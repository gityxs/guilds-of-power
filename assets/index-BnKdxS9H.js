var ui=Object.defineProperty;var hi=(T,e,t)=>e in T?ui(T,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):T[e]=t;var me=(T,e,t)=>hi(T,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const $e=Math.sqrt(3);class He{constructor(e,t,i=12){this.width=e,this.height=t,this.hexSize=i,this.cells=new Map,this.hexWidth=i*2,this.hexHeight=$e*i,this.horizSpacing=this.hexWidth*.75,this.vertSpacing=this.hexHeight,this._cornerOffsets=[];for(let s=0;s<6;s++){const a=Math.PI/180*(60*s);this._cornerOffsets.push({x:this.hexSize*Math.cos(a),y:this.hexSize*Math.sin(a)})}this._hexCornersCache=new Map}generate(){this.cells.clear();for(let e=0;e<this.height;e++)for(let t=0;t<this.width;t++){const i=`${t},${e}`;this.cells.set(i,{q:t,r:e,elevation:0,moisture:0,biome:null})}return this}getCell(e,t){return this.cells.get(`${e},${t}`)}setCell(e,t,i){const s=this.getCell(e,t);s&&Object.assign(s,i)}forEach(e){this.cells.forEach((t,i)=>e(t,i))}hexToPixel(e,t){const i=this.hexSize*(1.5*e),s=this.hexSize*($e/2*e+$e*t);return{x:i,y:s}}pixelToHex(e,t){const i=.6666666666666666*e/this.hexSize,s=(-1/3*e+$e/3*t)/this.hexSize;return this.axialRound(i,s)}axialRound(e,t){const i=-e-t;let s=Math.round(e),a=Math.round(t),n=Math.round(i);const r=Math.abs(s-e),o=Math.abs(a-t),l=Math.abs(n-i);return r>o&&r>l?s=-a-n:o>l&&(a=-s-n),{q:s,r:a}}getHexCorners(e,t){const i=`${e},${t}`;let s=this._hexCornersCache.get(i);if(s)return s;const a=this.hexToPixel(e,t);return s=this._cornerOffsets.map(n=>({x:a.x+n.x,y:a.y+n.y})),this._hexCornersCache.set(i,s),s}getNeighbors(e,t){return[[1,0],[1,-1],[0,-1],[-1,0],[-1,1],[0,1]].map(([s,a])=>this.getCell(e+s,t+a)).filter(s=>s!==void 0)}distance(e,t,i,s){return(Math.abs(e-i)+Math.abs(e+t-i-s)+Math.abs(t-s))/2}getCenter(){return{q:Math.floor(this.width/2),r:Math.floor(this.height/2)}}getMaxDistanceFromCenter(){const e=this.getCenter();return Math.max(e.q,e.r,this.width-e.q,this.height-e.r)}getPixelBounds(){let e=1/0,t=1/0,i=-1/0,s=-1/0;return this.forEach(a=>{this.getHexCorners(a.q,a.r).forEach(r=>{e=Math.min(e,r.x),t=Math.min(t,r.y),i=Math.max(i,r.x),s=Math.max(s,r.y)})}),{minX:e,minY:t,maxX:i,maxY:s,width:i-e,height:s-t}}}const mi=.5*(Math.sqrt(3)-1),ke=(3-Math.sqrt(3))/6,ge=[[1,1],[-1,1],[1,-1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]];class j{constructor(e=Math.random()*65536){this.perm=new Uint8Array(512),this.permMod8=new Uint8Array(512),this.seed(e)}seed(e){const t=new Uint8Array(256);for(let s=0;s<256;s++)t[s]=s;let i=Math.floor(e)||1;for(let s=255;s>0;s--){i=i*16807%2147483647;const a=i%(s+1);[t[s],t[a]]=[t[a],t[s]]}for(let s=0;s<512;s++)this.perm[s]=t[s&255],this.permMod8[s]=this.perm[s]%8}noise2D(e,t){let i,s,a;const n=(e+t)*mi,r=Math.floor(e+n),o=Math.floor(t+n),l=(r+o)*ke,c=r-l,d=o-l,u=e-c,h=t-d;let m,g;u>h?(m=1,g=0):(m=0,g=1);const y=u-m+ke,f=h-g+ke,p=u-1+2*ke,v=h-1+2*ke,b=r&255,k=o&255,w=this.permMod8[b+this.perm[k]],x=this.permMod8[b+m+this.perm[k+g]],C=this.permMod8[b+1+this.perm[k+1]];let _=.5-u*u-h*h;_<0?i=0:(_*=_,i=_*_*(ge[w][0]*u+ge[w][1]*h));let M=.5-y*y-f*f;M<0?s=0:(M*=M,s=M*M*(ge[x][0]*y+ge[x][1]*f));let S=.5-p*p-v*v;return S<0?a=0:(S*=S,a=S*S*(ge[C][0]*p+ge[C][1]*v)),70*(i+s+a)}fbm2D(e,t,i=6,s=.5,a=2,n=1){let r=0,o=1,l=n,c=0;for(let d=0;d<i;d++)r+=this.noise2D(e*l,t*l)*o,c+=o,o*=s,l*=a;return r/c}fbm2DNormalized(e,t,i=6,s=.5,a=2,n=1){return(this.fbm2D(e,t,i,s,a,n)+1)/2}}const I={DEEP_OCEAN:{id:"deep_ocean",name:"Deep Ocean",color:"#2a3a4a"},OCEAN:{id:"ocean",name:"Ocean",color:"#3a4a5a"},COAST:{id:"coast",name:"Coast",color:"#5a7080"},BEACH:{id:"beach",name:"Beach",color:"#c4b090"},DESERT:{id:"desert",name:"Desert",color:"#c8b888"},GRASSLAND:{id:"grassland",name:"Grassland",color:"#8a9a70"},SWAMP:{id:"swamp",name:"Swamp",color:"#5a7068"},SAVANNA:{id:"savanna",name:"Savanna",color:"#a89860"},FOREST:{id:"forest",name:"Forest",color:"#5a7050"},RAINFOREST:{id:"rainforest",name:"Rainforest",color:"#3a5038"},TUNDRA:{id:"tundra",name:"Tundra",color:"#909088"},TAIGA:{id:"taiga",name:"Taiga",color:"#606858"},SNOW_FOREST:{id:"snow_forest",name:"Snow Forest",color:"#788078"},MOUNTAIN:{id:"mountain",name:"Mountain",color:"#686058"},SNOW_PEAK:{id:"snow_peak",name:"Snow Peak",color:"#c8c4b8"},ARCTIC:{id:"arctic",name:"Arctic",color:"#d8e4f0"},FROZEN_SEA:{id:"frozen_sea",name:"Frozen Sea",color:"#a8c8d8"},HIGHLANDS:{id:"highlands",name:"Highlands",color:"#7a6858"},BADLANDS:{id:"badlands",name:"Badlands",color:"#8a4030"},VOLCANIC:{id:"volcanic",name:"Volcanic",color:"#3a2020"},CAVE_FLOOR:{id:"cave_floor",name:"Cave Floor",color:"#4a4540"},CAVE_WALL:{id:"cave_wall",name:"Cave Wall",color:"#2a1a2d",impassable:!0},STONE_FLOOR:{id:"stone_floor",name:"Stone Floor",color:"#5a5550"},DUNGEON_WALL:{id:"dungeon_wall",name:"Dungeon Wall",color:"#2d1d30",impassable:!0},RUBBLE:{id:"rubble",name:"Rubble",color:"#5a5045"},UNDERGROUND_WATER:{id:"underground_water",name:"Underground Pool",color:"#2a3a4a"},CHASM:{id:"chasm",name:"Chasm",color:"#0a0a0a",impassable:!0},CRYSTAL_FLOOR:{id:"crystal_floor",name:"Crystal Cavern",color:"#4a5a6a"},MOSSY_STONE:{id:"mossy_stone",name:"Mossy Stone",color:"#4a5a48"},SHRINE_FLOOR:{id:"shrine_floor",name:"Sacred Ground",color:"#5a5a60"}},pe={DEEP_WATER:.3,SHALLOW_WATER:.4,BEACH:.42,LOW:.55,MEDIUM:.7,HIGH:.85},Y={DRY:.33,MEDIUM:.66};class Ye{constructor(e=null){this.seed=e??Math.floor(Math.random()*65536),this.elevationNoise=new j(this.seed),this.moistureNoise=new j(this.seed+1e3),this.continentNoise=new j(this.seed+2e3),this.temperatureNoise=new j(this.seed+3e3),this.resourceIcons={forest:["ðŸŒ²","ðŸŒ²","ðŸŒ³","ðŸŒ³","ðŸª¨"],rainforest:["ðŸŒ´","ðŸŒ´","ðŸŒ³","ðŸŒ¿","ðŸª¨"],taiga:["ðŸŒ²","ðŸŒ²","ðŸŒ²","ðŸª¨"],snow_forest:["ðŸŒ²","ðŸŒ²","ðŸª¨"],deep_forest:["ðŸŒ²","ðŸŒ²","ðŸŒ³","ðŸŒ³","ðŸŒ³"],mountain:["ðŸª¨","ðŸª¨","ðŸª¨","â›°ï¸","ðŸ’Ž"],hills:["ðŸª¨","ðŸª¨","ðŸŒ³","â›°ï¸"],snow_peak:["ðŸ”ï¸","ðŸª¨","ðŸ’Ž","ðŸ’Ž"],desert:["ðŸŒµ","ðŸª¨"],savanna:["ðŸŒ¾","ðŸŒ³","ðŸª¨"],swamp:["ðŸŒ¿","ðŸ„","ðŸŒ³"],grassland:["ðŸŒ¿","ðŸŒ¸","ðŸŒ³","ðŸª¨"],plains:["ðŸŒ¾","ðŸŒ¼","ðŸŒ³","ðŸª¨"],tundra:["ðŸª¨","ðŸª¨","â„ï¸"],beach:["ðŸš","ðŸª¨"],coast:["ðŸš","ðŸŽ£","ðŸª¨"],arctic:["â„ï¸","ðŸ§Š","ðŸª¨"],frozen_sea:["ðŸ§Š"],highlands:["ðŸª¨","ðŸª¨","â›°ï¸","ðŸŒ³"],badlands:["ðŸª¨","ðŸª¨","ðŸ’€"],volcanic:["ðŸŒ‹","ðŸª¨","ðŸª¨"]}}seededRandom(e,t,i=0){const s=Math.sin((e+i)*12.9898+(t+i)*78.233+this.seed)*43758.5453;return s-Math.floor(s)}generate(e,t={}){const{elevationScale:i=.02,moistureScale:s=.03,elevationOctaves:a=6,moistureOctaves:n=4,islandFactor:r=.5,redistributePower:o=1,continentScale:l=.008,seaLevel:c=.4}=t,d=e.getCenter(),u=e.getMaxDistanceFromCenter()*1.3;return e.forEach(h=>{let m=this.continentNoise.fbm2DNormalized(h.q,h.r,3,.5,2,l),g=this.elevationNoise.fbm2DNormalized(h.q,h.r,a,.5,2,i),y=m*.6+g*.4,f=this.moistureNoise.fbm2DNormalized(h.q,h.r,n,.5,2,s),p=this.temperatureNoise.fbm2DNormalized(h.q,h.r,3,.5,2,.015);const b=e.distance(h.q,h.r,d.q,d.r)/u,k=1-Math.pow(Math.max(0,b-.7)/.3,2);y=y*(1-r)+y*k*r,y=Math.pow(y,o),y=Math.max(0,Math.min(1,y)),f=Math.max(0,Math.min(1,f)),p=Math.max(0,Math.min(1,p));const w=this.getBiome(y,f,p);h.elevation=y,h.moisture=f,h.temperature=p,h.biome=w,y>=.85?h.heightLevel=3:y>=.75?h.heightLevel=2:y>=.65?h.heightLevel=1:h.heightLevel=0;const x=this.seededRandom(h.q,h.r,42),C=this.resourceIcons[w.id];if(C&&x>.82){h.hasResources=!0;const _=Math.floor(this.seededRandom(h.q,h.r,123)*C.length);h.resourceIcon=C[_]}else h.hasResources=!1,h.resourceIcon=null}),this.generateChests(e),e}generateChests(e){const t=[],s=["forest","deep_forest","grassland","plains","savanna","hills","highlands","taiga","swamp","rainforest"],a=[];e.forEach(o=>{o.biome&&s.includes(o.biome.id)&&(o.hasResources||a.push(o))});for(let o=a.length-1;o>0;o--){const l=Math.floor(this.seededRandom(o,0,999)*(o+1));[a[o],a[l]]=[a[l],a[o]]}const n=Math.floor(a.length/200);let r=0;for(const o of a){if(r>=n)break;let l=!1;for(const u of t)if(e.distance(o.q,o.r,u.q,u.r)<15){l=!0;break}if(l)continue;const c=this.seededRandom(o.q,o.r,777);let d;c<.6?d="wooden":c<.9?d="iron":d="golden",o.chest={type:d,opened:!1},t.push(o),r++}return t}getBiome(e,t,i=.5){return e<pe.DEEP_WATER?i<.25?I.FROZEN_SEA:I.DEEP_OCEAN:e<pe.SHALLOW_WATER?i<.25?I.FROZEN_SEA:I.OCEAN:e<pe.BEACH?i<.25?I.ARCTIC:t<Y.DRY?I.BEACH:I.COAST:e<pe.LOW?i<.25?I.ARCTIC:i>.75&&t<Y.DRY?I.BADLANDS:t<Y.DRY?I.DESERT:t<Y.MEDIUM?I.GRASSLAND:I.SWAMP:e<pe.MEDIUM?i<.25?I.TUNDRA:i>.75&&t<Y.DRY?I.BADLANDS:i>.75&&t<Y.MEDIUM?I.VOLCANIC:t<Y.DRY?I.SAVANNA:t<Y.MEDIUM?I.FOREST:I.RAINFOREST:e<pe.HIGH?i<.25?I.ARCTIC:i>.75&&t<Y.MEDIUM?I.HIGHLANDS:t<Y.DRY?I.TUNDRA:t<Y.MEDIUM?I.TAIGA:I.SNOW_FOREST:i<.25?I.ARCTIC:i>.75?I.HIGHLANDS:t<Y.MEDIUM?I.MOUNTAIN:I.SNOW_PEAK}regenerate(e,t={}){return this.seed=Math.floor(Math.random()*65536),this.elevationNoise=new j(this.seed),this.moistureNoise=new j(this.seed+1e3),this.continentNoise=new j(this.seed+2e3),this.temperatureNoise=new j(this.seed+3e3),this.generate(e,t)}}const nt={"ðŸŒ²":{name:"pine_tree",path:"imgages/icons/pine-tree.png"},"ðŸŒ³":{name:"oak_tree",path:"images/icons/oak.png"},"ðŸŒ´":{name:"palm_tree",path:null},"ðŸŒ¿":{name:"herbs",path:null},"ðŸŒ¾":{name:"wheat",path:null},"ðŸŒµ":{name:"cactus",path:"images/icons/cactus.png"},"ðŸŒ»":{name:"sunflower",path:null},"ðŸŒ¼":{name:"flower",path:null},"ðŸŒº":{name:"hibiscus",path:null},"ðŸ„":{name:"mushroom",path:null},"ðŸª¨":{name:"rock",path:"images/icons/stone.png"},"â›°ï¸":{name:"mountain",path:"images/icons/mountain.png"},"â›°":{name:"mountain_alt",path:null},"ðŸ”ï¸":{name:"snow_mountain",path:"images/icons/mountai.png"},"ðŸ”":{name:"snow_mountain_alt",path:null},"ðŸŒ‹":{name:"volcano",path:null},"ðŸ’Ž":{name:"gem",path:null},"ðŸ§Š":{name:"ice",path:null},"â„ï¸":{name:"snowflake",path:null},"â„":{name:"snowflake_alt",path:null},"ðŸš":{name:"shell",path:"images/icons/sea-snail.png"},"ðŸ¦€":{name:"crab",path:"images/icons/crab.png"},"ðŸ§°":{name:"chest_wooden",path:"images/icons/treasure-chest.png"},"ðŸ“¦":{name:"chest_iron",path:"images/icons/container.png"},"ðŸŽ":{name:"chest_golden",path:"images/icons/container.png"},"ðŸ—¡ï¸":{name:"sword",path:"/images/icons/sword.png"},"ðŸ—¡":{name:"sword_alt",path:null},"âš”ï¸":{name:"crossed_swords",path:"images/icons/swords.png"},"âš”":{name:"crossed_swords_alt",path:null},"ðŸ›¡ï¸":{name:"shield",path:"images/icons/shield.png"},"ðŸ›¡":{name:"shield_alt",path:null},"ðŸª“":{name:"axe",path:null},"ðŸ¹":{name:"bow",path:null},"ðŸ‘‘":{name:"crown",path:"images/icons/crown.png"},"âš’ï¸":{name:"hammer_pick",path:null},"âš’":{name:"hammer_pick_alt",path:null},"ðŸŽ£":{name:"fishing_rod",path:null},"â›º":{name:"tent",path:null},"ðŸ”¥":{name:"fire",path:null},"âœ¨":{name:"sparkle",path:null},"ðŸ–":{name:"meat",path:null},"ðŸ¥©":{name:"steak",path:null},"ðŸž":{name:"bread",path:null},"ðŸŸ":{name:"fish",path:null},"ðŸ’§":{name:"water",path:null},"ðŸ§ª":{name:"potion",path:null},"ðŸ’Š":{name:"pill",path:null},"ðŸº":{name:"vase",path:null},"ðŸ—ï¸":{name:"key",path:null},"ðŸ—":{name:"key_alt",path:null},"ðŸšª":{name:"door",path:null},"ðŸªœ":{name:"ladder",path:null},"ðŸŒ€":{name:"portal",path:null},"ðŸ“œ":{name:"scroll",path:null},"ðŸº":{name:"wolf",path:null},"ðŸ—":{name:"boar",path:null},"ðŸ»":{name:"bear",path:null},"ðŸ¦Œ":{name:"deer",path:null},"ðŸ":{name:"snake",path:null},"ðŸ¦‚":{name:"scorpion",path:null},"ðŸ•·ï¸":{name:"spider",path:null},"ðŸ•·":{name:"spider_alt",path:null},"ðŸ¦‡":{name:"bat",path:null},"ðŸ‰":{name:"dragon",path:null},"ðŸ¦Ž":{name:"lizard",path:null},"ðŸ´":{name:"horse",path:null},"ðŸ’€":{name:"skull",path:null},"â˜ ï¸":{name:"skull_crossbones",path:null},"â˜ ":{name:"skull_crossbones_alt",path:null},"ðŸ‘»":{name:"ghost",path:null},"ðŸ§Ÿ":{name:"zombie",path:null},"ðŸ§Ÿâ€â™‚ï¸":{name:"zombie_male",path:null},"ðŸ’¤":{name:"sleep",path:null},"ðŸ¤":{name:"handshake",path:null},"ðŸ›ï¸":{name:"bed",path:null},"ðŸ›":{name:"bed_alt",path:null},"ðŸª":{name:"shop",path:null},"ðŸ ":{name:"house",path:null},"ðŸ°":{name:"castle",path:null},"â›ª":{name:"church",path:null}};function gi(){return Object.entries(nt).filter(([T,e])=>e.path!==null).map(([T,e])=>({emoji:T,name:e.name,path:e.path}))}let Qe=null;function pi(){if(!Qe){const T=Object.entries(nt).filter(([e,t])=>t.path).map(([e])=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"));T.length>0&&(Qe=new RegExp(T.join("|"),"g"))}return Qe}function ii(T,e=16){const t=pi();if(!t)return;const i=T.textContent;if(!t.test(i))return;t.lastIndex=0;const s=document.createDocumentFragment();let a=0,n;for(;(n=t.exec(i))!==null;){n.index>a&&s.appendChild(document.createTextNode(i.slice(a,n.index)));const r=n[0],o=nt[r];if(o!=null&&o.path){const l=document.createElement("img");l.src=o.path,l.alt=r,l.className="icon-img";const c=typeof e=="number"?`${e}px`:e;l.style.width=c,l.style.height=c,l.style.verticalAlign="middle",s.appendChild(l)}else s.appendChild(document.createTextNode(r));a=t.lastIndex}a<i.length&&s.appendChild(document.createTextNode(i.slice(a))),T.parentNode.replaceChild(s,T)}let Ne={"#title-screen":49,"#character-creation":24,"#main-menu":32,".modal-content":12,".inventory-panel":12,".log-entries":14,".combat-log":14,body:32};function si(T){if(!T)return Ne.body||18;for(const[e,t]of Object.entries(Ne))if(T.closest&&T.closest(e))return t;return Ne.body||18}let xe=null;function fi(T=document.body,e=18){return Ne.body=e,xe&&xe.disconnect(),mt(T),xe=new MutationObserver(t=>{for(const i of t)for(const s of i.addedNodes)if(s.nodeType===Node.TEXT_NODE){const a=si(s.parentElement);ii(s,a)}else s.nodeType===Node.ELEMENT_NODE&&mt(s)}),xe.observe(T,{childList:!0,subtree:!0}),xe}function mt(T){const e=document.createTreeWalker(T,NodeFilter.SHOW_TEXT,null,!1),t=[];for(;e.nextNode();)t.push(e.currentNode);for(const i of t){const s=si(i.parentElement||T);ii(i,s)}}class gt{constructor(e){me(this,"_shorelineCache",new Map);me(this,"shorelineColor","#c4b898");this.canvas=e,this.iconImages={},this.iconsLoaded=!1,this.ctx=e.getContext("2d"),this.offsetX=0,this.offsetY=0,this.scale=3,this.minScale=3,this.maxScale=3,this._hexCornersCache=new Map,this._pixelPositionCache=new Map,this._colorCache=new Map,this._colorCacheMaxSize=500,this._visibleCells=[],this._visibleCellsSet=new Set,this._lastViewportKey=null,this.detailThresholds={showBiomeIcons:.9,showDenseIcons:2,minimapMode:.6,simplifiedStroke:.5,showTimeTinting:.5},this.biomeIcons={forest:["ðŸŒ²","ðŸŒ³","ðŸŒ¿"],rainforest:["ðŸŒ´","ðŸŒ³","ðŸŒ¿","ðŸŒº"],taiga:["ðŸŒ²","ðŸŒ²","â„"],snow_forest:["ðŸŒ²","â„","ðŸŒ¨"],mountain:["â›°","ðŸª¨","â–³"],snow_peak:["ðŸ”","â„","â›·"],desert:["ðŸŒµ","â˜€","ðŸœ"],savanna:["ðŸŒ¾","ðŸŒ»","ðŸ¦"],swamp:["ðŸŒ¿","ðŸ¸","ðŸ’§"],grassland:["ðŸŒ¾","ðŸŒ¼","ðŸ¦‹"],tundra:["â„","ðŸŒ¬","ðŸª¨"],beach:["ðŸš","ðŸ¦€","ðŸŒŠ"]},this.timeOfDay={hour:12,minute:0},this.cloudShadows={enabled:!1,time:0,speed:8e-4,opacity:.15,shadowWidth:300,shadowGap:500,edgeSoftness:80},this.waterAnimation={enabled:!1,time:0,speed:.002,waveScale:.02,shimmerIntensity:.12},this.setupCanvas(),this.terrainTileset=null,this.terrainTilesetLoaded=!1,this.tileWidth=128,this.tileHeight=144,this.tilesPerRow=3,this.totalTiles=12,this.biomeTileMap={deep_ocean:11,ocean:11,coast:11,beach:0,frozen_sea:6,desert:0,savanna:3,grassland:4,forest:2,rainforest:5,swamp:7,taiga:8,tundra:6,mountain:9,snow_peak:6,highlands:7,badlands:7,volcanic:10,arctic:6,snow_forest:8,cave_floor:7,cave_wall:6,stone_floor:9,dungeon_wall:6,rubble:7,underground_water:11,chasm:10,crystal_floor:9,mossy_stone:7,shrine_floor:9},this.biomeTintOverlay={cave_wall:"rgba(40, 20, 50, 0.6)",dungeon_wall:"rgba(45, 25, 55, 0.6)",chasm:"rgba(0, 0, 0, 0.7)"}}async loadTerrainTileset(){if(!this.terrainTilesetLoaded)return new Promise((e,t)=>{const i=new Image;i.onload=()=>{this.terrainTileset=i,this.terrainTilesetLoaded=!0,console.log("Terrain tileset loaded successfully"),e()},i.onerror=()=>{console.warn("Failed to load terrain tileset, using procedural textures"),this.terrainTilesetLoaded=!1,e()},i.src="sbs_-_realistic_hex_tiles/Thick/Terrain 1 - Thick - Texture Outline 1px - 128x144.png"})}getTileIndexForBiome(e){return this.biomeTileMap[e]||5}drawTerrainTile(e,t,i,s,a=0){var y;if(!this.terrainTileset||!this.terrainTilesetLoaded)return!1;const n=this.getTileIndexForBiome(i),r=n%this.tilesPerRow,o=Math.floor(n/this.tilesPerRow),l=r*this.tileWidth,c=o*this.tileHeight;let d=1/0,u=-1/0,h=1/0,m=-1/0;e.save(),e.beginPath();for(let f=0;f<6;f++){const p=t[f].x*s+this.offsetX,v=t[f].y*s+this.offsetY-a;p<d&&(d=p),p>u&&(u=p),v<h&&(h=v),v>m&&(m=v),f===0?e.moveTo(p,v):e.lineTo(p,v)}e.closePath(),e.clip(),e.globalAlpha=1,e.drawImage(this.terrainTileset,l,c,this.tileWidth,this.tileHeight,d,h,u-d,m-h);const g=(y=this.biomeTintOverlay)==null?void 0:y[i];if(g){e.fillStyle=g,e.beginPath();for(let f=0;f<6;f++){const p=t[f].x*s+this.offsetX,v=t[f].y*s+this.offsetY-a;f===0?e.moveTo(p,v):e.lineTo(p,v)}e.closePath(),e.fill()}return e.restore(),!0}getTimeTint(e,t){const i=e+t/60;if(i>=21||i<5)return{r:.6,g:.65,b:.9,brightness:.5};if(i>=5&&i<7){const s=(i-5)/2;return{r:.6+s*.4,g:.65+s*.35,b:.9-s*.1,brightness:.5+s*.5}}else{if(i>=7&&i<17)return{r:1,g:1,b:1,brightness:1};if(i>=17&&i<20){const s=(i-17)/3;return{r:1,g:1-s*.2,b:1-s*.35,brightness:1-s*.3}}else{const s=i-20;return{r:1-s*.4,g:.8-s*.15,b:.65+s*.25,brightness:.7-s*.2}}}}applyTimeTint(e,t){let i,s,a;if(e.startsWith("#"))i=parseInt(e.slice(1,3),16),s=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);else if(e.startsWith("rgb")){const n=e.match(/(\d+),\s*(\d+),\s*(\d+)/);if(n)i=parseInt(n[1]),s=parseInt(n[2]),a=parseInt(n[3]);else return e}else return e;return i=Math.floor(i*t.r*t.brightness),s=Math.floor(s*t.g*t.brightness),a=Math.floor(a*t.b*t.brightness),i=Math.max(0,Math.min(255,i)),s=Math.max(0,Math.min(255,s)),a=Math.max(0,Math.min(255,a)),`rgb(${i}, ${s}, ${a})`}setTime(e,t=0){this.timeOfDay.hour=e,this.timeOfDay.minute=t}lerp(e,t,i){return e+(t-e)*i}getNightVisibility(e=0){const t=this.timeOfDay.hour+this.timeOfDay.minute/60,i=12,s=3;let a;if(t>=7&&t<18)a=i;else if(t>=18&&t<20){const n=(t-18)/2;a=this.lerp(i,s,n)}else if(t>=20||t<5)a=s;else{const n=(t-5)/2;a=this.lerp(s,i,n)}return a+e}isNightFogActive(){const e=this.timeOfDay.hour+this.timeOfDay.minute/60;return e>=18||e<7}drawNightFogOverlay(e,t,i=0){if(t<=0)return;const s=this.ctx,a=this.scale;s.beginPath(),s.moveTo(e[0].x*a+this.offsetX,e[0].y*a+this.offsetY-i);for(let l=1;l<6;l++)s.lineTo(e[l].x*a+this.offsetX,e[l].y*a+this.offsetY-i);s.closePath();const n=15,r=12,o=35;s.fillStyle=`rgba(${n}, ${r}, ${o}, ${t})`,s.fill()}getAngleToHex(e,t,i,s){const a=e.hexToPixel(t.q,t.r),n=e.hexToPixel(i,s);return Math.atan2(n.y-a.y,n.x-a.x)}normalizeAngle(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}getConicalVisibility(e,t,i=Math.PI*.6){let s=Math.abs(this.normalizeAngle(e-t));if(s<=i/2)return 1;const a=Math.PI-i/2;if(s<=Math.PI){const n=(s-i/2)/a;return Math.max(.15,1-n*.85)}return .15}renderNightFog(e,t,i={}){if(!t||!this.isNightFogActive())return;const s=i.torchLight||0,a=i.elevationScale||8,n=i.facingAngle||0,r=this.getNightVisibility(0),o=this.getNightVisibility(s),l=i.visibleCells||this._visibleCells,c=this.ctx;c.save();const u=o+2+3;for(const h of l){if(!h.biome)continue;const m=e.distance(h.q,h.r,t.q,t.r);if(m<r-2)continue;let g=0;if(m>u)g=.85;else{const y=this.getAngleToHex(e,t,h.q,h.r);let f=r;if(s>0&&m>0){const p=this.getConicalVisibility(y,n),v=(o-r)*p;f=r+v}m>f?g=.85:m>f-2&&(g=(m-(f-2))/2*.7)}if(g>0){const y=`${h.q},${h.r}`;let f=this._hexCornersCache.get(y);f||(f=e.getHexCorners(h.q,h.r),this._hexCornersCache.set(y,f));const p=(h.elevation-.4)*a*this.scale;this.drawNightFogOverlay(f,g,p)}}s>0&&this.drawTorchGlowCone(e,t,s,n,a),c.restore()}drawTorchGlowCone(e,t,i,s,a){const n=this.ctx,r=this.scale,o=e.getCell(t.q,t.r),l=e.hexToPixel(t.q,t.r),c=o?(o.elevation-.4)*a*r:0,d=l.x*r+this.offsetX,u=l.y*r+this.offsetY-c,h=(i+3)*e.hexSize*r*1.8,m=Math.PI*.5;n.save();const g=n.createRadialGradient(d,u,0,d,u,h);g.addColorStop(0,"rgba(255, 200, 100, 0.18)"),g.addColorStop(.3,"rgba(255, 180, 80, 0.12)"),g.addColorStop(.6,"rgba(255, 150, 50, 0.06)"),g.addColorStop(1,"rgba(255, 120, 30, 0)"),n.fillStyle=g,n.beginPath(),n.moveTo(d,u),n.arc(d,u,h,s-m/2,s+m/2),n.closePath(),n.fill();const y=n.createRadialGradient(d,u,0,d,u,e.hexSize*r*2);y.addColorStop(0,"rgba(255, 180, 100, 0.12)"),y.addColorStop(1,"rgba(255, 150, 80, 0)"),n.fillStyle=y,n.beginPath(),n.arc(d,u,e.hexSize*r*2,0,Math.PI*2),n.fill(),n.restore()}setupCanvas(){this.resize()}resize(){const e=window.devicePixelRatio||1,t=this.canvas.getBoundingClientRect();this.canvas.width=t.width*e,this.canvas.height=t.height*e,this.ctx.setTransform(e,0,0,e,0,0),this.width=t.width,this.height=t.height}async loadIcons(){const e=gi();if(e.length===0){this.iconsLoaded=!0;return}const t=e.map(({emoji:i,path:s})=>new Promise(a=>{const n=new Image;n.onload=()=>{this.iconImages[i]=n,a()},n.onerror=()=>{console.warn(`Failed to load icon: ${s}`),a()},n.src=s}));await Promise.all(t),this.iconsLoaded=!0}drawIcon(e,t,i,s,a={}){const n=this.ctx,r=this.iconImages[e];if(r){const o=s/2;a.shadowColor&&(n.shadowColor=a.shadowColor,n.shadowBlur=a.shadowBlur||0),n.drawImage(r,t-o,i-o,s,s),n.shadowBlur=0}else n.font=`${s}px sans-serif`,n.textAlign="center",n.textBaseline="middle",a.shadowColor&&(n.shadowColor=a.shadowColor,n.shadowBlur=a.shadowBlur||0),n.fillText(e,t,i),n.shadowBlur=0}clear(){this.ctx.fillStyle="#0a0a0a",this.ctx.fillRect(0,0,this.width,this.height)}centerGrid(e){if(this._centered)return;const t=e.getPixelBounds();this.offsetX=(this.width-t.width*this.scale)/2-t.minX*this.scale,this.offsetY=(this.height-t.height*this.scale)/2-t.minY*this.scale,this._centered=!0}centerOnHex(e,t,i){const s=e.hexToPixel(t,i);this.offsetX=this.width/2-s.x*this.scale,this.offsetY=this.height/2-s.y*this.scale,this._centered=!0}resetView(e){this._centered=!1,this.scale=3,this.centerGrid(e)}zoom(e,t,i){const s=Math.max(this.minScale,Math.min(this.maxScale,this.scale*e)),a=s/this.scale;this.offsetX=t-(t-this.offsetX)*a,this.offsetY=i-(i-this.offsetY)*a,this.scale=s}screenToHex(e,t,i){const s=(t-this.offsetX)/this.scale,a=(i-this.offsetY)/this.scale,n=e.pixelToHex(s,a);return e.getCell(n.q,n.r)?n:null}drawHexDropShadow(e,t,i){const s=this.ctx,a=this.scale,n=Math.min(.55,(t-.3)*.8);if(n<=.08)return;const r=2;for(let o=r;o>=0;o--){const l=o*.5,c=n/(o+1);s.beginPath(),s.moveTo(e[0].x*a+this.offsetX+i.x+l,e[0].y*a+this.offsetY+i.y+l);for(let d=1;d<6;d++)s.lineTo(e[d].x*a+this.offsetX+i.x+l,e[d].y*a+this.offsetY+i.y+l);s.closePath(),s.fillStyle=`rgba(0, 0, 0, ${c})`,s.fill()}}drawHexWithBevel(e,t,i,s=null,a=!1,n=null,r=0){const o=this.ctx,l=this.scale;let c=!1;if(n&&l>.8&&this.terrainTilesetLoaded&&(c=this.drawTerrainTile(o,e,n,l,r)),!c){o.beginPath(),o.moveTo(e[0].x*l+this.offsetX,e[0].y*l+this.offsetY-r);for(let d=1;d<6;d++)o.lineTo(e[d].x*l+this.offsetX,e[d].y*l+this.offsetY-r);o.closePath(),o.fillStyle=t,o.fill()}}drawRaisedHex(e,t,i,s=null,a=null,n=0){if(i<=0){this.drawHex(e,t,s,a,n);return}const r=this.ctx,o=this.scale,l=i*12*o,c=n+l,d=this.adjustBrightness(t,-.25),u=this.adjustBrightness(t,-.4);r.beginPath(),r.moveTo(e[2].x*o+this.offsetX,e[2].y*o+this.offsetY-n),r.lineTo(e[3].x*o+this.offsetX,e[3].y*o+this.offsetY-n),r.lineTo(e[3].x*o+this.offsetX,e[3].y*o+this.offsetY-c),r.lineTo(e[2].x*o+this.offsetX,e[2].y*o+this.offsetY-c),r.closePath(),r.fillStyle=d,r.fill(),r.beginPath(),r.moveTo(e[3].x*o+this.offsetX,e[3].y*o+this.offsetY-n),r.lineTo(e[4].x*o+this.offsetX,e[4].y*o+this.offsetY-n),r.lineTo(e[4].x*o+this.offsetX,e[4].y*o+this.offsetY-c),r.lineTo(e[3].x*o+this.offsetX,e[3].y*o+this.offsetY-c),r.closePath(),r.fillStyle=u,r.fill(),r.beginPath(),r.moveTo(e[4].x*o+this.offsetX,e[4].y*o+this.offsetY-n),r.lineTo(e[5].x*o+this.offsetX,e[5].y*o+this.offsetY-n),r.lineTo(e[5].x*o+this.offsetX,e[5].y*o+this.offsetY-c),r.lineTo(e[4].x*o+this.offsetX,e[4].y*o+this.offsetY-c),r.closePath(),r.fillStyle=d,r.fill();let h=!1;if(a&&o>.8&&this.terrainTilesetLoaded&&(h=this.drawTerrainTile(r,e,a,o,c)),!h){r.beginPath(),r.moveTo(e[0].x*o+this.offsetX,e[0].y*o+this.offsetY-c);for(let m=1;m<6;m++)r.lineTo(e[m].x*o+this.offsetX,e[m].y*o+this.offsetY-c);r.closePath(),r.fillStyle=t,r.fill()}}drawInsetHex(e,t,i,s=null,a=null,n=0){if(i<=0){this.drawHex(e,t,s,a,n);return}const r=this.ctx,o=this.scale,l=i*10*o,c=n-l,d=this.adjustBrightness(t,-.2-i*.1),u=this.adjustBrightness(t,-.35),h=this.adjustBrightness(t,-.5);let m=!1;if(a&&o>.8&&this.terrainTilesetLoaded&&(m=this.drawTerrainTile(r,e,a,o,c)),!m){r.beginPath(),r.moveTo(e[0].x*o+this.offsetX,e[0].y*o+this.offsetY-c);for(let g=1;g<6;g++)r.lineTo(e[g].x*o+this.offsetX,e[g].y*o+this.offsetY-c);r.closePath(),r.fillStyle=d,r.fill()}r.beginPath(),r.moveTo(e[5].x*o+this.offsetX,e[5].y*o+this.offsetY-n),r.lineTo(e[0].x*o+this.offsetX,e[0].y*o+this.offsetY-n),r.lineTo(e[0].x*o+this.offsetX,e[0].y*o+this.offsetY-c),r.lineTo(e[5].x*o+this.offsetX,e[5].y*o+this.offsetY-c),r.closePath(),r.fillStyle=u,r.fill(),r.beginPath(),r.moveTo(e[0].x*o+this.offsetX,e[0].y*o+this.offsetY-n),r.lineTo(e[1].x*o+this.offsetX,e[1].y*o+this.offsetY-n),r.lineTo(e[1].x*o+this.offsetX,e[1].y*o+this.offsetY-c),r.lineTo(e[0].x*o+this.offsetX,e[0].y*o+this.offsetY-c),r.closePath(),r.fillStyle=h,r.fill(),r.beginPath(),r.moveTo(e[1].x*o+this.offsetX,e[1].y*o+this.offsetY-n),r.lineTo(e[2].x*o+this.offsetX,e[2].y*o+this.offsetY-n),r.lineTo(e[2].x*o+this.offsetX,e[2].y*o+this.offsetY-c),r.lineTo(e[1].x*o+this.offsetX,e[1].y*o+this.offsetY-c),r.closePath(),r.fillStyle=u,r.fill()}drawHex(e,t,i=null,s=null,a=0){const n=this.ctx,r=this.scale;let o=!1;if(s&&r>.8&&this.terrainTilesetLoaded&&(o=this.drawTerrainTile(n,e,s,r,a)),!o){n.beginPath(),n.moveTo(e[0].x*r+this.offsetX,e[0].y*r+this.offsetY-a);for(let l=1;l<6;l++)n.lineTo(e[l].x*r+this.offsetX,e[l].y*r+this.offsetY-a);n.closePath(),n.fillStyle=t,n.fill()}if(i){n.beginPath(),n.moveTo(e[0].x*r+this.offsetX,e[0].y*r+this.offsetY-a);for(let l=1;l<6;l++)n.lineTo(e[l].x*r+this.offsetX,e[l].y*r+this.offsetY-a);n.closePath(),n.strokeStyle=i,n.lineWidth=Math.max(.5,r*.5),n.stroke()}}render(e,t={}){const{showStroke:i=!0,strokeColor:s="rgba(0, 0, 0, 0.2)"}=t;this.clear(),this.centerGrid(e),e.forEach(a=>{if(!a.biome)return;const n=e.getHexCorners(a.q,a.r),r=a.biome.color;this.drawHex(n,r,i?s:null)})}renderWithShading(e,t={}){const{showStroke:i=!0,strokeColor:s="rgba(0, 0, 0, 0.15)",shadingIntensity:a=.3}=t;this.clear(),this.centerGrid(e),e.forEach(n=>{if(!n.biome)return;const r=e.getHexCorners(n.q,n.r),o=n.biome.color,l=(n.elevation-.5)*a,c=this.adjustBrightness(o,l);this.drawHex(r,c,i?s:null)})}renderWithFog(e,t={}){const{showStroke:i=!0,strokeColor:s="rgba(0, 0, 0, 0.15)",shadingIntensity:a=.2,mouseHex:n=null,revealRadius:r=6}=t;this.clear(),this.centerGrid(e),e.forEach(o=>{if(!o.biome)return;const l=e.getHexCorners(o.q,o.r),c=o.biome.color,d=(o.elevation-.5)*a;let u=this.adjustBrightness(c,d),h=.15;if(n){const g=e.distance(o.q,o.r,n.q,n.r);if(g<=r){const y=g/r;h=.15+(1-y*y)*.85}}const m=this.applyFog(u,h);this.drawHex(l,m,i?this.applyFog(s,h):null)}),n&&this.drawRevealGlow(e,n,r)}applyFog(e,t){const i=this._parseColor(e);if(!i)return e;const{r:s,g:a,b:n,a:r}=i,o=10,l=10,c=18,d=Math.round(o+(s-o)*t),u=Math.round(l+(a-l)*t),h=Math.round(c+(n-c)*t);return`rgba(${d}, ${u}, ${h}, ${r})`}drawRevealGlow(e,t,i){const s=this.ctx,a=this.scale,n=e.hexToPixel(t.q,t.r),r=n.x*a+this.offsetX,o=n.y*a+this.offsetY,l=i*e.hexSize*a*1.8,c=s.createRadialGradient(r,o,l*.5,r,o,l);c.addColorStop(0,"rgba(255, 255, 200, 0)"),c.addColorStop(.7,"rgba(255, 255, 200, 0)"),c.addColorStop(1,"rgba(255, 255, 200, 0.03)"),s.fillStyle=c,s.beginPath(),s.arc(r,o,l,0,Math.PI*2),s.fill()}_parseColor(e){if(this._colorCache.has(e))return this._colorCache.get(e);let t,i,s,a=1;if(e.startsWith("#"))t=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16);else if(e.startsWith("rgba")){const r=e.match(/(\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)/);if(r)t=parseInt(r[1]),i=parseInt(r[2]),s=parseInt(r[3]),a=parseFloat(r[4]);else return null}else if(e.startsWith("rgb")){const r=e.match(/(\d+),\s*(\d+),\s*(\d+)/);if(r)t=parseInt(r[1]),i=parseInt(r[2]),s=parseInt(r[3]);else return null}else return null;const n={r:t,g:i,b:s,a};if(this._colorCache.size>=this._colorCacheMaxSize){const r=this._colorCache.keys().next().value;this._colorCache.delete(r)}return this._colorCache.set(e,n),n}adjustBrightness(e,t){const i=this._parseColor(e);if(!i)return e;const{r:s,g:a,b:n}=i,r=d=>{const u=Math.round(d+t*255);return Math.max(0,Math.min(255,u))},o=r(s),l=r(a),c=r(n);return`rgb(${o}, ${l}, ${c})`}desaturateColor(e,t){let i,s,a;if(e.startsWith("#"))i=parseInt(e.slice(1,3),16),s=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);else if(e.startsWith("rgb")){const d=e.match(/(\d+),\s*(\d+),\s*(\d+)/);if(d)i=parseInt(d[1]),s=parseInt(d[2]),a=parseInt(d[3]);else return e}else return e;const n=Math.round(.299*i+.587*s+.114*a),r=Math.max(0,Math.min(1,t)),o=Math.round(i+(n-i)*r),l=Math.round(s+(n-s)*r),c=Math.round(a+(n-a)*r);return`rgb(${o}, ${l}, ${c})`}blendColors(e,t,i){const s=this._parseColor(e),a=this._parseColor(t);if(!s||!a)return e;const n=Math.max(0,Math.min(1,i)),r=Math.round(s.r+(a.r-s.r)*n),o=Math.round(s.g+(a.g-s.g)*n),l=Math.round(s.b+(a.b-s.b)*n);return`rgb(${r}, ${o}, ${l})`}isWaterBiome(e){return["deep_ocean","ocean","coast","frozen_sea","underground_water"].includes(e)}clearShorelineCache(){this._shorelineCache.clear()}getShorelineFactor(e,t){if(!e||!e.biome||!t)return 0;const i=`${e.q},${e.r}`;if(this._shorelineCache.has(i))return this._shorelineCache.get(i);if(this.isWaterBiome(e.biome.id))return this._shorelineCache.set(i,0),0;if(["beach","coast","arctic","snow_peak","mountain","volcanic","badlands"].includes(e.biome.id))return this._shorelineCache.set(i,0),0;const a=t.getNeighbors(e.q,e.r);let n=0;for(const o of a)o&&o.biome&&this.isWaterBiome(o.biome.id)&&n++;let r=0;return n===1?r=.25:n===2?r=.35:n>=3&&(r=.45),this._shorelineCache.set(i,r),r}drawRoads(e,t={}){const i=this.ctx,s=this.scale,a={main:{width:3,color:"#8b7355",dash:[]},secondary:{width:2,color:"#9c8a6e",dash:[]},trail:{width:1.5,color:"#7a6b55",dash:[4,4]}};for(const n of e){const r=a[n.type]||a.trail,o=n.spline;if(!(o.length<2)){i.beginPath(),i.moveTo(o[0].x*s+this.offsetX,o[0].y*s+this.offsetY);for(let l=1;l<o.length;l++)i.lineTo(o[l].x*s+this.offsetX,o[l].y*s+this.offsetY);i.strokeStyle="rgba(0, 0, 0, 0.3)",i.lineWidth=(r.width+2)*s,i.lineCap="round",i.lineJoin="round",i.setLineDash([]),i.stroke(),i.beginPath(),i.moveTo(o[0].x*s+this.offsetX,o[0].y*s+this.offsetY);for(let l=1;l<o.length;l++)i.lineTo(o[l].x*s+this.offsetX,o[l].y*s+this.offsetY);i.strokeStyle=r.color,i.lineWidth=r.width*s,i.setLineDash(r.dash.map(l=>l*s)),i.stroke()}}i.setLineDash([])}drawPOIs(e,t,i={}){const s=this.ctx,a=this.scale,n=i.elevationScale||8,r=[...t].sort((o,l)=>o.r!==l.r?o.r-l.r:o.type.size-l.type.size);for(const o of r){const l=e.getCell(o.q,o.r),c=e.hexToPixel(o.q,o.r),d=l?(l.elevation-.4)*n*a:0,u=c.x*a+this.offsetX,h=c.y*a+this.offsetY-d,m=(o.type.size+2)*a*2;s.beginPath(),s.arc(u+1,h+1,m,0,Math.PI*2),s.fillStyle="rgba(0, 0, 0, 0.4)",s.fill(),s.beginPath(),s.arc(u,h,m,0,Math.PI*2);const g=s.createRadialGradient(u-m*.3,h-m*.3,0,u,h,m);g.addColorStop(0,this.adjustBrightness(o.type.color,.3)),g.addColorStop(1,o.type.color),s.fillStyle=g,s.fill(),s.strokeStyle=this.adjustBrightness(o.type.color,-.3),s.lineWidth=Math.max(1,a),s.stroke(),s.fillStyle="#fff",s.font=`bold ${m*1.2}px sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(o.type.icon,u,h)}}drawCorruptionAuras(e,t,i={}){const s=this.ctx,a=this.scale,n=i.elevationScale||8,r={OUTER:{alpha:.12,pulseSpeed:4e3,particleChance:0},MID:{alpha:.25,pulseSpeed:2500,particleChance:.3},INNER:{alpha:.45,pulseSpeed:1500,particleChance:.8}};s.save();for(const o of t){const{q:l,r:c,intensity:d,tier:u,effects:h}=o;if(!h)continue;const m=e.getCell(l,c);if(!m)continue;const g=e.hexToPixel(l,c),y=m?(m.elevation-.4)*n*a:0,f=g.x*a+this.offsetX,p=g.y*a+this.offsetY-y,v=e.hexSize*a,b=[];for(let w=0;w<6;w++){const x=Math.PI/3*w-Math.PI/6;b.push({x:f+v*Math.cos(x),y:p+v*Math.sin(x)})}s.beginPath(),s.moveTo(b[0].x,b[0].y);for(let w=1;w<6;w++)s.lineTo(b[w].x,b[w].y);s.closePath();const k=r[u]||r.OUTER;if(s.fillStyle=h.color,s.globalAlpha=k.alpha,s.fill(),u==="MID"||u==="INNER"){const w=Date.now()%k.pulseSpeed/k.pulseSpeed,x=.05+.15*Math.sin(w*Math.PI*2);s.globalAlpha=x,s.strokeStyle=u==="INNER"?"#ff2222":h.color,s.lineWidth=(u==="INNER"?3:2)*a,s.stroke()}u==="INNER"&&a>1.2&&Math.random()<k.particleChance?this.drawCorruptionParticles(f,p,v,"#ff4444",1):u==="MID"&&a>1.5&&Math.random()<k.particleChance&&this.drawCorruptionParticles(f,p,v,h.color,.6)}s.globalAlpha=1,s.restore()}drawCorruptionParticles(e,t,i,s,a){const n=this.ctx,r=Math.floor(3*a),o=Date.now()/1e3;n.save(),n.globalAlpha=.6*a,n.fillStyle=s;for(let l=0;l<r;l++){const c=(o+l*2.09)%(Math.PI*2),d=i*.3*(.5+.5*Math.sin(o*2+l)),u=e+Math.cos(c)*d,h=t+Math.sin(c)*d-d*.5,m=2+Math.sin(o*3+l)*1;n.beginPath(),n.arc(u,h,m,0,Math.PI*2),n.fill()}n.restore()}drawOverworldCorruption(e,t,i,s,a={}){if(!t||!i)return;const n=this.ctx,r=this.scale,o=a.elevationScale||8,l={TAINTED:{color:"rgba(120, 80, 160, 0.15)",borderColor:"rgba(120, 80, 160, 0.25)",pulseSpeed:6e3},CORRUPTED:{color:"rgba(140, 60, 120, 0.22)",borderColor:"rgba(140, 60, 120, 0.35)",pulseSpeed:4e3},BLIGHTED:{color:"rgba(100, 30, 80, 0.30)",borderColor:"rgba(150, 50, 100, 0.45)",pulseSpeed:2500}};n.save();const c=s||[];for(const d of c){const{q:u,r:h}=d,m=t.getZoneAt(u,h);if(m==="SAFE")continue;const g=l[m];if(!g)continue;const y=e.hexToPixel(u,h),f=d.elevation?(d.elevation-.4)*o*r:0,p=y.x*r+this.offsetX,v=y.y*r+this.offsetY-f,b=e.hexSize*r,k=[];for(let w=0;w<6;w++){const x=Math.PI/3*w-Math.PI/6;k.push({x:p+b*Math.cos(x),y:v+b*Math.sin(x)})}n.beginPath(),n.moveTo(k[0].x,k[0].y);for(let w=1;w<6;w++)n.lineTo(k[w].x,k[w].y);if(n.closePath(),n.fillStyle=g.color,n.globalAlpha=1,n.fill(),m==="CORRUPTED"||m==="BLIGHTED"){const w=Date.now()%g.pulseSpeed/g.pulseSpeed,x=.15+.15*Math.sin(w*Math.PI*2);n.globalAlpha=x,n.strokeStyle=g.borderColor,n.lineWidth=(m==="BLIGHTED"?3:2)*r,n.stroke()}}n.globalAlpha=1,n.restore()}hashNoise(e,t,i=0){const s=Math.sin(e*12.9898+t*78.233+i)*43758.5453;return s-Math.floor(s)}smoothNoise(e,t,i=0){const s=Math.floor(e),a=Math.floor(t),n=e-s,r=t-a,o=n*n*(3-2*n),l=r*r*(3-2*r),c=this.hashNoise(s,a,i),d=this.hashNoise(s+1,a,i),u=this.hashNoise(s,a+1,i),h=this.hashNoise(s+1,a+1,i),m=c+o*(d-c),g=u+o*(h-u);return m+l*(g-m)}cloudNoise(e,t,i){const s=this.cloudShadows,a=e+i*s.windX,n=t+i*s.windY;let r=0,o=1,l=1,c=0;for(let u=0;u<4;u++)r+=this.smoothNoise(a*l,n*l,u*100)*o,c+=o,o*=.5,l*=2;r/=c;const d=1-s.coverage;return r<d?0:(r-d)/(1-d)}drawCloudShadows(e,t={}){var u;const i=this.cloudShadows;if(!i.enabled)return;const s=this.timeOfDay.hour;if(s>=20||s<6)return;let a=1;s>=6&&s<8?a=(s-6)/2:s>=18&&s<20&&(a=1-(s-18)/2),i.time+=i.speed*16;const n=this.ctx,r=this.scale,o=t.elevationScale||8,l=t.visibleCells||[];n.save();const c=i.shadowWidth+i.shadowGap,d=i.time*1e3;for(const h of l){const m=(u=h.biome)==null?void 0:u.id;if(m==="ocean"||m==="deep_ocean"||m==="coast")continue;const g=e.hexToPixel(h.q,h.r),f=((g.x+g.y*.3+d)%c+c)%c;let p=0;if(f<i.shadowWidth){const C=Math.min(f/i.edgeSoftness,1),_=Math.min((i.shadowWidth-f)/i.edgeSoftness,1);p=Math.min(C,_)}if(p<=.01)continue;const v=`${h.q},${h.r}`;let b=this._hexCornersCache.get(v);b||(b=e.getHexCorners(h.q,h.r));const k=(h.elevation-.4)*o*r,w=b.map(C=>({x:C.x*r+this.offsetX,y:C.y*r+this.offsetY-k}));n.beginPath(),n.moveTo(w[0].x,w[0].y);for(let C=1;C<w.length;C++)n.lineTo(w[C].x,w[C].y);n.closePath();const x=p*i.opacity*a;n.fillStyle=`rgba(20, 30, 50, ${x})`,n.fill()}n.restore()}drawWaterAnimation(e,t={}){var o;const i=this.waterAnimation;if(!i.enabled)return;i.time+=i.speed*16;const s=this.ctx,a=this.scale,n=t.elevationScale||8,r=t.visibleCells||[];s.save();for(const l of r){const c=(o=l.biome)==null?void 0:o.id;if(c!=="ocean"&&c!=="deep_ocean"&&c!=="coast")continue;const d=e.hexToPixel(l.q,l.r),u=d.x*i.waveScale,h=d.y*i.waveScale,m=Math.sin(u+i.time*1)*Math.cos(h*.7+i.time*.8),g=Math.sin(u*1.3-i.time*.6)*Math.sin(h*.9+i.time*1.2),y=Math.cos(u*.8+h*.5+i.time*.5),f=(m+g*.5+y*.3)/1.8,p=`${l.q},${l.r}`;let v=this._hexCornersCache.get(p);v||(v=e.getHexCorners(l.q,l.r));const b=(l.elevation-.4)*n*a,k=v.map(x=>({x:x.x*a+this.offsetX,y:x.y*a+this.offsetY-b}));s.beginPath(),s.moveTo(k[0].x,k[0].y);for(let x=1;x<k.length;x++)s.lineTo(k[x].x,k[x].y);s.closePath();const w=i.shimmerIntensity;f>0?s.fillStyle=`rgba(200, 230, 255, ${f*w})`:s.fillStyle=`rgba(0, 20, 40, ${-f*w*.7})`,s.fill()}s.restore()}drawBiomeDetails(e,t={}){if(this.scale<this.detailThresholds.showBiomeIcons)return;const i=this.ctx,s=this.scale,a=t.elevationScale||8,n=t.playerPosition||null,r=t.walkRange||1,o=t.visibleCells||this._visibleCells;i.save(),i.globalAlpha=1;for(const l of o){if(!l.hasResources||!l.resourceIcon||n&&e.distance(n.q,n.r,l.q,l.r)>r)continue;const c=e.hexToPixel(l.q,l.r),d=(l.elevation-.4)*a*s,u=c.x*s+this.offsetX,h=c.y*s+this.offsetY-d,g=(l.q*73856093^l.r*19349663)%1e3/1e3,y=l.resourceIcon,f=y==="ðŸŒ²"||y==="ðŸŒ³"||y==="ðŸŒ´",p=y==="ðŸª¨";let v;if(f){const b=24*s,k=g*10*s;v=Math.max(16,Math.min(36,b+k))}else if(p){const b=18*s,k=g*8*s;v=Math.max(14,Math.min(28,b+k))}else v=Math.max(12,Math.min(20,14*s));i.globalAlpha=1,this.drawIcon(y,u,h,v)}i.restore()}drawChestIcons(e,t={}){const i=this.ctx,s=this.scale,a=t.elevationScale||8,n=t.playerPosition||null,r=t.walkRange||1,o=t.openedChests||new Set,l=t.visibleCells||this._visibleCells,c={wooden:"ðŸ§°",iron:"ðŸ“¦",golden:"ðŸŽ"};i.save(),i.globalAlpha=1;for(const d of l){if(!d.chest||d.chest.opened)continue;const u=`${d.q},${d.r}`;if(o.has(u)||n&&e.distance(n.q,n.r,d.q,d.r)>r)continue;const h=e.hexToPixel(d.q,d.r),m=(d.elevation-.4)*a*s,g=h.x*s+this.offsetX,y=h.y*s+this.offsetY-m,f=c[d.chest.type]||"ðŸ§°",p=Math.max(16,Math.min(28,22*s));let v={};d.chest.type==="golden"?v={shadowColor:"rgba(255, 215, 0, 0.6)",shadowBlur:8*s}:d.chest.type==="iron"&&(v={shadowColor:"rgba(150, 150, 180, 0.4)",shadowBlur:4*s}),this.drawIcon(f,g,y,p,v)}i.restore()}drawRivers(e,t={}){const i=this.ctx,s=this.scale;for(const a of e){const n=a.spline;if(!n||n.length<2)continue;const r=2,o=5;i.beginPath(),i.moveTo(n[0].x*s+this.offsetX,n[0].y*s+this.offsetY);for(let l=1;l<n.length;l++)i.lineTo(n[l].x*s+this.offsetX,n[l].y*s+this.offsetY);i.strokeStyle="rgba(30, 80, 120, 0.5)",i.lineWidth=(o+2)*s,i.lineCap="round",i.lineJoin="round",i.stroke();for(let l=1;l<n.length;l++){const c=l/n.length,d=r+(o-r)*c;i.beginPath(),i.moveTo(n[l-1].x*s+this.offsetX,n[l-1].y*s+this.offsetY),i.lineTo(n[l].x*s+this.offsetX,n[l].y*s+this.offsetY);const u=Math.floor(c*30);i.strokeStyle=`rgb(${70+u}, ${130+u}, ${180+u})`,i.lineWidth=d*s,i.lineCap="round",i.stroke()}}}drawPathPreview(e,t,i,s=8){if(!t||t.length<2)return;const a=this.ctx,n=this.scale;a.save();for(let c=0;c<t.length;c++){const d=t[c],u=e.getCell(d.q,d.r),h=e.getHexCorners(d.q,d.r),m=u?(u.elevation-.4)*s:0,g=h.map(f=>({x:f.x,y:f.y-m}));let y;c===0?y="rgba(100, 200, 255, 0.3)":c===t.length-1?y="rgba(100, 255, 150, 0.4)":y="rgba(255, 255, 100, 0.25)",this.drawHex(g,y,null)}a.beginPath();const r=e.getCell(t[0].q,t[0].r),o=e.hexToPixel(t[0].q,t[0].r),l=r?(r.elevation-.4)*s*n:0;a.moveTo(o.x*n+this.offsetX,o.y*n+this.offsetY-l);for(let c=1;c<t.length;c++){const d=e.getCell(t[c].q,t[c].r),u=e.hexToPixel(t[c].q,t[c].r),h=d?(d.elevation-.4)*s*n:0;a.lineTo(u.x*n+this.offsetX,u.y*n+this.offsetY-h)}if(a.strokeStyle="rgba(0, 0, 0, 0.5)",a.lineWidth=4*n,a.lineCap="round",a.lineJoin="round",a.stroke(),a.strokeStyle="rgba(255, 255, 150, 0.8)",a.lineWidth=2*n,a.stroke(),t.length>=2){const c=t[t.length-1],d=t[t.length-2],u=e.getCell(c.q,c.r),h=e.hexToPixel(c.q,c.r),m=e.hexToPixel(d.q,d.r),g=u?(u.elevation-.4)*s*n:0,y=Math.atan2(h.y-m.y,h.x-m.x),f=8*n,p=h.x*n+this.offsetX,v=h.y*n+this.offsetY-g;a.beginPath(),a.moveTo(p,v),a.lineTo(p-f*Math.cos(y-Math.PI/6),v-f*Math.sin(y-Math.PI/6)),a.moveTo(p,v),a.lineTo(p-f*Math.cos(y+Math.PI/6),v-f*Math.sin(y+Math.PI/6)),a.strokeStyle="rgba(100, 255, 150, 0.9)",a.lineWidth=3*n,a.stroke()}a.restore()}drawPlayerMarker(e,t,i=8,s=null,a=null){if(!t)return;const n=this.ctx,r=this.scale;let o,l;const c=e.getCell(t.q,t.r);if(s){o=s.x*r+this.offsetX;let _=0;if(a){const M=e.getCell(a.fromQ,a.fromR),S=e.getCell(a.toQ,a.toR),A=M?M.elevation-.4:0,q=S?S.elevation-.4:0,U=A+(q-A)*a.t,N=(M==null?void 0:M.depthLevel)||0,ne=(S==null?void 0:S.depthLevel)||0,Z=N+(ne-N)*a.t;_=(U*i-Z*10)*r}else{const M=c?(c.elevation-.4)*i:0,S=((c==null?void 0:c.depthLevel)||0)*10;_=(M-S)*r}l=s.y*r+this.offsetY-_}else{const _=e.hexToPixel(t.q,t.r),M=c?(c.elevation-.4)*i:0,S=((c==null?void 0:c.depthLevel)||0)*10,A=(M-S)*r;o=_.x*r+this.offsetX,l=_.y*r+this.offsetY-A}const d=performance.now()/1e3,u=s!==null,h=Math.sin(d*2)*.1,m=u?Math.sin(d*8)*.25:0,g=1+h+m,f=7*r*g,p=.5+Math.sin(d*3)*.2,v=u?p+.3:p,b=25*r,k=35*r;n.save(),n.globalCompositeOperation="saturation",n.globalAlpha=.15,n.beginPath(),n.arc(o,l,k,0,Math.PI*2),n.fillStyle="#fff",n.fill(),n.restore(),n.save(),n.globalCompositeOperation="saturation",n.globalAlpha=.4,n.beginPath(),n.arc(o,l,b,0,Math.PI*2),n.fillStyle="#fff",n.fill(),n.restore();const w=f*3.5,x=n.createRadialGradient(o,l,f*.5,o,l,w);x.addColorStop(0,`rgba(100, 200, 255, ${v*.6})`),x.addColorStop(.4,`rgba(80, 180, 255, ${v*.3})`),x.addColorStop(.7,`rgba(60, 160, 255, ${v*.1})`),x.addColorStop(1,"rgba(50, 150, 255, 0)"),n.beginPath(),n.arc(o,l,w,0,Math.PI*2),n.fillStyle=x,n.fill(),n.beginPath(),n.arc(o,l,f+6*r,0,Math.PI*2),n.fillStyle=`rgba(120, 220, 255, ${v*.5})`,n.fill();const C=n.createRadialGradient(o-f*.3,l-f*.3,0,o,l,f);C.addColorStop(0,"#8cf"),C.addColorStop(.5,"#4af"),C.addColorStop(1,"#28a"),n.beginPath(),n.arc(o,l,f,0,Math.PI*2),n.fillStyle=C,n.fill(),n.strokeStyle="#fff",n.lineWidth=2.5*r,n.stroke(),n.beginPath(),n.arc(o-f*.2,l-f*.2,f*.35,0,Math.PI*2),n.fillStyle="rgba(255, 255, 255, 0.8)",n.fill()}getCellVerticalOffset(e,t=8){if(!e)return 0;const i=(e.elevation-.4)*t,s=(e.depthLevel||0)*10;return(i-s)*this.scale}drawWorldEnemies(e,t,i=8){if(!t||t.length===0)return;const s=this.ctx,a=this.scale;s.save(),s.globalAlpha=1;for(const n of t){const r=e.getCell(n.q,n.r);if(!r)continue;const o=e.hexToPixel(n.q,n.r),l=this.getCellVerticalOffset(r,i),c=o.x*a+this.offsetX,d=o.y*a+this.offsetY-l,u=7*a;s.beginPath(),s.arc(c,d,u+4,0,Math.PI*2),s.fillStyle="rgba(255, 80, 80, 0.4)",s.fill(),s.beginPath(),s.arc(c,d,u,0,Math.PI*2),s.fillStyle="#a33",s.fill(),s.strokeStyle="#fff",s.lineWidth=2*a,s.stroke();const h=Math.max(12,Math.min(18,14*a));s.font=`${h}px sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(n.icon,c,d)}s.restore()}drawRoamingNPCs(e,t,i=8){if(!t||t.length===0)return;const s=this.ctx,a=this.scale;s.save(),s.globalAlpha=1;for(const n of t){const r=n.currentQ??n.q,o=n.currentR??n.r,l=e.getCell(r,o);if(!l)continue;const c=e.hexToPixel(r,o),d=this.getCellVerticalOffset(l,i),u=c.x*a+this.offsetX,h=c.y*a+this.offsetY-d,m=7*a;s.beginPath(),s.arc(u,h,m+4,0,Math.PI*2),s.fillStyle="rgba(80, 200, 180, 0.4)",s.fill(),s.beginPath(),s.arc(u,h,m,0,Math.PI*2),s.fillStyle="#3a8a80",s.fill(),s.strokeStyle="#fff",s.lineWidth=2*a,s.stroke();const g=Math.max(12,Math.min(18,14*a));s.font=`${g}px sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(n.icon,u,h)}s.restore()}renderWorld(e,t,i,s={},a=[]){if(!e||typeof e.forEach!="function"){console.error("renderWorld: Invalid grid",e),this.clear(),this.ctx.fillStyle="#ff0000",this.ctx.font="20px monospace",this.ctx.fillText("Render Error: Invalid grid",50,50);return}try{this._renderWorldInternal(e,t,i,s,a)}catch(n){console.error("renderWorld error:",n),this.ctx.fillStyle="rgba(0,0,0,0.8)",this.ctx.fillRect(0,0,400,80),this.ctx.fillStyle="#ff4444",this.ctx.font="16px monospace",this.ctx.fillText("Render Error: "+n.message,10,30),this.ctx.fillText("Check console for details",10,55)}}_renderWorldInternal(e,t,i,s,a){var lt,ct,dt,ut;const{shadingIntensity:n=.2,pathPreview:r=null,playerPosition:o=null,elevationScale:l=8}=s,c=this.scale<this.detailThresholds.minimapMode,d=this.scale<this.detailThresholds.showTimeTinting,u=c?0:l,h=s.isDungeon||!1,m=s.dungeonExplored||new Set,g=s.dungeonEnemies||new Map,y=s.dungeonChests||new Map,f=s.dungeonExits||[],p=s.dungeonLadders||new Map,v=s.dungeonDoors||new Map,b=s.dungeonPortals||new Map,k=s.dungeonQuestItems||new Map,w=s.dungeonFloorBrightness||1;this.clear(),this.centerGrid(e);const x=this.getTimeTint(this.timeOfDay.hour,this.timeOfDay.minute),C=e.hexSize*this.scale,_=C*2,M=(-this.offsetX-_)/this.scale,S=(this.width-this.offsetX+_)/this.scale,A=(-this.offsetY-_)/this.scale,q=(this.height-this.offsetY+_)/this.scale,U=`${Math.round(M)},${Math.round(A)},${Math.round(S)},${Math.round(q)}`;let N;this._lastViewportKey!==U&&(this._visibleCells=[],this._visibleCellsSet.clear(),e.forEach(E=>{if(!E.biome)return;const F=e.hexToPixel(E.q,E.r),K=C*1.2;F.x+K<M||F.x-K>S||F.y+K<A||F.y-K>q||(this._visibleCells.push(E),this._visibleCellsSet.add(`${E.q},${E.r}`))}),this._lastViewportKey=U),N=this._visibleCells,N.sort((E,F)=>{if(E.r!==F.r)return E.r-F.r;const K=E.depthLevel||0,X=F.depthLevel||0;if(K!==X)return X-K;const ce=E.heightLevel||0,ee=F.heightLevel||0;return ce!==ee?ce-ee:E.elevation-F.elevation});for(const E of N){const F=`${E.q},${E.r}`;if(h&&m){const re=m.has(F);let Ve=!1;if(o&&typeof o.q=="number"&&typeof o.r=="number"?Ve=this.hexDistance(E.q,E.r,o.q,o.r)<=2:Ve=!1,!re&&!Ve)continue}const K=`${E.q},${E.r}`;let X=this._hexCornersCache.get(K);X||(X=e.getHexCorners(E.q,E.r),this._hexCornersCache.set(K,X));const ce=(E.elevation-.4)*u*this.scale,ee=E.heightLevel||0;if(!c&&ee>0){const re={x:ee*4*this.scale,y:ee*8*this.scale};this.drawHexDropShadow(X,.5+ee*.15,re)}const ci=E.biome.color,di=(E.elevation-.5)*n;let V=this.adjustBrightness(ci,di);if(!h&&!c){const re=this.getShorelineFactor(E,e);re>0&&(V=this.blendColors(V,this.shorelineColor,re))}if(h&&w<1){const re=1-w;V=this.adjustBrightness(V,-re*.6),w<.5&&(V=this.desaturateColor(V,.3))}x&&!h&&!d&&(V=this.applyTimeTint(V,x));const ht=E.depthLevel||0;c?this.drawHex(X,V,null,(lt=E.biome)==null?void 0:lt.id,ce):ee>0&&!h?this.drawRaisedHex(X,V,ee,null,(ct=E.biome)==null?void 0:ct.id,ce):ht>0&&!h?this.drawInsetHex(X,V,ht,null,(dt=E.biome)==null?void 0:dt.id,ce):this.drawHexWithBevel(X,V,E.elevation,null,!1,(ut=E.biome)==null?void 0:ut.id,ce)}!h&&!c&&this.cloudShadows.enabled&&this.drawCloudShadows(e,{elevationScale:l,visibleCells:N}),!h&&!c&&this.waterAnimation.enabled&&this.drawWaterAnimation(e,{elevationScale:l,visibleCells:N}),r&&r.length>0&&this.drawPathPreview(e,r,o,l);const ne=s.walkRange||1;this.scale>=this.detailThresholds.showBiomeIcons&&!h&&this.drawBiomeDetails(e,{elevationScale:l,playerPosition:o,walkRange:ne,visibleCells:N});const Z=s.openedChests||new Set;h||this.drawChestIcons(e,{elevationScale:l,playerPosition:o,walkRange:ne,openedChests:Z,visibleCells:N}),a&&a.length>0&&this.drawRivers(a);const L=s.overworldCorruption;!h&&!c&&L&&this.drawOverworldCorruption(e,L,o,N,{elevationScale:l});const G=s.corruptionAuras||[];!h&&!c&&G.length>0&&this.drawCorruptionAuras(e,G,{elevationScale:l}),i&&i.length>0&&this.drawRoads(i),!h&&t&&t.length>0&&this.drawPOIs(e,t,{elevationScale:l});const Ae=s.worldEnemies||[];!h&&Ae.length>0&&this.drawWorldEnemies(e,Ae,l);const Ue=s.roamingNPCs||[];if(!h&&Ue.length>0&&this.drawRoamingNPCs(e,Ue,l),h&&this.drawDungeonMarkers(e,{enemies:g,chests:y,exits:f,ladders:p,doors:v,portals:b,questItems:k,explored:m,playerPosition:o,floorBrightness:w,elevationScale:l}),!c){const E=s.torchLight||0,F=s.facingAngle||0;this.renderNightFog(e,o,{torchLight:E,elevationScale:l,facingAngle:F,visibleCells:N})}if(o){const E=s.playerVisualPos||null,F=s.playerTransitionInfo||null;this.drawPlayerMarker(e,o,l,E,F)}}isHexAdjacent(e,t,i,s){const a=[[1,0],[-1,0],[0,1],[0,-1],[1,-1],[-1,1]];for(const[n,r]of a)if(e+n===i&&t+r===s)return!0;return!1}hexDistance(e,t,i,s){return(Math.abs(e-i)+Math.abs(e+t-i-s)+Math.abs(t-s))/2}drawDungeonMarkers(e,t){const{enemies:i,chests:s,exits:a,questItems:n,ladders:r,doors:o,portals:l,explored:c,playerPosition:d,floorBrightness:u=1,elevationScale:h=8}=t,m=this.ctx;if(a&&a.length>0)for(const g of a){if(!(c.has(`${g.q},${g.r}`)||d&&this.hexDistance(g.q,g.r,d.q,d.r)<=2))continue;const f=e.getCell(g.q,g.r);if(f){const p=e.hexToPixel(g.q,g.r),v=((f.elevation||.5)-.4)*h,b=p.x*this.scale+this.offsetX,k=(p.y-v)*this.scale+this.offsetY;m.font=`${16*this.scale}px Arial`,m.textAlign="center",m.textBaseline="middle",g.isEntrance?(m.shadowColor="#4a9eff",m.shadowBlur=6*this.scale,m.fillText("ðŸšª",b,k),m.shadowBlur=0):(m.shadowColor="#88ff88",m.shadowBlur=6*this.scale,m.fillText("ðŸšª",b,k),m.shadowBlur=0)}}if(r&&r.size>0)for(const[g,y]of r){const[f,p]=g.split(",").map(Number);if(!(c.has(g)||d&&this.hexDistance(f,p,d.q,d.r)<=2))continue;const b=e.getCell(f,p);if(!b)continue;const k=e.hexToPixel(f,p),w=((b.elevation||.5)-.4)*h,x=k.x*this.scale+this.offsetX,C=(k.y-w)*this.scale+this.offsetY;m.font=`${18*this.scale}px Arial`,m.textAlign="center",m.textBaseline="middle",y.direction==="down"?(m.shadowColor="#ff9944",m.shadowBlur=6*this.scale):(m.shadowColor="#44ff99",m.shadowBlur=6*this.scale),m.fillText(y.icon||"ðŸªœ",x,C),m.shadowBlur=0}if(o&&o.size>0)for(const[g,y]of o){if(y.opened)continue;const[f,p]=g.split(",").map(Number);if(!(c.has(g)||d&&this.hexDistance(f,p,d.q,d.r)<=2))continue;const b=e.getCell(f,p);if(!b)continue;const k=e.hexToPixel(f,p),w=((b.elevation||.5)-.4)*h,x=k.x*this.scale+this.offsetX,C=(k.y-w)*this.scale+this.offsetY;m.font=`${16*this.scale}px Arial`,m.textAlign="center",m.textBaseline="middle",y.locked&&(m.shadowColor="#ff4444",m.shadowBlur=4*this.scale),m.fillText("ðŸšª",x,C),m.shadowBlur=0}if(l&&l.size>0)for(const[g,y]of l){const[f,p]=g.split(",").map(Number);if(!(c.has(g)||d&&this.hexDistance(f,p,d.q,d.r)<=2))continue;const b=e.getCell(f,p);if(!b)continue;const k=e.hexToPixel(f,p),w=((b.elevation||.5)-.4)*h,x=k.x*this.scale+this.offsetX,C=(k.y-w)*this.scale+this.offsetY,_=Date.now()/200,M=8+Math.sin(_)*4;m.font=`${20*this.scale}px Arial`,m.textAlign="center",m.textBaseline="middle",y.destination==="cult"?(m.shadowColor="#9900ff",m.shadowBlur=M*this.scale):(m.shadowColor="#ffcc00",m.shadowBlur=M*this.scale),m.fillText(y.icon||"ðŸŒ€",x,C),m.shadowBlur=0}for(const[g,y]of s){if(y.opened)continue;const[f,p]=g.split(",").map(Number);if(!(c.has(g)||d&&this.hexDistance(f,p,d.q,d.r)<=2))continue;const b=e.getCell(f,p);if(!b)continue;const k=e.hexToPixel(f,p),w=((b.elevation||.5)-.4)*h,x=k.x*this.scale+this.offsetX,C=(k.y-w)*this.scale+this.offsetY;m.font=`${16*this.scale}px Arial`,m.textAlign="center",m.textBaseline="middle",m.fillText(y.icon||"ðŸ§°",x,C)}if(n&&n.size>0)for(const[g,y]of n){if(y.found)continue;const[f,p]=g.split(",").map(Number);if(!(c.has(g)||d&&this.hexDistance(f,p,d.q,d.r)<=2))continue;const b=e.getCell(f,p);if(!b)continue;const k=e.hexToPixel(f,p),w=((b.elevation||.5)-.4)*h,x=k.x*this.scale+this.offsetX,C=(k.y-w)*this.scale+this.offsetY,_=Date.now()/300,M=4+Math.sin(_)*2;m.shadowColor="#ffdd44",m.shadowBlur=M*this.scale,m.font=`${16*this.scale}px Arial`,m.textAlign="center",m.textBaseline="middle",m.fillText("âœ¨",x,C),m.shadowBlur=0}for(const[g,y]of i){if(y.defeated)continue;const[f,p]=g.split(",").map(Number);if(!(c.has(g)||d&&this.hexDistance(f,p,d.q,d.r)<=2))continue;const b=f,k=p,w=e.getCell(b,k);if(!w)continue;const x=e.hexToPixel(b,k),C=((w.elevation||.5)-.4)*h,_=x.x*this.scale+this.offsetX,M=(x.y-C)*this.scale+this.offsetY;m.font=`${y.isBoss?22:16}px Arial`,m.textAlign="center",m.textBaseline="middle",y.isBoss?(m.shadowColor="#ff0000",m.shadowBlur=8*this.scale,m.fillText("ðŸ’€",_,M),m.shadowBlur=0):m.fillText("ðŸ‘¹",_,M),y.hasKey&&(m.font=`${10*this.scale}px Arial`,m.fillText("ðŸ”‘",_+8*this.scale,M-8*this.scale))}}}const pt=["agriculture","construction","medicine","tailoring","warriors","smithing","rangers"],ft={agriculture:{id:"agriculture",name:"Agriculture",icon:"ðŸŒ¾",description:"Farming, food production, and crop management",color:"#8B4513",yields:"food",primaryResource:"food"},construction:{id:"construction",name:"Construction",icon:"ðŸ”¨",description:"Building, woodwork, and stonecraft",color:"#8B7355",yields:"materials",primaryResource:"wood"},medicine:{id:"medicine",name:"Clerical Medicine",icon:"âš•ï¸",description:"Healing, herbalism, and spiritual care",color:"#4A9F4A",yields:"healing",primaryResource:"herbs"},tailoring:{id:"tailoring",name:"Tailoring",icon:"ðŸ§µ",description:"Clothing, leatherwork, and textiles",color:"#9932CC",yields:"cloth",primaryResource:"leather"},warriors:{id:"warriors",name:"Warriors",icon:"âš”ï¸",description:"Combat training, defense, and military",color:"#B22222",yields:"defense",primaryResource:"weapons"},smithing:{id:"smithing",name:"Smithing",icon:"âš’ï¸",description:"Metalwork, forging, and tool crafting",color:"#4682B4",yields:"metal",primaryResource:"ore"},rangers:{id:"rangers",name:"Rangers",icon:"ðŸ¹",description:"Hunting, tracking, and wilderness survival",color:"#228B22",yields:"game",primaryResource:"pelts",isElite:!0}},yi={1:0,2:100,3:250,4:500,5:850,6:1300,7:1900,8:2700,9:3800,10:5200},vi={agriculture:{1:{foodPerDay:10,description:"+10 food/day"},2:{foodPerDay:15,farmEfficiency:.1,description:"+15 food/day, +10% farm efficiency"},3:{foodPerDay:20,farmEfficiency:.15,granaryCapacity:50,description:"+20 food/day, +15% efficiency, +50 storage"},4:{foodPerDay:30,farmEfficiency:.2,granaryCapacity:100,description:"+30 food/day, +20% efficiency, +100 storage"},5:{foodPerDay:40,farmEfficiency:.25,granaryCapacity:150,preserveFood:!0,description:"+40 food/day, food preservation unlocked"},6:{foodPerDay:55,farmEfficiency:.3,granaryCapacity:200,tradeBonus:.1,description:"+55 food/day, +10% food trade value"},7:{foodPerDay:70,farmEfficiency:.35,granaryCapacity:300,tradeBonus:.15,description:"+70 food/day, surplus export unlocked"},8:{foodPerDay:90,farmEfficiency:.4,granaryCapacity:400,tradeBonus:.2,festivalBonus:!0,description:"+90 food/day, harvest festivals"},9:{foodPerDay:115,farmEfficiency:.45,granaryCapacity:500,tradeBonus:.25,description:"+115 food/day, regional supplier"},10:{foodPerDay:150,farmEfficiency:.5,granaryCapacity:750,tradeBonus:.3,legendaryHarvest:!0,description:"+150 food/day, legendary harvests"}},construction:{1:{buildSpeed:.1,description:"+10% build speed"},2:{buildSpeed:.15,woodPerDay:5,description:"+15% build speed, +5 wood/day"},3:{buildSpeed:.2,woodPerDay:10,stonePerDay:3,description:"+20% build speed, +10 wood, +3 stone/day"},4:{buildSpeed:.25,woodPerDay:15,stonePerDay:5,repairCost:-.1,description:"+25% build speed, -10% repair costs"},5:{buildSpeed:.3,woodPerDay:20,stonePerDay:8,repairCost:-.15,fortifications:!0,description:"+30% build speed, fortifications unlocked"},6:{buildSpeed:.35,woodPerDay:30,stonePerDay:12,repairCost:-.2,description:"+35% build speed, master carpentry"},7:{buildSpeed:.4,woodPerDay:40,stonePerDay:18,repairCost:-.25,monuments:!0,description:"+40% build speed, monuments unlocked"},8:{buildSpeed:.45,woodPerDay:55,stonePerDay:25,repairCost:-.3,description:"+45% build speed, grand architecture"},9:{buildSpeed:.5,woodPerDay:70,stonePerDay:35,repairCost:-.35,description:"+50% build speed, regional builder"},10:{buildSpeed:.6,woodPerDay:100,stonePerDay:50,repairCost:-.4,legendaryStructures:!0,description:"+60% build speed, legendary structures"}},medicine:{1:{healingPerDay:5,description:"+5 HP healing/day for injured"},2:{healingPerDay:8,herbGathering:.1,description:"+8 healing/day, +10% herb gathering"},3:{healingPerDay:12,herbGathering:.15,diseaseResist:.1,description:"+12 healing/day, +10% disease resistance"},4:{healingPerDay:18,herbGathering:.2,diseaseResist:.15,curePoison:!0,description:"+18 healing/day, poison cure unlocked"},5:{healingPerDay:25,herbGathering:.25,diseaseResist:.2,hospitalCapacity:5,description:"+25 healing/day, hospital (5 beds)"},6:{healingPerDay:35,herbGathering:.3,diseaseResist:.25,hospitalCapacity:10,description:"+35 healing/day, expanded hospital"},7:{healingPerDay:50,herbGathering:.35,diseaseResist:.3,hospitalCapacity:15,resurrection:.1,description:"+50 healing/day, 10% resurrection chance"},8:{healingPerDay:70,herbGathering:.4,diseaseResist:.35,hospitalCapacity:20,resurrection:.15,description:"+70 healing/day, master healers"},9:{healingPerDay:95,herbGathering:.45,diseaseResist:.4,hospitalCapacity:30,resurrection:.2,description:"+95 healing/day, renowned healers"},10:{healingPerDay:130,herbGathering:.5,diseaseResist:.5,hospitalCapacity:50,resurrection:.3,miracleHealing:!0,description:"+130 healing/day, miraculous healing"}},tailoring:{1:{clothPerDay:3,description:"+3 cloth/day"},2:{clothPerDay:5,leatherPerDay:2,description:"+5 cloth/day, +2 leather/day"},3:{clothPerDay:8,leatherPerDay:4,armorBonus:.05,description:"+8 cloth/day, +5% armor quality"},4:{clothPerDay:12,leatherPerDay:6,armorBonus:.1,coldResist:.1,description:"+12 cloth/day, +10% cold resistance"},5:{clothPerDay:18,leatherPerDay:10,armorBonus:.15,coldResist:.15,fineClothes:!0,description:"+18 cloth/day, fine clothing unlocked"},6:{clothPerDay:25,leatherPerDay:14,armorBonus:.2,coldResist:.2,description:"+25 cloth/day, master tailoring"},7:{clothPerDay:35,leatherPerDay:20,armorBonus:.25,coldResist:.25,enchantedCloth:!0,description:"+35 cloth/day, enchanted fabrics"},8:{clothPerDay:50,leatherPerDay:28,armorBonus:.3,coldResist:.3,description:"+50 cloth/day, legendary tailor"},9:{clothPerDay:70,leatherPerDay:40,armorBonus:.35,coldResist:.35,description:"+70 cloth/day, regional clothier"},10:{clothPerDay:100,leatherPerDay:55,armorBonus:.4,coldResist:.4,legendaryArmor:!0,description:"+100 cloth/day, legendary garments"}},warriors:{1:{defenseBonus:.1,description:"+10% settlement defense"},2:{defenseBonus:.15,patrolRange:1,description:"+15% defense, patrol range +1"},3:{defenseBonus:.2,patrolRange:2,combatXP:.1,description:"+20% defense, +10% combat XP"},4:{defenseBonus:.25,patrolRange:2,combatXP:.15,guardCapacity:5,description:"+25% defense, guard barracks (5)"},5:{defenseBonus:.3,patrolRange:3,combatXP:.2,guardCapacity:10,siegeDefense:!0,description:"+30% defense, siege defense unlocked"},6:{defenseBonus:.35,patrolRange:3,combatXP:.25,guardCapacity:15,description:"+35% defense, veteran guards"},7:{defenseBonus:.4,patrolRange:4,combatXP:.3,guardCapacity:25,eliteUnits:!0,description:"+40% defense, elite units unlocked"},8:{defenseBonus:.45,patrolRange:4,combatXP:.35,guardCapacity:35,description:"+45% defense, war academy"},9:{defenseBonus:.5,patrolRange:5,combatXP:.4,guardCapacity:50,description:"+50% defense, regional garrison"},10:{defenseBonus:.6,patrolRange:6,combatXP:.5,guardCapacity:75,legendaryWarriors:!0,description:"+60% defense, legendary warriors"}},smithing:{1:{orePerDay:3,description:"+3 ore processed/day"},2:{orePerDay:5,metalPerDay:2,description:"+5 ore/day, +2 metal ingots/day"},3:{orePerDay:8,metalPerDay:4,weaponQuality:.1,description:"+8 ore/day, +10% weapon quality"},4:{orePerDay:12,metalPerDay:6,weaponQuality:.15,armorQuality:.1,description:"+12 ore/day, +15% weapon, +10% armor quality"},5:{orePerDay:18,metalPerDay:10,weaponQuality:.2,armorQuality:.15,steelWorking:!0,description:"+18 ore/day, steel working unlocked"},6:{orePerDay:25,metalPerDay:14,weaponQuality:.25,armorQuality:.2,description:"+25 ore/day, master smithing"},7:{orePerDay:35,metalPerDay:20,weaponQuality:.3,armorQuality:.25,enchantedMetal:!0,description:"+35 ore/day, enchanted metalwork"},8:{orePerDay:50,metalPerDay:28,weaponQuality:.35,armorQuality:.3,description:"+50 ore/day, legendary forge"},9:{orePerDay:70,metalPerDay:40,weaponQuality:.4,armorQuality:.35,description:"+70 ore/day, regional armory"},10:{orePerDay:100,metalPerDay:55,weaponQuality:.5,armorQuality:.4,legendaryWeapons:!0,description:"+100 ore/day, legendary weapons"}},rangers:{1:{huntingYield:.1,trackingRange:1,description:"+10% hunting yield, tracking range +1"},2:{huntingYield:.15,trackingRange:2,meatPerDay:5,description:"+15% hunting, +5 meat/day"},3:{huntingYield:.2,trackingRange:2,meatPerDay:10,peltsPerDay:3,description:"+20% hunting, +10 meat, +3 pelts/day"},4:{huntingYield:.25,trackingRange:3,meatPerDay:15,peltsPerDay:5,trapEfficiency:.15,description:"+25% hunting, +15% trap efficiency"},5:{huntingYield:.3,trackingRange:3,meatPerDay:22,peltsPerDay:8,trapEfficiency:.2,beastTracking:!0,description:"+30% hunting, beast tracking unlocked"},6:{huntingYield:.35,trackingRange:4,meatPerDay:30,peltsPerDay:12,trapEfficiency:.25,description:"+35% hunting, master trackers"},7:{huntingYield:.4,trackingRange:4,meatPerDay:40,peltsPerDay:18,trapEfficiency:.3,monsterHunting:!0,description:"+40% hunting, monster hunting unlocked"},8:{huntingYield:.45,trackingRange:5,meatPerDay:55,peltsPerDay:25,trapEfficiency:.35,description:"+45% hunting, legendary rangers"},9:{huntingYield:.5,trackingRange:5,meatPerDay:75,peltsPerDay:35,trapEfficiency:.4,description:"+50% hunting, regional wardens"},10:{huntingYield:.6,trackingRange:6,meatPerDay:100,peltsPerDay:50,trapEfficiency:.5,legendaryHunters:!0,description:"+60% hunting, legendary hunters"}}};function bi(T,e){const t=vi[T];if(!t)return{};const i={};for(let s=1;s<=e;s++)if(t[s])for(const[a,n]of Object.entries(t[s]))a!=="description"&&(typeof n=="number"||typeof n=="boolean")&&(i[a]=n);return i}function it(T=1){const e=2+Math.floor(Math.random()*2),s=[...pt.filter(n=>n!=="rangers")].sort(()=>Math.random()-.5).slice(0,e),a={};for(const n of pt)if(s.includes(n)){const o=1+Math.floor(Math.random()*3),l=yi[o];a[n]={level:o,xp:l,active:!0}}else a[n]={level:0,xp:0,active:!1};return a}const wi={wood:{construction:1},hardwood:{construction:2},pine_wood:{construction:1},tropical_wood:{construction:2},frozen_wood:{construction:2},bog_wood:{construction:1},stone:{construction:1,smithing:1},iron_ore:{smithing:2},copper_ore:{smithing:1},gold_ore:{smithing:2},silver_ore:{smithing:2},obsidian:{smithing:2,warriors:1},sandstone:{construction:1},ice_crystal:{smithing:2},herbs:{medicine:2,agriculture:1},wildflowers:{medicine:1},dry_herbs:{medicine:1,agriculture:1},mushrooms:{agriculture:2,medicine:1},swamp_moss:{medicine:2},lichen:{medicine:1},cactus_fruit:{agriculture:2,rangers:1},exotic_fruit:{agriculture:2},fish:{agriculture:2,rangers:1},game_meat:{rangers:3,agriculture:1,warriors:1},frog_legs:{rangers:1,agriculture:1},shells:{tailoring:1},leather:{tailoring:2},pelts:{tailoring:2,rangers:1}};function ki(T){return wi[T]||null}const J={1:{xp:0,title:"Fledgling"},2:{xp:100,title:"Novice"},3:{xp:250,title:"Developing"},4:{xp:500,title:"Established"},5:{xp:850,title:"Proficient"},6:{xp:1300,title:"Advanced"},7:{xp:1900,title:"Expert"},8:{xp:2700,title:"Master"},9:{xp:3800,title:"Renowned"},10:{xp:5200,title:"Legendary"}};function xi(T=1){return it(T)}function Ti(T){var t;const e=Math.min(T+1,7);return((t=J[e])==null?void 0:t.xp)||J[7].xp}const Ci={HAMLET:{id:"hamlet",name:"Hamlet",category:"settlement",size:1,icon:"âŒ‚",color:"#d4a574",minElevation:.42,maxElevation:.7,validBiomes:["grassland","forest","savanna","taiga"],rarity:.3,minDistance:8},VILLAGE:{id:"village",name:"Village",category:"settlement",size:2,icon:"âŒ‚",color:"#c4956a",minElevation:.42,maxElevation:.65,validBiomes:["grassland","forest","savanna"],rarity:.2,minDistance:12},TOWN:{id:"town",name:"Town",category:"settlement",size:3,icon:"â—‰",color:"#b8860b",minElevation:.42,maxElevation:.6,validBiomes:["grassland","forest"],rarity:.1,minDistance:20},CITADEL:{id:"citadel",name:"Citadel",category:"settlement",size:4,icon:"â˜…",color:"#ffd700",minElevation:.45,maxElevation:.6,validBiomes:["grassland","forest"],rarity:.03,minDistance:35},SHRINE:{id:"shrine",name:"Shrine",category:"landmark",size:1,icon:"â€ ",color:"#e6e6fa",minElevation:.42,maxElevation:.85,validBiomes:["grassland","forest","taiga","tundra","mountain"],rarity:.4,minDistance:5},RUINS:{id:"ruins",name:"Ruins",category:"landmark",size:2,icon:"âŒ˜",color:"#8b8682",minElevation:.42,maxElevation:.85,validBiomes:["grassland","forest","savanna","desert","tundra","highlands","taiga","swamp"],rarity:.02,minDistance:5},TEMPLE:{id:"temple",name:"Temple",category:"landmark",size:2,icon:"â–²",color:"#daa520",minElevation:.45,maxElevation:.75,validBiomes:["grassland","forest","rainforest"],rarity:.15,minDistance:12},KEEP:{id:"keep",name:"Keep",category:"landmark",size:2,icon:"â–£",color:"#696969",minElevation:.42,maxElevation:.85,validBiomes:["grassland","tundra","taiga","forest","highlands"],rarity:.02,minDistance:8},FORTRESS:{id:"fortress",name:"Fortress",category:"landmark",size:3,icon:"â–£",color:"#4a4a4a",minElevation:.45,maxElevation:.9,validBiomes:["tundra","taiga","mountain","highlands","grassland"],rarity:.02,minDistance:10},CASTLE:{id:"castle",name:"Castle",category:"landmark",size:3,icon:"â™œ",color:"#778899",minElevation:.5,maxElevation:.75,validBiomes:["grassland","forest"],rarity:.06,minDistance:25},CAVE:{id:"cave",name:"Cave",category:"landmark",size:1,icon:"â—–",color:"#2f2f2f",minElevation:.45,maxElevation:1,validBiomes:["mountain","snow_peak","tundra","taiga","highlands","forest","grassland"],rarity:.02,minDistance:4},MINE:{id:"mine",name:"Mine",category:"landmark",size:1,icon:"â›",color:"#8b4513",minElevation:.65,maxElevation:.9,validBiomes:["mountain","tundra","taiga"],rarity:.25,minDistance:7},FOREST_GROVE:{id:"forest_grove",name:"Ancient Grove",category:"landmark",size:2,icon:"â§",color:"#228b22",minElevation:.45,maxElevation:.65,validBiomes:["forest","rainforest"],rarity:.1,minDistance:12},CULT_SHRINE:{id:"cult_shrine",name:"Dark Shrine",category:"cult",size:1,icon:"â›§",color:"#2a0a2a",minElevation:.42,maxElevation:.9,validBiomes:["forest","swamp","taiga","tundra","mountain","grassland","highlands","savanna"],rarity:.05,minDistance:15,hidden:!0},BLOOD_ALTAR:{id:"blood_altar",name:"Blood Altar",category:"cult",size:2,icon:"ðŸ©¸",color:"#4a0000",minElevation:.42,maxElevation:.85,validBiomes:["swamp","forest","badlands","grassland","taiga","highlands"],rarity:.03,minDistance:18,hidden:!0},VOID_RIFT:{id:"void_rift",name:"Void Rift",category:"cult",size:2,icon:"ðŸŒ‘",color:"#0a0a1a",minElevation:.45,maxElevation:.95,validBiomes:["tundra","mountain","snow_peak","volcanic","highlands","taiga","forest"],rarity:.025,minDistance:20,hidden:!0},FLESH_PIT:{id:"flesh_pit",name:"Flesh Pit",category:"cult",size:2,icon:"ðŸ§¬",color:"#3a2a1a",minElevation:.42,maxElevation:.75,validBiomes:["swamp","rainforest","forest","grassland","savanna"],rarity:.025,minDistance:18,hidden:!0},MERCHANT_EXCHANGE:{id:"merchant_exchange",name:"Merchant Exchange",category:"guild",size:2,icon:"ðŸ’°",color:"#d4af37",minElevation:.42,maxElevation:.65,validBiomes:["grassland","forest","savanna"],rarity:.04,minDistance:25,guildId:"merchants"},EXPLORER_OUTPOST:{id:"explorer_outpost",name:"Explorer Outpost",category:"guild",size:2,icon:"ðŸ§­",color:"#2e8b57",minElevation:.45,maxElevation:.8,validBiomes:["grassland","forest","taiga","tundra","mountain"],rarity:.05,minDistance:20,guildId:"explorers"},ARTISAN_WORKSHOP:{id:"artisan_workshop",name:"Artisan Workshop",category:"guild",size:2,icon:"âš’ï¸",color:"#cd853f",minElevation:.42,maxElevation:.6,validBiomes:["grassland","forest"],rarity:.04,minDistance:22,guildId:"artisans"},IRON_BARRACKS:{id:"iron_barracks",name:"Iron Barracks",category:"guild",size:3,icon:"âš”ï¸",color:"#708090",minElevation:.5,maxElevation:.75,validBiomes:["grassland","tundra","taiga"],rarity:.03,minDistance:28,guildId:"iron_company"},SHADOW_DEN:{id:"shadow_den",name:"Shadow Den",category:"guild",size:1,icon:"ðŸ—ï¸",color:"#2f1f3f",minElevation:.45,maxElevation:.7,validBiomes:["forest","swamp","taiga"],rarity:.03,minDistance:25,guildId:"shadows",hidden:!0},ETHER_SANCTUM:{id:"ether_sanctum",name:"Ether Sanctum",category:"guild",size:2,icon:"ðŸ”®",color:"#9370db",minElevation:.55,maxElevation:.85,validBiomes:["forest","mountain","tundra"],rarity:.03,minDistance:30,guildId:"ether_conclave"},BLACKSMITH:{id:"blacksmith",name:"Blacksmith",category:"crafting",size:1,icon:"âš’ï¸",color:"#4a4a4a",minElevation:.45,maxElevation:.7,validBiomes:["grassland","forest","tundra","taiga","savanna"],rarity:.06,minDistance:15},ALCHEMY_TABLE:{id:"alchemy_table",name:"Alchemy Table",category:"crafting",size:1,icon:"âš—ï¸",color:"#6a5acd",minElevation:.45,maxElevation:.75,validBiomes:["forest","swamp","rainforest","taiga"],rarity:.05,minDistance:18},WORKBENCH:{id:"workbench",name:"Workbench",category:"crafting",size:1,icon:"ðŸªš",color:"#8b4513",minElevation:.42,maxElevation:.65,validBiomes:["grassland","forest","savanna","taiga"],rarity:.08,minDistance:12},COOKING_FIRE:{id:"cooking_fire",name:"Cooking Fire",category:"crafting",size:1,icon:"ðŸ”¥",color:"#ff4500",minElevation:.42,maxElevation:.7,validBiomes:["grassland","forest","beach","savanna","tundra","taiga"],rarity:.1,minDistance:10},LUMBER_CAMP:{id:"lumber_camp",name:"Lumber Camp",category:"resource",size:1,icon:"ðŸª“",color:"#8b4513",minElevation:.42,maxElevation:.7,validBiomes:["forest","rainforest","taiga"],rarity:.4,minDistance:6},QUARRY:{id:"quarry",name:"Stone Quarry",category:"resource",size:1,icon:"â¬™",color:"#808080",minElevation:.6,maxElevation:.9,validBiomes:["mountain","tundra","taiga"],rarity:.3,minDistance:8},FISHING_SPOT:{id:"fishing_spot",name:"Fishing Spot",category:"resource",size:1,icon:"ðŸŸ",color:"#4682b4",minElevation:.4,maxElevation:.45,validBiomes:["beach","coast","swamp"],rarity:.35,minDistance:6},HERB_GARDEN:{id:"herb_garden",name:"Herb Garden",category:"resource",size:1,icon:"ðŸŒ¿",color:"#90ee90",minElevation:.42,maxElevation:.6,validBiomes:["grassland","forest","swamp"],rarity:.35,minDistance:5},HUNTING_GROUND:{id:"hunting_ground",name:"Hunting Ground",category:"resource",size:1,icon:"ðŸ¦Œ",color:"#a0522d",minElevation:.45,maxElevation:.7,validBiomes:["forest","savanna","grassland","taiga"],rarity:.35,minDistance:7},BERRY_PATCH:{id:"berry_patch",name:"Berry Patch",category:"resource",size:1,icon:"ðŸ«",color:"#8b008b",minElevation:.42,maxElevation:.6,validBiomes:["forest","grassland","taiga"],rarity:.4,minDistance:5},CLAY_PIT:{id:"clay_pit",name:"Clay Pit",category:"resource",size:1,icon:"ðŸº",color:"#cd853f",minElevation:.42,maxElevation:.5,validBiomes:["swamp","grassland","beach"],rarity:.25,minDistance:8},IRON_DEPOSIT:{id:"iron_deposit",name:"Iron Deposit",category:"resource",size:1,icon:"â›°",color:"#a52a2a",minElevation:.65,maxElevation:.9,validBiomes:["mountain","tundra"],rarity:.25,minDistance:10},GOLD_VEIN:{id:"gold_vein",name:"Gold Vein",category:"resource",size:1,icon:"âœ¦",color:"#ffd700",minElevation:.7,maxElevation:.95,validBiomes:["mountain","snow_peak"],rarity:.08,minDistance:15},SPRING:{id:"spring",name:"Fresh Spring",category:"resource",size:1,icon:"ðŸ’§",color:"#00bfff",minElevation:.5,maxElevation:.75,validBiomes:["forest","grassland","taiga","tundra"],rarity:.2,minDistance:10},APIARY:{id:"apiary",name:"Wild Apiary",category:"resource",size:1,icon:"ðŸ",color:"#ffa500",minElevation:.45,maxElevation:.6,validBiomes:["grassland","forest","savanna"],rarity:.25,minDistance:8}};class yt{constructor(e){this.seed=e,this.pois=[],this.random=this.createRandom(e),this.nextPoiId=1}createRandom(e){let t=e;return()=>(t=t*16807%2147483647,(t-1)/2147483646)}generate(e,t={}){var l;const{density:i=1,maxPOIs:s=200}=t;this.pois=[],this.placementStats={},this.random=this.createRandom(this.seed),this.nextPoiId=1;const a=[];e.forEach(c=>{c.elevation>=.42&&c.biome&&a.push(c)}),this.shuffle(a);const n=c=>c.category==="settlement"?{citadel:1,town:2,village:4,hamlet:6}[c.id]||2:["ruins","cave","keep","fortress"].includes(c.id)?8:c.category==="guild"?2:c.category==="cult"?5:c.category==="crafting"?3:0,r={settlement:10,guild:9,cult:8,crafting:7,landmark:5,resource:3},o=Object.values(Ci).sort((c,d)=>{const u=(r[d.category]||0)-(r[c.category]||0);return u!==0?u:c.rarity-d.rarity});for(const c of o){const d=n(c);if(d===0)continue;let u=0,h=!1;const m=c.category==="cult"?new Map:null;for(const g of a){if(u>=d||this.pois.length>=s)break;c.category==="cult"&&m&&(m.get(g.biome.id)||0)>=2&&c.validBiomes.some(p=>(m.get(p)||0)<2)||this.canPlacePOI(g,c,e,h)&&(this.pois.push({id:this.nextPoiId++,type:c,q:g.q,r:g.r,name:this.generateName(c),data:this.generatePOIData(c)}),u++,m&&m.set(g.biome.id,(m.get(g.biome.id)||0)+1))}if(u<d){h=!0;for(const g of a){if(u>=d||this.pois.length>=s)break;this.canPlacePOI(g,c,e,h)&&(this.pois.push({id:this.nextPoiId++,type:c,q:g.q,r:g.r,name:this.generateName(c),data:this.generatePOIData(c)}),u++,m&&m.set(g.biome.id,(m.get(g.biome.id)||0)+1))}}this.placementStats[c.id]={target:d,placed:u,category:c.category,relaxed:h&&u<d,biomeDiversity:m?Object.fromEntries(m):null}}for(const c of o){if(this.pois.length>=s)break;const d=((l=this.placementStats[c.id])==null?void 0:l.placed)||0,u=n(c),h=Math.floor(a.length*c.rarity*i*.01),m=Math.max(h,u);if(Math.max(0,m-d)===0)continue;let y=d;for(const f of a){if(y>=m||this.pois.length>=s)break;this.canPlacePOI(f,c,e,!1)&&(this.pois.push({id:this.nextPoiId++,type:c,q:f.q,r:f.r,name:this.generateName(c),data:this.generatePOIData(c)}),y++)}this.placementStats[c.id]?(this.placementStats[c.id].placed=y,this.placementStats[c.id].target=m):this.placementStats[c.id]={target:m,placed:y,category:c.category}}return this.validatePOIGeneration(),this.pois}validatePOIGeneration(){if(!this.placementStats)return;const e=[],t={byCategory:{},byType:{}};for(const[a,n]of Object.entries(this.placementStats))if(t.byCategory[n.category]||(t.byCategory[n.category]={target:0,placed:0}),t.byCategory[n.category].target+=n.target,t.byCategory[n.category].placed+=n.placed,t.byType[a]=n,n.placed<n.target){const r=n.target-n.placed;e.push(`${a}: placed ${n.placed}/${n.target} (${r} short)`)}console.log("POI Generation Statistics:"),console.log("By Category:",t.byCategory),console.log("Total POIs:",this.pois.length);const i=this.pois.filter(a=>a.type.category==="cult");console.log(`Cult Sites: ${i.length} total`);const s={};for(const a of i)s[a.type.id]=(s[a.type.id]||0)+1;if(console.log("Cult Sites by Type:",s),e.length>0){console.warn("POI Generation Warnings - Minimums not met:"),e.forEach(n=>console.warn("  -",n));const a=e.filter(n=>{const r=n.split(":")[0],o=this.placementStats[r];return o&&["cult","settlement","guild"].includes(o.category)});a.length>0&&console.error("CRITICAL: Essential POI types failed to meet minimums:",a)}else console.log("âœ“ All POI minimums met successfully")}canPlacePOI(e,t,i,s=!1){if(e.elevation<t.minElevation||e.elevation>t.maxElevation||!t.validBiomes.includes(e.biome.id))return!1;const a=s?.5:.7;for(const n of this.pois){const r=i.distance(e.q,e.r,n.q,n.r),o=Math.max(t.minDistance,n.type.minDistance)*a;if(r<o)return!1}return!0}shuffle(e){for(let t=e.length-1;t>0;t--){const i=Math.floor(this.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}}generateName(e){const t={settlement:["North","South","East","West","Old","New","High","Low","Green","Grey"],landmark:["Ancient","Forgotten","Hidden","Lost","Sacred","Dark","Bright","Silent","Fallen"],resource:["Rich","Bountiful","Wild","Hidden","Quiet","Sunny","Shaded","Remote","Fertile"],cult:["Forbidden","Unholy","Cursed","Profane","Blighted","Accursed","Damned","Wretched"],guild:["The","Grand","Royal","Honored","Esteemed","Noble","Ancient","United"]},i={hamlet:["stead","ton","vale","dale","wick"],village:["ville","ford","bury","ham","worth"],town:["town","borough","field","gate","haven"],citadel:["citadel","hold","keep","throne","crown"],shrine:["shrine","altar","sanctum"],ruins:["ruins","remnants","wastes"],temple:["temple","sanctuary","basilica"],keep:["keep","watch","guard"],fortress:["fortress","bastion","stronghold"],castle:["castle","palace","manor"],cave:["cave","cavern","grotto"],mine:["mine","pit","delve"],forest_grove:["grove","glade","heart"],cult_shrine:["shrine","altar","circle","site"],blood_altar:["altar","sanctum","pit","throne"],void_rift:["rift","tear","portal","maw"],flesh_pit:["pit","pool","chamber","spawning ground"],lumber_camp:["timber stand","logging site","woodlands"],quarry:["quarry","stone pit","rock face"],fishing_spot:["fishing hole","waters","catch"],herb_garden:["herb patch","meadow","garden"],hunting_ground:["hunting grounds","chase","range"],berry_patch:["berry thicket","brambles","picking spot"],clay_pit:["clay pit","mudflats","pottery grounds"],iron_deposit:["iron vein","ore deposit","metal seam"],gold_vein:["gold strike","mother lode","gilded seam"],spring:["spring","wellspring","waters"],apiary:["apiary","bee hollow","honey grove"],merchant_exchange:["Golden Scale","Trade House","Merchant Hall","Commerce Guild"],explorer_outpost:["Wayfarer Lodge","Compass House","Pioneer Camp","Trailhead"],artisan_workshop:["Crafter Hall","Maker Guild","Forge & Anvil","Artisan Lodge"],iron_barracks:["Iron Company","Sword Hall","Mercenary Hold","Steel Garrison"],shadow_den:["Silent Step","Midnight House","Whisper Den","Hidden Hand"],ether_sanctum:["Ether Conclave","Arcane Sanctum","Mystic Circle","Mage Tower"]},s=t[e.category]||t.resource,a=i[e.id]||["site","spot","place"],n=s[Math.floor(this.random()*s.length)],r=a[Math.floor(this.random()*a.length)];return`${n} ${r}`}generatePOIData(e){var i;const t={};if(e.category==="settlement"){const a={1:50,2:200,3:1e3,4:5e3}[e.size]||100;t.population=Math.floor(a*(.5+this.random()*1));const n=["Farming","Trading","Mining","Fishing","Crafting","Hunting"];t.economy=n[Math.floor(this.random()*n.length)];const r=["Poor","Modest","Comfortable","Prosperous","Wealthy"],o=Math.min(4,Math.floor(this.random()*(e.size+2)));t.wealth=r[o];const l=["Independent","Kingdom of Aldoria","Free Cities League","Northern Clans","Empire of Solis"];t.faction=l[Math.floor(this.random()*l.length)];const c=["Market Square","Ancient Well","Watchtower","Temple","Tavern","Blacksmith","Library","Barracks"];t.features=[];const d=Math.min(e.size,1+Math.floor(this.random()*3));for(;t.features.length<d;){const m=c[Math.floor(this.random()*c.length)];t.features.includes(m)||t.features.push(m)}t.townAttributes=xi(e.size);const h={Farming:"agriculture",Trading:"tailoring",Mining:"smithing",Fishing:"agriculture",Crafting:"construction",Hunting:"warriors"}[t.economy];h&&((i=t.townAttributes[h])!=null&&i.active)&&(t.townAttributes[h].xp+=25*e.size),t.facilities=[],e.size>=1&&t.facilities.push("storage"),e.size>=2&&t.facilities.push("stable","inn"),e.size>=3&&t.facilities.push("market","blacksmith"),e.size>=4&&t.facilities.push("library","barracks")}else if(e.category==="resource"){const s=["Scarce","Modest","Abundant","Rich","Bountiful"];t.yield=s[Math.floor(this.random()*s.length)];const a=["Easy Access","Moderate Terrain","Difficult Path","Remote"];if(t.accessibility=a[Math.floor(this.random()*a.length)],t.claimed=this.random()<.3,t.claimed){const o=["Local Village","Merchant Guild","Noble House","Crown Property","Disputed"];t.owner=o[Math.floor(this.random()*o.length)]}const r={lumber_camp:["Oak","Pine","Birch","Maple","Ash"],quarry:["Granite","Marble","Limestone","Slate","Sandstone"],fishing_spot:["Trout","Salmon","Carp","Pike","Shellfish"],herb_garden:["Healing Herbs","Culinary Herbs","Rare Flowers","Medicinal Roots"],hunting_ground:["Deer","Boar","Rabbit","Fox Pelts","Wild Fowl"],berry_patch:["Blueberries","Raspberries","Blackberries","Wild Strawberries"],clay_pit:["Red Clay","White Clay","Pottery Clay"],iron_deposit:["Iron Ore","Hematite","Magnetite"],gold_vein:["Gold Nuggets","Gold Dust","Electrum"],spring:["Fresh Water","Mineral Water","Hot Spring"],apiary:["Honey","Beeswax","Royal Jelly"]}[e.id]||["Unknown Resource"];t.output=r[Math.floor(this.random()*r.length)]}else{const s=["Pristine","Well-maintained","Weathered","Crumbling","Ruined","Ancient"];t.condition=s[Math.floor(this.random()*s.length)];const a=["Safe","Caution Advised","Dangerous","Deadly"];t.danger=a[Math.floor(this.random()*(e.size+1))];const r={shrine:["Dedicated to forgotten gods","Pilgrims visit seasonally","Said to grant visions"],ruins:["Once a great fortress","Destroyed in ancient war","Treasure hunters frequent here"],temple:["Active worship site","Monks reside within","Sacred artifacts stored here"],keep:["Abandoned military outpost","Bandits may shelter here","Strategic location"],fortress:["Impenetrable in its prime","Siege marks visible","Underground tunnels rumored"],castle:["Former noble residence","Ghost sightings reported","Hidden passages exist"],cave:["Deep and unexplored","Strange sounds within","Mineral deposits visible"],mine:["Rich ore deposits","Abandoned equipment","Unstable tunnels"],forest_grove:["Ancient magic lingers","Druids once gathered here","Rare herbs grow here"]}[e.id]||["Mysterious place","Little is known"];t.lore=r[Math.floor(this.random()*r.length)];const o={cave:["Iron Ore","Crystals","Monster Parts"],mine:["Gold","Silver","Coal","Gems"],ruins:["Artifacts","Ancient Coins","Scrolls"],forest_grove:["Rare Herbs","Enchanted Wood","Spirit Essence"]};if(t.resources=o[e.id]?o[e.id][Math.floor(this.random()*o[e.id].length)]:null,["cave","mine","shrine","ruins","temple","fortress","keep","castle","forest_grove"].includes(e.id)){const d={cave:[6,12],mine:[8,14],shrine:[4,8],ruins:[10,18],temple:[8,14],fortress:[12,20],keep:[10,16],castle:[14,24],forest_grove:[6,10]}[e.id]||[6,12];t.maxFloors=d[0]+Math.floor(this.random()*(d[1]-d[0]+1)),t.exploredDepth=0;const u={Safe:1,"Caution Advised":2,Dangerous:3,Deadly:4};t.difficultyTier=u[t.danger]||1;const h=Math.floor(t.maxFloors*.7);t.bossFloor=h+Math.floor(this.random()*(t.maxFloors-h+1)),t.bossDefeated=!1,t.clearedFloors=0}}if(e.category==="cult"){t.hidden=!0,t.discoveryRequirement="Requires cult membership or special item";const a={cult_shrine:["void_seekers","whispering_shadow"],blood_altar:["blood_covenant"],void_rift:["void_seekers"],flesh_pit:["flesh_weavers"]}[e.id]||["void_seekers"];t.associatedCult=a[Math.floor(this.random()*a.length)];const n=["Weak","Moderate","Strong","Overwhelming"];t.ritualPower=n[Math.floor(this.random()*n.length)],t.corruptionRadius=2+Math.floor(this.random()*3);const o={cult_shrine:["Whispers echo at midnight","Blood offerings accepted here","The veil is thin"],blood_altar:["Stained with countless sacrifices","Power flows through blood","The covenant watches"],void_rift:["Reality bleeds here","Void entities stir within","Do not gaze too long"],flesh_pit:["Living tissue writhes","The Order crafts abominations here","Flesh is merely clay"]}[e.id]||["Dark power resides here"];t.lore=o[Math.floor(this.random()*o.length)];const l={cult_shrine:["void_meditation","dark_offering","shadow_whisper"],blood_altar:["blood_offering","sacrifice_npc","crimson_pact"],void_rift:["void_meditation","summon_shade","dark_offering"],flesh_pit:["flesh_offering","graft_ritual","construct_creation"]};t.availableRituals=l[e.id]||[]}if(e.category==="guild"){t.guildId=e.guildId,t.hidden=e.hidden||!1,t.guildRank=1+Math.floor(this.random()*3);const a={merchants:["contracts","trading","loans","appraisal"],explorers:["maps","expeditions","guide_hire","training"],artisans:["crafting","repairs","commissions","materials"],iron_company:["contracts","training","equipment","bounties"],shadows:["contracts","fencing","intel","training"],ether_conclave:["training","enchanting","research","rituals"]}[e.guildId]||["contracts","training"];t.services=a.slice(0,2+Math.floor(this.random()*2)),t.questBoard=!0,t.reputation=0,t.corruptionResistance=2+Math.floor(this.random()*3);const r={merchants:["Gold is the great equalizer","Fair deals build fortunes","The ledger never lies"],explorers:["The horizon calls to the bold","Every path leads somewhere","Maps are treasure"],artisans:["Craftsmanship is immortality","The hammer shapes destiny","Quality over quantity"],iron_company:["Steel solves problems","Coin for blood, blood for coin","The contract is sacred"],shadows:["Silence is golden","Information is power","Unseen, unheard, unforgotten"],ether_conclave:["Magic flows through all things","Knowledge is the ultimate power","The ether remembers"]}[e.guildId]||["A guild of repute"];t.lore=r[Math.floor(this.random()*r.length)];const o={merchants:"resource_denial",explorers:"discovery",artisans:"sacred_crafting",iron_company:"direct_combat",shadows:"infiltration",ether_conclave:"magical_cleansing"};t.antiCultFocus=o[e.guildId]||"general"}return t}getSettlements(){return this.pois.filter(e=>e.type.category==="settlement")}getLandmarks(){return this.pois.filter(e=>e.type.category==="landmark")}getCultSites(){return this.pois.filter(e=>e.type.category==="cult")}getGuildSites(){return this.pois.filter(e=>e.type.category==="guild")}getResourceSites(){return this.pois.filter(e=>e.type.category==="resource")}regenerate(e,t,i={}){return this.seed=t,this.generate(e,i)}}class vt{constructor(){this.roads=[],this.seed=Math.random()*65536}createRandom(e){let t=Math.floor(e)||1;return()=>(t=t*16807%2147483647,(t-1)/2147483646)}generate(e,t,i={}){const{maxRoadLength:s=50,wanderStrength:a=.3}=i;this.roads=[],this.random=this.createRandom(this.seed),this.wanderStrength=a;const n=t.filter(l=>l.type.category==="settlement").sort((l,c)=>c.type.size-l.type.size);if(!n||n.length<2)return this.roads;const r=new Set;for(r.add(this.poiKey(n[0]));r.size<n.length;){let l=null,c=1/0;for(const u of n)if(r.has(this.poiKey(u)))for(const h of n){if(r.has(this.poiKey(h)))continue;const m=e.distance(u.q,u.r,h.q,h.r);m<c&&m<=s&&(c=m,l={from:u,to:h})}if(!l)break;const d=this.findPath(e,l.from,l.to);d&&d.length>0&&this.roads.push({from:l.from,to:l.to,path:d,spline:this.createSpline(e,d),type:l.from.type.size>=3||l.to.type.size>=3?"main":"secondary"}),r.add(this.poiKey(l.to))}const o=t.filter(l=>l.type.category==="landmark"&&l.type.size>=2);for(const l of o){let c=null,d=1/0;for(const u of n){const h=e.distance(l.q,l.r,u.q,u.r);h<d&&h<=s*.5&&(d=h,c=u)}if(c){const u=this.findPath(e,l,c);u&&u.length>0&&this.roads.push({from:l,to:c,path:u,spline:this.createSpline(e,u),type:"trail"})}}return this.roads}poiKey(e){return`${e.q},${e.r}`}findPath(e,t,i){if(!t||!i)return null;const s=`${t.q},${t.r}`,a=`${i.q},${i.r}`;if(s===a)return[{q:t.q,r:t.r}];const n=[{q:t.q,r:t.r,g:0,f:0}],r=new Set,o=new Map,l=new Map;l.set(s,0);let c=0;const d=5e3;for(;n.length>0&&c<d;){c++,n.sort((g,y)=>g.f-y.f);const u=n.shift(),h=`${u.q},${u.r}`;if(h===a)return this.reconstructPath(o,h);r.add(h);const m=[[1,0],[1,-1],[0,-1],[-1,0],[-1,1],[0,1]];for(const[g,y]of m){const f=u.q+g,p=u.r+y,v=`${f},${p}`;if(r.has(v))continue;const b=e.getCell(f,p);if(!b)continue;const k=this.getMovementCost(b);if(k===1/0)continue;const w=this.random()*this.wanderStrength*2,x=(l.get(h)||0)+k+w,C=l.get(v);if(C===void 0||x<C){o.set(v,h),l.set(v,x);const _=e.distance(f,p,i.q,i.r),M=this.random()*this.wanderStrength,S=x+_+M,A=n.findIndex(q=>q.q===f&&q.r===p);A>=0?(n[A].g=x,n[A].f=S):n.push({q:f,r:p,g:x,f:S})}}}return null}getMovementCost(e){if(!e||!e.biome)return 1/0;const t=e.biome.id;return["deep_ocean","ocean","coast"].includes(t)?1/0:{beach:1.2,grassland:1,forest:1.5,rainforest:2,savanna:1.1,desert:1.8,swamp:2.5,taiga:1.6,tundra:1.4,snow_forest:2,mountain:3,snow_peak:5}[t]||1.5}reconstructPath(e,t){const i=[];let s=t;for(;s;){const[a,n]=s.split(",").map(Number);i.unshift({q:a,r:n}),s=e.get(s)}return i}createSpline(e,t){if(!t||t.length<2)return[];const i=t.map(n=>e.hexToPixel(n.q,n.r));if(i.length===2)return i;const s=[],a=3;for(let n=0;n<i.length-1;n++){const r=i[Math.max(0,n-1)],o=i[n],l=i[Math.min(i.length-1,n+1)],c=i[Math.min(i.length-1,n+2)];for(let d=0;d<a;d++){const u=d/a;s.push(this.catmullRom(r,o,l,c,u))}}return s.push(i[i.length-1]),s}catmullRom(e,t,i,s,a){const n=a*a,r=n*a,o=.5*(2*t.x+(-e.x+i.x)*a+(2*e.x-5*t.x+4*i.x-s.x)*n+(-e.x+3*t.x-3*i.x+s.x)*r),l=.5*(2*t.y+(-e.y+i.y)*a+(2*e.y-5*t.y+4*i.y-s.y)*n+(-e.y+3*t.y-3*i.y+s.y)*r);return{x:o,y:l}}regenerate(e,t,i={}){return this.seed=Math.random()*65536,this.generate(e,t,i)}}class bt{constructor(e){this.seed=e,this.rivers=[],this.random=this.createRandom(e)}createRandom(e){let t=Math.floor(e)||1;return()=>(t=t*16807%2147483647,(t-1)/2147483646)}generate(e,t={}){const{riverCount:i=8,minLength:s=10,maxLength:a=60,startElevation:n=.7,meanderStrength:r=.4}=t;this.rivers=[],this.random=this.createRandom(this.seed);const o=[];e.forEach(c=>{c.elevation>=n&&c.elevation<.9&&c.biome&&!["deep_ocean","ocean","coast","snow_peak"].includes(c.biome.id)&&o.push(c)}),this.shuffle(o);let l=0;for(;this.rivers.length<i&&l<i*3&&o.length>0;){l++;const c=o.pop();let d=!1;for(const h of this.rivers){for(const m of h.path)if(e.distance(c.q,c.r,m.q,m.r)<15){d=!0;break}if(d)break}if(d)continue;const u=this.traceRiver(e,c,s,a,r);u&&u.path.length>=s&&(u.spline=this.createSpline(e,u.path),this.rivers.push(u))}return this.rivers}traceRiver(e,t,i,s,a){const n=[{q:t.q,r:t.r,elevation:t.elevation}],r=new Set;r.add(`${t.q},${t.r}`);let o=t,l=null;for(;n.length<s;){const c=this.getFlowNeighbors(e,o,r,l,a);if(c.length===0)break;let d=c[0];if(c.length>1&&this.random()<a&&(d=c[Math.floor(this.random()*Math.min(2,c.length))]),d.biome&&["deep_ocean","ocean","coast"].includes(d.biome.id))return n.push({q:d.q,r:d.r,elevation:d.elevation}),{path:n,source:{q:t.q,r:t.r},mouth:{q:d.q,r:d.r},reachesWater:!0};n.push({q:d.q,r:d.r,elevation:d.elevation}),r.add(`${d.q},${d.r}`),l={dq:d.q-o.q,dr:d.r-o.r},o=d}return{path:n,source:{q:t.q,r:t.r},mouth:{q:o.q,r:o.r},reachesWater:!1}}getFlowNeighbors(e,t,i,s,a){const n=[[1,0],[1,-1],[0,-1],[-1,0],[-1,1],[0,1]],r=[];for(const[o,l]of n){const c=t.q+o,d=t.r+l,u=`${c},${d}`;if(i.has(u))continue;const h=e.getCell(c,d);if(!h||h.elevation>t.elevation+.02)continue;let m=0;if(m+=(t.elevation-h.elevation)*10,s){const g=o*s.dq+l*s.dr;m+=g*2}m+=this.random()*a,r.push({...h,score:m})}return r.sort((o,l)=>l.score-o.score),r}createSpline(e,t){if(!t||t.length<2)return[];const i=t.map(n=>e.hexToPixel(n.q,n.r));if(i.length===2)return i;const s=[],a=4;for(let n=0;n<i.length-1;n++){const r=i[Math.max(0,n-1)],o=i[n],l=i[Math.min(i.length-1,n+1)],c=i[Math.min(i.length-1,n+2)];for(let d=0;d<a;d++){const u=d/a;s.push(this.catmullRom(r,o,l,c,u))}}return s.push(i[i.length-1]),s}catmullRom(e,t,i,s,a){const n=a*a,r=n*a;return{x:.5*(2*t.x+(-e.x+i.x)*a+(2*e.x-5*t.x+4*i.x-s.x)*n+(-e.x+3*t.x-3*i.x+s.x)*r),y:.5*(2*t.y+(-e.y+i.y)*a+(2*e.y-5*t.y+4*i.y-s.y)*n+(-e.y+3*t.y-3*i.y+s.y)*r)}}shuffle(e){for(let t=e.length-1;t>0;t--){const i=Math.floor(this.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}}regenerate(e,t,i={}){return this.seed=t,this.generate(e,i)}}const le={storage:{id:"storage",name:"Storage Shed",icon:"ðŸ“¦",description:"Store resources safely in town",category:"infrastructure",effects:{storageCapacity:100,storageSlots:20},requires:{},buildCost:null,unlockSource:"default"},stable:{id:"stable",name:"Stable",icon:"ðŸ´",description:"Fast travel to nearby settlements",category:"travel",effects:{travelSpeedBonus:.25,travelCostReduction:.1,horseRental:!0},requires:{construction:2},buildCost:{wood:15,gold:50},unlockSource:"townBoard",infrastructureEffect:"stable"},inn:{id:"inn",name:"Inn",icon:"ðŸ¨",description:"Rest and recover, hear rumors",category:"services",effects:{restEfficiency:1.5,moraleBonus:10,rumorsAvailable:!0,roomRental:!0},requires:{agriculture:2,construction:2},buildCost:{wood:20,stone:10,gold:75},unlockSource:"townBoard",infrastructureEffect:"inn"},market:{id:"market",name:"Market Square",icon:"ðŸ›’",description:"Buy and sell goods at better prices",category:"commerce",effects:{buyPriceReduction:.1,sellPriceBonus:.1,tradeGoods:!0,merchantVisits:!0},requires:{agriculture:2,tailoring:2},buildCost:{wood:10,stone:15,gold:100},unlockSource:"townBoard",infrastructureEffect:"market"},blacksmith:{id:"blacksmith",name:"Blacksmith",icon:"âš’ï¸",description:"Craft and repair metal equipment",category:"crafting",effects:{craftingSpeedBonus:.25,repairAvailable:!0,metalCrafting:!0,equipmentUpgrades:!0},requires:{smithing:3,construction:2},buildCost:{stone:20,iron:10,gold:150},unlockSource:"townBoard",infrastructureEffect:"blacksmith"},carpenter:{id:"carpenter",name:"Carpenter Workshop",icon:"ðŸªš",description:"Craft wooden items and furniture",category:"crafting",effects:{woodCraftingBonus:.3,buildSpeedBonus:.2,furnitureCrafting:!0},requires:{construction:3},buildCost:{wood:25,gold:75},unlockSource:"townBoard",infrastructureEffect:"carpenter"},clinic:{id:"clinic",name:"Clinic",icon:"ðŸ¥",description:"Heal injuries and cure conditions",category:"services",effects:{healingBonus:.5,conditionCureAvailable:!0,injuryRecoveryBonus:.5,citizenHealthBonus:10},requires:{medicine:3,construction:2},buildCost:{wood:15,herbs:20,gold:100},unlockSource:"townBoard",infrastructureEffect:"clinic"},granary:{id:"granary",name:"Granary",icon:"ðŸŒ¾",description:"Store food and prevent spoilage",category:"infrastructure",effects:{foodCapacityBonus:100,foodSpoilageReduction:.5,rationEfficiency:1.25},requires:{agriculture:3,construction:2},buildCost:{wood:20,stone:10,gold:80},unlockSource:"townBoard",infrastructureEffect:"granary"},barracks:{id:"barracks",name:"Barracks",icon:"âš”ï¸",description:"Train warriors and organize militia",category:"military",effects:{guardCapacity:5,combatTrainingBonus:.2,townDefenseBonus:20,militiaAvailable:!0},requires:{warriors:3,construction:3},buildCost:{wood:25,stone:20,iron:5,gold:200},unlockSource:"townBoard",infrastructureEffect:"barracks"},library:{id:"library",name:"Library",icon:"ðŸ“š",description:"Research and learn new skills",category:"knowledge",effects:{xpGainBonus:.15,skillLearningBonus:.2,loreDiscoveryBonus:.25,researchAvailable:!0},requires:{medicine:3,construction:3},buildCost:{wood:15,stone:10,gold:150},unlockSource:"townBoard",infrastructureEffect:"library"},tavern:{id:"tavern",name:"Tavern",icon:"ðŸº",description:"Recruit citizens and hear news",category:"social",effects:{citizenRecruitBonus:.2,moraleBonus:15,questDiscoveryBonus:.1,socialGathering:!0},requires:{agriculture:3,construction:2},buildCost:{wood:20,gold:100},unlockSource:"townBoard",infrastructureEffect:"tavern"},tailorshop:{id:"tailorshop",name:"Tailor Shop",icon:"ðŸ§µ",description:"Craft clothing and cloth armor",category:"crafting",effects:{clothCraftingBonus:.3,armorRepairAvailable:!0,clothingUpgrades:!0},requires:{tailoring:3,construction:2},buildCost:{wood:15,cloth:10,gold:80},unlockSource:"townBoard",infrastructureEffect:"tailorshop"},apothecary:{id:"apothecary",name:"Apothecary",icon:"âš—ï¸",description:"Brew potions and remedies",category:"crafting",effects:{potionCraftingBonus:.3,herbProcessing:!0,antidoteAvailable:!0},requires:{medicine:4,agriculture:2},buildCost:{wood:10,herbs:30,gold:120},unlockSource:"townBoard",infrastructureEffect:"apothecary"},watchtower:{id:"watchtower",name:"Watchtower",icon:"ðŸ—¼",description:"Early warning of threats",category:"military",effects:{visionRange:3,ambushWarning:!0,scoutEfficiencyBonus:.2},requires:{warriors:2,construction:3},buildCost:{stone:25,wood:10,gold:100},unlockSource:"townBoard",infrastructureEffect:"watchtower"},well:{id:"well",name:"Town Well",icon:"ðŸª£",description:"Clean water for the settlement",category:"infrastructure",effects:{citizenHealthBonus:5,fireRiskReduction:.3,farmingBonus:.1},requires:{construction:2},buildCost:{stone:10,wood:5,gold:30},unlockSource:"townBoard",infrastructureEffect:"well"},shrine:{id:"shrine",name:"Town Shrine",icon:"â›©ï¸",description:"Blessings and spiritual protection",category:"spiritual",effects:{blessingAvailable:!0,corruptionResistance:.2,moraleBonus:10},requires:{medicine:2},buildCost:{stone:15,gold:50},unlockSource:"townBoard",infrastructureEffect:"shrine"},rangerhall:{id:"rangerhall",name:"Ranger Hall",icon:"ðŸ¹",description:"Elite training and expeditions",category:"military",effects:{rangerTraining:!0,expeditionBonus:.25,trackingBonus:.3,eliteRecruits:!0},requires:{rangers:3,warriors:3,construction:3},buildCost:{wood:30,stone:15,gold:250},unlockSource:"townBoard",infrastructureEffect:"rangerhall"},guildhouse:{id:"guildhouse",name:"Guild House",icon:"ðŸ›ï¸",description:"Guild operations and contracts",category:"commerce",effects:{guildContractsBonus:.2,reputationGainBonus:.15,guildServicesAvailable:!0},requires:{construction:4,tailoring:3},buildCost:{wood:25,stone:20,gold:300},unlockSource:"townBoard",infrastructureEffect:"guildhouse"}};function _i(T,e){var s;const t=le[T];if(!t)return{can:!1,reason:"Unknown facility"};if(!t.requires||Object.keys(t.requires).length===0)return{can:!0};const i=[];for(const[a,n]of Object.entries(t.requires)){const r=((s=e==null?void 0:e[a])==null?void 0:s.level)||0;r<n&&i.push(`${a} Lv.${n} (have Lv.${r})`)}return i.length>0?{can:!1,reason:`Requires: ${i.join(", ")}`}:{can:!0}}function Si(T,e=[]){const t=[];for(const[i,s]of Object.entries(le)){if(e.includes(i))continue;const a=_i(i,T);t.push({...s,canUnlock:a.can,unlockReason:a.reason})}return t}function Mi(T){const e={};for(const t of T){const i=le[t];if(i!=null&&i.effects)for(const[s,a]of Object.entries(i.effects))typeof a=="number"?e[s]=(e[s]||0)+a:typeof a=="boolean"&&(e[s]=e[s]||a)}return e}const Ii={well:"well",walls:null,trade_route:null,roads:null,militia:"barracks",granary:"granary",clinic:"clinic",resource_map:null,stable:"stable",inn:"inn",market:"market",blacksmith:"blacksmith",carpenter:"carpenter",library:"library",tavern:"tavern",tailorshop:"tailorshop",apothecary:"apothecary",watchtower:"watchtower",shrine:"shrine",rangerhall:"rangerhall",guildhouse:"guildhouse"};function Ai(T){return Ii[T]||null}const $i={granary:{produces:"food",baseYield:{min:5,max:15},scale:"agriculture_level",description:"Produces food daily based on agriculture expertise"},blacksmith:{produces:"weapons",baseYield:{min:0,max:2},scale:"smithing_level",description:"Chance to produce weapons daily based on smithing skill"},stable:{produces:"gold",baseYield:{min:3,max:8},scale:"settlement_size",description:"Horse rentals and transport fees generate gold"},inn:{produces:"gold",baseYield:{min:5,max:15},scale:"settlement_size",description:"Room rentals and guest services generate gold"},market:{produces:"gold",baseYield:{min:8,max:25},scale:"tailoring_level",description:"Trade commissions and stall fees generate gold"},tavern:{produces:"gold",baseYield:{min:2,max:10},scale:"agriculture_level",description:"Food and drink sales generate gold"},clinic:{produces:"morale",baseYield:{min:1,max:3},scale:"medicine_level",description:"Healthcare improves population morale"},barracks:{produces:"defense",baseYield:{min:5,max:10},scale:"warriors_level",description:"Training soldiers improves town defense"},warehouse:{produces:"gold",baseYield:{min:2,max:6},scale:"settlement_size",description:"Storage fees and logistics generate gold"},library:{produces:"morale",baseYield:{min:1,max:2},scale:"settlement_size",description:"Education and knowledge improve morale"}},Ei={stable:{tasks:[{id:"stable_groom",name:"Groom Horses",icon:"ðŸ´",description:"Care for the stable animals",duration:2,cost:5,rewards:{rangers:15},citizenXp:{rangers:10},guildAffinity:"rangers"},{id:"stable_courier",name:"Courier Run",icon:"ðŸ“¬",description:"Deliver messages to nearby towns",duration:4,cost:10,rewards:{rangers:25,gold:15},citizenXp:{rangers:20},guildAffinity:"rangers"}]},inn:{tasks:[{id:"inn_serve",name:"Serve Guests",icon:"ðŸº",description:"Work the tavern floor",duration:3,cost:0,rewards:{agriculture:20,gold:10},citizenXp:{agriculture:15},guildAffinity:"merchants"},{id:"inn_rumors",name:"Gather Rumors",icon:"ðŸ‘‚",description:"Listen for useful information",duration:2,cost:5,rewards:{intel:1},citizenXp:{rangers:10},guildAffinity:"rangers"}]},market:{tasks:[{id:"market_trade",name:"Haggle Training",icon:"ðŸ¤",description:"Practice negotiation skills",duration:2,cost:10,rewards:{gold:20},citizenXp:{tailoring:15},guildAffinity:"merchants"},{id:"market_appraise",name:"Appraise Goods",icon:"ðŸ”",description:"Learn to value items accurately",duration:3,cost:5,rewards:{tailoring:25},citizenXp:{tailoring:20,medicine:10},guildAffinity:"merchants"}]},blacksmith:{tasks:[{id:"smith_apprentice",name:"Smith Apprentice",icon:"ðŸ”¨",description:"Learn basic metalworking",duration:4,cost:15,rewards:{smithing:30},citizenXp:{smithing:25,construction:10},guildAffinity:"warriors"},{id:"smith_repair",name:"Repair Equipment",icon:"âš’ï¸",description:"Fix damaged gear",duration:2,cost:10,rewards:{smithing:15},citizenXp:{smithing:15},guildAffinity:"warriors"}]},barracks:{tasks:[{id:"barracks_drill",name:"Combat Drill",icon:"âš”ï¸",description:"Practice fighting techniques",duration:3,cost:10,rewards:{warriors:30},citizenXp:{warriors:25},guildAffinity:"warriors"},{id:"barracks_guard",name:"Guard Duty",icon:"ðŸ›¡ï¸",description:"Patrol the settlement",duration:4,cost:5,rewards:{warriors:20,townDefense:5},citizenXp:{warriors:20},guildAffinity:"warriors"}]},library:{tasks:[{id:"library_study",name:"Study Lore",icon:"ðŸ“–",description:"Research ancient knowledge",duration:3,cost:5,rewards:{medicine:25},citizenXp:{medicine:20,xpBonus:.1},guildAffinity:"clerics"},{id:"library_scribe",name:"Copy Texts",icon:"âœï¸",description:"Transcribe important documents",duration:4,cost:10,rewards:{medicine:20,gold:15},citizenXp:{medicine:15},guildAffinity:"clerics"}]},clinic:{tasks:[{id:"clinic_assist",name:"Assist Healer",icon:"ðŸ’Š",description:"Help treat the wounded",duration:3,cost:10,rewards:{medicine:25},citizenXp:{medicine:25},guildAffinity:"clerics"},{id:"clinic_herbs",name:"Prepare Remedies",icon:"ðŸŒ¿",description:"Create healing salves",duration:2,cost:15,rewards:{medicine:20,healing:1},citizenXp:{medicine:15,agriculture:10},guildAffinity:"clerics"}]},carpenter:{tasks:[{id:"carpenter_build",name:"Carpentry Work",icon:"ðŸªµ",description:"Learn woodworking",duration:3,cost:10,rewards:{construction:25},citizenXp:{construction:20},guildAffinity:"artisans"},{id:"carpenter_furniture",name:"Craft Furniture",icon:"ðŸª‘",description:"Build useful items",duration:4,cost:20,rewards:{construction:30,gold:25},citizenXp:{construction:25,tailoring:10},guildAffinity:"artisans"}]},tavern:{tasks:[{id:"tavern_entertain",name:"Entertain Guests",icon:"ðŸŽ­",description:"Perform for the crowd",duration:2,cost:0,rewards:{agriculture:15,morale:10},citizenXp:{agriculture:15,tailoring:10},guildAffinity:"merchants"},{id:"tavern_recruit",name:"Scout Talent",icon:"ðŸ‘¤",description:"Find potential recruits",duration:3,cost:15,rewards:{recruitBonus:1},citizenXp:{rangers:15},guildAffinity:"rangers"}]},apothecary:{tasks:[{id:"apothecary_brew",name:"Brew Potions",icon:"âš—ï¸",description:"Create magical concoctions",duration:4,cost:20,rewards:{medicine:35,potion:1},citizenXp:{medicine:30},guildAffinity:"clerics"}]},tailorshop:{tasks:[{id:"tailor_sew",name:"Sewing Practice",icon:"ðŸ§µ",description:"Learn tailoring skills",duration:3,cost:10,rewards:{tailoring:25},citizenXp:{tailoring:20},guildAffinity:"artisans"}]},rangerhall:{tasks:[{id:"ranger_track",name:"Tracking Lesson",icon:"ðŸ¾",description:"Learn to follow trails",duration:4,cost:15,rewards:{rangers:35},citizenXp:{rangers:30,warriors:10},guildAffinity:"rangers"},{id:"ranger_archery",name:"Archery Training",icon:"ðŸ¹",description:"Practice ranged combat",duration:3,cost:20,rewards:{rangers:25,warriors:15},citizenXp:{rangers:25,warriors:15},guildAffinity:"rangers"}]},shrine:{tasks:[{id:"shrine_pray",name:"Meditation",icon:"ðŸ™",description:"Seek spiritual guidance",duration:2,cost:5,rewards:{medicine:15,blessing:1},citizenXp:{medicine:15},guildAffinity:"clerics"}]},guildhouse:{tasks:[{id:"guild_contracts",name:"Review Contracts",icon:"ðŸ“œ",description:"Study guild operations",duration:3,cost:10,rewards:{tailoring:20,gold:20},citizenXp:{tailoring:20,medicine:10},guildAffinity:"merchants"}]},watchtower:{tasks:[{id:"watch_scout",name:"Scout Duty",icon:"ðŸ”­",description:"Watch for threats",duration:4,cost:5,rewards:{rangers:20,warriors:15},citizenXp:{rangers:20},guildAffinity:"rangers"}]},granary:{tasks:[{id:"granary_manage",name:"Inventory Check",icon:"ðŸ“‹",description:"Organize food stores",duration:2,cost:0,rewards:{agriculture:15},citizenXp:{agriculture:15},guildAffinity:"artisans"}]}};function ai(T){var e;return((e=Ei[T])==null?void 0:e.tasks)||[]}function Pi(T,e,t,i){const s=le[T];if(!s||!e)return null;const a=`${t.q},${t.r}`;return{id:`training_${e.id}_${Date.now()}`,templateId:e.id,name:e.name,description:e.description,icon:e.icon,category:"training",type:"time",facilityId:T,facilityName:s.name,poiKey:a,poiName:t.name,objective:{current:0,required:e.duration,unit:"hours"},rewards:e.rewards||{},citizenXp:e.citizenXp||{},guildAffinity:e.guildAffinity,cost:e.cost||0,accepted:!0,acceptedDay:i,expiresDay:i+7,progress:0,assignedCitizenUid:null,difficulty:1}}const Q={poisoned:{id:"poisoned",name:"Poisoned",icon:"â˜ ï¸",color:"#00ff00",tickDamage:2,duration:30,message:"You feel poison coursing through your veins!"},bleeding:{id:"bleeding",name:"Bleeding",icon:"ðŸ©¸",color:"#ff0000",tickDamage:1,movementDamage:3,duration:20,message:"You are bleeding!"},hexed:{id:"hexed",name:"Hexed",icon:"ðŸ”®",color:"#8b00ff",damageMultiplier:.7,duration:45,message:"A dark hex weakens your attacks!"},weakened:{id:"weakened",name:"Weakened",icon:"ðŸ’”",color:"#808080",defenseMultiplier:.8,duration:40,message:"You feel your strength fading!"},bewitched:{id:"bewitched",name:"Bewitched",icon:"ðŸ‘ï¸",color:"#ff00ff",randomMovement:.3,duration:25,message:"Your mind clouds with unnatural visions!"},confused:{id:"confused",name:"Confused",icon:"â“",color:"#ffff00",cannotUseItems:!0,duration:20,message:"You cannot think straight!"},diseased:{id:"diseased",name:"Diseased",icon:"ðŸ¤¢",color:"#9acd32",healingMultiplier:.5,duration:60,message:"A terrible disease afflicts you!"},paralyzed:{id:"paralyzed",name:"Paralyzed",icon:"âš¡",color:"#00ffff",skipTurnChance:.3,duration:15,message:"Your limbs refuse to move!"},cursed:{id:"cursed",name:"Cursed",icon:"ðŸ’€",color:"#4b0082",allStatsMultiplier:.75,duration:120,message:"A dark curse binds your soul!"}},we=class we{constructor(){this.tick=0,this.ticksPerHour=10,this.hoursPerDay=24,this.ticksPerDay=this.ticksPerHour*this.hoursPerDay,this.day=1,this.hour=6,this.minute=0,this.isPaused=!1,this.timeScale=1,this.worldSeed=null,this.player={name:"Unnamed Citizen",race:"human",class:"mercenary",position:null,currentPOI:null,traveling:!1,travelProgress:0,travelDestination:null,travelTime:0,attributes:{prestige:5,trust:5,influence:5,stamina:5,hp:5,ether:5,agility:5},health:60,maxHealth:60,stamina:60,maxStamina:60,ether:50,maxEther:50,gold:300,skills:{gathering:1,combat:1,trading:1,crafting:1,survival:1},exp:0,level:1,xpToNextLevel:100,inventory:[],maxInventory:20,alignment:0,alignmentLock:0,conditions:{poisoned:{active:!1,duration:0},bleeding:{active:!1,duration:0},hexed:{active:!1,duration:0},weakened:{active:!1,duration:0},bewitched:{active:!1,duration:0},confused:{active:!1,duration:0},diseased:{active:!1,duration:0},paralyzed:{active:!1,duration:0},cursed:{active:!1,duration:0}},survival:{hunger:100,thirst:100,energy:100}},this.knownRecipes=new Set(["bandage","torch","cooked_meat","dried_meat","leather_strip"]),this.openedChests=new Set,this.exploredHexes=new Set,this.guild={unlocked:!1,name:null,reputation:0,members:[],maxMembers:5,missions:[]},this.discoveredPOIs=new Set,this.resourceCooldowns=new Map,this.startingPosition=null,this.townStorage=new Map,this.worldEnemies=[],this.log=[],this.maxLogEntries=50,this.listeners=new Set}get timeOfDay(){return this.hour>=6&&this.hour<12?"morning":this.hour>=12&&this.hour<17?"afternoon":this.hour>=17&&this.hour<21?"evening":"night"}get isNight(){return this.hour>=21||this.hour<6}get formattedTime(){const e=this.hour.toString().padStart(2,"0"),t=this.minute.toString().padStart(2,"0");return`Day ${this.day}, ${e}:${t}`}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){for(const e of this.listeners)e(this)}addLog(e,t="info"){this.log.unshift({message:e,type:t,time:this.formattedTime,tick:this.tick}),this.log.length>this.maxLogEntries&&this.log.pop()}showToast(e,t="info",i=3e3,s=null){let a=document.getElementById("toast-container");a||(a=document.createElement("div"),a.id="toast-container",document.body.appendChild(a));const n=document.createElement("div");n.className=`toast toast-${t}`;const r={success:"âœ“",info:"â„¹",warning:"âš ",error:"âœ—",citizen:"ðŸ‘¤",gold:"ðŸ’°",item:"ðŸ“¦"},o=s||r[t]||r.info;n.innerHTML=`
            <span class="toast-icon">${o}</span>
            <span class="toast-message">${e}</span>
        `,a.appendChild(n),requestAnimationFrame(()=>{n.classList.add("toast-show")}),setTimeout(()=>{n.classList.remove("toast-show"),n.classList.add("toast-hide"),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},300)},i)}showError(e,t=null){this.showToast(e,"error",5e3,"âœ—"),this.addLog(e,"error"),t?console.error("Critical Error:",e,t):console.error("Critical Error:",e)}showResourcePopup(e,t,i=null,s=null){let a=document.getElementById("resource-popup-container");a||(a=document.createElement("div"),a.id="resource-popup-container",document.body.appendChild(a));const n=document.createElement("div");n.className="resource-popup",n.innerHTML=`
            <span class="resource-popup-icon">${e}</span>
            <span class="resource-popup-text">${t}</span>
        `,i!==null&&s!==null?(n.style.left=`${i}px`,n.style.top=`${s}px`):(n.style.left="50%",n.style.top="40%",n.style.transform="translateX(-50%)"),a.appendChild(n),requestAnimationFrame(()=>{n.classList.add("resource-popup-show")}),setTimeout(()=>{n.classList.add("resource-popup-hide"),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},600)},1200)}addItem(e,t=!1){if(this.player.inventory.length>=this.player.maxInventory)return this.addLog("Inventory full!","warning"),!1;if(this.player.inventory.push(e),!t){const i=e.quantity&&e.quantity>1?` x${e.quantity}`:"";this.addLog(`Obtained: ${e.name}${i}`,"success")}return!0}removeItem(e){const t=this.player.inventory.findIndex(i=>i.id===e);return t>=0?this.player.inventory.splice(t,1)[0]:null}initStorage(e,t=null){if(this.townStorage.has(e))return this.townStorage.get(e);let i=100;t&&t.type&&(i=50+(t.type.size||1)*50);const s={items:new Map,maxCapacity:i,currentWeight:0};return this.townStorage.set(e,s),s}getStorage(e){return this.townStorage.get(e)||this.initStorage(e)}getEffectiveStorageCapacity(e){const i=this.getStorage(e).maxCapacity||100,s=this.getFacilityEffects(e),a=s.storageCapacity||0,n=s.foodCapacityBonus||0;return i+a+n}getStorageWeight(e){return this.getStorage(e).currentWeight}addToStorage(e,t,i){const s=this.getStorage(e),a=s.items.get(t)||0;return s.items.set(t,a+i),s.currentWeight+=i,i}removeFromStorage(e,t,i){const s=this.getStorage(e),a=s.items.get(t)||0,n=Math.min(a,i);if(n<=0)return 0;const r=a-n;return r<=0?s.items.delete(t):s.items.set(t,r),s.currentWeight-=n,n}getStorageItems(e){const t=this.getStorage(e),i=[];for(const[s,a]of t.items)i.push({itemId:s,quantity:a});return i}getTownAttributes(e){var i;if(!this.pois)return null;const t=this.pois.find(s=>`${s.q},${s.r}`===e);return!t||t.type.category!=="settlement"?null:((i=t.data)==null?void 0:i.townAttributes)||null}getTownAttribute(e,t){const i=this.getTownAttributes(e);return i?i[t]:null}awardTownAttributeXP(e,t,i){var o,l,c;if(!this.pois)return!1;const s=this.pois.find(d=>`${d.q},${d.r}`===e);if(!s||s.type.category!=="settlement")return!1;s.data.townAttributes||(s.data.townAttributes=it(((o=s.type)==null?void 0:o.size)||1));const a=s.data.townAttributes[t];if(!a)return!1;if(!a.active){a.active=!0,a.level=1,a.xp=0;const d=ft[t],u=(d==null?void 0:d.name)||t,h=(d==null?void 0:d.icon)||"ðŸ“ˆ";this.addLog(`${s.name} has established ${u}!`,"levelup"),(l=this.showToast)==null||l.call(this,`${s.name}: ${u} established!`,"success",3e3,h)}a.xp+=i;const n=[0,100,250,500,850,1300,1900,2700,3800,5200];let r=1;for(let d=n.length-1;d>=0;d--)if(a.xp>=n[d]){r=d+1;break}if(r>a.level){const d=a.level;a.level=Math.min(r,10);const u=ft[t],h=(u==null?void 0:u.name)||t,m=(u==null?void 0:u.icon)||"ðŸ“ˆ";return this.addLog(`${s.name}'s ${h} improved to level ${a.level}!`,"levelup"),(c=this.showToast)==null||c.call(this,`${s.name}: ${h} Lv.${a.level}!`,"success",3e3,m),{leveled:!0,oldLevel:d,newLevel:a.level}}return{leveled:!1}}getTownFacilities(e){var i;if(!this.pois)return[];const t=this.pois.find(s=>`${s.q},${s.r}`===e);return!t||t.type.category!=="settlement"?[]:((i=t.data)==null?void 0:i.facilities)||[]}hasFacility(e,t){return this.getTownFacilities(e).includes(t)}unlockFacility(e,t){var s;if(!this.pois)return!1;const i=this.pois.find(a=>`${a.q},${a.r}`===e);if(!i||i.type.category!=="settlement")return!1;if(i.data.facilities||(i.data.facilities=[]),!i.data.facilities.includes(t)){i.data.facilities.push(t);const a=le[t],n=(a==null?void 0:a.name)||t;return this.addLog(`${i.name} unlocked: ${n}!`,"success"),(s=this.showToast)==null||s.call(this,`New facility: ${n}!`,"success",3e3,"ðŸ—ï¸"),!0}return!1}getFacilityEffects(e){const t=this.getTownFacilities(e);return Mi(t)}hasFacilityEffect(e,t){return!!this.getFacilityEffects(e)[t]}getFacilityEffectValue(e,t,i=0){return this.getFacilityEffects(e)[t]??i}migrateSettlementData(){var t;if(!this.pois)return;const e=new Map;if(this._savedSettlementData)for(const i of this._savedSettlementData)e.set(i.key,i);for(const i of this.pois){if(i.type.category!=="settlement")continue;const s=`${i.q},${i.r}`,a=e.get(s);if(a!=null&&a.townAttributes?i.data.townAttributes=a.townAttributes:i.data.townAttributes||(i.data.townAttributes=it(((t=i.type)==null?void 0:t.size)||1)),a!=null&&a.facilities&&a.facilities.length>0)i.data.facilities=a.facilities;else if(!i.data.facilities){i.data.facilities=[];const n=i.type.size||1;n>=1&&i.data.facilities.push("storage"),n>=2&&i.data.facilities.push("stable","inn"),n>=3&&i.data.facilities.push("market","blacksmith"),n>=4&&i.data.facilities.push("library","barracks")}}this._savedSettlementData=null}getXpForLevel(e){return Math.floor(100*Math.pow(e,1.5))}gainXp(e){const t=this.player;t.exp+=e;let i=!1;for(;t.exp>=t.xpToNextLevel;)t.exp-=t.xpToNextLevel,t.level++,t.xpToNextLevel=this.getXpForLevel(t.level),this.applyLevelUp(),i=!0;return i}applyLevelUp(){const e=this.player,t=6+Math.floor(e.attributes.hp*1.5),i=4+Math.floor(e.attributes.stamina*.8),s=2+Math.floor(e.attributes.ether*.8);e.maxHealth+=t,e.health=e.maxHealth,e.maxStamina+=i,e.stamina=e.maxStamina,e.maxEther+=s,e.ether=e.maxEther,e.level%3===0&&this.autoDistributeAttribute(),this.addLog(`Level Up! Now level ${e.level}!`,"levelup"),this.addLog(`+${t} Max HP, +${i} Stamina, +${s} Ether`,"levelup")}autoDistributeAttribute(){const e=this.player,i={warrior:"hp",paladin:"hp",rogue:"agility",ranger:"agility",mage:"ether",cleric:"ether",druid:"ether",mercenary:"prestige",scout:"agility",merchant:"influence",artisan:"trust",scholar:"ether",mechanist:"prestige"}[e.class]||"prestige";e.attributes[i]++,this.addLog(`+1 ${i.charAt(0).toUpperCase()+i.slice(1)}`,"levelup")}applyCondition(e,t=null){const i=Q[e];if(!i)return console.warn(`Unknown condition: ${e}`),!1;const s=this.player.conditions[e];if(!s)return!1;const a=t||i.duration;if(s.active)s.duration=Math.max(s.duration,a);else if(s.active=!0,s.duration=a,this.addLog(i.message,"warning"),this.lexicon){this.lexicon.unlock("conditions_overview");const n=`condition_${e}`;this.lexicon.unlock(n)}return this.notify(),!0}removeCondition(e){const t=this.player.conditions[e];if(!t||!t.active)return!1;t.active=!1,t.duration=0;const i=Q[e];return i&&this.addLog(`${i.name} has worn off.`,"info"),this.notify(),!0}clearAllConditions(){let e=0;for(const t of Object.keys(this.player.conditions))this.player.conditions[t].active&&(this.player.conditions[t].active=!1,this.player.conditions[t].duration=0,e++);return e>0&&(this.addLog("All afflictions have been cleansed!","success"),this.notify()),e}tickConditions(){const e=this.player;for(const[t,i]of Object.entries(e.conditions)){if(!i.active)continue;if(i.duration--,i.duration<=0){this.removeCondition(t);continue}const s=Q[t];s.tickDamage&&s.tickDamage>0&&(e.health-=s.tickDamage,e.health<=0&&(e.health=1))}}onPlayerMove(){const e=this.player;if(e.conditions.bleeding&&e.conditions.bleeding.active){const t=Q.bleeding;e.health-=t.movementDamage,e.health<=0&&(e.health=1)}}getActiveConditions(){const e=[];for(const[t,i]of Object.entries(this.player.conditions))if(i.active){const s=Q[t];e.push({id:t,...s,remainingDuration:i.duration})}return e}hasCondition(e){const t=this.player.conditions[e];return t&&t.active}getConditionDamageMultiplier(){let e=1;return this.hasCondition("hexed")&&(e*=Q.hexed.damageMultiplier),this.hasCondition("cursed")&&(e*=Q.cursed.allStatsMultiplier),e}getConditionDefenseMultiplier(){let e=1;return this.hasCondition("weakened")&&(e*=Q.weakened.defenseMultiplier),this.hasCondition("cursed")&&(e*=Q.cursed.allStatsMultiplier),e}getConditionHealingMultiplier(){let e=1;return this.hasCondition("diseased")&&(e*=Q.diseased.healingMultiplier),e}canUseItems(){return!this.hasCondition("confused")}shouldSkipTurn(){return this.hasCondition("paralyzed")&&Math.random()<Q.paralyzed.skipTurnChance?(this.addLog("You are paralyzed and cannot act!","warning"),!0):!1}getBewitchedMovementChance(){return this.hasCondition("bewitched")?Q.bewitched.randomMovement:0}tickSurvival(e=1,t=!1,i=!1){const s=this.player.survival;s.hunger=Math.max(0,s.hunger-1.5*e),s.thirst=Math.max(0,s.thirst-3*e);let a=.5*e;t&&(a=2*e),i&&(a=5),s.energy=Math.max(0,s.energy-a);const n=this.getSurvivalPenalties();n.hungerDamage>0&&(this.player.health=Math.max(1,this.player.health-n.hungerDamage*e)),n.thirstDamage>0&&(this.player.health=Math.max(1,this.player.health-n.thirstDamage*e)),this.notify()}getSurvivalPenalties(){const e=this.player.survival,t={hungerStatus:"full",hungerStaminaRegen:1,hungerDamageMultiplier:1,hungerDamage:0,thirstStatus:"hydrated",thirstStaminaRegen:1,thirstSpeedMultiplier:1,thirstAllStats:1,thirstDamage:0,energyStatus:"rested",energyAgilityMultiplier:1,energyDamageMultiplier:1,energySkipTurnChance:0};return e.hunger<15?(t.hungerStatus="starving",t.hungerDamageMultiplier=.85,t.hungerDamage=.5):e.hunger<30?(t.hungerStatus="hungry",t.hungerStaminaRegen=.9):e.hunger<50&&(t.hungerStatus="peckish"),e.thirst<15?(t.thirstStatus="dying",t.thirstAllStats=.85,t.thirstDamage=1):e.thirst<30?(t.thirstStatus="dehydrated",t.thirstStaminaRegen=.85,t.thirstSpeedMultiplier=.95):e.thirst<50&&(t.thirstStatus="parched"),e.energy<15?(t.energyStatus="collapsing",t.energySkipTurnChance=.2):e.energy<30?(t.energyStatus="exhausted",t.energyAgilityMultiplier=.9,t.energyDamageMultiplier=.95):e.energy<50&&(t.energyStatus="tired"),t}getSurvivalDamageMultiplier(){const e=this.getSurvivalPenalties();return e.hungerDamageMultiplier*e.thirstAllStats*e.energyDamageMultiplier}getSurvivalAgilityMultiplier(){const e=this.getSurvivalPenalties();return e.thirstAllStats*e.energyAgilityMultiplier}shouldSkipTurnFromExhaustion(){const e=this.getSurvivalPenalties();return e.energySkipTurnChance>0&&Math.random()<e.energySkipTurnChance?(this.addLog("You are too exhausted to act!","warning"),!0):!1}restoreHunger(e){this.player.survival.hunger=Math.min(100,this.player.survival.hunger+e),this.notify()}restoreThirst(e){this.player.survival.thirst=Math.min(100,this.player.survival.thirst+e),this.notify()}restoreEnergy(e){this.player.survival.energy=Math.min(100,this.player.survival.energy+e),this.notify()}rest(e,t=100){const i=t;this.restoreEnergy(i),this.player.survival.hunger=Math.max(0,this.player.survival.hunger-.5*e),this.player.survival.thirst=Math.max(0,this.player.survival.thirst-1*e),this.addLog(`Rested for ${e} hours. Energy restored.`,"info")}drinkWater(){this.restoreThirst(100),this.addLog("You drink fresh water.","success")}learnRecipe(e){return this.knownRecipes.has(e)?!1:(this.knownRecipes.add(e),this.addLog(`Learned new recipe: ${e}`,"success"),!0)}hasRecipe(e){return this.knownRecipes.has(e)}markChestOpened(e,t){this.openedChests.add(`${e},${t}`)}isChestOpened(e,t){return this.openedChests.has(`${e},${t}`)}isPOIVisible(e){return!e||!e.id?!1:e.type.category==="settlement"?this.isNearStartingPosition(e.q,e.r,5)?!0:this.discoveredPOIs.has(e.id):we.ALWAYS_VISIBLE_CATEGORIES.includes(e.type.category)?!0:we.HIDDEN_CATEGORIES.includes(e.type.category)?this.discoveredPOIs.has(e.id):this.discoveredPOIs.has(e.id)}isNearStartingPosition(e,t,i=5){if(!this.startingPosition)return!1;const s=Math.abs(e-this.startingPosition.q),a=Math.abs(t-this.startingPosition.r),n=Math.abs(-e-t-(-this.startingPosition.q-this.startingPosition.r));return Math.max(s,a,n)<=i}discoverPOI(e,t=null){return this.discoveredPOIs.has(e)?!1:(this.discoveredPOIs.add(e),t&&(this.addLog(`Discovered: ${t.name} (${t.type.name})`,"success"),this.showToast(`Discovered ${t.name}!`,"success",3e3,"ðŸ”")),this.notify(),!0)}initializeDiscoveredPOIs(e,t){if(!(!e||!t)){this.startingPosition={q:t.q,r:t.r},t.id&&this.discoveredPOIs.add(t.id);for(const i of e)i.type.category==="settlement"&&this.isNearStartingPosition(i.q,i.r,5)&&this.discoveredPOIs.add(i.id);console.log(`Initialized POI discovery. Starting at ${t.name}. Discovered ${this.discoveredPOIs.size} POIs.`)}}getVisiblePOIs(e){return e?e.filter(t=>this.isPOIVisible(t)):[]}getUndiscoveredCount(e,t=null){return e?e.filter(i=>t&&i.type.category!==t?!1:!this.isPOIVisible(i)).length:0}serialize(){const e=[];for(const[t,i]of this.townStorage)e.push([t,{items:[...i.items.entries()],maxCapacity:i.maxCapacity,currentWeight:i.currentWeight}]);return JSON.stringify({version:9,worldSeed:this.worldSeed,tick:this.tick,day:this.day,hour:this.hour,minute:this.minute,player:this.player,guild:this.guild,cultData:this.cults?this.cults.toJSON():null,townActionsData:this.townActions?this.townActions.toJSON():null,townEconomyData:this.townEconomy?this.townEconomy.toJSON():null,discoveredPOIs:[...this.discoveredPOIs],startingPosition:this.startingPosition,resourceCooldowns:[...this.resourceCooldowns.entries()],townStorage:e,worldEnemies:this.worldEnemies,equippedTorch:this.equippedTorch||null,playerFacingAngle:this.playerFacingAngle||0,stolenDelivery:this.stolenDelivery||null,log:this.log.slice(0,20),lexiconData:this.lexicon?this.lexicon.toJSON():null,inventoryData:this.inventory?this.inventory.toJSON():null,questsData:this.quests?this.quests.toJSON():null,citizensData:this.citizens?this.citizens.toJSON():null,guildsData:this.guilds?this.guilds.toJSON():null,overworldCorruptionData:this.overworldCorruption?this.overworldCorruption.toJSON():null,knownRecipes:[...this.knownRecipes],openedChests:[...this.openedChests],exploredHexes:[...this.exploredHexes],settlementData:this.serializeSettlementData(),savedAt:Date.now()})}serializeSettlementData(){var t,i,s;if(!this.pois)return[];const e=[];for(const a of this.pois){if(((t=a.type)==null?void 0:t.category)!=="settlement")continue;const n=`${a.q},${a.r}`;e.push({key:n,townAttributes:((i=a.data)==null?void 0:i.townAttributes)||null,facilities:((s=a.data)==null?void 0:s.facilities)||[]})}return e}deserialize(e){try{const t=JSON.parse(e),i=9;if(t.version<i&&!t.lexiconOnly)return console.log(`Save version ${t.version} is outdated (current: ${i}). Preserving lexicon only.`),this.lexiconData=t.lexiconData||null,!1;if(this.worldSeed=t.worldSeed||null,this.tick=t.tick||0,this.day=t.day||1,this.hour=t.hour||6,this.minute=t.minute||0,t.player&&Object.assign(this.player,t.player),t.guild&&Object.assign(this.guild,t.guild),this.discoveredPOIs=new Set(t.discoveredPOIs||[]),this.startingPosition=t.startingPosition||null,this.resourceCooldowns=new Map(t.resourceCooldowns||[]),this.townStorage=new Map,t.townStorage)for(const[s,a]of t.townStorage)this.townStorage.set(s,{items:new Map(a.items||[]),maxCapacity:a.maxCapacity||100,currentWeight:a.currentWeight||0});return this.log=t.log||[],this.worldEnemies=t.worldEnemies||[],this.equippedTorch=t.equippedTorch||null,this.playerFacingAngle=t.playerFacingAngle||0,this.stolenDelivery=t.stolenDelivery||null,this._savedCultData=t.cultData||null,this._savedTownActionsData=t.townActionsData||null,this._savedTownEconomyData=t.townEconomyData||null,this.lexiconData=t.lexiconData||null,this._savedInventoryData=t.inventoryData||null,this._savedQuestsData=t.questsData||null,this._savedCitizensData=t.citizensData||null,this._savedGuildsData=t.guildsData||null,this._savedOverworldCorruptionData=t.overworldCorruptionData||null,this._savedSettlementData=t.settlementData||null,t.knownRecipes&&(this.knownRecipes=new Set(t.knownRecipes)),t.openedChests&&(this.openedChests=new Set(t.openedChests)),t.exploredHexes&&(this.exploredHexes=new Set(t.exploredHexes)),this.player.survival||(this.player.survival={hunger:100,thirst:100,energy:100}),this.notify(),!0}catch(t){return this.showError("Failed to load save game. The save file may be corrupted.",t),!1}}save(){try{const e=this.serialize();return!e||e==="undefined"||e==="null"?(this.showError("Failed to save game: Invalid data format."),!1):(localStorage.setItem("etherground_save",e),localStorage.getItem("etherground_save")?(this.lastSaveTime=Date.now(),!0):(this.showError("Failed to save game: Save verification failed."),!1))}catch(e){if(e.name==="QuotaExceededError"||e.code===22){this.showError("Save failed: Browser storage is full. Try clearing old saves.");try{localStorage.removeItem("etherground_preview_cache");const t=this.serialize();return localStorage.setItem("etherground_save",t),this.lastSaveTime=Date.now(),this.addLog("Save succeeded after clearing cache","success"),!0}catch(t){this.showError("Save retry failed. Please clear browser storage.",t)}}return this.showError("Failed to save game. Please check browser storage permissions.",e),!1}}load(){try{const e=localStorage.getItem("etherground_save");return e?this.deserialize(e):!1}catch(e){return this.showError("Failed to load game. The save file may be corrupted or incompatible.",e),!1}}hasSave(){const e=localStorage.getItem("etherground_save");if(!e)return!1;try{if(JSON.parse(e).lexiconOnly)return!1}catch{return!1}return!0}deleteSave(){const e="etherground_save";let t=null;try{const i=localStorage.getItem(e);i&&(t=JSON.parse(i).lexiconData)}catch{console.log("Could not preserve lexicon data")}if(localStorage.removeItem(e),t)try{localStorage.setItem(e,JSON.stringify({version:9,lexiconData:t,lexiconOnly:!0}))}catch{console.log("Could not save lexicon data")}}getSaveInfo(){var e,t;try{const i=localStorage.getItem("etherground_save");if(i){const s=JSON.parse(i);return s.lexiconOnly?{exists:!1}:{exists:!0,savedAt:s.savedAt,day:s.day,playerName:(e=s.player)==null?void 0:e.name,playerLevel:(t=s.player)==null?void 0:t.level,worldSeed:s.worldSeed}}}catch{}return{exists:!1}}};me(we,"ALWAYS_VISIBLE_CATEGORIES",["resource","crafting","landmark"]),me(we,"HIDDEN_CATEGORIES",["cult","guild"]);let ue=we;class wt{constructor(e){this.state=e,this.tickHandlers=[]}onTick(e){return this.tickHandlers.push(e),()=>{const t=this.tickHandlers.indexOf(e);t>=0&&this.tickHandlers.splice(t,1)}}advanceTime(e,t={}){const i=this.state,{isTraveling:s=!1,inCombat:a=!1}=t;i.hour;for(let n=0;n<e;n++){i.tick++,i.minute+=60/i.ticksPerHour,i.minute>=60&&(i.minute=0,i.hour++,i.hour>=24&&(i.hour=0,i.day++,i.addLog(`Dawn of Day ${i.day}`,"time")));for(const r of this.tickHandlers)r(i,i.tick)}i.notify()}advanceHours(e,t={}){const i=Math.ceil(e*this.state.ticksPerHour);this.advanceTime(i,t)}advanceMinutes(e){const t=e/60,i=Math.ceil(t*this.state.ticksPerHour);this.advanceTime(i)}travelTo(e,t,i=1){const s=this.state;if(s.player.traveling)return s.addLog("Already traveling!","warning"),!1;if(!s.player.position)return s.addLog("No current position!","error"),!1;const a=t.distance(s.player.position.q,s.player.position.r,e.q,e.r);if(a===0)return s.addLog("Already here!","warning"),!1;const n=5,r=1+s.player.attributes.agility*.05,o=Math.ceil(a*n/(i*r)),l=o/s.ticksPerHour,c=l<1?`${Math.ceil(l*60)} min`:`${l.toFixed(1)} hrs`,d=s.hour+l,u=s.hour<21&&d>=21?" (arriving after dark!)":"";s.addLog(`Traveling to ${e.name} (${c})${u}`,"travel");const h=a*.005;if(s.player.stamina<h)return s.addLog("Too exhausted to travel! Rest first.","warning"),!1;s.player.stamina=Math.max(0,s.player.stamina-h),s.isNight&&(s.player.stamina=Math.max(0,s.player.stamina-a*.009),s.addLog("Night travel is exhausting...","warning")),this.advanceTime(o,{isTraveling:!0}),s.player.position={q:e.q,r:e.r},s.player.currentPOI=e;const m=`${e.q},${e.r}`;return s.discoveredPOIs.has(m)?s.addLog(`Arrived at ${e.name}`,"success"):(s.discoveredPOIs.add(m),s.addLog(`Discovered: ${e.name}`,"discovery")),s.notify(),!0}rest(e=1,t="normal"){var o,l;const i=this.state,s=i.player.stamina<i.player.maxStamina,a=((o=i.player.survival)==null?void 0:o.energy)<100;if(!s&&!a)return i.addLog("Already well rested.","info"),!1;const n=e*20;if(i.player.stamina=Math.min(i.player.maxStamina,i.player.stamina+n),typeof i.rest=="function"){const c=t==="inn"?1:t==="camp"?.8:.5,d=e/8*100*c;i.rest(e,d)}const r=((l=i.player.currentPOI)==null?void 0:l.name)||"the wilderness";return i.addLog(`Rested for ${e}hr at ${r}`,"info"),this.advanceHours(e),!0}wait(e=1){const t=this.state;return t.addLog(`Waited ${e} hour${e>1?"s":""}`,"info"),t.player.stamina=Math.min(t.player.maxStamina,t.player.stamina+e*5),this.advanceHours(e),!0}}class qi{constructor(){this.ctx=null,this.enabled=!0,this.volume=.3,this.activeOscillators=new Map,this.clickSound=null,this.coinSound=null,this.loadClickSound(),this.loadCoinSound()}loadClickSound(){this.clickSound=new Audio("click.webm"),this.clickSound.volume=this.volume}loadCoinSound(){this.coinSound=new Audio("276172__littlerobotsoundfactory__coins_few_07.wav"),this.coinSound.volume=this.volume}playCoin(){if(!this.enabled||!this.coinSound)return;const e=this.coinSound.cloneNode();e.volume=this.volume*.6,e.play().catch(()=>{})}init(){return this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),this.ctx.state==="suspended"&&this.ctx.resume(),this.ctx}startProgressSound(e=200,t=600){const i=this.init();if(!this.enabled)return{update:()=>{},stop:()=>{}};const s=i.createOscillator(),a=i.createGain();s.type="sine",s.frequency.setValueAtTime(e,i.currentTime),a.gain.setValueAtTime(this.volume*.4,i.currentTime),s.connect(a),a.connect(i.destination),s.start();const n=Date.now();return this.activeOscillators.set(n,{oscillator:s,gainNode:a}),{update:r=>{if(!this.enabled)return;const o=e+(t-e)*(r/100);s.frequency.setValueAtTime(o,i.currentTime),a.gain.setValueAtTime(this.volume*(.3+r*.004),i.currentTime)},stop:(r=!1)=>{r&&this.enabled&&this.playComplete(),a.gain.exponentialRampToValueAtTime(.001,i.currentTime+.1),setTimeout(()=>{s.stop(),this.activeOscillators.delete(n)},100)}}}playComplete(){const e=this.init();this.enabled&&[523.25,659.25].forEach((t,i)=>{const s=e.createOscillator(),a=e.createGain();s.type="sine",s.frequency.setValueAtTime(t,e.currentTime);const n=e.currentTime+i*.08;a.gain.setValueAtTime(0,n),a.gain.linearRampToValueAtTime(this.volume*.5,n+.02),a.gain.exponentialRampToValueAtTime(.001,n+.3),s.connect(a),a.connect(e.destination),s.start(n),s.stop(n+.35)})}playPickup(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="square",t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(800,e.currentTime+.1),i.gain.setValueAtTime(this.volume*.3,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.15),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+.15)}playHit(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="sawtooth",t.frequency.setValueAtTime(150,e.currentTime),t.frequency.exponentialRampToValueAtTime(50,e.currentTime+.1),i.gain.setValueAtTime(this.volume*.4,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.15),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+.15)}playClick(){if(!this.enabled||!this.clickSound)return;const e=this.clickSound.cloneNode();e.volume=this.volume*.5,e.play().catch(()=>{})}playError(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="square",t.frequency.setValueAtTime(200,e.currentTime),t.frequency.setValueAtTime(150,e.currentTime+.1),i.gain.setValueAtTime(this.volume*.3,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.2),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+.2)}playSwordSlash(){const e=this.init();if(!this.enabled)return;const t=e.sampleRate*.15,i=e.createBuffer(1,t,e.sampleRate),s=i.getChannelData(0);for(let o=0;o<t;o++)s[o]=(Math.random()*2-1)*(1-o/t);const a=e.createBufferSource();a.buffer=i;const n=e.createBiquadFilter();n.type="highpass",n.frequency.setValueAtTime(2e3,e.currentTime),n.frequency.exponentialRampToValueAtTime(500,e.currentTime+.1);const r=e.createGain();r.gain.setValueAtTime(this.volume*.4,e.currentTime),r.gain.exponentialRampToValueAtTime(.001,e.currentTime+.15),a.connect(n),n.connect(r),r.connect(e.destination),a.start()}playCriticalHit(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="sine",t.frequency.setValueAtTime(150,e.currentTime),t.frequency.exponentialRampToValueAtTime(30,e.currentTime+.2),i.gain.setValueAtTime(this.volume*.6,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.25),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+.3);const s=e.createOscillator(),a=e.createGain();s.type="square",s.frequency.setValueAtTime(800,e.currentTime),s.frequency.exponentialRampToValueAtTime(200,e.currentTime+.05),a.gain.setValueAtTime(this.volume*.3,e.currentTime),a.gain.exponentialRampToValueAtTime(.001,e.currentTime+.1),s.connect(a),a.connect(e.destination),s.start(),s.stop(e.currentTime+.15)}playSpellCast(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="sine",t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(800,e.currentTime+.2),i.gain.setValueAtTime(this.volume*.3,e.currentTime),i.gain.linearRampToValueAtTime(this.volume*.4,e.currentTime+.1),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.3),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+.35);const s=e.createOscillator(),a=e.createGain();s.type="triangle",s.frequency.setValueAtTime(600,e.currentTime),s.frequency.exponentialRampToValueAtTime(1200,e.currentTime+.15),a.gain.setValueAtTime(this.volume*.15,e.currentTime),a.gain.exponentialRampToValueAtTime(.001,e.currentTime+.25),s.connect(a),a.connect(e.destination),s.start(),s.stop(e.currentTime+.3)}playHeal(){const e=this.init();this.enabled&&[523.25,659.25,783.99].forEach((t,i)=>{const s=e.createOscillator(),a=e.createGain();s.type="sine",s.frequency.setValueAtTime(t,e.currentTime);const n=e.currentTime+i*.06;a.gain.setValueAtTime(0,n),a.gain.linearRampToValueAtTime(this.volume*.35,n+.03),a.gain.exponentialRampToValueAtTime(.001,n+.4),s.connect(a),a.connect(e.destination),s.start(n),s.stop(n+.45)})}playDefend(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="triangle",t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),i.gain.setValueAtTime(this.volume*.5,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.2),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+.25);const s=e.createOscillator(),a=e.createGain();s.type="sine",s.frequency.setValueAtTime(1200,e.currentTime),a.gain.setValueAtTime(this.volume*.2,e.currentTime),a.gain.exponentialRampToValueAtTime(.001,e.currentTime+.15),s.connect(a),a.connect(e.destination),s.start(),s.stop(e.currentTime+.2)}playEnemyAttack(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="sawtooth",t.frequency.setValueAtTime(120,e.currentTime),t.frequency.exponentialRampToValueAtTime(60,e.currentTime+.15),i.gain.setValueAtTime(this.volume*.4,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.2),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+.25)}playPlayerHurt(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="sawtooth",t.frequency.setValueAtTime(200,e.currentTime),t.frequency.exponentialRampToValueAtTime(100,e.currentTime+.1),i.gain.setValueAtTime(this.volume*.35,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.15),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+.2)}playDodge(){const e=this.init();if(!this.enabled)return;const t=e.sampleRate*.2,i=e.createBuffer(1,t,e.sampleRate),s=i.getChannelData(0);for(let o=0;o<t;o++)s[o]=(Math.random()*2-1)*Math.sin(Math.PI*o/t);const a=e.createBufferSource();a.buffer=i;const n=e.createBiquadFilter();n.type="bandpass",n.frequency.setValueAtTime(1500,e.currentTime),n.Q.setValueAtTime(2,e.currentTime);const r=e.createGain();r.gain.setValueAtTime(this.volume*.25,e.currentTime),r.gain.exponentialRampToValueAtTime(.001,e.currentTime+.2),a.connect(n),n.connect(r),r.connect(e.destination),a.start()}playFlee(){const e=this.init();this.enabled&&[0,.08,.16,.24].forEach(t=>{const i=e.createOscillator(),s=e.createGain();i.type="triangle",i.frequency.setValueAtTime(300+Math.random()*100,e.currentTime+t),s.gain.setValueAtTime(0,e.currentTime+t),s.gain.linearRampToValueAtTime(this.volume*.2,e.currentTime+t+.01),s.gain.exponentialRampToValueAtTime(.001,e.currentTime+t+.05),i.connect(s),s.connect(e.destination),i.start(e.currentTime+t),i.stop(e.currentTime+t+.06)})}playVictory(){const e=this.init();if(!this.enabled)return;const t=[{freq:261.63,time:0,duration:.15},{freq:329.63,time:.12,duration:.15},{freq:392,time:.24,duration:.15},{freq:523.25,time:.36,duration:.4}];t.forEach(a=>{const n=e.createOscillator(),r=e.createGain();n.type="triangle",n.frequency.setValueAtTime(a.freq,e.currentTime+a.time);const o=e.currentTime+a.time;r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(this.volume*.4,o+.02),r.gain.setValueAtTime(this.volume*.4,o+a.duration*.7),r.gain.exponentialRampToValueAtTime(.001,o+a.duration),n.connect(r),r.connect(e.destination),n.start(o),n.stop(o+a.duration+.1)}),t.forEach(a=>{const n=e.createOscillator(),r=e.createGain();n.type="sine",n.frequency.setValueAtTime(a.freq*2,e.currentTime+a.time);const o=e.currentTime+a.time;r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(this.volume*.15,o+.02),r.gain.exponentialRampToValueAtTime(.001,o+a.duration),n.connect(r),r.connect(e.destination),n.start(o),n.stop(o+a.duration+.1)});const i=.5;[523.25,659.25,783.99].forEach(a=>{const n=e.createOscillator(),r=e.createGain();n.type="sine",n.frequency.setValueAtTime(a,e.currentTime+i);const o=e.currentTime+i;r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(this.volume*.25,o+.03),r.gain.setValueAtTime(this.volume*.25,o+.3),r.gain.exponentialRampToValueAtTime(.001,o+.6),n.connect(r),r.connect(e.destination),n.start(o),n.stop(o+.7)})}playDefeat(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="sawtooth",t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(50,e.currentTime+.8),i.gain.setValueAtTime(this.volume*.4,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+1),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+1.1)}playCombatStart(){const e=this.init();if(!this.enabled)return;const t=e.sampleRate*.12,i=e.createBuffer(1,t,e.sampleRate),s=i.getChannelData(0);for(let d=0;d<t;d++){const u=Math.pow(1-d/t,2);s[d]=(Math.random()*2-1)*u}const a=e.createBufferSource();a.buffer=i;const n=e.createBiquadFilter();n.type="highpass",n.frequency.setValueAtTime(3e3,e.currentTime),n.frequency.exponentialRampToValueAtTime(800,e.currentTime+.1);const r=e.createGain();r.gain.setValueAtTime(this.volume*.6,e.currentTime),r.gain.exponentialRampToValueAtTime(.001,e.currentTime+.15),a.connect(n),n.connect(r),r.connect(e.destination),a.start();const o=e.createOscillator(),l=e.createGain();o.type="sine",o.frequency.setValueAtTime(80,e.currentTime+.05),o.frequency.exponentialRampToValueAtTime(30,e.currentTime+.25),l.gain.setValueAtTime(0,e.currentTime),l.gain.linearRampToValueAtTime(this.volume*.5,e.currentTime+.07),l.gain.exponentialRampToValueAtTime(.001,e.currentTime+.3),o.connect(l),l.connect(e.destination),o.start(e.currentTime+.05),o.stop(e.currentTime+.35),[220,233,311].forEach((d,u)=>{const h=e.createOscillator(),m=e.createGain();h.type="sawtooth",h.frequency.setValueAtTime(d,e.currentTime+.08);const g=e.currentTime+.08;m.gain.setValueAtTime(0,g),m.gain.linearRampToValueAtTime(this.volume*.2,g+.02),m.gain.exponentialRampToValueAtTime(.001,g+.25),h.connect(m),m.connect(e.destination),h.start(g),h.stop(g+.3)})}playQuestComplete(){const e=this.init();if(!this.enabled)return;[{freq:523.25,time:0,duration:.12},{freq:659.25,time:.1,duration:.12},{freq:783.99,time:.2,duration:.12},{freq:1046.5,time:.3,duration:.35}].forEach(i=>{const s=e.createOscillator(),a=e.createGain();s.type="triangle",s.frequency.setValueAtTime(i.freq,e.currentTime+i.time);const n=e.currentTime+i.time;a.gain.setValueAtTime(0,n),a.gain.linearRampToValueAtTime(this.volume*.35,n+.015),a.gain.setValueAtTime(this.volume*.35,n+i.duration*.6),a.gain.exponentialRampToValueAtTime(.001,n+i.duration),s.connect(a),a.connect(e.destination),s.start(n),s.stop(n+i.duration+.05);const r=e.createOscillator(),o=e.createGain();r.type="sine",r.frequency.setValueAtTime(i.freq*2,e.currentTime+i.time),o.gain.setValueAtTime(0,n),o.gain.linearRampToValueAtTime(this.volume*.12,n+.015),o.gain.exponentialRampToValueAtTime(.001,n+i.duration*.8),r.connect(o),o.connect(e.destination),r.start(n),r.stop(n+i.duration+.05)})}playBuff(){const e=this.init();if(!this.enabled)return;const t=e.createOscillator(),i=e.createGain();t.type="sine",t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(800,e.currentTime+.15),t.frequency.setValueAtTime(800,e.currentTime+.15),i.gain.setValueAtTime(this.volume*.3,e.currentTime),i.gain.linearRampToValueAtTime(this.volume*.35,e.currentTime+.1),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.3),t.connect(i),i.connect(e.destination),t.start(),t.stop(e.currentTime+.35)}playImpact(){const e=this.init();if(!this.enabled)return;const t=e.sampleRate*.1,i=e.createBuffer(1,t,e.sampleRate),s=i.getChannelData(0);for(let c=0;c<t;c++)s[c]=Math.random()*2-1;const a=e.createBufferSource();a.buffer=i;const n=e.createGain(),r=e.createBiquadFilter();r.type="lowpass",r.frequency.setValueAtTime(1e3,e.currentTime),r.frequency.exponentialRampToValueAtTime(100,e.currentTime+.1),n.gain.setValueAtTime(this.volume*.5,e.currentTime),n.gain.exponentialRampToValueAtTime(.001,e.currentTime+.1),a.connect(r),r.connect(n),n.connect(e.destination),a.start();const o=e.createOscillator(),l=e.createGain();o.type="sine",o.frequency.setValueAtTime(100,e.currentTime),o.frequency.exponentialRampToValueAtTime(40,e.currentTime+.1),l.gain.setValueAtTime(this.volume*.4,e.currentTime),l.gain.exponentialRampToValueAtTime(.001,e.currentTime+.1),o.connect(l),l.connect(e.destination),o.start(),o.stop(e.currentTime+.15)}stopAll(){for(const[e,t]of this.activeOscillators)try{t.gainNode.gain.setValueAtTime(0,this.ctx.currentTime),t.oscillator.stop()}catch{}this.activeOscillators.clear()}toggle(){return this.enabled=!this.enabled,this.enabled||this.stopAll(),this.enabled}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.clickSound&&(this.clickSound.volume=this.volume)}enableGlobalClickSound(){document.addEventListener("click",()=>{this.playClick()},!0)}}const $=new qi;$.enableGlobalClickSound();const Ri={agriculture:{id:"agriculture",name:"Agriculture",nameEs:"Agricultura",icon:"ðŸŒ¾",tier:1,description:"Farming, food production, and crop management",primarySkills:["farming","cooking","brewing"],secondarySkills:["gathering","fishing","hunting"],relatedResources:["food","fish","meat","vegetables","grain","herbs","salt","spices"],guildBuilding:"granary",color:"#8B4513"},construction:{id:"construction",name:"Construction",nameEs:"ConstrucciÃ³n",icon:"ðŸ”¨",tier:2,description:"Building structures with basic materials",primarySkills:["carpentry","masonry","construction"],secondarySkills:["gathering","woodcutting","mining"],relatedResources:["wood","stone","clay","mud","lumber","bricks","rope"],guildBuilding:"workshop",color:"#8b6914"},medicine:{id:"medicine",name:"Clerical Medicine",nameEs:"Medicina Cleriga",icon:"âš•ï¸",tier:3,description:"Healing through plants, books, and faith",primarySkills:["medicine","herbalism","alchemy"],secondarySkills:["lore","faith","gathering"],relatedResources:["herbs","potions","books","holy_water","incense","bandages","antidotes"],guildBuilding:"clinic",color:"#45a87e"},tailoring:{id:"tailoring",name:"Tailoring",nameEs:"Ropa",icon:"ðŸ§µ",tier:4,description:"Crafting clothing from leather, bones, and cloth",primarySkills:["tailoring","leatherworking","weaving"],secondarySkills:["hunting","crafting","trading"],relatedResources:["leather","bone","cloth","pelts","fur","wool","silk","thread"],guildBuilding:"tailorshop",color:"#9b59b6"},warriors:{id:"warriors",name:"Warriors",nameEs:"Guerreros",icon:"âš”ï¸",tier:5,description:"Combat training and monster hunting",primarySkills:["combat","hunting","patrol"],secondarySkills:["survival","tracking","leadership"],relatedResources:["monster_parts","meat","pelts","bones","trophies","weapons"],guildBuilding:"barracks",color:"#c0392b"},smithing:{id:"smithing",name:"Smithing",nameEs:"HerrerÃ­a",icon:"âš’ï¸",tier:6,description:"Metalworking and precious material crafting",primarySkills:["smithing","mining","metalworking"],secondarySkills:["crafting","appraisal","gathering"],relatedResources:["iron","ore","coal","gold","silver","gems","ingots","steel"],guildBuilding:"forge",color:"#7f8c8d"},rangers:{id:"rangers",name:"Rangers",nameEs:"Rangers",icon:"ðŸ¹",tier:7,description:"Elite specialists combining all disciplines",primarySkills:["exploration","survival","tracking"],secondarySkills:["combat","hunting","gathering","crafting","medicine"],relatedResources:[],guildBuilding:"rangerhall",color:"#27ae60",prerequisites:{minProfessions:3,minLevel:3}}},kt={food:"agriculture",fish:"agriculture",meat:"agriculture",vegetables:"agriculture",grain:"agriculture",salt:"agriculture",spices:"agriculture",bread:"agriculture",rations:"agriculture",dried_meat:"agriculture",cheese:"agriculture",wood:"construction",stone:"construction",clay:"construction",mud:"construction",lumber:"construction",bricks:"construction",rope:"construction",planks:"construction",herbs:"medicine",potions:"medicine",health_potion:"medicine",bandage:"medicine",antidote:"medicine",holy_water:"medicine",incense:"medicine",books:"medicine",stamina_potion:"medicine",leather:"tailoring",cloth:"tailoring",pelts:"tailoring",fur:"tailoring",wool:"tailoring",silk:"tailoring",thread:"tailoring",bone:"tailoring",hide:"tailoring",wolf_pelt:"tailoring",deer_hide:"tailoring",bear_pelt:"tailoring",monster_parts:"warriors",trophies:"warriors",claws:"warriors",fangs:"warriors",venom:"warriors",scales:"warriors",iron:"smithing",ore:"smithing",coal:"smithing",gold:"smithing",silver:"smithing",gems:"smithing",ingots:"smithing",steel:"smithing",iron_ingot:"smithing",copper:"smithing",tin:"smithing",ruby:"smithing",emerald:"smithing",sapphire:"smithing"},xt={gather_wood:{construction:2,rangers:1},mine_stone:{construction:3,smithing:1},gather_herbs:{medicine:3,agriculture:1},clear_pests:{warriors:3,rangers:1},delivery_run:{rangers:2,tailoring:1},smithy_work:{smithing:4,construction:1},hunt_game:{warriors:2,agriculture:2,tailoring:1},catch_fish:{agriculture:3,rangers:1},heal_wounded:{medicine:4,agriculture:1},repair_buildings:{construction:3,smithing:1},street_patrol:{warriors:2,rangers:1},assist_merchants:{tailoring:2,smithing:1},guard_duty:{warriors:3},teach_skills:{medicine:1,construction:1,rangers:2},build_well:{construction:5},repair_walls:{construction:4,smithing:2},establish_trade_route:{tailoring:3,rangers:2},clear_roads:{construction:2,rangers:2},organize_militia:{warriors:5,rangers:2},build_granary:{construction:4,agriculture:2},establish_clinic:{medicine:5,construction:2},survey_resources:{rangers:4,construction:1}},Di={gather_wood:{id:"gather_wood",name:"Gather Wood",icon:"ðŸªµ",description:"Collect wood from nearby forests",type:"gather",target:"wood",tiers:[{required:3,reward:{gold:8,trust:1},difficulty:1},{required:5,reward:{gold:12,trust:1},difficulty:2},{required:8,reward:{gold:20,trust:2},difficulty:3}]},mine_stone:{id:"mine_stone",name:"Mine Stone",icon:"ðŸª¨",description:"Extract stone from quarries",type:"gather",target:"stone",tiers:[{required:2,reward:{gold:10,trust:1},difficulty:1},{required:4,reward:{gold:15,trust:1},difficulty:2},{required:6,reward:{gold:25,trust:2},difficulty:3}]},gather_herbs:{id:"gather_herbs",name:"Gather Herbs",icon:"ðŸŒ¿",description:"Collect medicinal herbs",type:"gather",target:"herbs",tiers:[{required:4,reward:{gold:6},difficulty:1},{required:7,reward:{gold:10,trust:1},difficulty:2},{required:10,reward:{gold:18,trust:2},difficulty:3}]},clear_pests:{id:"clear_pests",name:"Clear Pests",icon:"ðŸ€",description:"Eliminate pests in the area",type:"kill",target:["rat","giant_rat","snake"],tiers:[{required:2,reward:{gold:15,prestige:1},difficulty:1},{required:4,reward:{gold:25,prestige:2},difficulty:2},{required:6,reward:{gold:40,prestige:3},difficulty:3}]},delivery_run:{id:"delivery_run",name:"Delivery Run",icon:"ðŸ“¦",description:"Deliver goods across the region",type:"time",tiers:[{required:4,reward:{gold:6},difficulty:1},{required:8,reward:{gold:10,influence:1},difficulty:2},{required:12,reward:{gold:16,influence:2},difficulty:3}]},smithy_work:{id:"smithy_work",name:"Smithy Work",icon:"âš’ï¸",description:"Help at the blacksmith",type:"craft",target:"iron_ingot",requiresFeature:"Blacksmith",tiers:[{required:1,reward:{gold:12,prestige:1},difficulty:1},{required:2,reward:{gold:20,prestige:2},difficulty:2},{required:3,reward:{gold:35,prestige:3},difficulty:3}]},hunt_game:{id:"hunt_game",name:"Hunt Game",icon:"ðŸ¦Œ",description:"Hunt animals for the town",type:"gather",target:"game_meat",tiers:[{required:2,reward:{gold:12},difficulty:1},{required:4,reward:{gold:20,trust:1},difficulty:2},{required:6,reward:{gold:32,trust:2},difficulty:3}]},catch_fish:{id:"catch_fish",name:"Catch Fish",icon:"ðŸŽ£",description:"Fish for the local market",type:"gather",target:"fish",tiers:[{required:3,reward:{gold:8},difficulty:1},{required:5,reward:{gold:14,trust:1},difficulty:2},{required:8,reward:{gold:22,trust:2},difficulty:3}]}},Li={heal_wounded:{id:"heal_wounded",name:"Heal Wounded",icon:"ðŸ©¹",description:"Tend to injured citizens",type:"use_item",target:"bandage",tiers:[{required:2,reward:{trust:3,influence:1},difficulty:1},{required:4,reward:{trust:5,influence:2},difficulty:2}]},repair_buildings:{id:"repair_buildings",name:"Repair Buildings",icon:"ðŸ”¨",description:"Help with town repairs",type:"gather",target:"wood",tiers:[{required:3,reward:{trust:3,prestige:1},difficulty:1},{required:5,reward:{trust:5,prestige:2},difficulty:2}]},street_patrol:{id:"street_patrol",name:"Street Patrol",icon:"ðŸ‘ï¸",description:"Help keep the peace",type:"time",tiers:[{required:4,reward:{trust:3,influence:2},difficulty:1},{required:8,reward:{trust:5,influence:3},difficulty:2}]},assist_merchants:{id:"assist_merchants",name:"Assist Merchants",icon:"ðŸ›’",description:"Help with market duties",type:"time",tiers:[{required:2,reward:{trust:2,influence:1},difficulty:1},{required:4,reward:{trust:4,influence:2},difficulty:2}]},guard_duty:{id:"guard_duty",name:"Guard Duty",icon:"ðŸ›¡ï¸",description:"Watch over the settlement",type:"time",tiers:[{required:2,reward:{trust:3,prestige:2},difficulty:1},{required:4,reward:{trust:5,prestige:3},difficulty:2}]},teach_skills:{id:"teach_skills",name:"Teach Skills",icon:"ðŸ“š",description:"Share knowledge with townsfolk",type:"time",tiers:[{required:3,reward:{trust:2,prestige:3,influence:1},difficulty:1},{required:6,reward:{trust:4,prestige:5,influence:2},difficulty:2}]}},Bi={build_well:{id:"build_well",name:"Build New Well",icon:"ðŸª£",description:"Construct a well to improve water access",type:"build",requirements:{wood:5,stone:3},tiers:[{required:1,reward:{trust:5,prestige:4,influence:3},difficulty:2}],infrastructureEffect:"well"},repair_walls:{id:"repair_walls",name:"Repair Town Walls",icon:"ðŸ§±",description:"Strengthen settlement defenses",type:"build",requirements:{stone:8,wood:4},tiers:[{required:1,reward:{trust:4,prestige:6,influence:4},difficulty:3}],infrastructureEffect:"walls"},establish_trade_route:{id:"establish_trade_route",name:"Establish Trade Route",icon:"ðŸ›¤ï¸",description:"Create a trade connection to nearby settlement",type:"travel",tiers:[{required:10,reward:{trust:3,prestige:5,influence:6,gold:30},difficulty:2}],infrastructureEffect:"trade_route"},clear_roads:{id:"clear_roads",name:"Clear the Roads",icon:"ðŸ›£ï¸",description:"Remove debris and hazards from local roads",type:"time",tiers:[{required:6,reward:{trust:4,prestige:3,influence:2},difficulty:1},{required:12,reward:{trust:6,prestige:5,influence:4},difficulty:2}],infrastructureEffect:"roads"},organize_militia:{id:"organize_militia",name:"Organize Militia",icon:"âš”ï¸",description:"Train citizens for town defense",type:"time",tiers:[{required:8,reward:{trust:5,prestige:6,influence:4},difficulty:2}],infrastructureEffect:"militia"},build_granary:{id:"build_granary",name:"Build Granary",icon:"ðŸŒ¾",description:"Construct storage for food reserves",type:"build",requirements:{wood:10,stone:5},tiers:[{required:1,reward:{trust:6,prestige:5,influence:4},difficulty:3}],infrastructureEffect:"granary"},establish_clinic:{id:"establish_clinic",name:"Establish Clinic",icon:"ðŸ¥",description:"Set up a place for healing the sick",type:"build",requirements:{wood:6,herbs:10},tiers:[{required:1,reward:{trust:8,prestige:4,influence:5},difficulty:3}],infrastructureEffect:"clinic"},survey_resources:{id:"survey_resources",name:"Survey Resources",icon:"ðŸ—ºï¸",description:"Map nearby resource locations",type:"travel",tiers:[{required:8,reward:{trust:3,prestige:4,influence:3},difficulty:2}],infrastructureEffect:"resource_map"}},Oi={gather_wood:{primary:"gathering",secondary:"woodcutting"},mine_stone:{primary:"gathering",secondary:"mining"},gather_herbs:{primary:"gathering",secondary:"herbalism"},clear_pests:{primary:"combat",secondary:"patrol"},delivery_run:{primary:"exploration",secondary:"survival"},smithy_work:{primary:"smithing",secondary:"crafting"},hunt_game:{primary:"hunting",secondary:"gathering"},catch_fish:{primary:"gathering",secondary:"survival"},heal_wounded:{primary:"medicine",secondary:"herbalism"},repair_buildings:{primary:"crafting",secondary:"gathering"},street_patrol:{primary:"patrol",secondary:"combat"},assist_merchants:{primary:"trading",secondary:"appraisal"},guard_duty:{primary:"combat",secondary:"patrol"},teach_skills:{primary:"teaching",secondary:"leadership"},build_well:{primary:"crafting",secondary:"gathering"},repair_walls:{primary:"crafting",secondary:"gathering"},establish_trade_route:{primary:"trading",secondary:"exploration"},clear_roads:{primary:"gathering",secondary:"survival"},organize_militia:{primary:"combat",secondary:"leadership"},build_granary:{primary:"crafting",secondary:"gathering"},establish_clinic:{primary:"medicine",secondary:"crafting"},survey_resources:{primary:"exploration",secondary:"gathering"}},Hi={farmer:["gather_wood","gather_herbs","catch_fish","clear_roads","build_granary","survey_resources"],builder:["gather_wood","mine_stone","repair_buildings","build_well","repair_walls","build_granary","clear_roads","establish_clinic"],healer:["heal_wounded","gather_herbs","establish_clinic","teach_skills"],tailor:["assist_merchants","delivery_run","establish_trade_route"],guard:["clear_pests","guard_duty","street_patrol","organize_militia","hunt_game"],smith:["smithy_work","mine_stone","build_well","repair_walls"],ranger:["gather_wood","hunt_game","delivery_run","street_patrol","clear_pests","clear_roads","survey_resources","establish_trade_route","teach_skills"],worker:[]},Te={gather_wood:["farmer","builder","ranger"],mine_stone:["builder","smith"],gather_herbs:["farmer","healer"],clear_pests:["guard","ranger"],delivery_run:["tailor","ranger"],smithy_work:["smith"],hunt_game:["ranger","guard"],catch_fish:["farmer"],heal_wounded:["healer"],repair_buildings:["builder"],street_patrol:["guard","ranger"],assist_merchants:["tailor"],guard_duty:["guard"],teach_skills:["ranger","healer"],build_well:["builder","smith"],repair_walls:["builder","smith"],establish_trade_route:["tailor","ranger"],clear_roads:["farmer","builder","ranger"],organize_militia:["guard"],build_granary:["builder","farmer"],establish_clinic:["healer","builder"],survey_resources:["ranger","farmer"]},Ee={farmer:"Farmer",builder:"Builder",healer:"Healer",tailor:"Tailor",guard:"Guard",smith:"Smith",ranger:"Ranger",worker:"Worker"},Ni={farmer:{speedBonus:.25,rewardBonus:.15},builder:{speedBonus:.3,rewardBonus:.2},healer:{speedBonus:.25,rewardBonus:.2},tailor:{speedBonus:.2,rewardBonus:.25},guard:{speedBonus:.35,rewardBonus:.15},smith:{speedBonus:.3,rewardBonus:.2},ranger:{speedBonus:.3,rewardBonus:.1},worker:{speedBonus:.1,rewardBonus:.05}},zi={gatherer:"farmer",crafter:"smith",merchant:"tailor",guard:"guard",scout:"ranger",farmer:"farmer",builder:"builder",healer:"healer",tailor:"tailor",smith:"smith",ranger:"ranger",worker:"worker"};function Tt(T){if(!T)return null;const e=T.toLowerCase();return zi[e]||e}class Ct{constructor(e,t){this.state=e,this.gameLoop=t,this.availableTasks=[],this.acceptedTasks=[],this.acceptedTasksById=new Map,this.completedToday=0,this.taskGenerationDay=new Map,this.citizenAssignedTasks=new Map,this.townInfrastructure=new Map,this.availableDeliveries=[],this.activeDelivery=null,this.deliveryGenerationDay=new Map,this.menuActions={rest:{id:"rest",name:"Rest at Inn",description:"Full recovery",cost:{gold:10},reward:{health:"full",stamina:"full"},hourCost:8},stables:{id:"stables",name:"Visit Stables",description:"Fast travel options",isMenu:!0},shop:{id:"shop",name:"Visit Shop",description:"Buy and sell items",isMenu:!0},storage:{id:"storage",name:"Town Storage",description:"Store items safely",isMenu:!0}}}generateTasks(e){var d,u;if(!e||e.type.category!=="settlement")return[];const t=`${e.q},${e.r}`,i=this.state.day;if(this.taskGenerationDay.get(t)===i&&this.availableTasks.length>0)return this.availableTasks;this.availableTasks=[];const s=((d=e.data)==null?void 0:d.features)||[],a=((u=this.state.citizens)==null?void 0:u.citizens)||[],n=a.length,r=[...new Set(a.map(h=>Tt(h.role)).filter(Boolean))],o=this._generateCategoryTasks(Di,"work",{baseCount:4,maxCount:8,citizenCount:n,citizenRoles:r,features:s,poiKey:t,includeAllTypes:!0}),l=this._generateCategoryTasks(Li,"volunteer",{baseCount:3,maxCount:6,citizenCount:n,citizenRoles:r,features:s,poiKey:t,includeAllTypes:!0}),c=this._generateCategoryTasks(Bi,"townBoard",{baseCount:2,maxCount:5,citizenCount:n,citizenRoles:r,features:s,poiKey:t,checkInfrastructure:!0,includeAllTypes:!0});return this.availableTasks=[...o,...l,...c],this.taskGenerationDay.set(t,i),this.availableTasks}_generateCategoryTasks(e,t,i){const{baseCount:s,maxCount:a,citizenCount:n,citizenRoles:r,features:o,poiKey:l,checkInfrastructure:c,includeAllTypes:d}=i,u=[],h=Math.min(s+Math.floor(n/2),a),m=[],g=[];for(const v of Object.values(e)){if(v.requiresFeature&&!o.includes(v.requiresFeature)||c&&v.infrastructureEffect&&(this.townInfrastructure.get(l)||new Set).has(v.infrastructureEffect))continue;const b=Te[v.id]||[];b.length===0||r.some(w=>b.includes(w))?m.push({template:v,hasEligibleCitizen:!0}):g.push({template:v,hasEligibleCitizen:!1})}const y=v=>v.sort(()=>Math.random()-.5);y(m),y(g);const f=d?[...m,...g]:m,p=new Set;for(const{template:v,hasEligibleCitizen:b}of f){if(u.length>=h&&!d)break;if(p.has(v.id))continue;if(!(d&&u.length>=h&&b)){if(u.length>=h&&b)break}p.add(v.id);const k=Math.floor(Math.random()*v.tiers.length),w=v.tiers[k],C=(Te[v.id]||[]).map(M=>Ee[M]||M),_={id:`${v.id}_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,templateId:v.id,category:t,name:v.name,icon:v.icon,description:v.description,type:v.type,target:v.target,requirements:v.requirements||null,infrastructureEffect:v.infrastructureEffect||null,objective:{required:w.required,current:0},reward:{...w.reward},difficulty:w.difficulty,duration:t==="townBoard"?5:3,expiresDay:this.state.day+(t==="townBoard"?5:3),accepted:!1,acceptedDay:null,assignedCitizenUid:null,progress:0,poiKey:l,hasEligibleCitizen:b,requiredRoles:C};u.push(_)}if(d){const v=Math.min(3,g.length);let b=0;for(const{template:k,hasEligibleCitizen:w}of g){if(b>=v)break;if(p.has(k.id))continue;p.add(k.id),b++;const x=Math.floor(Math.random()*k.tiers.length),C=k.tiers[x],M=(Te[k.id]||[]).map(A=>Ee[A]||A),S={id:`${k.id}_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,templateId:k.id,category:t,name:k.name,icon:k.icon,description:k.description,type:k.type,target:k.target,requirements:k.requirements||null,infrastructureEffect:k.infrastructureEffect||null,objective:{required:C.required,current:0},reward:{...C.reward},difficulty:C.difficulty,duration:t==="townBoard"?5:3,expiresDay:this.state.day+(t==="townBoard"?5:3),accepted:!1,acceptedDay:null,assignedCitizenUid:null,progress:0,poiKey:l,hasEligibleCitizen:!1,requiredRoles:M};u.push(S)}}return u}getTasksByCategory(e){return this.availableTasks.filter(t=>t.category===e&&!t.accepted)}getAcceptedTasksByCategory(e){return this.acceptedTasks.filter(t=>t.category===e)}getTaskById(e){return this.acceptedTasksById.get(e)}acceptTask(e){var i,s;const t=this.availableTasks.find(a=>a.id===e);return t?this.acceptedTasks.length>=3?(this.state.addLog("Too many active tasks (max 3)","warning"),!1):(t.accepted=!0,t.acceptedDay=this.state.day,this.acceptedTasks.push(t),this.acceptedTasksById.set(e,t),this.state.addLog(`Accepted: ${t.name}`,"success"),(s=(i=this.state).notify)==null||s.call(i),!0):!1}acceptTrainingTask(e,t,i,s,a){var c,d,u,h;const r=ai(e).find(m=>m.id===t);if(!r)return this.state.addLog("Training task not found","warning"),null;const o=((c=a==null?void 0:a.getCitizenByUid)==null?void 0:c.call(a,i))||((d=a==null?void 0:a.getCitizen)==null?void 0:d.call(a,i));if(!o)return this.state.addLog("Citizen not found","warning"),null;if(o.lastTrainingDay===this.state.day)return this.state.addLog(`${o.name} has already trained today`,"warning"),null;if(o.assignment)return this.state.addLog(`${o.name} is already busy`,"warning"),null;if(r.cost>0&&this.state.player.gold<r.cost)return this.state.addLog(`Not enough gold (need ${r.cost}g)`,"warning"),null;if(this.acceptedTasks.length>=3)return this.state.addLog("Too many active tasks (max 3)","warning"),null;r.cost>0&&(this.state.player.gold-=r.cost);const l=Pi(e,r,s,this.state.day);return l?(this.acceptedTasks.push(l),this.acceptedTasksById.set(l.id,l),this.assignCitizenToTask(i,l.id),o.lastTrainingDay=this.state.day,a!=null&&a.assign&&a.assign(i,{type:"townTask",taskId:l.id}),this.state.addLog(`${o.name} started training: ${l.name}`,"success"),(h=(u=this.state).notify)==null||h.call(u),l.id):(this.state.addLog("Failed to create training task","warning"),null)}abandonTask(e){var s,a;const t=this.acceptedTasks.findIndex(n=>n.id===e);if(t===-1)return!1;const i=this.acceptedTasks[t];return i.assignedCitizenUid&&this.unassignCitizenFromTask(e),i.accepted=!1,i.objective.current=0,i.progress=0,this.acceptedTasks.splice(t,1),this.acceptedTasksById.delete(e),this.state.addLog(`Abandoned: ${i.name}`,"warning"),(a=(s=this.state).notify)==null||a.call(s),!0}getAcceptedTasks(){return this.acceptedTasks}updateTaskProgress(e,t=null,i=1){var a,n;let s=!1;for(const r of this.acceptedTasks){if(!r.accepted||r.assignedCitizenUid)continue;let o=!1;switch(r.type){case"gather":case"craft":case"use_item":e===r.type&&r.target===t&&(o=!0);break;case"kill":e==="kill"&&(Array.isArray(r.target)?o=r.target.includes(t):o=r.target===t);break;case"time":case"travel":(e==="time"||e==="travel")&&(o=!0);break;case"build":e==="build"&&r.templateId===t&&(o=!0);break}o&&(r.objective.current=Math.min(r.objective.current+i,r.objective.required),s=!0,r.objective.current>=r.objective.required&&this.completeTask(r.id))}return s&&((n=(a=this.state).notify)==null||n.call(a)),s}canCompleteBuildTask(e,t){const i=this.getTaskById(e);if(!i||i.type!=="build"||!i.requirements)return{can:!1,reason:"Invalid task"};for(const[s,a]of Object.entries(i.requirements))if(!t.has(s,a))return{can:!1,reason:`Need ${a} ${s}`};return{can:!0}}completeBuildTask(e,t){const i=this.getTaskById(e);if(!i||i.type!=="build")return!1;const s=this.canCompleteBuildTask(e,t);if(!s.can)return this.state.addLog(s.reason,"warning"),!1;for(const[a,n]of Object.entries(i.requirements))t.remove(a,n);return i.objective.current=i.objective.required,this.completeTask(e),!0}completeTask(e,t=null){var o,l,c,d,u,h,m,g,y,f,p,v,b,k,w;const i=this.acceptedTasks.findIndex(x=>x.id===e);if(i===-1)return!1;const s=this.acceptedTasks[i],a=[];if((o=s.reward)!=null&&o.gold&&(this.state.player.gold+=s.reward.gold,a.push(`+${s.reward.gold}g`)),(l=s.reward)!=null&&l.trust&&(this.state.player.attributes.trust=(this.state.player.attributes.trust||0)+s.reward.trust,a.push(`+${s.reward.trust} trust`)),(c=s.reward)!=null&&c.prestige&&(this.state.player.attributes.prestige=(this.state.player.attributes.prestige||0)+s.reward.prestige,a.push(`+${s.reward.prestige} prestige`)),(d=s.reward)!=null&&d.influence&&(this.state.player.attributes.influence=(this.state.player.attributes.influence||0)+s.reward.influence,a.push(`+${s.reward.influence} influence`)),s.infrastructureEffect&&s.poiKey){this.townInfrastructure.has(s.poiKey)||this.townInfrastructure.set(s.poiKey,new Set),this.townInfrastructure.get(s.poiKey).add(s.infrastructureEffect);const x=Ai(s.infrastructureEffect);x&&((u=this.state)!=null&&u.unlockFacility)&&this.state.unlockFacility(s.poiKey,x)}if(t&&((m=(h=this.state)==null?void 0:h.citizens)!=null&&m.awardProfessionXP)){const x=xt[s.templateId];if(x)for(const[C,_]of Object.entries(x)){const M=_*(s.difficulty||1);this.state.citizens.awardProfessionXP(t.uid,C,M)}}if(s.poiKey&&((g=this.state)!=null&&g.awardTownAttributeXP)){const x=xt[s.templateId];if(x)for(const[C,_]of Object.entries(x)){const M=_*(s.difficulty||1)*2;this.state.awardTownAttributeXP(s.poiKey,C,M)}}if(s.category==="training"&&t){if(s.citizenXp&&((f=(y=this.state)==null?void 0:y.citizens)!=null&&f.awardProfessionXP))for(const[x,C]of Object.entries(s.citizenXp))x!=="xpBonus"&&this.state.citizens.awardProfessionXP(t.uid,x,C);if(s.rewards&&s.poiKey&&((p=this.state)!=null&&p.awardTownAttributeXP))for(const[x,C]of Object.entries(s.rewards)){if(["gold","healing","potion","intel","blessing","morale","townDefense","recruitBonus"].includes(x)){x==="gold"&&(this.state.player.gold+=C,a.push(`+${C}g`));continue}this.state.awardTownAttributeXP(s.poiKey,x,C)}s.guildAffinity&&t&&!t.guildAffinity&&(t.guildAffinity=s.guildAffinity)}const n=t?t.name:"You",r=a.join(", ");if(this.state.addLog(`${n} completed: ${s.name} (${r})`,"success"),this.state.showToast){const x=t?"ðŸ‘¤":"âœ“";this.state.showToast(`Task Complete: ${s.name}!`,"success",4e3,x)}return $!=null&&$.playComplete&&$.playComplete(),this.citizenAssignedTasks.delete(e),this.availableTasks=this.availableTasks.filter(x=>x.id!==e),this.acceptedTasks.splice(i,1),this.acceptedTasksById.delete(e),this.completedToday++,t&&((b=(v=this.state)==null?void 0:v.citizens)!=null&&b.unassign?this.state.citizens.unassign(t.uid):(t.assignment=null,t.state="idle")),(w=(k=this.state).notify)==null||w.call(k),!0}canCitizenPerformTask(e,t){var o;if(!e||!t)return{can:!1,efficiency:0,reason:"Invalid citizen or task"};const i=e.skills||{},s=Tt(e.role),a=Oi[t.templateId],n=Te[t.templateId];if(n&&n.length>0&&(!s||!n.includes(s)))return{can:!1,efficiency:0,reason:`Requires: ${n.map(l=>Ee[l]||l).join(", ")}`};let r=.5;if(a){const l=i[a.primary]||0,c=i[a.secondary]||0;r+=l*.1+c*.05}if(s&&((o=Hi[s])!=null&&o.includes(t.templateId))){const l=Ni[s];l&&(r*=1+l.speedBonus)}return r+=(e.level||1)*.05,r=Math.min(r,2),{can:!0,efficiency:r}}hasEligibleCitizen(e){var i;const t=((i=this.state.citizens)==null?void 0:i.citizens)||[];if(t.length===0)return!1;for(const s of t)if(this.canCitizenPerformTask(s,e).can)return!0;return!1}getRequiredRoles(e){return(Te[e]||[]).map(i=>Ee[i]||i)}getEligibleCitizens(e){var i;return(((i=this.state.citizens)==null?void 0:i.citizens)||[]).filter(s=>s.assignment?!1:this.canCitizenPerformTask(s,e).can)}getTasksForCitizen(e,t=null){return this.acceptedTasks.filter(i=>!(t&&i.category!==t||i.assignedCitizenUid)).map(i=>{const s=this.canCitizenPerformTask(e,i);return s.can?{task:i,efficiency:s.efficiency}:null}).filter(Boolean)}assignCitizenToTask(e,t){var s;const i=this.getTaskById(t);return!i||i.assignedCitizenUid||this.citizenAssignedTasks.has(t)?!1:(this.citizenAssignedTasks.set(t,{citizenUid:e,progress:((s=i.objective)==null?void 0:s.current)||0,efficiency:1,lastRealTimeUpdate:Date.now(),accumulatedProgress:0}),i.assignedCitizenUid=e,this.state.addLog(`Assigned citizen to: ${i.name}`,"info"),!0)}unassignCitizenFromTask(e){var s,a;const t=this.getTaskById(e),i=this.citizenAssignedTasks.get(e);return i!=null&&i.citizenUid&&((a=(s=this.state)==null?void 0:s.citizens)!=null&&a.unassign)&&this.state.citizens.unassign(i.citizenUid),t&&(t.assignedCitizenUid=null),this.citizenAssignedTasks.delete(e),!0}calculateRealTimeProgress(e,t){var u,h,m,g,y,f,p,v;const i=this.citizenAssignedTasks.get(e);if(!i)return null;const s=this.getTaskById(e);if(!s)return null;const a=((u=t==null?void 0:t.getCitizenByUid)==null?void 0:u.call(t,i.citizenUid))||((h=t==null?void 0:t.getCitizen)==null?void 0:h.call(t,i.citizenUid));if(!a)return null;const n=Date.now(),r=((m=s.objective)==null?void 0:m.required)||1;if((a.energy||100)<10)return i.lastRealTimeUpdate=n,i.pausedReason="exhausted",{progress:i.progress||0,required:r,paused:!0,pausedReason:"exhausted"};if(i.pausedReason=null,!i.lastRealTimeUpdate)return i.lastRealTimeUpdate=n,i.progress=i.progress||0,{progress:i.progress,required:r};let o=(n-i.lastRealTimeUpdate)/1e3;if(o=Math.min(o,5),o<.001)return{progress:i.progress||0,required:r};i.lastRealTimeUpdate=n;const c=(i.efficiency||1)*.25,d=o*c;if(i.progress=(i.progress||0)+d,i.progress>=r){if(i.progress=r,s.type==="gather"){const b=s.poiKey||a.homeSettlement||((y=(g=this.state)==null?void 0:g.player)!=null&&y.currentPOI?`${this.state.player.currentPOI.q},${this.state.player.currentPOI.r}`:null),k=typeof s.target=="string"?s.target:null;if(k&&b&&((f=this.state)!=null&&f.addToStorage)){this.state.addToStorage(b,k,r);const w=kt[k];w&&((v=(p=this.state)==null?void 0:p.citizens)!=null&&v.awardProfessionXP)&&this.state.citizens.awardProfessionXP(a.uid,w,r)}}return s.objective.current=r,this.completeTask(e,a),null}return{progress:i.progress,required:r}}processCitizenTasks(e){var t,i,s,a,n,r,o,l,c,d,u,h;if(e)for(const[m,g]of this.citizenAssignedTasks.entries()){const y=((t=e.getCitizenByUid)==null?void 0:t.call(e,g.citizenUid))||((i=e.getCitizen)==null?void 0:i.call(e,g.citizenUid)),f=this.getTaskById(m);if(!y||!f){this.citizenAssignedTasks.delete(m);continue}if((y.energy||100)<10)continue;const p=this.canCitizenPerformTask(y,f);if(g.efficiency=p.efficiency,!(g.lastRealTimeUpdate!==void 0))if(f.type==="time"||f.type==="travel")g.progress+=g.efficiency,f.objective.current=Math.floor(g.progress);else if(f.type==="gather"||f.type==="kill"){g.progress+=g.efficiency*.25;const b=Math.floor(g.progress),k=b-f.objective.current;if(k>0){f.objective.current=b;const w=f.poiKey||y.homeSettlement||((a=(s=this.state)==null?void 0:s.player)!=null&&a.currentPOI?`${this.state.player.currentPOI.q},${this.state.player.currentPOI.r}`:null),x=typeof f.target=="string"?f.target:null;if(f.type==="gather"&&x&&w){(r=(n=this.state)==null?void 0:n.addToStorage)==null||r.call(n,w,x,k);const C=kt[x];C&&((l=(o=this.state)==null?void 0:o.citizens)!=null&&l.awardProfessionXP)&&this.state.citizens.awardProfessionXP(y.uid,C,k)}else f.type==="kill"&&w&&((d=(c=this.state)==null?void 0:c.addToStorage)==null||d.call(c,w,"monster_parts",k),(h=(u=this.state)==null?void 0:u.citizens)!=null&&h.awardProfessionXP&&this.state.citizens.awardProfessionXP(y.uid,"warriors",k*2))}}else f.type==="craft"?(g.progress+=g.efficiency*.15,f.objective.current=Math.floor(g.progress)):g.progress+=g.efficiency*.1;f.objective.required>0&&(f.progress=Math.floor(f.objective.current/f.objective.required*100)),y.energy!==void 0&&(y.energy-=3),y.experience=(y.experience||0)+1,f.objective.current>=f.objective.required&&this.completeTask(m,y)}}processTimeBasedTasks(e){for(const t of this.acceptedTasks)if(t.accepted&&!t.assignedCitizenUid&&t.type==="time"){const[i,s]=t.poiKey.split(",").map(Number);this._isPlayerNearSettlement(i,s)&&(t.objective.current=Math.min(t.objective.current+e,t.objective.required),t.objective.current>=t.objective.required&&this.completeTask(t.id))}}_isPlayerNearSettlement(e,t){var n,r;const i=(n=this.state.player.currentHex)==null?void 0:n.q,s=(r=this.state.player.currentHex)==null?void 0:r.r;return i===void 0||s===void 0?!1:(Math.abs(i-e)+Math.abs(i+s-e-t)+Math.abs(s-t))/2<=3}processDayChange(){const e=this.state.day,t=this.availableTasks.filter(s=>!s.accepted&&s.expiresDay<=e);for(const s of t)this.availableTasks=this.availableTasks.filter(a=>a.id!==s.id);const i=this.acceptedTasks.filter(s=>s.expiresDay<=e);for(const s of i)this.state.addLog(`Task expired: ${s.name}`,"warning"),s.assignedCitizenUid&&this.unassignCitizenFromTask(s.id);this.acceptedTasks=this.acceptedTasks.filter(s=>s.expiresDay>e),this.completedToday=0,this.taskGenerationDay.clear()}canAfford(e){return e.cost?e.cost.gold&&this.state.player.gold<e.cost.gold?{can:!1,reason:`Need ${e.cost.gold}g`}:{can:!0}:{can:!0}}getAvailableActions(e){var s;if(!e||e.type.category!=="settlement")return[];const t=[],i=((s=e.data)==null?void 0:s.features)||[];return t.push({id:"work",name:"Work",description:"Paid tasks for the town",available:!0}),t.push({id:"volunteer",name:"Volunteer",description:"Help the community",available:!0}),t.push({...this.menuActions.rest,available:!0}),t.push({...this.menuActions.storage,available:!0}),t.push({id:"townBoard",name:"Town Board",description:"Infrastructure projects",available:!0}),i.includes("Stables")&&t.push({...this.menuActions.stables,available:!0}),(i.includes("Shop")||i.includes("Market"))&&t.push({...this.menuActions.shop,available:!0}),t}performMenuAction(e,t){const i=this.menuActions[e];if(!i)return!1;switch(e){case"rest":return this.state.player.gold<i.cost.gold?(this.state.addLog("Not enough gold","warning"),!1):(this.state.player.gold-=i.cost.gold,this.state.player.hp=this.state.player.maxHp,this.state.player.stamina=this.state.player.maxStamina,this.gameLoop&&this.gameLoop.advanceTime(i.hourCost),this.state.addLog("Rested at the inn","success"),!0);default:return!1}}generateDeliveryJobs(e){return!e||e.type.category!=="settlement"?[]:this.availableDeliveries}getAvailableDeliveries(){return this.availableDeliveries||[]}getActiveDelivery(){return this.activeDelivery}acceptDelivery(e){var t;return this.activeDelivery?!1:(this.activeDelivery={...e,accepted:!0,startDay:((t=this.state)==null?void 0:t.day)||0},this.availableDeliveries=this.availableDeliveries.filter(i=>i.id!==e.id),!0)}abandonDelivery(){return this.activeDelivery?(this.activeDelivery=null,!0):!1}completeDelivery(){if(!this.activeDelivery)return null;const e=this.activeDelivery.reward||{gold:50};return this.activeDelivery=null,e}failDelivery(){return this.activeDelivery?(this.activeDelivery=null,!0):!1}clearActiveDelivery(){this.activeDelivery=null}get volunteerTasks(){return this.availableTasks.filter(e=>e.category==="volunteer")}get workTasks(){return this.availableTasks.filter(e=>e.category==="work")}generateVolunteerTasks(e){return this.generateTasks(e).filter(t=>t.category==="volunteer")}generateWorkTasks(e){return this.generateTasks(e).filter(t=>t.category==="work")}generateQuests(e){return[]}getCompletedToday(){return this.completedToday||0}canUseItemForTask(e,t){const i=this.getTaskById(t);return!i||i.type!=="use_item"?!1:i.target===e}useItemForTask(e,t){return this.canUseItemForTask(e,t)?(this.updateTaskProgress("use_item",e,1),!0):!1}cancelAction(){return!0}updateTimeTasks(e=1){for(const t of this.acceptedTasks)t.accepted&&t.type==="time"&&(t.objective.current=Math.min(t.objective.current+e,t.objective.required),t.objective.current>=t.objective.required&&this.completeTask(t.id))}clearExpiredTasks(){var i,s,a;const e=((i=this.state)==null?void 0:i.day)||0,t=[];for(const n of this.acceptedTasks)n.expiresDay&&e>n.expiresDay&&t.push(n.id);for(const n of t)this.abandonTask(n),(a=(s=this.state)==null?void 0:s.addLog)==null||a.call(s,"A task has expired.","warning");this.availableTasks=this.availableTasks.filter(n=>n.expiresDay?e<=n.expiresDay:!0)}checkBanditAmbush(){return!this.activeDelivery||Math.random()>.05?null:{message:"Bandits ambush you on the road!",delivery:this.activeDelivery,bandits:Math.floor(Math.random()*3)+1}}toJSON(){return{availableTasks:this.availableTasks,acceptedTasks:this.acceptedTasks,completedToday:this.completedToday,taskGenerationDay:[...this.taskGenerationDay.entries()],citizenAssignedTasks:[...this.citizenAssignedTasks.entries()],townInfrastructure:[...this.townInfrastructure.entries()].map(([e,t])=>[e,[...t]]),availableDeliveries:this.availableDeliveries,activeDelivery:this.activeDelivery,deliveryGenerationDay:[...this.deliveryGenerationDay.entries()]}}fromJSON(e){e&&(this.availableTasks=e.availableTasks||[],this.acceptedTasks=e.acceptedTasks||[],this.completedToday=e.completedToday||0,this.taskGenerationDay=new Map(e.taskGenerationDay||[]),this.citizenAssignedTasks=new Map(e.citizenAssignedTasks||[]),this.townInfrastructure=new Map((e.townInfrastructure||[]).map(([t,i])=>[t,new Set(i)])),this.availableDeliveries=e.availableDeliveries||[],this.activeDelivery=e.activeDelivery||null,this.deliveryGenerationDay=new Map(e.deliveryGenerationDay||[]))}}const _t=["Aldric","Bran","Cedric","Dorian","Edwin","Finn","Gareth","Harald","Ivar","Jasper","Klaus","Leif","Magnus","Nils","Osric","Percival","Quinn","Roland","Sven","Theron","Ulric","Viktor","Willem","Xavier","Aric","Bjorn","Corwin","Dain","Eamon","Fenris","Godric","Halvar","Ingram","Jorik","Kael","Lothar","Merric","Norvin","Orin","Paxton","Ragnar","Sigurd","Tormund","Ulfric","Valdis","Wulfgar","Yorick","Zephyr","Alara","Brynn","Celia","Daria","Elena","Freya","Greta","Hilda","Iris","Jenna","Kira","Luna","Mira","Nadia","Olga","Petra","Roslyn","Sylva","Thalia","Una","Vera","Wren","Yara","Zara","Astrid","Britta","Cordelia","Dahlia","Elara","Fiona","Gwendolyn","Helga","Ingrid","Johanna","Katla","Livia","Margot","Nessa","Odette","Primrose","Rowena","Sigrid","Tilda","Ursula","Vesper","Wynne","Ylva","Zelda"],St=["Oak","Iron","Stone","Storm","Shadow","Silver","Gold","Dark","Bright","Swift","Strong","Frost","Fire","Thunder","Wind","Black","White","Red","Grey","Dawn","Dusk","Star","Moon","Sun","Wolf","Bear","Hawk","Raven","Dragon","Lion","Stag","Boar","Ash","Thorn","Willow","Elder","Moss","Copper","Bronze","Steel","Grim","Bold","True","Keen","Wise","Wild","High","Deep"],Mt=["shield","bane","heart","forge","helm","blade","wind","vale","wood","stone","brook","well","dale","ford","ridge","cliff","born","walker","breaker","keeper","warden","strider","runner","seeker","mane","claw","fang","horn","wing","tail","pelt","eye","song","flame","frost","storm","light","shade","soul","spirit","hammer","axe","spear","arrow","bow","brand","guard","ward"],Fi=["agriculture","construction","medicine","tailoring","warriors","smithing","rangers"];function Gi(){const T=St[Math.floor(Math.random()*St.length)],e=Mt[Math.floor(Math.random()*Mt.length)];return T+e}function Wi(){const T=_t[Math.floor(Math.random()*_t.length)],e=Gi();return`${T} ${e}`}const Pe={farmer:{productivity:1,facilities:["granary","farm"]},craftsman:{productivity:1,facilities:["blacksmith","market","tannery"]},merchant:{productivity:1,facilities:["market","inn","tavern","stable"]},laborer:{productivity:.8,facilities:["lumberyard","quarry","warehouse"]},healer:{productivity:1,facilities:["clinic","herbalist"]},soldier:{productivity:1,facilities:["barracks","guardhouse","armory"]},scholar:{productivity:1,facilities:["library","archive"]},servant:{productivity:.9,facilities:["inn","tavern","bathhouse"]}};function ji(){return"npc_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}class Fe{constructor(e,t=null){this.poiKey=e,this.population=[],t===null&&(t=25+Math.floor(Math.random()*11)),this.basePopulation=t,this.stats={totalBorn:0,totalDied:0,totalFled:0,totalImmigrated:0},this.generateInitialPopulation(t)}generateInitialPopulation(e){const t=Object.keys(Pe);for(let i=0;i<e;i++){const s=t[Math.floor(Math.random()*t.length)];this.population.push(this.createNPC(s))}this.stats.totalBorn=e}generateSkills(){const e={},t=2+Math.floor(Math.random()*3),i=[...Fi].sort(()=>Math.random()-.5);for(let s=0;s<t;s++){const a=i[s],n=Math.ceil(Math.random()*Math.random()*5)||1;e[a]=n}return e}generateAge(){const e=Math.random();return e<.1?16+Math.floor(Math.random()*5):e<.7?21+Math.floor(Math.random()*25):e<.9?46+Math.floor(Math.random()*15):61+Math.floor(Math.random()*10)}createNPC(e=null){if(!e){const a=Object.keys(Pe);e=a[Math.floor(Math.random()*a.length)]}const t=Pe[e],i=this.generateAge(),s=this.generateSkills();if(i>40)for(const a of Object.keys(s))s[a]=Math.min(5,s[a]+Math.floor((i-40)/15));return{uid:ji(),name:Wi(),age:i,occupation:e,skills:s,productivity:t.productivity+(Math.random()*.2-.1),morale:80+Math.floor(Math.random()*20),assignedFacility:null,status:"active",daysStarving:0,isHireable:i>=16}}getAssignedTo(e){return this.population.filter(t=>t.assignedFacility===e&&t.status==="active")}getEmployedCount(){return this.population.filter(e=>e.assignedFacility!==null&&e.status==="active").length}getActiveCount(){return this.population.filter(e=>e.status==="active").length}getAverageMorale(){const e=this.population.filter(i=>i.status==="active");if(e.length===0)return 0;const t=e.reduce((i,s)=>i+s.morale,0);return Math.round(t/e.length)}getAverageProductivity(){const e=this.population.filter(i=>i.status==="active");return e.length===0?0:e.reduce((i,s)=>{const a=s.morale>=50?1:.5+s.morale/100;return i+s.productivity*a},0)/e.length}reduceMorale(e){this.population.forEach(t=>{t.status==="active"&&(t.morale=Math.max(0,t.morale-e))})}increaseMorale(e){this.population.forEach(t=>{t.status==="active"&&(t.morale=Math.min(100,t.morale+e))})}markStarving(){this.population.forEach(e=>{e.status==="active"&&e.daysStarving++})}resetStarvation(){this.population.forEach(e=>{e.status==="active"&&(e.daysStarving=0)})}removePopulation(e,t="fled"){const i=this.population.filter(a=>a.status==="active"),s=Math.min(e,i.length);i.sort((a,n)=>a.morale-n.morale);for(let a=0;a<s;a++){const n=i[a];n.status=t==="fled"?"fled":"dead",n.assignedFacility=null,t==="fled"?this.stats.totalFled++:this.stats.totalDied++}return s}addPopulation(e,t="immigration"){for(let i=0;i<e;i++){const s=this.createNPC();this.population.push(s),t==="birth"?this.stats.totalBorn++:this.stats.totalImmigrated++}}autoAssignWorkers(e){const t=this.population.filter(i=>i.status==="active"&&i.assignedFacility===null);for(const i of t){const s=Pe[i.occupation];if(!s)continue;const a=e.find(n=>s.facilities.includes(n.type));a&&(i.assignedFacility=a.id)}}getOccupationBreakdown(){const e={};return this.population.forEach(t=>{t.status==="active"&&(e[t.occupation]=(e[t.occupation]||0)+1)}),e}getHireableCitizens(){return this.population.filter(e=>e.status==="active"&&e.isHireable&&!e.isHired)}getCitizensBySkill(e,t=1){return this.population.filter(i=>i.status==="active"&&i.skills&&i.skills[e]>=t)}getPrimarySkill(e){if(!e.skills||Object.keys(e.skills).length===0)return null;let t=null,i=0;for(const[s,a]of Object.entries(e.skills))a>i&&(t=s,i=a);return{skill:t,level:i}}markAsHired(e){const t=this.population.find(i=>i.uid===e);return t?(t.isHired=!0,!0):!1}toJSON(){return{poiKey:this.poiKey,basePopulation:this.basePopulation,population:this.population,stats:this.stats}}static fromJSON(e){const t=new Fe(e.poiKey,0);return t.basePopulation=e.basePopulation,t.population=e.population||[],t.stats=e.stats||{totalBorn:0,totalDied:0,totalFled:0,totalImmigrated:0},t}}const Ie={agriculture:{name:"Agriculture",icon:"ðŸŒ¾",tiers:{1:[{id:"wheat_bundle",name:"Wheat Bundle",icon:"ðŸŒ¾",value:2,weight:1},{id:"vegetables",name:"Fresh Vegetables",icon:"ðŸ¥¬",value:3,weight:1},{id:"eggs",name:"Eggs",icon:"ðŸ¥š",value:2,weight:.5},{id:"milk",name:"Milk Jug",icon:"ðŸ¥›",value:3,weight:2}],3:[{id:"bread_loaf",name:"Bread Loaf",icon:"ðŸž",value:5,weight:1},{id:"cheese_wheel",name:"Cheese Wheel",icon:"ðŸ§€",value:8,weight:2},{id:"salted_meat",name:"Salted Meat",icon:"ðŸ¥“",value:7,weight:1.5},{id:"pickled_vegetables",name:"Pickled Vegetables",icon:"ðŸ¥’",value:6,weight:1}],5:[{id:"aged_cheese",name:"Aged Cheese",icon:"ðŸ§€",value:15,weight:2},{id:"honey_jar",name:"Honey Jar",icon:"ðŸ¯",value:12,weight:1},{id:"spice_blend",name:"Spice Blend",icon:"ðŸŒ¶ï¸",value:18,weight:.5},{id:"fine_wine",name:"Fine Wine",icon:"ðŸ·",value:25,weight:3}]}},construction:{name:"Construction",icon:"ðŸ”¨",tiers:{1:[{id:"wooden_planks",name:"Wooden Planks",icon:"ðŸªµ",value:3,weight:3},{id:"rope_coil",name:"Rope Coil",icon:"ðŸª¢",value:4,weight:1},{id:"clay_bricks",name:"Clay Bricks",icon:"ðŸ§±",value:5,weight:4},{id:"wooden_pegs",name:"Wooden Pegs",icon:"ðŸªµ",value:2,weight:.5}],3:[{id:"wooden_furniture",name:"Wooden Furniture",icon:"ðŸª‘",value:15,weight:8},{id:"window_frame",name:"Window Frame",icon:"ðŸªŸ",value:12,weight:5},{id:"door_frame",name:"Door Frame",icon:"ðŸšª",value:18,weight:10},{id:"stone_blocks",name:"Cut Stone Blocks",icon:"ðŸª¨",value:10,weight:6}],5:[{id:"ornate_door",name:"Ornate Door",icon:"ðŸšª",value:35,weight:12},{id:"carved_pillar",name:"Carved Pillar",icon:"ðŸ›ï¸",value:40,weight:15},{id:"stained_glass",name:"Stained Glass",icon:"ðŸªŸ",value:50,weight:4},{id:"marble_tiles",name:"Marble Tiles",icon:"â¬œ",value:45,weight:8}]}},medicine:{name:"Medicine",icon:"âš•ï¸",tiers:{1:[{id:"herb_bundle",name:"Herb Bundle",icon:"ðŸŒ¿",value:3,weight:.5},{id:"bandages",name:"Bandages",icon:"ðŸ©¹",value:4,weight:.3},{id:"healing_salve",name:"Healing Salve",icon:"ðŸ§´",value:6,weight:.5},{id:"herbal_tea",name:"Herbal Tea",icon:"ðŸµ",value:5,weight:.3}],3:[{id:"health_potion",name:"Health Potion",icon:"ðŸ§ª",value:15,weight:.5},{id:"antidote",name:"Antidote",icon:"ðŸ’Š",value:12,weight:.3},{id:"stamina_tonic",name:"Stamina Tonic",icon:"ðŸ§ª",value:14,weight:.5},{id:"fever_remedy",name:"Fever Remedy",icon:"ðŸ’Š",value:10,weight:.3}],5:[{id:"greater_health_potion",name:"Greater Health Potion",icon:"ðŸ§ª",value:35,weight:.5},{id:"cure_disease",name:"Cure Disease",icon:"âœ¨",value:40,weight:.3},{id:"regeneration_elixir",name:"Regeneration Elixir",icon:"ðŸ§ª",value:50,weight:.5},{id:"blessed_water",name:"Blessed Water",icon:"ðŸ’§",value:30,weight:1}]}},tailoring:{name:"Tailoring",icon:"ðŸ§µ",tiers:{1:[{id:"cloth_scraps",name:"Cloth Scraps",icon:"ðŸ§µ",value:2,weight:.5},{id:"leather_straps",name:"Leather Straps",icon:"ðŸª¢",value:4,weight:.5},{id:"simple_tunic",name:"Simple Tunic",icon:"ðŸ‘•",value:8,weight:1},{id:"wool_socks",name:"Wool Socks",icon:"ðŸ§¦",value:5,weight:.3}],3:[{id:"leather_vest",name:"Leather Vest",icon:"ðŸ¦º",value:18,weight:2},{id:"travel_cloak",name:"Travel Cloak",icon:"ðŸ§¥",value:20,weight:1.5},{id:"leather_boots",name:"Leather Boots",icon:"ðŸ‘¢",value:15,weight:2},{id:"belt_pouch",name:"Belt Pouch",icon:"ðŸ‘",value:12,weight:.5}],5:[{id:"silk_robe",name:"Silk Robe",icon:"ðŸ‘˜",value:45,weight:1},{id:"enchanted_cloak",name:"Enchanted Cloak",icon:"ðŸ§¥",value:60,weight:1},{id:"masterwork_armor",name:"Masterwork Leather Armor",icon:"ðŸ›¡ï¸",value:80,weight:4},{id:"noble_attire",name:"Noble Attire",icon:"ðŸ‘”",value:70,weight:2}]}},warriors:{name:"Warriors",icon:"âš”ï¸",tiers:{1:[{id:"wooden_shield",name:"Wooden Shield",icon:"ðŸ›¡ï¸",value:8,weight:4},{id:"training_sword",name:"Training Sword",icon:"ðŸ—¡ï¸",value:6,weight:2},{id:"arrow_bundle",name:"Arrow Bundle",icon:"ðŸ¹",value:5,weight:1},{id:"leather_armor_patch",name:"Armor Patch",icon:"ðŸ›¡ï¸",value:4,weight:.5}],3:[{id:"iron_shortsword",name:"Iron Shortsword",icon:"ðŸ—¡ï¸",value:25,weight:3},{id:"reinforced_shield",name:"Reinforced Shield",icon:"ðŸ›¡ï¸",value:22,weight:5},{id:"chainmail_piece",name:"Chainmail Piece",icon:"â›“ï¸",value:30,weight:4},{id:"crossbow_bolts",name:"Crossbow Bolts",icon:"ðŸ¹",value:15,weight:1}],5:[{id:"steel_longsword",name:"Steel Longsword",icon:"âš”ï¸",value:60,weight:4},{id:"tower_shield",name:"Tower Shield",icon:"ðŸ›¡ï¸",value:55,weight:8},{id:"plate_armor_piece",name:"Plate Armor Piece",icon:"ðŸ›¡ï¸",value:80,weight:6},{id:"war_banner",name:"War Banner",icon:"ðŸš©",value:40,weight:2}]}},smithing:{name:"Smithing",icon:"âš’ï¸",tiers:{1:[{id:"iron_nails",name:"Iron Nails",icon:"ðŸ”©",value:3,weight:.5},{id:"iron_ingot",name:"Iron Ingot",icon:"ðŸ”©",value:6,weight:2},{id:"horseshoes",name:"Horseshoes",icon:"ðŸ§²",value:8,weight:2},{id:"simple_tools",name:"Simple Tools",icon:"ðŸ”§",value:10,weight:2}],3:[{id:"steel_ingot",name:"Steel Ingot",icon:"â¬œ",value:18,weight:2},{id:"iron_dagger",name:"Iron Dagger",icon:"ðŸ—¡ï¸",value:20,weight:1},{id:"metal_fittings",name:"Metal Fittings",icon:"ðŸ”©",value:15,weight:1.5},{id:"iron_helm",name:"Iron Helm",icon:"â›‘ï¸",value:25,weight:3}],5:[{id:"masterwork_blade",name:"Masterwork Blade",icon:"âš”ï¸",value:70,weight:3},{id:"ornate_armor",name:"Ornate Armor",icon:"ðŸ›¡ï¸",value:90,weight:8},{id:"enchanted_metal",name:"Enchanted Metal",icon:"âœ¨",value:60,weight:2},{id:"golden_jewelry",name:"Golden Jewelry",icon:"ðŸ’",value:80,weight:.3}]}},rangers:{name:"Rangers",icon:"ðŸ¹",tiers:{1:[{id:"rabbit_pelt",name:"Rabbit Pelt",icon:"ðŸ°",value:4,weight:.5},{id:"game_meat",name:"Game Meat",icon:"ðŸ–",value:5,weight:2},{id:"feathers",name:"Feathers",icon:"ðŸª¶",value:3,weight:.2},{id:"simple_trap",name:"Simple Trap",icon:"ðŸª¤",value:6,weight:1}],3:[{id:"wolf_pelt",name:"Wolf Pelt",icon:"ðŸº",value:18,weight:2},{id:"antlers",name:"Antlers",icon:"ðŸ¦Œ",value:15,weight:1.5},{id:"hunting_bow",name:"Hunting Bow",icon:"ðŸ¹",value:25,weight:2},{id:"venison",name:"Venison",icon:"ðŸ–",value:12,weight:3}],5:[{id:"bear_pelt",name:"Bear Pelt",icon:"ðŸ»",value:45,weight:5},{id:"monster_hide",name:"Monster Hide",icon:"ðŸ¦Ž",value:60,weight:4},{id:"masterwork_bow",name:"Masterwork Bow",icon:"ðŸ¹",value:70,weight:2},{id:"beast_trophy",name:"Beast Trophy",icon:"ðŸ†",value:80,weight:3}]}}},Ui={gathering:"agriculture",farming:"agriculture",herbalism:"agriculture",woodcutting:"construction",crafting:"construction",building:"construction",combat:"warriors",patrol:"warriors",fighting:"warriors",trading:"tailoring",appraisal:"tailoring",exploration:"rangers",survival:"rangers",hunting:"rangers",tracking:"rangers",mining:"smithing",smithing:"smithing",forging:"smithing",medicine:"medicine",healing:"medicine",lore:"medicine"};function ni(T){return T>=5?5:T>=3?3:1}function Vi(T,e){const t=Ie[T];if(!t)return[];const i=[],s=ni(e);for(const[a,n]of Object.entries(t.tiers))parseInt(a)<=s&&i.push(...n);return i}function Yi(T,e){const t=Vi(T,e);if(t.length===0)return null;const i=ni(e),s=Ie[T];let a;i>1&&Math.random()<.6&&s.tiers[i]?a=s.tiers[i]:a=t;const n=a[Math.floor(Math.random()*a.length)];let r=1;return e>=4&&(r=Math.random()<.3?2:1),e>=7&&(r=Math.random()<.2?3:Math.random()<.4?2:1),{...n,quantity:r,skillId:T,skillLevel:e}}function Qi(T){const e=[];for(const t of T){const i=[];if(t.skills&&Object.keys(t.skills).length>0)for(const[n,r]of Object.entries(t.skills)){const o=Ui[n];o&&Ie[o]?i.push({professionId:o,level:r,source:"skill"}):Ie[n]&&i.push({professionId:n,level:r,source:"skill"})}if(t.professionXP){for(const[n,r]of Object.entries(t.professionXP))if(r>0&&Ie[n]){const o=Math.max(1,Math.floor(r/50)+1);i.some(c=>c.professionId===n)||i.push({professionId:n,level:o,source:"professionXP"})}}if(i.length===0)continue;i.sort((n,r)=>r.level-n.level);let s;i.length>1&&Math.random()<.3?s=i[1]:s=i[0];const a=Yi(s.professionId,s.level);a&&e.push({citizenUid:t.uid,citizenName:t.name,item:a})}return e}const It={fish:{foodValue:2,raw:!0},game_meat:{foodValue:3,raw:!0},frog_legs:{foodValue:1,raw:!0},mushrooms:{foodValue:1,raw:!0},cactus_fruit:{foodValue:2,raw:!1},exotic_fruit:{foodValue:2,raw:!1},rations:{foodValue:5,raw:!1},bread:{foodValue:3,raw:!1},cheese:{foodValue:2,raw:!1},dried_meat:{foodValue:4,raw:!1},smoked_fish:{foodValue:3,raw:!1},stew:{foodValue:6,raw:!1},ale:{foodValue:1,raw:!1},wine:{foodValue:1,raw:!1},food:{foodValue:1,raw:!1}};class Ge{constructor(e,t){this.poiKey=e,this.population=new Fe(e,t),this.lastProcessedDay=0,this.deficitDays=0,this.dailyProduction={food:0,gold:0,weapons:0,morale:0,defense:0},this.dailyConsumption={food:0},this.stats={totalDaysTracked:0,totalFoodProduced:0,totalFoodConsumed:0,totalGoldGenerated:0,totalWeaponsProduced:0,deficitDaysTotal:0,surplusDaysTotal:0},this.citizenYields=[],this.dailyCitizenYields=[]}toJSON(){return{poiKey:this.poiKey,population:this.population.toJSON(),lastProcessedDay:this.lastProcessedDay,deficitDays:this.deficitDays,dailyProduction:this.dailyProduction,dailyConsumption:this.dailyConsumption,stats:this.stats,citizenYields:this.citizenYields}}static fromJSON(e){const t=new Ge(e.poiKey,0);return t.population=Fe.fromJSON(e.population),t.lastProcessedDay=e.lastProcessedDay||0,t.deficitDays=e.deficitDays||0,t.dailyProduction=e.dailyProduction||{food:0,gold:0,weapons:0,morale:0,defense:0},t.dailyConsumption=e.dailyConsumption||{food:0},t.stats=e.stats||{totalDaysTracked:0,totalFoodProduced:0,totalFoodConsumed:0,totalGoldGenerated:0,totalWeaponsProduced:0,deficitDaysTotal:0,surplusDaysTotal:0},t.citizenYields=e.citizenYields||[],t.dailyCitizenYields=[],t}}class At{constructor(e){this.state=e,this.townEconomies=new Map}getOrCreateEconomy(e){var i;const t=e.key||`${e.q},${e.r}`;if(!this.townEconomies.has(t)){const s=((i=e.type)==null?void 0:i.size)||1,a=15+s*5,n=5+s*2,r=Math.min(40,a+Math.floor(Math.random()*n));this.townEconomies.set(t,new Ge(t,r))}return this.townEconomies.get(t)}processDailyEconomy(e,t){var a,n,r,o,l,c;const i=[],s=Array.isArray(e)?e:[...e.values()];for(const d of s){const u=typeof d.type=="string"?d.type:(a=d.type)==null?void 0:a.id;if(!u||!["hamlet","village","town","city","capital","citadel"].includes(u))continue;const h=d.key||`${d.q},${d.r}`,m=this.getOrCreateEconomy(d);if(m.lastProcessedDay>=t)continue;const g=((r=(n=this.state).getFacilities)==null?void 0:r.call(n,h))||[],y=((l=(o=this.state).getTownAttributes)==null?void 0:l.call(o,h))||{},f=this.calculateDailyProduction(d,m,g,y),p=this.calculateDailyConsumption(d,m),v=this.processHiredCitizenYields(h,d);m.dailyCitizenYields=v,v.length>0&&this.storeCitizenYields(h,v);const b=this.calculateTotalFoodInStorage(h),k=f.food-p.food,w=b+k;w<0?this.handleFoodDeficit(d,m,Math.abs(w)):(m.deficitDays>0&&(m.deficitDays=0,m.population.resetStarvation(),m.population.increaseMorale(3)),m.stats.surplusDaysTotal++),this.deliverToStorage(h,f,p),m.dailyProduction=f,m.dailyConsumption=p,m.lastProcessedDay=t,m.stats.totalDaysTracked++,m.stats.totalFoodProduced+=f.food,m.stats.totalFoodConsumed+=p.food,m.stats.totalGoldGenerated+=f.gold,m.stats.totalWeaponsProduced+=f.weapons,i.push({poiKey:h,poiName:((c=d.data)==null?void 0:c.name)||d.name||"Settlement",production:f,consumption:p,balance:k,deficitDays:m.deficitDays,population:m.population.getActiveCount()})}return i}calculateDailyProduction(e,t,i,s){var o,l,c,d,u,h;const a={food:0,gold:0,weapons:0,morale:0,defense:0},n=t.population.getAverageProductivity(),r=this.getSettlementSize(e);for(const[m,g]of Object.entries(s)){if(!g.active)continue;const y=bi(m,g.level);y.foodPerDay&&(a.food+=y.foodPerDay),y.defenseBonus&&(a.defense+=Math.floor(y.defenseBonus*10)),y.healingPerDay&&m==="medicine"&&(a.morale+=Math.floor(y.healingPerDay/10))}for(const m of i){const g=$i[m];if(!g)continue;const y=this.randomInRange(g.baseYield.min,g.baseYield.max);let f=1;switch(g.scale){case"agriculture_level":case"culinary_level":f=1+((((o=s.agriculture)==null?void 0:o.level)||1)-1)*.15;break;case"smithing_level":f=1+((((l=s.smithing)==null?void 0:l.level)||1)-1)*.15;break;case"medicine_level":f=1+((((c=s.medicine)==null?void 0:c.level)||1)-1)*.1;break;case"warriors_level":f=1+((((d=s.warriors)==null?void 0:d.level)||1)-1)*.1;break;case"tailoring_level":f=1+((((u=s.tailoring)==null?void 0:u.level)||1)-1)*.1;break;case"settlement_size":f=.5+r*.25;break}const p=Math.floor(y*f*n);g.produces==="weapons"?a.weapons+=this.calculateWeaponProduction(((h=s.smithing)==null?void 0:h.level)||1):a[g.produces]=(a[g.produces]||0)+p}return a}calculateWeaponProduction(e){let t=0;const i=Math.min(e,3),s=.3+e*.1;for(let a=0;a<i;a++)Math.random()<s&&t++;return t}calculateDailyConsumption(e,t){var d,u;const i=t.population.getActiveCount(),s=this.getSettlementSize(e),a=Math.ceil(i/10),n=.8+s*.1,l=(((u=(d=this.state).getFacilities)==null?void 0:u.call(d,t.poiKey))||[]).includes("barracks")?1.15:1;return{food:Math.ceil(a*n*l)}}handleFoodDeficit(e,t,i){var a,n,r,o,l,c,d;t.deficitDays++,t.stats.deficitDaysTotal++,t.population.markStarving();const s=((a=e.data)==null?void 0:a.name)||e.name||"Settlement";if(t.deficitDays<=2)t.population.reduceMorale(5),(r=(n=this.state).addLog)==null||r.call(n,`${s} is experiencing food shortage (Day ${t.deficitDays})`,"warning");else if(t.deficitDays<=4){t.population.reduceMorale(10);const u=Math.ceil(t.population.getActiveCount()*.02);if(u>0){const h=t.population.removePopulation(u,"fled");(l=(o=this.state).addLog)==null||l.call(o,`${h} people fled ${s} due to famine`,"danger")}}else{t.population.reduceMorale(15);const u=Math.ceil(t.population.getActiveCount()*.05);if(u>0){const h=t.population.removePopulation(u,"starved");(d=(c=this.state).addLog)==null||d.call(c,`${h} people died of starvation in ${s}`,"danger")}}}deliverToStorage(e,t,i){if(t.food>0&&this.state.addToStorage&&this.state.addToStorage(e,"food",t.food),t.gold>0&&this.state.player&&this.state.player.gold!==void 0&&(this.state.player.gold+=t.gold),t.weapons>0&&this.state.addToStorage)for(let s=0;s<t.weapons;s++)this.state.addToStorage(e,"weapon",1);i.food>0&&this.consumeFoodFromStorage(e,i.food)}consumeFoodFromStorage(e,t){if(!this.state.getStorageItems||!this.state.removeFromStorage)return 0;const i=this.state.getStorageItems(e);if(!i||i.length===0)return 0;const s=[];for(const{itemId:r,quantity:o}of i){const l=It[r];l&&o>0&&s.push({itemId:r,quantity:o,foodValue:l.foodValue,raw:l.raw,totalFoodValue:l.foodValue*o})}if(s.length===0)return 0;s.sort((r,o)=>r.raw!==o.raw?r.raw?1:-1:r.foodValue-o.foodValue);let a=0,n=t;for(const r of s){if(n<=0)break;const o=Math.ceil(n/r.foodValue),l=Math.min(o,r.quantity),c=l*r.foodValue;this.state.removeFromStorage(e,r.itemId,l),a+=c,n-=c}return a}calculateTotalFoodInStorage(e){if(!this.state.getStorageItems)return 0;const t=this.state.getStorageItems(e);if(!t)return 0;let i=0;for(const{itemId:s,quantity:a}of t){const n=It[s];n&&(i+=n.foodValue*a)}return i}importFood(e,t){var n,r,o,l,c;const s=t*3;return(((n=this.state.player)==null?void 0:n.gold)||0)<s?((o=(r=this.state).addLog)==null||o.call(r,`Not enough gold to import food (need ${s}g)`,"warning"),!1):this.state.addToStorage?(this.state.player.gold-=s,this.state.addToStorage(e,"food",t),(c=(l=this.state).addLog)==null||c.call(l,`Imported ${t} food for ${s} gold`,"success"),!0):!1}getSettlementSize(e){var s;const t=e.type||((s=e.data)==null?void 0:s.type);switch(typeof t=="string"?t:t==null?void 0:t.id){case"capital":case"citadel":return 4;case"city":return 3;case"town":return 2;case"village":case"hamlet":default:return 1}}randomInRange(e,t){return Math.floor(Math.random()*(t-e+1))+e}processHiredCitizenYields(e,t){var n,r,o;const i=this.state.citizenManager||this.state.citizens;if(!i||!i.hiredWorkers)return[];const s=i.hiredWorkers.filter(l=>l.homeSettlement===e||l.currentLocation===e);if(s.length===0)return[];const a=Qi(s);if(a.length>0){const l=((n=t.data)==null?void 0:n.name)||t.name||"Settlement",c=a.reduce((d,u)=>d+u.item.value*u.item.quantity,0);(o=(r=this.state).addLog)==null||o.call(r,`${l}: ${a.length} item(s) crafted (${c}g)`,"info")}return a}storeCitizenYields(e,t){const i=this.townEconomies.get(e);if(i){for(const s of t){const a=s.item,n=i.citizenYields.find(r=>r.id===a.id);n?n.quantity+=a.quantity:i.citizenYields.push({id:a.id,name:a.name,icon:a.icon,value:a.value,weight:a.weight,quantity:a.quantity,skillId:a.skillId})}if(this.state.addToStorage)for(const s of t){const a=s.item;this.state.addToStorage(e,a.id,a.quantity)}}}getCitizenYields(e){const t=this.townEconomies.get(e);return(t==null?void 0:t.citizenYields)||[]}sellCitizenYield(e,t,i=1){var l,c;const s=this.townEconomies.get(e);if(!s)return{success:!1,reason:"No economy data"};const a=s.citizenYields.findIndex(d=>d.id===t);if(a===-1)return{success:!1,reason:"Item not found"};const n=s.citizenYields[a],r=Math.min(i,n.quantity),o=Math.floor(n.value*r*.8);return n.quantity-=r,n.quantity<=0&&s.citizenYields.splice(a,1),this.state.player&&this.state.player.gold!==void 0&&(this.state.player.gold+=o),(c=(l=this.state).addLog)==null||c.call(l,`Sold ${r}x ${n.name} for ${o}g`,"success"),{success:!0,goldEarned:o,quantitySold:r}}getEconomyData(e){return this.townEconomies.get(e)}getEconomySummary(e,t=null){var n,r,o,l;let i=this.townEconomies.get(e);if(!i&&t){i=this.getOrCreateEconomy(t);const c=((r=(n=this.state).getFacilities)==null?void 0:r.call(n,e))||[],d=((l=(o=this.state).getTownAttributes)==null?void 0:l.call(o,e))||{};i.dailyProduction=this.calculateDailyProduction(t,i,c,d),i.dailyConsumption=this.calculateDailyConsumption(t,i)}if(!i)return null;const s=i.citizenYields.reduce((c,d)=>c+d.value*d.quantity,0),a=this.calculateTotalFoodInStorage(e);return{population:i.population.getActiveCount(),morale:i.population.getAverageMorale(),productivity:Math.round(i.population.getAverageProductivity()*100),production:i.dailyProduction,consumption:i.dailyConsumption,foodBalance:i.dailyProduction.food-i.dailyConsumption.food,deficitDays:i.deficitDays,stats:i.stats,citizenYields:i.citizenYields,citizenYieldsValue:s,dailyCitizenYields:i.dailyCitizenYields,totalFoodInStorage:a}}toJSON(){const e={};for(const[t,i]of this.townEconomies)e[t]=i.toJSON();return e}fromJSON(e){if(this.townEconomies.clear(),e)for(const[t,i]of Object.entries(e))this.townEconomies.set(t,Ge.fromJSON(i))}}const D={wood:{id:"wood",name:"Wood",category:"material",weight:2,value:3,icon:"ðŸªµ",stackable:!0},hardwood:{id:"hardwood",name:"Hardwood",category:"material",weight:3,value:8,icon:"ðŸªµ",stackable:!0},pine_wood:{id:"pine_wood",name:"Pine Wood",category:"material",weight:2,value:4,icon:"ðŸªµ",stackable:!0},stone:{id:"stone",name:"Stone",category:"material",weight:4,value:2,icon:"ðŸª¨",stackable:!0},ice_crystal:{id:"ice_crystal",name:"Ice Crystal",category:"material",weight:1,value:25,icon:"ðŸ’Ž",stackable:!0},herbs:{id:"herbs",name:"Herbs",category:"consumable",weight:.5,value:5,icon:"ðŸŒ¿",stackable:!0,description:"Medicinal herbs for healing",effect:{health:10},cures:["poison"]},wildflowers:{id:"wildflowers",name:"Wildflowers",category:"material",weight:.3,value:2,icon:"ðŸŒ¸",stackable:!0,description:"Pretty flowers for crafting"},dry_herbs:{id:"dry_herbs",name:"Dry Herbs",category:"material",weight:.3,value:4,icon:"ðŸŒ¾",stackable:!0,description:"Preserved herbs for alchemy"},mushrooms:{id:"mushrooms",name:"Mushrooms",category:"food",weight:.5,value:6,icon:"ðŸ„",stackable:!0,description:"Forest mushrooms",effect:{stamina:5},raw:!0,hungerRestore:10},swamp_moss:{id:"swamp_moss",name:"Swamp Moss",category:"consumable",weight:.5,value:4,icon:"ðŸŒ¿",stackable:!0,description:"Absorbs toxins",cures:["poison"]},lichen:{id:"lichen",name:"Lichen",category:"material",weight:.3,value:3,icon:"ðŸŒ¿",stackable:!0,description:"Grows on rocks and trees"},cactus_fruit:{id:"cactus_fruit",name:"Cactus Fruit",category:"food",weight:.5,value:7,icon:"ðŸŒµ",stackable:!0,description:"Refreshing desert fruit",effect:{stamina:15,health:5},hungerRestore:15,thirstRestore:25},shells:{id:"shells",name:"Shells",category:"material",weight:.2,value:1,icon:"ðŸš",stackable:!0,description:"Decorative seashells"},fish:{id:"fish",name:"Fish",category:"food",weight:1,value:4,icon:"ðŸŸ",stackable:!0,description:"Fresh catch",effect:{health:8,stamina:8},raw:!0,hungerRestore:20},game_meat:{id:"game_meat",name:"Game Meat",category:"food",weight:2,value:6,icon:"ðŸ–",stackable:!0,description:"Wild game from hunting",effect:{health:12,stamina:10},raw:!0,hungerRestore:30},frog_legs:{id:"frog_legs",name:"Frog Legs",category:"food",weight:.5,value:3,icon:"ðŸ¸",stackable:!0,description:"Swamp delicacy",effect:{stamina:8},raw:!0,hungerRestore:12},planks:{id:"planks",name:"Wooden Planks",category:"material",weight:3,value:10,icon:"ðŸªµ",stackable:!0},rope:{id:"rope",name:"Rope",category:"usable",weight:1,value:8,icon:"ðŸª¢",stackable:!0,description:"Use to escape from dungeons"},leather:{id:"leather",name:"Leather",category:"material",weight:1.5,value:12,icon:"ðŸŸ«",stackable:!0},cloth:{id:"cloth",name:"Cloth",category:"material",weight:.5,value:6,icon:"ðŸ§µ",stackable:!0},iron_ore:{id:"iron_ore",name:"Iron Ore",category:"material",weight:5,value:8,icon:"ðŸª¨",stackable:!0},iron_ingot:{id:"iron_ingot",name:"Iron Ingot",category:"material",weight:4,value:20,icon:"ðŸ”©",stackable:!0},copper_ore:{id:"copper_ore",name:"Copper Ore",category:"material",weight:4,value:6,icon:"ðŸª¨",stackable:!0},gold_ore:{id:"gold_ore",name:"Gold Ore",category:"material",weight:6,value:25,icon:"âœ¨",stackable:!0},silver_ore:{id:"silver_ore",name:"Silver Ore",category:"material",weight:5,value:18,icon:"ðŸª¨",stackable:!0},obsidian:{id:"obsidian",name:"Obsidian",category:"material",weight:4,value:15,icon:"ðŸ–¤",stackable:!0},sandstone:{id:"sandstone",name:"Sandstone",category:"material",weight:3,value:3,icon:"ðŸŸ«",stackable:!0},tropical_wood:{id:"tropical_wood",name:"Tropical Wood",category:"material",weight:3,value:6,icon:"ðŸªµ",stackable:!0},frozen_wood:{id:"frozen_wood",name:"Frozen Wood",category:"material",weight:3,value:5,icon:"ðŸªµ",stackable:!0},bog_wood:{id:"bog_wood",name:"Bog Wood",category:"material",weight:3,value:4,icon:"ðŸªµ",stackable:!0},exotic_fruit:{id:"exotic_fruit",name:"Exotic Fruit",category:"food",weight:.5,value:8,icon:"ðŸŒ",stackable:!0,effect:{stamina:15},hungerRestore:15,thirstRestore:20},health_potion:{id:"health_potion",name:"Health Potion",category:"consumable",weight:.5,value:15,icon:"â¤ï¸",stackable:!0,description:"Restores health instantly",effect:{health:30}},stamina_potion:{id:"stamina_potion",name:"Stamina Potion",category:"consumable",weight:.5,value:12,icon:"ðŸ’š",stackable:!0,description:"Restores energy for travel",effect:{stamina:40}},ether_potion:{id:"ether_potion",name:"Ether Potion",category:"consumable",weight:.5,value:20,icon:"ðŸ’œ",stackable:!0,description:"Restores magical ether",effect:{ether:25}},antidote:{id:"antidote",name:"Antidote",category:"consumable",weight:.3,value:18,icon:"ðŸ’Š",stackable:!0,description:"Cures poison and toxins",cures:["poison","toxic"]},cleansing_potion:{id:"cleansing_potion",name:"Cleansing Potion",category:"consumable",weight:.5,value:25,icon:"âœ¨",stackable:!0,description:"Removes dark auras",cures:["curse","corruption"]},fortifying_elixir:{id:"fortifying_elixir",name:"Fortifying Elixir",category:"consumable",weight:.5,value:35,icon:"ðŸ›¡ï¸",stackable:!0,description:"Temporary damage resistance",buffs:[{type:"defense",value:.25,duration:300}]},bread:{id:"bread",name:"Bread",category:"food",weight:.3,value:2,icon:"ðŸž",stackable:!0,description:"Simple but filling",effect:{stamina:10},hungerRestore:25},cooked_meat:{id:"cooked_meat",name:"Cooked Meat",category:"food",weight:1,value:8,icon:"ðŸ–",stackable:!0,description:"Hearty cooked meal",effect:{health:10,stamina:15},hungerRestore:50},rations:{id:"rations",name:"Travel Rations",category:"food",weight:1,value:5,icon:"ðŸŽ’",stackable:!0,description:"Preserved food for journeys",effect:{stamina:20},hungerRestore:35},cooked_fish:{id:"cooked_fish",name:"Cooked Fish",category:"food",weight:.8,value:6,icon:"ðŸŸ",stackable:!0,description:"Fresh grilled fish",effect:{health:12,stamina:10},hungerRestore:30},hearty_stew:{id:"hearty_stew",name:"Hearty Stew",category:"food",weight:1.5,value:15,icon:"ðŸ²",stackable:!0,description:"A nourishing stew",effect:{health:25,stamina:25},hungerRestore:60,thirstRestore:20},leather_strip:{id:"leather_strip",name:"Leather Strip",category:"material",weight:.2,value:4,icon:"ðŸŸ«",stackable:!0,description:"Cut leather for crafting"},iron_sword:{id:"iron_sword",name:"Iron Sword",category:"weapon",weight:3,value:45,icon:"ðŸ—¡ï¸",stackable:!1,damage:12,description:"A reliable iron blade"},iron_axe:{id:"iron_axe",name:"Iron Axe",category:"weapon",weight:4,value:50,icon:"ðŸª“",stackable:!1,damage:14,description:"A sturdy iron axe"},steel_sword:{id:"steel_sword",name:"Steel Sword",category:"weapon",weight:3.5,value:120,icon:"âš”ï¸",stackable:!1,damage:18,description:"A finely crafted steel blade"},leather_armor:{id:"leather_armor",name:"Leather Armor",category:"armor",weight:6,value:35,icon:"ðŸ¥‹",stackable:!1,defense:5,description:"Basic protection for adventurers"},chainmail:{id:"chainmail",name:"Chainmail Armor",category:"armor",weight:15,value:150,icon:"ðŸ›¡ï¸",stackable:!1,defense:12,description:"Interlocking metal rings for defense"},iron_helmet:{id:"iron_helmet",name:"Iron Helmet",category:"armor",weight:3,value:40,icon:"â›‘ï¸",stackable:!1,defense:4,description:"Protects your head in battle"},gems:{id:"gems",name:"Gems",category:"trade",weight:.2,value:50,icon:"ðŸ’Ž",stackable:!0},spices:{id:"spices",name:"Spices",category:"trade",weight:.3,value:30,icon:"ðŸ§‚",stackable:!0},silk:{id:"silk",name:"Silk",category:"trade",weight:.5,value:40,icon:"ðŸ§£",stackable:!0},delivery_package:{id:"delivery_package",name:"Delivery Package",category:"quest",weight:3,value:0,icon:"ðŸ“¦",stackable:!1,isDelivery:!0},sealed_letter:{id:"sealed_letter",name:"Sealed Letter",category:"quest",weight:.1,value:0,icon:"ðŸ“œ",stackable:!1,isDelivery:!0},merchant_goods:{id:"merchant_goods",name:"Merchant Goods",category:"quest",weight:5,value:0,icon:"ðŸŽ",stackable:!1,isDelivery:!0},pickaxe:{id:"pickaxe",name:"Pickaxe",category:"tool",weight:4,value:25,icon:"â›ï¸",stackable:!1,durability:100,bonus:{mining:1.2}},axe:{id:"axe",name:"Axe",category:"tool",weight:3,value:20,icon:"ðŸª“",stackable:!1,durability:100,bonus:{woodcutting:1.2}},fishing_rod:{id:"fishing_rod",name:"Fishing Rod",category:"tool",weight:2,value:15,icon:"ðŸŽ£",stackable:!1,durability:80,bonus:{fishing:1.3}},herbalist_pouch:{id:"herbalist_pouch",name:"Herbalist Pouch",category:"tool",weight:1,value:18,icon:"ðŸ‘",stackable:!1,durability:120,bonus:{gathering:1.25}},rat_hide:{id:"rat_hide",name:"Rat Hide",category:"material",weight:.5,value:2,icon:"ðŸ€",stackable:!0},wolf_pelt:{id:"wolf_pelt",name:"Wolf Pelt",category:"material",weight:2,value:8,icon:"ðŸº",stackable:!0},dire_wolf_pelt:{id:"dire_wolf_pelt",name:"Dire Wolf Pelt",category:"material",weight:3,value:18,icon:"ðŸº",stackable:!0},bear_hide:{id:"bear_hide",name:"Bear Hide",category:"material",weight:4,value:15,icon:"ðŸ»",stackable:!0},lion_pelt:{id:"lion_pelt",name:"Lion Pelt",category:"material",weight:3,value:20,icon:"ðŸ¦",stackable:!0},jaguar_pelt:{id:"jaguar_pelt",name:"Jaguar Pelt",category:"material",weight:2.5,value:18,icon:"ðŸ†",stackable:!0},boar_hide:{id:"boar_hide",name:"Boar Hide",category:"material",weight:2,value:6,icon:"ðŸ—",stackable:!0},croc_hide:{id:"croc_hide",name:"Crocodile Hide",category:"material",weight:3,value:12,icon:"ðŸŠ",stackable:!0},small_bones:{id:"small_bones",name:"Small Bones",category:"material",weight:.3,value:1,icon:"ðŸ¦´",stackable:!0},animal_bones:{id:"animal_bones",name:"Animal Bones",category:"material",weight:.5,value:3,icon:"ðŸ¦´",stackable:!0},large_bones:{id:"large_bones",name:"Large Bones",category:"material",weight:1,value:6,icon:"ðŸ¦´",stackable:!0},rat_teeth:{id:"rat_teeth",name:"Rat Teeth",category:"material",weight:.1,value:1,icon:"ðŸ¦·",stackable:!0},wolf_fang:{id:"wolf_fang",name:"Wolf Fang",category:"material",weight:.2,value:5,icon:"ðŸ¦·",stackable:!0},bear_claw:{id:"bear_claw",name:"Bear Claw",category:"material",weight:.3,value:8,icon:"ðŸ¾",stackable:!0},lion_claw:{id:"lion_claw",name:"Lion Claw",category:"material",weight:.3,value:10,icon:"ðŸ¾",stackable:!0},boar_tusk:{id:"boar_tusk",name:"Boar Tusk",category:"material",weight:.3,value:4,icon:"ðŸ¦·",stackable:!0},snake_fang:{id:"snake_fang",name:"Snake Fang",category:"material",weight:.1,value:3,icon:"ðŸ¦·",stackable:!0},croc_tooth:{id:"croc_tooth",name:"Crocodile Tooth",category:"material",weight:.2,value:6,icon:"ðŸ¦·",stackable:!0},rat_meat:{id:"rat_meat",name:"Rat Meat",category:"food",weight:.5,value:1,icon:"ðŸ–",stackable:!0,description:"Best cooked before eating",effect:{stamina:3},raw:!0,hungerRestore:8},raw_meat:{id:"raw_meat",name:"Raw Meat",category:"food",weight:1,value:3,icon:"ðŸ–",stackable:!0,description:"Uncooked meat",effect:{health:5},raw:!0,hungerRestore:15},quality_meat:{id:"quality_meat",name:"Quality Meat",category:"food",weight:1.5,value:8,icon:"ðŸ¥©",stackable:!0,description:"Premium cut",effect:{health:15,stamina:10},raw:!0,hungerRestore:40},boar_meat:{id:"boar_meat",name:"Boar Meat",category:"food",weight:1.5,value:5,icon:"ðŸ¥©",stackable:!0,description:"Tough but nutritious",effect:{health:10,stamina:8},raw:!0,hungerRestore:25},venom_sac:{id:"venom_sac",name:"Venom Sac",category:"material",weight:.3,value:8,icon:"ðŸ’§",stackable:!0},spider_silk:{id:"spider_silk",name:"Spider Silk",category:"material",weight:.2,value:6,icon:"ðŸ•¸ï¸",stackable:!0},slime_goo:{id:"slime_goo",name:"Slime Goo",category:"material",weight:.5,value:4,icon:"ðŸ’š",stackable:!0},toxic_goo:{id:"toxic_goo",name:"Toxic Goo",category:"material",weight:.5,value:10,icon:"ðŸ’œ",stackable:!0},scorpion_stinger:{id:"scorpion_stinger",name:"Scorpion Stinger",category:"material",weight:.2,value:7,icon:"ðŸ¦‚",stackable:!0},scorpion_chitin:{id:"scorpion_chitin",name:"Scorpion Chitin",category:"material",weight:.5,value:5,icon:"ðŸ›¡ï¸",stackable:!0},beetle_shell:{id:"beetle_shell",name:"Beetle Shell",category:"material",weight:.5,value:6,icon:"ðŸª²",stackable:!0},hornet_stinger:{id:"hornet_stinger",name:"Hornet Stinger",category:"material",weight:.1,value:4,icon:"ðŸ",stackable:!0},ember_core:{id:"ember_core",name:"Ember Core",category:"material",weight:.5,value:15,icon:"ðŸ”¥",stackable:!0},ghost_essence:{id:"ghost_essence",name:"Ghost Essence",category:"material",weight:.1,value:20,icon:"ðŸ‘»",stackable:!0},imp_horn:{id:"imp_horn",name:"Imp Horn",category:"material",weight:.2,value:8,icon:"ðŸ˜ˆ",stackable:!0},goblin_ear:{id:"goblin_ear",name:"Goblin Ear",category:"material",weight:.1,value:3,icon:"ðŸ‘‚",stackable:!0},whisker:{id:"whisker",name:"Mystic Whisker",category:"material",weight:.1,value:12,icon:"ã€°ï¸",stackable:!0},cockatrice_feather:{id:"cockatrice_feather",name:"Cockatrice Feather",category:"material",weight:.2,value:14,icon:"ðŸª¶",stackable:!0},troll_blood:{id:"troll_blood",name:"Troll Blood",category:"material",weight:.5,value:25,icon:"ðŸ©¸",stackable:!0},gargoyle_dust:{id:"gargoyle_dust",name:"Gargoyle Dust",category:"material",weight:.3,value:22,icon:"âœ¨",stackable:!0},yeti_fur:{id:"yeti_fur",name:"Yeti Fur",category:"material",weight:3,value:30,icon:"ðŸ¦",stackable:!0},mandragora_root:{id:"mandragora_root",name:"Mandragora Root",category:"material",weight:.5,value:10,icon:"ðŸ¥¬",stackable:!0},living_bark:{id:"living_bark",name:"Living Bark",category:"material",weight:1,value:12,icon:"ðŸŒ³",stackable:!0},cactus_needle:{id:"cactus_needle",name:"Cactus Needle",category:"material",weight:.1,value:8,icon:"ðŸŒµ",stackable:!0},fish_scales:{id:"fish_scales",name:"Fish Scales",category:"material",weight:.2,value:4,icon:"ðŸŸ",stackable:!0},gillkin_scale:{id:"gillkin_scale",name:"Gillkin Scale",category:"material",weight:.3,value:8,icon:"ðŸ¸",stackable:!0},bone_dust:{id:"bone_dust",name:"Bone Dust",category:"material",weight:.2,value:5,icon:"ðŸ’€",stackable:!0},rotting_flesh:{id:"rotting_flesh",name:"Rotting Flesh",category:"material",weight:.5,value:2,icon:"ðŸ§Ÿ",stackable:!0},coal:{id:"coal",name:"Coal",category:"material",weight:2,value:3,icon:"â¬›",stackable:!0},crystal_shard:{id:"crystal_shard",name:"Crystal Shard",category:"material",weight:.3,value:8,icon:"ðŸ’Ž",stackable:!0},amethyst:{id:"amethyst",name:"Amethyst",category:"material",weight:.3,value:25,icon:"ðŸ’œ",stackable:!0},bat_wing:{id:"bat_wing",name:"Bat Wing",category:"material",weight:.2,value:10,icon:"ðŸ¦‡",stackable:!0},gold_nugget:{id:"gold_nugget",name:"Gold Nugget",category:"material",weight:.5,value:50,icon:"âœ¨",stackable:!0},ruby:{id:"ruby",name:"Ruby",category:"material",weight:.3,value:80,icon:"â¤ï¸",stackable:!0},cave_pearl:{id:"cave_pearl",name:"Cave Pearl",category:"material",weight:.2,value:100,icon:"ðŸ¤",stackable:!0},gold_dust:{id:"gold_dust",name:"Gold Dust",category:"material",weight:.3,value:30,icon:"âœ¨",stackable:!0},mithril_ore:{id:"mithril_ore",name:"Mithril Ore",category:"material",weight:3,value:120,icon:"ðŸª¨",stackable:!0},diamond:{id:"diamond",name:"Diamond",category:"material",weight:.2,value:150,icon:"ðŸ’Ž",stackable:!0},ancient_coin:{id:"ancient_coin",name:"Ancient Coin",category:"material",weight:.1,value:10,icon:"ðŸª™",stackable:!0},pottery_shard:{id:"pottery_shard",name:"Pottery Shard",category:"material",weight:.5,value:5,icon:"ðŸº",stackable:!0},old_scroll:{id:"old_scroll",name:"Old Scroll",category:"material",weight:.2,value:15,icon:"ðŸ“œ",stackable:!0},artifact_fragment:{id:"artifact_fragment",name:"Artifact Fragment",category:"material",weight:.5,value:40,icon:"ðŸ—¿",stackable:!0},enchanted_stone:{id:"enchanted_stone",name:"Enchanted Stone",category:"material",weight:.5,value:50,icon:"ðŸ”®",stackable:!0},rune_tablet:{id:"rune_tablet",name:"Rune Tablet",category:"material",weight:1,value:60,icon:"ðŸ“‹",stackable:!0},ancient_tome:{id:"ancient_tome",name:"Ancient Tome",category:"material",weight:2,value:200,icon:"ðŸ“•",stackable:!0},crown_shard:{id:"crown_shard",name:"Crown Shard",category:"material",weight:.3,value:250,icon:"ðŸ‘‘",stackable:!0},cursed_idol:{id:"cursed_idol",name:"Cursed Idol",category:"material",weight:1,value:55,icon:"ðŸ—¿",stackable:!0},forbidden_tome:{id:"forbidden_tome",name:"Forbidden Tome",category:"material",weight:2,value:350,icon:"ðŸ““",stackable:!0},incense:{id:"incense",name:"Incense",category:"material",weight:.2,value:5,icon:"ðŸ•¯ï¸",stackable:!0},candle:{id:"candle",name:"Blessed Candle",category:"material",weight:.3,value:8,icon:"ðŸ•¯ï¸",stackable:!0},blessed_water:{id:"blessed_water",name:"Blessed Water",category:"quest",weight:.5,value:50,icon:"ðŸ’§",stackable:!0},blessing_scroll:{id:"blessing_scroll",name:"Blessing Scroll",category:"quest",weight:.2,value:35,icon:"ðŸ“œ",stackable:!0},spirit_essence:{id:"spirit_essence",name:"Spirit Essence",category:"quest",weight:.2,value:45,icon:"ðŸ‘»",stackable:!0},purifying_crystal:{id:"purifying_crystal",name:"Purifying Crystal",category:"quest",weight:.5,value:180,icon:"ðŸ’Ž",stackable:!0},sacred_chalice:{id:"sacred_chalice",name:"Sacred Chalice",category:"quest",weight:1.5,value:200,icon:"ðŸ†",stackable:!1},holy_relic:{id:"holy_relic",name:"Holy Relic",category:"quest",weight:1,value:250,icon:"âœï¸",stackable:!1},celestial_tear:{id:"celestial_tear",name:"Celestial Tear",category:"quest",weight:.1,value:250,icon:"ðŸ’§",stackable:!0},leather_scraps:{id:"leather_scraps",name:"Leather Scraps",category:"material",weight:.5,value:8,icon:"ðŸŸ«",stackable:!0},steel_ingot:{id:"steel_ingot",name:"Steel Ingot",category:"material",weight:4,value:40,icon:"ðŸ”©",stackable:!0},battle_standard:{id:"battle_standard",name:"Battle Standard",category:"material",weight:2,value:50,icon:"ðŸš©",stackable:!0},war_medal:{id:"war_medal",name:"War Medal",category:"material",weight:.2,value:35,icon:"ðŸŽ–ï¸",stackable:!0},legendary_weapon:{id:"legendary_weapon",name:"Legendary Weapon",category:"equipment",weight:5,value:400,icon:"âš”ï¸",stackable:!1},royal_armor:{id:"royal_armor",name:"Royal Armor",category:"equipment",weight:8,value:350,icon:"ðŸ›¡ï¸",stackable:!1},war_chest:{id:"war_chest",name:"War Chest",category:"material",weight:10,value:500,icon:"ðŸ“¦",stackable:!1},old_pickaxe:{id:"old_pickaxe",name:"Old Pickaxe",category:"tool",weight:3,value:20,icon:"â›ï¸",stackable:!1,durability:50},beast_heart:{id:"beast_heart",name:"Beast Heart",category:"viscera",weight:.5,value:12,icon:"â¤ï¸",stackable:!0},beast_blood:{id:"beast_blood",name:"Beast Blood",category:"viscera",weight:.3,value:5,icon:"ðŸ©¸",stackable:!0},entrails:{id:"entrails",name:"Entrails",category:"viscera",weight:.6,value:4,icon:"ðŸ«€",stackable:!0},organ_meat:{id:"organ_meat",name:"Organ Meat",category:"viscera",weight:.4,value:3,icon:"ðŸ«",stackable:!0},severed_tongue:{id:"severed_tongue",name:"Severed Tongue",category:"viscera",weight:.2,value:6,icon:"ðŸ‘…",stackable:!0},eyeball:{id:"eyeball",name:"Eyeball",category:"viscera",weight:.1,value:8,icon:"ðŸ‘ï¸",stackable:!0},brain_matter:{id:"brain_matter",name:"Brain Matter",category:"viscera",weight:.4,value:15,icon:"ðŸ§ ",stackable:!0},skull:{id:"skull",name:"Skull",category:"viscera",weight:.8,value:10,icon:"ðŸ’€",stackable:!0},sinew:{id:"sinew",name:"Sinew",category:"viscera",weight:.2,value:4,icon:"ðŸ§µ",stackable:!0},rendered_fat:{id:"rendered_fat",name:"Rendered Fat",category:"viscera",weight:.4,value:3,icon:"ðŸ« ",stackable:!0},human_heart:{id:"human_heart",name:"Human Heart",category:"cult_material",weight:.5,value:100,icon:"â¤ï¸",stackable:!0,illegal:!0},human_blood:{id:"human_blood",name:"Human Blood",category:"cult_material",weight:.3,value:25,icon:"ðŸ©¸",stackable:!0,illegal:!0},soul_fragment:{id:"soul_fragment",name:"Soul Fragment",category:"cult_material",weight:.1,value:200,icon:"âœ¨",stackable:!0,illegal:!0},bone_powder:{id:"bone_powder",name:"Bone Powder",category:"cult_material",weight:.2,value:15,icon:"ðŸ’€",stackable:!0,illegal:!0},flesh_sample:{id:"flesh_sample",name:"Flesh Sample",category:"cult_material",weight:.4,value:20,icon:"ðŸ¥©",stackable:!0,illegal:!0},eye_of_victim:{id:"eye_of_victim",name:"Eye of Victim",category:"cult_material",weight:.1,value:40,icon:"ðŸ‘ï¸",stackable:!0,illegal:!0},corrupted_essence:{id:"corrupted_essence",name:"Corrupted Essence",category:"cult_material",weight:.1,value:150,icon:"ðŸ’œ",stackable:!0,illegal:!0},sacrificial_blood:{id:"sacrificial_blood",name:"Sacrificial Blood",category:"cult_material",weight:.5,value:80,icon:"ðŸ©¸",stackable:!0,illegal:!0},sacred_chalice:{id:"sacred_chalice",name:"Sacred Chalice",category:"sacred",weight:1,value:200,icon:"ðŸ†",stackable:!1,description:"A holy vessel used in purification rituals.",cleansePower:3},blessed_tome:{id:"blessed_tome",name:"Blessed Tome",category:"sacred",weight:2,value:150,icon:"ðŸ“–",stackable:!1,description:"Ancient scriptures of protection against dark forces.",cleansePower:2},holy_relic:{id:"holy_relic",name:"Holy Relic",category:"sacred",weight:.5,value:250,icon:"âœï¸",stackable:!1,description:"A fragment of a saint, radiating divine power.",cleansePower:4},purifying_crystal:{id:"purifying_crystal",name:"Purifying Crystal",category:"sacred",weight:.5,value:180,icon:"ðŸ’Ž",stackable:!1,description:"A crystal charged with cleansing energy. Can dispel corruption.",cleansePower:3,canDispelAura:!0},ancestral_seal:{id:"ancestral_seal",name:"Ancestral Seal",category:"sacred",weight:.3,value:220,icon:"ðŸ”±",stackable:!1,description:"An ancient seal that wards against void energies.",cleansePower:3,voidResistance:!0},blessed_water:{id:"blessed_water",name:"Blessed Water",category:"sacred",weight:.5,value:50,icon:"ðŸ’§",stackable:!0,description:"Holy water that burns the corrupt.",cleansePower:1,effect:{cureCondition:!0}},sanctified_oil:{id:"sanctified_oil",name:"Sanctified Oil",category:"sacred",weight:.3,value:75,icon:"ðŸ«—",stackable:!0,description:"Oil blessed by priests, used to anoint weapons.",cleansePower:1,weaponBonus:{vsDark:1.5}},silver_talisman:{id:"silver_talisman",name:"Silver Talisman",category:"sacred",weight:.2,value:120,icon:"ðŸª¬",stackable:!1,description:"Protects the wearer from corruption.",corruptionResistance:.5},rusty_sword:{id:"rusty_sword",name:"Rusty Sword",category:"weapon",weight:3,value:10,icon:"ðŸ—¡ï¸",stackable:!1},worn_dagger:{id:"worn_dagger",name:"Worn Dagger",category:"weapon",weight:1,value:8,icon:"ðŸ”ª",stackable:!1},crude_axe:{id:"crude_axe",name:"Crude Axe",category:"weapon",weight:4,value:12,icon:"ðŸª“",stackable:!1},bandit_bow:{id:"bandit_bow",name:"Bandit Bow",category:"weapon",weight:2,value:15,icon:"ðŸ¹",stackable:!1},leather_armor:{id:"leather_armor",name:"Leather Armor",category:"armor",weight:5,value:20,icon:"ðŸ¥‹",stackable:!1},iron_helm:{id:"iron_helm",name:"Iron Helm",category:"armor",weight:3,value:15,icon:"â›‘ï¸",stackable:!1},dark_plate:{id:"dark_plate",name:"Dark Plate",category:"armor",weight:10,value:50,icon:"ðŸ–¤",stackable:!1},gold_pouch:{id:"gold_pouch",name:"Gold Pouch",category:"valuable",weight:.5,value:25,icon:"ðŸ‘›",stackable:!1},silver_ring:{id:"silver_ring",name:"Silver Ring",category:"valuable",weight:.1,value:15,icon:"ðŸ’",stackable:!1},stolen_goods:{id:"stolen_goods",name:"Stolen Goods",category:"trade",weight:2,value:12,icon:"ðŸ“¦",stackable:!0},treasure_map:{id:"treasure_map",name:"Treasure Map",category:"valuable",weight:.1,value:30,icon:"ðŸ—ºï¸",stackable:!1},lockpick:{id:"lockpick",name:"Lockpick",category:"tool",weight:.1,value:5,icon:"ðŸ”§",stackable:!0},healing_herb:{id:"healing_herb",name:"Healing Herb",category:"consumable",weight:.2,value:6,icon:"ðŸŒ¿",stackable:!0,effect:{health:15}},antidote:{id:"antidote",name:"Antidote",category:"consumable",weight:.3,value:10,icon:"ðŸ§ª",stackable:!0},torch:{id:"torch",name:"Torch",category:"equipment",slot:"offhand",weight:1,value:5,icon:"ðŸ”¦",stackable:!0,lightRadius:4,burnDuration:60},tent:{id:"tent",name:"Tent",category:"usable",weight:4,value:25,icon:"â›º",stackable:!1,restBonus:1.5},waterskin:{id:"waterskin",name:"Waterskin",category:"consumable",weight:1,value:8,icon:"ðŸ’§",stackable:!0,effect:{stamina:10},thirstRestore:50,description:"Fresh water for the road"},bandage:{id:"bandage",name:"Bandage",category:"consumable",weight:.2,value:6,icon:"ðŸ©¹",stackable:!0,effect:{health:20}},mana_crystal:{id:"mana_crystal",name:"Mana Crystal",category:"consumable",weight:.3,value:20,icon:"ðŸ”®",stackable:!0,effect:{ether:30}},holy_water:{id:"holy_water",name:"Holy Water",category:"consumable",weight:.5,value:15,icon:"âœï¸",stackable:!0,effect:{health:15,ether:10}},throwing_knife:{id:"throwing_knife",name:"Throwing Knife",category:"weapon",weight:.3,value:8,icon:"ðŸ—¡ï¸",stackable:!0},iron_sword:{id:"iron_sword",name:"Iron Sword",category:"weapon",weight:4,value:80,icon:"ðŸ—¡ï¸",stackable:!1},iron_dagger:{id:"iron_dagger",name:"Iron Dagger",category:"weapon",weight:1.5,value:35,icon:"ðŸ”ª",stackable:!1},iron_axe:{id:"iron_axe",name:"Iron Axe",category:"weapon",weight:5,value:60,icon:"ðŸª“",stackable:!1},chainmail:{id:"chainmail",name:"Chainmail Armor",category:"armor",weight:12,value:150,icon:"ðŸ›¡ï¸",stackable:!1},iron_shield:{id:"iron_shield",name:"Iron Shield",category:"armor",weight:6,value:70,icon:"ðŸ›¡ï¸",stackable:!1},repair_kit:{id:"repair_kit",name:"Repair Kit",category:"tool",weight:1,value:20,icon:"ðŸ”§",stackable:!0},poison_vial:{id:"poison_vial",name:"Poison Vial",category:"consumable",weight:.3,value:30,icon:"â˜ ï¸",stackable:!0},rare_herb:{id:"rare_herb",name:"Rare Herb",category:"material",weight:.2,value:45,icon:"ðŸŒ¿",stackable:!0},dried_meat:{id:"dried_meat",name:"Dried Meat",category:"food",weight:.5,value:8,icon:"ðŸ¥“",stackable:!0,effect:{stamina:12}},cheese:{id:"cheese",name:"Aged Cheese",category:"food",weight:.4,value:5,icon:"ðŸ§€",stackable:!0,effect:{stamina:8}},wine:{id:"wine",name:"Wine Bottle",category:"consumable",weight:1,value:12,icon:"ðŸ·",stackable:!0,effect:{health:5}},ale:{id:"ale",name:"Ale Keg",category:"consumable",weight:2,value:8,icon:"ðŸº",stackable:!0,effect:{stamina:10}},cooking_pot:{id:"cooking_pot",name:"Cooking Pot",category:"tool",weight:3,value:15,icon:"ðŸ²",stackable:!1},salt:{id:"salt",name:"Salt Pouch",category:"material",weight:.2,value:4,icon:"ðŸ§‚",stackable:!0},deer_hide:{id:"deer_hide",name:"Deer Hide",category:"material",weight:2,value:18,icon:"ðŸ¦Œ",stackable:!0},bear_pelt:{id:"bear_pelt",name:"Bear Pelt",category:"material",weight:4,value:60,icon:"ðŸ»",stackable:!0},arrows:{id:"arrows",name:"Arrow Bundle",category:"weapon",weight:.5,value:12,icon:"ðŸ¹",stackable:!0},hunting_bow:{id:"hunting_bow",name:"Hunting Bow",category:"weapon",weight:2,value:45,icon:"ðŸ¹",stackable:!1},trap:{id:"trap",name:"Animal Trap",category:"tool",weight:2,value:20,icon:"ðŸª¤",stackable:!0},bait:{id:"bait",name:"Hunting Bait",category:"material",weight:.2,value:5,icon:"ðŸª±",stackable:!0},gold_ring:{id:"gold_ring",name:"Gold Ring",category:"valuable",weight:.1,value:80,icon:"ðŸ’",stackable:!1},silver_necklace:{id:"silver_necklace",name:"Silver Necklace",category:"valuable",weight:.2,value:55,icon:"ðŸ“¿",stackable:!1},ruby:{id:"ruby",name:"Polished Ruby",category:"valuable",weight:.1,value:120,icon:"â¤ï¸",stackable:!0},emerald:{id:"emerald",name:"Cut Emerald",category:"valuable",weight:.1,value:100,icon:"ðŸ’š",stackable:!0},sapphire:{id:"sapphire",name:"Blue Sapphire",category:"valuable",weight:.1,value:90,icon:"ðŸ’™",stackable:!0},pearl:{id:"pearl",name:"River Pearl",category:"valuable",weight:.1,value:40,icon:"âšª",stackable:!0},amulet:{id:"amulet",name:"Enchanted Amulet",category:"valuable",weight:.2,value:150,icon:"ðŸ”®",stackable:!1},lantern:{id:"lantern",name:"Lantern",category:"equipment",weight:1,value:18,icon:"ðŸ®",stackable:!1,lightRadius:5},backpack:{id:"backpack",name:"Traveler's Pack",category:"equipment",weight:1,value:30,icon:"ðŸŽ’",stackable:!1},greater_health_potion:{id:"greater_health_potion",name:"Greater Health Potion",category:"consumable",weight:.5,value:45,icon:"â¤ï¸",stackable:!0,effect:{health:60}},healing_salve:{id:"healing_salve",name:"Healing Salve",category:"consumable",weight:.3,value:28,icon:"ðŸ©¹",stackable:!0,effect:{health:25}},cure_disease:{id:"cure_disease",name:"Cure Disease",category:"consumable",weight:.3,value:35,icon:"ðŸ’Š",stackable:!0},smelling_salts:{id:"smelling_salts",name:"Smelling Salts",category:"consumable",weight:.2,value:10,icon:"âœ¨",stackable:!0,effect:{stamina:20}},mystery_box:{id:"mystery_box",name:"Mystery Box",category:"valuable",weight:1,value:50,icon:"ðŸ“¦",stackable:!1},strange_map:{id:"strange_map",name:"Strange Map",category:"valuable",weight:.1,value:40,icon:"ðŸ—ºï¸",stackable:!1},lucky_charm:{id:"lucky_charm",name:"Lucky Charm",category:"valuable",weight:.1,value:35,icon:"ðŸ€",stackable:!1},cursed_coin:{id:"cursed_coin",name:"Cursed Coin",category:"valuable",weight:.1,value:25,icon:"ðŸª™",stackable:!0},shadow_cloak:{id:"shadow_cloak",name:"Shadow Cloak",category:"armor",weight:2,value:120,icon:"ðŸ§¥",stackable:!1},ancient_key:{id:"ancient_key",name:"Ancient Key",category:"valuable",weight:.2,value:75,icon:"ðŸ—ï¸",stackable:!1},void_crystal:{id:"void_crystal",name:"Void Crystal",category:"material",weight:.3,value:200,icon:"ðŸ”®",stackable:!0},sunstone:{id:"sunstone",name:"Sunstone of Purity",category:"relic",weight:1,value:0,icon:"â˜€ï¸",stackable:!1,description:"A radiant crystal that burns away the darkness of the Void. Use to cleanse Void Rift corruption.",cleansesAura:"void_rift",cleanseRadius:4,canDrop:!1,canSell:!1},lifeblood_chalice:{id:"lifeblood_chalice",name:"Chalice of Lifeblood",category:"relic",weight:1.5,value:0,icon:"ðŸ†",stackable:!1,description:"An ancient chalice that purifies blood corruption. Use to cleanse Blood Altar zones.",cleansesAura:"blood_altar",cleanseRadius:3,canDrop:!1,canSell:!1},mindshield_crystal:{id:"mindshield_crystal",name:"Crystal of Clear Mind",category:"relic",weight:.5,value:0,icon:"ðŸ”·",stackable:!1,description:"A crystal that shields against whispered corruption. Use to cleanse Dark Shrine zones.",cleansesAura:"cult_shrine",cleanseRadius:4,canDrop:!1,canSell:!1},fleshbane_totem:{id:"fleshbane_totem",name:"Totem of Natural Form",category:"relic",weight:2,value:0,icon:"ðŸ—¿",stackable:!1,description:"A totem that restores natural order. Use to cleanse Flesh Pit corruption.",cleansesAura:"flesh_pit",cleanseRadius:3,canDrop:!1,canSell:!1},purifying_flame:{id:"purifying_flame",name:"Eternal Purifying Flame",category:"relic",weight:.5,value:0,icon:"ðŸ”¥",stackable:!1,description:"A flame that never dies. Can cleanse any cult site but with reduced radius.",cleansesAura:"any",cleanseRadius:2,canDrop:!1,canSell:!1}},$t={warrior:[{itemId:"rations",quantity:3},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:2},{itemId:"tent",quantity:1},{itemId:"bandage",quantity:2}],paladin:[{itemId:"rations",quantity:2},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:2},{itemId:"tent",quantity:1},{itemId:"holy_water",quantity:2}],mage:[{itemId:"rations",quantity:2},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:3},{itemId:"tent",quantity:1},{itemId:"mana_crystal",quantity:1}],rogue:[{itemId:"rations",quantity:2},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:2},{itemId:"tent",quantity:1},{itemId:"lockpick",quantity:3}],ranger:[{itemId:"rations",quantity:4},{itemId:"waterskin",quantity:2},{itemId:"torch",quantity:2},{itemId:"tent",quantity:1},{itemId:"rope",quantity:1}],cleric:[{itemId:"rations",quantity:2},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:2},{itemId:"tent",quantity:1},{itemId:"holy_water",quantity:2}],druid:[{itemId:"rations",quantity:3},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:1},{itemId:"tent",quantity:1},{itemId:"herbs",quantity:5}],scout:[{itemId:"rations",quantity:4},{itemId:"waterskin",quantity:2},{itemId:"torch",quantity:3},{itemId:"tent",quantity:1},{itemId:"rope",quantity:1}],mercenary:[{itemId:"rations",quantity:3},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:2},{itemId:"tent",quantity:1},{itemId:"bandage",quantity:3}],merchant:[{itemId:"rations",quantity:2},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:2},{itemId:"tent",quantity:1},{itemId:"health_potion",quantity:2}],artisan:[{itemId:"rations",quantity:2},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:2},{itemId:"tent",quantity:1},{itemId:"rope",quantity:2}],scholar:[{itemId:"rations",quantity:2},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:4},{itemId:"tent",quantity:1},{itemId:"mana_crystal",quantity:1}],mechanist:[{itemId:"rations",quantity:2},{itemId:"waterskin",quantity:1},{itemId:"torch",quantity:3},{itemId:"tent",quantity:1},{itemId:"lockpick",quantity:2}]},We={Wood:"wood",Hardwood:"hardwood","Pine Wood":"pine_wood","Tropical Wood":"tropical_wood","Frozen Wood":"frozen_wood","Bog Wood":"bog_wood",Stone:"stone","Iron Ore":"iron_ore","Copper Ore":"copper_ore","Gold Ore":"gold_ore","Silver Ore":"silver_ore",Obsidian:"obsidian",Sandstone:"sandstone","Ice Crystal":"ice_crystal",Herbs:"herbs",Wildflowers:"wildflowers","Dry Herbs":"dry_herbs",Mushrooms:"mushrooms","Swamp Moss":"swamp_moss",Lichen:"lichen","Cactus Fruit":"cactus_fruit","Exotic Fruit":"exotic_fruit",Shells:"shells",Fish:"fish","Game Meat":"game_meat","Frog Legs":"frog_legs"};class Et{constructor(e){this.state=e,this.items=new Map,this.uidCounter=0}get maxWeight(){return 30+this.state.player.attributes.stamina*5}get currentWeight(){let e=0;for(const[t,i]of this.items){const s=D[t];s&&(s.stackable?e+=s.weight*i:e+=s.weight*i.length)}return Math.round(e*10)/10}get remainingCapacity(){return Math.round((this.maxWeight-this.currentWeight)*10)/10}canAdd(e,t=1){const i=D[e];if(!i)return{can:!1,reason:"Unknown item"};const s=i.weight*t;return this.currentWeight+s>this.maxWeight?{can:!1,reason:"Inventory full (over weight limit)"}:{can:!0}}add(e,t=1,i={}){const s=D[e];if(!s)return console.warn(`Unknown item: ${e}`),!1;const a=this.canAdd(e,t);if(!a.can)return this.state.addLog(a.reason,"warning"),!1;if(s.stackable){const n=this.items.get(e)||0;this.items.set(e,n+t)}else{const n=this.items.get(e)||[];for(let r=0;r<t;r++)n.push({uid:++this.uidCounter,durability:s.durability||100,...i});this.items.set(e,n)}return!0}remove(e,t=1){const i=D[e];if(!i)return!1;if(i.stackable){const s=this.items.get(e)||0;if(s<t)return!1;const a=s-t;a<=0?this.items.delete(e):this.items.set(e,a)}else{const s=this.items.get(e)||[];if(s.length<t)return!1;s.splice(-t,t),s.length===0&&this.items.delete(e)}return!0}getQuantity(e){const t=D[e];return t?t.stackable?this.items.get(e)||0:(this.items.get(e)||[]).length:0}has(e,t=1){return this.getQuantity(e)>=t}useConsumable(e){const t=D[e];return!t||t.category!=="consumable"&&t.category!=="food"?!1:this.has(e)?(t.effect&&(t.effect.health&&(this.state.player.health=Math.min(this.state.player.maxHealth,this.state.player.health+t.effect.health)),t.effect.stamina&&(this.state.player.stamina=Math.min(this.state.player.maxStamina,this.state.player.stamina+t.effect.stamina)),t.effect.ether&&(this.state.player.ether=Math.min(this.state.player.maxEther,this.state.player.ether+t.effect.ether))),t.hungerRestore&&typeof this.state.restoreHunger=="function"&&this.state.restoreHunger(t.hungerRestore),t.thirstRestore&&typeof this.state.restoreThirst=="function"&&this.state.restoreThirst(t.thirstRestore),this.remove(e,1),this.state.addLog(`Used ${t.name}`,"success"),this.state.notify(),!0):(this.state.addLog(`No ${t.name} in inventory`,"warning"),!1)}getAllItems(){const e=[];for(const[i,s]of this.items){const a=D[i];if(a)if(a.stackable)e.push({...a,quantity:s,totalWeight:Math.round(a.weight*s*10)/10});else for(const n of s)e.push({...a,quantity:1,totalWeight:a.weight,instance:n})}const t=["tool","consumable","food","material","trade"];return e.sort((i,s)=>{const a=t.indexOf(i.category),n=t.indexOf(s.category);return a!==n?a-n:i.name.localeCompare(s.name)}),e}getTotalValue(){let e=0;for(const[t,i]of this.items){const s=D[t];s&&(s.stackable?e+=s.value*i:e+=s.value*i.length)}return e}sell(e,t=1,i=.5){const s=D[e];if(!s)return!1;if(!this.has(e,t))return this.state.addLog(`Not enough ${s.name}`,"warning"),!1;const a=Math.floor(s.value*t*i);return this.remove(e,t),this.state.player.gold+=a,this.state.addLog(`Sold ${t}x ${s.name} for ${a}g`,"success"),this.state.notify(),!0}craft(e){var a,n;if(!e||!e.ingredients||!e.result)return this.state.addLog("Invalid recipe","error"),!1;if(this.state.knownRecipes&&!this.state.hasRecipe(e.id))return this.state.addLog(`You don't know how to craft ${e.name}`,"warning"),!1;if((((a=this.state.player.skills)==null?void 0:a.crafting)||0)<e.skillRequired)return this.state.addLog(`Crafting skill too low (need ${e.skillRequired})`,"warning"),!1;for(const r of e.ingredients)if(!this.has(r.item,r.quantity)){const o=((n=D[r.item])==null?void 0:n.name)||r.item;return this.state.addLog(`Missing ${r.quantity}x ${o}`,"warning"),!1}if(D[e.result.item]){const r=this.canAdd(e.result.item,e.result.quantity);if(!r.can)return this.state.addLog(r.reason,"warning"),!1}for(const r of e.ingredients)this.remove(r.item,r.quantity);this.add(e.result.item,e.result.quantity);const s=e.skillRequired>=2?15:5;return this.state.player.exp+=s,this.state.player.skills.crafting=(this.state.player.skills.crafting||0)+.1,this.state.townActions&&this.state.townActions.updateTaskProgress("craft",e.result.item,e.result.quantity),this.state.addLog(`Crafted ${e.result.quantity}x ${e.name}!`,"success"),this.state.notify(),!0}getCount(e){if(!this.items.has(e))return 0;const t=this.items.get(e),i=D[e];return i?i.stackable?t:t.length:0}toJSON(){const e={};for(const[t,i]of this.items)e[t]=i;return{items:e,uidCounter:this.uidCounter}}fromJSON(e){if(this.items.clear(),e.items)for(const[t,i]of Object.entries(e.items))this.items.set(t,i);this.uidCounter=e.uidCounter||0}}const rt={wooden:{id:"wooden",name:"Wooden Chest",icon:"ðŸ§°",goldMin:10,goldMax:30,itemCount:{min:2,max:4},recipeChance:.15},iron:{id:"iron",name:"Iron Chest",icon:"ðŸ“¦",goldMin:30,goldMax:80,itemCount:{min:3,max:5},recipeChance:.3},golden:{id:"golden",name:"Golden Chest",icon:"ðŸŽ",goldMin:100,goldMax:250,itemCount:{min:4,max:6},recipeChance:.6,guaranteedValuable:!0}},Xi={wooden:{common:[{item:"rations",weight:15},{item:"bread",weight:15},{item:"wood",weight:12,qtyMin:2,qtyMax:5},{item:"stone",weight:10,qtyMin:2,qtyMax:4},{item:"herbs",weight:12,qtyMin:1,qtyMax:3},{item:"cloth",weight:8,qtyMin:1,qtyMax:2},{item:"bandage",weight:10,qtyMin:1,qtyMax:3},{item:"torch",weight:10,qtyMin:2,qtyMax:4},{item:"rope",weight:5}],uncommon:[{item:"waterskin",weight:15},{item:"health_potion",weight:12},{item:"leather",weight:12,qtyMin:1,qtyMax:2},{item:"iron_ore",weight:10,qtyMin:1,qtyMax:2},{item:"cooked_meat",weight:15,qtyMin:1,qtyMax:2},{item:"fishing_rod",weight:5}]},iron:{common:[{item:"rations",weight:10,qtyMin:2,qtyMax:3},{item:"health_potion",weight:15},{item:"stamina_potion",weight:12},{item:"leather",weight:10,qtyMin:2,qtyMax:3},{item:"iron_ore",weight:12,qtyMin:2,qtyMax:4},{item:"coal",weight:8,qtyMin:2,qtyMax:4}],uncommon:[{item:"iron_ingot",weight:15,qtyMin:1,qtyMax:2},{item:"antidote",weight:10},{item:"crystal_shard",weight:10,qtyMin:1,qtyMax:2},{item:"silver_ore",weight:8,qtyMin:1,qtyMax:2},{item:"pickaxe",weight:5},{item:"axe",weight:5}],rare:[{item:"ether_potion",weight:10},{item:"steel_ingot",weight:8},{item:"gems",weight:5,qtyMin:1,qtyMax:2}]},golden:{common:[{item:"health_potion",weight:12,qtyMin:2,qtyMax:3},{item:"stamina_potion",weight:12,qtyMin:2,qtyMax:3},{item:"iron_ingot",weight:10,qtyMin:2,qtyMax:4}],uncommon:[{item:"steel_ingot",weight:15,qtyMin:1,qtyMax:2},{item:"ether_potion",weight:12},{item:"gems",weight:10,qtyMin:2,qtyMax:4},{item:"gold_ore",weight:10,qtyMin:2,qtyMax:3},{item:"fortifying_elixir",weight:8}],rare:[{item:"diamond",weight:8},{item:"ruby",weight:8},{item:"amethyst",weight:10,qtyMin:2,qtyMax:3},{item:"mithril_ore",weight:5},{item:"ancient_tome",weight:3}],valuable:[{item:"diamond",weight:25},{item:"ruby",weight:25},{item:"gems",weight:20,qtyMin:3,qtyMax:5},{item:"gold_ore",weight:20,qtyMin:3,qtyMax:5},{item:"mithril_ore",weight:10,qtyMin:1,qtyMax:2}]}},qe={basic:["cloth","planks","leather_strip","fishing_rod"],intermediate:["health_potion","stamina_potion","antidote","leather_armor","cooked_fish","hearty_stew","pickaxe","axe","tent"],advanced:["iron_sword","iron_axe","iron_helmet","chainmail","ether_potion","steel_sword","steel_ingot","fortifying_elixir"]};function Pt(T){const e=T.reduce((i,s)=>i+s.weight,0);let t=Math.random()*e;for(const i of T)if(t-=i.weight,t<=0){const s=i.qtyMin&&i.qtyMax?Math.floor(Math.random()*(i.qtyMax-i.qtyMin+1))+i.qtyMin:1;return{item:i.item,quantity:s}}return{item:T[0].item,quantity:1}}function Ki(T){const e=rt[T];if(!e)return{gold:0,items:[],recipe:null};const t=Xi[T];if(!t)return{gold:0,items:[],recipe:null};const i=Math.floor(Math.random()*(e.goldMax-e.goldMin+1))+e.goldMin,s=Math.floor(Math.random()*(e.itemCount.max-e.itemCount.min+1))+e.itemCount.min,a=[],n=new Set;for(let o=0;o<s;o++){let l;const c=Math.random();t.rare&&c<.15?l=t.rare:t.uncommon&&c<.45?l=t.uncommon:l=t.common;const d=Pt(l);(!n.has(d.item)||["health_potion","stamina_potion","ether_potion","gems"].includes(d.item))&&(a.push(d),n.add(d.item))}if(e.guaranteedValuable&&t.valuable){const o=Pt(t.valuable);a.push(o)}let r=null;if(Math.random()<e.recipeChance){let o;T==="golden"?o=qe.advanced:T==="iron"?o=Math.random()<.5?qe.intermediate:qe.basic:o=qe.basic,o.length>0&&(r=o[Math.floor(Math.random()*o.length)])}return{gold:i,items:a,recipe:r}}class qt{constructor(e,t,i){this.state=e,this.gameLoop=t,this.grid=i,this.maxGatherDistance=1,this.activeHex=null,this.progress=0,this.progressInterval=null,this.onActionComplete=null,this.hexResources=new Map,this.resourceSpawnChance=.15,this.maxNewResourcesPerDay=3,this.resourceIcons={forest:["ðŸŒ²","ðŸŒ²","ðŸŒ³","ðŸŒ³","ðŸª¨"],rainforest:["ðŸŒ´","ðŸŒ´","ðŸŒ³","ðŸŒ¿","ðŸª¨"],taiga:["ðŸŒ²","ðŸŒ²","ðŸŒ²","ðŸª¨"],snow_forest:["ðŸŒ²","ðŸŒ²","ðŸª¨"],deep_forest:["ðŸŒ²","ðŸŒ²","ðŸŒ³","ðŸŒ³","ðŸŒ³"],mountain:["ðŸª¨","ðŸª¨","ðŸª¨","â›°ï¸","ðŸ’Ž"],hills:["ðŸª¨","ðŸª¨","ðŸŒ³","â›°ï¸"],snow_peak:["ðŸ”ï¸","ðŸª¨","ðŸ’Ž","ðŸ’Ž"],desert:["ðŸŒµ","ðŸª¨"],savanna:["ðŸŒ¾","ðŸŒ³","ðŸª¨"],swamp:["ðŸŒ¿","ðŸ„","ðŸŒ³"],grassland:["ðŸŒ¿","ðŸŒ¸","ðŸŒ³","ðŸª¨"],plains:["ðŸŒ¾","ðŸŒ¼","ðŸŒ³","ðŸª¨"],tundra:["ðŸª¨","ðŸª¨","â„ï¸"],beach:["ðŸš","ðŸª¨"],coast:["ðŸš","ðŸŽ£","ðŸª¨"],arctic:["â„ï¸","ðŸ§Š","ðŸª¨"],frozen_sea:["ðŸ§Š"],highlands:["ðŸª¨","ðŸª¨","â›°ï¸","ðŸŒ³"],badlands:["ðŸª¨","ðŸª¨","ðŸ’€"],volcanic:["ðŸŒ‹","ðŸª¨","ðŸª¨"]},this.iconActionTypes={"ðŸŒ²":["chop","hunt"],"ðŸŒ³":["chop","hunt"],"ðŸŒ´":["chop"],"ðŸª¨":["mine"],"â›°ï¸":["mine"],"ðŸ’Ž":["mine"],"ðŸ”ï¸":["mine"],"ðŸŒ¿":["gather","forage","hunt"],"ðŸ„":["forage"],"ðŸŒ¸":["gather","hunt"],"ðŸŒ¾":["gather","hunt"],"ðŸŒ¼":["gather","hunt"],"ðŸŒµ":["gather"],"ðŸš":["fish","gather"],"ðŸŽ£":["fish"],"â„ï¸":["mine","gather"],"ðŸ§Š":["mine"],"ðŸŒ‹":["mine"],"ðŸ’€":["mine","gather"]},this.biomeActions={forest:{actions:[{id:"chop_wood",name:"Chop Wood",icon:"ðŸª“",resource:"Wood",uses:5,duration:80,staminaCost:8},{id:"mine_ore",name:"Mine Iron Ore",icon:"â›ï¸",resource:"Iron Ore",uses:2,duration:100,staminaCost:12},{id:"hunt_game",name:"Hunt Game",icon:"ðŸ¹",resource:"Game Meat",uses:2,duration:120,staminaCost:15}]},deep_forest:{actions:[{id:"chop_wood",name:"Chop Hardwood",icon:"ðŸª“",resource:"Hardwood",uses:4,duration:100,staminaCost:12},{id:"forage",name:"Forage Mushrooms",icon:"ðŸ„",resource:"Mushrooms",uses:3,duration:50,staminaCost:5},{id:"hunt_game",name:"Hunt Game",icon:"ðŸ¹",resource:"Game Meat",uses:3,duration:110,staminaCost:14}]},taiga:{actions:[{id:"chop_wood",name:"Chop Pine",icon:"ðŸª“",resource:"Pine Wood",uses:4,duration:90,staminaCost:10},{id:"mine_ore",name:"Mine Iron Ore",icon:"â›ï¸",resource:"Iron Ore",uses:2,duration:100,staminaCost:12}]},rainforest:{actions:[{id:"chop_wood",name:"Chop Tropical Wood",icon:"ðŸª“",resource:"Tropical Wood",uses:4,duration:90,staminaCost:10},{id:"forage",name:"Gather Exotic Fruits",icon:"ðŸŒ",resource:"Exotic Fruit",uses:3,duration:45,staminaCost:5},{id:"gather_herbs",name:"Gather Jungle Herbs",icon:"ðŸŒ¿",resource:"Herbs",uses:3,duration:40,staminaCost:5},{id:"mine",name:"Dig for Stone",icon:"â›ï¸",resource:"Stone",uses:2,duration:70,staminaCost:9}]},snow_forest:{actions:[{id:"chop_wood",name:"Chop Frozen Pine",icon:"ðŸª“",resource:"Frozen Wood",uses:3,duration:100,staminaCost:12},{id:"mine_ore",name:"Mine Iron Ore",icon:"â›ï¸",resource:"Iron Ore",uses:2,duration:110,staminaCost:14}]},grassland:{actions:[{id:"gather_herbs",name:"Gather Herbs",icon:"ðŸŒ¿",resource:"Herbs",uses:3,duration:40,staminaCost:4},{id:"chop_wood",name:"Chop Tree",icon:"ðŸª“",resource:"Wood",uses:2,duration:80,staminaCost:8},{id:"mine",name:"Dig for Stone",icon:"â›ï¸",resource:"Stone",uses:2,duration:60,staminaCost:8},{id:"hunt_game",name:"Hunt Game",icon:"ðŸ¹",resource:"Game Meat",uses:2,duration:100,staminaCost:12}]},plains:{actions:[{id:"gather_herbs",name:"Pick Wildflowers",icon:"ðŸŒ¸",resource:"Wildflowers",uses:4,duration:30,staminaCost:3},{id:"chop_wood",name:"Chop Tree",icon:"ðŸª“",resource:"Wood",uses:2,duration:80,staminaCost:8},{id:"mine",name:"Dig for Stone",icon:"â›ï¸",resource:"Stone",uses:2,duration:60,staminaCost:8},{id:"hunt_game",name:"Hunt Game",icon:"ðŸ¹",resource:"Game Meat",uses:2,duration:100,staminaCost:12}]},savanna:{actions:[{id:"gather_herbs",name:"Gather Savanna Herbs",icon:"ðŸŒ¾",resource:"Dry Herbs",uses:3,duration:45,staminaCost:5},{id:"chop_wood",name:"Chop Acacia",icon:"ðŸª“",resource:"Hardwood",uses:2,duration:90,staminaCost:10},{id:"mine",name:"Dig for Stone",icon:"â›ï¸",resource:"Stone",uses:2,duration:60,staminaCost:8},{id:"hunt_game",name:"Hunt Game",icon:"ðŸ¹",resource:"Game Meat",uses:2,duration:110,staminaCost:14}]},swamp:{actions:[{id:"gather_herbs",name:"Collect Swamp Moss",icon:"ðŸŒ¿",resource:"Swamp Moss",uses:4,duration:50,staminaCost:6},{id:"fish",name:"Catch Frogs",icon:"ðŸ¸",resource:"Frog Legs",uses:3,duration:60,staminaCost:5},{id:"chop_wood",name:"Chop Bog Wood",icon:"ðŸª“",resource:"Bog Wood",uses:3,duration:85,staminaCost:9}]},mountain:{actions:[{id:"mine",name:"Mine Stone",icon:"â›ï¸",resource:"Stone",uses:6,duration:100,staminaCost:12},{id:"mine_ore",name:"Mine Iron Ore",icon:"â›ï¸",resource:"Iron Ore",uses:4,duration:120,staminaCost:15},{id:"mine_gold",name:"Mine Gold Ore",icon:"â›ï¸",resource:"Gold Ore",uses:1,duration:180,staminaCost:20}]},hills:{actions:[{id:"mine",name:"Mine Stone",icon:"â›ï¸",resource:"Stone",uses:5,duration:90,staminaCost:10},{id:"mine_ore",name:"Mine Iron Ore",icon:"â›ï¸",resource:"Iron Ore",uses:3,duration:110,staminaCost:14},{id:"chop_wood",name:"Chop Tree",icon:"ðŸª“",resource:"Wood",uses:2,duration:80,staminaCost:8},{id:"hunt_game",name:"Hunt Game",icon:"ðŸ¹",resource:"Game Meat",uses:1,duration:120,staminaCost:14}]},highlands:{actions:[{id:"mine",name:"Mine Stone",icon:"â›ï¸",resource:"Stone",uses:5,duration:95,staminaCost:11},{id:"mine_ore",name:"Mine Iron Ore",icon:"â›ï¸",resource:"Iron Ore",uses:3,duration:115,staminaCost:14},{id:"mine_copper",name:"Mine Copper Ore",icon:"â›ï¸",resource:"Copper Ore",uses:2,duration:100,staminaCost:12},{id:"chop_wood",name:"Chop Highland Tree",icon:"ðŸª“",resource:"Hardwood",uses:2,duration:85,staminaCost:10}]},snow_peak:{actions:[{id:"mine",name:"Mine Ice Crystal",icon:"ðŸ’Ž",resource:"Ice Crystal",uses:2,duration:150,staminaCost:20},{id:"mine_ore",name:"Mine Silver Ore",icon:"â›ï¸",resource:"Silver Ore",uses:2,duration:140,staminaCost:18}]},arctic:{actions:[{id:"mine",name:"Mine Frozen Stone",icon:"â›ï¸",resource:"Stone",uses:3,duration:100,staminaCost:14},{id:"mine_ice",name:"Harvest Ice Crystal",icon:"ðŸ’Ž",resource:"Ice Crystal",uses:2,duration:120,staminaCost:16},{id:"gather",name:"Collect Ice",icon:"ðŸ§Š",resource:"Ice Crystal",uses:3,duration:60,staminaCost:8}]},frozen_sea:{actions:[{id:"mine",name:"Break Ice",icon:"â›ï¸",resource:"Ice Crystal",uses:3,duration:90,staminaCost:12}]},tundra:{actions:[{id:"gather_herbs",name:"Collect Lichen",icon:"ðŸŒ¿",resource:"Lichen",uses:3,duration:50,staminaCost:6},{id:"mine",name:"Mine Frozen Stone",icon:"â›ï¸",resource:"Stone",uses:4,duration:110,staminaCost:14}]},desert:{actions:[{id:"gather_herbs",name:"Find Cacti",icon:"ðŸŒµ",resource:"Cactus Fruit",uses:2,duration:60,staminaCost:8},{id:"mine",name:"Mine Sandstone",icon:"â›ï¸",resource:"Sandstone",uses:4,duration:80,staminaCost:10}]},badlands:{actions:[{id:"mine",name:"Mine Stone",icon:"â›ï¸",resource:"Stone",uses:5,duration:90,staminaCost:10},{id:"mine_ore",name:"Mine Iron Ore",icon:"â›ï¸",resource:"Iron Ore",uses:4,duration:100,staminaCost:12},{id:"mine_copper",name:"Mine Copper Ore",icon:"â›ï¸",resource:"Copper Ore",uses:3,duration:95,staminaCost:11}]},volcanic:{actions:[{id:"mine",name:"Mine Obsidian",icon:"â›ï¸",resource:"Obsidian",uses:3,duration:130,staminaCost:16},{id:"mine_ore",name:"Mine Iron Ore",icon:"â›ï¸",resource:"Iron Ore",uses:3,duration:110,staminaCost:14}]},coast:{actions:[{id:"fish",name:"Fish",icon:"ðŸŽ£",resource:"Fish",uses:4,duration:70,staminaCost:8},{id:"gather",name:"Collect Shells",icon:"ðŸš",resource:"Shells",uses:5,duration:30,staminaCost:3},{id:"mine",name:"Dig for Stone",icon:"â›ï¸",resource:"Stone",uses:2,duration:60,staminaCost:8}]},beach:{actions:[{id:"fish",name:"Fish",icon:"ðŸŽ£",resource:"Fish",uses:4,duration:70,staminaCost:8},{id:"gather",name:"Collect Shells",icon:"ðŸš",resource:"Shells",uses:5,duration:30,staminaCost:3},{id:"mine",name:"Dig for Rocks",icon:"â›ï¸",resource:"Stone",uses:2,duration:60,staminaCost:8}]}}}setGrid(e){this.grid=e}getActionsForHex(e){if(!e||!e.biome)return[];if(!e.hasResources)return[];const t=e.biome.id,i=this.biomeActions[t];if(!i)return[];const s=e.resourceIcon,a=s?this.iconActionTypes[s]:null,n=`${e.q},${e.r}`,r=[];for(const o of i.actions){if(a){const d=o.id.split("_")[0];if(!a.includes(d))continue}const l=`${n}_${o.id}`,c=this.hexResources.has(l)?this.hexResources.get(l):o.uses;c>0&&r.push({...o,remaining:c,hexKey:n,resourceKey:l})}return r}canPerform(e,t=null){if(this.state.player.stamina<e.staminaCost)return{can:!1,reason:"Not enough stamina"};if(e.remaining<=0)return{can:!1,reason:"Resource depleted"};if(t&&this.grid){const s=this.state.player.position;if(s&&this.grid.distance(s.q,s.r,t.q,t.r)>this.maxGatherDistance)return{can:!1,reason:"Too far away - travel closer"}}const i=We[e.resource];if(i&&this.state.inventory){const s=this.state.inventory.canAdd(i,1);if(!s.can)return{can:!1,reason:s.reason}}return{can:!0}}getDistanceToHex(e){if(!this.grid||!this.state.player.position)return 1/0;const t=this.state.player.position;return this.grid.distance(t.q,t.r,e.q,e.r)}startAction(e,t,i,s){const a=this.canPerform(t,e);if(!a.can)return this.state.addLog(a.reason,"warning"),!1;this.activeHex&&this.cancelAction(),this.activeHex=e,this.activeAction=t,this.progress=0;const n=1+(this.state.player.skills.gathering||0)*.02,r=t.duration/n,o=50,l=100/(r/(o/50));return this.progressInterval=setInterval(()=>{this.progress+=l,i&&i(Math.min(100,this.progress),t,e),this.progress>=100&&this.completeAction(t,s)},o),!0}completeAction(e,t){clearInterval(this.progressInterval),this.progressInterval=null,this.state.player.stamina-=e.staminaCost;const s=(this.hexResources.has(e.resourceKey)?this.hexResources.get(e.resourceKey):e.uses)-1;this.hexResources.set(e.resourceKey,s);const a=1+this.state.player.attributes.prestige*.05,n=Math.floor(Math.random()*2)+1,r=Math.ceil(n*a),o=We[e.resource];o&&this.state.inventory?this.state.inventory.add(o,r)?(this.state.addLog(`Gathered ${r}x ${e.resource}`,"success"),this.state.townActions&&this.state.townActions.updateTaskProgress("gather",o,r)):this.state.addLog(`Inventory full! ${e.resource} lost.`,"warning"):this.state.addLog(`Gathered ${r}x ${e.resource}`,"success"),this.state.player.exp+=3,this.state.player.skills.gathering=(this.state.player.skills.gathering||0)+.1,this.gameLoop.advanceHours(.5);const l=this.activeHex;s>0?this.state.addLog(`${s} more ${e.resource} available here`,"info"):(this.destroyResourceSpot(l),this.state.addLog("Resource depleted. New resources may appear elsewhere.","warning")),this.activeHex=null,this.activeAction=null,this.progress=0,this.state.notify(),t&&t(e,l,s),this.onActionComplete&&this.onActionComplete()}cancelAction(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null),this.activeHex=null,this.activeAction=null,this.progress=0}resetHexResources(e){for(const t of this.hexResources.keys())t.startsWith(e)&&this.hexResources.delete(t)}destroyResourceSpot(e){if(!e)return;e.hasResources=!1,e.resourceIcon=null;const t=`${e.q},${e.r}`;this.resetHexResources(t)}propagateResources(){if(!this.grid)return;const e=[];if(this.grid.forEach(i=>{if(i.hasResources||!i.biome||i.biome.id.includes("ocean")||i.biome.id.includes("sea"))return;const s=this.resourceIcons[i.biome.id];!s||s.length===0||e.push(i)}),e.length===0)return;let t=0;for(const i of e){if(t>=this.maxNewResourcesPerDay)break;if(Math.random()<this.resourceSpawnChance){const s=this.resourceIcons[i.biome.id],a=s[Math.floor(Math.random()*s.length)];i.hasResources=!0,i.resourceIcon=a,t++}}t>0&&this.state.addLog("New resources appeared in the wilderness.","discovery")}getResourceSpotCount(){let e=0;return this.grid&&this.grid.forEach(t=>{t.hasResources&&e++}),e}hasWaterSource(e){var i;if(!e)return{has:!1};if(e.poi&&(e.poi.type==="town"||e.poi.type==="city"||e.poi.type==="village"||e.poi.type==="outpost"))return{has:!0,type:"well",name:`${e.poi.name} Well`};const t=(i=e.biome)==null?void 0:i.id;return t==="coast"||t==="beach"||t==="ocean"||t==="deep_ocean"?{has:!1,reason:"Saltwater is not drinkable"}:t==="swamp"?{has:!0,type:"swamp",name:"Murky Swamp Water"}:{has:!1}}getWaterActions(){const e=this.state.player.position;if(!e||!this.grid||typeof this.grid.getCell!="function")return[];const t=[],i=this.grid.getCell(e.q,e.r),s=this.hasWaterSource(i);s.has&&t.push({id:"drink_water",name:`Drink from ${s.name}`,icon:"ðŸ’§",type:s.type,hex:i,thirstRestore:s.type==="well"?100:60});const a=this.grid.getNeighbors?this.grid.getNeighbors(e.q,e.r):[];for(const n of a){const r=this.hasWaterSource(n);r.has&&t.push({id:"drink_water",name:`Drink from ${r.name}`,icon:"ðŸ’§",type:r.type,hex:n,thirstRestore:r.type==="well"?100:60})}return t}drinkWater(e){return!e||e.id!=="drink_water"?!1:(typeof this.state.restoreThirst=="function"&&this.state.restoreThirst(e.thirstRestore),e.type==="swamp"&&Math.random()<.15?(this.state.applyCondition("poison",30),this.state.addLog("The murky water made you feel ill...","warning")):this.state.addLog(`Drank from ${e.name}. Refreshing!`,"success"),this.gameLoop.advanceMinutes(5),this.state.notify(),!0)}hasChest(e){return!e||!e.chest||(`${e.q}${e.r}`,this.state.isChestOpened&&this.state.isChestOpened(e.q,e.r))?!1:!e.chest.opened}getChestInfo(e){if(!this.hasChest(e))return null;const t=rt[e.chest.type];return{type:e.chest.type,name:(t==null?void 0:t.name)||"Chest",icon:(t==null?void 0:t.icon)||"ðŸ§°",q:e.q,r:e.r}}openChest(e){if(!this.hasChest(e))return null;const t=e.chest.type,i=Ki(t);return e.chest.opened=!0,this.state.markChestOpened&&this.state.markChestOpened(e.q,e.r),i}getNearbyChests(){if(!this.state.player.position||!this.grid||typeof this.grid.getCell!="function")return[];const e=this.state.player.position,t=[],i=this.grid.getCell(e.q,e.r);this.hasChest(i)&&t.push(this.getChestInfo(i));const s=this.grid.getNeighbors?this.grid.getNeighbors(e.q,e.r):[];for(const a of s)this.hasChest(a)&&t.push(this.getChestInfo(a));return t}}const fe={WAGE_THRESHOLD_LEVEL:3,BASE_DAILY_WAGE:5,MIN_INITIATION_LEVEL:3,INJURY_RECOVERY_DAYS:2,RESCUE_TIMER_DAYS:5},O={ACTIVE:"active",INJURED:"injured",IMPRISONED:"imprisoned",MISSING:"missing",DEAD:"dead"},ye={apprentice:{id:"apprentice",name:"Apprentice",levelRange:[1,2],baseCostMultiplier:1,guildAffiliated:!1,minSettlementSize:1,minPrestige:0,minInfluence:0,spawnWeight:50},journeyman:{id:"journeyman",name:"Journeyman",levelRange:[3,4],baseCostMultiplier:3,guildAffiliated:!0,minSettlementSize:2,minPrestige:3,minInfluence:2,spawnWeight:30},veteran:{id:"veteran",name:"Veteran",levelRange:[5,6],baseCostMultiplier:6,guildAffiliated:!0,guildRankRange:[2,3],minSettlementSize:3,minPrestige:5,minInfluence:4,spawnWeight:15},expert:{id:"expert",name:"Expert",levelRange:[7,8],baseCostMultiplier:12,guildAffiliated:!0,guildRankRange:[3,4],minSettlementSize:4,minPrestige:7,minInfluence:6,spawnWeight:5}},Ji={gatherer:"explorers",crafter:"artisans",merchant:"merchants",guard:"ironcompany",scout:"explorers"},Re={gatherer:{role:"gatherer",icon:"ðŸ§‘â€ðŸŒ¾",skills:{gathering:2,woodcutting:1,mining:1},wage:5,carryWeight:25,description:"Gathers resources from assigned locations"},crafter:{role:"crafter",icon:"ðŸ§‘â€ðŸ”§",skills:{crafting:3,smithing:1},wage:8,carryWeight:15,description:"Crafts items at workshops"},merchant:{role:"merchant",icon:"ðŸ§‘â€ðŸ’¼",skills:{trading:3,appraisal:2},wage:10,carryWeight:20,description:"Manages trade routes and shops"},guard:{role:"guard",icon:"ðŸ’‚",skills:{combat:3,patrol:2},wage:12,carryWeight:18,description:"Protects settlements and caravans"},scout:{role:"scout",icon:"ðŸƒ",skills:{exploration:3,survival:2},wage:7,carryWeight:12,description:"Explores and reveals map areas"}},Me={traveling_blacksmith:{id:"traveling_blacksmith",name:"Traveling Blacksmith",icon:"âš’ï¸",canTrade:!0,canGiveQuests:!0,questTypes:["gather"],tradeType:"weapons",baseSkills:{smithing:3,trading:2}},wandering_herbalist:{id:"wandering_herbalist",name:"Wandering Herbalist",icon:"ðŸŒ¿",canTrade:!0,canGiveQuests:!0,questTypes:["gather"],tradeType:"herbs",baseSkills:{herbalism:3,medicine:2}},roaming_provisioner:{id:"roaming_provisioner",name:"Roaming Provisioner",icon:"ðŸ–",canTrade:!0,canGiveQuests:!1,tradeType:"food",baseSkills:{trading:2,survival:2}},wandering_hunter:{id:"wandering_hunter",name:"Wandering Hunter",icon:"ðŸ¹",canTrade:!0,canGiveQuests:!0,questTypes:["bounty"],tradeType:"hunting",baseSkills:{hunting:3,tracking:2}},traveling_jeweler:{id:"traveling_jeweler",name:"Traveling Jeweler",icon:"ðŸ’Ž",canTrade:!0,canGiveQuests:!1,tradeType:"jewelry",baseSkills:{appraisal:3,trading:2}},wandering_merchant:{id:"wandering_merchant",name:"Wandering Merchant",icon:"ðŸ§³",canTrade:!0,canGiveQuests:!0,questTypes:["gather","delivery"],tradeType:"general",baseSkills:{trading:3,appraisal:2}},wandering_healer:{id:"wandering_healer",name:"Wandering Healer",icon:"ðŸ’Š",canTrade:!0,canGiveQuests:!1,tradeType:"healing",baseSkills:{medicine:3,herbalism:2}},traveling_scholar:{id:"traveling_scholar",name:"Traveling Scholar",icon:"ðŸ“š",canTrade:!1,canGiveQuests:!0,questTypes:["dungeon","explore"],baseSkills:{lore:3,exploration:2}},bounty_hunter:{id:"bounty_hunter",name:"Bounty Hunter",icon:"ðŸŽ¯",canTrade:!1,canGiveQuests:!0,questTypes:["bounty","dungeon"],baseSkills:{combat:3,tracking:2}},mysterious_stranger:{id:"mysterious_stranger",name:"Mysterious Stranger",icon:"ðŸŽ­",canTrade:!0,canGiveQuests:!0,questTypes:["dungeon"],tradeType:"rare",baseSkills:{stealth:2,lore:2}}},Rt={traveling_blacksmith:[{id:"iron_sword",name:"Iron Sword",basePrice:80,quantity:2},{id:"iron_dagger",name:"Iron Dagger",basePrice:35,quantity:3},{id:"iron_axe",name:"Iron Axe",basePrice:60,quantity:2},{id:"chainmail",name:"Chainmail Armor",basePrice:150,quantity:1},{id:"iron_shield",name:"Iron Shield",basePrice:70,quantity:2},{id:"pickaxe",name:"Pickaxe",basePrice:25,quantity:3},{id:"repair_kit",name:"Repair Kit",basePrice:20,quantity:4}],wandering_herbalist:[{id:"herbs",name:"Medicinal Herbs",basePrice:8,quantity:10},{id:"health_potion",name:"Health Potion",basePrice:22,quantity:4},{id:"stamina_potion",name:"Stamina Potion",basePrice:18,quantity:4},{id:"antidote",name:"Antidote",basePrice:12,quantity:5},{id:"poison_vial",name:"Poison Vial",basePrice:30,quantity:2},{id:"rare_herb",name:"Rare Herb",basePrice:45,quantity:2},{id:"mushrooms",name:"Medicinal Mushrooms",basePrice:15,quantity:6}],roaming_provisioner:[{id:"rations",name:"Travel Rations",basePrice:6,quantity:15},{id:"bread",name:"Fresh Bread",basePrice:3,quantity:10},{id:"dried_meat",name:"Dried Meat",basePrice:8,quantity:8},{id:"cheese",name:"Aged Cheese",basePrice:5,quantity:6},{id:"wine",name:"Wine Bottle",basePrice:12,quantity:4},{id:"ale",name:"Ale Keg",basePrice:8,quantity:5},{id:"cooking_pot",name:"Cooking Pot",basePrice:15,quantity:2},{id:"salt",name:"Salt Pouch",basePrice:4,quantity:8}],wandering_hunter:[{id:"raw_meat",name:"Fresh Game Meat",basePrice:10,quantity:8},{id:"wolf_pelt",name:"Wolf Pelt",basePrice:25,quantity:3},{id:"deer_hide",name:"Deer Hide",basePrice:18,quantity:4},{id:"bear_pelt",name:"Bear Pelt",basePrice:60,quantity:1},{id:"arrows",name:"Arrow Bundle",basePrice:12,quantity:6},{id:"hunting_bow",name:"Hunting Bow",basePrice:45,quantity:2},{id:"trap",name:"Animal Trap",basePrice:20,quantity:3},{id:"bait",name:"Hunting Bait",basePrice:5,quantity:10}],traveling_jeweler:[{id:"gold_ring",name:"Gold Ring",basePrice:80,quantity:2},{id:"silver_necklace",name:"Silver Necklace",basePrice:55,quantity:3},{id:"ruby",name:"Polished Ruby",basePrice:120,quantity:1},{id:"emerald",name:"Cut Emerald",basePrice:100,quantity:1},{id:"sapphire",name:"Blue Sapphire",basePrice:90,quantity:2},{id:"pearl",name:"River Pearl",basePrice:40,quantity:4},{id:"amulet",name:"Enchanted Amulet",basePrice:150,quantity:1}],wandering_merchant:[{id:"health_potion",name:"Health Potion",basePrice:25,quantity:3},{id:"torch",name:"Torch",basePrice:5,quantity:8},{id:"rope",name:"Rope",basePrice:10,quantity:4},{id:"rations",name:"Rations",basePrice:8,quantity:6},{id:"lantern",name:"Lantern",basePrice:18,quantity:2},{id:"backpack",name:"Traveler's Pack",basePrice:30,quantity:2},{id:"waterskin",name:"Waterskin",basePrice:6,quantity:5}],wandering_healer:[{id:"health_potion",name:"Health Potion",basePrice:20,quantity:6},{id:"greater_health_potion",name:"Greater Health Potion",basePrice:45,quantity:2},{id:"antidote",name:"Antidote",basePrice:15,quantity:5},{id:"bandage",name:"Bandage",basePrice:5,quantity:12},{id:"healing_salve",name:"Healing Salve",basePrice:28,quantity:4},{id:"cure_disease",name:"Cure Disease",basePrice:35,quantity:2},{id:"smelling_salts",name:"Smelling Salts",basePrice:10,quantity:5}],mysterious_stranger:[{id:"mystery_box",name:"Mystery Box",basePrice:50,quantity:2},{id:"strange_map",name:"Strange Map",basePrice:40,quantity:1},{id:"lucky_charm",name:"Lucky Charm",basePrice:35,quantity:2},{id:"cursed_coin",name:"Cursed Coin",basePrice:25,quantity:3},{id:"shadow_cloak",name:"Shadow Cloak",basePrice:120,quantity:1},{id:"ancient_key",name:"Ancient Key",basePrice:75,quantity:1},{id:"void_crystal",name:"Void Crystal",basePrice:200,quantity:1}]},Dt=["Aldric","Bran","Cedric","Dorian","Edwin","Finn","Gareth","Harald","Ivar","Jasper","Klaus","Leif","Magnus","Nils","Osric","Percival","Quinn","Roland","Sven","Theron","Ulric","Viktor","Willem","Xavier","Aric","Bjorn","Corwin","Dain","Eamon","Fenris","Godric","Halvar","Ingram","Jorik","Kael","Lothar","Merric","Norvin","Orin","Paxton","Ragnar","Sigurd","Tormund","Ulfric","Valdis","Wulfgar","Yorick","Zephyr","Alara","Brynn","Celia","Daria","Elena","Freya","Greta","Hilda","Iris","Jenna","Kira","Luna","Mira","Nadia","Olga","Petra","Roslyn","Sylva","Thalia","Una","Vera","Wren","Yara","Zara","Astrid","Britta","Cordelia","Dahlia","Elara","Fiona","Gwendolyn","Helga","Ingrid","Johanna","Katla","Livia","Margot","Nessa","Odette","Primrose","Rowena","Sigrid","Tilda","Ursula","Vesper","Wynne","Ylva","Zelda"],Lt=["Oak","Iron","Stone","Storm","Shadow","Silver","Gold","Dark","Bright","Swift","Strong","Frost","Fire","Thunder","Wind","Black","White","Red","Grey","Dawn","Dusk","Star","Moon","Sun","Wolf","Bear","Hawk","Raven","Dragon","Lion","Stag","Boar","Ash","Thorn","Willow","Elder","Moss","Copper","Bronze","Steel","Grim","Bold","True","Keen","Wise","Wild","High","Deep"],Bt=["shield","bane","heart","forge","helm","blade","wind","vale","wood","stone","brook","well","dale","ford","ridge","cliff","born","walker","breaker","keeper","warden","strider","runner","seeker","mane","claw","fang","horn","wing","tail","pelt","eye","song","flame","frost","storm","light","shade","soul","spirit","hammer","axe","spear","arrow","bow","brand","guard","ward"];function Zi(){const T=Lt[Math.floor(Math.random()*Lt.length)],e=Bt[Math.floor(Math.random()*Bt.length)];return T+e}const De={traveling_blacksmith:["Smith ","Blacksmith ","Forgemaster "],wandering_herbalist:["Herbalist ","Apothecary ",""],roaming_provisioner:["","Cook ","Provisioner "],wandering_hunter:["Hunter ","Trapper ",""],traveling_jeweler:["Jeweler ","Gemcutter ",""],wandering_merchant:["","Trader ","Peddler "],wandering_healer:["Healer ","Sister ","Brother ","Doctor "],traveling_scholar:["Sage ","Scholar ","Lorekeeper "],bounty_hunter:["","Hunter ","Tracker "],mysterious_stranger:["The ","A ",""]},Ot=["Hooded One","Shrouded Sage","Silent Wanderer","Dark Pilgrim","Veiled Stranger","Enigmatic Visitor","Masked Figure","Shadow Walker"],se=class se{constructor(e){this.state=e,this.allCitizens=new Map,this.uidCounter=0,this.hiredWorkers=[],this.roamingNPCs=[],this.maxHiredWorkers=2,this.maxRoamingNPCs=8,this.spawnRadius=3,this.wanderRadius=6,this.moveChance=.25,this.citizens=this.hiredWorkers}getCitizenByUid(e){return this.allCitizens.get(e)||this.allCitizens.get(String(e))||this.allCitizens.get(Number(e))}registerCitizen(e){return this.allCitizens.set(e.uid,e),e}generateName(e=null){if(e==="mysterious_stranger"&&Math.random()>.3){const s=De[e][Math.floor(Math.random()*De[e].length)],a=Ot[Math.floor(Math.random()*Ot.length)];return s+a}const t=Dt[Math.floor(Math.random()*Dt.length)],i=Zi();if(e&&De[e]){const s=De[e],a=s[Math.floor(Math.random()*s.length)];if(a&&Math.random()>.5)return`${a}${t}`}return`${t} ${i}`}createBaseCitizen(e={}){var i,s;return{uid:++this.uidCounter,name:e.name||this.generateName(e.archetype),trust:e.trust??50,reputation:e.reputation??0,interactions:0,questsGiven:0,questsCompleted:0,questsFailed:0,homeSettlement:e.homeSettlement||null,currentQ:e.q??0,currentR:e.r??0,status:e.status||"idle",state:e.state||"idle",spawnDay:e.spawnDay||(((i=this.state)==null?void 0:i.day)??1),lastSeenDay:e.spawnDay||(((s=this.state)==null?void 0:s.day)??1),isRoaming:e.isRoaming||!1,isHired:e.isHired||!1,archetype:e.archetype||null,workerRole:e.workerRole||null,skills:e.skills||{},professionXP:{agriculture:0,construction:0,medicine:0,tailoring:0,warriors:0,smithing:0,rangers:0},combatStats:{hp:e.combatHp??50,maxHp:e.combatMaxHp??50,damage:e.combatDamage??5,defense:e.combatDefense??3,agility:e.combatAgility??5},isHostile:e.isHostile||!1,fleeing:!1,isDead:!1,wage:e.wage||0,morale:e.morale??80,energy:e.energy??100,experience:0,level:1,assignment:null,inventory:[],maxCarryWeight:e.maxCarryWeight||15,status:O.ACTIVE,statusTimer:0,captureLocation:null,guildId:null,guildRank:0,icon:e.icon||"ðŸ‘¤",tradeInventory:e.tradeInventory||[],currentQuest:null,canTrade:e.canTrade||!1,canGiveQuests:e.canGiveQuests||!1,questTypes:e.questTypes||[]}}generateRoamingCitizen(e,t,i=null){const s=Object.keys(Me),a=i||s[Math.floor(Math.random()*s.length)],n=Me[a];if(!n)return null;const r=this.findSpawnPosition(e,t);if(!r)return null;const o=this.createBaseCitizen({name:this.generateName(a),archetype:a,isRoaming:!0,homeSettlement:`${e.q},${e.r}`,q:r.q,r:r.r,icon:n.icon,skills:{...n.baseSkills},canTrade:n.canTrade,canGiveQuests:n.canGiveQuests,questTypes:n.questTypes||[],trust:50+Math.floor(Math.random()*20)-10});return o.archetypeData=n,o.originName=e.name,n.canTrade&&(o.tradeInventory=this.generateTradeInventory(a,o.trust)),this.registerCitizen(o),o}generateTradeInventory(e,t=50){const i=Rt[e]||Rt.wandering_merchant,s=1.3-t/100*.5;return i.map(a=>({id:a.id,name:a.name,basePrice:a.basePrice,price:Math.floor(a.basePrice*s),quantity:Math.max(1,a.quantity+Math.floor(Math.random()*3)-1),trustModifier:s}))}updateTradePrices(e){if(!e.tradeInventory)return;const t=1.3-e.trust/100*.5;for(const i of e.tradeInventory)i.price=Math.floor(i.basePrice*t),i.trustModifier=t}findSpawnPosition(e,t){var s,a;const i=[];for(let n=-this.spawnRadius;n<=this.spawnRadius;n++)for(let r=-this.spawnRadius;r<=this.spawnRadius;r++){if(n===0&&r===0)continue;const o=e.q+n,l=e.r+r,c=t.getCell(o,l);c&&!((s=c.biome)!=null&&s.impassable)&&!["deep_ocean","ocean","frozen_sea"].includes((a=c.biome)==null?void 0:a.id)&&(this.getRoamingNPCAt(o,l)||i.push({q:o,r:l}))}return i.length===0?null:i[Math.floor(Math.random()*i.length)]}spawnRoamingNPCs(e,t,i=!1){if(this.roamingNPCs.length>=this.maxRoamingNPCs)return;const s=e.filter(a=>{var n;return((n=a.type)==null?void 0:n.category)==="settlement"});for(const a of s){if(this.roamingNPCs.length>=this.maxRoamingNPCs)break;if(!i&&Math.random()>.15||this.roamingNPCs.filter(o=>o.homeSettlement===`${a.q},${a.r}`).length>=2)continue;const r=this.generateRoamingCitizen(a,t);r&&this.roamingNPCs.push(r)}}moveRoamingNPCs(e){for(const t of this.roamingNPCs){if(Math.random()>this.moveChance)continue;const s=[{dq:1,dr:0},{dq:-1,dr:0},{dq:0,dr:1},{dq:0,dr:-1},{dq:1,dr:-1},{dq:-1,dr:1}].filter(a=>{var u,h;const n=t.currentQ+a.dq,r=t.currentR+a.dr,o=e.getCell(n,r);if(!o||(u=o.biome)!=null&&u.impassable||["deep_ocean","ocean","frozen_sea"].includes((h=o.biome)==null?void 0:h.id)||this.getRoamingNPCAt(n,r))return!1;const[l,c]=(t.homeSettlement||"0,0").split(",").map(Number);return!(this.hexDistance(n,r,l,c)>this.wanderRadius)});if(s.length>0){const a=s[Math.floor(Math.random()*s.length)];t.currentQ+=a.dq,t.currentR+=a.dr}}}getRoamingNPCAt(e,t){return this.roamingNPCs.find(i=>i.currentQ===e&&i.currentR===t)}hexDistance(e,t,i,s){return Math.max(Math.abs(e-i),Math.abs(t-s),Math.abs(e+t-(i+s)))}modifyTrust(e,t,i=""){const s=this.getCitizenByUid(e);if(!s)return;const a=s.trust;if(s.trust=Math.max(0,Math.min(100,s.trust+t)),s.interactions++,s.canTrade&&this.updateTradePrices(s),i){const n=t>=0?`+${t}`:`${t}`;this.state.addLog(`${s.name}: Trust ${n} (${i})`,t>=0?"success":"warning")}return a>=30&&s.trust<30?this.state.addLog(`${s.name} no longer trusts you...`,"error"):a<70&&s.trust>=70&&this.state.addLog(`${s.name} considers you a trusted friend!`,"success"),s.trust}onQuestCompleted(e){const t=this.getCitizenByUid(e);if(!t)return;t.questsCompleted++;const i=Math.min(15,5+t.questsCompleted);this.modifyTrust(e,i,"quest completed"),t.reputation+=2}onQuestFailed(e){const t=this.getCitizenByUid(e);if(!t)return;t.questsFailed++;const i=Math.min(20,8+t.questsFailed*3);this.modifyTrust(e,-i,"quest failed"),t.reputation-=3,t.trust<20&&(t.currentQuest=null,this.state.addLog(`${t.name} refuses to offer you more work.`,"error"))}onQuestAbandoned(e){const t=this.getCitizenByUid(e);t&&(this.modifyTrust(e,-5,"quest abandoned"),t.reputation-=1)}onTrade(e,t){this.getCitizenByUid(e)&&(t>=50?this.modifyTrust(e,2,"good trade"):t>=20&&this.modifyTrust(e,1,"trade"))}getTrustLevel(e){return e>=90?{level:"devoted",color:"#4a9"}:e>=70?{level:"trusted",color:"#5a5"}:e>=50?{level:"friendly",color:"#aa5"}:e>=30?{level:"neutral",color:"#888"}:e>=15?{level:"wary",color:"#a85"}:{level:"hostile",color:"#a55"}}get maxCitizenSlots(){var i,s;return 2+Math.floor((((s=(i=this.state.player)==null?void 0:i.attributes)==null?void 0:s.trust)||0)/3)}generateWorker(e=null,t=null,i={}){const s=Object.keys(Re),a=e||s[Math.floor(Math.random()*s.length)],n=Re[a],r={...n.skills};for(const h of Object.keys(r))r[h]+=Math.floor(Math.random()*3)-1,r[h]=Math.max(1,r[h]);const o=i.tier?ye[i.tier]:ye.apprentice,[l,c]=o.levelRange,d=l+Math.floor(Math.random()*(c-l+1));for(const h of Object.keys(r))r[h]+=Math.floor((d-1)*.5);const u=this.createBaseCitizen({name:this.generateName(),workerRole:a,isHired:!1,homeSettlement:t?`${t.q},${t.r}`:null,q:(t==null?void 0:t.q)??0,r:(t==null?void 0:t.r)??0,icon:n.icon,skills:r,wage:n.wage+Math.floor(Math.random()*5)-2,maxCarryWeight:n.carryWeight+Math.floor(Math.random()*6)-2,morale:80+Math.floor(Math.random()*20),trust:50});if(u.level=d,u.tier=o.id,o.guildAffiliated){const h=Ji[a]||"explorers";if(u.guildId=h,o.guildRankRange){const[m,g]=o.guildRankRange;u.guildRank=m+Math.floor(Math.random()*(g-m+1))}else u.guildRank=1}return u.combat||(u.combat={}),u.combat.hp=20+d*5,u.combat.maxHp=u.combat.hp,u.combat.damage=3+Math.floor(d*1.5),u.combat.defense=2+d,u.combat.agility=5+Math.floor(d*.5),u.workerTemplate=n,u.hireCost=this.calculateHireCost(u,o),this.registerCitizen(u),u}generateCitizen(e=null){return this.generateWorker(e)}getCarryWeight(e){let t=0;for(const i of e.inventory){const s=D[i.itemId];s&&(t+=s.weight*i.quantity)}return Math.round(t*10)/10}canCarry(e,t,i=1){const s=D[t];return s?this.getCarryWeight(e)+s.weight*i<=e.maxCarryWeight:!1}addToInventory(e,t,i=1){if(!this.canCarry(e,t,i))return!1;const s=e.inventory.find(a=>a.itemId===t);return s?s.quantity+=i:e.inventory.push({itemId:t,quantity:i}),!0}clearInventory(e){const t=[...e.inventory];return e.inventory=[],t}getAvailableForHire(e){var d,u,h,m,g,y;if(!e||e.type.category!=="settlement")return[];const t=e.type.size||1,i=(d=this.state)==null?void 0:d.player,s=((u=i==null?void 0:i.attributes)==null?void 0:u.prestige)||0,a=((h=i==null?void 0:i.attributes)==null?void 0:h.influence)||0,n=Math.min(5,t+1),r=[],o=`${e.q},${e.r}-${this.state.day}`,l=this.seededRandom(o),c=this.getAvailableTiers(t,s,a);c.length===0&&c.push({...ye.apprentice,tierId:"apprentice"});for(let f=0;f<n;f++){let p=null;((m=e.data)==null?void 0:m.economy)==="Mining"&&(p=l()>.5?"gatherer":null),((g=e.data)==null?void 0:g.economy)==="Trade"&&(p=l()>.5?"merchant":null),((y=e.data)==null?void 0:y.economy)==="Military"&&(p=l()>.5?"guard":null);const v=this.selectRandomTier(c,l),b=this.generateWorker(p,e,{tier:v});r.push(b)}return r.sort((f,p)=>f.level-p.level),r}hire(e,t=null){return this.citizens.length>=this.maxCitizenSlots?(this.state.addLog("No room for more citizens. Increase Trust.","warning"),!1):this.state.player.gold<e.hireCost?(this.state.addLog(`Not enough gold to hire ${e.name}`,"warning"),!1):(this.state.player.gold-=e.hireCost,e.hired=!0,e.hiredDay=this.state.day,t&&(e.homeSettlement=`${t.q},${t.r}`,e.currentLocation=e.homeSettlement),this.citizens.push(e),this.allCitizens.set(e.uid,e),this.state.addLog(`Hired ${e.name} (${e.role})`,"success"),this.state.notify(),!0)}dismiss(e){const t=String(e),i=this.citizens.findIndex(a=>String(a.uid)===t);if(i===-1)return!1;const s=this.citizens[i];return this.citizens.splice(i,1),this.state.addLog(`${s.name} has departed`,"info"),this.state.notify(),!0}assign(e,t){const i=this.getCitizenByUid(e);return i?(i.assignment=t,this.state.addLog(`${i.name} assigned to ${t.type}`,"info"),this.state.notify(),!0):!1}unassign(e){const t=this.getCitizenByUid(e);return t?(t.assignment=null,t.state="idle",this.state.addLog(`${t.name} is now idle`,"info"),this.state.notify(),!0):!1}processTick(){for(const e of this.citizens){if(e.energy<10&&e.state!=="idle"){e.state="idle",this.state.addLog(`${e.name} is exhausted and resting`,"warning");continue}switch(e.state){case"idle":if(e.assignment)switch(e.assignment.type){case"gather":this.startTravelToResource(e);break;case"craft":this.processCrafting(e),e.energy-=5;break;case"patrol":this.processPatrol(e),e.energy-=5;break;case"trade":this.processTrading(e),e.energy-=5;break;case"scout":this.processScouting(e),e.energy-=5;break}break;case"traveling_to_resource":this.processTraveling(e,"gathering");break;case"gathering":this.processGathering(e);break;case"traveling_to_storage":this.processTraveling(e,"depositing");break;case"depositing":this.processDepositing(e);break}e.assignment&&(e.state!=="idle"||e.assignment.type!=="gather")&&(e.experience+=1,e.experience>=e.level*100&&(e.level++,e.experience=0,this.state.addLog(`${e.name} reached level ${e.level}!`,"success"),this.state.showToast&&this.state.showToast(`${e.name} reached level ${e.level}!`,"success",4e3,"â¬†ï¸")))}}startTravelToResource(e){!e.assignment||!e.assignment.poiKey||(e.travelTime=3,e.travelProgress=0,e.state="traveling_to_resource")}startTravelToStorage(e){if(!e.homeSettlement){this.depositToPlayer(e);return}e.travelTime=3,e.travelProgress=0,e.state="traveling_to_storage"}processTraveling(e,t){e.travelProgress++,e.energy-=2,e.travelProgress>=e.travelTime&&(e.travelProgress=0,e.state=t,t==="gathering"?e.currentLocation=e.assignment.poiKey:t==="depositing"&&(e.currentLocation=e.homeSettlement))}processGathering(e){const t=e.skills.gathering||1,i=.4+t*.1;if(e.energy-=5,Math.random()<i){let a="wood";e.assignment&&e.assignment.resourceType&&(a=We[e.assignment.resourceType]||"wood");const n=1+Math.floor(t/3);if(this.canCarry(e,a,n))this.addToInventory(e,a,n);else{this.startTravelToStorage(e);return}}this.getCarryWeight(e)>=e.maxCarryWeight*.8&&this.startTravelToStorage(e)}processDepositing(e){const t=this.clearInventory(e);if(t.length>0)if(this.state.getStorage(e.homeSettlement)){let s=0;for(const a of t){const n=this.state.addToStorage(e.homeSettlement,a.itemId,a.quantity);s+=n}s>0&&(this.state.addLog(`${e.name} deposited ${s} items at storage`,"success"),this.state.showToast&&this.state.showToast(`${e.name} deposited ${s} items`,"citizen",3e3,"ðŸ“¦"))}else this.depositToPlayer(e,t);e.assignment?this.startTravelToResource(e):e.state="idle"}depositToPlayer(e,t=null){const i=t||this.clearInventory(e);for(const s of i)this.state.inventory&&this.state.inventory.add(s.itemId,s.quantity);i.length>0&&(this.state.addLog(`${e.name} handed over gathered items`,"info"),this.state.showToast&&this.state.showToast(`${e.name} handed over items`,"citizen",3e3,"ðŸ¤")),e.state="idle"}processCrafting(e){const t=e.skills.crafting||1,i=.2+t*.1;if(Math.random()<i){const s=2+t;this.state.player.gold+=s,this.state.addLog(`${e.name} earned ${s}g from crafting`,"success"),this.state.showToast&&this.state.showToast(`${e.name} earned ${s}g crafting`,"gold",3e3,"ðŸ”¨")}}processPatrol(e){const t=e.skills.combat||e.skills.patrol||1,i=.15+t*.05;if(Math.random()<i){const s=1+Math.floor(Math.random()*t*2);this.state.player.gold+=s,this.state.addLog(`${e.name} found ${s}g while patrolling`,"info"),this.state.showToast&&this.state.showToast(`${e.name} found ${s}g patrolling`,"gold",3e3,"ðŸ›¡ï¸")}}processTrading(e){const t=e.skills.trading||1,i=.25+t*.1;if(Math.random()<i){const s=3+t*2;this.state.player.gold+=s,this.state.addLog(`${e.name} made ${s}g trading`,"success"),this.state.showToast&&this.state.showToast(`${e.name} earned ${s}g trading`,"gold",3e3,"ðŸ’°")}}processScouting(e){e.skills.exploration||e.skills.survival,Math.random()<.1&&(this.state.addLog(`${e.name} reports nearby activity`,"info"),this.state.showToast&&this.state.showToast(`${e.name} reports nearby activity`,"info",3e3,"ðŸ”"))}calculateWage(e){return e.level>=fe.WAGE_THRESHOLD_LEVEL||e.guildId&&e.guildRank>0?0:e.wage}calculateHireCost(e,t=null){var r,o,l;const i=t||ye[e.tier]||ye.apprentice;let a=(e.wage||fe.BASE_DAILY_WAGE)*5*i.baseCostMultiplier;a*=1+(e.level-1)*.2,e.guildRank>0&&(a*=1+e.guildRank*.15);const n=(r=this.state)==null?void 0:r.player;if(n){const c=((o=n.attributes)==null?void 0:o.prestige)||0,d=((l=n.attributes)==null?void 0:l.influence)||0,u=Math.min(.3,c*.02),h=Math.min(.2,d*.015);a*=1-u-h}return Math.round(a)}getAvailableTiers(e,t,i){const s=[];for(const[a,n]of Object.entries(ye))e>=n.minSettlementSize&&t>=n.minPrestige&&i>=n.minInfluence&&s.push({...n,tierId:a});return s}selectRandomTier(e,t){var a;const i=e.reduce((n,r)=>n+r.spawnWeight,0);let s=t()*i;for(const n of e)if(s-=n.spawnWeight,s<=0)return n.tierId;return((a=e[0])==null?void 0:a.tierId)||"apprentice"}payWages(){let e=0;const t=[];for(const i of this.citizens){if(i.status!==O.ACTIVE)continue;const s=this.calculateWage(i);s>0&&(e+=s,t.push({citizen:i,wage:s}))}if(this.state.player.gold<e){for(const{citizen:i}of t)i.morale-=20,i.morale<=0&&(this.state.addLog(`${i.name} left due to unpaid wages!`,"error"),this.dismiss(i.uid));this.state.addLog(`Cannot pay wages! (${e}g needed)`,"error")}else{this.state.player.gold-=e;for(const i of this.citizens)i.status===O.ACTIVE&&(i.energy=Math.min(100,i.energy+50));e>0&&this.state.addLog(`Paid ${e}g in wages`,"info")}}awardProfessionXP(e,t,i){var o;const s=this.getCitizenByUid(e);if(!s)return null;s.professionXP||(s.professionXP={agriculture:0,construction:0,medicine:0,tailoring:0,warriors:0,smithing:0,rangers:0});const a=s.professionXP[t]||0,n=this.getProfessionLevel(a);s.professionXP[t]=(s.professionXP[t]||0)+i;const r=this.getProfessionLevel(s.professionXP[t]);if(r>n){const l={agriculture:"Agriculture",construction:"Construction",medicine:"Clerical Medicine",tailoring:"Tailoring",warriors:"Warriors",smithing:"Smithing",rangers:"Rangers"},c=((o=se.PROFESSION_LEVELS[r])==null?void 0:o.title)||"Expert";this.state.addLog(`${s.name} is now a ${c} in ${l[t]}!`,"success"),this.state.showToast&&this.state.showToast(`${s.name}: ${l[t]} Level ${r}!`,"success",4e3,"â¬†ï¸")}return{citizen:s,oldXP:a,newXP:s.professionXP[t],leveledUp:r>n}}getProfessionLevel(e){let t=1;for(let i=7;i>=1;i--)if(e>=se.PROFESSION_LEVELS[i].xp){t=i;break}return t}getCitizenProfessions(e){var s;const t=this.getCitizenByUid(e);if(!t||!t.professionXP)return{};const i={};for(const[a,n]of Object.entries(t.professionXP)){const r=this.getProfessionLevel(n),o=se.PROFESSION_LEVELS[r];i[a]={xp:n,level:r,title:(o==null?void 0:o.title)||"Novice",nextLevelXP:r<7?(s=se.PROFESSION_LEVELS[r+1])==null?void 0:s.xp:null,progress:r<7?(n-o.xp)/(se.PROFESSION_LEVELS[r+1].xp-o.xp):1}}return i}getCitizenSpecialization(e){var n;const t=this.getCitizenByUid(e);if(!t||!t.professionXP)return null;let i=null,s=0;for(const[r,o]of Object.entries(t.professionXP))o>s&&(s=o,i=r);if(!i||s===0)return null;const a=this.getProfessionLevel(s);return{profession:i,xp:s,level:a,title:((n=se.PROFESSION_LEVELS[a])==null?void 0:n.title)||"Novice"}}canBecomeRanger(e){const t=this.getCitizenProfessions(e);if(!t)return{can:!1,reason:"No profession data"};let i=0;for(const[s,a]of Object.entries(t))s!=="rangers"&&a.level>=3&&i++;return i>=3?{can:!0,qualifyingCount:i}:{can:!1,reason:`Need level 3+ in 3 professions (have ${i})`,qualifyingCount:i}}getCitizensByProfession(e,t=1){return this.hiredWorkers.filter(i=>{if(!i.professionXP)return!1;const s=i.professionXP[e]||0;return this.getProfessionLevel(s)>=t})}canInitiate(e){return e?e.level<fe.MIN_INITIATION_LEVEL?{can:!1,reason:`Must be level ${fe.MIN_INITIATION_LEVEL}+ (currently ${e.level})`}:e.guildId?{can:!1,reason:`Already in guild: ${e.guildId}`}:e.status!==O.ACTIVE?{can:!1,reason:`Citizen status: ${e.status}`}:{can:!0}:{can:!1,reason:"Invalid citizen"}}initiateCitizen(e,t){const i=this.getCitizenByUid(e);if(!i)return{success:!1,reason:"Citizen not found"};const s=this.canInitiate(i);return s.can?(i.guildId=t,i.guildRank=1,this.state.addLog(`${i.name} has been initiated into the ${t} guild!`,"success"),this.state.showToast&&this.state.showToast(`${i.name} joined ${t}!`,"success",4e3,"ðŸŽ“"),{success:!0,citizen:i}):{success:!1,reason:s.reason}}promoteInGuild(e){const t=this.getCitizenByUid(e);if(!t||!t.guildId)return{success:!1,reason:"Not in a guild"};if(t.guildRank>=5)return{success:!1,reason:"Already at max rank"};t.guildRank++;const s=["","Initiate","Member","Adept","Veteran","Master"][t.guildRank]||"Unknown";return this.state.addLog(`${t.name} promoted to ${s}!`,"success"),this.state.showToast&&this.state.showToast(`${t.name} is now ${s}!`,"success",4e3,"â¬†ï¸"),{success:!0,newRank:t.guildRank,rankName:s}}getInitiationCandidates(){return this.citizens.filter(e=>this.canInitiate(e).can)}getGuildMembers(e){return this.citizens.filter(t=>t.guildId===e)}setCitizenStatus(e,t,i={}){const s=this.getCitizenByUid(e);if(!s)return!1;const a=s.status;switch(s.status=t,t){case O.INJURED:s.statusTimer=i.recoveryDays||fe.INJURY_RECOVERY_DAYS,this.state.addLog(`${s.name} has been injured!`,"warning");break;case O.IMPRISONED:s.statusTimer=i.rescueDays||fe.RESCUE_TIMER_DAYS,s.captureLocation=i.captureLocation||null,this.state.addLog(`${s.name} has been captured!`,"error");break;case O.MISSING:s.statusTimer=i.searchDays||7,this.state.addLog(`${s.name} has gone missing!`,"warning");break;case O.DEAD:s.statusTimer=0,this.state.addLog(`${s.name} has perished!`,"error"),this.state.showToast&&this.state.showToast(`${s.name} has died!`,"error",5e3,"ðŸ’€");break;case O.ACTIVE:s.statusTimer=0,s.captureLocation=null,a!==O.ACTIVE&&this.state.addLog(`${s.name} has recovered!`,"success");break}return!0}processDailyStatus(){for(const e of this.citizens)if(e.status!==O.ACTIVE&&(e.statusTimer>0&&e.statusTimer--,e.statusTimer<=0))switch(e.status){case O.INJURED:this.setCitizenStatus(e.uid,O.ACTIVE);break;case O.IMPRISONED:this.state.addLog(`${e.name} was sacrificed by captors!`,"error"),this.setCitizenStatus(e.uid,O.DEAD);break;case O.MISSING:this.state.addLog(`${e.name} is presumed dead...`,"error"),this.setCitizenStatus(e.uid,O.DEAD);break}}rescueCitizen(e){const t=this.getCitizenByUid(e);return!t||t.status!==O.IMPRISONED?{success:!1,reason:"Citizen not imprisoned"}:(this.setCitizenStatus(e,O.INJURED,{recoveryDays:1}),t.morale=Math.min(100,t.morale+30),this.state.addLog(`${t.name} has been rescued!`,"success"),this.state.showToast&&this.state.showToast(`Rescued ${t.name}!`,"success",4e3,"ðŸŽ‰"),{success:!0,citizen:t})}getCitizensByStatus(e){return this.citizens.filter(t=>t.status===e)}getActiveCitizens(){return this.citizens.filter(e=>e.status===O.ACTIVE)}seededRandom(e){let t=0;for(let i=0;i<e.length;i++)t=Math.imul(31,t)+e.charCodeAt(i)|0;return function(){return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}getCitizen(e){const t=String(e);return this.hiredWorkers.find(i=>String(i.uid)===t)||this.getCitizenByUid(e)}getCitizensByRole(e){return this.hiredWorkers.filter(t=>t.workerRole===e)}getIdleCitizens(){return this.hiredWorkers.filter(e=>!e.assignment&&(e.energy||100)>=10)}assignToTownTask(e,t,i){const s=this.getCitizenByUid(e);return s&&i.assignCitizenToTask(e,t)?(s.assignment={type:"townTask",taskId:t},s.state="working",this.state.addLog(`${s.name} started working on task`,"info"),!0):!1}unassignFromTownTask(e,t){var a;const i=this.getCitizenByUid(e);if(!i||((a=i.assignment)==null?void 0:a.type)!=="townTask")return!1;const s=i.assignment.taskId;return t.unassignCitizenFromTask(s),i.assignment=null,i.state="idle",this.state.addLog(`${i.name} stopped working on task`,"info"),!0}getRoamingNPCs(){return this.roamingNPCs}processDayChange(){for(const e of this.roamingNPCs)e.lastSeenDay=this.state.day;for(const e of this.roamingNPCs)e.canTrade&&Math.random()<.3&&(e.tradeInventory=this.generateTradeInventory(e.archetype,e.trust))}toJSON(){return{allCitizens:Array.from(this.allCitizens.values()).map(t=>{const{archetypeData:i,workerTemplate:s,...a}=t;return a}),hiredWorkerUids:this.hiredWorkers.map(t=>t.uid),roamingNPCUids:this.roamingNPCs.map(t=>t.uid),uidCounter:this.uidCounter}}fromJSON(e){this.allCitizens.clear(),this.hiredWorkers=[],this.roamingNPCs=[];const t=e.allCitizens||e.citizens||[];for(const a of t)a.archetype&&Me[a.archetype]&&(a.archetypeData=Me[a.archetype]),a.workerRole&&Re[a.workerRole]&&(a.workerTemplate=Re[a.workerRole]),this.allCitizens.set(a.uid,a);const i=e.hiredWorkerUids||[];for(const a of i){const n=this.allCitizens.get(a);n&&this.hiredWorkers.push(n)}const s=e.roamingNPCUids||[];for(const a of s){const n=this.allCitizens.get(a);n&&this.roamingNPCs.push(n)}if(e.citizens&&!e.allCitizens)for(const a of e.citizens)(a.hired||a.isHired)&&(this.allCitizens.set(a.uid,a),this.hiredWorkers.push(a));this.uidCounter=e.uidCounter||0,this.citizens=this.hiredWorkers}damageNPC(e,t){const i=this.getCitizenByUid(e);if(!i||i.isDead)return!1;const s=Math.max(1,t-i.combatStats.defense);return i.combatStats.hp-=s,i.combatStats.hp<=0?(i.combatStats.hp=0,i.isDead=!0,this.state.addLog(`${i.name} has been slain!`,"danger"),!0):(i.combatStats.hp<i.combatStats.maxHp*.3&&Math.random()<.5&&(i.fleeing=!0,this.state.addLog(`${i.name} attempts to flee!`,"warning")),!1)}makeHostile(e,t=""){const i=this.getCitizenByUid(e);i&&(i.isHostile=!0,i.trust=Math.max(0,i.trust-80),t&&this.state.addLog(`${i.name} has become hostile! (${t})`,"danger"))}harvestBodyParts(e){const t=this.getCitizenByUid(e);if(!t||!t.isDead)return[];const i=[],s=[{id:"human_heart",chance:.8},{id:"human_blood",chance:1,quantity:2},{id:"bone_powder",chance:.9,quantity:3},{id:"flesh_sample",chance:.7,quantity:2},{id:"eye_of_victim",chance:.5},{id:"soul_fragment",chance:.3}];for(const a of s)Math.random()<a.chance&&i.push({itemId:a.id,quantity:a.quantity||1});return t.harvested=!0,i}removeDeadNPC(e){const t=this.getCitizenByUid(e);if(!t||!t.isDead)return!1;const i=String(e),s=this.roamingNPCs.findIndex(n=>String(n.uid)===i);s>=0&&this.roamingNPCs.splice(s,1);const a=this.hiredWorkers.findIndex(n=>String(n.uid)===i);return a>=0&&this.hiredWorkers.splice(a,1),this.allCitizens.delete(e),this.allCitizens.delete(i),!0}getCitizensAtPOI(e){const t=[];for(const i of this.roamingNPCs)`${i.currentQ},${i.currentR}`===e&&t.push(i);for(const i of this.hiredWorkers)(i.homeSettlement===e||i.currentLocation===e)&&t.push(i);return t}generateNPCQuest(e,t,i){if(!e.canGiveQuests||!t||e.trust<20)return null;const s=e.questTypes||[];if(s.length===0)return null;const[a,n]=(e.homeSettlement||"0,0").split(",").map(Number),r={q:a,r:n,name:e.originName||"Unknown"};for(const o of s){const l=this.getQuestTemplatesByType(o,t);if(l.length===0)continue;const c=l[Math.floor(Math.random()*l.length)],d=Math.floor(Math.random()*3),u=t.createQuest(c,r,d,i);if(u)return u.fromCitizenUid=e.uid,u.npcName=e.name,e.questsGiven++,u}return null}getQuestTemplatesByType(e,t){const i=(t==null?void 0:t.QUEST_TEMPLATES)||window.QUEST_TEMPLATES||{};switch(e){case"gather":return i.gather||[];case"delivery":return i.delivery||[];case"explore":return i.explore||[];case"combat":return i.combat||[];case"bounty":return i.bounty||[];case"dungeon":return i.dungeon||[];default:return[]}}};me(se,"PROFESSION_LEVELS",{1:{xp:0,title:"Novice"},2:{xp:50,title:"Apprentice"},3:{xp:150,title:"Journeyman"},4:{xp:300,title:"Adept"},5:{xp:500,title:"Expert"},6:{xp:800,title:"Master"},7:{xp:1200,title:"Grandmaster"}});let je=se;const Xe=[{min:75,name:"Paragon",color:"#ffd700"},{min:50,name:"Virtuous",color:"#90EE90"},{min:20,name:"Good",color:"#98FB98"},{min:-19,name:"Neutral",color:"#b0b0b0"},{min:-49,name:"Dubious",color:"#dda0dd"},{min:-74,name:"Corrupt",color:"#cd5c5c"},{min:-100,name:"Malevolent",color:"#8b0000"}],z={merchants:{id:"merchants",name:"Merchant's Coalition",icon:"ðŸ’°",color:"#c4a84b",focus:"trade",description:"Masters of commerce and trade routes",alignment:"neutral",alignmentRequirement:null,perks:{1:{name:"Trade License",description:"+10% sell prices",effect:{sellBonus:.1}},2:{name:"Bulk Discount",description:"-10% buy prices",effect:{buyDiscount:.1}},3:{name:"Caravan Access",description:"Unlock trade caravans",effect:{caravans:!0}},4:{name:"Market Intel",description:"See price trends",effect:{priceIntel:!0}},5:{name:"Trade Empire",description:"+25% all trade profits",effect:{tradeBonus:.25}}},contracts:["bulk_delivery","price_speculation","trade_route"],reputation:{start:0,max:1e3}},explorers:{id:"explorers",name:"Explorer's League",icon:"ðŸ§­",color:"#5a9a7a",focus:"discovery",description:"Cartographers and treasure hunters",alignment:"benevolent",alignmentRequirement:{min:-20},perks:{1:{name:"Trail Blazer",description:"-15% travel time",effect:{travelBonus:.15}},2:{name:"Keen Eye",description:"Auto-discover nearby POIs",effect:{autoDiscover:2}},3:{name:"Dungeon Maps",description:"Access to dungeon locations",effect:{dungeonAccess:!0}},4:{name:"Treasure Sense",description:"+30% loot quality",effect:{lootBonus:.3}},5:{name:"Legendary Explorer",description:"Reveal hidden locations",effect:{hiddenLocations:!0}}},contracts:["survey_area","recover_artifact","map_dungeon"],reputation:{start:0,max:1e3}},artisans:{id:"artisans",name:"Artisan's Circle",icon:"ðŸ”¨",color:"#8a6a4a",focus:"crafting",description:"Master craftsmen and inventors",alignment:"neutral",alignmentRequirement:null,perks:{1:{name:"Quality Materials",description:"+15% craft success",effect:{craftBonus:.15}},2:{name:"Workshop Access",description:"Use guild workshops",effect:{workshops:!0}},3:{name:"Secret Recipes",description:"Unlock rare recipes",effect:{rareRecipes:!0}},4:{name:"Material Efficiency",description:"-20% material cost",effect:{materialSave:.2}},5:{name:"Masterwork",description:"Chance for masterwork items",effect:{masterwork:.1}}},contracts:["craft_order","repair_equipment","research_recipe"],reputation:{start:0,max:1e3}},mercenaries:{id:"mercenaries",name:"Iron Company",icon:"âš”ï¸",color:"#6a5a5a",focus:"combat",description:"Soldiers of fortune and dungeon delvers",alignment:"neutral",alignmentRequirement:null,perks:{1:{name:"Combat Training",description:"+15% damage",effect:{damageBonus:.15}},2:{name:"Dungeon Contracts",description:"Access dungeon raids",effect:{dungeonRaids:!0}},3:{name:"Battle Hardened",description:"-15% damage taken",effect:{damageReduction:.15}},4:{name:"Siege Tactics",description:"Participate in sieges",effect:{siegeAccess:!0}},5:{name:"War Leader",description:"Command mercenary squads",effect:{squads:!0}}},contracts:["bounty_hunt","dungeon_clear","escort_mission","siege_assault"],reputation:{start:0,max:1e3}},shadows:{id:"shadows",name:"Shadow Council",icon:"ðŸ—¡ï¸",color:"#4a4a6a",focus:"political",description:"Spies, assassins, and puppet masters",alignment:"chaotic",alignmentRequirement:{max:20},perks:{1:{name:"Whisper Network",description:"Hear rumors and secrets",effect:{rumors:!0}},2:{name:"Hidden Paths",description:"Access secret routes",effect:{secretPaths:!0}},3:{name:"Blackmail",description:"Influence faction leaders",effect:{blackmail:!0}},4:{name:"Sabotage",description:"Disrupt enemy operations",effect:{sabotage:!0}},5:{name:"Kingmaker",description:"Control faction politics",effect:{kingmaker:!0}}},contracts:["gather_intel","assassination","steal_document","frame_target"],reputation:{start:0,max:1e3}},ether:{id:"ether",name:"Ether Conclave",icon:"âœ¨",color:"#7a5a9a",focus:"magic",description:"Arcanists and ether manipulators",alignment:"neutral",alignmentRequirement:null,perks:{1:{name:"Ether Attunement",description:"+20% max ether",effect:{etherBonus:.2}},2:{name:"Enchanting",description:"Enchant items",effect:{enchanting:!0}},3:{name:"Ether Nodes",description:"Harvest ether nodes",effect:{etherNodes:!0}},4:{name:"Spell Research",description:"Learn new spells",effect:{spells:!0}},5:{name:"Archmage",description:"Master-level magic",effect:{archmage:!0}}},contracts:["harvest_ether","enchant_item","seal_rift","arcane_research"],reputation:{start:0,max:1e3}}},ve=[{rank:1,name:"Initiate",rep:0},{rank:2,name:"Member",rep:100},{rank:3,name:"Adept",rep:300},{rank:4,name:"Veteran",rep:600},{rank:5,name:"Master",rep:1e3}];class Ht{constructor(e){this.state=e,this.memberships={},this.activeContracts=[],this.completedContracts=[],this.poiContracts=new Map}canJoinByAlignment(e){const t=z[e];if(!t||!t.alignmentRequirement)return!0;const i=this.state.player.alignment,s=t.alignmentRequirement;return!(s.min!==void 0&&i<s.min||s.max!==void 0&&i>s.max)}getAlignmentTier(){const e=this.state.player.alignment;for(const t of Xe)if(e>=t.min)return t;return Xe[Xe.length-1]}modifyAlignment(e,t=""){if(this.state.player.alignmentLock>0)return!1;const i=this.state.player.alignment,s=this.getAlignmentTier();this.state.player.alignment=Math.max(-100,Math.min(100,i+e));const a=this.getAlignmentTier();if(s.name!==a.name){const n=e>0?"risen to":"fallen to";this.state.addLog(`Your alignment has ${n} ${a.name}!`,e>0?"success":"warning")}else if(t){const n=e>0?"+":"";this.state.addLog(`${t} (${n}${e} alignment)`,e>0?"info":"warning")}return this.state.notify(),!0}lockAlignment(e){this.state.player.alignmentLock=e}decrementAlignmentLock(){this.state.player.alignmentLock>0&&this.state.player.alignmentLock--}join(e){if(this.memberships[e])return this.state.addLog("Already a member of this guild","warning"),!1;const t=z[e];return t?this.canJoinByAlignment(e)?e==="shadows"&&this.memberships.mercenaries?(this.state.addLog("Iron Company members cannot join Shadow Council","warning"),!1):(this.memberships[e]={reputation:t.reputation.start,rank:1,joinedDay:this.state.day},this.state.addLog(`Joined ${t.name}!`,"success"),this.state.notify(),!0):(t.alignmentRequirement.min!==void 0?this.state.addLog(`Your alignment is too chaotic to join ${t.name}`,"warning"):this.state.addLog(`Your alignment is too benevolent to join ${t.name}`,"warning"),!1):!1}leave(e){if(!this.memberships[e])return!1;const t=z[e];return delete this.memberships[e],this.activeContracts=this.activeContracts.filter(i=>i.guildId!==e),this.state.addLog(`Left ${t.name}`,"info"),this.state.notify(),!0}addReputation(e,t){if(!this.memberships[e])return;const i=this.memberships[e],s=z[e];i.reputation=Math.min(s.reputation.max,Math.max(0,i.reputation+t));const a=this.calculateRank(i.reputation);if(a>i.rank){i.rank=a;const n=ve.find(o=>o.rank===a).name;this.state.addLog(`Promoted to ${n} in ${s.name}!`,"success");const r=s.perks[a];r&&this.state.addLog(`Unlocked: ${r.name}`,"success")}this.state.notify()}calculateRank(e){let t=1;for(const i of ve)e>=i.rep&&(t=i.rank);return t}getRankName(e){const t=this.memberships[e];if(!t)return null;const i=ve.find(s=>s.rank===t.rank);return i?i.name:"Unknown"}getRank(e){const t=this.memberships[e];return t?ve.find(i=>i.rank===t.rank)||ve[0]:null}getNextRank(e){const t=this.memberships[e];if(!t)return null;const i=ve.find(s=>s.rank===t.rank+1);return i?{...i,repRequired:i.rep}:null}getCurrentPerks(e){return this.getActivePerks(e).map(i=>`${i.name}: ${i.description}`)}getActivePerks(e){const t=this.memberships[e];if(!t)return[];const i=z[e],s=[];for(let a=1;a<=t.rank;a++)i.perks[a]&&s.push(i.perks[a]);return s}getAllEffects(){const e={};for(const[t,i]of Object.entries(this.memberships)){const s=this.getActivePerks(t);for(const a of s)for(const[n,r]of Object.entries(a.effect))typeof r=="number"?e[n]=(e[n]||0)+r:e[n]=r}return e}generateContracts(e,t){const i=this.memberships[e];if(!i)return[];const s=`${t.id}_${e}`,a=this.state.day,n=this.poiContracts.get(s);if(n&&n.day===a)return n.contracts.filter(c=>!this.activeContracts.find(d=>d.id===c.id));const r=z[e],o=[],l=Math.min(3,Math.max(1,i.rank));for(let c=0;c<l;c++){const d=r.contracts[Math.floor(Math.random()*r.contracts.length)],u=this.createContract(e,d,i.rank);o.push(u)}return this.poiContracts.set(s,{contracts:o,day:a}),o}createContract(e,t,i){const s=20+i*15,a=10+i*5,n={bulk_delivery:{name:"Bulk Delivery",description:"Deliver goods to a settlement",objective:{type:"deliver",item:"trade_goods",amount:5+i*2},reward:{gold:s*1.2,reputation:a}},price_speculation:{name:"Price Speculation",description:"Buy low, sell high",objective:{type:"profit",amount:s*2},reward:{gold:s,reputation:a*1.5}},survey_area:{name:"Survey Area",description:"Explore and map a region",objective:{type:"explore",hexes:5+i*3},reward:{gold:s*.8,reputation:a*1.2}},recover_artifact:{name:"Recover Artifact",description:"Retrieve a lost artifact from ruins",objective:{type:"dungeon",clear:!0},reward:{gold:s*1.5,reputation:a*1.5}},bounty_hunt:{name:"Bounty Hunt",description:"Eliminate a dangerous target",objective:{type:"kill",target:"bandit_leader",count:1},reward:{gold:s*1.5,reputation:a}},dungeon_clear:{name:"Dungeon Assault",description:"Clear a dungeon of threats",objective:{type:"dungeon",clear:!0},reward:{gold:s*2,reputation:a*2}},siege_assault:{name:"Siege Assault",description:"Participate in a siege battle",objective:{type:"siege",contribution:100},reward:{gold:s*3,reputation:a*3}},gather_intel:{name:"Gather Intelligence",description:"Spy on a faction",objective:{type:"spy",faction:"random",intel:3},reward:{gold:s,reputation:a*1.5}},assassination:{name:"Silent Removal",description:"Eliminate a target discreetly",objective:{type:"assassinate",target:"noble"},reward:{gold:s*2.5,reputation:a*2}},craft_order:{name:"Guild Order",description:"Craft items for the guild",objective:{type:"craft",item:"tools",amount:3+i},reward:{gold:s,reputation:a}},harvest_ether:{name:"Ether Harvest",description:"Collect ether from nodes",objective:{type:"gather",resource:"ether",amount:10+i*5},reward:{gold:s*.8,reputation:a*1.2}},seal_rift:{name:"Seal Rift",description:"Close an unstable ether rift",objective:{type:"dungeon",riftSeal:!0},reward:{gold:s*1.8,reputation:a*2}}},r=n[t]||n.bulk_delivery,o=15+i*10;return{id:`${e}_${t}_${Date.now()}`,guildId:e,type:t,...r,reward:{...r.reward,experience:o},objective:{...r.objective,current:0},rank:i,expiresDay:this.state.day+7,accepted:!1}}acceptContract(e){return this.activeContracts.length>=3?(this.state.addLog("Too many active contracts (max 3)","warning"),!1):(e.accepted=!0,e.acceptedDay=this.state.day,this.activeContracts.push(e),this.state.addLog(`Accepted: ${e.name}`,"success"),this.state.notify(),!0)}completeContract(e){const t=this.activeContracts.findIndex(a=>a.id===e);if(t===-1)return!1;const i=this.activeContracts[t],s=[];return i.reward.gold&&(this.state.player.gold+=Math.floor(i.reward.gold),s.push(`+${Math.floor(i.reward.gold)}g`)),i.reward.reputation&&(this.addReputation(i.guildId,Math.floor(i.reward.reputation)),s.push(`+${Math.floor(i.reward.reputation)} rep`)),i.reward.experience&&(this.state.player.experience=(this.state.player.experience||0)+i.reward.experience,s.push(`+${i.reward.experience} XP`)),this.activeContracts.splice(t,1),this.completedContracts.push({...i,completedDay:this.state.day}),z[i.guildId],this.state.addLog(`Guild Contract Completed: ${i.name} (${s.join(", ")})`,"success"),this.state.showToast&&this.state.showToast(`Contract Complete: ${i.name}!`,"success",4e3,"âœ“"),$.playQuestComplete(),this.state.notify(),!0}abandonContract(e){const t=this.activeContracts.findIndex(s=>s.id===e);if(t===-1)return!1;const i=this.activeContracts[t];return this.activeContracts.splice(t,1),this.addReputation(i.guildId,-i.reward.reputation),this.state.addLog(`Abandoned: ${i.name} (reputation lost)`,"warning"),this.state.notify(),!0}checkExpiredContracts(){const e=this.activeContracts.filter(t=>this.state.day>t.expiresDay);for(const t of e)this.abandonContract(t.id),this.state.addLog(`Contract expired: ${t.name}`,"warning")}updateContractProgress(e,t={}){for(const i of this.activeContracts){const s=i.objective;let a=!1;switch(s.type){case"explore":e==="explore"&&(s.current=(s.current||0)+1,a=!0);break;case"kill":e==="kill"&&(s.current=(s.current||0)+1,a=!0);break;case"dungeon":e==="dungeon_clear"&&(s.current=1,a=!0);break;case"gather":e==="gather"&&t.resource&&(s.resource==="ether"&&t.resource.includes("ether")||t.resource===s.resource)&&(s.current=(s.current||0)+(t.amount||1),a=!0);break;case"deliver":e==="deliver"&&(s.current=(s.current||0)+(t.amount||1),a=!0);break;case"profit":e==="trade_profit"&&(s.current=(s.current||0)+(t.profit||0),a=!0);break}a&&this.isContractComplete(i)&&this.completeContract(i.id)}}isContractComplete(e){const t=e.objective,i=t.current||0;let s=1;return t.amount?s=t.amount:t.count?s=t.count:t.hexes?s=t.hexes:t.clear&&(s=1),i>=s}getContractProgress(e){const t=e.objective,i=t.current||0;let s=1;return t.amount?s=t.amount:t.count?s=t.count:t.hexes?s=t.hexes:t.clear&&(s=1),Math.min(100,Math.floor(i/s*100))}isMember(e){return!!this.memberships[e]}getAllMemberships(){return Object.entries(this.memberships).map(([e,t])=>({guild:z[e],...t}))}toJSON(){return{memberships:this.memberships,activeContracts:this.activeContracts,completedContracts:this.completedContracts}}fromJSON(e){this.memberships=e.memberships||{},this.activeContracts=e.activeContracts||[],this.completedContracts=e.completedContracts||[]}}const Ce=[{rank:1,name:"Initiate",rep:0},{rank:2,name:"Acolyte",rep:100},{rank:3,name:"Devotee",rep:300},{rank:4,name:"Disciple",rep:600},{rank:5,name:"High Priest",rep:1e3}],ie={void_seekers:{id:"void_seekers",name:"Seekers of the Void",icon:"ðŸŒ‘",color:"#1a0a2e",focus:"destruction",description:"Those who embrace the emptiness between worlds",alignment:"chaotic",alignmentRequirement:{max:20},perks:{1:{name:"Void Touch",description:"+10% dark damage",effect:{darkDamage:.1}},2:{name:"Nihil Sight",description:"See hidden enemies",effect:{seeHidden:!0}},3:{name:"Ritual Access",description:"Perform void rituals",effect:{voidRituals:!0}},4:{name:"Entropy Aura",description:"-20% enemy defense",effect:{enemyDefenseDebuff:.2}},5:{name:"Void Avatar",description:"Transform into void entity",effect:{voidForm:!0}}},rituals:["void_meditation","dark_offering","summon_shade"],reputation:{start:0,max:1e3}},blood_covenant:{id:"blood_covenant",name:"Blood Covenant",icon:"ðŸ©¸",color:"#4a0000",focus:"sacrifice",description:"Power through blood and sacred offerings",alignment:"chaotic",alignmentRequirement:{max:10},perks:{1:{name:"Blood Rite",description:"Convert HP to ether",effect:{bloodRite:!0}},2:{name:"Scarlet Shield",description:"+15% HP regen from kills",effect:{killRegen:.15}},3:{name:"Sacrifice",description:"Sacrifice NPCs at altars",effect:{canSacrifice:!0}},4:{name:"Blood Bond",description:"Link HP with allies",effect:{bloodBond:!0}},5:{name:"Crimson Lord",description:"Gain power from all nearby deaths",effect:{deathHarvest:!0}}},rituals:["blood_offering","sacrifice_npc","crimson_pact"],reputation:{start:0,max:1e3}},whispering_shadow:{id:"whispering_shadow",name:"Whispering Shadow",icon:"ðŸ‘ï¸",color:"#2a2a4a",focus:"corruption",description:"Masters of manipulation and dark influence",alignment:"chaotic",alignmentRequirement:{max:15},perks:{1:{name:"Silver Tongue",description:"+20% persuasion",effect:{persuasion:.2}},2:{name:"Shadow Step",description:"Move unseen at night",effect:{nightStealth:!0}},3:{name:"Corrupt Mind",description:"Turn NPCs to your cause",effect:{canCorrupt:!0}},4:{name:"Fear Aura",description:"Enemies may flee",effect:{fearAura:!0}},5:{name:"Puppetmaster",description:"Control faction politics",effect:{puppetmaster:!0}}},rituals:["shadow_whisper","mind_corruption","puppet_ritual"],reputation:{start:0,max:1e3}},flesh_weavers:{id:"flesh_weavers",name:"Order of Flesh Weavers",icon:"ðŸ§¬",color:"#3a2a1a",focus:"transformation",description:"Sculptors of living tissue and forbidden knowledge",alignment:"chaotic",alignmentRequirement:{max:5},perks:{1:{name:"Flesh Craft",description:"Craft from body parts",effect:{fleshCraft:!0}},2:{name:"Regeneration",description:"+25% healing received",effect:{healingBonus:.25}},3:{name:"Harvest",description:"Extract parts from fallen",effect:{canHarvest:!0}},4:{name:"Chimera Form",description:"Temporary mutations",effect:{chimeraForm:!0}},5:{name:"Flesh Architect",description:"Create living constructs",effect:{constructs:!0}}},rituals:["flesh_offering","graft_ritual","construct_creation"],reputation:{start:0,max:1e3}}},st={void_meditation:{id:"void_meditation",name:"Void Meditation",description:"Commune with the emptiness",cultId:"void_seekers",minRank:1,cost:{ether:20},reward:{reputation:15,alignment:-3},cooldownHours:24},dark_offering:{id:"dark_offering",name:"Dark Offering",description:"Sacrifice items to the void",cultId:"void_seekers",minRank:2,cost:{items:{type:"any",value:50}},reward:{reputation:25,alignment:-5,ether:30},cooldownHours:12},summon_shade:{id:"summon_shade",name:"Summon Shade",description:"Call forth a shadow ally",cultId:"void_seekers",minRank:3,cost:{ether:50,playerHealth:20},reward:{reputation:40,alignment:-8,summon:"shade"},cooldownHours:48},blood_offering:{id:"blood_offering",name:"Blood Offering",description:"Spill your own blood for power",cultId:"blood_covenant",minRank:1,cost:{playerHealth:30},reward:{reputation:20,alignment:-5},cooldownHours:12},sacrifice_npc:{id:"sacrifice_npc",name:"Blood Sacrifice",description:"Offer a living soul to the covenant",cultId:"blood_covenant",minRank:3,cost:{npc:"citizen"},reward:{reputation:100,alignment:-25,gold:500},cooldownHours:72,witnessRisk:!0},crimson_pact:{id:"crimson_pact",name:"Crimson Pact",description:"Bind your life force for great power",cultId:"blood_covenant",minRank:4,cost:{playerHealth:50,maxHealthPermanent:10},reward:{reputation:80,alignment:-15,permanentDamage:5},cooldownHours:168},shadow_whisper:{id:"shadow_whisper",name:"Shadow Whisper",description:"Spread rumors and discord",cultId:"whispering_shadow",minRank:1,cost:{gold:20},reward:{reputation:15,alignment:-3},cooldownHours:24},mind_corruption:{id:"mind_corruption",name:"Mind Corruption",description:"Plant dark thoughts in an NPC",cultId:"whispering_shadow",minRank:3,cost:{ether:40,gold:50},reward:{reputation:50,alignment:-12,corruptedNpc:!0},cooldownHours:48},puppet_ritual:{id:"puppet_ritual",name:"Puppet Ritual",description:"Take full control of a weak mind",cultId:"whispering_shadow",minRank:5,cost:{ether:100,gold:200},reward:{reputation:120,alignment:-30,puppet:!0},cooldownHours:168},flesh_offering:{id:"flesh_offering",name:"Flesh Offering",description:"Offer harvested viscera to the Order",cultId:"flesh_weavers",minRank:1,cost:{items:{category:"viscera",count:3}},reward:{reputation:30,alignment:-8},cooldownHours:24},graft_ritual:{id:"graft_ritual",name:"Graft Ritual",description:"Permanently enhance your body with flesh",cultId:"flesh_weavers",minRank:3,cost:{items:{category:"viscera",count:5},playerHealth:40},reward:{reputation:60,alignment:-15,permanentStat:!0},cooldownHours:72},construct_creation:{id:"construct_creation",name:"Construct Creation",description:"Build a living servant from humanoid parts",cultId:"flesh_weavers",minRank:5,cost:{items:{category:"cult_material",count:5},ether:80},reward:{reputation:150,alignment:-35,construct:!0},cooldownHours:168}};class Nt{constructor(e,t){this.state=e,this.guildManager=t,this.memberships={},this.ritualCooldowns=new Map,this.sacrificeHistory=[],this.witnessedBy=new Set}canJoinByAlignment(e){const t=ie[e];if(!t||!t.alignmentRequirement)return!0;const i=this.state.player.alignment,s=t.alignmentRequirement;return!(s.min!==void 0&&i<s.min||s.max!==void 0&&i>s.max)}join(e){if(this.memberships[e])return{success:!1,message:"Already a member of this cult"};const t=ie[e];return t?this.canJoinByAlignment(e)?(this.memberships[e]={reputation:t.reputation.start,rank:1,joinedDay:this.state.day},this.guildManager.modifyAlignment(-5,`Joined ${t.name}`),this.state.notify(),{success:!0,message:`Joined ${t.name}... ${t.icon}`}):{success:!1,message:`Your alignment is too benevolent to join ${t.name}`}:{success:!1,message:"Unknown cult"}}leave(e){if(!this.memberships[e])return{success:!1,message:"Not a member of this cult"};const t=ie[e];return delete this.memberships[e],this.guildManager.modifyAlignment(10,"Left the darkness behind"),this.state.notify(),{success:!0,message:`Betrayed ${t.name}! They will remember...`}}addReputation(e,t){if(!this.memberships[e])return;const i=this.memberships[e],s=ie[e];i.reputation=Math.min(s.reputation.max,Math.max(0,i.reputation+t));const a=this.calculateRank(i.reputation);if(a>i.rank){i.rank=a;const n=Ce.find(o=>o.rank===a).name;this.state.addLog(`Promoted to ${n} in ${s.name}!`,"success");const r=s.perks[a];r&&this.state.addLog(`Unlocked: ${r.name}`,"success")}this.state.notify()}calculateRank(e){let t=1;for(const i of Ce)e>=i.rep&&(t=i.rank);return t}getRankName(e){const t=this.memberships[e];if(!t)return null;const i=Ce.find(s=>s.rank===t.rank);return i?i.name:"Unknown"}getMembership(e){return this.memberships[e]||null}getRank(e){const t=this.memberships[e];return t?t.rank:0}getNextRankThreshold(e){const t=this.memberships[e];if(!t)return null;const i=t.rank+1,s=Ce.find(a=>a.rank===i);return s?s.rep:null}isRitualOnCooldown(e){const t=this.ritualCooldowns.get(e);return t&&this.state.tick<t}canJoin(e){return this.memberships[e]?!1:this.canJoinByAlignment(e)}getAllMemberships(){return this.memberships}getActivePerks(e){const t=this.memberships[e];if(!t)return[];const i=ie[e],s=[];for(let a=1;a<=t.rank;a++)i.perks[a]&&s.push(i.perks[a]);return s}getAllEffects(){const e={};for(const[t,i]of Object.entries(this.memberships)){const s=this.getActivePerks(t);for(const a of s)for(const[n,r]of Object.entries(a.effect))typeof r=="number"?e[n]=(e[n]||0)+r:e[n]=r}return e}canPerformRitual(e){const t=st[e];if(!t)return{can:!1,reason:"Unknown ritual"};const i=this.memberships[t.cultId];if(!i)return{can:!1,reason:`Not a member of ${ie[t.cultId].name}`};if(i.rank<t.minRank)return{can:!1,reason:`Requires ${Ce.find(r=>r.rank===t.minRank).name} rank`};const s=this.ritualCooldowns.get(e);if(s&&this.state.tick<s)return{can:!1,reason:`On cooldown (${Math.ceil((s-this.state.tick)/this.state.ticksPerHour)}h remaining)`};const a=t.cost;if(a.playerHealth&&this.state.player.health<=a.playerHealth)return{can:!1,reason:"Not enough health"};if(a.ether&&this.state.player.ether<a.ether)return{can:!1,reason:"Not enough ether"};if(a.gold&&this.state.player.gold<a.gold)return{can:!1,reason:"Not enough gold"};if(a.items){const n=this.checkItemCost(a.items);if(!n.has)return{can:!1,reason:n.reason}}return{can:!0}}checkItemCost(e){if(!this.state.inventory)return{has:!1,reason:"No inventory access"};if(e.category){const i=this.countItemsByCategory(e.category);return i<e.count?{has:!1,reason:`Need ${e.count} ${e.category} items (have ${i})`}:{has:!0,items:this.getItemsByCategory(e.category,e.count)}}if(e.type==="any"&&e.value){const i=this.getTotalInventoryValue();return i<e.value?{has:!1,reason:`Need items worth ${e.value}g (have ${i}g)`}:{has:!0,value:e.value}}return{has:!0}}countItemsByCategory(e){const t=this.state.inventory;if(!t)return 0;let i=0;for(const[s,a]of t.items){const n=D[s];n&&n.category===e&&(i+=a)}return i}getItemsByCategory(e,t){const i=this.state.inventory;if(!i)return[];const s=[];let a=t;for(const[n,r]of i.items){if(a<=0)break;const o=D[n];if(o&&o.category===e){const l=Math.min(r,a);s.push({itemId:n,count:l}),a-=l}}return s}getTotalInventoryValue(){const e=this.state.inventory;if(!e)return 0;let t=0;for(const[i,s]of e.items){const a=D[i];a&&(t+=a.value*s)}return t}consumeItemCost(e){const t=this.state.inventory;if(t){if(e.category){const i=this.getItemsByCategory(e.category,e.count);for(const{itemId:s,count:a}of i)t.remove(s,a);return}if(e.type==="any"&&e.value){let i=e.value;const s=[],a=[...t.items.entries()].map(([n,r])=>{var o;return{id:n,qty:r,value:((o=D[n])==null?void 0:o.value)||0}}).sort((n,r)=>n.value-r.value);for(const{id:n,qty:r,value:o}of a){if(i<=0)break;const l=Math.ceil(i/o),c=Math.min(r,l);s.push({id:n,count:c}),i-=c*o}for(const{id:n,count:r}of s)t.remove(n,r)}}}performRitual(e,t=null,i=null){const s=this.canPerformRitual(e);if(!s.can)return{success:!1,message:s.reason};const a=st[e],n=ie[a.cultId];a.cost.playerHealth&&(this.state.player.health-=a.cost.playerHealth),a.cost.ether&&(this.state.player.ether-=a.cost.ether),a.cost.gold&&(this.state.player.gold-=a.cost.gold),a.cost.maxHealthPermanent&&(this.state.player.maxHealth-=a.cost.maxHealthPermanent,this.state.player.health=Math.min(this.state.player.health,this.state.player.maxHealth)),a.cost.items&&this.consumeItemCost(a.cost.items),a.reward.reputation&&this.addReputation(a.cultId,a.reward.reputation),a.reward.alignment&&this.guildManager.modifyAlignment(a.reward.alignment,`Performed ${a.name}`),a.reward.gold&&(this.state.player.gold+=a.reward.gold),a.reward.ether&&(this.state.player.ether=Math.min(this.state.player.maxEther,this.state.player.ether+a.reward.ether)),a.reward.permanentDamage&&(this.state.player.permanentDamageBonus=(this.state.player.permanentDamageBonus||0)+a.reward.permanentDamage);const r=a.cooldownHours*this.state.ticksPerHour;return this.ritualCooldowns.set(e,this.state.tick+r),this.state.notify(),{success:!0,message:`Performed ${a.name}... ${n.icon}`}}sacrificeNPC(e,t){const i=this.memberships.blood_covenant;return!i||i.rank<3?{success:!1,message:"Requires Devotee rank in Blood Covenant"}:(this.sacrificeHistory.push({npcUid:e,day:this.state.day,tick:this.state.tick}),this.addReputation("blood_covenant",100),this.guildManager.modifyAlignment(-25,"Sacrificed a soul"),this.state.player.gold+=500,this.guildManager.lockAlignment(3),this.state.notify(),{success:!0,message:"The sacrifice is complete... ðŸ©¸"})}canHarvest(){const e=this.memberships.flesh_weavers;return e&&e.rank>=3}checkForWitnesses(e,t){if(!e||!t)return[];const i=[],s=`${e.q},${e.r}`,a=t.getCitizensAtPOI(s);for(const n of a)Math.random()<.7&&(i.push(n),this.witnessedBy.add(n.uid));return i.length>0&&this.state.addLog(`Your dark deed was witnessed by ${i.length} soul(s)!`,"danger"),i}isMember(e){return!!this.memberships[e]}getAllMemberships(){return Object.entries(this.memberships).map(([e,t])=>({cult:ie[e],...t}))}hasWitnessed(e){return this.witnessedBy.has(e)}toJSON(){return{memberships:this.memberships,ritualCooldowns:[...this.ritualCooldowns.entries()],sacrificeHistory:this.sacrificeHistory,witnessedBy:[...this.witnessedBy]}}fromJSON(e){this.memberships=e.memberships||{},this.ritualCooldowns=new Map(e.ritualCooldowns||[]),this.sacrificeHistory=e.sacrificeHistory||[],this.witnessedBy=new Set(e.witnessedBy||[])}}class zt{constructor(e,t,i){this.state=e,this.grid=t,this.pois=i,this.horseRange=15,this.carriageRange=40,this.horseCostPerHex=1,this.carriageCostPerHex=2,this.horseMinCost=5,this.carriageMinCost=15}getFacilityBonuses(e){var s;if(!e||!((s=this.state)!=null&&s.getFacilityEffects))return{costReduction:0,speedBonus:0};const t=`${e.q},${e.r}`,i=this.state.getFacilityEffects(t);return{costReduction:i.travelCostReduction||0,speedBonus:i.travelSpeedBonus||0}}hexDistance(e,t,i,s){return Math.max(Math.abs(e-i),Math.abs(t-s),Math.abs(e+t-(i+s)))}getDestinations(e){if(!e)return{horse:[],carriage:[]};const t=e.q,i=e.r,s=this.getFacilityBonuses(e),a=1-s.costReduction,n=1+s.speedBonus,r=[],o=[];for(const l of this.pois){if(l.q===t&&l.r===i||!this.isValidDestination(l))continue;const c=this.hexDistance(t,i,l.q,l.r);if(c<3)continue;const d=this.calculateTravelTime(c),u={poi:l,distance:c,travelTime:Math.max(1,Math.floor(d/n))};if(c<=this.horseRange){const h=Math.max(this.horseMinCost,c*this.horseCostPerHex);u.cost=Math.floor(h*a),u.baseCost=h,u.type="horse",u.icon="ðŸ´",r.push(u)}else if(c<=this.carriageRange){const h=Math.max(this.carriageMinCost,c*this.carriageCostPerHex);u.cost=Math.floor(h*a),u.baseCost=h,u.type="carriage",u.icon="ðŸ›’",o.push(u)}}return r.sort((l,c)=>l.distance-c.distance),o.sort((l,c)=>l.distance-c.distance),{horse:r,carriage:o,hasStableBonus:s.costReduction>0||s.speedBonus>0}}isValidDestination(e){if(e.type.category==="settlement")return!0;const t=["castle","fortress","keep","temple","tower"];return!!(e.type.category==="landmark"&&t.includes(e.type.id))}calculateTravelTime(e){return e<=this.horseRange?Math.max(1,Math.floor(e/5)):Math.max(2,Math.floor(e/4))}travel(e){const t=this.state.player;if(t.gold<e.cost)return this.state.addLog(`Not enough gold (${e.cost}g required)`,"warning"),!1;t.gold-=e.cost,t.position={q:e.poi.q,r:e.poi.r},t.currentPOI=e.poi,e.poi.id&&this.state.discoverPOI(e.poi.id,e.poi);const i=e.type==="horse"?"Rode":"Traveled by carriage";return this.state.addLog(`${i} to ${e.poi.name} (-${e.cost}g)`,"travel"),this.state.notify(),e.travelTime}}const Ke={cave:{name:"Natural Cave",floorBiome:I.CAVE_FLOOR,wallBiome:I.CAVE_WALL,accentBiomes:[I.UNDERGROUND_WATER,I.CRYSTAL_FLOOR,I.MOSSY_STONE],caveiness:.55,enemies:["BAT","SPIDER","CAVE_TROLL"],lootTable:"cave_loot"},mine:{name:"Abandoned Mine",floorBiome:I.STONE_FLOOR,wallBiome:I.DUNGEON_WALL,accentBiomes:[I.RUBBLE,I.CAVE_FLOOR],caveiness:.5,enemies:["GOBLIN","RAT","UNDEAD_MINER"],lootTable:"mine_loot"},shrine:{name:"Sacred Shrine",floorBiome:I.SHRINE_FLOOR,wallBiome:I.DUNGEON_WALL,accentBiomes:[I.MOSSY_STONE,I.CRYSTAL_FLOOR],caveiness:.48,enemies:["SPIRIT","GUARDIAN"],lootTable:"shrine_loot"},ruins:{name:"Ancient Ruins",floorBiome:I.STONE_FLOOR,wallBiome:I.DUNGEON_WALL,accentBiomes:[I.RUBBLE,I.MOSSY_STONE],caveiness:.52,enemies:["SKELETON","GHOST","CONSTRUCT"],lootTable:"ruins_loot"},temple:{name:"Forgotten Temple",floorBiome:I.SHRINE_FLOOR,wallBiome:I.DUNGEON_WALL,accentBiomes:[I.CRYSTAL_FLOOR,I.MOSSY_STONE],caveiness:.5,enemies:["CULTIST","DEMON","GUARDIAN"],lootTable:"temple_loot"},fortress:{name:"Ruined Fortress",floorBiome:I.STONE_FLOOR,wallBiome:I.DUNGEON_WALL,accentBiomes:[I.RUBBLE],caveiness:.45,enemies:["BANDIT","KNIGHT","WARLORD"],lootTable:"fortress_loot"},keep:{name:"Abandoned Keep",floorBiome:I.STONE_FLOOR,wallBiome:I.DUNGEON_WALL,accentBiomes:[I.RUBBLE,I.MOSSY_STONE],caveiness:.48,enemies:["BANDIT","SKELETON","GHOST"],lootTable:"ruins_loot"},castle:{name:"Haunted Castle",floorBiome:I.STONE_FLOOR,wallBiome:I.DUNGEON_WALL,accentBiomes:[I.RUBBLE,I.SHRINE_FLOOR],caveiness:.46,enemies:["GHOST","KNIGHT","WARLORD"],lootTable:"fortress_loot"},forest_grove:{name:"Enchanted Grove",floorBiome:I.MOSSY_STONE,wallBiome:I.CAVE_WALL,accentBiomes:[I.UNDERGROUND_WATER,I.CRYSTAL_FLOOR],caveiness:.58,enemies:["SPIRIT","FOREST_BEAST"],lootTable:"shrine_loot"}},Ft={cave_loot:{common:[{id:"iron_ore",name:"Iron Ore",value:5},{id:"coal",name:"Coal",value:3},{id:"crystal_shard",name:"Crystal Shard",value:8}],uncommon:[{id:"silver_ore",name:"Silver Ore",value:15},{id:"amethyst",name:"Amethyst",value:25},{id:"bat_wing",name:"Bat Wing",value:10}],rare:[{id:"gold_nugget",name:"Gold Nugget",value:50},{id:"ruby",name:"Ruby",value:80},{id:"cave_pearl",name:"Cave Pearl",value:100}]},mine_loot:{common:[{id:"iron_ore",name:"Iron Ore",value:5},{id:"copper_ore",name:"Copper Ore",value:4},{id:"coal",name:"Coal",value:3}],uncommon:[{id:"silver_ore",name:"Silver Ore",value:15},{id:"gold_dust",name:"Gold Dust",value:30},{id:"old_pickaxe",name:"Old Pickaxe",value:20}],rare:[{id:"mithril_ore",name:"Mithril Ore",value:120},{id:"diamond",name:"Diamond",value:150},{id:"ancient_coin",name:"Ancient Coin",value:75}]},shrine_loot:{common:[{id:"incense",name:"Incense",value:5},{id:"candle",name:"Blessed Candle",value:8},{id:"blessed_water",name:"Blessed Water",value:50}],uncommon:[{id:"blessing_scroll",name:"Blessing Scroll",value:35},{id:"spirit_essence",name:"Spirit Essence",value:45},{id:"purifying_crystal",name:"Purifying Crystal",value:180}],rare:[{id:"sacred_chalice",name:"Sacred Chalice",value:200},{id:"holy_relic",name:"Holy Relic",value:250},{id:"celestial_tear",name:"Celestial Tear",value:250}]},ruins_loot:{common:[{id:"ancient_coin",name:"Ancient Coin",value:10},{id:"pottery_shard",name:"Pottery Shard",value:5},{id:"old_scroll",name:"Old Scroll",value:15}],uncommon:[{id:"artifact_fragment",name:"Artifact Fragment",value:40},{id:"enchanted_stone",name:"Enchanted Stone",value:50},{id:"rune_tablet",name:"Rune Tablet",value:60}],rare:[{id:"purifying_crystal",name:"Purifying Crystal",value:180},{id:"ancient_tome",name:"Ancient Tome",value:200},{id:"crown_shard",name:"Crown Shard",value:250}]},temple_loot:{common:[{id:"incense",name:"Incense",value:5},{id:"old_scroll",name:"Old Scroll",value:15},{id:"blessed_water",name:"Blessed Water",value:50}],uncommon:[{id:"spirit_essence",name:"Spirit Essence",value:45},{id:"purifying_crystal",name:"Purifying Crystal",value:180},{id:"cursed_idol",name:"Cursed Idol",value:55}],rare:[{id:"holy_relic",name:"Holy Relic",value:250},{id:"sacred_chalice",name:"Sacred Chalice",value:200},{id:"forbidden_tome",name:"Forbidden Tome",value:350}]},fortress_loot:{common:[{id:"iron_ore",name:"Iron Ore",value:5},{id:"leather_scraps",name:"Leather Scraps",value:8},{id:"ancient_coin",name:"Ancient Coin",value:10}],uncommon:[{id:"steel_ingot",name:"Steel Ingot",value:40},{id:"battle_standard",name:"Battle Standard",value:50},{id:"war_medal",name:"War Medal",value:35}],rare:[{id:"legendary_weapon",name:"Legendary Weapon",value:400},{id:"royal_armor",name:"Royal Armor",value:350},{id:"war_chest",name:"War Chest",value:500}]}},ri={cave:["Pristine Cave Crystal","Ancient Fossil","Underground Map"],mine:["Mining Ledger","Rare Ore Sample","Miner's Journal"],shrine:["Sacred Chalice","Prayer Scroll","Blessed Stone"],ruins:["Ancient Tablet","Runed Artifact","Crown Fragment"],temple:["Temple Key","Divine Icon","Forbidden Scroll"],fortress:["War Banner","Commander's Seal","Battle Plans"],keep:["War Banner","Ancient Key","Battle Plans"],castle:["Royal Seal","Crown Fragment","Forbidden Scroll"],forest_grove:["Sacred Seed","Spirit Essence","Nature Scroll"]},Je={cave:"sunstone",mine:"fleshbane_totem",shrine:"mindshield_crystal",ruins:"lifeblood_chalice",temple:"purifying_flame",fortress:"sunstone",keep:"mindshield_crystal",castle:"lifeblood_chalice",forest_grove:"fleshbane_totem"},es=.7,H={NORMAL:{id:"normal",name:"Standard",description:"A typical dungeon floor",enemyMultiplier:1,lootMultiplier:1,hazards:[]},FLOODED:{id:"flooded",name:"Flooded Depths",description:"Water fills the passages, slowing movement",enemyMultiplier:.8,lootMultiplier:1.2,hazards:["water_damage"],accentBiomeOverride:"UNDERGROUND_WATER",movementPenalty:.5},INFESTED:{id:"infested",name:"Infested Cavern",description:"Crawling with extra enemies",enemyMultiplier:1.8,lootMultiplier:1.3,hazards:["poison_spores"],tintColor:"rgba(80, 120, 40, 0.15)"},TREASURE_VAULT:{id:"treasure_vault",name:"Treasure Vault",description:"An ancient vault filled with riches",enemyMultiplier:.5,lootMultiplier:2.5,hazards:["traps"],chestMultiplier:3,tintColor:"rgba(212, 175, 55, 0.1)"},BOSS_LAIR:{id:"boss_lair",name:"Boss Lair",description:"A powerful guardian awaits",enemyMultiplier:.3,lootMultiplier:2,hazards:[],hasBoss:!0,tintColor:"rgba(150, 50, 50, 0.15)"},CORRUPTED:{id:"corrupted",name:"Corrupted Depths",description:"Dark corruption seeps through the walls",enemyMultiplier:1.3,lootMultiplier:1.5,hazards:["corruption_damage"],tintColor:"rgba(100, 40, 120, 0.2)",corruptionDamage:1},SHRINE_FLOOR:{id:"shrine_floor",name:"Sacred Chamber",description:"Ancient shrines offer blessings",enemyMultiplier:.6,lootMultiplier:1,hazards:[],hasShrine:!0,tintColor:"rgba(100, 150, 200, 0.1)"},CRYSTAL_CAVERN:{id:"crystal_cavern",name:"Crystal Cavern",description:"Glowing crystals illuminate the darkness",enemyMultiplier:1,lootMultiplier:1.4,hazards:[],accentBiomeOverride:"CRYSTAL_FLOOR",brightnessBonus:.3,tintColor:"rgba(150, 100, 200, 0.1)"},TRAP_MAZE:{id:"trap_maze",name:"Trap-Filled Maze",description:"Watch your step...",enemyMultiplier:.7,lootMultiplier:1.3,hazards:["floor_traps","dart_traps"],trapDensity:.15,tintColor:"rgba(150, 100, 50, 0.1)"},RELIC_CHAMBER:{id:"relic_chamber",name:"Relic Chamber",description:"The purifying relic rests here",enemyMultiplier:1.5,lootMultiplier:2,hazards:[],hasRelic:!0,hasBoss:!0,tintColor:"rgba(255, 215, 0, 0.15)"}},ts={getFloorType(T,e,t){const i=T/e;if(T===e-1&&e>=20)return H.RELIC_CHAMBER;if(e>=12&&(T+1)%8===0&&T<e-1)return H.BOSS_LAIR;if(T<2)return H.NORMAL;if(e>=12&&T>2&&(T%6===3||T%6===4)&&Math.random()<.5)return H.SHRINE_FLOOR;const s=Math.random();if(i>.7){if(s<.2)return H.CORRUPTED;if(s<.35)return H.TREASURE_VAULT;if(s<.5)return H.INFESTED;if(s<.6)return H.TRAP_MAZE;if(s<.7)return H.CRYSTAL_CAVERN}else if(i>.4){if(s<.15)return H.FLOODED;if(s<.25)return H.INFESTED;if(s<.35)return H.CRYSTAL_CAVERN;if(s<.42)return H.TRAP_MAZE;if(s<.48)return H.TREASURE_VAULT}else{if(s<.1)return H.FLOODED;if(s<.18)return H.CRYSTAL_CAVERN;if(s<.22)return H.TRAP_MAZE}return H.NORMAL}};class is{constructor(e,t,i,s=null){this.level=e,this.grid=t,this.entrance=i,this.floorType=s||H.NORMAL,this.explored=new Set([`${i.q},${i.r}`]),this.enemies=new Map,this.chests=new Map,this.doors=new Map,this.ladders=new Map,this.portals=new Map,this.traps=new Map,this.shrines=new Map,this.cleared=!1,this.bossPosition=null,this.bossDefeated=!1,this.keyHolderPosition=null,this.relicPosition=null;const a=[[1,0],[-1,0],[0,1],[0,-1],[1,-1],[-1,1]];for(const[n,r]of a){const o=i.q+n,l=i.r+r;t.getCell(o,l)&&this.explored.add(`${o},${l}`)}}}class ss{constructor(e,t){this.poi=e,this.type=t,this.floors=[],this.currentFloorIndex=0,this.totalFloors=3,this.playerPosition=null,this.hasFloorKey=!1,this.killCounts=new Map,this.questItems=new Map,this.totalKills=0,this.overworldExits=[]}get grid(){var e;return(e=this.currentFloor)==null?void 0:e.grid}get currentFloor(){return this.floors[this.currentFloorIndex]}get entrance(){var e;return(e=this.floors[0])==null?void 0:e.entrance}get enemies(){var e;return((e=this.currentFloor)==null?void 0:e.enemies)||new Map}get chests(){var e;return((e=this.currentFloor)==null?void 0:e.chests)||new Map}get doors(){var e;return((e=this.currentFloor)==null?void 0:e.doors)||new Map}get ladders(){var e;return((e=this.currentFloor)==null?void 0:e.ladders)||new Map}get portals(){var e;return((e=this.currentFloor)==null?void 0:e.portals)||new Map}get explored(){var e;return((e=this.currentFloor)==null?void 0:e.explored)||new Set}get exits(){return this.currentFloorIndex===0?this.overworldExits:[]}getFloorBrightness(e=!1){const t=this.currentFloorIndex;let i;return t===0?i=1:t===1?i=.85:t===2?i=.65:t===3?i=.45:t===4?i=.3:i=.15,e&&t>=3?Math.min(.75,i+.4):i}requiresTorch(){return this.currentFloorIndex>=5}isDimlyLit(){return this.currentFloorIndex>=3&&this.currentFloorIndex<5}addFloor(e){this.floors.push(e),this.floors.length===1&&(this.playerPosition={...e.entrance})}descendToFloor(e){return e>=0&&e<this.floors.length?(this.currentFloorIndex=e,this.playerPosition={...this.currentFloor.entrance},this.hasFloorKey=!1,!0):!1}ascendToFloor(e){if(e>=0&&e<this.floors.length){this.currentFloorIndex=e;for(const[t,i]of this.floors[e].ladders)if(i.direction==="down"&&i.targetFloor===this.currentFloorIndex+1){const[s,a]=t.split(",").map(Number);this.playerPosition={q:s,r:a};break}return!0}return!1}}class Gt{constructor(e){this.seed=e,this.noise=new j(e),this.detailNoise=new j(e+1e3),this.accentNoise=new j(e+2e3)}generate(e,t=1,i=!1){const s=Ke[e.type.id]||Ke.cave;let a;if(i||t>=2.5){const r=16+Math.floor(Math.random()*5),o=Math.floor((t-1)*4);a=Math.min(28,r+o)}else{const r=4+Math.floor(Math.random()*3),o=Math.floor(t*2);a=Math.min(10,r+o)}const n=new ss(e,s);n.totalFloors=a,n.isDeepDungeon=i||a>=16;for(let r=0;r<a;r++){const o=ts.getFloorType(r,a,s),l=this.generateFloor(e,s,t,r,a,o);n.addFloor(l)}return this.connectFloors(n),this.placeOverworldExits(n),this.placeDeepPortals(n),n}generateFloor(e,t,i,s,a,n=null){const r=n||H.NORMAL,o=this.seed+s*1e4,l=new j(o),c=new j(o+1e3),d=new j(o+2e3),u=25+Math.floor(i*5),h=Math.min(s*.5,8),m=Math.max(18,u-h),g=new He(m,m,12);g.generate();const y=Math.floor(m/2);let f=t.accentBiomes;r.accentBiomeOverride&&(f=[I[r.accentBiomeOverride]||t.accentBiomes[0]]),g.forEach(C=>{const _=Math.sqrt(Math.pow(C.q-y,2)+Math.pow(C.r-y,2)),M=m*.4,S=_>M?Math.max(0,1-(_-M)/(m*.15)):1,A=l.fbm2DNormalized(C.q,C.r,3,.5,2,.08),q=c.fbm2DNormalized(C.q,C.r,2,.5,2,.2);if(A*.8+q*.2+(1-S)*.5<t.caveiness){const Z=d.noise2D(C.q*.2,C.r*.2),L=r.accentBiomeOverride?.4:.7;if(Z>L&&f.length>0){const G=Math.floor((Z-L)/(1-L)*f.length);C.biome=f[Math.min(G,f.length-1)]}else C.biome=t.floorBiome;C.elevation=.5+q*.1}else C.biome=t.wallBiome,C.elevation=.7+q*.15});let p=this.findFloorNear(g,y,y);p||(p={q:y,r:y}),this.carveEntranceArea(g,p.q,p.r,t),this.ensureConnectivity(g,p,t);const v=new is(s,g,p,r),b=r.enemyMultiplier||1,k=r.lootMultiplier||1,w=r.chestMultiplier||1,x=1+s*.2;return this.placeFloorEnemies(g,v,t,i*x*b,s),this.placeFloorContainers(g,v,t,i*k,s,a,e,w),s>0&&this.placeFloorDoors(g,v,t,s),s<a-1&&this.designateKeyHolder(v),(r.hasBoss||s===a-1)&&(v.bossPosition=this.placeBoss(g,p,v,t)),r.hasShrine&&this.placeShrine(g,v,p),r.trapDensity&&this.placeTraps(g,v,r.trapDensity),r.hasRelic&&this.placeRelic(g,v,p,e),v}placeShrine(e,t,i){let s=null,a=0;e.forEach(n=>{var l;if((l=n.biome)!=null&&l.impassable)return;const r=`${n.q},${n.r}`;if(t.enemies.has(r)||t.chests.has(r))return;const o=Math.abs(n.q-i.q)+Math.abs(n.r-i.r);o>a&&o>5&&(a=o,s={q:n.q,r:n.r})}),s&&t.shrines.set(`${s.q},${s.r}`,{type:"blessing_shrine",icon:"ðŸ›ï¸",used:!1,blessings:["heal","strength","fortitude","swiftness","vigor"],q:s.q,r:s.r})}placeTraps(e,t,i){const s=[];e.forEach(r=>{var o;if(!((o=r.biome)!=null&&o.impassable)){const l=`${r.q},${r.r}`;!t.enemies.has(l)&&!t.chests.has(l)&&l!==`${t.entrance.q},${t.entrance.r}`&&s.push(r)}});const a=Math.floor(s.length*i);this.shuffle(s);const n=["spike","dart","pit","gas"];for(let r=0;r<a&&r<s.length;r++){const o=s[r],l=`${o.q},${o.r}`;t.traps.set(l,{type:n[Math.floor(Math.random()*n.length)],triggered:!1,visible:Math.random()<.3,damage:5+Math.floor(t.level*2),q:o.q,r:o.r})}}placeRelic(e,t,i,s){var r;let a=null,n=0;if(e.forEach(o=>{var d;if((d=o.biome)!=null&&d.impassable)return;const l=`${o.q},${o.r}`;if(t.enemies.has(l)||t.chests.has(l))return;const c=Math.abs(o.q-i.q)+Math.abs(o.r-i.r);c>n&&(n=c,a={q:o.q,r:o.r})}),a){const o=((r=s==null?void 0:s.type)==null?void 0:r.id)||"cave",l=Je[o]||"purifying_flame";t.relicPosition=a,t.chests.set(`${a.q},${a.r}`,{type:"relic_chest",icon:"âœ¨",relicId:l,difficulty:3,opened:!1,q:a.q,r:a.r})}}placeFloorEnemies(e,t,i,s,a){const n=i.enemies,r=4+Math.floor(s*2.5);let o=0;const l=[];e.forEach(c=>{var d;(d=c.biome)!=null&&d.impassable||`${c.q},${c.r}`!==`${t.entrance.q},${t.entrance.r}`&&l.push(c)}),this.shuffle(l);for(const c of l){if(o>=r)break;const d=`${c.q},${c.r}`;if(t.enemies.has(d))continue;const u=Math.random();let h=0;const m=a*.15;u>.8-m?h=Math.min(2,n.length-1):u>.5-m&&(h=Math.min(1,n.length-1)),t.enemies.set(d,{templateId:n[h],isBoss:!1,defeated:!1,hasKey:!1,q:c.q,r:c.r}),o++}}placeFloorContainers(e,t,i,s,a,n=12,r=null,o=1){var b,k,w;const l=1+Math.floor(s*.5),c=Math.floor(l*o),d=3+Math.floor(Math.random()*3);let u=0,h=0;const m=[];e.forEach(x=>{var C;if(!((C=x.biome)!=null&&C.impassable)){const _=`${x.q},${x.r}`;!t.enemies.has(_)&&_!==`${t.entrance.q},${t.entrance.r}`&&m.push(x)}}),this.shuffle(m);const g=Ft[i.lootTable]||Ft.cave_loot,y=Math.floor(n*es),f=a>=y,p=Je[(b=i.name)==null?void 0:b.toLowerCase()]||Je[(k=i.lootTable)==null?void 0:k.replace("_loot","")],v=r&&!((w=r.data)!=null&&w.relicClaimed);if(f&&a===y&&p&&v&&m.length>0){const x=m.shift(),C=`${x.q},${x.r}`;t.chests.set(C,{type:"relic_chest",icon:"âœ¨",relicId:p,difficulty:s,opened:!1,q:x.q,r:x.r})}for(const x of m){if(u>=c)break;const C=`${x.q},${x.r}`;t.chests.has(C)||(t.chests.set(C,{type:"chest",icon:"ðŸ§°",lootTable:g,difficulty:s,opened:!1,q:x.q,r:x.r}),u++)}for(const x of m){if(h>=d)break;const C=`${x.q},${x.r}`;t.chests.has(C)||(t.chests.set(C,{type:"vase",icon:"ðŸº",lootTable:g,difficulty:Math.max(.5,s-.5),opened:!1,q:x.q,r:x.r}),h++)}}placeFloorDoors(e,t,i,s){const a=[];e.forEach(r=>{var d,u;if((d=r.biome)!=null&&d.impassable||`${r.q},${r.r}`===`${t.entrance.q},${t.entrance.r}`)return;const l=this.getNeighbors(r.q,r.r);let c=0;for(const h of l){const m=e.getCell(h.q,h.r);m&&!((u=m.biome)!=null&&u.impassable)&&c++}c===2&&a.push(r)}),this.shuffle(a);const n=Math.min(2,Math.floor(s*.5)+1);for(let r=0;r<n&&r<a.length;r++){const o=a[r],l=`${o.q},${o.r}`;t.doors.set(l,{locked:!0,opened:!1,q:o.q,r:o.r})}}designateKeyHolder(e){const t=Array.from(e.enemies.keys());if(t.length===0)return;let i=null,s=0;for(const a of t){const n=e.enemies.get(a);if(n.isBoss)continue;const r=Math.abs(n.q-e.entrance.q)+Math.abs(n.r-e.entrance.r);(r>s||r===s&&Math.random()>.5)&&(s=r,i=a)}if(i){const a=e.enemies.get(i);a.hasKey=!0,e.keyHolderPosition={q:a.q,r:a.r}}}connectFloors(e){for(let t=0;t<e.floors.length-1;t++){const i=e.floors[t],s=e.floors[t+1],a=this.findLadderPosition(i,"down");a&&i.ladders.set(`${a.q},${a.r}`,{direction:"down",targetFloor:t+1,icon:"ðŸªœ",q:a.q,r:a.r}),s.ladders.set(`${s.entrance.q},${s.entrance.r}`,{direction:"up",targetFloor:t,icon:"ðŸªœ",q:s.entrance.q,r:s.entrance.r})}}findLadderPosition(e,t){var o,l,c;const i=e.grid,s=new Set,a=[`${e.entrance.q},${e.entrance.r}`];for(;a.length>0;){const d=a.pop();if(s.has(d))continue;const[u,h]=d.split(",").map(Number),m=i.getCell(u,h);if(!m||(o=m.biome)!=null&&o.impassable)continue;s.add(d);const g=this.getNeighbors(u,h);for(const y of g){const f=`${y.q},${y.r}`;s.has(f)||a.push(f)}}let n=null,r=0;for(const d of s){if(e.enemies.has(d)||e.chests.has(d)||e.doors.has(d)||d===`${e.entrance.q},${e.entrance.r}`)continue;const[u,h]=d.split(",").map(Number),m=i.getCell(u,h);if(((l=m==null?void 0:m.biome)==null?void 0:l.id)==="underground_water"||((c=m==null?void 0:m.biome)==null?void 0:c.id)==="chasm")continue;const g=Math.abs(u-e.entrance.q)+Math.abs(h-e.entrance.r);g>r&&(r=g,n={q:u,r:h})}return n}placeOverworldExits(e){const t=e.floors[0];if(!t)return;const i=t.grid,s=i.width,a=Math.floor(s/2),n=e.poi,r=[{name:"north",dq:0,dr:-1,oq:0,or:-3},{name:"south",dq:0,dr:1,oq:0,or:3},{name:"east",dq:1,dr:0,oq:3,or:0},{name:"west",dq:-1,dr:0,oq:-3,or:0}];this.shuffle(r);let o=0;for(const l of r){if(o>=2)break;let c=null,d=0;i.forEach(u=>{var y,f,p;if((y=u.biome)!=null&&y.impassable||((f=u.biome)==null?void 0:f.id)==="underground_water"||((p=u.biome)==null?void 0:p.id)==="chasm"||`${u.q},${u.r}`===`${t.entrance.q},${t.entrance.r}`)return;const m=(u.q-a)*l.dq+(u.r-a)*l.dr,g=Math.abs(u.q-a)+Math.abs(u.r-a);m>d&&g>s*.25&&Math.abs(u.q-t.entrance.q)+Math.abs(u.r-t.entrance.r)>8&&(d=m,c=u)}),c&&(e.overworldExits.push({q:c.q,r:c.r,overworldQ:n.q+l.oq,overworldR:n.r+l.or,direction:l.name,isEntrance:!1,icon:"ðŸšª"}),o++)}}placeDeepPortals(e){var s,a,n;const t={cave:["cult","guild"],mine:["guild","guild"],ruins:["cult","cult"],temple:["cult","cult"],fortress:["guild","cult"],keep:["guild","guild"],castle:["cult","guild"],shrine:["cult","cult"],forest_grove:["cult","guild"]},i=t[(s=e.type.name)==null?void 0:s.toLowerCase()]||t[(n=(a=e.poi)==null?void 0:a.type)==null?void 0:n.id]||["cult","guild"];for(let r=3;r<e.floors.length;r++){const o=e.floors[r],l=o.grid;if(Math.random()>.6)continue;const c=i[Math.floor(Math.random()*i.length)];let d=null,u=0;l.forEach(h=>{var y,f,p;if((y=h.biome)!=null&&y.impassable||((f=h.biome)==null?void 0:f.id)==="underground_water"||((p=h.biome)==null?void 0:p.id)==="chasm")return;const m=`${h.q},${h.r}`;if(o.enemies.has(m)||o.chests.has(m)||o.doors.has(m)||o.ladders.has(m))return;const g=Math.abs(h.q-o.entrance.q)+Math.abs(h.r-o.entrance.r);g>u&&g>8&&(u=g,d={q:h.q,r:h.r})}),d&&o.portals.set(`${d.q},${d.r}`,{destination:c,destPOI:null,icon:c==="cult"?"ðŸŒ€":"â­",floorLevel:r,q:d.q,r:d.r,discovered:!1})}}findFloorNear(e,t,i){for(let s=0;s<10;s++)for(let a=-s;a<=s;a++)for(let n=-s;n<=s;n++){const r=e.getCell(t+a,i+n);if(r&&r.biome&&!r.biome.impassable){if(r.biome.id==="underground_water"||r.biome.id==="chasm")continue;return{q:t+a,r:i+n}}}return null}carveEntranceArea(e,t,i,s){const a=e.getCell(t,i);a&&(a.biome=s.floorBiome,a.elevation=.5);const n=this.getNeighbors(t,i);for(const r of n){const o=e.getCell(r.q,r.r);o&&(o.biome=s.floorBiome,o.elevation=.5)}for(let r=0;r<4;r++){const o=n[Math.floor(Math.random()*n.length)];let l=o.q,c=o.r;for(let d=0;d<5;d++){const u=this.getNeighbors(l,c),h=u[Math.floor(Math.random()*u.length)],m=e.getCell(h.q,h.r);m&&(m.biome=s.floorBiome,m.elevation=.5,l=h.q,c=h.r)}}}ensureConnectivity(e,t,i){var n;const s=new Set,a=[`${t.q},${t.r}`];for(;a.length>0;){const r=a.pop();if(s.has(r))continue;const[o,l]=r.split(",").map(Number),c=e.getCell(o,l);if(!c||(n=c.biome)!=null&&n.impassable)continue;s.add(r);const d=this.getNeighbors(o,l);for(const u of d){const h=`${u.q},${u.r}`;s.has(h)||a.push(h)}}e.forEach(r=>{var l;const o=`${r.q},${r.r}`;!((l=r.biome)!=null&&l.impassable)&&!s.has(o)&&this.carvePath(e,r.q,r.r,t.q,t.r,i)})}carvePath(e,t,i,s,a,n){let r=t,o=i;for(;r!==s||o!==a;){const l=e.getCell(r,o);l&&(l.biome=n.floorBiome,l.elevation=.5),Math.abs(s-r)>Math.abs(a-o)?r+=s>r?1:-1:o+=a>o?1:-1}}getNeighbors(e,t){return[{q:e+1,r:t},{q:e-1,r:t},{q:e,r:t+1},{q:e,r:t-1},{q:e+1,r:t-1},{q:e-1,r:t+1}]}placeBoss(e,t,i,s){let a=0,n=null;if(e.forEach(r=>{var c;if((c=r.biome)!=null&&c.impassable)return;const o=`${r.q},${r.r}`;if(i.enemies.has(o)||i.chests.has(o))return;const l=Math.abs(r.q-t.q)+Math.abs(r.r-t.r);l>a&&(a=l,n={q:r.q,r:r.r})}),n){const r=s.enemies,o=r[r.length-1]||r[0];i.enemies.set(`${n.q},${n.r}`,{templateId:o,isBoss:!0,defeated:!1,hasKey:!1,q:n.q,r:n.r})}return n}placeQuestItems(e,t){let i=null;for(const[n,r]of Object.entries(Ke))if(r===t.type){i=n;break}const s=ri[i];if(!s||s.length===0)return;const a=[];e.forEach(n=>{var r;if(!((r=n.biome)!=null&&r.impassable)){const o=`${n.q},${n.r}`;!t.enemies.has(o)&&!t.chests.has(o)&&o!==`${t.entrance.q},${t.entrance.r}`&&Math.abs(n.q-t.entrance.q)+Math.abs(n.r-t.entrance.r)>5&&a.push(n)}}),this.shuffle(a);for(let n=0;n<s.length&&n<a.length;n++){const r=a[n],o=`${r.q},${r.r}`;t.questItems.set(o,{itemId:s[n],found:!1,q:r.q,r:r.r})}}shuffle(e){for(let t=e.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}}}function Wt(T){const e=T.lootTable,t=T.difficulty||1,i=Math.random();let s="common";const a=.05+t*.03,n=.2+t*.05;i<a?s="rare":i<a+n&&(s="uncommon");const r=e[s],o=r[Math.floor(Math.random()*r.length)];let l=1;return s==="common"?l=1+Math.floor(Math.random()*3):s==="uncommon"&&(l=1+Math.floor(Math.random()*2)),{...o,quantity:l,tier:s}}const ze=["cave","mine","shrine","ruins","temple","fortress","keep","castle","forest_grove"],as=["cave","shrine","ruins","temple"],ns=["cult_shrine","blood_altar","void_rift","flesh_pit"],rs=["cult_shrine","blood_altar"],Ze=["blessed_water","purifying_crystal","holy_relic","sacred_chalice"],os=["blessed_water","purifying_crystal"],ls=["cultist","dark_acolyte","blood_priest","void_adept","flesh_weaver","shadow_assassin"],oe={maxActiveQuests:5,refreshIntervalDays:3,nearbyPOIRange:20,guildQuestRange:30,baseQuestCount:{min:1,max:2},guildQuestCount:{min:2,max:4}},cs=["Easy","Medium","Hard"],ds={gatherer:["gather"],crafter:["gather","dungeon"],merchant:["delivery"],guard:["combat","bounty"],scout:["scout","explore","delivery"]},te={baseSuccessChance:.5,levelBonus:.05,guildRankBonus:.08,partySizeBonus:.1,explorerGuildBonus:.15,dangerPenalty:.1,maxSuccessChance:.95,minSuccessChance:.1,failureConsequences:{safe:.5,injured:.3,captured:.15,dead:.05}},B={gather:[{id:"gather_wood",name:"Timber Collection",description:"The settlement needs wood for construction.",objective:{type:"gather",item:"wood",amount:[5,10,15]},rewards:{gold:[15,30,50],prestige:[1,2,3]},duration:3},{id:"gather_stone",name:"Stone Supply",description:"Quarry stone for building repairs.",objective:{type:"gather",item:"stone",amount:[5,8,12]},rewards:{gold:[20,35,55],prestige:[1,2,3]},duration:3},{id:"gather_herbs",name:"Herbal Remedy",description:"The healer needs medicinal herbs.",objective:{type:"gather",item:"herbs",amount:[3,6,10]},rewards:{gold:[25,45,70],trust:[1,2,3]},duration:3},{id:"gather_ore",name:"Ore Expedition",description:"The smithy requires raw ore.",objective:{type:"gather",item:"iron_ore",amount:[3,5,8]},rewards:{gold:[30,50,80],prestige:[1,2,4]},duration:4}],delivery:[{id:"deliver_supplies",name:"Supply Run",description:"Deliver supplies to a nearby settlement.",objective:{type:"deliver",poiCategory:"settlement"},rewards:{gold:[30,55,85],trust:[1,2,3]},duration:2},{id:"trade_mission",name:"Trade Mission",description:"Deliver trade goods to a distant market.",objective:{type:"deliver",poiCategory:"settlement"},rewards:{gold:[35,65,100],influence:[1,2,3]},duration:3},{id:"urgent_message",name:"Urgent Message",description:"Deliver an important letter to another settlement.",objective:{type:"deliver",poiCategory:"settlement"},rewards:{gold:[25,45,70],trust:[2,3,4]},duration:1}],explore:[{id:"survey_ruins",name:"Survey Ruins",description:"Investigate nearby ancient ruins.",objective:{type:"visit",poiType:"ruins"},rewards:{gold:[40,70,100],prestige:[2,3,5]},duration:4},{id:"map_cave",name:"Cave Mapping",description:"Explore and map a local cave system.",objective:{type:"visit",poiType:"cave"},rewards:{gold:[35,60,90],trust:[1,2,3]},duration:4},{id:"scout_tower",name:"Tower Reconnaissance",description:"Scout the mysterious tower in the region.",objective:{type:"visit",poiType:"tower"},rewards:{gold:[50,85,120],influence:[2,3,5]},duration:5}],scout:[{id:"scout_region",name:"Survey the Region",description:"Send scouts to explore uncharted territory.",objective:{type:"scout_region",poiCategories:["landmark","settlement"]},rewards:{gold:[20,40,60],prestige:[2,4,6]},duration:2,minCitizens:1,maxCitizens:3,requiresGuild:!1},{id:"scout_dungeon",name:"Dungeon Reconnaissance",description:"Scout a hidden dungeon location.",objective:{type:"scout_poi",poiCategories:["landmark"],poiTypes:ze},rewards:{gold:[35,60,90],prestige:[3,5,8]},duration:3,minCitizens:1,maxCitizens:2,requiresGuild:!0,dangerLevel:2},{id:"scout_guild_outpost",name:"Locate Guild Outpost",description:"Find a guild headquarters in the wilderness.",objective:{type:"scout_poi",poiCategories:["guild"]},rewards:{gold:[40,70,100],influence:[2,4,6]},duration:3,minCitizens:1,maxCitizens:2,requiresGuild:!0},{id:"dungeon_explore",name:"Dungeon Exploration",description:"Send scouts to map dungeon floors.",objective:{type:"explore_dungeon",floorsToReveal:[2,3,4]},rewards:{gold:[50,80,120],prestige:[4,6,9]},duration:4,minCitizens:2,maxCitizens:3,requiresGuild:!0,dangerLevel:3},{id:"scout_cult_site",name:"Infiltrate Dark Territory",description:"Scout the corrupted lands for cult activity.",objective:{type:"scout_poi",poiCategories:["cult"]},rewards:{gold:[60,100,150],prestige:[5,8,12],alignment:[2,3,5]},duration:4,minCitizens:2,maxCitizens:3,requiresGuild:!0,dangerLevel:5}],rescue:[{id:"rescue_citizen",name:"Rescue {citizenName}",description:"{citizenName} has been captured and needs rescue before it's too late!",objective:{type:"rescue",citizenUid:null},rewards:{trust:[20,30,40],morale:[10,15,20]},duration:5,urgent:!0,playerRequired:!0}],combat:[{id:"clear_cave",name:"Cave Cleansing",description:"Clear dangerous creatures from a nearby cave.",objective:{type:"clear",poiType:"cave"},rewards:{gold:[60,100,150],prestige:[3,5,8]},duration:5,minRank:1},{id:"dungeon_delve",name:"Dungeon Delve",description:"Venture into the dungeon and retrieve treasures.",objective:{type:"clear",poiType:"dungeon"},rewards:{gold:[80,130,200],prestige:[4,6,10]},duration:6,minRank:2},{id:"fortress_assault",name:"Fortress Assault",description:"Lead an assault on the enemy fortress.",objective:{type:"clear",poiType:"fortress"},rewards:{gold:[120,200,300],influence:[5,8,12]},duration:7,minRank:3},{id:"castle_siege",name:"Castle Siege",description:"Participate in the siege of a contested castle.",objective:{type:"clear",poiType:"castle"},rewards:{gold:[150,250,400],prestige:[6,10,15],influence:[3,5,8]},duration:8,minRank:4},{id:"keep_defense",name:"Keep Defense",description:"Defend the keep from raiders.",objective:{type:"clear",poiType:"keep"},rewards:{gold:[100,170,260],trust:[4,7,10]},duration:6,minRank:2}],bounty:[{id:"bandit_hunt",name:"Bandit Hunt",description:"Track down bandits terrorizing the roads.",objective:{type:"bounty",target:"bandits",count:[3,5,8]},rewards:{gold:[45,75,120],prestige:[2,4,6]},duration:4},{id:"beast_slaying",name:"Beast Slaying",description:"Hunt dangerous beasts in the wilderness.",objective:{type:"bounty",target:"beasts",count:[2,4,6]},rewards:{gold:[50,85,130],trust:[2,3,5]},duration:4}],dungeon:[{id:"dungeon_retrieve",name:"Relic Recovery",description:"Retrieve a valuable artifact from the depths.",objective:{type:"dungeon_retrieve",itemId:null},rewards:{gold:[80,130,200],prestige:[3,5,8]},duration:5},{id:"dungeon_kill",name:"Dungeon Purge",description:"Clear dangerous creatures from the dungeon.",objective:{type:"dungeon_kill",count:[5,8,12]},rewards:{gold:[60,100,150],trust:[2,4,6]},duration:4},{id:"dungeon_boss",name:"Dungeon Lord",description:"Defeat the powerful boss that lurks within.",objective:{type:"dungeon_boss"},rewards:{gold:[120,200,300],prestige:[5,8,12]},duration:6,minRank:2}],guild_anticult:[{id:"purge_shrine",name:"Purge the Darkness",description:"Eradicate a cult presence and cleanse their unholy site.",category:"guild_combat",objective:{type:"clear_cult_site",targetCult:null,killCount:[5,8,12],destroyAltar:!0},rewards:{gold:[150,250,400],prestige:[4,6,10],alignment:[10,15,20]},duration:5,minRank:2},{id:"hunt_cultists",name:"Cultist Hunt",description:"Track down and eliminate cult members in the region.",category:"guild_bounty",objective:{type:"bounty_cultist",targetCult:null,count:[3,5,8]},rewards:{gold:[80,130,200],prestige:[2,4,6],alignment:[5,8,12]},duration:4,minRank:1},{id:"recover_relic",name:"Sacred Recovery",description:"Retrieve a sacred artifact from a corrupted dungeon.",category:"guild_dungeon",objective:{type:"dungeon_retrieve_sacred",sacredItemId:null,dungeonPOI:null,returnToPOI:null},rewards:{gold:[200,350,500],prestige:[5,8,12],alignment:[15,20,30]},duration:6,minRank:2},{id:"cleanse_corruption",name:"Cleanse the Land",description:"Use a sacred artifact to dispel the corruption emanating from a cult site.",category:"guild_special",objective:{type:"dispel_aura",targetPOI:null,requiredItem:null},rewards:{gold:[300,450,600],prestige:[8,12,18],alignment:[20,30,40]},duration:7,minRank:3},{id:"infiltrate_cult",name:"Shadow Infiltration",description:"Infiltrate a cult gathering and steal their dark artifacts.",category:"guild_stealth",guildId:"shadows",objective:{type:"infiltrate_cult",targetCult:null,stealArtifact:!0},rewards:{gold:[120,200,320],prestige:[3,5,8],alignment:[8,12,18]},duration:5,minRank:2},{id:"map_corruption",name:"Chart the Darkness",description:"Map the extent of corruption spreading from cult sites.",category:"guild_explore",guildId:"explorers",objective:{type:"map_corruption_zone",targetCultSites:[],hexesToMap:[10,15,25]},rewards:{gold:[100,170,260],prestige:[4,6,9],alignment:[5,8,12]},duration:4,minRank:1},{id:"forge_purifier",name:"Sacred Forging",description:"Gather materials and craft a purifying artifact.",category:"guild_craft",guildId:"artisans",objective:{type:"craft_sacred_item",requiredMaterials:{},resultItem:null},rewards:{gold:[90,150,240],prestige:[3,5,8],alignment:[8,12,18]},duration:5,minRank:2},{id:"seal_rift",name:"Seal the Rift",description:"Use arcane knowledge to seal a void rift before it spreads.",category:"guild_magic",guildId:"ether_conclave",objective:{type:"seal_void_rift",targetPOI:null},rewards:{gold:[180,300,450],prestige:[6,10,15],alignment:[15,22,30]},duration:6,minRank:3}]};class jt{constructor(e,t){this.state=e,this.pois=t,this.citizenManager=null,this.activeQuests=[],this.availableQuests=new Map,this.completedQuests=new Set,this.refreshInterval=oe.refreshIntervalDays,this.maxActiveQuests=oe.maxActiveQuests,this.nearbyPOICache=new Map,this.nearbyPOICacheMaxSize=50}pickRandom(e,t){if(!(!e||e.length===0))return e[Math.floor(t()*e.length)]}filterPOIsByType(e,t){const i=Array.isArray(t)?t:[t];return e.filter(s=>i.includes(s.type.id))}filterUncleanedCultSites(e,t=ns){return e.filter(i=>{var s;return t.includes(i.type.id)&&!((s=i.data)!=null&&s.cleansed)})}filterDungeonPOIs(e,t=ze){return e.filter(i=>t.includes(i.type.id))}findHiddenPOIs(e,t=["landmark"]){var i;return(i=this.state)!=null&&i.isPOIVisible?e.filter(s=>t.includes(s.type.category)?!this.state.isPOIVisible(s):!1):[]}findExplorableDungeons(e){var t;return(t=this.state)!=null&&t.isPOIVisible?e.filter(i=>{var n,r;if(!ze.includes(i.type.id)||!this.state.isPOIVisible(i))return!1;const s=((n=i.data)==null?void 0:n.exploredDepth)||0,a=((r=i.data)==null?void 0:r.maxFloors)||24;return s<a-3}):[]}generateQuestId(e,t){const i=Math.floor(t()*4294967295).toString(36);return`${e}_${Date.now()}_${i}`}setCitizenManager(e){this.citizenManager=e}generateQuestBoard(e){var M;if(!e||e.type.category!=="settlement")return[];const t=`${e.q},${e.r}`,i=this.availableQuests.get(t);if(i&&i.generatedDay&&this.state.day-i.generatedDay<this.refreshInterval)return i.quests;const s=`${t}-${Math.floor(this.state.day/this.refreshInterval)}`,a=this.seededRandom(s),n=((M=this.state.citizens)==null?void 0:M.citizens)||[],r=n.length,o=e.type.size||1,{min:l,max:c}=oe.baseQuestCount,d=l+Math.floor(a()*(c-l+1)),u=Math.min(d+r+Math.floor(o/2),oe.maxActiveQuests),h=this.findNearbyPOIs(e,oe.nearbyPOIRange),m=new Set(h.map(S=>S.type.id)),g=S=>m.has(S),y=this.filterUncleanedCultSites(h).length>0,f=ze.some(S=>m.has(S)),p=[];p.push(...B.gather),p.push(...B.delivery),p.push(...B.bounty),g("ruins")&&p.push(B.explore.find(S=>S.id==="survey_ruins")),g("cave")&&p.push(B.explore.find(S=>S.id==="map_cave")),g("tower")&&p.push(B.explore.find(S=>S.id==="scout_tower")),g("cave")&&p.push(B.combat.find(S=>S.id==="clear_cave")),g("dungeon")&&p.push(B.combat.find(S=>S.id==="dungeon_delve")),g("fortress")&&p.push(B.combat.find(S=>S.id==="fortress_assault")),g("castle")&&p.push(B.combat.find(S=>S.id==="castle_siege")),g("keep")&&p.push(B.combat.find(S=>S.id==="keep_defense")),f&&p.push(...B.dungeon),y&&(p.push(B.guild_anticult.find(S=>S.id==="hunt_cultists")),p.push(B.guild_anticult.find(S=>S.id==="purge_shrine")),p.push(B.guild_anticult.find(S=>S.id==="cleanse_corruption")));const v=p.filter(S=>S),b=new Set(n.map(S=>{var A;return(A=S.role)==null?void 0:A.toLowerCase()}).filter(Boolean)),k=[],w=[];for(const S of v){let A=!1;for(const q of b)if((ds[q]||[]).includes(S.category)){A=!0;break}A?k.push(S):w.push(S)}k.sort(()=>a()-.5),w.sort(()=>a()-.5);const C=[...k,...w].slice(0,u),_=[];for(const S of C){const A=Math.floor(a()*3),q=this.createQuest(S,e,A,h,a);q&&_.push(q)}return this.availableQuests.set(t,{quests:_,generatedDay:this.state.day}),_}buildObjective(e,t,i,s,a,n){const r=t.objective;switch(e){case"gather":return{type:"gather",item:r.item,required:r.amount[i],current:0};case"have_gold":return{type:"have_gold",required:r.amount[i],current:0};case"deliver":{const o=s.filter(c=>c.type.category===(r.poiCategory||"settlement")&&(c.q!==a.q||c.r!==a.r)),l=this.pickRandom(o,n);return l?{type:"deliver",targetQ:l.q,targetR:l.r,targetName:l.name,originName:a.name,delivered:!1,_description:`${t.description} Destination: ${l.name}.`}:null}case"visit":case"clear":{const o=s.find(l=>l.type.id===r.poiType);return o?{type:e,poiType:r.poiType,targetQ:o.q,targetR:o.r,targetName:o.name,visited:!1,cleared:!1}:null}case"bounty":return{type:"bounty",target:r.target,required:r.count[i],current:0};case"dungeon_kill":{const o=this.filterDungeonPOIs(s),l=this.pickRandom(o,n);return l?{type:"dungeon_kill",targetQ:l.q,targetR:l.r,targetName:l.name,dungeonType:l.type.id,required:r.count[i],current:0,_description:`Defeat ${r.count[i]} enemies in ${l.name}.`}:null}case"dungeon_boss":{const o=this.filterDungeonPOIs(s),l=this.pickRandom(o,n);return l?{type:"dungeon_boss",targetQ:l.q,targetR:l.r,targetName:l.name,dungeonType:l.type.id,_description:`Defeat the boss of ${l.name}.`}:null}case"dungeon_retrieve":{const o=this.filterDungeonPOIs(s),l=this.pickRandom(o,n);if(!l)return null;const c=this.getDungeonQuestItems(l.type.id),d=this.pickRandom(c,n);return d?{type:"dungeon_retrieve",targetQ:l.q,targetR:l.r,targetName:l.name,dungeonType:l.type.id,itemId:d,_description:`Retrieve the ${d} from ${l.name}.`}:null}case"clear_cult_site":{const o=this.filterUncleanedCultSites(s),l=this.pickRandom(o,n);return l?{type:"clear_cult_site",targetQ:l.q,targetR:l.r,targetName:l.name,killCount:r.killCount[i],killProgress:0,siteVisited:!1,_description:`Defeat ${r.killCount[i]} cultists and cleanse ${l.name}.`}:null}case"bounty_cultist":return{type:"bounty_cultist",count:r.count[i],killProgress:0,_description:`Hunt down and eliminate ${r.count[i]} cult members.`};case"dispel_aura":{const o=this.filterUncleanedCultSites(s),l=this.pickRandom(o,n);if(!l)return null;const c=Ze[Math.min(i,Ze.length-1)];return{type:"dispel_aura",targetPOI:l.name,targetQ:l.q,targetR:l.r,requiredItem:c,_description:`Use a ${c.replace("_"," ")} to cleanse the corruption at ${l.name}.`}}case"map_corruption_zone":return{type:"map_corruption_zone",hexesToMap:r.hexesToMap[i],mappedHexes:0,mappedHexSet:new Set,_description:`Explore and map ${r.hexesToMap[i]} hexes affected by corruption.`};case"craft_sacred_item":{const o=this.pickRandom(os,n);return{type:"craft_sacred_item",resultItem:o,_description:`Craft a ${o.replace("_"," ")} to aid in fighting corruption.`}}case"seal_void_rift":{const o=s.filter(c=>{var d;return c.type.id==="void_rift"&&!((d=c.data)!=null&&d.cleansed)}),l=this.pickRandom(o,n);return l?{type:"seal_void_rift",targetQ:l.q,targetR:l.r,targetName:l.name,_description:`Seal the void rift at ${l.name} before it spreads further.`}:null}case"infiltrate_cult":{const o=this.filterUncleanedCultSites(s,rs),l=this.pickRandom(o,n);return l?{type:"infiltrate_cult",targetQ:l.q,targetR:l.r,targetName:l.name,infiltrated:!1,_description:`Infiltrate the cult gathering at ${l.name} and steal their artifacts.`}:null}case"dungeon_retrieve_sacred":{const o=this.filterDungeonPOIs(s,as),l=this.pickRandom(o,n);if(!l)return null;const c=this.pickRandom(Ze,n);return{type:"dungeon_retrieve_sacred",targetQ:l.q,targetR:l.r,targetName:l.name,sacredItemId:c,returnQ:a.q,returnR:a.r,returnName:a.name,hasItem:!1,_description:`Retrieve a ${c.replace("_"," ")} from ${l.name} and return it to ${a.name}.`}}case"scout_region":{const o=this.findHiddenPOIs(s,r.poiCategories);if(o.length===0)return null;const l=Math.min(o.length,i+1),c=[];for(let d=0;d<l;d++){const u=this.pickRandom(o.filter(h=>!c.includes(h)),n);u&&c.push(u)}return{type:"scout_region",targetPOIs:c.map(d=>({id:d.id,q:d.q,r:d.r,name:d.name,type:d.type.id})),poiCategories:r.poiCategories,assignedCitizens:[],missionStartDay:null,status:"pending",_description:`Scout the region to discover ${l} hidden location${l>1?"s":""}.`}}case"scout_poi":{const o=r.poiCategories||["landmark"],l=r.poiTypes||null;let c=this.findHiddenPOIs(s,o);if(l&&(c=c.filter(h=>l.includes(h.type.id))),c.length===0)return null;const d=this.pickRandom(c,n),u=t.dangerLevel||1;return{type:"scout_poi",targetPOI:{id:d.id,q:d.q,r:d.r,name:d.name,type:d.type.id},dangerLevel:u,assignedCitizens:[],missionStartDay:null,status:"pending",_description:`Locate and scout ${d.name||"the hidden location"}.`}}case"explore_dungeon":{const o=this.findExplorableDungeons(s);if(o.length===0)return null;const l=this.pickRandom(o,n),c=r.floorsToReveal[i],d=t.dangerLevel||3;return{type:"explore_dungeon",targetPOI:{id:l.id,q:l.q,r:l.r,name:l.name,type:l.type.id},floorsToReveal:c,dangerLevel:d,assignedCitizens:[],missionStartDay:null,status:"pending",_description:`Send scouts to explore ${c} floors of ${l.name}.`}}default:return null}}createQuest(e,t,i,s,a=null){const n=a||(()=>Math.random()),r=this.buildObjective(e.objective.type,e,i,s,t,n);if(!r)return null;const o=r._description||e.description;delete r._description;const l={id:this.generateQuestId(e.id,n),templateId:e.id,name:e.name,description:o,difficulty:cs[i],difficultyLevel:i,origin:{q:t.q,r:t.r,name:t.name},duration:e.duration,expiresDay:this.state.day+e.duration,accepted:!1,completed:!1,progress:0,objective:r};l.rewards={};for(const[c,d]of Object.entries(e.rewards))l.rewards[c]=d[i];return l}findNearbyPOIs(e,t){const i=`${e.q},${e.r},${t}`,s=this.nearbyPOICache.get(i);if(s&&s.day===this.state.day)return s.pois;const a=this.pois.filter(n=>n.q===e.q&&n.r===e.r?!1:this.hexDistance(e.q,e.r,n.q,n.r)<=t);if(this.nearbyPOICache.size>=this.nearbyPOICacheMaxSize){const n=this.nearbyPOICache.keys().next().value;this.nearbyPOICache.delete(n)}return this.nearbyPOICache.set(i,{pois:a,day:this.state.day}),a}hexDistance(e,t,i,s){return Math.max(Math.abs(e-i),Math.abs(t-s),Math.abs(e+t-(i+s)))}getDungeonQuestItems(e){return ri[e]||[]}generateGuildAnticultQuests(e,t=null){if(!e)return[];const i=`guild_${e.q},${e.r}`,s=this.availableQuests.get(i);if(s&&s.generatedDay&&this.state.day-s.generatedDay<this.refreshInterval)return s.quests;const a=[],n=this.findNearbyPOIs(e,oe.guildQuestRange),r=B.guild_anticult.filter(g=>!(g.guildId&&g.guildId!==t)),o=`${i}-anticult-${Math.floor(this.state.day/this.refreshInterval)}`,l=this.seededRandom(o),{min:c,max:d}=oe.guildQuestCount,u=c+Math.floor(l()*(d-c+1)),m=r.sort(()=>l()-.5).slice(0,u);for(const g of m){const y=Math.floor(l()*3),f=this.createQuest(g,e,y,n,l);f&&(f.isGuildQuest=!0,f.guildId=t,a.push(f))}return this.availableQuests.set(i,{quests:a,generatedDay:this.state.day}),a}generateGuildScoutQuests(e,t=null){if(!e)return[];const i=`guild_scout_${e.q},${e.r}`,s=this.availableQuests.get(i);if(s&&s.generatedDay&&this.state.day-s.generatedDay<this.refreshInterval)return s.quests;const a=[],n=this.findNearbyPOIs(e,oe.guildQuestRange);let r=[];if(t==="explorers"?r=[...B.scout]:t==="shadows"?r=B.scout.filter(m=>m.id==="scout_cult_site"||m.id==="scout_guild_outpost"):t==="iron_company"?r=B.scout.filter(m=>m.id==="dungeon_explore"||m.id==="scout_dungeon"):r=B.scout.filter(m=>m.id==="scout_region"),r.length===0)return[];const o=`${i}-scout-${Math.floor(this.state.day/this.refreshInterval)}`,l=this.seededRandom(o),d=t==="explorers"?2+Math.floor(l()*2):1+Math.floor(l()*2),u=r.sort(()=>l()-.5),h=u.slice(0,Math.min(d,u.length));for(const m of h){const g=Math.floor(l()*3),y=this.createQuest(m,e,g,n,l);y&&(y.isGuildQuest=!0,y.isScoutQuest=!0,y.guildId=t,a.push(y))}return this.availableQuests.set(i,{quests:a,generatedDay:this.state.day}),a}getGuildQuests(e,t=null){const i=this.generateGuildAnticultQuests(e,t),s=this.generateGuildScoutQuests(e,t);return[...i,...s]}acceptQuest(e){return this.activeQuests.length>=this.maxActiveQuests?(this.state.addLog(`Too many active quests (max ${this.maxActiveQuests})`,"warning"),!1):this.activeQuests.find(t=>t.id===e.id)?(this.state.addLog("Quest already accepted","warning"),!1):(e.accepted=!0,e.acceptedDay=this.state.day,this.activeQuests.push(e),this.state.addLog(`Accepted: ${e.name} (${e.difficulty})`,"success"),this.state.notify(),!0)}abandonQuest(e,t=!1){const i=this.activeQuests.findIndex(a=>a.id===e);if(i===-1)return!1;const s=this.activeQuests[i];return this.activeQuests.splice(i,1),s.fromCitizenUid&&this.citizenManager&&(t?this.citizenManager.onQuestFailed(s.fromCitizenUid):this.citizenManager.onQuestAbandoned(s.fromCitizenUid)),this.state.addLog(`Abandoned: ${s.name}`,"warning"),this.state.notify(),!0}checkProgress(){var s,a;if(this.activeQuests.length===0)return!1;const e=this.state.player,t=this.state.inventory,i=[];for(const n of this.activeQuests){if(n.completed)continue;const r=n.objective;let o=!1;switch(r.type){case"gather":if(t){const l=t.getQuantity(r.item);r.current=l,o=l>=r.required}break;case"have_gold":r.current=e.gold,o=e.gold>=r.required;break;case"visit":e.position.q===r.targetQ&&e.position.r===r.targetR&&(r.visited=!0,o=!0);break;case"deliver":e.position.q===r.targetQ&&e.position.r===r.targetR&&(r.delivered=!0,o=!0);break;case"clear":e.position.q===r.targetQ&&e.position.r===r.targetR&&(r.cleared=!0,o=!0);break;case"bounty":r.current>=r.required&&(o=!0);break;case"clear_cult_site":r.killProgress>=r.killCount&&(r.targetQ!==void 0&&r.targetR!==void 0&&e.position.q===r.targetQ&&e.position.r===r.targetR&&(r.siteVisited=!0),r.siteVisited&&(o=!0)),r.current=r.killProgress||0,r.required=r.killCount;break;case"bounty_cultist":r.current=r.killProgress||0,r.required=r.count,r.current>=r.required&&(o=!0);break;case"dispel_aura":if(r.targetPOI){const l=this.pois.find(c=>c.q===r.targetQ&&c.r===r.targetR);l&&((s=l.data)!=null&&s.cleansed)&&(o=!0)}break;case"dungeon_retrieve_sacred":r.sacredItemId&&t&&t.has(r.sacredItemId)&&(r.hasItem=!0,r.returnQ!==void 0&&r.returnR!==void 0&&e.position.q===r.returnQ&&e.position.r===r.returnR&&(o=!0));break;case"craft_sacred_item":r.resultItem&&t&&t.has(r.resultItem)&&(o=!0);break;case"seal_void_rift":if(r.targetQ!==void 0&&r.targetR!==void 0){const l=this.pois.find(c=>c.q===r.targetQ&&c.r===r.targetR);l&&((a=l.data)!=null&&a.cleansed)&&(o=!0)}break;case"map_corruption_zone":r.current=r.mappedHexes||0,r.required=r.hexesToMap,r.current>=r.required&&(o=!0);break;case"infiltrate_cult":r.targetQ!==void 0&&r.targetR!==void 0&&e.position.q===r.targetQ&&e.position.r===r.targetR&&(r.infiltrated=!0,o=!0);break}r.required?n.progress=Math.min(100,Math.floor(r.current/r.required*100)):o&&(n.progress=100),o&&i.push(n)}for(const n of i)this.completeQuest(n);return i.length>0}completeQuest(e){e.completed=!0;const t=e.rewards;t.gold&&(this.state.player.gold+=t.gold),t.prestige&&(this.state.player.attributes.prestige+=t.prestige),t.trust&&(this.state.player.attributes.trust+=t.trust),t.influence&&(this.state.player.attributes.influence+=t.influence),t.alignment&&(this.state.player.alignment=(this.state.player.alignment||0)+t.alignment),e.objective.type==="gather"&&this.state.inventory&&this.state.inventory.remove(e.objective.item,e.objective.required),e.objective.type==="dungeon_retrieve_sacred"&&this.state.inventory&&e.objective.sacredItemId&&this.state.inventory.remove(e.objective.sacredItemId,1),e.objective.type==="craft_sacred_item"&&this.state.inventory&&e.objective.resultItem&&this.state.inventory.remove(e.objective.resultItem,1),e.fromCitizenUid&&this.citizenManager&&this.citizenManager.onQuestCompleted(e.fromCitizenUid);const i=this.activeQuests.findIndex(a=>a.id===e.id);i!==-1&&this.activeQuests.splice(i,1),this.completedQuests.add(e.templateId);const s=Object.entries(t).map(([a,n])=>`+${n} ${a}`).join(", ");this.state.addLog(`Quest Complete: ${e.name}! (${s})`,"success"),this.state.showToast&&this.state.showToast(`Quest Complete: ${e.name}!`,"success",4e3,"âœ“"),$.playQuestComplete(),this.state.notify()}checkExpired(){const e=this.activeQuests.filter(t=>!t.completed&&!t.isRescueQuest&&this.state.day>t.expiresDay);for(const t of e)this.state.addLog(`Quest expired: ${t.name}`,"error"),this.abandonQuest(t.id,!0);this.checkRescueDeadlines()}checkDungeonProgress(e,t){for(const i of this.activeQuests){if(i.completed)continue;const s=i.objective;s.type==="dungeon_kill"&&e==="kill"&&t.poi.q===s.targetQ&&t.poi.r===s.targetR&&(s.current=(s.current||0)+1,i.progress=Math.min(100,Math.floor(s.current/s.required*100)),s.current>=s.required&&this.completeQuest(i)),s.type==="dungeon_boss"&&e==="boss"&&t.poi.q===s.targetQ&&t.poi.r===s.targetR&&this.completeQuest(i),s.type==="dungeon_retrieve"&&e==="retrieve"&&t.itemId===s.itemId&&t.poi.q===s.targetQ&&t.poi.r===s.targetR&&this.completeQuest(i)}}updateCultistKill(e){if(ls.some(i=>e.includes(i)))for(const i of this.activeQuests){if(i.completed)continue;const s=i.objective;s.type==="bounty_cultist"&&(s.killProgress=(s.killProgress||0)+1,i.progress=Math.min(100,Math.floor(s.killProgress/s.count*100))),s.type==="clear_cult_site"&&(s.killProgress=(s.killProgress||0)+1,i.progress=Math.min(100,Math.floor(s.killProgress/s.killCount*100)))}}updateCorruptionMapping(e,t,i){if(!i)return;const s=i.getAurasAt(e,t);if(!(!s||s.length===0))for(const a of this.activeQuests){if(a.completed)continue;const n=a.objective;if(n.type==="map_corruption_zone"){n.mappedHexSet=n.mappedHexSet||new Set;const r=`${e},${t}`;n.mappedHexSet.has(r)||(n.mappedHexSet.add(r),n.mappedHexes=n.mappedHexSet.size,a.progress=Math.min(100,Math.floor(n.mappedHexes/n.hexesToMap*100)))}}}seededRandom(e){let t=0;for(let i=0;i<e.length;i++)t=Math.imul(31,t)+e.charCodeAt(i)|0;return function(){return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}assignScoutMission(e,t){var c,d;const i=this.activeQuests.find(u=>u.id===e);if(!i)return{success:!1,reason:"Quest not found"};if(!["scout_region","scout_poi","explore_dungeon"].includes((c=i.objective)==null?void 0:c.type))return{success:!1,reason:"Not a scout mission"};if(i.objective.status!=="pending")return{success:!1,reason:"Mission already in progress"};const a=(d=B.scout)==null?void 0:d.find(u=>u.id===i.templateId),n=(a==null?void 0:a.minCitizens)||1,r=(a==null?void 0:a.maxCitizens)||3;if(t.length<n)return{success:!1,reason:`Need at least ${n} citizen(s)`};if(t.length>r)return{success:!1,reason:`Maximum ${r} citizens allowed`};if(!this.citizenManager)return{success:!1,reason:"Citizen manager not available"};const o=[];for(const u of t){const h=this.citizenManager.getCitizenByUid(u);if(!h)return{success:!1,reason:`Citizen ${u} not found`};if(h.status!=="active")return{success:!1,reason:`${h.name} is not available`};if(h.assignment)return{success:!1,reason:`${h.name} is already assigned`};o.push(h)}if(a!=null&&a.requiresGuild&&!o.some(h=>h.guildId&&h.guildRank>0))return{success:!1,reason:"At least one guild member required"};i.objective.assignedCitizens=t,i.objective.missionStartDay=this.state.day,i.objective.status="in_progress";for(const u of o)u.assignment={type:"scout_mission",questId:e};const l=this.calculateScoutSuccess(i,o);return this.state.addLog(`Scout mission started: ${i.name} (${Math.round(l*100)}% success)`,"info"),{success:!0,successChance:l}}calculateScoutSuccess(e,t){let i=te.baseSuccessChance;for(const a of t)i+=a.level*te.levelBonus,i+=(a.guildRank||0)*te.guildRankBonus,a.guildId==="explorers"&&(i+=te.explorerGuildBonus);i+=(t.length-1)*te.partySizeBonus;const s=e.objective.dangerLevel||1;return i-=s*te.dangerPenalty,Math.min(te.maxSuccessChance,Math.max(te.minSuccessChance,i))}resolveScoutMission(e){var o,l,c,d;const t=e.objective,i=t.assignedCitizens.map(u=>{var h;return(h=this.citizenManager)==null?void 0:h.getCitizenByUid(u)}).filter(Boolean);if(i.length===0)return{success:!1,reason:"No citizens assigned"};const s=this.calculateScoutSuccess(e,i),n=Math.random()<s,r={success:n,discoveredPOIs:[],citizenOutcomes:[]};if(n){if(t.type==="scout_region"||t.type==="scout_poi"){const u=t.type==="scout_region"?t.targetPOIs:[t.targetPOI];for(const h of u){const m=this.pois.find(g=>g.id===h.id);m&&this.state.discoverPOI&&(this.state.discoverPOI(m.id,m),r.discoveredPOIs.push(m))}}else if(t.type==="explore_dungeon"){const u=this.pois.find(h=>h.id===t.targetPOI.id);u&&(u.data=u.data||{},u.data.exploredDepth=(u.data.exploredDepth||0)+t.floorsToReveal,r.floorsRevealed=t.floorsToReveal,this.state.addLog(`Scouts mapped ${t.floorsToReveal} floors of ${u.name}`,"success"))}for(const u of i)u.assignment=null,r.citizenOutcomes.push({citizen:u,outcome:"safe"});this.completeQuest(e)}else{const u=t.dangerLevel||1,h={...te.failureConsequences};u>=3&&(h.safe-=.15,h.injured+=.1,h.captured+=.05),u>=5&&(h.safe-=.15,h.captured+=.1,h.dead+=.05);for(const m of i){const g=Math.random();let y="safe",f=0;for(const[p,v]of Object.entries(h))if(f+=v,g<f){y=p;break}m.assignment=null,y==="injured"?(o=this.citizenManager)==null||o.setCitizenStatus(m.uid,"injured"):y==="captured"?(c=this.citizenManager)==null||c.setCitizenStatus(m.uid,"imprisoned",{captureLocation:t.targetPOI||((l=t.targetPOIs)==null?void 0:l[0])}):y==="dead"&&((d=this.citizenManager)==null||d.setCitizenStatus(m.uid,"dead")),r.citizenOutcomes.push({citizen:m,outcome:y})}t.status="failed",this.state.addLog(`Scout mission failed: ${e.name}`,"error"),this.abandonQuest(e.id)}return r}processScoutMissions(){for(const e of this.activeQuests){const t=e.objective;if(!["scout_region","scout_poi","explore_dungeon"].includes(t==null?void 0:t.type)||t.status!=="in_progress")continue;this.state.day-t.missionStartDay>=e.duration&&this.resolveScoutMission(e)}}getActiveScoutMissions(){const e=["scout_region","scout_poi","explore_dungeon"];return this.activeQuests.filter(t=>{var i,s;return e.includes((i=t.objective)==null?void 0:i.type)&&((s=t.objective)==null?void 0:s.status)==="in_progress"})}getPendingScoutMissions(){const e=["scout_region","scout_poi","explore_dungeon"];return this.activeQuests.filter(t=>{var i,s;return e.includes((i=t.objective)==null?void 0:i.type)&&((s=t.objective)==null?void 0:s.status)==="pending"})}generateRescueQuest(e,t=null){if(this.activeQuests.find(a=>{var n,r;return((n=a.objective)==null?void 0:n.citizenUid)===e.uid&&((r=a.objective)==null?void 0:r.type)==="rescue"}))return null;const i=B.rescue[0],s={id:`rescue_${e.uid}_${this.state.day}`,templateId:i.id,name:i.name.replace("{citizenName}",e.name),description:i.description.replace("{citizenName}",e.name),objective:{type:"rescue",citizenUid:e.uid,citizenName:e.name,captureLocation:t,status:"active"},rewards:{trust:i.rewards.trust[1],morale:i.rewards.morale[1]},difficulty:"Urgent",expiresDay:this.state.day+i.duration,urgent:!0,playerRequired:!0,accepted:!0,acceptedDay:this.state.day,isRescueQuest:!0};return this.activeQuests.push(s),this.state.addLog(`âš ï¸ URGENT: ${e.name} needs rescue!`,"error"),this.state.notify(),s}checkRescueDeadlines(){const e=this.activeQuests.filter(t=>t.isRescueQuest);for(const t of e)this.state.day>=t.expiresDay&&(this.removeQuest(t.id),this.state.addLog(`Failed to rescue ${t.objective.citizenName} in time...`,"error"))}completeRescue(e){const t=this.activeQuests.find(i=>{var s,a;return((s=i.objective)==null?void 0:s.type)==="rescue"&&((a=i.objective)==null?void 0:a.citizenUid)===e});t&&(t.rewards.trust&&(this.state.player.trust=(this.state.player.trust||0)+t.rewards.trust),t.rewards.morale&&(this.state.guild.morale=Math.min(100,(this.state.guild.morale||50)+t.rewards.morale)),this.state.addLog(`âœ¨ Successfully rescued ${t.objective.citizenName}!`,"success"),this.removeQuest(t.id),this.completedQuests.add(t.id))}getActiveRescueQuests(){return this.activeQuests.filter(e=>e.isRescueQuest)}toJSON(){return{activeQuests:this.activeQuests,completedQuests:Array.from(this.completedQuests)}}fromJSON(e){this.activeQuests=e.activeQuests||[],this.completedQuests=new Set(e.completedQuests||[])}}const ae={baseDuration:5e3,minDuration:3e3,maxDuration:1e4,agilityBonus:200,staminaRecoveryPerTurn:5,timePenaltyPerHit:350,warningThreshold:.25,criticalThreshold:.1},_e={poisoned:{id:"poisoned",name:"Poisoned",icon:"ðŸ¤¢",description:"Taking damage over time",duration:3,damagePerTurn:2,stackable:!1},bleeding:{id:"bleeding",name:"Bleeding",icon:"ðŸ©¸",description:"Losing health each turn",duration:2,damagePerTurn:2,stackable:!0,maxStacks:2},infected:{id:"infected",name:"Infected",icon:"ðŸ¦ ",description:"Weakened and taking damage",duration:3,damagePerTurn:1,statMod:{damage:-.1},stackable:!1},weakened:{id:"weakened",name:"Weakened",icon:"ðŸ’”",description:"Reduced damage output",duration:2,statMod:{damage:-.15},stackable:!1},cursed:{id:"cursed",name:"Cursed",icon:"ðŸ’€",description:"Dark magic drains your life",duration:3,damagePerTurn:1,statMod:{defense:-1},stackable:!1},haunted:{id:"haunted",name:"Haunted",icon:"ðŸ‘»",description:"Spirits drain your energy",duration:2,staminaDrainPerTurn:5,etherDrainPerTurn:3,stackable:!1},hexed:{id:"hexed",name:"Hexed",icon:"ðŸ”®",description:"Bad luck follows you",duration:3,statMod:{critChance:-.1,dodgeChance:-.05},stackable:!1},paralyzed:{id:"paralyzed",name:"Paralyzed",icon:"âš¡",description:"Cannot act this turn",duration:1,skipTurn:!0,stackable:!1},terrified:{id:"terrified",name:"Terrified",icon:"ðŸ˜±",description:"Frozen with fear, reduced stats",duration:2,statMod:{damage:-.1,defense:-1},stackable:!1},chilled:{id:"chilled",name:"Chilled",icon:"ðŸ¥¶",description:"Slowed and taking cold damage",duration:2,damagePerTurn:1,statMod:{agility:-2},stackable:!1},burning:{id:"burning",name:"Burning",icon:"ðŸ”¥",description:"On fire! Taking damage",duration:2,damagePerTurn:3,stackable:!1},entangled:{id:"entangled",name:"Entangled",icon:"ðŸŒ¿",description:"Vines restrict movement",duration:2,statMod:{agility:-2,dodgeChance:-.1},stackable:!1},corroded:{id:"corroded",name:"Corroded",icon:"ðŸ§ª",description:"Armor dissolving",duration:2,statMod:{defense:-2},stackable:!1}},us={beast:{bleeding:8,infected:4},insect:{poisoned:10,infected:5},plant:{poisoned:8,entangled:6},slime:{corroded:10,poisoned:6},undead:{cursed:8,infected:5,terrified:5},spirit:{haunted:10,hexed:6,terrified:5,paralyzed:3},demon:{cursed:10,burning:6,terrified:5,hexed:4},elemental:{burning:8,chilled:8,paralyzed:4},goblinoid:{poisoned:6,bleeding:5,weakened:4},humanoid:{bleeding:6,weakened:4},giant:{weakened:8,bleeding:5},magical_beast:{hexed:7,poisoned:5,paralyzed:3},aquatic:{poisoned:7,chilled:5,entangled:4},construct:{paralyzed:4,corroded:4}},Se={fire:{id:"fire",name:"Fire",icon:"ðŸ”¥",etherCost:8,damage:[8,14],type:"offensive",chargeTime:2e3,description:"Hurl a ball of fire at the enemy"},ice:{id:"ice",name:"Ice",icon:"â„ï¸",etherCost:8,damage:[7,13],type:"offensive",chargeTime:2e3,description:"Blast the enemy with freezing cold"},thunder:{id:"thunder",name:"Thunder",icon:"âš¡",etherCost:10,damage:[10,16],type:"offensive",chargeTime:2500,description:"Strike with lightning"},cure:{id:"cure",name:"Cure",icon:"ðŸ’š",etherCost:10,healing:[12,20],type:"healing",chargeTime:1800,description:"Restore health"},protect:{id:"protect",name:"Protect",icon:"ðŸ›¡ï¸",etherCost:6,effect:"defense_up",duration:15e3,type:"buff",chargeTime:1500,description:"Increase defense temporarily"},haste:{id:"haste",name:"Haste",icon:"ðŸ’¨",etherCost:8,effect:"agility_up",duration:12e3,type:"buff",chargeTime:1500,description:"Increase attack speed temporarily"}},hs={unarmed:{id:"unarmed",name:"Fists",icon:"ðŸ‘Š",damage:[2,4],chargeTime:1200,critChance:.05,staminaCost:3,melee:!0},sword:{id:"sword",name:"Sword",icon:"âš”ï¸",damage:[5,9],chargeTime:1500,critChance:.1,staminaCost:5,melee:!0,skills:["slash","thrust"]},axe:{id:"axe",name:"Axe",icon:"ðŸª“",damage:[7,12],chargeTime:2200,critChance:.15,staminaCost:8,melee:!0,skills:["cleave"]},bow:{id:"bow",name:"Bow",icon:"ðŸ¹",damage:[4,8],chargeTime:1400,critChance:.12,staminaCost:4,melee:!1,skills:["aim_shot"]},staff:{id:"staff",name:"Staff",icon:"ðŸª„",damage:[2,5],chargeTime:1800,critChance:.05,staminaCost:3,melee:!1,magicBonus:1.3},dagger:{id:"dagger",name:"Dagger",icon:"ðŸ—¡ï¸",damage:[3,6],chargeTime:1e3,critChance:.2,staminaCost:4,melee:!0,skills:["backstab"]}},Le={slash:{id:"slash",name:"Slash",icon:"âš”ï¸",staminaCost:5,damageMultiplier:1.3,chargeMultiplier:1.2,description:"A powerful slashing attack"},thrust:{id:"thrust",name:"Thrust",icon:"ðŸ—¡ï¸",staminaCost:4,damageMultiplier:1.2,chargeMultiplier:1,armorPiercing:2,description:"Pierce through armor"},cleave:{id:"cleave",name:"Cleave",icon:"ðŸª“",staminaCost:8,damageMultiplier:1.5,chargeMultiplier:1.4,description:"A devastating heavy strike"},aim_shot:{id:"aim_shot",name:"Aimed Shot",icon:"ðŸŽ¯",staminaCost:6,damageMultiplier:1.4,chargeMultiplier:1.5,critBonus:.15,description:"Careful aim for critical hit"},backstab:{id:"backstab",name:"Backstab",icon:"ðŸ”ª",staminaCost:7,damageMultiplier:2,chargeMultiplier:1.3,description:"Strike at a vital point"}},oi={rat_hide:{id:"rat_hide",name:"Rat Hide",icon:"ðŸ€",type:"material",subtype:"hide",value:2,stackable:!0},wolf_pelt:{id:"wolf_pelt",name:"Wolf Pelt",icon:"ðŸº",type:"material",subtype:"hide",value:8,stackable:!0},dire_wolf_pelt:{id:"dire_wolf_pelt",name:"Dire Wolf Pelt",icon:"ðŸº",type:"material",subtype:"hide",value:18,stackable:!0},bear_hide:{id:"bear_hide",name:"Bear Hide",icon:"ðŸ»",type:"material",subtype:"hide",value:15,stackable:!0},lion_pelt:{id:"lion_pelt",name:"Lion Pelt",icon:"ðŸ¦",type:"material",subtype:"hide",value:20,stackable:!0},jaguar_pelt:{id:"jaguar_pelt",name:"Jaguar Pelt",icon:"ðŸ†",type:"material",subtype:"hide",value:18,stackable:!0},boar_hide:{id:"boar_hide",name:"Boar Hide",icon:"ðŸ—",type:"material",subtype:"hide",value:6,stackable:!0},croc_hide:{id:"croc_hide",name:"Crocodile Hide",icon:"ðŸŠ",type:"material",subtype:"hide",value:12,stackable:!0},small_bones:{id:"small_bones",name:"Small Bones",icon:"ðŸ¦´",type:"material",subtype:"bone",value:1,stackable:!0},animal_bones:{id:"animal_bones",name:"Animal Bones",icon:"ðŸ¦´",type:"material",subtype:"bone",value:3,stackable:!0},large_bones:{id:"large_bones",name:"Large Bones",icon:"ðŸ¦´",type:"material",subtype:"bone",value:6,stackable:!0},rat_teeth:{id:"rat_teeth",name:"Rat Teeth",icon:"ðŸ¦·",type:"material",subtype:"fang",value:1,stackable:!0},wolf_fang:{id:"wolf_fang",name:"Wolf Fang",icon:"ðŸ¦·",type:"material",subtype:"fang",value:5,stackable:!0},bear_claw:{id:"bear_claw",name:"Bear Claw",icon:"ðŸ¾",type:"material",subtype:"claw",value:8,stackable:!0},lion_claw:{id:"lion_claw",name:"Lion Claw",icon:"ðŸ¾",type:"material",subtype:"claw",value:10,stackable:!0},boar_tusk:{id:"boar_tusk",name:"Boar Tusk",icon:"ðŸ¦·",type:"material",subtype:"fang",value:4,stackable:!0},snake_fang:{id:"snake_fang",name:"Snake Fang",icon:"ðŸ¦·",type:"material",subtype:"fang",value:3,stackable:!0},croc_tooth:{id:"croc_tooth",name:"Crocodile Tooth",icon:"ðŸ¦·",type:"material",subtype:"fang",value:6,stackable:!0},rat_meat:{id:"rat_meat",name:"Rat Meat",icon:"ðŸ–",type:"material",subtype:"meat",value:1,stackable:!0},raw_meat:{id:"raw_meat",name:"Raw Meat",icon:"ðŸ–",type:"material",subtype:"meat",value:3,stackable:!0},quality_meat:{id:"quality_meat",name:"Quality Meat",icon:"ðŸ¥©",type:"material",subtype:"meat",value:8,stackable:!0},boar_meat:{id:"boar_meat",name:"Boar Meat",icon:"ðŸ¥©",type:"material",subtype:"meat",value:5,stackable:!0},venom_sac:{id:"venom_sac",name:"Venom Sac",icon:"ðŸ’§",type:"material",subtype:"fluid",value:8,stackable:!0},spider_silk:{id:"spider_silk",name:"Spider Silk",icon:"ðŸ•¸ï¸",type:"material",subtype:"fiber",value:6,stackable:!0},slime_goo:{id:"slime_goo",name:"Slime Goo",icon:"ðŸ’š",type:"material",subtype:"fluid",value:4,stackable:!0},toxic_goo:{id:"toxic_goo",name:"Toxic Goo",icon:"ðŸ’œ",type:"material",subtype:"fluid",value:10,stackable:!0},scorpion_stinger:{id:"scorpion_stinger",name:"Scorpion Stinger",icon:"ðŸ¦‚",type:"material",subtype:"stinger",value:7,stackable:!0},scorpion_chitin:{id:"scorpion_chitin",name:"Scorpion Chitin",icon:"ðŸ›¡ï¸",type:"material",subtype:"chitin",value:5,stackable:!0},beetle_shell:{id:"beetle_shell",name:"Beetle Shell",icon:"ðŸª²",type:"material",subtype:"chitin",value:6,stackable:!0},hornet_stinger:{id:"hornet_stinger",name:"Hornet Stinger",icon:"ðŸ",type:"material",subtype:"stinger",value:4,stackable:!0},ember_core:{id:"ember_core",name:"Ember Core",icon:"ðŸ”¥",type:"material",subtype:"essence",value:15,stackable:!0},ice_crystal:{id:"ice_crystal",name:"Ice Crystal",icon:"â„ï¸",type:"material",subtype:"essence",value:18,stackable:!0},ghost_essence:{id:"ghost_essence",name:"Ghost Essence",icon:"ðŸ‘»",type:"material",subtype:"essence",value:20,stackable:!0},imp_horn:{id:"imp_horn",name:"Imp Horn",icon:"ðŸ˜ˆ",type:"material",subtype:"horn",value:8,stackable:!0},goblin_ear:{id:"goblin_ear",name:"Goblin Ear",icon:"ðŸ‘‚",type:"material",subtype:"trophy",value:3,stackable:!0},whisker:{id:"whisker",name:"Mystic Whisker",icon:"ã€°ï¸",type:"material",subtype:"essence",value:12,stackable:!0},cockatrice_feather:{id:"cockatrice_feather",name:"Cockatrice Feather",icon:"ðŸª¶",type:"material",subtype:"feather",value:14,stackable:!0},troll_blood:{id:"troll_blood",name:"Troll Blood",icon:"ðŸ©¸",type:"material",subtype:"fluid",value:25,stackable:!0},gargoyle_dust:{id:"gargoyle_dust",name:"Gargoyle Dust",icon:"âœ¨",type:"material",subtype:"powder",value:22,stackable:!0},yeti_fur:{id:"yeti_fur",name:"Yeti Fur",icon:"ðŸ¦",type:"material",subtype:"hide",value:30,stackable:!0},mandragora_root:{id:"mandragora_root",name:"Mandragora Root",icon:"ðŸ¥¬",type:"material",subtype:"plant",value:10,stackable:!0},living_bark:{id:"living_bark",name:"Living Bark",icon:"ðŸŒ³",type:"material",subtype:"plant",value:12,stackable:!0},cactus_needle:{id:"cactus_needle",name:"Cactus Needle",icon:"ðŸŒµ",type:"material",subtype:"plant",value:8,stackable:!0},fish_scales:{id:"fish_scales",name:"Fish Scales",icon:"ðŸŸ",type:"material",subtype:"scale",value:4,stackable:!0},gillkin_scale:{id:"gillkin_scale",name:"Gillkin Scale",icon:"ðŸ¸",type:"material",subtype:"scale",value:8,stackable:!0},bone_dust:{id:"bone_dust",name:"Bone Dust",icon:"ðŸ’€",type:"material",subtype:"powder",value:5,stackable:!0},rotting_flesh:{id:"rotting_flesh",name:"Rotting Flesh",icon:"ðŸ§Ÿ",type:"material",subtype:"meat",value:2,stackable:!0},beast_heart:{id:"beast_heart",name:"Beast Heart",icon:"â¤ï¸",type:"viscera",subtype:"organ",value:12,stackable:!0},beast_blood:{id:"beast_blood",name:"Beast Blood",icon:"ðŸ©¸",type:"viscera",subtype:"fluid",value:5,stackable:!0},entrails:{id:"entrails",name:"Entrails",icon:"ðŸ«€",type:"viscera",subtype:"organ",value:4,stackable:!0},organ_meat:{id:"organ_meat",name:"Organ Meat",icon:"ðŸ«",type:"viscera",subtype:"organ",value:3,stackable:!0},severed_tongue:{id:"severed_tongue",name:"Severed Tongue",icon:"ðŸ‘…",type:"viscera",subtype:"organ",value:6,stackable:!0},eyeball:{id:"eyeball",name:"Eyeball",icon:"ðŸ‘ï¸",type:"viscera",subtype:"organ",value:8,stackable:!0},brain_matter:{id:"brain_matter",name:"Brain Matter",icon:"ðŸ§ ",type:"viscera",subtype:"organ",value:15,stackable:!0},skull:{id:"skull",name:"Skull",icon:"ðŸ’€",type:"viscera",subtype:"bone",value:10,stackable:!0},sinew:{id:"sinew",name:"Sinew",icon:"ðŸ§µ",type:"viscera",subtype:"tissue",value:4,stackable:!0},rendered_fat:{id:"rendered_fat",name:"Rendered Fat",icon:"ðŸ« ",type:"viscera",subtype:"tissue",value:3,stackable:!0},rusty_sword:{id:"rusty_sword",name:"Rusty Sword",icon:"ðŸ—¡ï¸",type:"weapon",subtype:"sword",value:10,stackable:!1},worn_dagger:{id:"worn_dagger",name:"Worn Dagger",icon:"ðŸ”ª",type:"weapon",subtype:"dagger",value:8,stackable:!1},crude_axe:{id:"crude_axe",name:"Crude Axe",icon:"ðŸª“",type:"weapon",subtype:"axe",value:12,stackable:!1},bandit_bow:{id:"bandit_bow",name:"Bandit Bow",icon:"ðŸ¹",type:"weapon",subtype:"bow",value:15,stackable:!1},leather_armor:{id:"leather_armor",name:"Leather Armor",icon:"ðŸ¥‹",type:"armor",subtype:"light",value:20,stackable:!1},iron_helm:{id:"iron_helm",name:"Iron Helm",icon:"â›‘ï¸",type:"armor",subtype:"head",value:15,stackable:!1},dark_plate:{id:"dark_plate",name:"Dark Plate",icon:"ðŸ–¤",type:"armor",subtype:"heavy",value:50,stackable:!1},gold_pouch:{id:"gold_pouch",name:"Gold Pouch",icon:"ðŸ‘›",type:"valuable",subtype:"currency",value:25,stackable:!1},silver_ring:{id:"silver_ring",name:"Silver Ring",icon:"ðŸ’",type:"valuable",subtype:"jewelry",value:15,stackable:!1},stolen_goods:{id:"stolen_goods",name:"Stolen Goods",icon:"ðŸ“¦",type:"valuable",subtype:"trade",value:12,stackable:!0},treasure_map:{id:"treasure_map",name:"Treasure Map",icon:"ðŸ—ºï¸",type:"valuable",subtype:"quest",value:30,stackable:!1},lockpick:{id:"lockpick",name:"Lockpick",icon:"ðŸ”§",type:"tool",subtype:"tool",value:5,stackable:!0},healing_herb:{id:"healing_herb",name:"Healing Herb",icon:"ðŸŒ¿",type:"consumable",subtype:"herb",value:6,stackable:!0},antidote:{id:"antidote",name:"Antidote",icon:"ðŸ§ª",type:"consumable",subtype:"potion",value:10,stackable:!0}},ms={rat:[{itemId:"rat_hide",chance:.6,min:1,max:1},{itemId:"rat_teeth",chance:.4,min:1,max:2},{itemId:"rat_meat",chance:.5,min:1,max:1},{itemId:"small_bones",chance:.3,min:1,max:2}],wolf:[{itemId:"wolf_pelt",chance:.7,min:1,max:1},{itemId:"wolf_fang",chance:.5,min:1,max:2},{itemId:"raw_meat",chance:.6,min:1,max:2},{itemId:"animal_bones",chance:.4,min:1,max:2}],dire_wolf:[{itemId:"dire_wolf_pelt",chance:.8,min:1,max:1},{itemId:"wolf_fang",chance:.7,min:2,max:3},{itemId:"quality_meat",chance:.6,min:1,max:2},{itemId:"large_bones",chance:.5,min:1,max:2}],bear:[{itemId:"bear_hide",chance:.8,min:1,max:1},{itemId:"bear_claw",chance:.6,min:2,max:4},{itemId:"quality_meat",chance:.7,min:2,max:3},{itemId:"large_bones",chance:.5,min:1,max:3}],boar:[{itemId:"boar_hide",chance:.7,min:1,max:1},{itemId:"boar_tusk",chance:.5,min:1,max:2},{itemId:"boar_meat",chance:.8,min:1,max:2},{itemId:"animal_bones",chance:.4,min:1,max:2}],snake:[{itemId:"snake_fang",chance:.6,min:1,max:2},{itemId:"venom_sac",chance:.3,min:1,max:1},{itemId:"small_bones",chance:.4,min:1,max:1}],cobra:[{itemId:"snake_fang",chance:.7,min:2,max:2},{itemId:"venom_sac",chance:.5,min:1,max:1},{itemId:"small_bones",chance:.4,min:1,max:2}],scorpion:[{itemId:"scorpion_stinger",chance:.7,min:1,max:1},{itemId:"scorpion_chitin",chance:.6,min:1,max:2},{itemId:"venom_sac",chance:.4,min:1,max:1}],spider:[{itemId:"spider_silk",chance:.7,min:1,max:3},{itemId:"venom_sac",chance:.3,min:1,max:1},{itemId:"small_bones",chance:.3,min:1,max:1}],lion:[{itemId:"lion_pelt",chance:.8,min:1,max:1},{itemId:"lion_claw",chance:.6,min:2,max:4},{itemId:"quality_meat",chance:.7,min:2,max:3},{itemId:"large_bones",chance:.5,min:1,max:2}],jaguar:[{itemId:"jaguar_pelt",chance:.8,min:1,max:1},{itemId:"lion_claw",chance:.5,min:2,max:3},{itemId:"quality_meat",chance:.6,min:1,max:2},{itemId:"animal_bones",chance:.4,min:1,max:2}],mountain_cat:[{itemId:"wolf_pelt",chance:.7,min:1,max:1},{itemId:"lion_claw",chance:.5,min:1,max:2},{itemId:"raw_meat",chance:.6,min:1,max:2}],crocodile:[{itemId:"croc_hide",chance:.8,min:1,max:1},{itemId:"croc_tooth",chance:.6,min:2,max:4},{itemId:"quality_meat",chance:.5,min:1,max:2},{itemId:"large_bones",chance:.4,min:1,max:2}],hyena:[{itemId:"wolf_pelt",chance:.5,min:1,max:1},{itemId:"wolf_fang",chance:.4,min:1,max:2},{itemId:"raw_meat",chance:.5,min:1,max:1}],goblin:[{itemId:"goblin_ear",chance:.8,min:1,max:2},{itemId:"worn_dagger",chance:.2,min:1,max:1},{itemId:"stolen_goods",chance:.3,min:1,max:1},{itemId:"lockpick",chance:.15,min:1,max:2}],hobgoblin:[{itemId:"goblin_ear",chance:.9,min:2,max:2},{itemId:"rusty_sword",chance:.3,min:1,max:1},{itemId:"leather_armor",chance:.15,min:1,max:1},{itemId:"gold_pouch",chance:.2,min:1,max:1}],imp:[{itemId:"imp_horn",chance:.7,min:1,max:2},{itemId:"ember_core",chance:.2,min:1,max:1},{itemId:"small_bones",chance:.4,min:1,max:1}],slime:[{itemId:"slime_goo",chance:.9,min:2,max:4}],gel:[{itemId:"toxic_goo",chance:.9,min:2,max:4},{itemId:"slime_goo",chance:.5,min:1,max:2}],ember:[{itemId:"ember_core",chance:.8,min:1,max:2}],needler:[{itemId:"cactus_needle",chance:.9,min:3,max:6},{itemId:"healing_herb",chance:.3,min:1,max:1}],mandragora:[{itemId:"mandragora_root",chance:.8,min:1,max:2},{itemId:"healing_herb",chance:.5,min:1,max:2}],living_oak:[{itemId:"living_bark",chance:.9,min:2,max:4},{itemId:"large_bones",chance:.3,min:1,max:2}],hornet:[{itemId:"hornet_stinger",chance:.7,min:1,max:1},{itemId:"small_bones",chance:.3,min:1,max:1}],beetle:[{itemId:"beetle_shell",chance:.8,min:1,max:2},{itemId:"small_bones",chance:.4,min:1,max:1}],whisker_cat:[{itemId:"whisker",chance:.6,min:1,max:2},{itemId:"lion_pelt",chance:.5,min:1,max:1},{itemId:"lion_claw",chance:.4,min:1,max:2}],cockatrice:[{itemId:"cockatrice_feather",chance:.8,min:2,max:4},{itemId:"animal_bones",chance:.5,min:1,max:2}],gillkin:[{itemId:"gillkin_scale",chance:.8,min:2,max:4},{itemId:"fish_scales",chance:.5,min:1,max:3},{itemId:"raw_meat",chance:.4,min:1,max:1}],skeleton:[{itemId:"bone_dust",chance:.9,min:2,max:4},{itemId:"rusty_sword",chance:.2,min:1,max:1},{itemId:"iron_helm",chance:.1,min:1,max:1}],zombie:[{itemId:"rotting_flesh",chance:.8,min:1,max:3},{itemId:"bone_dust",chance:.5,min:1,max:2}],ghost:[{itemId:"ghost_essence",chance:.7,min:1,max:2}],bandit:[{itemId:"worn_dagger",chance:.25,min:1,max:1},{itemId:"rusty_sword",chance:.2,min:1,max:1},{itemId:"stolen_goods",chance:.5,min:1,max:2},{itemId:"gold_pouch",chance:.3,min:1,max:1},{itemId:"lockpick",chance:.2,min:1,max:2},{itemId:"healing_herb",chance:.25,min:1,max:1}],bandit_leader:[{itemId:"rusty_sword",chance:.4,min:1,max:1},{itemId:"leather_armor",chance:.3,min:1,max:1},{itemId:"gold_pouch",chance:.7,min:1,max:2},{itemId:"silver_ring",chance:.2,min:1,max:1},{itemId:"treasure_map",chance:.1,min:1,max:1}],pirate:[{itemId:"worn_dagger",chance:.3,min:1,max:1},{itemId:"gold_pouch",chance:.4,min:1,max:1},{itemId:"stolen_goods",chance:.5,min:1,max:2},{itemId:"treasure_map",chance:.05,min:1,max:1}],pirate_captain:[{itemId:"rusty_sword",chance:.4,min:1,max:1},{itemId:"gold_pouch",chance:.7,min:1,max:2},{itemId:"stolen_goods",chance:.6,min:2,max:4},{itemId:"treasure_map",chance:.2,min:1,max:1},{itemId:"silver_ring",chance:.3,min:1,max:1}],mercenary:[{itemId:"rusty_sword",chance:.3,min:1,max:1},{itemId:"leather_armor",chance:.2,min:1,max:1},{itemId:"gold_pouch",chance:.5,min:1,max:1},{itemId:"healing_herb",chance:.3,min:1,max:2}],highwayman:[{itemId:"worn_dagger",chance:.35,min:1,max:1},{itemId:"bandit_bow",chance:.2,min:1,max:1},{itemId:"stolen_goods",chance:.5,min:1,max:3},{itemId:"gold_pouch",chance:.4,min:1,max:1}],wraith:[{itemId:"ghost_essence",chance:.8,min:1,max:3},{itemId:"bone_dust",chance:.5,min:1,max:2}],specter:[{itemId:"ghost_essence",chance:.6,min:1,max:2}],troll:[{itemId:"troll_blood",chance:.8,min:1,max:2},{itemId:"large_bones",chance:.7,min:2,max:4},{itemId:"quality_meat",chance:.5,min:2,max:3}],ogre:[{itemId:"large_bones",chance:.8,min:3,max:5},{itemId:"crude_axe",chance:.3,min:1,max:1},{itemId:"gold_pouch",chance:.4,min:1,max:2}],orc_warrior:[{itemId:"crude_axe",chance:.35,min:1,max:1},{itemId:"iron_helm",chance:.25,min:1,max:1},{itemId:"leather_armor",chance:.2,min:1,max:1},{itemId:"gold_pouch",chance:.4,min:1,max:1}],dark_knight:[{itemId:"dark_plate",chance:.25,min:1,max:1},{itemId:"rusty_sword",chance:.5,min:1,max:1},{itemId:"gold_pouch",chance:.6,min:1,max:2},{itemId:"ghost_essence",chance:.2,min:1,max:1}],gargoyle:[{itemId:"gargoyle_dust",chance:.9,min:2,max:4},{itemId:"large_bones",chance:.4,min:1,max:2}],mimic:[{itemId:"gold_pouch",chance:.9,min:2,max:3},{itemId:"silver_ring",chance:.4,min:1,max:1},{itemId:"treasure_map",chance:.15,min:1,max:1},{itemId:"slime_goo",chance:.5,min:1,max:2}],ice_wolf:[{itemId:"wolf_pelt",chance:.7,min:1,max:1},{itemId:"wolf_fang",chance:.5,min:1,max:2},{itemId:"ice_crystal",chance:.3,min:1,max:1}],yeti:[{itemId:"yeti_fur",chance:.9,min:1,max:1},{itemId:"large_bones",chance:.6,min:2,max:3},{itemId:"ice_crystal",chance:.4,min:1,max:2}],ice_elemental:[{itemId:"ice_crystal",chance:.95,min:2,max:4}]};function gs(T){const e=ms[T];if(!e)return[];const t=[];for(const i of e)if(Math.random()<i.chance){const s=oi[i.itemId];if(s){const a=i.min+Math.floor(Math.random()*(i.max-i.min+1));t.push({...s,quantity:a})}}return t}const ps={small:[{itemId:"beast_blood",chance:.7,min:1,max:1},{itemId:"entrails",chance:.5,min:1,max:1},{itemId:"eyeball",chance:.3,min:1,max:2}],medium:[{itemId:"beast_heart",chance:.6,min:1,max:1},{itemId:"beast_blood",chance:.8,min:1,max:2},{itemId:"entrails",chance:.7,min:1,max:2},{itemId:"organ_meat",chance:.5,min:1,max:2},{itemId:"eyeball",chance:.4,min:1,max:2},{itemId:"sinew",chance:.4,min:1,max:2}],large:[{itemId:"beast_heart",chance:.8,min:1,max:1},{itemId:"beast_blood",chance:.9,min:2,max:4},{itemId:"entrails",chance:.8,min:2,max:3},{itemId:"organ_meat",chance:.7,min:2,max:4},{itemId:"brain_matter",chance:.4,min:1,max:1},{itemId:"skull",chance:.3,min:1,max:1},{itemId:"eyeball",chance:.5,min:2,max:2},{itemId:"severed_tongue",chance:.4,min:1,max:1},{itemId:"sinew",chance:.6,min:2,max:4},{itemId:"rendered_fat",chance:.5,min:2,max:3}],humanoid:[{itemId:"beast_heart",chance:.5,min:1,max:1},{itemId:"beast_blood",chance:.7,min:1,max:2},{itemId:"brain_matter",chance:.3,min:1,max:1},{itemId:"skull",chance:.4,min:1,max:1},{itemId:"eyeball",chance:.5,min:1,max:2},{itemId:"severed_tongue",chance:.3,min:1,max:1},{itemId:"sinew",chance:.4,min:1,max:2}],undead:[{itemId:"bone_dust",chance:.8,min:2,max:4},{itemId:"rotting_flesh",chance:.7,min:1,max:3},{itemId:"skull",chance:.5,min:1,max:1},{itemId:"entrails",chance:.3,min:1,max:2}]},Ut={rat:"small",snake:"small",spider:"small",scorpion:"small",wolf:"medium",boar:"medium",goblin:"humanoid",bandit:"humanoid",bear:"large",troll:"large",ogre:"large",dire_wolf:"medium",skeleton:"undead",zombie:"undead",ghost:"undead",beast:"medium",humanoid:"humanoid",undead:"undead",insect:"small"};function fs(T,e="beast"){let t=Ut[T]||Ut[e]||"medium";const i=ps[t];if(!i)return[];const s=[];for(const a of i)if(Math.random()<a.chance){const n=oi[a.itemId];if(n){const r=a.min+Math.floor(Math.random()*(a.max-a.min+1));s.push({...n,quantity:r})}}return s}const W={rat:{id:"rat",name:"Giant Rat",icon:"ðŸ€",hp:6,damage:[1,3],defense:0,agility:7,xp:4,gold:[0,1],biomes:["swamp","cave","ruins","dungeon"],category:"beast",behavior:"skittish"},wolf:{id:"wolf",name:"Wolf",icon:"ðŸº",hp:15,damage:[3,6],defense:1,agility:6,xp:10,gold:[0,3],biomes:["forest","taiga","tundra","grassland"],category:"beast",behavior:"aggressive"},dire_wolf:{id:"dire_wolf",name:"Dire Wolf",icon:"ðŸº",hp:28,damage:[5,10],defense:2,agility:6,xp:22,gold:[2,8],biomes:["taiga","tundra","mountain"],category:"beast",behavior:"aggressive"},bear:{id:"bear",name:"Brown Bear",icon:"ðŸ»",hp:35,damage:[6,11],defense:3,agility:3,xp:28,gold:[0,5],biomes:["forest","taiga","mountain"],category:"beast",behavior:"territorial"},snake:{id:"snake",name:"Pit Viper",icon:"ðŸ",hp:8,damage:[2,5],defense:0,agility:8,xp:8,gold:[0,2],biomes:["swamp","desert","rainforest","grassland"],category:"beast",behavior:"passive"},cobra:{id:"cobra",name:"King Cobra",icon:"ðŸ",hp:14,damage:[4,8],defense:0,agility:9,xp:14,gold:[1,4],biomes:["desert","rainforest"],category:"beast",behavior:"passive"},scorpion:{id:"scorpion",name:"Giant Scorpion",icon:"ðŸ¦‚",hp:18,damage:[4,8],defense:4,agility:4,xp:15,gold:[0,5],biomes:["desert","savanna"],category:"beast",behavior:"passive"},spider:{id:"spider",name:"Cave Spider",icon:"ðŸ•·ï¸",hp:12,damage:[3,6],defense:1,agility:7,xp:12,gold:[0,3],biomes:["swamp","cave","dungeon","rainforest"],category:"beast",behavior:"passive"},lion:{id:"lion",name:"Lion",icon:"ðŸ¦",hp:32,damage:[6,11],defense:2,agility:7,xp:26,gold:[0,4],biomes:["savanna","grassland"],category:"beast",behavior:"aggressive"},jaguar:{id:"jaguar",name:"Jaguar",icon:"ðŸ†",hp:26,damage:[5,10],defense:1,agility:9,xp:22,gold:[0,3],biomes:["rainforest","swamp"],category:"beast",behavior:"aggressive"},mountain_cat:{id:"mountain_cat",name:"Mountain Lion",icon:"ðŸ±",hp:24,damage:[4,9],defense:1,agility:8,xp:18,gold:[0,3],biomes:["mountain","taiga","tundra"],category:"beast",behavior:"territorial"},boar:{id:"boar",name:"Wild Boar",icon:"ðŸ—",hp:20,damage:[4,7],defense:2,agility:4,xp:12,gold:[0,2],biomes:["forest","grassland","swamp"],category:"beast",behavior:"territorial"},crocodile:{id:"crocodile",name:"Crocodile",icon:"ðŸŠ",hp:30,damage:[6,12],defense:4,agility:3,xp:24,gold:[0,4],biomes:["swamp","coast","rainforest"],category:"beast",behavior:"passive"},hyena:{id:"hyena",name:"Hyena",icon:"ðŸ¦´",hp:14,damage:[3,6],defense:1,agility:6,xp:10,gold:[0,2],biomes:["savanna","desert"],category:"beast",behavior:"aggressive"},goblin:{id:"goblin",name:"Goblin",icon:"ðŸ‘º",hp:10,damage:[2,5],defense:1,agility:6,xp:8,gold:[3,10],biomes:["cave","forest","swamp","ruins"],category:"goblinoid"},hobgoblin:{id:"hobgoblin",name:"Hobgoblin",icon:"ðŸ‘º",hp:22,damage:[4,8],defense:3,agility:5,xp:18,gold:[5,15],biomes:["cave","fortress","ruins"],category:"goblinoid"},imp:{id:"imp",name:"Imp",icon:"ðŸ˜ˆ",hp:8,damage:[2,5],defense:0,agility:9,xp:10,gold:[2,6],biomes:["cave","dungeon","ruins"],category:"demon"},slime:{id:"slime",name:"Slime",icon:"ðŸŸ¢",hp:20,damage:[3,6],defense:6,agility:2,xp:14,gold:[1,5],biomes:["swamp","cave","dungeon"],category:"slime"},gel:{id:"gel",name:"Toxic Gel",icon:"ðŸŸ£",hp:35,damage:[5,9],defense:8,agility:1,xp:24,gold:[3,10],biomes:["dungeon","cave"],category:"slime"},ember:{id:"ember",name:"Ember",icon:"ðŸ”¥",hp:15,damage:[4,10],defense:2,agility:3,xp:16,gold:[2,8],biomes:["mountain","cave","dungeon"],category:"elemental"},needler:{id:"needler",name:"Needler",icon:"ðŸŒµ",hp:12,damage:[8,15],defense:0,agility:12,xp:30,gold:[10,25],biomes:["desert"],category:"plant"},mandragora:{id:"mandragora",name:"Mandragora",icon:"ðŸ¥¬",hp:16,damage:[3,7],defense:1,agility:5,xp:12,gold:[2,6],biomes:["forest","rainforest","swamp"],category:"plant"},living_oak:{id:"living_oak",name:"Living Oak",icon:"ðŸŒ³",hp:45,damage:[6,12],defense:6,agility:1,xp:35,gold:[5,15],biomes:["forest","rainforest"],category:"plant"},hornet:{id:"hornet",name:"Killer Hornet",icon:"ðŸ",hp:10,damage:[3,6],defense:0,agility:10,xp:10,gold:[0,3],biomes:["forest","grassland","rainforest"],category:"insect"},beetle:{id:"beetle",name:"Iron Beetle",icon:"ðŸª²",hp:18,damage:[3,6],defense:7,agility:2,xp:14,gold:[1,5],biomes:["forest","cave","grassland"],category:"insect"},whisker_cat:{id:"whisker_cat",name:"Whisker Cat",icon:"ðŸˆ",hp:28,damage:[5,11],defense:2,agility:8,xp:24,gold:[4,12],biomes:["grassland","savanna","mountain"],category:"magical_beast"},cockatrice:{id:"cockatrice",name:"Cockatrice",icon:"ðŸ“",hp:22,damage:[4,9],defense:2,agility:6,xp:20,gold:[3,10],biomes:["mountain","ruins","desert"],category:"magical_beast"},gillkin:{id:"gillkin",name:"Gillkin",icon:"ðŸ¸",hp:20,damage:[4,8],defense:2,agility:5,xp:16,gold:[3,9],biomes:["swamp","coast","rainforest"],category:"aquatic"},skeleton:{id:"skeleton",name:"Skeleton",icon:"ðŸ’€",hp:15,damage:[3,7],defense:1,agility:4,xp:12,gold:[2,8],biomes:["ruins","dungeon","cave","swamp","forest","mountain"],category:"undead",nightOnly:!0},zombie:{id:"zombie",name:"Zombie",icon:"ðŸ§Ÿ",hp:25,damage:[4,8],defense:2,agility:2,xp:14,gold:[1,5],biomes:["ruins","dungeon","swamp","forest","grassland"],category:"undead",nightOnly:!0},ghost:{id:"ghost",name:"Ghost",icon:"ðŸ‘»",hp:18,damage:[4,9],defense:0,agility:8,xp:18,gold:[4,12],biomes:["ruins","dungeon","castle","cave","forest"],category:"undead",nightOnly:!0},bandit:{id:"bandit",name:"Bandit",icon:"ðŸ—¡ï¸",hp:20,damage:[4,8],defense:2,agility:5,xp:15,gold:[5,15],biomes:["grassland","savanna","forest","desert"],category:"humanoid"},bandit_leader:{id:"bandit_leader",name:"Bandit Captain",icon:"âš”ï¸",hp:38,damage:[6,12],defense:4,agility:5,xp:40,gold:[15,35],biomes:["grassland","forest","fortress"],category:"humanoid"},pirate:{id:"pirate",name:"Pirate",icon:"ðŸ´â€â˜ ï¸",hp:22,damage:[4,9],defense:2,agility:5,xp:18,gold:[8,20],biomes:["coast","beach"],category:"humanoid"},pirate_captain:{id:"pirate_captain",name:"Pirate Captain",icon:"ðŸ´â€â˜ ï¸",hp:40,damage:[7,13],defense:4,agility:5,xp:38,gold:[25,50],biomes:["coast","beach"],category:"humanoid"},mercenary:{id:"mercenary",name:"Mercenary",icon:"âš”ï¸",hp:28,damage:[5,10],defense:3,agility:5,xp:22,gold:[10,25],biomes:["grassland","forest","savanna","mountain","desert"],category:"humanoid"},highwayman:{id:"highwayman",name:"Highwayman",icon:"ðŸ—¡ï¸",hp:24,damage:[5,9],defense:2,agility:7,xp:20,gold:[12,30],biomes:["grassland","forest","savanna"],category:"humanoid"},wraith:{id:"wraith",name:"Wraith",icon:"ðŸ‘¤",hp:25,damage:[6,12],defense:1,agility:8,xp:30,gold:[5,15],biomes:["ruins","dungeon","swamp","cave"],category:"undead",nightOnly:!0},specter:{id:"specter",name:"Specter",icon:"ðŸ‘»",hp:20,damage:[5,10],defense:0,agility:9,xp:25,gold:[3,10],biomes:["ruins","dungeon","cave","forest"],category:"undead",nightOnly:!0},troll:{id:"troll",name:"Cave Troll",icon:"ðŸ‘¹",hp:50,damage:[8,15],defense:5,agility:2,xp:50,gold:[10,30],biomes:["mountain","cave","dungeon"],category:"giant"},ogre:{id:"ogre",name:"Ogre",icon:"ðŸ‘¹",hp:60,damage:[10,16],defense:4,agility:2,xp:55,gold:[12,35],biomes:["cave","swamp","fortress"],category:"giant"},orc_warrior:{id:"orc_warrior",name:"Orc Warrior",icon:"ðŸ§Ÿ",hp:35,damage:[6,12],defense:4,agility:4,xp:35,gold:[8,20],biomes:["fortress","keep","dungeon"],category:"humanoid"},dark_knight:{id:"dark_knight",name:"Dark Knight",icon:"ðŸ–¤",hp:55,damage:[10,18],defense:8,agility:4,xp:65,gold:[20,50],biomes:["castle","fortress","dungeon"],category:"humanoid"},gargoyle:{id:"gargoyle",name:"Gargoyle",icon:"ðŸ—¿",hp:40,damage:[6,12],defense:8,agility:5,xp:45,gold:[8,20],biomes:["castle","ruins","dungeon"],category:"magical_beast"},mimic:{id:"mimic",name:"Mimic",icon:"ðŸ“¦",hp:30,damage:[7,14],defense:4,agility:3,xp:40,gold:[20,50],biomes:["dungeon","ruins","castle"],category:"magical_beast"},ice_wolf:{id:"ice_wolf",name:"Frost Wolf",icon:"ðŸº",hp:24,damage:[5,9],defense:2,agility:7,xp:20,gold:[2,7],biomes:["tundra","snow_peak"],category:"beast"},yeti:{id:"yeti",name:"Yeti",icon:"ðŸ¦",hp:55,damage:[8,14],defense:5,agility:3,xp:48,gold:[8,25],biomes:["snow_peak","tundra"],category:"giant"},ice_elemental:{id:"ice_elemental",name:"Ice Elemental",icon:"â„ï¸",hp:35,damage:[6,12],defense:4,agility:4,xp:38,gold:[5,15],biomes:["snow_peak","tundra","mountain"],category:"elemental"},BAT:{id:"BAT",name:"Cave Bat",icon:"ðŸ¦‡",hp:15,damage:[2,4],defense:0,agility:12,xp:10,gold:[0,2],biomes:["cave","dungeon"],category:"beast",behavior:"swarm"},SPIDER:{id:"SPIDER",name:"Giant Spider",icon:"ðŸ•·ï¸",hp:25,damage:[5,10],defense:2,agility:6,xp:20,gold:[2,6],biomes:["cave","dungeon","ruins"],category:"beast",behavior:"ambush"},CAVE_TROLL:{id:"CAVE_TROLL",name:"Cave Troll",icon:"ðŸ‘¹",hp:80,damage:[12,20],defense:8,agility:2,xp:60,gold:[15,40],biomes:["cave","dungeon"],category:"giant",behavior:"aggressive"},SKELETON:{id:"SKELETON",name:"Skeleton",icon:"ðŸ’€",hp:30,damage:[6,12],defense:3,agility:5,xp:25,gold:[3,10],biomes:["ruins","dungeon","cave"],category:"undead",behavior:"aggressive"},GHOST:{id:"GHOST",name:"Restless Spirit",icon:"ðŸ‘»",hp:20,damage:[8,15],defense:0,agility:10,xp:30,gold:[0,5],biomes:["ruins","dungeon","shrine"],category:"undead",behavior:"passive"},GOBLIN:{id:"GOBLIN",name:"Goblin",icon:"ðŸ‘º",hp:20,damage:[4,8],defense:2,agility:8,xp:15,gold:[5,15],biomes:["cave","mine","dungeon"],category:"humanoid",behavior:"skittish"},RAT:{id:"RAT",name:"Giant Rat",icon:"ðŸ€",hp:8,damage:[2,4],defense:0,agility:8,xp:5,gold:[0,2],biomes:["cave","mine","dungeon"],category:"beast",behavior:"swarm"},UNDEAD_MINER:{id:"UNDEAD_MINER",name:"Undead Miner",icon:"â›ï¸",hp:35,damage:[8,14],defense:4,agility:3,xp:35,gold:[10,25],biomes:["mine","dungeon"],category:"undead",behavior:"aggressive"},SPIRIT:{id:"SPIRIT",name:"Ancient Spirit",icon:"âœ¨",hp:25,damage:[10,18],defense:0,agility:9,xp:40,gold:[0,10],biomes:["shrine","temple"],category:"spirit",behavior:"passive"},GUARDIAN:{id:"GUARDIAN",name:"Stone Guardian",icon:"ðŸ—¿",hp:100,damage:[15,25],defense:15,agility:1,xp:80,gold:[20,50],biomes:["shrine","temple","ruins"],category:"construct",behavior:"territorial"},CONSTRUCT:{id:"CONSTRUCT",name:"Ancient Construct",icon:"ðŸ¤–",hp:60,damage:[10,16],defense:10,agility:3,xp:55,gold:[15,35],biomes:["ruins","temple"],category:"construct",behavior:"territorial"},CULTIST:{id:"CULTIST",name:"Dark Cultist",icon:"ðŸ§™",hp:25,damage:[8,14],defense:2,agility:5,xp:30,gold:[8,20],biomes:["temple","dungeon"],category:"humanoid",behavior:"aggressive"},DEMON:{id:"DEMON",name:"Lesser Demon",icon:"ðŸ˜ˆ",hp:70,damage:[12,22],defense:6,agility:6,xp:70,gold:[20,50],biomes:["temple","dungeon"],category:"demon",behavior:"aggressive"},BANDIT:{id:"BANDIT",name:"Bandit",icon:"ðŸ—¡ï¸",hp:30,damage:[6,12],defense:3,agility:6,xp:25,gold:[10,30],biomes:["fortress","keep","castle"],category:"humanoid",behavior:"aggressive"},KNIGHT:{id:"KNIGHT",name:"Fallen Knight",icon:"âš”ï¸",hp:55,damage:[10,18],defense:8,agility:4,xp:50,gold:[15,40],biomes:["fortress","castle"],category:"undead",behavior:"territorial"},WARLORD:{id:"WARLORD",name:"Warlord",icon:"ðŸ‘‘",hp:90,damage:[14,24],defense:10,agility:5,xp:100,gold:[40,100],biomes:["fortress","castle"],category:"humanoid",behavior:"aggressive"},FOREST_BEAST:{id:"FOREST_BEAST",name:"Forest Spirit Beast",icon:"ðŸŒ¿",hp:45,damage:[8,15],defense:4,agility:7,xp:45,gold:[5,20],biomes:["forest_grove"],category:"spirit",behavior:"territorial"}},Be={ocean:0,coast:.01,grassland:.03,forest:.05,rainforest:.07,savanna:.04,desert:.05,swamp:.08,taiga:.05,tundra:.04,mountain:.06,snow_peak:.03,cave:.2,dungeon:.35,ruins:.15,fortress:.3,castle:.25,keep:.2};class Vt{constructor(e){this.state=e,this.currentEncounter=null,this.combatLog=[],this.combatLoopId=null,this.lastTick=0,this.onCombatUpdate=null,this.onDungeonCombatEnd=null,this.onNPCCombatEnd=null,this.onBanditAmbushEnd=null,this.onCombatEvent=null,this.ENEMIES=W,this.combatTick=this.combatTick.bind(this)}emitCombatEvent(e,t={}){this.onCombatEvent&&this.onCombatEvent(e,t)}checkEncounter(e,t=null){let i=Be[e]||.05;return t&&Be[t.type.id]&&(i=Be[t.type.id]),t&&t.type.category==="settlement"?null:Math.random()<i?this.generateEncounter(e,t):null}generateEncounter(e,t=null){const i=t?t.type.id:e,s=Object.values(W).filter(o=>o.biomes.includes(i)||o.biomes.includes(e));if(s.length===0)return this.createEncounter(W.bandit);const a=s.sort((o,l)=>o.hp-l.hp),n=Math.floor(Math.random()*Math.random()*a.length),r=a[n];return this.createEncounter(r)}createEncounter(e){const i=1+(Math.random()*.2*2-.2),s=2e3,a=1-e.agility*.03,n=Math.max(800,s*a);return{enemy:{...e,maxHp:Math.floor(e.hp*i),currentHp:Math.floor(e.hp*i),damage:[...e.damage],chargeTime:n},playerStartHp:this.state.player.health,playerStartEther:this.state.player.ether,round:0,fled:!1,victory:!1,playerBuffs:{},enemyBuffs:{},combatState:{playerAction:null,playerActionData:null,playerChargeTime:0,playerChargeProgress:0,playerReady:!1,pendingAction:null,pendingActionData:null,enemyChargeProgress:0,paused:!1,turnTimerActive:!1,turnTimerDuration:0,turnTimerRemaining:0,turnTimerStarted:0,actionsThisTurn:0,playerConditions:[]}}}getPlayerWeapon(){const t={warrior:"sword",paladin:"sword",rogue:"dagger",ranger:"bow",mage:"staff",cleric:"staff",druid:"staff",mercenary:"axe",scout:"dagger",merchant:"dagger",artisan:"unarmed",scholar:"staff",mechanist:"unarmed"}[this.state.player.class]||"unarmed";return hs[t]}getPlayerWeaponDamage(){return this.getPlayerWeapon().damage||[3,6]}getAvailableActions(){const e=this.state.player,t=this.getPlayerWeapon(),i=[],s=t.staminaCost||3,a=e.stamina>=s;if(i.push({type:"attack",name:"Attack",icon:t.icon,description:`Basic ${t.name} attack (${s} stamina)`,available:a,cost:s}),t.skills)for(const o of t.skills){const l=Le[o],c=e.stamina>=l.staminaCost;i.push({type:"skill",skillId:o,name:l.name,icon:l.icon,description:`${l.description} (${l.staminaCost} stamina)`,available:c,cost:l.staminaCost})}if(["mage","cleric","druid","paladin","scholar"].includes(e.class))for(const o of["fire","ice","thunder"]){const l=Se[o],c=e.ether>=l.etherCost;i.push({type:"spell",spellId:o,name:l.name,icon:l.icon,description:`${l.description} (${l.etherCost} ether)`,available:c,cost:l.etherCost})}if(["cleric","druid","paladin"].includes(e.class)){const o=Se.cure;i.push({type:"spell",spellId:"cure",name:o.name,icon:o.icon,description:`${o.description} (${o.etherCost} ether)`,available:e.ether>=o.etherCost,cost:o.etherCost})}return i.push({type:"defend",name:"Defend",icon:"ðŸ›¡ï¸",description:"Reduce damage, chance to counter, recover 5 stamina",available:!0}),i.push({type:"stand_ground",name:"Stand Ground",icon:"ðŸ§˜",description:"Brace yourself, recover 10 stamina",available:!0}),i.push({type:"flee",name:"Flee",icon:"ðŸƒ",description:"Attempt to escape combat",available:!0}),i}startCombat(e){if(this.currentEncounter=e,this.combatLog=[],e.enemies&&e.enemies.length>0)if(e.enemies.length===1)this.addCombatLog(`A ${e.enemies[0].name} appears!`);else{const t=e.enemies.map(i=>i.name).join(" and ");this.addCombatLog(`${t} appear!`)}else e.enemy&&this.addCombatLog(`A ${e.enemy.name} appears!`);return e.combatState.playerReady=!0,e.combatState.enemyChargeProgress!==void 0&&(e.combatState.enemyChargeProgress=0),this.turnBasedMode=!0,e}startCombatLoop(){this.combatLoopId&&cancelAnimationFrame(this.combatLoopId),this.combatLoopId=requestAnimationFrame(this.combatTick)}stopCombatLoop(){this.combatLoopId&&(cancelAnimationFrame(this.combatLoopId),this.combatLoopId=null)}combatTick(e){if(!this.currentEncounter){this.stopCombatLoop();return}const t=this.currentEncounter.combatState;if(t.paused){this.lastTick=e,this.combatLoopId=requestAnimationFrame(this.combatTick);return}const i=e-this.lastTick;if(this.lastTick=e,this.tickBuffs(i),t.playerAction&&!t.playerReady&&(t.playerChargeProgress+=i,t.playerChargeProgress>=t.playerChargeTime&&this.executePlayerAction()),!this.currentEncounter){this.stopCombatLoop();return}if(this.currentEncounter.enemies){for(const s of this.currentEncounter.enemies)if(!(s.dead||s.currentHp<=0)&&(s.chargeProgress+=i,s.chargeProgress>=s.chargeTime&&(this.executeEnemyAction(s),s.chargeProgress=0,!this.currentEncounter))){this.stopCombatLoop();return}this.currentEncounter&&this.currentEncounter.enemies&&this.currentEncounter.enemies.every(a=>a.dead||a.currentHp<=0)&&!this.currentEncounter.victory&&this.endCombat(!0)}else{const s=this.currentEncounter.enemy;s&&s.currentHp>0&&(t.enemyChargeProgress+=i,t.enemyChargeProgress>=s.chargeTime&&this.executeEnemyAction())}this.onCombatUpdate&&this.onCombatUpdate(this.getCombatState()),this.currentEncounter&&!this.currentEncounter.victory&&!this.currentEncounter.fled&&this.state.player.health>0?this.combatLoopId=requestAnimationFrame(this.combatTick):this.stopCombatLoop()}queuePlayerAction(e,t={}){if(!this.currentEncounter)return!1;const i=this.currentEncounter.combatState;return this.state.player,i.playerReady?this.startPlayerAction(e,t):(i.pendingAction=e,i.pendingActionData={...t},!0)}startPlayerAction(e,t={}){if(!this.currentEncounter)return!1;const i=this.currentEncounter.combatState,s=this.state.player;let a=0,n=0;if(e==="attack"){const o=this.getPlayerWeapon();if(n=o.staminaCost||3,s.stamina<n)return this.addCombatLog("Not enough stamina to attack!"),!1;a=o.chargeTime}else if(e==="skill"){const o=this.getPlayerWeapon(),l=Le[t.skillId];if(!l)return!1;if(n=l.staminaCost,s.stamina<n)return this.addCombatLog("Not enough stamina!"),!1;a=o.chargeTime*l.chargeMultiplier}else if(e==="spell"){const o=Se[t.spellId];if(!o)return!1;if(s.ether<o.etherCost)return this.addCombatLog("Not enough ether!"),!1;a=o.chargeTime}else e==="defend"?a=500:e==="stand_ground"?a=800:e==="flee"&&(a=1500);if(e==="attack"||e==="skill"){const l=1+(1-s.stamina/s.maxStamina)*1.5;a*=l}const r=1-s.attributes.agility*.02;return a=Math.max(300,a*r),this.currentEncounter.playerBuffs.agility_up&&(a*=.7),i.playerAction=e,i.playerActionData={...t,staminaCost:n},i.playerChargeTime=a,i.playerChargeProgress=0,i.playerReady=!1,!0}clearPendingAction(){if(!this.currentEncounter)return;const e=this.currentEncounter.combatState;e.pendingAction=null,e.pendingActionData=null}executePlayerAction(){if(!this.currentEncounter)return;const e=this.currentEncounter.combatState,t=e.playerAction,i=e.playerActionData||{},s=this.state.player;let a=this.getTargetedEnemy();a&&(a.dead||a.currentHp<=0)&&(this.cycleTarget(),a=this.getTargetedEnemy()),a||(a=this.currentEncounter.enemy),this.currentEncounter.round++;let n=!1;const r=this.getPlayerWeapon();if(t==="attack"){const o=i.staminaCost||r.staminaCost||3;s.stamina-=o,this.playerAttack(),n=r.melee}else if(t==="skill"){const o=Le[i.skillId];o&&s.stamina>=o.staminaCost&&(s.stamina-=o.staminaCost,this.playerSkillAttack(o),n=r.melee)}else if(t==="spell"){const o=Se[i.spellId];o&&s.ether>=o.etherCost&&(s.ether-=o.etherCost,this.castSpell(o))}else if(t==="defend"){this.currentEncounter.playerBuffs.defending=3e3;const o=5;s.stamina=Math.min(s.maxStamina,s.stamina+o),this.addCombatLog(`You brace for impact! (+${o} stamina)`),this.emitCombatEvent("playerDefend",{})}else if(t==="stand_ground")s.stamina=Math.min(s.maxStamina,s.stamina+10),this.addCombatLog("You steady yourself. (+10 stamina)");else if(t==="flee"){const o=.4+(s.attributes.agility-a.agility)*.05;if(Math.random()<o){this.currentEncounter.fled=!0,this.addCombatLog("You successfully fled!"),this.emitCombatEvent("playerFlee",{success:!0}),this.endCombat();return}else this.addCombatLog("Failed to flee!"),this.emitCombatEvent("playerFlee",{success:!1})}if(a.currentHp<=0){a.dead!==void 0&&(a.dead=!0),this.addCombatLog(`${a.name} defeated!`);const o=this.currentEncounter.enemies?this.currentEncounter.enemies.indexOf(a):0;if(this.emitCombatEvent("enemyKilled",{enemyIndex:o,enemy:a}),this.currentEncounter.enemies){if(this.currentEncounter.enemies.every(c=>c.dead||c.currentHp<=0)){this.currentEncounter.victory=!0,this.endCombat();return}this.cycleTarget()}else{this.currentEncounter.victory=!0,this.endCombat();return}}if(e.playerAction=null,e.playerActionData=null,e.playerChargeProgress=0,e.playerReady=!0,e.pendingAction){const o=e.pendingAction,l=e.pendingActionData||{};e.pendingAction=null,e.pendingActionData=null,this.startPlayerAction(o,l)}else n&&s.stamina>=(r.staminaCost||3)&&this.startPlayerAction("attack");this.state.notify()}executeEnemyAction(e=null){if(!this.currentEncounter)return;const t=this.currentEncounter.combatState,i=this.state.player,s=e||this.currentEncounter.enemy;if(!s)return;if(e||(t.enemyChargeProgress=0),this.currentEncounter.playerBuffs.defending>0){if(this.enemyAttack(.5,s),Math.random()<.3){const n=this.getTargetedEnemy()||s;this.playerAttack(.5,n),this.addCombatLog("Counter-attack!")}}else this.enemyAttack(1,s);if(i.health<=0){this.addCombatLog("You have been defeated..."),this.endCombat();return}this.state.notify()}getCombatState(){if(!this.currentEncounter)return null;const e=this.currentEncounter.combatState,t=e.turnTimerDuration>0?Math.max(0,e.turnTimerRemaining/e.turnTimerDuration*100):0,i={playerChargeProgress:e.playerChargeProgress,playerChargeTime:e.playerChargeTime,playerChargePercent:e.playerChargeTime>0?Math.min(100,e.playerChargeProgress/e.playerChargeTime*100):0,playerReady:e.playerReady,playerAction:e.playerAction,playerHealth:this.state.player.health,playerMaxHealth:this.state.player.maxHealth,playerStamina:this.state.player.stamina,playerEther:this.state.player.ether,log:this.combatLog,turnTimerActive:e.turnTimerActive,turnTimerDuration:e.turnTimerDuration,turnTimerRemaining:e.turnTimerRemaining,turnTimerPercent:t,actionsThisTurn:e.actionsThisTurn};if(this.currentEncounter.enemies)return{...i,enemies:this.currentEncounter.enemies.map(a=>({id:a.id,name:a.name,icon:a.icon,currentHp:a.currentHp,maxHp:a.maxHp,chargeProgress:a.chargeProgress,chargeTime:a.chargeTime,chargePercent:Math.min(100,a.chargeProgress/a.chargeTime*100),dead:a.dead||a.currentHp<=0})),targetedEnemyIndex:this.currentEncounter.targetedEnemyIndex,enemy:this.currentEncounter.enemies[this.currentEncounter.targetedEnemyIndex],enemyChargeProgress:0,enemyChargeTime:1e3,enemyChargePercent:0};const s=this.currentEncounter.enemy;return{...i,enemyChargeProgress:e.enemyChargeProgress,enemyChargeTime:s.chargeTime,enemyChargePercent:Math.min(100,e.enemyChargeProgress/s.chargeTime*100),enemy:s}}pauseCombat(e){this.currentEncounter&&(this.currentEncounter.combatState.paused=e)}calculateTurnDuration(){var s;const t=((s=this.state.player.attributes)==null?void 0:s.agility)||5;let i=ae.baseDuration+t*ae.agilityBonus;return i=Math.max(ae.minDuration,Math.min(ae.maxDuration,i)),i}startTurnTimer(){if(!this.currentEncounter)return;const e=this.currentEncounter.combatState,t=this.calculateTurnDuration();e.turnTimerActive=!0,e.turnTimerDuration=t,e.turnTimerRemaining=t,e.turnTimerStarted=performance.now(),e.actionsThisTurn=0;const i=this.state.player,s=ae.staminaRecoveryPerTurn;i.stamina=Math.min(i.maxStamina,i.stamina+s),this.turnTimerLoop()}stopTurnTimer(){if(!this.currentEncounter)return;const e=this.currentEncounter.combatState;e.turnTimerActive=!1,e.turnTimerRemaining=0,this.turnTimerAnimationId&&(cancelAnimationFrame(this.turnTimerAnimationId),this.turnTimerAnimationId=null)}turnTimerLoop(){if(!this.currentEncounter)return;const e=this.currentEncounter.combatState;if(!e.turnTimerActive||e.paused){this.turnTimerAnimationId=requestAnimationFrame(()=>this.turnTimerLoop());return}const i=performance.now()-e.turnTimerStarted;if(e.turnTimerRemaining=Math.max(0,e.turnTimerDuration-i),this.onTurnTimerUpdate&&this.onTurnTimerUpdate({remaining:e.turnTimerRemaining,duration:e.turnTimerDuration,percent:e.turnTimerRemaining/e.turnTimerDuration*100,actionsThisTurn:e.actionsThisTurn}),e.turnTimerRemaining<=0){this.onTurnTimerExpired();return}this.turnTimerAnimationId=requestAnimationFrame(()=>this.turnTimerLoop())}onTurnTimerExpired(){if(!this.currentEncounter)return;const e=this.currentEncounter.combatState;e.turnTimerActive=!1,this.onTurnEnded&&this.onTurnEnded({actionsThisTurn:e.actionsThisTurn,timedOut:!0})}endTurnEarly(){if(!this.currentEncounter)return;const e=this.currentEncounter.combatState;e.turnTimerActive&&(this.stopTurnTimer(),this.onTurnEnded&&this.onTurnEnded({actionsThisTurn:e.actionsThisTurn,timedOut:!1}))}recordActionThisTurn(){this.currentEncounter&&this.currentEncounter.combatState.actionsThisTurn++}subtractTimeOnHit(){if(!this.currentEncounter)return;const e=this.currentEncounter.combatState;if(!e.turnTimerActive)return;const t=ae.timePenaltyPerHit;e.turnTimerRemaining=Math.max(0,e.turnTimerRemaining-t),e.turnTimerRemaining<=0&&this.onTurnTimerExpired()}tryApplyCondition(e){if(!this.currentEncounter)return null;const t=e.category;if(!t)return null;const i=us[t];if(!i)return null;for(const[s,a]of Object.entries(i))if(Math.random()*100<a)return this.applyCondition(s);return null}applyCondition(e){if(!this.currentEncounter)return null;const t=_e[e];if(!t)return null;const i=this.currentEncounter.combatState;if(!i||!i.playerConditions)if(i)i.playerConditions=[];else return null;const s=i.playerConditions.findIndex(a=>a.id===e);if(s>=0){const a=i.playerConditions[s];return t.stackable&&a.stacks<(t.maxStacks||1)?(a.stacks++,a.turnsRemaining=t.duration,{condition:t,action:"stacked",stacks:a.stacks}):(a.turnsRemaining=t.duration,{condition:t,action:"refreshed"})}else return i.playerConditions.push({id:e,turnsRemaining:t.duration,stacks:1}),{condition:t,action:"applied"}}processConditionEffects(){if(!this.currentEncounter)return[];const e=this.currentEncounter.combatState,t=[],i=this.state.player;if(!e||!e.playerConditions)return t;for(const s of e.playerConditions){const a=_e[s.id];if(!a)continue;const n=s.stacks||1;if(a.damagePerTurn){const r=a.damagePerTurn*n;i.health=Math.max(0,i.health-r),t.push({condition:a,type:"damage",value:r})}if(a.staminaDrainPerTurn){const r=a.staminaDrainPerTurn*n;i.stamina=Math.max(0,i.stamina-r),t.push({condition:a,type:"staminaDrain",value:r})}if(a.etherDrainPerTurn){const r=a.etherDrainPerTurn*n;i.ether=Math.max(0,i.ether-r),t.push({condition:a,type:"etherDrain",value:r})}s.turnsRemaining--}return e.playerConditions=e.playerConditions.filter(s=>s.turnsRemaining>0),t}getConditionStatMods(){if(!this.currentEncounter)return{};const e=this.currentEncounter.combatState,t={damage:0,defense:0,agility:0,critChance:0,dodgeChance:0};for(const i of e.playerConditions){const s=_e[i.id];if(!(s!=null&&s.statMod))continue;const a=i.stacks||1;for(const[n,r]of Object.entries(s.statMod))t[n]!==void 0&&(t[n]+=r*a)}return t}isPlayerParalyzed(){return this.currentEncounter?this.currentEncounter.combatState.playerConditions.some(t=>{const i=_e[t.id];return i==null?void 0:i.skipTurn}):!1}getActiveConditions(){if(!this.currentEncounter)return[];const e=this.currentEncounter.combatState;return!e||!e.playerConditions?[]:e.playerConditions.map(t=>({..._e[t.id],turnsRemaining:t.turnsRemaining,stacks:t.stacks}))}clearConditions(){this.currentEncounter&&(this.currentEncounter.combatState.playerConditions=[])}canActDuringTurn(){if(!this.currentEncounter)return!1;const e=this.currentEncounter.combatState;if(!e.turnTimerActive||e.turnTimerRemaining<=0)return!1;const i=this.getPlayerWeapon().staminaCost||3;return this.state.player.stamina>=i||this.state.player.ether>=6}cancelPlayerAction(){if(!this.currentEncounter)return;const e=this.currentEncounter.combatState;e.playerAction=null,e.playerActionData=null,e.playerChargeProgress=0,e.pendingAction=null,e.pendingActionData=null,e.playerReady=!0}combatRound(e,t={}){if(!this.currentEncounter)return null;const i=this.state.player,s=this.currentEncounter.enemy;this.currentEncounter.round++,this.tickBuffs();let a=i.attributes.agility;this.currentEncounter.playerBuffs.agility_up&&(a+=5);const n=a>=s.agility;if(e==="attack")n?(this.playerAttack(),s.currentHp>0&&this.enemyAttack()):(this.enemyAttack(),i.health>0&&this.playerAttack());else if(e==="skill"){const r=Le[t.skillId];r&&i.stamina>=r.staminaCost&&(i.stamina-=r.staminaCost,n?(this.playerSkillAttack(r),s.currentHp>0&&this.enemyAttack()):(this.enemyAttack(),i.health>0&&this.playerSkillAttack(r)))}else if(e==="spell"){const r=Se[t.spellId];r&&i.ether>=r.etherCost&&(i.ether-=r.etherCost,this.castSpell(r),s.currentHp>0&&i.health>0&&this.enemyAttack())}else if(e==="defend"){this.currentEncounter.playerBuffs.defending=1;const r=5;i.stamina=Math.min(i.maxStamina,i.stamina+r),this.addCombatLog(`You brace for impact! (+${r} stamina)`),this.enemyAttack(.5),i.health>0&&Math.random()<.3&&(this.playerAttack(.5),this.addCombatLog("Counter-attack!"))}else if(e==="stand_ground")i.stamina=Math.min(i.maxStamina,i.stamina+10),this.addCombatLog("You steady yourself. (+10 stamina)"),this.enemyAttack();else if(e==="flee"){const r=.3+(a-s.agility)*.05;if(Math.random()<r)return this.currentEncounter.fled=!0,this.addCombatLog("You successfully fled!"),this.endCombat();this.addCombatLog("Failed to flee!"),this.enemyAttack()}return s.currentHp<=0?(this.currentEncounter.victory=!0,this.addCombatLog(`${s.name} defeated!`),this.endCombat()):i.health<=0?(this.addCombatLog("You have been defeated..."),this.endCombat()):{ongoing:!0,encounter:this.currentEncounter,log:this.combatLog,actions:this.getAvailableActions()}}tickBuffs(e){const t=this.currentEncounter.playerBuffs;for(const i of Object.keys(t))t[i]>0&&(t[i]-=e,t[i]<=0&&(delete t[i],this.addCombatLog(`${i.replace("_"," ")} wore off`)))}castSpell(e,t=null){const i=this.state.player,s=t||this.getTargetedEnemy()||this.currentEncounter.enemy,n=this.getPlayerWeapon().magicBonus||1;if(e.type==="offensive"){if(!s)return;const[r,o]=e.damage;let l=Math.floor((r+Math.random()*(o-r))*n);l=Math.max(1,l-Math.floor(s.defense*.3)),s.currentHp-=l,this.addCombatLog(`${e.icon} ${e.name} deals ${l} damage!`),this.emitCombatEvent("playerSpell",{spell:e,damage:l});const c=this.currentEncounter.enemies?this.currentEncounter.enemies.indexOf(s):0;this.emitCombatEvent("enemyDamaged",{enemyIndex:c,damage:l,enemy:s})}else if(e.type==="healing"){const[r,o]=e.healing,l=Math.floor((r+Math.random()*(o-r))*n),c=Math.min(l,i.maxHealth-i.health);i.health+=c,this.addCombatLog(`${e.icon} ${e.name} restores ${c} HP!`),this.emitCombatEvent("playerHeal",{spell:e,healing:c})}else e.type==="buff"&&(this.currentEncounter.playerBuffs[e.effect]=e.duration,this.addCombatLog(`${e.icon} ${e.name} activated!`),this.emitCombatEvent("playerBuff",{spell:e}))}playerSkillAttack(e,t=null){const i=this.state.player,s=t||this.getTargetedEnemy()||this.currentEncounter.enemy;if(!s)return;const a=this.getPlayerWeapon(),[n,r]=a.damage;let o=n+Math.random()*(r-n);o+=i.attributes.prestige/2;let l=Math.floor(o*e.damageMultiplier),c=s.defense;e.armorPiercing&&(c=Math.max(0,c-e.armorPiercing));let d=a.critChance;e.critBonus&&(d+=e.critBonus);const u=Math.random()<d;u&&(l=Math.floor(l*1.5)),l=Math.max(1,l-c),s.currentHp-=l;const h=u?" CRITICAL!":"";this.addCombatLog(`${e.icon} ${e.name} deals ${l} damage!${h}`),this.emitCombatEvent("playerSkill",{skill:e,weapon:a,damage:l}),u&&this.emitCombatEvent("criticalHit",{damage:l});const m=this.currentEncounter.enemies?this.currentEncounter.enemies.indexOf(s):0;this.emitCombatEvent("enemyDamaged",{enemyIndex:m,damage:l,enemy:s})}playerAttack(e=1,t=null){const i=this.state.player,s=t||this.getTargetedEnemy()||this.currentEncounter.enemy;if(!s)return;const a=this.getPlayerWeapon(),[n,r]=a.damage;let o=n+Math.random()*(r-n);o+=i.attributes.prestige/2,["warrior","paladin","mercenary","ranger"].includes(i.class)&&(o+=2);let c=Math.floor(o*e);const d=Math.random()<a.critChance;d&&(c=Math.floor(c*1.5)),c=Math.max(1,c-s.defense),s.currentHp-=c;const u=d?" (Critical!)":"";this.addCombatLog(`${a.icon} You deal ${c} damage${u}`),this.emitCombatEvent("playerAttack",{weapon:a,damage:c}),d&&this.emitCombatEvent("criticalHit",{damage:c});const h=this.currentEncounter.enemies?this.currentEncounter.enemies.indexOf(s):0;this.emitCombatEvent("enemyDamaged",{enemyIndex:h,damage:c,enemy:s})}enemyAttack(e=1,t=null){const i=this.state.player,s=t||this.currentEncounter.enemy;if(!s)return 0;const a=this.currentEncounter.playerBuffs,[n,r]=s.damage;let o=Math.floor((n+Math.random()*(r-n))*e),l=i.attributes.agility;return a.agility_up&&(l+=5),Math.random()<l*.02?(this.addCombatLog(`You dodged ${s.name}'s attack!`),this.emitCombatEvent("playerDodge",{enemy:s}),0):(a.defense_up&&(o=Math.floor(o*.6),this.addCombatLog("Protect reduces damage!")),i.health=Math.max(0,i.health-o),this.addCombatLog(`${s.icon} ${s.name} deals ${o} damage`),this.emitCombatEvent("enemyAttack",{enemy:s,damage:o}),this.emitCombatEvent("playerHurt",{damage:o}),o)}endCombat(){this.stopCombatLoop();const e=this.currentEncounter,t=this.state.player,i={ongoing:!1,victory:e.victory,fled:e.fled,log:this.combatLog,rewards:null};if(e.worldEnemyIds&&e.worldEnemyIds.length>0)for(const s of e.worldEnemyIds)this.removeWorldEnemy(s);else e.worldEnemyId&&this.removeWorldEnemy(e.worldEnemyId);if(e.victory){let s=0,a=0,n=[];const r=e.enemies||[e.enemy];for(const c of r){if(!c)continue;const[d,u]=c.gold,h=d+Math.floor(Math.random()*(u-d+1));s+=h,a+=c.xp;const m=gs(c.templateId||c.id);n=n.concat(m),this.state.quests&&this.updateBountyProgress(c.templateId||c.id,c.category)}t.gold+=s;const o=this.state.gainXp(a);if(i.rewards={gold:s,xp:a,leveledUp:o,loot:n},r.length>0){const c=r[0];i.enemyInfo={id:c.templateId||c.id,category:c.category||"beast",name:c.name}}const l=r.length;l>1?this.state.addLog(`Victory over ${l} enemies! +${s}g, +${a}xp`,"success"):this.state.addLog(`Victory! +${s}g, +${a}xp`,"success"),n.length>0&&this.state.addLog(`Dropped ${n.length} item${n.length>1?"s":""}`,"success"),this.emitCombatEvent("victory",{rewards:i.rewards})}else e.fled||(e.isBanditAmbush?(i.banditEscaped=!0,i.permadeath=!1,t.health=Math.max(10,Math.floor(t.maxHealth*.15)),this.state.addLog("The bandits knocked you out and fled with the package!","danger")):(i.permadeath=!0,this.state.addLog("You have fallen in battle...","error"),this.emitCombatEvent("defeat",{})));if(this.lastCombatResult=i,this.currentEncounter=null,this.onCombatUpdate&&this.onCombatUpdate(null,i),this.onDungeonCombatEnd&&this.onDungeonCombatEnd(e.victory),this.onRoguelikeCombatEnd&&this.onRoguelikeCombatEnd(e.victory),this.onOverworldCombatEnd&&!e.isNPCCombat&&!e.isBanditAmbush&&this.onOverworldCombatEnd(e.victory,e),e.isNPCCombat&&this.onNPCCombatEnd&&this.onNPCCombatEnd(e.victory),e.isBanditAmbush&&this.onBanditAmbushEnd){let s=!1;e.enemies?s=e.enemies.every(l=>l.dead||l.currentHp<=0):e.enemy&&(s=e.enemy.currentHp<=0);const a=e.victory||s,n=i.banditEscaped||!1,o=e.fled||!1||n;console.log("Bandit ambush ended:",{victory:e.victory,fled:e.fled,allBanditsDead:s,playerWon:a,banditEscaped:n,deliveryStolen:o}),this.onBanditAmbushEnd(a,o,e.deliveryInfo,n)}return this.state.notify(),i}updateBountyProgress(e,t){const i=this.state.quests;if(!i)return;const s={beast:"beasts",insect:"beasts",plant:"beasts",humanoid:"bandits",goblinoid:"goblins",undead:"undead",slime:"monsters",elemental:"monsters",demon:"monsters",magical_beast:"monsters",giant:"monsters",aquatic:"beasts"},n={bandit:"bandits",bandit_leader:"bandits",pirate:"bandits"}[e]||s[t];if(n)for(const r of i.activeQuests)r.objective.type==="bounty"&&r.objective.target===n&&(r.objective.current=(r.objective.current||0)+1)}addCombatLog(e){this.combatLog.push(e),this.combatLog.length>20&&this.combatLog.shift()}isInCombat(){return this.currentEncounter!==null}spawnWorldEnemies(e,t=6){const i=this.state.player.position;if(!i)return;const s=3,a=.08;if(this.state.worldEnemies.length>=s)return;const n=[];e.forEach(r=>{if(!r.biome)return;const o=e.distance(i.q,i.r,r.q,r.r);if(o<3||o>t)return;const l=Be[r.biome.id]||0;l<.05||r.biome.id==="ocean"||r.biome.id==="coast"||this.state.worldEnemies.some(d=>d.q===r.q&&d.r===r.r)||n.push({cell:r,danger:l})});for(const{cell:r,danger:o}of n){if(this.state.worldEnemies.length>=s)break;if(Math.random()>a*o*3)continue;const l=this.createWorldEnemy(r);l&&this.state.worldEnemies.push(l)}}createWorldEnemy(e){const t=e.biome.id,i=this.state.isNight,a=["grassland","forest","savanna","desert","mountain","taiga","swamp","rainforest"].includes(t);let n=Object.values(W).filter(c=>{if(!c.biomes.includes(t))if(a&&c.category==="humanoid"&&!c.biomes.includes("coast")){if(Math.random()>.3)return!1}else return!1;return!(c.nightOnly&&!i)});if(i&&a){const c=Object.values(W).filter(d=>d.category==="undead"&&d.nightOnly);n=[...n,...c,...c]}if(n.length===0){const c=W.bandit;return this.createWorldEnemyFromTemplate(c,e)}const r=n.sort((c,d)=>c.hp-d.hp),o=Math.floor(Math.random()*Math.random()*r.length),l=r[o];return this.createWorldEnemyFromTemplate(l,e)}createWorldEnemyFromTemplate(e,t){const s=1+(Math.random()*.2*2-.2);return{id:`enemy_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,templateId:e.id,name:e.name,icon:e.icon,q:t.q,r:t.r,hp:Math.floor(e.hp*s),maxHp:Math.floor(e.hp*s),damage:[...e.damage],defense:e.defense,agility:e.agility,xp:e.xp,gold:e.gold,category:e.category,behavior:e.behavior||"aggressive"}}getMovementAction(e,t){const i=Math.random();switch(e){case"aggressive":return i<.8?"approach":i<.95?"wander":"stay";case"territorial":return t<4?i<.6?"approach":i<.85?"wander":"stay":i<.2?"approach":i<.6?"wander":"stay";case"passive":return i<.2?"approach":i<.6?"wander":"stay";case"skittish":return i<.1?"approach":i<.35?"wander":i<.75?"flee":"stay";default:return i<.85?"approach":i<.95?"wander":"stay"}}moveWorldEnemies(e){const t=this.state.player.position;if(!t)return null;for(const s of this.state.worldEnemies){const a=e.distance(t.q,t.r,s.q,s.r);if(a<=1)continue;const n=s.behavior||"aggressive",r=this.getMovementAction(n,a);if(r==="stay")continue;const l=e.getNeighbors(s.q,s.r).filter(d=>{const u=e.getCell(d.q,d.r);return!u||!u.biome||u.biome.id==="ocean"?!1:!this.state.worldEnemies.some(m=>m.id!==s.id&&m.q===d.q&&m.r===d.r)});if(l.length===0)continue;let c=null;if(r==="approach"){let d=a;for(const u of l){const h=e.distance(t.q,t.r,u.q,u.r);h<d&&(d=h,c=u)}}else if(r==="flee"){let d=a;for(const u of l){const h=e.distance(t.q,t.r,u.q,u.r);h>d&&(d=h,c=u)}}else r==="wander"&&(c=l[Math.floor(Math.random()*l.length)]);c&&(s.q=c.q,s.r=c.r)}const i=this.state.worldEnemies.filter(s=>e.distance(t.q,t.r,s.q,s.r)<=1);return i.length>0?i:null}removeDistantEnemies(e,t=10){const i=this.state.player.position;i&&(this.state.worldEnemies=this.state.worldEnemies.filter(s=>e.distance(i.q,i.r,s.q,s.r)<=t))}getEnemiesInRange(e,t){const i=this.state.player.position;return i?this.state.worldEnemies.filter(s=>e.distance(i.q,i.r,s.q,s.r)<=t):[]}hasEnemiesNearby(e,t=6){return this.getEnemiesInRange(e,t).length>0}removeWorldEnemy(e){this.state.worldEnemies=this.state.worldEnemies.filter(t=>t.id!==e)}applyStatVariance(e,t){const i=.8+Math.random()*.4;if(e.maxHp=Math.round(e.maxHp*i),e.currentHp=e.maxHp,Array.isArray(t.damage))e.damage=t.damage;else{const s=.85+Math.random()*.3;e.damage=Math.round(t.damage*s)}return e.defense=Math.max(0,(t.defense||0)+Math.floor(Math.random()*3)-1),e.agility=Math.max(1,(t.agility||5)+Math.floor(Math.random()*5)-2),e.agility>=8?e.hitsPerTurn=[1,3]:e.agility>=5?e.hitsPerTurn=[1,2]:e.hitsPerTurn=[1,1],e}getReinforcementPool(e){const t=W[e];if(!t)return[];const i=[],s=t.category,a=t.biomes||[];for(const[n,r]of Object.entries(W)){if(n===e||r.category!==s)continue;const o=r.biomes||[];if(a.some(c=>o.includes(c))||o.length===0){const c=t.hp/(r.hp||10);i.push({id:n,weight:Math.min(3,Math.max(.3,c))})}}return i}maybeAddReinforcements(e,t){if(Math.random()>.4)return null;const i=this.getReinforcementPool(t.templateId);if(i.length===0)return null;const s=1+(Math.random()<.3?1:0),a=[];for(let n=0;n<s;n++){const r=i.reduce((d,u)=>d+u.weight,0);let o=Math.random()*r,l=i[0];for(const d of i)if(o-=d.weight,o<=0){l=d;break}const c=W[l.id];if(c){const d=c.hp||20,u={id:a.length+1,templateId:l.id,...c,maxHp:d,currentHp:d,damage:c.damage,defense:c.defense||0,agility:c.agility||5,chargeTime:Math.max(800,2e3*(1-(c.agility||5)*.03)),chargeProgress:Math.random()*.3,dead:!1,isReinforcement:!0};this.applyStatVariance(u,c),a.push(u)}}return a.length>0?a:null}startCombatWithWorldEnemy(e){const t=W[e.templateId];if(!t)return null;const i={...t,id:0,templateId:e.templateId,maxHp:e.maxHp,currentHp:e.hp,damage:e.damage,defense:t.defense||0,agility:e.agility||t.agility||5,chargeTime:Math.max(800,2e3*(1-e.agility*.03)),chargeProgress:0,dead:!1};this.applyStatVariance(i,t);let s;return s={enemy:i,enemies:[i],targetedEnemyIndex:0,worldEnemyId:e.id,playerStartHp:this.state.player.health,playerStartEther:this.state.player.ether,round:0,fled:!1,victory:!1,playerBuffs:{},enemyBuffs:{},combatState:{playerAction:null,playerActionData:null,playerChargeTime:0,playerChargeProgress:0,playerReady:!1,pendingAction:null,pendingActionData:null,enemyChargeProgress:0,paused:!1,turnTimerActive:!1,turnTimerDuration:0,turnTimerRemaining:0,turnTimerStarted:0,actionsThisTurn:0,playerConditions:[]}},this.startCombat(s),s}startCombatWithMultipleEnemies(e){if(!e||e.length===0)return null;const t=e.map((s,a)=>{const n=W[s.templateId];return n?{id:a,worldEnemyId:s.id,templateId:s.templateId,...n,maxHp:s.maxHp,currentHp:s.hp,damage:s.damage,chargeTime:Math.max(800,2e3*(1-s.agility*.03)),chargeProgress:0,dead:!1}:null}).filter(s=>s!==null);if(t.length===0)return null;t.forEach(s=>{s.chargeProgress=Math.random()*.3*s.chargeTime});const i={enemies:t,targetedEnemyIndex:0,worldEnemyIds:e.map(s=>s.id),playerStartHp:this.state.player.health,playerStartEther:this.state.player.ether,round:0,fled:!1,victory:!1,playerBuffs:{},enemyBuffs:{},combatState:{playerAction:null,playerActionData:null,playerChargeTime:0,playerChargeProgress:0,playerReady:!1,pendingAction:null,pendingActionData:null,paused:!1}};return this.startCombat(i),i}setTarget(e){if(!this.currentEncounter||!this.currentEncounter.enemies)return!1;const t=this.currentEncounter.enemies;return e>=0&&e<t.length&&!t[e].dead&&t[e].currentHp>0?(this.currentEncounter.targetedEnemyIndex=e,!0):!1}cycleTarget(){if(!this.currentEncounter||!this.currentEncounter.enemies)return;const e=this.currentEncounter.enemies;if(e.filter(n=>!n.dead&&n.currentHp>0).length===0)return;let s=(this.currentEncounter.targetedEnemyIndex+1)%e.length,a=0;for(;(e[s].dead||e[s].currentHp<=0)&&a<e.length;)s=(s+1)%e.length,a++;this.currentEncounter.targetedEnemyIndex=s}getTargetedEnemy(){const e=this.currentEncounter;return e?e.enemies?e.enemies[e.targetedEnemyIndex]:e.enemy:null}startBanditAmbush(e){const t=e.packageType.itemId==="merchant_goods"?2:1;if(t===1){const i=W.bandit,s=i.hp||i.maxHp||20,a={enemy:{...i,id:"bandit",maxHp:s,currentHp:s,damage:i.damage,chargeTime:i.chargeTime||1500},isBanditAmbush:!0,deliveryInfo:e,playerStartHp:this.state.player.health,playerStartEther:this.state.player.ether,round:0,fled:!1,victory:!1,playerBuffs:{},enemyBuffs:{},combatState:{playerAction:null,playerActionData:null,playerChargeTime:0,playerChargeProgress:0,playerReady:!1,pendingAction:null,pendingActionData:null,enemyChargeProgress:0,paused:!1}};this.startCombat(a)}else{const i=[];for(let a=0;a<t;a++){const n=a===0,r=n?W.bandit_leader:W.bandit,o=r.hp||r.maxHp||20;i.push({id:a,templateId:n?"bandit_leader":"bandit",...r,maxHp:o,currentHp:o,damage:r.damage,chargeTime:r.chargeTime||1500,chargeProgress:Math.random()*.3,dead:!1})}const s={enemies:i,targetedEnemyIndex:0,isBanditAmbush:!0,isMultiEnemy:!0,deliveryInfo:e,playerStartHp:this.state.player.health,playerStartEther:this.state.player.ether,round:0,fled:!1,victory:!1,playerBuffs:{},enemyBuffs:{},combatState:{playerAction:null,playerActionData:null,playerChargeTime:0,playerChargeProgress:0,playerReady:!1,pendingAction:null,pendingActionData:null,paused:!1}};this.startCombat(s)}}}class ys{constructor(){this.enabled=!0,this.menuTrack=new Audio("main menu.mp3"),this.dayTrack=new Audio("511311__theojt__fantasy-classical-themes.mp3"),this.nightTrack=new Audio("727096__theojt__minimalistic-piano-strings-improvisation.wav"),this.dungeonTrack=new Audio("dungeonmusic.wav"),this.combatTrack=new Audio("785376__fnakez__piano-action-combat.ogg"),this.currentTrack=null,this.activeGameplayTrack=null,this.isInGame=!1,this.isInDungeon=!1,this.isInCombat=!1,this.volume=.25,this.gameplayVolume=.07,this.dungeonVolume=.04,this.combatVolume=.08,this.fadeDuration=2e3,this.dayNightFadeDuration=4e3,this.currentHour=12,this.lastPeriod=null,this.menuTrack.volume=0,this.dayTrack.volume=0,this.nightTrack.volume=0,this.dungeonTrack.volume=0,this.combatTrack.volume=0,this.dayTrack.loop=!0,this.nightTrack.loop=!0,this.dungeonTrack.loop=!0,this.combatTrack.loop=!0,this.menuTrack.addEventListener("ended",()=>this.onMenuTrackEnded())}getTimePeriod(e){return e>=6&&e<18?"day":"night"}isTransitionPeriod(e){return e>=5&&e<7||e>=17&&e<19}updateTimeOfDay(e){if(!this.isInGame||this.isInDungeon||this.isInCombat)return;this.currentHour=e;const t=this.getTimePeriod(e);this.lastPeriod!==t&&(this.transitionDayNight(t),this.lastPeriod=t)}transitionToDungeon(){this.isInDungeon=!0,this.enabled&&((this.dayTrack.volume>0||!this.dayTrack.paused)&&this.fadeOut(this.dayTrack),(this.nightTrack.volume>0||!this.nightTrack.paused)&&this.fadeOut(this.nightTrack),(this.menuTrack.volume>0||!this.menuTrack.paused)&&this.fadeOut(this.menuTrack),this.dungeonTrack.currentTime=0,this.dungeonTrack.play().catch(e=>console.log("Audio play error:",e)),this.fadeIn(this.dungeonTrack,this.fadeDuration,this.dungeonVolume),this.currentTrack=this.dungeonTrack)}transitionFromDungeon(){this.isInDungeon=!1,this.enabled&&((this.dungeonTrack.volume>0||!this.dungeonTrack.paused)&&this.fadeOut(this.dungeonTrack),this.startGameplayMusic())}transitionToCombat(){this.isInCombat=!0,this.enabled&&((this.dayTrack.volume>0||!this.dayTrack.paused)&&this.fadeOut(this.dayTrack,500),(this.nightTrack.volume>0||!this.nightTrack.paused)&&this.fadeOut(this.nightTrack,500),(this.menuTrack.volume>0||!this.menuTrack.paused)&&this.fadeOut(this.menuTrack,500),(this.dungeonTrack.volume>0||!this.dungeonTrack.paused)&&this.fadeOut(this.dungeonTrack,500),setTimeout(()=>{this.isInCombat&&(this.combatTrack.currentTime=0,this.combatTrack.play().catch(e=>console.log("Audio play error:",e)),this.fadeIn(this.combatTrack,1e3,this.combatVolume),this.currentTrack=this.combatTrack)},400))}transitionFromCombat(){this.isInCombat=!1,this.enabled&&((this.combatTrack.volume>0||!this.combatTrack.paused)&&this.fadeOut(this.combatTrack),this.isInDungeon?(this.dungeonTrack.play().catch(e=>console.log("Audio play error:",e)),this.fadeIn(this.dungeonTrack,this.fadeDuration,this.dungeonVolume),this.currentTrack=this.dungeonTrack):this.isInGame&&this.startGameplayMusic())}transitionDayNight(e){if(!this.enabled)return;const t=this.dayNightFadeDuration;e==="day"?((this.nightTrack.volume>0||!this.nightTrack.paused)&&this.fadeOut(this.nightTrack,t),this.dayTrack.paused&&this.dayTrack.play().catch(i=>console.log("Audio play error:",i)),this.fadeIn(this.dayTrack,t,this.gameplayVolume),this.activeGameplayTrack="day",this.currentTrack=this.dayTrack):((this.dayTrack.volume>0||!this.dayTrack.paused)&&this.fadeOut(this.dayTrack,t),this.nightTrack.paused&&this.nightTrack.play().catch(i=>console.log("Audio play error:",i)),this.fadeIn(this.nightTrack,t,this.gameplayVolume),this.activeGameplayTrack="night",this.currentTrack=this.nightTrack)}playMenuMusic(e=!0){this.enabled&&(this.menuTrack.loop=e,this.menuTrack.currentTime=0,this.menuTrack.play().catch(t=>console.log("Audio autoplay blocked:",t)),this.fadeIn(this.menuTrack),this.currentTrack=this.menuTrack)}onMenuTrackEnded(){this.isInGame&&this.startGameplayMusic()}transitionToGameplay(e=6){this.isInGame=!0,this.currentHour=e,this.lastPeriod=this.getTimePeriod(e),this.currentTrack===this.menuTrack?(this.menuTrack.loop=!1,!this.menuTrack.paused&&!this.menuTrack.ended?this.crossfadeToGameplay():this.startGameplayMusic()):this.startGameplayMusic()}crossfadeToGameplay(){this.fadeOut(this.menuTrack),this.startGameplayMusic()}startGameplayMusic(){if(!this.enabled)return;const e=this.getTimePeriod(this.currentHour);this.lastPeriod=e,e==="day"?(this.dayTrack.currentTime=0,this.dayTrack.play().catch(t=>console.log("Audio play error:",t)),this.fadeIn(this.dayTrack,this.fadeDuration,this.gameplayVolume),this.activeGameplayTrack="day",this.currentTrack=this.dayTrack):(this.nightTrack.currentTime=0,this.nightTrack.play().catch(t=>console.log("Audio play error:",t)),this.fadeIn(this.nightTrack,this.fadeDuration,this.gameplayVolume),this.activeGameplayTrack="night",this.currentTrack=this.nightTrack)}fadeIn(e,t=this.fadeDuration,i=this.volume){const s=e.volume,a=30,n=t/a,r=(i-s)/a;let o=0;e._fadeInterval&&clearInterval(e._fadeInterval),e._fadeInterval=setInterval(()=>{o++,e.volume=Math.min(i,s+r*o),o>=a&&(clearInterval(e._fadeInterval),e._fadeInterval=null,e.volume=i)},n)}fadeOut(e,t=this.fadeDuration){const i=e.volume;if(i<=0){e.pause();return}const s=30,a=t/s,n=i/s;let r=0;e._fadeInterval&&clearInterval(e._fadeInterval),e._fadeInterval=setInterval(()=>{r++,e.volume=Math.max(0,i-n*r),r>=s&&(clearInterval(e._fadeInterval),e._fadeInterval=null,e.volume=0,e.pause())},a)}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.gameplayVolume=this.volume*.3,this.dungeonVolume=this.volume*.16,this.combatVolume=this.volume*.32,this.currentTrack&&!this.currentTrack.paused&&(this.currentTrack===this.menuTrack?this.currentTrack.volume=this.volume:this.currentTrack===this.dungeonTrack?this.currentTrack.volume=this.dungeonVolume:this.currentTrack===this.combatTrack?this.currentTrack.volume=this.combatVolume:this.currentTrack.volume=this.gameplayVolume)}pause(){this.menuTrack.pause(),this.dayTrack.pause(),this.nightTrack.pause(),this.dungeonTrack.pause(),this.combatTrack.pause()}resume(){this.currentTrack&&this.currentTrack.play().catch(e=>console.log("Audio play error:",e))}stop(){this.fadeOut(this.menuTrack),this.fadeOut(this.dayTrack),this.fadeOut(this.nightTrack),this.fadeOut(this.dungeonTrack),this.fadeOut(this.combatTrack),this.currentTrack=null,this.activeGameplayTrack=null,this.isInDungeon=!1,this.isInCombat=!1}ensureCorrectMusic(){if(!this.enabled)return;const e=!this.isInGame,t=this.isInGame&&this.isInCombat,i=this.isInGame&&this.isInDungeon&&!this.isInCombat,s=this.isInGame&&!this.isInDungeon&&!this.isInCombat,a=!this.menuTrack.paused&&this.menuTrack.volume>0,n=!this.dungeonTrack.paused&&this.dungeonTrack.volume>0,r=!this.combatTrack.paused&&this.combatTrack.volume>0,o=!this.dayTrack.paused&&this.dayTrack.volume>0,l=!this.nightTrack.paused&&this.nightTrack.volume>0;e?(n&&this.fadeOut(this.dungeonTrack),r&&this.fadeOut(this.combatTrack),o&&this.fadeOut(this.dayTrack),l&&this.fadeOut(this.nightTrack),!a&&this.menuTrack.paused&&this.playMenuMusic(!0)):t?(a&&this.fadeOut(this.menuTrack),n&&this.fadeOut(this.dungeonTrack),o&&this.fadeOut(this.dayTrack),l&&this.fadeOut(this.nightTrack),!r&&this.combatTrack.paused&&(this.combatTrack.currentTime=0,this.combatTrack.play().catch(c=>console.log("Audio play error:",c)),this.fadeIn(this.combatTrack,this.fadeDuration,this.combatVolume),this.currentTrack=this.combatTrack)):i?(a&&this.fadeOut(this.menuTrack),r&&this.fadeOut(this.combatTrack),o&&this.fadeOut(this.dayTrack),l&&this.fadeOut(this.nightTrack),!n&&this.dungeonTrack.paused&&(this.dungeonTrack.currentTime=0,this.dungeonTrack.play().catch(c=>console.log("Audio play error:",c)),this.fadeIn(this.dungeonTrack,this.fadeDuration,this.dungeonVolume),this.currentTrack=this.dungeonTrack)):s&&(a&&this.fadeOut(this.menuTrack),r&&this.fadeOut(this.combatTrack),n&&this.fadeOut(this.dungeonTrack),this.getTimePeriod(this.currentHour)==="day"?(l&&this.fadeOut(this.nightTrack),!o&&this.dayTrack.paused&&(this.dayTrack.currentTime=0,this.dayTrack.play().catch(d=>console.log("Audio play error:",d)),this.fadeIn(this.dayTrack,this.fadeDuration,this.gameplayVolume),this.activeGameplayTrack="day",this.currentTrack=this.dayTrack,this.lastPeriod="day")):(o&&this.fadeOut(this.dayTrack),!l&&this.nightTrack.paused&&(this.nightTrack.currentTime=0,this.nightTrack.play().catch(d=>console.log("Audio play error:",d)),this.fadeIn(this.nightTrack,this.fadeDuration,this.gameplayVolume),this.activeGameplayTrack="night",this.currentTrack=this.nightTrack,this.lastPeriod="night")))}setGameState(e,t=!1,i=!1){this.isInGame=e,this.isInDungeon=t,this.isInCombat=i,this.ensureCorrectMusic()}}const de={SNOWFLAKE:{id:"snowflake",chars:["*","â„","â†",".","Â·"],sizes:[8,10,12,14],colors:["#ffffff","#e8f4ff","#d0e8ff"],speed:{min:.3,max:.8},drift:{min:-.3,max:.3},lifespan:{min:4e3,max:8e3},opacity:{min:.4,max:.9}},BLIZZARD:{id:"blizzard",chars:["*","â„","Â·","."],sizes:[6,8,10,12,14,16],colors:["#ffffff","#e8f4ff"],speed:{min:1.5,max:3},drift:{min:1,max:2.5},lifespan:{min:2e3,max:4e3},opacity:{min:.6,max:1}},RAIN:{id:"rain",chars:["|","/","\\"],sizes:[10,12,14,16],colors:["#6090b0","#7ca8c8","#8cc0e0"],speed:{min:4,max:7},drift:{min:.5,max:1.5},lifespan:{min:1e3,max:2e3},opacity:{min:.3,max:.6}},LEAF:{id:"leaf",chars:["ðŸƒ","ðŸ‚","ðŸ","Â·"],sizes:[10,12,14,16],colors:["#8ab050","#a0c060","#70a040","#c09030"],speed:{min:.2,max:.5},drift:{min:-.8,max:.8},wobble:!0,lifespan:{min:6e3,max:12e3},opacity:{min:.6,max:1}},DUST:{id:"dust",chars:["Â·",".","Â°"],sizes:[4,6,8],colors:["#c8b078","#b8a068","#d0b888"],speed:{min:.1,max:.3},drift:{min:.2,max:.6},lifespan:{min:5e3,max:1e4},opacity:{min:.2,max:.5}},SANDSTORM:{id:"sandstorm",chars:["Â·",".","Â°","â€¢"],sizes:[4,6,8,10],colors:["#d0a050","#c09040","#b08030"],speed:{min:.5,max:1.5},drift:{min:2,max:4},lifespan:{min:2e3,max:4e3},opacity:{min:.4,max:.8}},ASH:{id:"ash",chars:["Â·",".","Â°","â€¢"],sizes:[4,6,8],colors:["#505050","#404040","#606060","#ff6030"],speed:{min:-.3,max:.2},drift:{min:-.5,max:.5},lifespan:{min:4e3,max:8e3},opacity:{min:.3,max:.7}},SMOKE:{id:"smoke",chars:["â—‹","â—¯","â—","â—Œ"],sizes:[12,16,20,24],colors:["#303030","#404040","#505050"],speed:{min:-.8,max:-.3},drift:{min:-.3,max:.3},lifespan:{min:3e3,max:6e3},opacity:{min:.1,max:.4},fadeOut:!0},MIST:{id:"mist",chars:["~","â‰ˆ","â—‹"],sizes:[16,20,24,28],colors:["#607060","#506050","#708070"],speed:{min:.05,max:.15},drift:{min:-.2,max:.2},lifespan:{min:8e3,max:15e3},opacity:{min:.1,max:.3},fadeOut:!0},FIREFLY:{id:"firefly",chars:["âœ¦","âœ§","Â·"],sizes:[6,8,10],colors:["#90ff70","#a0ff80","#70ff50"],speed:{min:.1,max:.3},drift:{min:-.4,max:.4},wobble:!0,lifespan:{min:3e3,max:6e3},opacity:{min:.5,max:1},glow:!0,pulse:!0},SPRAY:{id:"spray",chars:["Â·",".","Â°","~"],sizes:[4,6,8],colors:["#90c0d0","#a0d0e0","#b0e0f0"],speed:{min:-.5,max:.3},drift:{min:.3,max:1},lifespan:{min:2e3,max:4e3},opacity:{min:.2,max:.5}},POLLEN:{id:"pollen",chars:["Â·",".","Â°"],sizes:[3,4,5,6],colors:["#e0d080","#f0e090","#d0c070"],speed:{min:.05,max:.2},drift:{min:-.3,max:.3},wobble:!0,lifespan:{min:8e3,max:15e3},opacity:{min:.3,max:.6}},WIND:{id:"wind",chars:["~","â‰ˆ","-"],sizes:[8,10,12],colors:["#ffffff","#e0e0e0"],speed:{min:.1,max:.3},drift:{min:2,max:4},lifespan:{min:1e3,max:2e3},opacity:{min:.1,max:.3}},CORRUPTION_OOZE:{id:"corruption_ooze",chars:["â—","â—‰","â—Ž","â—‹","â€¢","â˜ "],sizes:[6,8,10,12,14],colors:["#8040a0","#603080","#a050c0","#904090","#602080"],speed:{min:-.4,max:-.15},drift:{min:-.3,max:.3},wobble:!0,lifespan:{min:3e3,max:6e3},opacity:{min:.3,max:.7},fadeOut:!0,glow:!0},CORRUPTION_MIASMA:{id:"corruption_miasma",chars:["â—‰","â˜ ","âš‰","â—ˆ","âœ¦"],sizes:[10,14,18,22],colors:["#602060","#801060","#500840","#700050"],speed:{min:-.6,max:-.2},drift:{min:-.5,max:.5},wobble:!0,lifespan:{min:2500,max:5e3},opacity:{min:.4,max:.8},fadeOut:!0,glow:!0,pulse:!0}},vs={arctic:{ambient:{type:"SNOWFLAKE",density:15,spawnRate:200},weather:{type:"BLIZZARD",density:40,chance:.15,duration:{min:1e4,max:3e4}}},frozen_sea:{ambient:{type:"SNOWFLAKE",density:10,spawnRate:300},weather:null},snow_peak:{ambient:{type:"SNOWFLAKE",density:20,spawnRate:150},weather:{type:"BLIZZARD",density:50,chance:.2,duration:{min:15e3,max:4e4}}},snow_forest:{ambient:{type:"SNOWFLAKE",density:12,spawnRate:250},weather:null},tundra:{ambient:{type:"SNOWFLAKE",density:8,spawnRate:350},weather:{type:"WIND",density:20,chance:.1,duration:{min:5e3,max:15e3}}},desert:{ambient:{type:"DUST",density:10,spawnRate:400},weather:{type:"SANDSTORM",density:60,chance:.08,duration:{min:8e3,max:25e3}}},badlands:{ambient:{type:"DUST",density:12,spawnRate:350},weather:{type:"SANDSTORM",density:50,chance:.1,duration:{min:1e4,max:3e4}}},forest:{ambient:{type:"LEAF",density:6,spawnRate:600},weather:{type:"RAIN",density:40,chance:.12,duration:{min:15e3,max:45e3}}},rainforest:{ambient:{type:"LEAF",density:8,spawnRate:500},weather:{type:"RAIN",density:60,chance:.25,duration:{min:2e4,max:6e4}}},taiga:{ambient:{type:"LEAF",density:4,spawnRate:800},weather:{type:"SNOWFLAKE",density:15,chance:.15,duration:{min:1e4,max:3e4}}},volcanic:{ambient:{type:"ASH",density:15,spawnRate:300},weather:{type:"SMOKE",density:25,chance:.2,duration:{min:8e3,max:2e4}}},swamp:{ambient:{type:"MIST",density:8,spawnRate:500},nightAmbient:{type:"FIREFLY",density:12,spawnRate:400},weather:null},coast:{ambient:{type:"SPRAY",density:6,spawnRate:600},weather:{type:"RAIN",density:35,chance:.1,duration:{min:1e4,max:3e4}}},beach:{ambient:{type:"SPRAY",density:4,spawnRate:700},weather:null},ocean:{ambient:{type:"SPRAY",density:8,spawnRate:500},weather:{type:"RAIN",density:50,chance:.15,duration:{min:15e3,max:4e4}}},deep_ocean:{ambient:{type:"SPRAY",density:10,spawnRate:400},weather:{type:"RAIN",density:60,chance:.18,duration:{min:2e4,max:5e4}}},grassland:{ambient:{type:"POLLEN",density:8,spawnRate:500},weather:{type:"RAIN",density:30,chance:.08,duration:{min:1e4,max:25e3}}},savanna:{ambient:{type:"DUST",density:6,spawnRate:600},weather:null},mountain:{ambient:{type:"WIND",density:8,spawnRate:400},weather:{type:"SNOWFLAKE",density:20,chance:.12,duration:{min:1e4,max:3e4}}},highlands:{ambient:{type:"WIND",density:10,spawnRate:350},weather:null}};class bs{constructor(e,t,i,s,a){this.type=e,this.x=t,this.y=i,this.canvasWidth=s,this.canvasHeight=a,this.char=e.chars[Math.floor(Math.random()*e.chars.length)],this.size=e.sizes[Math.floor(Math.random()*e.sizes.length)],this.color=e.colors[Math.floor(Math.random()*e.colors.length)];const n=e.speed.max-e.speed.min;this.speedY=e.speed.min+Math.random()*n;const r=e.drift.max-e.drift.min;this.speedX=e.drift.min+Math.random()*r;const o=e.lifespan.max-e.lifespan.min;this.lifespan=e.lifespan.min+Math.random()*o,this.age=0;const l=e.opacity.max-e.opacity.min;this.baseOpacity=e.opacity.min+Math.random()*l,this.opacity=this.baseOpacity,e.wobble&&(this.wobbleOffset=Math.random()*Math.PI*2,this.wobbleSpeed=.002+Math.random()*.003,this.wobbleAmount=.3+Math.random()*.5),e.pulse&&(this.pulseOffset=Math.random()*Math.PI*2,this.pulseSpeed=.003+Math.random()*.004),this.glow=e.glow||!1,this.fadeOut=e.fadeOut||!1}update(e){if(this.age+=e,this.x+=this.speedX*e*.06,this.y+=this.speedY*e*.06,this.type.wobble&&(this.x+=Math.sin(this.age*this.wobbleSpeed+this.wobbleOffset)*this.wobbleAmount),this.type.pulse){const t=(Math.sin(this.age*this.pulseSpeed+this.pulseOffset)+1)/2;this.opacity=this.baseOpacity*(.3+t*.7)}if(this.fadeOut){const t=this.age/this.lifespan;t>.7&&(this.opacity=this.baseOpacity*(1-(t-.7)/.3))}return this.age<this.lifespan&&this.x>-50&&this.x<this.canvasWidth+50&&this.y>-50&&this.y<this.canvasHeight+50}render(e){e.save(),e.globalAlpha=this.opacity,e.font=`${this.size}px sans-serif`,e.fillStyle=this.color,e.textAlign="center",e.textBaseline="middle",this.glow&&(e.shadowColor=this.color,e.shadowBlur=8),e.fillText(this.char,this.x,this.y),e.restore()}}class Yt{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.particles=[],this.currentBiome=null,this.isNight=!1,this.weatherActive=!1,this.weatherEndTime=0,this.weatherType=null,this.corruptionZone=null,this.lastUpdate=performance.now(),this.lastSpawn={ambient:0,weather:0,corruption:0},this.animationId=null,this.running=!1,this.maxParticles=150,this.enabled=!0}setCorruptionZone(e){this.corruptionZone=e}setBiome(e){this.currentBiome!==e&&(this.currentBiome=e,this.particles=[])}setNight(e){this.isNight=e}start(){this.running||(this.running=!0,this.lastUpdate=performance.now(),this.animate())}stop(){this.running=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}setEnabled(e){this.enabled=e,e||(this.particles=[])}animate(){if(!this.running)return;const e=performance.now(),t=e-this.lastUpdate;if(this.lastUpdate=e,this.particles.length===0&&!this.weatherActive&&!this.enabled){this.animationId=requestAnimationFrame(()=>this.animate());return}this.update(t),this.particles.length>0&&this.render(),this.animationId=requestAnimationFrame(()=>this.animate())}update(e){if(!this.enabled)return;this.particles=this.particles.filter(i=>i.update(e));const t=this.currentBiome?vs[this.currentBiome]:null;if(t){const i=this.isNight&&t.nightAmbient?t.nightAmbient:t.ambient;i&&this.particles.length<this.maxParticles&&(this.lastSpawn.ambient+=e,this.lastSpawn.ambient>=i.spawnRate&&(this.lastSpawn.ambient=0,this.spawnParticle(de[i.type]))),t.weather&&!this.weatherActive&&Math.random()<t.weather.chance*e*1e-4&&this.startWeather(t.weather)}if(this.weatherActive&&this.weatherType&&(performance.now()>this.weatherEndTime?(this.weatherActive=!1,this.weatherType=null):this.particles.length<this.maxParticles*2&&(this.lastSpawn.weather+=e,this.lastSpawn.weather>=100&&(this.lastSpawn.weather=0,this.spawnParticle(this.weatherType)))),this.corruptionZone&&this.corruptionZone!=="SAFE"){this.lastSpawn.corruption+=e;let i,s,a;switch(this.corruptionZone){case"TAINTED":i=800,s=de.CORRUPTION_OOZE,a=.3;break;case"CORRUPTED":i=400,s=de.CORRUPTION_OOZE,a=.6;break;case"BLIGHTED":i=200,s=de.CORRUPTION_MIASMA,a=1;break;default:i=1e3,s=de.CORRUPTION_OOZE,a=.2}if(this.lastSpawn.corruption>=i&&this.particles.length<this.maxParticles){this.lastSpawn.corruption=0;const n=Math.ceil(a*2);for(let r=0;r<n;r++)this.spawnParticle(s)}}}startWeather(e){this.weatherActive=!0,this.weatherType=de[e.type];const t=e.duration.max-e.duration.min,i=e.duration.min+Math.random()*t;this.weatherEndTime=performance.now()+i}forceWeather(e,t=15e3){const i=de[e];i&&(this.weatherActive=!0,this.weatherType=i,this.weatherEndTime=performance.now()+t)}spawnParticle(e){if(!e)return;const t=this.canvas.width/(window.devicePixelRatio||1),i=this.canvas.height/(window.devicePixelRatio||1);let s,a;e.speed.max<0?(s=Math.random()*t,a=i+20):e.drift.max>1.5?(s=-20,a=Math.random()*i):(s=Math.random()*t,a=-20),this.particles.push(new bs(e,s,a,t,i))}render(){const e=this.canvas.width/(window.devicePixelRatio||1),t=this.canvas.height/(window.devicePixelRatio||1);this.ctx.clearRect(0,0,e,t);for(const i of this.particles)i.render(this.ctx)}getParticleCount(){return this.particles.length}isWeatherActive(){return this.weatherActive}getWeatherType(){var e;return((e=this.weatherType)==null?void 0:e.id)||null}}const ws={deep_ocean:{files:["ocean_01.wav","ocean_02.wav","ocean_03.wav"],volume:.4},ocean:{files:["ocean_01.wav","ocean_02.wav","ocean_waves_slow.wav"],volume:.35},coast:{files:["ocean_04_slow.wav","ocean_waves_slow.wav"],volume:.3},beach:{files:["ocean_waves_slow.wav"],volume:.25},frozen_sea:{files:["wind_arctic_01.wav","wind_arctic_02.wav"],volume:.3},forest:{files:["birds_01.wav"],volume:.3,night:["forest_night_crickets_01.wav","forest_night_crickets_02.wav"]},rainforest:{files:["birds_01.wav"],volume:.35,night:["forest_night_crickets_01.wav"]},taiga:{files:["wind_01.wav","birds_01.wav"],volume:.25},snow_forest:{files:["wind_01.wav"],volume:.2},arctic:{files:["wind_arctic_01.wav","wind_arctic_02.wav"],volume:.35},snow_peak:{files:["wind_arctic_01.wav","wind_arctic_02.wav"],volume:.4},tundra:{files:["wind_01.wav","wind_02.wav"],volume:.3},grassland:{files:["birds_01.wav","wind_01.wav"],volume:.2,night:["forest_night_crickets_01.wav"]},savanna:{files:["wind_01.wav","wind_02.wav"],volume:.25},desert:{files:["wind_02.wav","wind_03.wav"],volume:.2},badlands:{files:["wind_02.wav","wind_03.wav"],volume:.25},volcanic:{files:["fire_large_01.wav","fire_large_02.wav","wind_03.wav"],volume:.3},swamp:{files:["river_01.wav"],volume:.2,night:["forest_night_crickets_01.wav","forest_night_crickets_02.wav"]},mountain:{files:["wind_03.wav","wind_04.wav"],volume:.3},highlands:{files:["wind_02.wav","wind_03.wav"],volume:.25}},Qt={rain:{files:["rain_medium_01.wav","rain_light_01.wav"],volume:.4},rain_heavy:{files:["rain_heavy_01.wav","rain_heavy_02.wav","rain_heavy_03.wav"],volume:.5},blizzard:{files:["wind_arctic_01.wav","wind_arctic_02.wav"],volume:.5},sandstorm:{files:["wind_03.wav","wind_04.wav"],volume:.45},thunderstorm:{files:["thunderstorm_01.wav","thunderstorm_02.wav"],volume:.5},wind:{files:["wind_01.wav","wind_02.wav"],volume:.3}},et={town:{files:["market_01.wav","market_02.wav"],volume:.25},city:{files:["market_01.wav","market_02.wav"],volume:.3},village:{files:["market_01.wav"],volume:.15},tavern:{files:["market_01.wav","fire_medium_01.wav"],volume:.2},camp:{files:["fire_small_01.wav","fire_small_02.wav"],volume:.25}};class Xt{constructor(){this.basePath="loops/",this.fadeTime=2e3,this.biomeAudio=null,this.weatherAudio=null,this.settlementAudio=null,this.corruptionAudio=null,this.currentBiome=null,this.currentWeather=null,this.currentSettlement=null,this.currentCorruptionZone=null,this.isNight=!1,this.masterVolume=.5,this.biomeVolume=1,this.weatherVolume=1,this.corruptionVolume=1,this.biomeFadeInterval=null,this.weatherFadeInterval=null,this.settlementFadeInterval=null,this.corruptionFadeInterval=null,this.corruptionFile="tension_for_auras.wav",this.corruptionZoneVolumes={SAFE:0,TAINTED:.15,CORRUPTED:.35,BLIGHTED:.6},this.enabled=!0}init(){this.biomeAudio=new Audio,this.biomeAudio.loop=!0,this.biomeAudio.volume=0,this.weatherAudio=new Audio,this.weatherAudio.loop=!0,this.weatherAudio.volume=0,this.settlementAudio=new Audio,this.settlementAudio.loop=!0,this.settlementAudio.volume=0,this.corruptionAudio=new Audio,this.corruptionAudio.loop=!0,this.corruptionAudio.volume=0,this.corruptionAudio.src=this.corruptionFile}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e)),this.updateVolumes()}setEnabled(e){this.enabled=e,e||this.stopAll()}updateVolumes(){if(this.biomeAudio&&this.currentBiome){const e=this.getBiomeConfig(this.currentBiome);e&&(this.biomeAudio.volume=e.volume*this.biomeVolume*this.masterVolume)}if(this.weatherAudio&&this.currentWeather){const e=Qt[this.currentWeather];e&&(this.weatherAudio.volume=e.volume*this.weatherVolume*this.masterVolume)}if(this.settlementAudio&&this.currentSettlement){const e=et[this.currentSettlement];e&&(this.settlementAudio.volume=e.volume*this.masterVolume)}}getBiomeConfig(e){const t=ws[e];return t?this.isNight&&t.night?{files:t.night,volume:t.volume}:t:null}pickRandom(e){return e[Math.floor(Math.random()*e.length)]}setBiome(e){if(!this.enabled||e===this.currentBiome)return;const t=this.getBiomeConfig(e);if(!t){this.fadeOutBiome(),this.currentBiome=e;return}this.currentBiome=e;const i=this.pickRandom(t.files);this.crossfadeBiome(i,t.volume)}setNight(e){if(this.isNight!==e&&(this.isNight=e,this.currentBiome)){const t=this.currentBiome;this.currentBiome=null,this.setBiome(t)}}setWeather(e){if(!this.enabled)return;if(!e){this.currentWeather&&(this.fadeOutWeather(),this.currentWeather=null);return}const i={rain:"rain",blizzard:"blizzard",sandstorm:"sandstorm",wind:"wind",snowflake:null,smoke:null}[e];if(!i||i===this.currentWeather)return;const s=Qt[i];if(!s){this.fadeOutWeather(),this.currentWeather=null;return}this.currentWeather=i;const a=this.pickRandom(s.files);this.crossfadeWeather(a,s.volume)}setSettlement(e){if(!this.enabled)return;if(!e||!et[e]){this.currentSettlement&&(this.fadeOutSettlement(),this.currentSettlement=null);return}if(e===this.currentSettlement)return;this.currentSettlement=e;const t=et[e],i=this.pickRandom(t.files);this.crossfadeSettlement(i,t.volume)}setCorruptionZone(e){if(!this.enabled||!this.corruptionAudio)return;const i=(this.corruptionZoneVolumes[e]||0)*this.corruptionVolume*this.masterVolume;if(this.corruptionFadeInterval&&(clearInterval(this.corruptionFadeInterval),this.corruptionFadeInterval=null),e==="SAFE"||!e){this.currentCorruptionZone&&this.currentCorruptionZone!=="SAFE"&&this.fadeOutCorruption(),this.currentCorruptionZone=e;return}this.corruptionAudio.paused&&(this.corruptionAudio.volume=0,this.corruptionAudio.play().catch(()=>{})),this.currentCorruptionZone=e,this.smoothFadeCorruption(i)}smoothFadeCorruption(e){if(!this.corruptionAudio)return;const t=this.corruptionAudio.volume,i=e-t;if(Math.abs(i)<.01){this.corruptionAudio.volume=e;return}const s=1500,a=30,n=s/a,r=i/a;let o=0;this.corruptionFadeInterval=setInterval(()=>{o++,o>=a?(this.corruptionAudio.volume=e,clearInterval(this.corruptionFadeInterval),this.corruptionFadeInterval=null):this.corruptionAudio.volume=Math.max(0,Math.min(1,t+r*o))},n)}fadeOutCorruption(){if(!this.corruptionAudio)return;this.corruptionFadeInterval&&clearInterval(this.corruptionFadeInterval);const e=this.corruptionAudio.volume,t=2e3,i=40,s=t/i,a=e/i;let n=0;this.corruptionFadeInterval=setInterval(()=>{n++,n>=i?(this.corruptionAudio.volume=0,this.corruptionAudio.pause(),clearInterval(this.corruptionFadeInterval),this.corruptionFadeInterval=null):this.corruptionAudio.volume=Math.max(0,e-a*n)},s)}crossfadeBiome(e,t){if(!this.biomeAudio)return;const i=t*this.biomeVolume*this.masterVolume;if(this.biomeFadeInterval&&clearInterval(this.biomeFadeInterval),!this.biomeAudio.src||this.biomeAudio.paused){this.biomeAudio.src=this.basePath+e,this.biomeAudio.volume=0,this.biomeAudio.play().catch(()=>{}),this.fadeIn(this.biomeAudio,i,"biome");return}this.fadeOut(this.biomeAudio,()=>{this.biomeAudio.src=this.basePath+e,this.biomeAudio.play().catch(()=>{}),this.fadeIn(this.biomeAudio,i,"biome")},"biome")}crossfadeWeather(e,t){if(!this.weatherAudio)return;const i=t*this.weatherVolume*this.masterVolume;if(this.weatherFadeInterval&&clearInterval(this.weatherFadeInterval),!this.weatherAudio.src||this.weatherAudio.paused){this.weatherAudio.src=this.basePath+e,this.weatherAudio.volume=0,this.weatherAudio.play().catch(()=>{}),this.fadeIn(this.weatherAudio,i,"weather");return}this.fadeOut(this.weatherAudio,()=>{this.weatherAudio.src=this.basePath+e,this.weatherAudio.play().catch(()=>{}),this.fadeIn(this.weatherAudio,i,"weather")},"weather")}crossfadeSettlement(e,t){if(!this.settlementAudio)return;const i=t*this.masterVolume;if(this.settlementFadeInterval&&clearInterval(this.settlementFadeInterval),!this.settlementAudio.src||this.settlementAudio.paused){this.settlementAudio.src=this.basePath+e,this.settlementAudio.volume=0,this.settlementAudio.play().catch(()=>{}),this.fadeIn(this.settlementAudio,i,"settlement");return}this.fadeOut(this.settlementAudio,()=>{this.settlementAudio.src=this.basePath+e,this.settlementAudio.play().catch(()=>{}),this.fadeIn(this.settlementAudio,i,"settlement")},"settlement")}fadeIn(e,t,i){const a=this.fadeTime/20,n=t/20;let r=0;const o=setInterval(()=>{r++,e.volume=Math.min(t,n*r),r>=20&&(clearInterval(o),e.volume=t)},a);i==="biome"?this.biomeFadeInterval=o:i==="weather"?this.weatherFadeInterval=o:i==="settlement"&&(this.settlementFadeInterval=o)}fadeOut(e,t,i){const a=this.fadeTime/20,n=e.volume,r=n/20;let o=0;const l=setInterval(()=>{o++,e.volume=Math.max(0,n-r*o),o>=20&&(clearInterval(l),e.volume=0,e.pause(),t&&t())},a);i==="biome"?this.biomeFadeInterval=l:i==="weather"?this.weatherFadeInterval=l:i==="settlement"&&(this.settlementFadeInterval=l)}fadeOutBiome(){this.biomeAudio&&!this.biomeAudio.paused&&this.fadeOut(this.biomeAudio,null,"biome")}fadeOutWeather(){this.weatherAudio&&!this.weatherAudio.paused&&this.fadeOut(this.weatherAudio,null,"weather")}fadeOutSettlement(){this.settlementAudio&&!this.settlementAudio.paused&&this.fadeOut(this.settlementAudio,null,"settlement")}stopAll(){this.biomeFadeInterval&&clearInterval(this.biomeFadeInterval),this.weatherFadeInterval&&clearInterval(this.weatherFadeInterval),this.settlementFadeInterval&&clearInterval(this.settlementFadeInterval),this.corruptionFadeInterval&&clearInterval(this.corruptionFadeInterval),this.biomeAudio&&(this.biomeAudio.pause(),this.biomeAudio.volume=0),this.weatherAudio&&(this.weatherAudio.pause(),this.weatherAudio.volume=0),this.settlementAudio&&(this.settlementAudio.pause(),this.settlementAudio.volume=0),this.corruptionAudio&&(this.corruptionAudio.pause(),this.corruptionAudio.volume=0),this.currentBiome=null,this.currentWeather=null,this.currentSettlement=null,this.currentCorruptionZone=null}pauseAll(){this.biomeAudio&&this.biomeAudio.pause(),this.weatherAudio&&this.weatherAudio.pause(),this.settlementAudio&&this.settlementAudio.pause(),this.corruptionAudio&&this.corruptionAudio.pause()}resumeAll(){this.biomeAudio&&this.currentBiome&&this.biomeAudio.play().catch(()=>{}),this.weatherAudio&&this.currentWeather&&this.weatherAudio.play().catch(()=>{}),this.settlementAudio&&this.currentSettlement&&this.settlementAudio.play().catch(()=>{}),this.corruptionAudio&&this.currentCorruptionZone&&this.currentCorruptionZone!=="SAFE"&&this.corruptionAudio.play().catch(()=>{})}}const Kt={MID:{min:.35},INNER:{min:.7}},he={SAFE:{minDist:0,maxDist:10,name:"Safe",color:null,effects:{dotDamage:0,staminaDrain:0,enemyBuff:1,spawnRate:1}},TAINTED:{minDist:11,maxDist:18,name:"Tainted",color:"rgba(90, 50, 110, 0.12)",effects:{dotDamage:0,staminaDrain:.1,enemyBuff:1.1,spawnRate:1.2}},CORRUPTED:{minDist:19,maxDist:22,name:"Corrupted",color:"rgba(100, 40, 80, 0.20)",effects:{dotDamage:1,staminaDrain:.2,enemyBuff:1.25,spawnRate:1.5}},BLIGHTED:{minDist:23,maxDist:1/0,name:"Blighted",color:"rgba(80, 20, 60, 0.35)",effects:{dotDamage:3,staminaDrain:.3,enemyBuff:1.5,spawnRate:2,conditionChance:.1}}};function ks(T){return T<=he.SAFE.maxDist?"SAFE":T<=he.TAINTED.maxDist?"TAINTED":T<=he.CORRUPTED.maxDist?"CORRUPTED":"BLIGHTED"}class Jt{constructor(e,t){this.state=e,this.grid=t,this.settlements=[],this.cleansedHexes=new Set,this.lastZone=null,this.wardProtection=null}initFromPOIs(e){var t;this.settlements=[];for(const i of e)((t=i.type)==null?void 0:t.category)==="settlement"&&this.settlements.push({q:i.q,r:i.r,size:i.type.size||1});console.log(`OverworldCorruption: Tracking ${this.settlements.length} settlements as safe zones`)}getDistanceToNearestTown(e,t){if(this.settlements.length===0)return 1/0;let i=1/0;for(const s of this.settlements){const n=this.grid.distance(e,t,s.q,s.r)-(s.size-1);i=Math.min(i,n)}return Math.max(0,i)}getZoneAt(e,t){const i=`${e},${t}`;if(this.cleansedHexes.has(i))return"SAFE";const s=this.getDistanceToNearestTown(e,t);return ks(s)}getZoneDataAt(e,t){const i=this.getZoneAt(e,t);return he[i]}hasWardProtection(e="TAINTED"){if(!this.wardProtection)return!1;const t=this.state.tick;return this.wardProtection.expiresAt<=t?(this.wardProtection=null,this.state.addLog("Your ward protection has expired!","warning"),!1):({basic:["TAINTED"],corruption:["TAINTED","CORRUPTED"],blessed:["TAINTED","CORRUPTED","BLIGHTED"],relic:["TAINTED","CORRUPTED","BLIGHTED"]}[this.wardProtection.type]||[]).includes(e)}activateWard(e,t){this.wardProtection={type:e,expiresAt:this.state.tick+t,activatedAt:this.state.tick};const i={basic:"Basic Ward",corruption:"Corruption Ward",blessed:"Blessed Ward",relic:"Cleansing Relic"};this.state.addLog(`${i[e]||"Ward"} activated!`,"success")}getWardTimeRemaining(){return this.wardProtection?Math.max(0,this.wardProtection.expiresAt-this.state.tick):0}applyZoneEffects(e,t){const i=this.getZoneAt(e,t),s=he[i];if(i!==this.lastZone&&(this.onZoneChange(this.lastZone,i),this.lastZone=i),i==="SAFE")return{damage:0,message:null};if(this.hasWardProtection(i))return{damage:0,message:null,protected:!0};const a=s.effects;let n=0,r=null;if(a.dotDamage>0&&(n=a.dotDamage,this.state.player.health=Math.max(0,this.state.player.health-n),this.state.player.health<=0&&(this.state.player.health=0,this.state.addLog("The corruption has consumed you...","error"),this.onCorruptionDeath&&this.onCorruptionDeath())),a.conditionChance&&Math.random()<a.conditionChance){const o=["poisoned","weakened","hexed"],l=o[Math.floor(Math.random()*o.length)];this.state.applyCondition(l),r=l}return{damage:n,zone:s.name,conditionApplied:r,protected:!1}}onZoneChange(e,t){t==="TAINTED"&&e==="SAFE"?this.state.addLog("You leave the safety of civilization. The air feels... wrong.","warning"):t==="CORRUPTED"?this.state.addLog("The corruption intensifies. You feel it draining your life force.","danger"):t==="BLIGHTED"?this.state.addLog("You enter the blighted lands. The corruption is overwhelming!","danger"):t==="SAFE"&&e!==null?this.state.addLog("You return to safety. The corruption cannot reach you here.","success"):t==="TAINTED"&&(e==="CORRUPTED"||e==="BLIGHTED")?this.state.addLog("The corruption eases slightly.","info"):t==="CORRUPTED"&&e==="BLIGHTED"&&this.state.addLog("The corruption lessens, but danger remains.","info")}cleanseArea(e,t,i=3){let s=0;for(let a=-i;a<=i;a++)for(let n=-i;n<=i;n++){const r=e+a,o=t+n;if(this.grid.distance(e,t,r,o)<=i){const c=`${r},${o}`;this.cleansedHexes.has(c)||(this.cleansedHexes.add(c),s++)}}return s>0&&this.state.addLog(`The corruption recedes! ${s} hexes cleansed.`,"success"),s}isHexCleansed(e,t){return this.cleansedHexes.has(`${e},${t}`)}getZonesInView(e,t,i){const s=[];for(let a=-i;a<=i;a++)for(let n=-i;n<=i;n++){const r=e+a,o=t+n,l=this.getZoneAt(r,o),c=he[l];l!=="SAFE"&&c.color&&s.push({q:r,r:o,zone:l,color:c.color,cleansed:this.isHexCleansed(r,o)})}return s}toJSON(){return{cleansedHexes:[...this.cleansedHexes],wardProtection:this.wardProtection,lastZone:this.lastZone}}fromJSON(e){e&&(this.cleansedHexes=new Set(e.cleansedHexes||[]),this.wardProtection=e.wardProtection||null,this.lastZone=e.lastZone||null)}}function xs(T){return T>=Kt.INNER.min?"INNER":T>=Kt.MID.min?"MID":T>0?"OUTER":null}const Zt={void_seekers:{id:"void_seekers",name:"Void Corruption",color:"#1a0a2e",overlayAlpha:.3,conditions:["hexed","weakened"],enemyBuff:{damage:1.3,health:1.2},spawnBonus:.15},blood_covenant:{id:"blood_covenant",name:"Blood Miasma",color:"#3a0a0a",overlayAlpha:.25,conditions:["poisoned","bleeding"],enemyBuff:{damage:1.4,lifesteal:.1},spawnBonus:.2},whispering_shadow:{id:"whispering_shadow",name:"Shadow Veil",color:"#0a0a1a",overlayAlpha:.4,conditions:["bewitched","confused"],enemyBuff:{agility:1.5,evasion:.2},spawnBonus:.1},flesh_weavers:{id:"flesh_weavers",name:"Flesh Rot",color:"#2a1a0a",overlayAlpha:.2,conditions:["diseased","paralyzed"],enemyBuff:{health:1.5,regen:.05},spawnBonus:.25}},Ts={cult_shrine:["void_seekers","whispering_shadow"],blood_altar:["blood_covenant"],void_rift:["void_seekers"],flesh_pit:["flesh_weavers"]};class ei{constructor(e,t,i=1){this.source=e,this.cultType=t,this.power=i,this.radius=2+i*1.5,this.affectedHexes=new Set,this.intensity=new Map,this.zoneTiers=new Map,this.cleansed=!1}recalculateHexes(e){if(this.affectedHexes.clear(),this.intensity.clear(),this.zoneTiers.clear(),this.cleansed||this.power<=0)return;const t=this.source.q,i=this.source.r;for(let s=-this.radius;s<=this.radius;s++)for(let a=-this.radius;a<=this.radius;a++){const n=t+s,r=i+a,o=e.distance(t,i,n,r);if(o<=this.radius){const l=`${n},${r}`;this.affectedHexes.add(l);const c=Math.max(0,1-o/this.radius);this.intensity.set(l,c);const d=xs(c);d&&this.zoneTiers.set(l,d)}}}getIntensityAt(e,t){const i=`${e},${t}`;return this.intensity.get(i)||0}containsHex(e,t){const i=`${e},${t}`;return this.affectedHexes.has(i)}getZoneTierAt(e,t){const i=`${e},${t}`;return this.zoneTiers.get(i)||null}}class ti{constructor(e,t){this.state=e,this.grid=t,this.activeAuras=[],this.hexAuraCache=new Map,this.auraHexMap=new Map,this.innerZoneTime=0,this.lastZoneTier=null,this.random=null}createRandom(e){let t=Math.floor(e)||1;return()=>(t=t*16807%2147483647,(t-1)/2147483646)}initFromPOIs(e,t=null){var n,r;this.activeAuras=[],t?this.random=t:this.state.worldSeed!==null?this.random=this.createRandom(this.state.worldSeed+5e3):(console.warn("AuraSystem: No seed available, using Math.random (non-deterministic)"),this.random=()=>Math.random());const i={cult_shrine:.5,blood_altar:.75,void_rift:.9,flesh_pit:.7};let s=0;for(const o of e){if(o.type.category!=="cult")continue;const l=i[o.type.id]||.5;if(this.random()>l)continue;let c=(n=o.data)==null?void 0:n.associatedCult;if(!c){const h=Ts[o.type.id];h?c=h[Math.floor(this.random()*h.length)]:c="void_seekers"}let d=1;(r=o.data)!=null&&r.ritualPower?d={Weak:1,Moderate:2,Strong:3,Overwhelming:4}[o.data.ritualPower]||2:d=1+Math.floor(this.random()*3);const u=new ei(o,c,d);u.recalculateHexes(this.grid),this.activeAuras.push(u),this.updateAuraInCache(u),s++}const a=e.filter(o=>o.type.category==="cult");console.log(`AuraSystem: Generated ${s} active auras from ${a.length} cult sites`)}rebuildHexCache(){this.hexAuraCache.clear(),this.auraHexMap.clear();for(const e of this.activeAuras)e.cleansed||this.updateAuraInCache(e)}updateAuraInCache(e){const t=this.auraHexMap.get(e);if(t)for(const s of t){const a=this.hexAuraCache.get(s);if(a){const n=a.filter(r=>r.aura!==e);n.length===0?this.hexAuraCache.delete(s):this.hexAuraCache.set(s,n)}}if(e.cleansed||e.power<=0){this.auraHexMap.delete(e);return}const i=new Set;for(const s of e.affectedHexes){i.add(s);const a=e.intensity.get(s)||0,n=e.zoneTiers.get(s)||"OUTER";this.hexAuraCache.has(s)||this.hexAuraCache.set(s,[]),this.hexAuraCache.get(s).push({aura:e,intensity:a,tier:n,cultType:e.cultType,effects:Zt[e.cultType]})}this.auraHexMap.set(e,i)}getAurasAt(e,t){const i=`${e},${t}`;return this.hexAuraCache.get(i)||[]}getStrongestAuraAt(e,t){const i=this.getAurasAt(e,t);return i.length===0?null:i.reduce((s,a)=>a.intensity>s.intensity?a:s)}isPlayerInAura(){const e=this.state.player.position;return e?this.getAurasAt(e.q,e.r).length>0:!1}getZoneTierAt(e,t){const i=this.getAurasAt(e,t);if(i.length===0)return null;const s={INNER:3,MID:2,OUTER:1};let a=null,n=0;for(const r of i){const o=s[r.tier]||0;o>n&&(n=o,a=r.tier)}return a}applyAuraEffects(e,t){const i=this.getAurasAt(e,t);if(i.length===0){this.innerZoneTime=0,this.lastZoneTier=null;return}this.state.lexicon&&this.state.lexicon.unlock("corruption_auras");const s=this.getZoneTierAt(e,t);if(this.hasCorruptionProtection()){s!==this.lastZoneTier&&(s==="INNER"?this.state.addLog("Your sacred item glows, warding off the corruption.","info"):s==="OUTER"&&!this.lastZoneTier&&this.state.addLog("You enter a tainted area. Your protection holds.","info"),this.lastZoneTier=s);return}s!==this.lastZoneTier&&(s==="INNER"?this.state.addLog("The corruption here is overwhelming!","danger"):s==="MID"&&this.lastZoneTier!=="INNER"?this.state.addLog("You feel the corruption intensify...","warning"):s==="OUTER"&&!this.lastZoneTier&&this.state.addLog("You enter a tainted area.","info"),this.lastZoneTier=s);for(const a of i){const{tier:n,effects:r}=a;if(r&&n!=="OUTER"){if(n==="MID")for(const o of r.conditions)Math.random()<.05&&this.state.applyCondition(o);if(n==="INNER")for(const o of r.conditions)Math.random()<.15&&this.state.applyCondition(o)}}}tickInnerZoneEffects(){const e=this.state.player.position;if(!e||this.hasCorruptionProtection())return;if(this.getZoneTierAt(e.q,e.r)==="INNER"){if(this.innerZoneTime++,this.innerZoneTime%5===0){const i=this.getAurasAt(e.q,e.r);for(const s of i)if(s.tier==="INNER"&&s.effects){const a=s.effects.conditions,n=a[Math.floor(Math.random()*a.length)];this.state.applyCondition(n),this.state.addLog("The corruption seeps into your very being...","danger");break}}}else this.innerZoneTime=0}applyPostCombatConditions(e,t){const i=this.getAurasAt(e,t);if(i.length===0)return;const s=this.hasCorruptionProtection()?.5:1;for(const a of i){const{tier:n,effects:r}=a;if(!r)continue;const l=({OUTER:.15,MID:.3,INNER:.5}[n]||.1)*s;for(const c of r.conditions)Math.random()<l&&this.state.applyCondition(c)}}isHexPassable(e,t,i=!1){const s=this.getAurasAt(e,t);for(const a of s)if(a.intensity>.8&&!i)return{passable:!1,reason:"The corruption is too intense!"};return{passable:!0}}hasCorruptionProtection(){const e=this.state.inventory;return!!(e&&(e.has("silver_talisman")||e.has("purifying_crystal")))}buffEnemyInAura(e,t,i){const s=this.getStrongestAuraAt(t,i);if(!s||!s.effects)return e;const n=s.effects.enemyBuff;return n.health&&(e.hp=Math.floor(e.hp*n.health),e.maxHp=Math.floor(e.maxHp*n.health)),n.damage&&(e.damage=Math.floor(e.damage*n.damage)),n.agility&&(e.agility=Math.floor((e.agility||5)*n.agility)),n.lifesteal&&(e.lifesteal=n.lifesteal),n.regen&&(e.regen=n.regen),n.evasion&&(e.evasion=n.evasion),e.auraBuffed=!0,e.auraType=s.cultType,e}dailyUpdate(){for(const e of this.activeAuras)if(e.cleansed){if(e.power=Math.max(0,e.power-.5),e.radius=2+e.power*1.5,e.recalculateHexes(this.grid),this.updateAuraInCache(e),e.power<=0){const t=this.activeAuras.indexOf(e);t!==-1&&this.activeAuras.splice(t,1),this.updateAuraInCache(e)}}else Math.random()<.1&&(e.power=Math.min(5,e.power+.1),e.radius=2+e.power*1.5,e.recalculateHexes(this.grid),this.updateAuraInCache(e))}cleanseCultSite(e){for(const t of this.activeAuras)if(t.source.q===e.q&&t.source.r===e.r)return t.cleansed=!0,e.data=e.data||{},e.data.cleansed=!0,this.state.addLog(`The corruption at ${e.name} has been cleansed!`,"success"),this.state.player.alignment+=15,this.updateAuraInCache(t),!0;return!1}getAllAffectedHexes(){const e=[];for(const[t,i]of this.hexAuraCache){const[s,a]=t.split(",").map(Number),n=i.reduce((r,o)=>o.intensity>r.intensity?o:r);e.push({q:s,r:a,intensity:n.intensity,tier:n.tier,cultType:n.cultType,effects:n.effects})}return e}cleanseAura(e,t,i,s){var l,c;const a=this.activeAuras.filter(d=>d.cleansed?!1:this.grid.distance(e,t,d.source.q,d.source.r)<=d.radius+2);if(a.length===0)return{success:!1,reason:"No corruption zones nearby to cleanse."};const n=s.cleansesAura;let r=null;if(n==="any")r=a.reduce((d,u)=>{const h=this.grid.distance(e,t,d.source.q,d.source.r);return this.grid.distance(e,t,u.source.q,u.source.r)<h?u:d});else{const u={void_rift:["void_seekers"],blood_altar:["blood_covenant"],cult_shrine:["void_seekers","whispering_shadow"],flesh_pit:["flesh_weavers"]}[n]||[];if(r=a.find(h=>u.includes(h.cultType)),!r)return{success:!1,reason:`This relic cleanses ${n.replace("_"," ")} corruption, but no matching zones are nearby.`}}r.cleansed=!0,r.power=Math.max(0,r.power-s.cleanseRadius),r.radius=2+r.power*1.5,r.recalculateHexes(this.grid),this.updateAuraInCache(r),(l=r.source)!=null&&l.data&&(r.source.data.cleansed=!0);const o=((c=Zt[r.cultType])==null?void 0:c.name)||"corruption";return{success:!0,message:`The ${s.name||"relic"} purifies the ${o}! The corruption begins to fade.`,aura:r}}getCleanseableAuras(e,t){return this.activeAuras.filter(i=>i.cleansed?!1:this.grid.distance(e,t,i.source.q,i.source.r)<=i.radius+2)}toJSON(){return{auras:this.activeAuras.map(e=>({sourceQ:e.source.q,sourceR:e.source.r,cultType:e.cultType,power:e.power,cleansed:e.cleansed}))}}fromJSON(e,t){if(!(!e||!e.auras)){this.activeAuras=[];for(const i of e.auras){const s=t.find(a=>a.q===i.sourceQ&&a.r===i.sourceR);if(s){const a=new ei(s,i.cultType,i.power);a.cleansed=i.cleansed||!1,a.recalculateHexes(this.grid),this.activeAuras.push(a),this.updateAuraInCache(a)}}}}}const be={time_system:{id:"time_system",category:"basics",title:"Time & Day Cycle",icon:"ðŸ•",content:`Time in Etherground flows in two modes:

**Realtime Mode**: Time advances automatically (2 minutes every few seconds). The world moves around you.

**Stop Mode**: Press the time button or Spacebar to pause automatic time. Time only advances when you take actions. After 15 seconds of idle, realtime resumes.

The day cycles through morning (6-12), afternoon (12-17), evening (17-21), and night (21-6). Night travel is more dangerous and exhausting.`},movement:{id:"movement",category:"basics",title:"Movement & Travel",icon:"ðŸš¶",content:`Click on the map to move. Your character will walk along the path, with each step taking time and stamina.

**Terrain Effects**:
- Mountains: Slower travel, more stamina cost
- Roads: Faster travel between locations
- Water: Impassable (use bridges)

**Stamina**: Moving costs stamina. Rest to recover. Running out of stamina slows you down significantly.`},gathering_basics:{id:"gathering_basics",category:"basics",title:"Gathering Resources",icon:"â›ï¸",content:`The world is filled with resources you can gather. Look for icons on the map:

**Resource Icons**:
- ðŸŒ²ðŸŒ³ Trees: Chop for wood
- ðŸª¨â›°ï¸ Rocks: Mine for ore and stone
- ðŸŒ¿ðŸŒ¸ Plants: Gather herbs and flowers
- ðŸšðŸŽ£ Coasts: Fish or collect shells

**How to Gather**:
1. Move adjacent to (or onto) a hex with a resource icon
2. Action buttons appear automatically (e.g., "ðŸª“ Chop Wood Ã—5")
3. Click an action to start gathering
4. Wait for the progress bar to complete

**Tips**:
- The Ã—number shows total remaining uses nearby
- Each resource spot has limited uses before it's depleted
- Depleted resources respawn elsewhere over time
- Gathering costs stamina and time
- Higher Prestige gives bonus yield!`},combat_basics:{id:"combat_basics",category:"combat",title:"Combat Basics",icon:"âš”ï¸",content:`When you encounter enemies, combat begins. Combat is turn-based.

**Your Options**:
- Attack: Deal damage based on your weapon and stats
- Defend: Reduce incoming damage
- Use Item: Consume potions or use equipment
- Flee: Attempt to escape (may fail)

**Damage**: Based on your weapon, class bonuses, and the enemy's defense. Critical hits deal extra damage.`},settlements:{id:"settlements",category:"locations",title:"Settlements",icon:"ðŸ˜ï¸",content:`Settlements are safe havens where you can rest, trade, and find work.

**Types**: Villages, Towns, Cities, Outposts, Ports
**Services**: Shops, Taverns, Stables, Guild Halls
**Activities**: Rest, Trade, Work, Volunteer, Hire Citizens

Larger settlements have more services and opportunities.`},dungeons:{id:"dungeons",category:"locations",title:"Dungeons",icon:"ðŸ›ï¸",content:`Dungeons are multi-floor locations filled with dangers and treasures.

**Features**:
- Multiple floors connected by ladders
- Locked doors require keys or lockpicks
- Chests and vases contain loot
- One enemy per floor carries the floor key

**Tips**: Explore carefully, the entrance is one-way - find another exit! Deeper floors are darker and more dangerous.`},guild_halls:{id:"guild_halls",category:"locations",title:"Guild Halls",icon:"ðŸ›ï¸",content:`Guild halls are headquarters for various professional organizations.

**Services**:
- Quest Board: Take on contracts
- Rest: Restore HP and Stamina
- Training: Improve skills (coming soon)

**Guilds protect against corruption** - staying near a guild hall provides resistance to cult auras.`},cult_sites:{id:"cult_sites",category:"locations",title:"Cult Sites",icon:"ðŸ©¸",content:`Dark shrines where forbidden cults practice their rituals.

**Types**: Shrines, Blood Altars, Void Rifts, Flesh Pits

**Danger**: Cult sites emanate corruption auras that can afflict you with conditions.

**Choice**: Join the cult for dark power, or cleanse the site with sacred items for alignment and rewards.`},guilds_overview:{id:"guilds_overview",category:"factions",title:"Guilds",icon:"ðŸ…",content:`Professional guilds offer contracts, training, and community.

**Known Guilds**:
- ðŸ’° Merchant's Coalition - Trade & Commerce
- ðŸ§­ Explorer's League - Discovery & Mapping
- âš’ï¸ Artisan's Circle - Crafting & Creation
- âš”ï¸ Iron Company - Mercenary Work
- ðŸ—ï¸ Shadow Network - Information & Infiltration
- ðŸ”® Ether Conclave - Arcane Knowledge

Each guild specializes in fighting different aspects of cult corruption.`},cults_overview:{id:"cults_overview",category:"factions",title:"Cults",icon:"ðŸ‘ï¸",content:`Dark organizations that worship forbidden powers.

**Known Cults**:
- Void Seekers - Embrace the emptiness
- Blood Covenant - Power through sacrifice
- Whispering Shadow - Secrets and manipulation
- Flesh Weavers - Transformation of the body

Joining a cult grants dark powers but corrupts your alignment. Their sites spread corruption across the land.`},alignment:{id:"alignment",category:"factions",title:"Alignment",icon:"âš–ï¸",content:`Your moral standing ranges from -100 (Chaotic) to +100 (Benevolent).

**Effects**:
- Positive alignment: Access to temples, guild bonuses
- Negative alignment: Access to cults, dark powers
- Neutral: Flexibility but fewer faction benefits

**Changing Alignment**: Good deeds (helping, cleansing) raise it. Dark deeds (cult rituals, crimes) lower it.`},conditions_overview:{id:"conditions_overview",category:"conditions",title:"Status Conditions",icon:"ðŸ’”",content:`Conditions are status effects that affect your character.

**Sources**: Corruption auras, enemy attacks, traps, poison

**Duration**: Most conditions wear off over time (measured in game minutes).

**Curing**: Rest at guild halls, use blessed water, or cleanse cult sites to remove all conditions.`},condition_poisoned:{id:"condition_poisoned",category:"conditions",title:"Poisoned",icon:"â˜ ï¸",content:`You take damage over time from poison in your system.

**Effect**: 2 damage per game minute
**Duration**: 30 minutes
**Source**: Blood Covenant auras, venomous enemies
**Cure**: Antidote, Blessed Water, resting at guild`},condition_hexed:{id:"condition_hexed",category:"conditions",title:"Hexed",icon:"ðŸ”®",content:`A dark curse weakens your attacks.

**Effect**: -30% damage dealt
**Duration**: 45 minutes
**Source**: Void Seeker auras, dark magic
**Cure**: Blessed Water, cleansing, guild rest`},condition_cursed:{id:"condition_cursed",category:"conditions",title:"Cursed",icon:"ðŸ’€",content:`A powerful curse binds your soul, weakening all abilities.

**Effect**: -25% to all stats
**Duration**: 120 minutes (2 hours)
**Source**: Powerful cult magic, cursed items
**Cure**: Sacred relics, cleansing rituals`},sacred_items:{id:"sacred_items",category:"items",title:"Sacred Items",icon:"âœï¸",content:`Holy artifacts that can cleanse corruption and cure conditions.

**Types**:
- ðŸ’Ž Purifying Crystal - Can dispel cult auras
- âœï¸ Holy Relic - Powerful cleansing
- ðŸ† Sacred Chalice - Ritual purification
- ðŸ’§ Blessed Water - Cures conditions

**Source**: Dungeon loot, guild quests, temples`},consumables:{id:"consumables",category:"items",title:"Consumables",icon:"ðŸ§ª",content:`Items that are consumed on use for immediate effects.

**Potions**:
- â¤ï¸ Health Potion: Restore 30 HP
- ðŸ’š Stamina Potion: Restore 40 Stamina
- ðŸ’œ Ether Potion: Restore 25 Ether

**Food**: Restores stamina and sometimes health. Quality varies.`},corruption_auras:{id:"corruption_auras",category:"world",title:"Corruption Auras",icon:"ðŸŒ‘",content:`Cult sites emanate corruption that spreads across the land.

**Effects**:
- Walking through corrupted hexes may inflict conditions
- Enemies in corruption are stronger
- High intensity areas may be impassable

**Protection**:
- Sacred items provide resistance
- Guild halls create safe zones
- Cleansing cult sites removes auras

**Cleansing**: Use sacred items at cult sites to dispel corruption permanently.`},hiring_citizens:{id:"hiring_citizens",category:"citizens",title:"Hiring Citizens",icon:"ðŸ‘¥",content:`You can hire NPCs to work for you.

**Finding Workers**: Visit settlements and talk to available citizens.

**Wages**: Citizens require daily gold payment. Different professions have different rates.

**Tasks**: Assign citizens to gather resources, guard locations, or assist with crafting.`},creature_wolf:{id:"creature_wolf",category:"creatures",title:"Wolf",icon:"ðŸº",content:`A cunning predator that hunts in packs across forests and grasslands.

**Behavior**: Aggressive - will actively hunt prey
**Habitat**: Forest, Taiga, Tundra, Grassland
**Danger**: Moderate

Wolves are fast and work together. A lone traveler may face multiple wolves at once. Their pelts are valuable for crafting warm clothing.`},creature_dire_wolf:{id:"creature_dire_wolf",category:"creatures",title:"Dire Wolf",icon:"ðŸº",content:`A massive, ancient breed of wolf, far larger and more dangerous than its common cousin.

**Behavior**: Aggressive pack hunter
**Habitat**: Deep forests, Taiga
**Danger**: High

Dire wolves are remnants of an older age. Their pelts are prized by nobility, and their fangs are used in dark rituals.`},creature_bear:{id:"creature_bear",category:"creatures",title:"Bear",icon:"ðŸ»",content:`A powerful beast that commands respect in the wilderness.

**Behavior**: Territorial - attacks if you get too close
**Habitat**: Forest, Taiga, Mountains
**Danger**: High

Bears are not naturally aggressive but will defend their territory fiercely. Their hides make excellent armor, and their claws are sought after by alchemists.`},creature_boar:{id:"creature_boar",category:"creatures",title:"Wild Boar",icon:"ðŸ—",content:`A fierce pig with sharp tusks and a bad temper.

**Behavior**: Aggressive when threatened
**Habitat**: Forest, Grassland
**Danger**: Low-Moderate

Boars are surprisingly dangerous due to their tusks and speed. Their meat is a common food source, and their tusks have various uses.`},creature_giant_spider:{id:"creature_giant_spider",category:"creatures",title:"Giant Spider",icon:"ðŸ•·ï¸",content:`Enormous arachnids that lurk in dark places, spinning webs to catch prey.

**Behavior**: Ambush predator
**Habitat**: Caves, Dungeons, Dark Forests
**Danger**: Moderate

Giant spiders are patient hunters. Their venom can paralyze victims, and their silk is valuable for crafting. They often guard valuable treasures in their lairs.`},creature_snake:{id:"creature_snake",category:"creatures",title:"Venomous Snake",icon:"ðŸ",content:`Serpents that strike from hiding with deadly venom.

**Behavior**: Passive until disturbed
**Habitat**: Desert, Swamp, Jungle
**Danger**: Low (but venomous)

Snakes are rarely aggressive but their bite can be deadly. Antivenom is essential when traveling through snake-infested areas.`},creature_crocodile:{id:"creature_crocodile",category:"creatures",title:"Crocodile",icon:"ðŸŠ",content:`Ancient reptilian predators that lurk in waters waiting for prey.

**Behavior**: Ambush hunter
**Habitat**: Swamp, Rivers, Coast
**Danger**: High

Crocodiles are patient killers. They can wait motionless for hours before striking with devastating force. Their hides make excellent armor.`},creature_goblin:{id:"creature_goblin",category:"creatures",title:"Goblin",icon:"ðŸ‘º",content:`Small, cunning creatures that live in caves and ruins in tribal groups.

**Behavior**: Aggressive in groups, cowardly alone
**Habitat**: Caves, Ruins, Forests
**Danger**: Low (individually)

Goblins are weak but numerous. They set traps and prefer ambushes. Some goblins have learned to craft crude weapons and armor.`},creature_troll:{id:"creature_troll",category:"creatures",title:"Troll",icon:"ðŸ‘¹",content:`Massive, regenerating brutes that dwell in caves and under bridges.

**Behavior**: Aggressive and territorial
**Habitat**: Caves, Mountains, Bridges
**Danger**: Very High

Trolls regenerate wounds rapidly and are incredibly strong. Fire and acid prevent their regeneration. They collect tolls from travelers or simply eat them.`},creature_ogre:{id:"creature_ogre",category:"creatures",title:"Ogre",icon:"ðŸ‘¹",content:`Giant humanoids with more muscle than brains.

**Behavior**: Aggressive
**Habitat**: Mountains, Highlands, Ruins
**Danger**: High

Ogres are simple creatures driven by hunger. They wield crude clubs and can smash through defenses. Some serve as muscle for bandit groups.`},creature_skeleton:{id:"creature_skeleton",category:"creatures",title:"Skeleton",icon:"ðŸ’€",content:`Animated bones of the dead, held together by dark magic.

**Behavior**: Aggressive to the living
**Habitat**: Ruins, Dungeons, Graveyards (Night only)
**Danger**: Moderate

Skeletons are tireless warriors that feel no pain or fear. They often guard ancient tombs or serve necromancers. Destroying the skull ends the animation.`},creature_zombie:{id:"creature_zombie",category:"creatures",title:"Zombie",icon:"ðŸ§Ÿ",content:`Rotting corpses animated by dark magic, driven by an endless hunger.

**Behavior**: Aggressive, slow but relentless
**Habitat**: Ruins, Graveyards, Dungeons (Night only)
**Danger**: Moderate

Zombies are slow but hard to kill. They spread disease with their touch and are often found in groups. Fire is effective against them.`},creature_ghost:{id:"creature_ghost",category:"creatures",title:"Ghost",icon:"ðŸ‘»",content:`Spectral remnants of the dead, bound to the mortal world by unfinished business.

**Behavior**: Varies - some passive, others hostile
**Habitat**: Ruins, Castles, Dungeons (Night only)
**Danger**: High

Ghosts can pass through walls and are immune to normal weapons. They drain life force with their touch. Putting their spirit to rest requires understanding their story.`},creature_wraith:{id:"creature_wraith",category:"creatures",title:"Wraith",icon:"ðŸ‘¤",content:`A malevolent spirit of pure hatred, far more dangerous than common ghosts.

**Behavior**: Highly aggressive
**Habitat**: Ancient Ruins, Cursed Places
**Danger**: Very High

Wraiths are formed from souls consumed by rage or betrayal. Their touch drains life and can curse victims. Only magical weapons can harm them.`},creature_golem:{id:"creature_golem",category:"creatures",title:"Golem",icon:"ðŸ—¿",content:`Animated constructs of stone or metal, created to guard ancient places.

**Behavior**: Defensive - attacks intruders
**Habitat**: Dungeons, Ruins, Temples
**Danger**: Very High

Golems are incredibly durable and tireless. They follow simple commands from their creators. Finding and destroying the animating rune is the only sure way to stop them.`},creature_elemental:{id:"creature_elemental",category:"creatures",title:"Elemental",icon:"ðŸ”¥",content:`Spirits of pure elemental force given physical form.

**Types**: Fire, Ice, Stone, Storm
**Habitat**: Varies by type
**Danger**: High to Very High

Elementals are powerful magical beings. They are immune to their own element and weak to opposing forces. Fire fears water, ice fears fire.`},creature_slime:{id:"creature_slime",category:"creatures",title:"Slime",icon:"ðŸŸ¢",content:`Amorphous blobs that dissolve organic matter for sustenance.

**Behavior**: Passive predator
**Habitat**: Caves, Sewers, Dungeons
**Danger**: Low-Moderate

Slimes are mindless but persistent. They can squeeze through tiny gaps and dissolve armor. Their residue has alchemical uses.`},creature_bandit:{id:"creature_bandit",category:"creatures",title:"Bandit",icon:"ðŸ—¡ï¸",content:`Outlaws who prey on travelers and merchants.

**Behavior**: Aggressive, may demand toll
**Habitat**: Roads, Forests, Hideouts
**Danger**: Moderate

Bandits range from desperate peasants to organized criminals. They often set ambushes and have hideouts where they store stolen goods.`},creature_cultist:{id:"creature_cultist",category:"creatures",title:"Cultist",icon:"ðŸ‘ï¸",content:`Fanatical worshippers of dark powers who have abandoned their humanity.

**Behavior**: Hostile to non-believers
**Habitat**: Cult Sites, Corrupted Areas
**Danger**: Moderate to High

Cultists often possess dark magic granted by their patrons. They perform rituals to spread corruption and may attempt to convert rather than kill.`},biome_forest:{id:"biome_forest",category:"world",title:"Forest",icon:"ðŸŒ²",content:`Dense woodlands teeming with life and hidden dangers.

**Resources**: Wood, Herbs, Berries, Game
**Creatures**: Wolves, Bears, Boars, Goblins
**Features**: Natural cover, limited visibility

Forests offer abundant resources but easy ambush spots. Stick to roads when possible.`},biome_mountain:{id:"biome_mountain",category:"world",title:"Mountains",icon:"â›°ï¸",content:`Towering peaks that challenge even experienced travelers.

**Resources**: Ore, Stone, Mountain Herbs
**Creatures**: Mountain Cats, Trolls, Giants
**Features**: Difficult terrain, cave systems

Mountains slow travel significantly but often hide valuable mines and ancient ruins.`},biome_swamp:{id:"biome_swamp",category:"world",title:"Swamp",icon:"ðŸŒ¿",content:`Murky wetlands filled with disease and strange creatures.

**Resources**: Rare Herbs, Frog Legs, Reeds
**Creatures**: Crocodiles, Snakes, Gillkin
**Features**: Slow travel, diseases, hidden paths

Swamps are dangerous but hold rare alchemical ingredients. The water hides many threats.`},biome_desert:{id:"biome_desert",category:"world",title:"Desert",icon:"ðŸœï¸",content:`Scorching wastelands where water is more precious than gold.

**Resources**: Cactus, Sand, Ancient Ruins
**Creatures**: Scorpions, Snakes, Bandits
**Features**: Extreme heat, dehydration risk

Deserts drain stamina quickly. Travel at night to avoid the worst heat, but beware nocturnal predators.`},biome_tundra:{id:"biome_tundra",category:"world",title:"Tundra",icon:"â„ï¸",content:`Frozen wastelands at the edge of the world.

**Resources**: Ice, Rare Furs, Frozen Herbs
**Creatures**: Frost Wolves, Yetis, Ice Elementals
**Features**: Extreme cold, blizzards

The cold itself is an enemy. Warm clothing and fire are essential for survival.`},guild_merchants:{id:"guild_merchants",category:"factions",title:"Merchant's Coalition",icon:"ðŸ’°",content:`The wealthiest guild, controlling trade routes across the realm.

**Focus**: Commerce, Trade, Resource Networks
**Anti-Cult Role**: Economic warfare - denying cults resources and funding
**Benefits**: Better prices, trade contracts, market information

The Coalition believes wealth is the truest power. They fight corruption by strangling its supply lines.`},guild_explorers:{id:"guild_explorers",category:"factions",title:"Explorer's League",icon:"ðŸ§­",content:`Cartographers, adventurers, and seekers of the unknown.

**Focus**: Discovery, Mapping, Ancient Knowledge
**Anti-Cult Role**: Finding hidden cult sites, mapping corruption zones
**Benefits**: Maps, travel bonuses, discovery rewards

The League believes knowledge defeats darkness. They map cult activity and uncover their secrets.`},guild_artisans:{id:"guild_artisans",category:"factions",title:"Artisan's Circle",icon:"âš’ï¸",content:`Master crafters who forge the tools of civilization.

**Focus**: Crafting, Creation, Sacred Items
**Anti-Cult Role**: Forging purifying items, repairing holy artifacts
**Benefits**: Crafting recipes, quality equipment, repair services

The Circle creates the weapons against darkness - blessed blades and sacred relics.`},guild_iron_company:{id:"guild_iron_company",category:"factions",title:"Iron Company",icon:"âš”ï¸",content:`Professional mercenaries bound by an iron code of honor.

**Focus**: Combat, Protection, Military Operations
**Anti-Cult Role**: Direct assault on cult strongholds, cultist hunts
**Benefits**: Combat training, military contracts, weapon access

The Company solves problems with steel. They believe the only good cultist is a dead one.`},guild_shadows:{id:"guild_shadows",category:"factions",title:"Shadow Network",icon:"ðŸ—ï¸",content:`Information brokers, spies, and those who work in darkness.

**Focus**: Intelligence, Infiltration, Secrets
**Anti-Cult Role**: Infiltrating cults, stealing artifacts, sabotage
**Benefits**: Information, stealth training, lockpicking tools

The Network knows that some battles are won without drawing a blade. They fight cults from within.`},guild_ether_conclave:{id:"guild_ether_conclave",category:"factions",title:"Ether Conclave",icon:"ðŸ”®",content:`Scholars of the arcane who seek to understand magical forces.

**Focus**: Magic, Rituals, Ether Manipulation
**Anti-Cult Role**: Dispelling corruption, sealing rifts, magical cleansing
**Benefits**: Magical training, enchantments, ritual knowledge

The Conclave fights fire with fire - using controlled magic against cult corruption.`},cult_void_seekers:{id:"cult_void_seekers",category:"factions",title:"Void Seekers",icon:"ðŸŒ‘",content:`Those who embrace the emptiness between worlds.

**Philosophy**: The Void is peace. Reality is suffering.
**Corruption**: Void auras cause hexed and weakened conditions
**Rituals**: Summoning void entities, opening rifts

The Seekers believe existence itself is a mistake. They work to unmake reality, one piece at a time.`},cult_blood_covenant:{id:"cult_blood_covenant",category:"factions",title:"Blood Covenant",icon:"ðŸ©¸",content:`Worshippers of power through sacrifice.

**Philosophy**: Blood is life. Power demands payment.
**Corruption**: Blood auras cause poisoned and bleeding conditions
**Rituals**: Blood sacrifice, dark pacts, life drain

The Covenant believes power must be paid for in blood - preferably someone else's.`},cult_whispering_shadow:{id:"cult_whispering_shadow",category:"factions",title:"Whispering Shadow",icon:"ðŸ‘ï¸",content:`Masters of secrets and manipulation.

**Philosophy**: Knowledge is power. Secrets are weapons.
**Corruption**: Shadow auras cause bewitched and confused conditions
**Rituals**: Mind control, secret extraction, shadow walking

The Shadow knows everyone has secrets. They collect them, trade them, and use them as leverage.`},cult_flesh_weavers:{id:"cult_flesh_weavers",category:"factions",title:"Flesh Weavers",icon:"ðŸ§¬",content:`Those who seek transcendence through bodily transformation.

**Philosophy**: The flesh is clay to be molded. Perfection awaits.
**Corruption**: Flesh auras cause diseased and paralyzed conditions
**Rituals**: Body modification, mutation, flesh grafting

The Weavers believe humanity is incomplete. They "improve" themselves and others, willing or not.`},npc_merchant:{id:"npc_merchant",category:"citizens",title:"Traveling Merchants",icon:"ðŸŽ’",content:`Wandering traders who bring goods between settlements.

**Services**: Buy and sell goods, often rare items
**Found**: Traveling between towns, at markets
**Trust**: Building trust unlocks better prices and rare stock

Merchants risk their lives to keep trade flowing. Treat them well and they'll remember you.`},npc_pilgrim:{id:"npc_pilgrim",category:"citizens",title:"Pilgrims",icon:"ðŸ™",content:`Faithful travelers journeying to holy sites.

**Role**: Traveling to temples and shrines
**Found**: Roads, near religious sites
**Quests**: Escort missions, item delivery

Pilgrims often need protection. Helping them earns blessings and good karma.`},npc_scholar:{id:"npc_scholar",category:"citizens",title:"Scholars",icon:"ðŸ“œ",content:`Seekers of knowledge who study the world's mysteries.

**Role**: Research, translation, lore
**Found**: Cities, libraries, ruins
**Services**: Identify items, translate texts, share knowledge

Scholars pay well for rare books and artifacts. They may have information about cult activities.`},npc_mercenary:{id:"npc_mercenary",category:"citizens",title:"Mercenaries",icon:"âš”ï¸",content:`Soldiers for hire who fight for coin rather than cause.

**Role**: Combat assistance, guard duty
**Found**: Taverns, battlefields, guild halls
**Hire**: Can be recruited for dangerous missions

Mercenaries are reliable if paid, but loyalty ends when the gold runs out.`},dungeon_chests:{id:"dungeon_chests",category:"locations",title:"Dungeon Treasure",icon:"ðŸ“¦",content:`Containers of loot found throughout dungeons.

**Types**:
- ðŸ“¦ Chests: Larger rewards, sometimes trapped
- ðŸº Vases: Quick loot, breakable
- ðŸ’Ž Special: Quest items, rare artifacts

**Tips**: Check for traps before opening. Vases can alert enemies when broken.`},dungeon_doors:{id:"dungeon_doors",category:"locations",title:"Locked Doors",icon:"ðŸšª",content:`Barriers that block progress through dungeons.

**Opening Methods**:
- ðŸ—ï¸ Floor Key: Dropped by a specific enemy
- ðŸ”“ Lockpick: Consumable, may break

**Strategy**: Find and defeat the key holder, or bring lockpicks for emergencies.`},dungeon_portals:{id:"dungeon_portals",category:"locations",title:"Deep Portals",icon:"ðŸŒ€",content:`Mysterious gateways found in the depths of dungeons.

**Types**:
- ðŸŒ€ Cult Portal: Leads to a cult site
- â­ Guild Portal: Leads to a guild base

**Discovery**: Only found on floor 3 and deeper. Offer alternate escape routes and strategic shortcuts.`}},Cs={basics:{name:"Basics",icon:"ðŸ“–",order:1},combat:{name:"Combat",icon:"âš”ï¸",order:2},locations:{name:"Locations",icon:"ðŸ—ºï¸",order:3},factions:{name:"Factions",icon:"ðŸ…",order:4},conditions:{name:"Conditions",icon:"ðŸ’”",order:5},items:{name:"Items",icon:"ðŸŽ’",order:6},world:{name:"World",icon:"ðŸŒ",order:7},citizens:{name:"Citizens",icon:"ðŸ‘¥",order:8},creatures:{name:"Creatures",icon:"ðŸ‰",order:9}};class tt{constructor(e){this.state=e,this.unlockedEntries=new Set,this.readEntries=new Set,this.unlock("time_system",!0),this.unlock("movement",!0),this.unlock("gathering_basics",!0),this.readEntries.add("time_system"),this.readEntries.add("movement"),this.readEntries.add("gathering_basics")}unlock(e,t=!1){if(this.unlockedEntries.has(e))return!1;const i=be[e];return i?(this.unlockedEntries.add(e),!t&&this.state&&this.state.addLog(`Lexicon: "${i.title}" discovered!`,"discovery"),!0):!1}markRead(e){this.readEntries.add(e)}markAllRead(){for(const e of this.unlockedEntries)this.readEntries.add(e)}isUnread(e){return this.unlockedEntries.has(e)&&!this.readEntries.has(e)}getUnreadCount(){let e=0;for(const t of this.unlockedEntries)this.readEntries.has(t)||e++;return e}isUnlocked(e){return this.unlockedEntries.has(e)}getUnlockedEntries(){return Array.from(this.unlockedEntries).map(e=>be[e]).filter(e=>e)}getEntriesByCategory(e){return this.getUnlockedEntries().filter(t=>t.category===e)}getUnlockedCategories(){const e=new Set;for(const t of this.unlockedEntries){const i=be[t];i&&e.add(i.category)}return Array.from(e).map(t=>({id:t,...Cs[t]})).sort((t,i)=>t.order-i.order)}getProgress(){const e=Object.keys(be).length,t=this.unlockedEntries.size;return{unlocked:t,total:e,percent:Math.floor(t/e*100)}}toJSON(){return{unlocked:Array.from(this.unlockedEntries),read:Array.from(this.readEntries)}}fromJSON(e){e&&e.unlocked&&(this.unlockedEntries=new Set(e.unlocked)),e&&e.read&&(this.readEntries=new Set(e.read));const t=["time_system","movement","gathering_basics"];for(const i of t)this.unlockedEntries.add(i),this.readEntries.add(i)}}const _s={enter_combat:"combat_basics",enter_settlement:"settlements",enter_dungeon:"dungeons",enter_guild:"guild_halls",enter_cult_site:"cult_sites",join_cult:"cults_overview",view_guilds:"guilds_overview",get_condition:"conditions_overview",use_consumable:"consumables",find_sacred_item:"sacred_items",enter_corruption:"corruption_auras",hire_citizen:"hiring_citizens",check_alignment:"alignment",condition_poisoned:"condition_poisoned",condition_hexed:"condition_hexed",condition_cursed:"condition_cursed",defeat_wolf:"creature_wolf",defeat_dire_wolf:"creature_dire_wolf",defeat_bear:"creature_bear",defeat_boar:"creature_boar",defeat_spider:"creature_giant_spider",defeat_snake:"creature_snake",defeat_crocodile:"creature_crocodile",defeat_goblin:"creature_goblin",defeat_troll:"creature_troll",defeat_ogre:"creature_ogre",defeat_skeleton:"creature_skeleton",defeat_zombie:"creature_zombie",defeat_ghost:"creature_ghost",defeat_wraith:"creature_wraith",defeat_golem:"creature_golem",defeat_elemental:"creature_elemental",defeat_slime:"creature_slime",defeat_bandit:"creature_bandit",defeat_cultist:"creature_cultist",enter_forest:"biome_forest",enter_mountain:"biome_mountain",enter_swamp:"biome_swamp",enter_desert:"biome_desert",enter_tundra:"biome_tundra",join_merchants:"guild_merchants",join_explorers:"guild_explorers",join_artisans:"guild_artisans",join_iron_company:"guild_iron_company",join_shadows:"guild_shadows",join_ether_conclave:"guild_ether_conclave",encounter_void_seekers:"cult_void_seekers",encounter_blood_covenant:"cult_blood_covenant",encounter_whispering_shadow:"cult_whispering_shadow",encounter_flesh_weavers:"cult_flesh_weavers",meet_merchant_npc:"npc_merchant",meet_pilgrim:"npc_pilgrim",meet_scholar:"npc_scholar",meet_mercenary:"npc_mercenary",open_chest:"dungeon_chests",encounter_door:"dungeon_doors",find_portal:"dungeon_portals"},P={NONE:null,FORGE:"forge",ALCHEMY:"alchemy",COOKING:"cooking",WORKBENCH:"workbench"},R={MATERIALS:"materials",CONSUMABLES:"consumables",FOOD:"food",WEAPONS:"weapons",ARMOR:"armor",TOOLS:"tools",ALCHEMY:"alchemy"},Oe={leather_strip:{id:"leather_strip",name:"Leather Strip",category:R.MATERIALS,icon:"ðŸŸ«",ingredients:[{item:"leather",quantity:1}],result:{item:"leather_strip",quantity:3},skillRequired:0,craftTime:5,station:P.NONE,description:"Cut leather into strips for crafting"},cloth:{id:"cloth",name:"Cloth",category:R.MATERIALS,icon:"ðŸ§µ",ingredients:[{item:"wildflowers",quantity:3}],result:{item:"cloth",quantity:1},skillRequired:0,craftTime:10,station:P.NONE,description:"Weave plant fibers into cloth"},iron_ingot:{id:"iron_ingot",name:"Iron Ingot",category:R.MATERIALS,icon:"ðŸ”©",ingredients:[{item:"iron_ore",quantity:2},{item:"coal",quantity:1}],result:{item:"iron_ingot",quantity:1},skillRequired:1,craftTime:15,station:P.FORGE,description:"Smelt iron ore into usable ingots"},steel_ingot:{id:"steel_ingot",name:"Steel Ingot",category:R.MATERIALS,icon:"ðŸ”©",ingredients:[{item:"iron_ingot",quantity:2},{item:"coal",quantity:2}],result:{item:"steel_ingot",quantity:1},skillRequired:2,craftTime:20,station:P.FORGE,description:"Forge high-quality steel"},planks:{id:"planks",name:"Wooden Planks",category:R.MATERIALS,icon:"ðŸªµ",ingredients:[{item:"wood",quantity:2}],result:{item:"planks",quantity:3},skillRequired:0,craftTime:8,station:P.NONE,description:"Cut logs into planks"},rope:{id:"rope",name:"Rope",category:R.MATERIALS,icon:"ðŸª¢",ingredients:[{item:"wildflowers",quantity:5}],result:{item:"rope",quantity:1},skillRequired:0,craftTime:10,station:P.NONE,description:"Braid plant fibers into rope"},bandage:{id:"bandage",name:"Bandage",category:R.CONSUMABLES,icon:"ðŸ©¹",ingredients:[{item:"cloth",quantity:2}],result:{item:"bandage",quantity:2},skillRequired:0,craftTime:5,station:P.NONE,description:"Simple wound dressing"},torch:{id:"torch",name:"Torch",category:R.CONSUMABLES,icon:"ðŸ”¦",ingredients:[{item:"wood",quantity:1},{item:"cloth",quantity:1}],result:{item:"torch",quantity:2},skillRequired:0,craftTime:5,station:P.NONE,description:"Light the way through darkness"},cooked_meat:{id:"cooked_meat",name:"Cooked Meat",category:R.FOOD,icon:"ðŸ–",ingredients:[{item:"raw_meat",quantity:1}],result:{item:"cooked_meat",quantity:1},skillRequired:0,craftTime:10,station:P.COOKING,description:"Properly cooked meat, filling and safe"},cooked_fish:{id:"cooked_fish",name:"Cooked Fish",category:R.FOOD,icon:"ðŸŸ",ingredients:[{item:"fish",quantity:1}],result:{item:"cooked_fish",quantity:1},skillRequired:0,craftTime:8,station:P.COOKING,description:"Fresh grilled fish"},dried_meat:{id:"dried_meat",name:"Dried Meat",category:R.FOOD,icon:"ðŸ¥“",ingredients:[{item:"raw_meat",quantity:2}],result:{item:"rations",quantity:1},skillRequired:0,craftTime:20,station:P.COOKING,description:"Preserved meat that lasts for travel"},hearty_stew:{id:"hearty_stew",name:"Hearty Stew",category:R.FOOD,icon:"ðŸ²",ingredients:[{item:"raw_meat",quantity:1},{item:"mushrooms",quantity:2},{item:"herbs",quantity:1}],result:{item:"hearty_stew",quantity:1},skillRequired:1,craftTime:15,station:P.COOKING,description:"A nourishing stew that restores vitality"},health_potion:{id:"health_potion",name:"Health Potion",category:R.ALCHEMY,icon:"â¤ï¸",ingredients:[{item:"herbs",quantity:3},{item:"waterskin",quantity:1}],result:{item:"health_potion",quantity:2},skillRequired:1,craftTime:15,station:P.ALCHEMY,description:"Restores health when consumed"},stamina_potion:{id:"stamina_potion",name:"Stamina Potion",category:R.ALCHEMY,icon:"ðŸ’š",ingredients:[{item:"herbs",quantity:2},{item:"mushrooms",quantity:2},{item:"waterskin",quantity:1}],result:{item:"stamina_potion",quantity:2},skillRequired:1,craftTime:15,station:P.ALCHEMY,description:"Restores stamina for extended activities"},antidote:{id:"antidote",name:"Antidote",category:R.ALCHEMY,icon:"ðŸ’Š",ingredients:[{item:"swamp_moss",quantity:2},{item:"herbs",quantity:1}],result:{item:"antidote",quantity:1},skillRequired:1,craftTime:10,station:P.ALCHEMY,description:"Cures poison and toxins"},ether_potion:{id:"ether_potion",name:"Ether Potion",category:R.ALCHEMY,icon:"ðŸ’œ",ingredients:[{item:"crystal_shard",quantity:2},{item:"herbs",quantity:2},{item:"waterskin",quantity:1}],result:{item:"ether_potion",quantity:1},skillRequired:2,craftTime:20,station:P.ALCHEMY,description:"Restores magical ether"},fortifying_elixir:{id:"fortifying_elixir",name:"Fortifying Elixir",category:R.ALCHEMY,icon:"ðŸ›¡ï¸",ingredients:[{item:"herbs",quantity:3},{item:"troll_blood",quantity:1},{item:"waterskin",quantity:1}],result:{item:"fortifying_elixir",quantity:1},skillRequired:3,craftTime:25,station:P.ALCHEMY,description:"Grants temporary damage resistance"},iron_sword:{id:"iron_sword",name:"Iron Sword",category:R.WEAPONS,icon:"ðŸ—¡ï¸",ingredients:[{item:"iron_ingot",quantity:2},{item:"wood",quantity:1},{item:"leather_strip",quantity:1}],result:{item:"iron_sword",quantity:1},skillRequired:2,craftTime:20,station:P.FORGE,description:"A reliable iron blade"},iron_axe:{id:"iron_axe",name:"Iron Axe",category:R.WEAPONS,icon:"ðŸª“",ingredients:[{item:"iron_ingot",quantity:2},{item:"hardwood",quantity:1},{item:"leather_strip",quantity:1}],result:{item:"iron_axe",quantity:1},skillRequired:2,craftTime:20,station:P.FORGE,description:"A sturdy iron axe for combat or work"},steel_sword:{id:"steel_sword",name:"Steel Sword",category:R.WEAPONS,icon:"âš”ï¸",ingredients:[{item:"steel_ingot",quantity:3},{item:"hardwood",quantity:1},{item:"leather_strip",quantity:2}],result:{item:"steel_sword",quantity:1},skillRequired:3,craftTime:30,station:P.FORGE,description:"A finely crafted steel blade"},leather_armor:{id:"leather_armor",name:"Leather Armor",category:R.ARMOR,icon:"ðŸ¥‹",ingredients:[{item:"leather",quantity:4},{item:"leather_strip",quantity:3}],result:{item:"leather_armor",quantity:1},skillRequired:1,craftTime:25,station:P.NONE,description:"Basic protection for adventurers"},chainmail:{id:"chainmail",name:"Chainmail Armor",category:R.ARMOR,icon:"ðŸ›¡ï¸",ingredients:[{item:"iron_ingot",quantity:5},{item:"leather",quantity:2}],result:{item:"chainmail",quantity:1},skillRequired:3,craftTime:40,station:P.FORGE,description:"Interlocking metal rings for defense"},iron_helmet:{id:"iron_helmet",name:"Iron Helmet",category:R.ARMOR,icon:"â›‘ï¸",ingredients:[{item:"iron_ingot",quantity:2},{item:"leather_strip",quantity:1}],result:{item:"iron_helmet",quantity:1},skillRequired:2,craftTime:15,station:P.FORGE,description:"Protects your head in battle"},pickaxe:{id:"pickaxe",name:"Pickaxe",category:R.TOOLS,icon:"â›ï¸",ingredients:[{item:"iron_ingot",quantity:2},{item:"wood",quantity:2}],result:{item:"pickaxe",quantity:1},skillRequired:1,craftTime:15,station:P.FORGE,description:"Essential for mining operations"},axe:{id:"axe",name:"Woodcutting Axe",category:R.TOOLS,icon:"ðŸª“",ingredients:[{item:"iron_ingot",quantity:1},{item:"wood",quantity:2}],result:{item:"axe",quantity:1},skillRequired:1,craftTime:12,station:P.FORGE,description:"For efficient wood gathering"},fishing_rod:{id:"fishing_rod",name:"Fishing Rod",category:R.TOOLS,icon:"ðŸŽ£",ingredients:[{item:"wood",quantity:2},{item:"rope",quantity:1}],result:{item:"fishing_rod",quantity:1},skillRequired:0,craftTime:10,station:P.NONE,description:"Catch fish from bodies of water"},tent:{id:"tent",name:"Tent",category:R.TOOLS,icon:"â›º",ingredients:[{item:"cloth",quantity:4},{item:"wood",quantity:3},{item:"rope",quantity:2}],result:{item:"tent",quantity:1},skillRequired:1,craftTime:20,station:P.NONE,description:"Portable shelter for wilderness camping"}};function Ss(T,e){var t,i,s;if(!T.station)return!0;if(!e||e.type.category!=="settlement")return!1;switch(T.station){case P.FORGE:return((t=e.data)==null?void 0:t.hasForge)||e.type.id==="city";case P.ALCHEMY:return((i=e.data)==null?void 0:i.hasAlchemy)||e.type.id==="city";case P.COOKING:return!0;case P.WORKBENCH:return((s=e.data)==null?void 0:s.hasWorkbench)||e.type.id==="city"||e.type.id==="town";default:return!1}}class Ms{constructor(){this.queue=[],this.roundNumber=1,this.currentIndex=0}rollInitiative(e){var s;const t=Math.floor(Math.random()*20)+1;return(e.speed||((s=e.attributes)==null?void 0:s.agility)||5)+t}buildTurnOrder(e){return this.queue=e.filter(t=>!t.dead&&(t.hp>0||t.health>0||t.currentHp>0)).map(t=>({combatant:t,initiative:this.rollInitiative(t),acted:!1})).sort((t,i)=>i.initiative-t.initiative),this.currentIndex=0,this.queue}getCurrentTurn(){return this.currentIndex>=this.queue.length?null:this.queue[this.currentIndex]}isPlayerTurn(){const e=this.getCurrentTurn();return e&&e.combatant.isPlayer}nextTurn(){for(this.currentIndex<this.queue.length&&(this.queue[this.currentIndex].acted=!0),this.currentIndex++;this.currentIndex<this.queue.length;){const e=this.queue[this.currentIndex],t=e.combatant.hp||e.combatant.health||e.combatant.currentHp||0;if(!e.combatant.dead&&t>0)break;this.currentIndex++}if(this.currentIndex>=this.queue.length){this.roundNumber++;const e=this.queue.map(t=>t.combatant).filter(t=>!t.dead&&(t.hp>0||t.health>0||t.currentHp>0));this.buildTurnOrder(e)}return this.getCurrentTurn()}getUpcomingTurns(e=8){const t=[];let i=this.currentIndex,s=this.roundNumber,a=[...this.queue];for(;t.length<e;){if(i>=a.length){if(s++,a=a.filter(o=>{const l=o.combatant.hp||o.combatant.health||o.combatant.currentHp||0;return!o.combatant.dead&&l>0}),a.length===0)break;i=0}const n=a[i],r=n.combatant.hp||n.combatant.health||n.combatant.currentHp||0;!n.combatant.dead&&r>0&&t.push({combatant:n.combatant,isCurrent:t.length===0,round:s}),i++}return t}}class Is{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.playerPos={x:0,y:0},this.mousePos={x:0,y:0},this.enemies=[],this.hoveredTarget=null,this.active=!1,this.animationId=null,this.lockedTarget=null,this.lockedPosition=null,this.splineColor="#4a9eff",this.splineWidth=3,this.pulsePhase=0,this.targetRadius=50,this.animate=this.animate.bind(this)}setParticipants(e,t){this.playerPos=e,this.enemies=t.filter(i=>!i.dead&&i.currentHp>0)}lockToTarget(e){!e||!e.position||this.lockedTarget&&this.lockedTarget.id===e.id||(this.lockedTarget=e,this.lockedPosition={x:e.position.x,y:e.position.y},this.hoveredTarget=e,this.active||(this.active=!0,this.pulsePhase=0,this.animate()))}unlock(){this.lockedTarget=null,this.lockedPosition=null,this.hoveredTarget=null}start(){this.active=!0,this.pulsePhase=0,this.animate()}stop(){this.active=!1,this.lockedTarget=null,this.lockedPosition=null,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}animate(){this.active&&(this.draw(),this.pulsePhase++,this.animationId=requestAnimationFrame(this.animate))}calculateControlPoints(e,t){const i=t.x-e.x,s=t.y-e.y,a=Math.sqrt(i*i+s*s);if(a<1)return{cp1:{x:e.x,y:e.y},cp2:{x:t.x,y:t.y}};const n=a*.25,r=-s/a*n,o=i/a*n,l=Math.sin(this.pulsePhase*.08)*8;return{cp1:{x:e.x+i*.3+r+l,y:e.y+s*.3+o},cp2:{x:e.x+i*.7-r-l,y:e.y+s*.7-o}}}draw(){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),!this.active)return;const e=this.lockedPosition||this.mousePos;if(!e||e.x===0&&e.y===0)return;const{cp1:t,cp2:i}=this.calculateControlPoints(this.playerPos,e);this.ctx.beginPath(),this.ctx.moveTo(this.playerPos.x,this.playerPos.y),this.ctx.bezierCurveTo(t.x,t.y,i.x,i.y,e.x,e.y),this.ctx.strokeStyle="rgba(74, 158, 255, 0.2)",this.ctx.lineWidth=this.splineWidth+6,this.ctx.lineCap="round",this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(this.playerPos.x,this.playerPos.y),this.ctx.bezierCurveTo(t.x,t.y,i.x,i.y,e.x,e.y);const s=this.ctx.createLinearGradient(this.playerPos.x,this.playerPos.y,e.x,e.y),a=.6+Math.sin(this.pulsePhase*.1)*.2;s.addColorStop(0,`rgba(74, 158, 255, ${a*.5})`),s.addColorStop(.5,`rgba(100, 180, 255, ${a})`),s.addColorStop(1,`rgba(150, 220, 255, ${a})`),this.ctx.strokeStyle=s,this.ctx.lineWidth=this.splineWidth,this.ctx.stroke(),this.drawParticles(t,i,e);const n=this.lockedTarget||this.hoveredTarget;n&&this.drawTargetHighlight(n)}drawParticles(e,t,i){for(let a=0;a<6;a++){const n=(this.pulsePhase*.025+a*.16666666666666666)%1,r=this.easeInOutQuad(n),o=this.bezierPoint(this.playerPos.x,e.x,t.x,i.x,r),l=this.bezierPoint(this.playerPos.y,e.y,t.y,i.y,r),c=3+Math.sin(n*Math.PI)*2,d=.4+Math.sin(n*Math.PI)*.5;this.ctx.beginPath(),this.ctx.arc(o,l,c+3,0,Math.PI*2),this.ctx.fillStyle=`rgba(100, 180, 255, ${d*.3})`,this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(o,l,c,0,Math.PI*2),this.ctx.fillStyle=`rgba(180, 220, 255, ${d})`,this.ctx.fill()}}bezierPoint(e,t,i,s,a){const n=1-a;return n*n*n*e+3*n*n*a*t+3*n*a*a*i+a*a*a*s}easeInOutQuad(e){return e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2}drawTargetHighlight(e){const t=e.arenaPosition||e.position,i=t.x,s=t.y,n=this.targetRadius+Math.sin(this.pulsePhase*.12)*4;this.ctx.beginPath(),this.ctx.arc(i,s,n+8,0,Math.PI*2),this.ctx.strokeStyle="rgba(255, 200, 50, 0.15)",this.ctx.lineWidth=12,this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(i,s,n,0,Math.PI*2),this.ctx.strokeStyle="rgba(255, 200, 50, 0.8)",this.ctx.lineWidth=3,this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(i,s,n-6,0,Math.PI*2),this.ctx.strokeStyle="rgba(255, 220, 100, 0.4)",this.ctx.lineWidth=2,this.ctx.stroke()}updateMouse(e,t){this.mousePos={x:e,y:t},this.hoveredTarget=null;let i=this.targetRadius;for(const s of this.enemies){if(s.dead||s.currentHp<=0)continue;const a=s.arenaPosition||s.position,n=e-a.x,r=t-a.y,o=Math.sqrt(n*n+r*r);o<i&&(i=o,this.hoveredTarget=s)}return this.hoveredTarget}getHoveredTarget(){return this.hoveredTarget}resize(e,t){this.canvas.width=e,this.canvas.height=t}}class As{constructor(e){this.state=e}resolveAction(e,t,i){var o;const s={success:!0,damage:0,healing:0,effects:[],message:"",isCrit:!1},a=t.name||"You",n=(i==null?void 0:i.name)||"target";switch(e.type){case"attack":case"skill":s.damage=this.calculateDamage(e,t,i),this._dodged?(s.damage=0,s.dodged=!0,s.message=`${n} dodged ${a}'s attack!`):this._lastWasCrit?(s.isCrit=!0,s.message=`Critical hit! ${a} ${e.verb||"attacks"} ${n} for ${s.damage} damage!`):s.message=`${a} ${e.verb||"attacks"} ${n} for ${s.damage} damage!`,s.damage>0&&(i.currentHp!==void 0?(i.currentHp=Math.max(0,i.currentHp-s.damage),i.hp!==void 0&&(i.hp=i.currentHp)):i.health!==void 0&&(i.health=Math.max(0,i.health-s.damage),i.hp!==void 0&&(i.hp=i.health)));break;case"spell":if(e.damage)s.damage=this.calculateSpellDamage(e,t,i),s.message=`${a} casts ${e.name} on ${n} for ${s.damage} damage!`,i.currentHp!==void 0?(i.currentHp=Math.max(0,i.currentHp-s.damage),i.hp!==void 0&&(i.hp=i.currentHp)):i.health!==void 0&&(i.health=Math.max(0,i.health-s.damage),i.hp!==void 0&&(i.hp=i.health));else if(e.healing){s.healing=this.calculateHealing(e,t);const d=i.maxHp||i.maxHealth||100;i.currentHp!==void 0?(i.currentHp=Math.min(d,i.currentHp+s.healing),i.hp!==void 0&&(i.hp=i.currentHp)):i.health!==void 0&&(i.health=Math.min(d,i.health+s.healing),i.hp!==void 0&&(i.hp=i.health)),s.message=`${a} casts ${e.name} and heals for ${s.healing} HP!`}break;case"defend":t.defending=!0,s.message=`${a} takes a defensive stance.`,s.effects.push({type:"buff",name:"Defending",duration:1});break;case"flee":const c=.3+(t.speed||((o=t.attributes)==null?void 0:o.agility)||5)*.03;s.success=Math.random()<c,s.message=s.success?`${a} fled from battle!`:`${a} failed to escape!`,s.fled=s.success;break;case"item":s.message=`${a} uses ${e.name}.`;break}const r=(i==null?void 0:i.currentHp)??(i==null?void 0:i.health)??1;return i&&r<=0&&!i.dead&&(i.dead=!0,s.message+=` ${n} is defeated!`,s.killed=!0),s}calculateDamage(e,t,i){var l,c;let s,a;e.damage?[s,a]=e.damage:t.damage?[s,a]=t.damage:(s=3,a=6);let n=s+Math.random()*(a-s);const r=((l=t.attributes)==null?void 0:l.strength)||0;if(n+=r*.3,i.isPlayer){const u=(((c=i.attributes)==null?void 0:c.agility)||5)*.02;if(Math.random()<u)return this._dodged=!0,0}if(this._dodged=!1,!i.isPlayer&&i.defense){const d=i.defense,u=d/(d+20);n*=1-u}i.defending&&(n*=.5);const o=e.critChance||.1;return Math.random()<o?(n*=1.5,this._lastWasCrit=!0):this._lastWasCrit=!1,Math.round(Math.max(1,n))}calculateSpellDamage(e,t,i){var c;const[s,a]=e.damage;let n=s+Math.random()*(a-s);const r=((c=t.attributes)==null?void 0:c.magic)||0;n+=r*.8;const o=(i.defense||0)*.5,l=o/(o+50);return n*=1-l,Math.round(Math.max(1,n))}calculateHealing(e,t){var r;const[i,s]=e.healing;let a=i+Math.random()*(s-i);const n=((r=t.attributes)==null?void 0:r.magic)||0;return a+=n*.5,Math.round(a)}}class $s{selectAction(e,t,i){const s=i.filter(c=>c.available!==!1);if(s.length===0)return{action:{type:"attack",name:"Attack",damage:e.damage},target:t};const a=e.currentHp||e.hp||0,n=e.maxHp||100;if(a/n<.3){const c=s.find(d=>d.type==="spell"&&d.healing);if(c)return{action:c,target:e}}const o=s.filter(c=>(c.type==="skill"||c.type==="spell")&&c.damage);return o.length>0&&Math.random()<.3?{action:o[Math.floor(Math.random()*o.length)],target:t}:{action:s.find(c=>c.type==="attack")||s[0],target:t}}}let ot=!1;function at(T){ot=T,console.log(`Debug mid-game mode: ${T?"ENABLED":"DISABLED"}`)}function Es(T){if(!T)return;const e=Object.keys(le);for(const t of T)t.type.category==="settlement"&&(t.data.townAttributes={agriculture:{level:5,xp:J[5].xp+200,active:!0},construction:{level:5,xp:J[5].xp+200,active:!0},medicine:{level:4,xp:J[4].xp+150,active:!0},tailoring:{level:4,xp:J[4].xp+150,active:!0},warriors:{level:5,xp:J[5].xp+200,active:!0},smithing:{level:4,xp:J[4].xp+150,active:!0},rangers:{level:3,xp:J[3].xp+100,active:!0}},t.data.facilities=[...e],console.log(`Applied mid-game state to: ${t.name}`))}function Ps(T){var t,i,s;if(!(T!=null&&T.player))return;const e=T.player;if(e.gold=500,e.level=5,e.exp=0,e.xpToNextLevel=((t=T.getXpForLevel)==null?void 0:t.call(T,5))||500,e.attributes.trust=15,e.attributes.prestige=12,e.attributes.influence=10,T.inventory){const a=[{id:"health_potion",qty:5},{id:"stamina_potion",qty:5},{id:"rations",qty:10},{id:"torch",qty:3},{id:"iron_sword",qty:1},{id:"leather_armor",qty:1},{id:"antidote",qty:3}];for(const n of a)(s=(i=T.inventory).add)==null||s.call(i,n.id,n.qty)}console.log("Applied mid-game state to player")}function qs(T,e,t=5){var a;if(!(T!=null&&T.hireRandomCitizen))return[];const i=[],s=["gatherer","crafter","merchant","guard","scout"];for(let n=0;n<t;n++){const r=T.hireRandomCitizen(e);if(r){const o=Math.floor(Math.random()*4)+1;for(let l=0;l<o;l++)(a=T.levelUpCitizen)==null||a.call(T,r.uid);r.role=s[Math.floor(Math.random()*s.length)],i.push(r)}}return console.log(`Generated ${i.length} test citizens for ${e}`),i}function li(T){var e,t,i,s,a,n,r,o,l,c;if(T){if(console.log("=== APPLYING MID-GAME DEBUG STATE ==="),Es(T.pois),Ps(T.state),T.citizenManager&&((e=T.state)!=null&&e.player)){const d=(t=T.state.player.position)==null?void 0:t.q,u=(i=T.state.player.position)==null?void 0:i.r;if(d!==void 0&&u!==void 0){const h=`${d},${u}`;qs(T.citizenManager,h,5)}}if((s=T.state)!=null&&s.discoveredPOIs&&T.pois){const d=T.pois.filter(h=>h.type.category==="settlement"),u=d.slice(0,Math.min(5,d.length));for(const h of u)T.state.discoveredPOIs.add(`${h.q},${h.r}`)}(n=(a=T.state)==null?void 0:a.save)==null||n.call(a),console.log("=== MID-GAME DEBUG STATE APPLIED ==="),(o=(r=T.state)==null?void 0:r.addLog)==null||o.call(r,"Debug: Mid-game state applied","debug"),(c=(l=T.state)==null?void 0:l.showToast)==null||c.call(l,"Mid-game debug state enabled!","info",3e3,"ðŸ”§")}}typeof window<"u"&&(window.debugMidgame={enable:()=>at(!0),disable:()=>at(!1),apply:()=>{window.game?li(window.game):console.error("Game instance not found on window.game")},status:()=>console.log(`Mid-game debug: ${ot?"ENABLED":"DISABLED"}`)},console.log("Debug mid-game commands available: window.debugMidgame.enable(), .disable(), .apply(), .status()"));const Rs={human:{prestige:5,trust:6,influence:6,stamina:5,hp:5,ether:4,agility:5},half_elf:{prestige:4,trust:5,influence:5,stamina:5,hp:4,ether:6,agility:6},elf:{prestige:6,trust:4,influence:5,stamina:4,hp:3,ether:8,agility:7},orc:{prestige:3,trust:4,influence:4,stamina:7,hp:8,ether:2,agility:5},goblin:{prestige:2,trust:3,influence:3,stamina:5,hp:4,ether:4,agility:8},dwarf:{prestige:5,trust:6,influence:4,stamina:8,hp:7,ether:3,agility:3},dragon_tongue:{prestige:7,trust:4,influence:6,stamina:4,hp:5,ether:9,agility:4}},Ds={warrior:{prestige:1,trust:0,influence:0,stamina:2,hp:4,ether:-2,agility:1},rogue:{prestige:0,trust:-1,influence:0,stamina:1,hp:0,ether:0,agility:5},ranger:{prestige:0,trust:1,influence:0,stamina:2,hp:1,ether:1,agility:3},paladin:{prestige:2,trust:2,influence:1,stamina:1,hp:3,ether:1,agility:-1},mercenary:{prestige:1,trust:0,influence:0,stamina:2,hp:3,ether:-1,agility:1},mage:{prestige:1,trust:0,influence:1,stamina:-1,hp:-2,ether:6,agility:0},cleric:{prestige:1,trust:3,influence:1,stamina:0,hp:1,ether:3,agility:0},druid:{prestige:0,trust:2,influence:0,stamina:2,hp:0,ether:4,agility:1},scout:{prestige:0,trust:0,influence:0,stamina:2,hp:0,ether:0,agility:4},merchant:{prestige:2,trust:2,influence:3,stamina:0,hp:-1,ether:0,agility:0},artisan:{prestige:1,trust:3,influence:1,stamina:1,hp:0,ether:1,agility:0},scholar:{prestige:1,trust:1,influence:1,stamina:-1,hp:-1,ether:4,agility:0},mechanist:{prestige:1,trust:1,influence:1,stamina:0,hp:0,ether:3,agility:1}},Ls={warrior:[{icon:"ðŸ›¡ï¸",text:"Shield Wall: +25% damage reduction when HP below 50%"},{icon:"ðŸ’ª",text:"Battle Hardened: Start with Combat skill at 5"}],rogue:[{icon:"ðŸ—ï¸",text:"Lockpick: Can access locked areas and containers"},{icon:"ðŸŽ¯",text:"Backstab: First attack in combat deals double damage"}],ranger:[{icon:"ðŸ•ï¸",text:"Survivalist: -50% stamina cost when traveling"},{icon:"ðŸ¦…",text:"Eagle Eye: Discover nearby POIs automatically"}],paladin:[{icon:"âœ¨",text:"Divine Protection: Immune to curses and dark magic"},{icon:"ðŸ’›",text:"Lay on Hands: Can heal party members using Ether"}],mercenary:[{icon:"ðŸ’°",text:"Negotiator: +20% gold from combat and quests"},{icon:"âš”ï¸",text:"Weapon Master: Start with Combat skill at 3"}],mage:[{icon:"ðŸ“–",text:"Arcane Study: +50% Ether regeneration rate"},{icon:"ðŸ”¥",text:"Elemental Mastery: Unlock elemental spells earlier"}],cleric:[{icon:"ðŸ™",text:"Blessing: Party members gain +10% to all yields"},{icon:"ðŸ’š",text:"Healing Aura: Slowly regenerate HP while resting"}],druid:[{icon:"ðŸŒ²",text:"Nature's Bounty: +50% resources from gathering"},{icon:"ðŸº",text:"Animal Companion: Start with a loyal wolf companion"}],scout:[{icon:"ðŸ—ºï¸",text:"Pathfinder: -30% travel time on roads"},{icon:"ðŸ‘ï¸",text:"Keen Senses: Spot ambushes and hidden dangers"}],merchant:[{icon:"ðŸ“ˆ",text:"Trade Routes: +30% profit from buying/selling"},{icon:"ðŸ¤",text:"Connections: Start with 100 extra gold"}],artisan:[{icon:"âš’ï¸",text:"Master Crafter: +25% quality on crafted items"},{icon:"ðŸ”§",text:"Efficient: -20% material cost for crafting"}],scholar:[{icon:"ðŸ“š",text:"Quick Learner: +50% experience from all sources"},{icon:"ðŸ”",text:"Lore Master: Identify rare items and artifacts"}],mechanist:[{icon:"âš™ï¸",text:"Tinkerer: Can repair and upgrade equipment"},{icon:"ðŸ¤–",text:"Automaton: Build mechanical helpers for tasks"}]};class Bs{constructor(){this.selectedRace="human",this.selectedClass="warrior",this.selectedSpawnType="settlement",this.gameStarted=!1,this.previewGrid=null,this.previewPois=[],this.previewRoads=[],this.previewRivers=[],this.previewSeed=null,this.music=new ys,this.stepSounds=[new Audio("step1.mp3"),new Audio("step2.mp3")],this.stepSounds.forEach(e=>{e.volume=.3}),this.currentDungeon=null,this.dungeonGenerator=null,this.inDungeon=!1,this.worldGrid=null,this.worldPois=null,this.worldRoads=null,this.worldRivers=null,this.currentDungeonEnemy=null,this.progressTweens=new Map,this.progressBarCache=new Map,this.lastTweenTime=0,this.startProgressTweenLoop(),this.bindTitleScreenEvents(),this.bindMenuEvents(),this.updateStatsPreview(),this.checkExistingSave(),this.initPreview(),this.initMusicOnInteraction()}initMusicOnInteraction(){const e=()=>{this.music.playMenuMusic(!0),document.removeEventListener("click",e),document.removeEventListener("keydown",e)};document.addEventListener("click",e,{once:!0}),document.addEventListener("keydown",e,{once:!0})}startProgressTweenLoop(){const e=t=>{this.lastTweenTime||(this.lastTweenTime=t);const i=(t-this.lastTweenTime)/1e3;this.lastTweenTime=t,this.updateProgressTweens(i),requestAnimationFrame(e)};requestAnimationFrame(e)}getTweenedProgress(e){const t=this.progressTweens.get(e);return t?t.current:null}syncProgressBarsToTweens(){for(const[e,t]of this.progressTweens){const i=Math.min(100,t.current/t.required*100);document.querySelectorAll(`[data-task-progress="${e}"]`).forEach(a=>{a.style.transition="none",a.style.width=`${i}%`})}}updateProgressTweens(e){var s;if(!((s=this.townActions)!=null&&s.citizenAssignedTasks)||!this.gameStarted)return;const t=[...this.townActions.citizenAssignedTasks.keys()];for(const a of t){if(!this.townActions.citizenAssignedTasks.has(a))continue;const n=this.townActions.calculateRealTimeProgress(a,this.citizens);if(!n)continue;const{progress:r,required:o}=n;if(!this.progressTweens.has(a))this.progressTweens.set(a,{current:r,required:o});else{const l=this.progressTweens.get(a);l.current=r,l.required=o}}let i=!1;for(const[a]of this.progressTweens)this.townActions.citizenAssignedTasks.has(a)||(this.progressTweens.delete(a),this.progressBarCache.delete(a),i=!0);i&&this.refreshOpenModalContent();for(const[a,n]of this.progressTweens){const r=Math.min(100,n.current/n.required*100);let o=this.progressBarCache.get(a);o&&o.length>0&&o[0].isConnected||(o=document.querySelectorAll(`[data-task-progress="${a}"]`),o.length>0?this.progressBarCache.set(a,o):this.progressBarCache.delete(a)),o.forEach(u=>{u.style.transition="none",u.style.width=`${r}%`});const c=document.querySelectorAll(`[data-task-progress-text="${a}"]`),d=`${Math.round(r)}%`;c.forEach(u=>{u.textContent!==d&&(u.textContent=d)})}this.updateTaskQueue()}updateTaskQueue(){var n,r,o;const e=document.getElementById("task-queue-items");if(!e)return;const t=new Set;if((n=this.townActions)!=null&&n.citizenAssignedTasks)for(const[l]of this.townActions.citizenAssignedTasks)t.add(l);const i=((o=(r=this.townActions)==null?void 0:r.getAcceptedTasksByCategory)==null?void 0:o.call(r,"townBoard"))||[];for(const l of i)l.type==="build"&&l.requirements&&t.add(l.id);const s=new Set(Array.from(e.querySelectorAll(".task-queue-item")).map(l=>l.dataset.taskId)),a=t.size!==s.size||[...t].some(l=>!s.has(l));if(t.size===0){e.innerHTML!==""&&(e.innerHTML="");return}a?this.rebuildTaskQueue(e):(this.updateTaskQueueProgress(e),this.updateBuildTaskProgress(e))}rebuildTaskQueue(e){var a,n,r,o,l,c,d,u;const t=[];for(const[h,m]of this.townActions.citizenAssignedTasks){const g=(a=this.townActions.acceptedTasks)==null?void 0:a.find(b=>b.id===h);if(!g)continue;const y=((r=(n=this.citizens)==null?void 0:n.getCitizenByUid)==null?void 0:r.call(n,m.citizenUid))||((l=(o=this.citizens)==null?void 0:o.getCitizen)==null?void 0:l.call(o,m.citizenUid));if(!y)continue;const f=this.progressTweens.get(h),p=f?f.current:m.progress||0,v=((c=g.objective)==null?void 0:c.required)||1;t.push({taskId:h,task:g,citizen:y,current:p,required:v,isBuildTask:!1})}const i=((u=(d=this.townActions).getAcceptedTasksByCategory)==null?void 0:u.call(d,"townBoard"))||[];for(const h of i)t.some(m=>m.taskId===h.id)||h.type==="build"&&h.requirements&&t.push({taskId:h.id,task:h,citizen:null,current:0,required:1,isBuildTask:!0,requirements:h.requirements});const s=t.map(({taskId:h,task:m,citizen:g,current:y,required:f,isBuildTask:p,requirements:v})=>{const b=m.category==="volunteer"?"volunteer":m.category==="townBoard"?"townboard":"";if(p&&v){const k=this.calculateBuildTaskProgress(v),w=k.percent>=100;return`
                    <div class="task-queue-item ${b} build-task ${w?"ready":""}" data-task-id="${h}">
                        <span class="task-queue-icon">${m.icon||"ðŸ—ï¸"}</span>
                        <div class="task-queue-info">
                            <div class="task-queue-name">${m.name}</div>
                            <div class="task-queue-resources">
                                ${k.items.map(x=>`
                                    <span class="resource-item ${x.complete?"complete":""}">
                                        ${x.have}/${x.need} ${x.name}
                                    </span>
                                `).join("")}
                            </div>
                            ${w?`
                                <button class="task-queue-complete-btn" data-task-id="${h}">âœ“ Complete</button>
                            `:`
                                <div class="task-queue-progress-bar">
                                    <div class="fill build" style="width:${k.percent}%"></div>
                                </div>
                                <div class="task-queue-progress-text">${Math.round(k.percent)}%</div>
                            `}
                        </div>
                    </div>
                `}else{const k=Math.min(100,y/f*100);return`
                    <div class="task-queue-item ${b}" data-task-id="${h}">
                        <span class="task-queue-icon">${m.icon||"ðŸ“‹"}</span>
                        <div class="task-queue-info">
                            <div class="task-queue-name">${m.name}</div>
                            <div class="task-queue-worker">
                                <span class="task-queue-worker-icon">${g.icon}</span>
                                ${g.name}
                            </div>
                            <div class="task-queue-progress-bar">
                                <div class="fill" data-task-progress="${h}" style="width:${k}%"></div>
                            </div>
                            <div class="task-queue-progress-text" data-task-progress-text="${h}">${Math.round(k)}%</div>
                        </div>
                    </div>
                `}}).join("");e.innerHTML=s,e.querySelectorAll(".task-queue-complete-btn").forEach(h=>{h.addEventListener("click",m=>{m.stopPropagation();const g=h.dataset.taskId;this.completeBuildTaskFromQueue(g)})}),this.progressBarCache.clear()}calculateBuildTaskProgress(e){var n,r;const t=[];let i=0,s=0;for(const[o,l]of Object.entries(e)){const c=((r=(n=this.inventory)==null?void 0:n.count)==null?void 0:r.call(n,o))||0,d=Math.min(c,l);t.push({name:o,need:l,have:d,complete:d>=l}),i+=l,s+=d}const a=i>0?s/i*100:0;return{items:t,percent:a}}updateTaskQueueProgress(e){for(const[t,i]of this.progressTweens){const s=e.querySelector(`[data-task-progress-text="${t}"]`);if(s){const a=Math.min(100,i.current/i.required*100),n=`${Math.round(a)}%`;s.textContent!==n&&(s.textContent=n)}}}updateBuildTaskProgress(e){var i,s;const t=e.querySelectorAll(".task-queue-item.build-task");for(const a of t){const n=a.dataset.taskId,r=(s=(i=this.townActions)==null?void 0:i.getTaskById)==null?void 0:s.call(i,n);if(!r||!r.requirements)continue;const o=this.calculateBuildTaskProgress(r.requirements),l=o.percent>=100,c=a.querySelector(".task-queue-resources");if(c){const h=o.items.map(m=>`
                    <span class="resource-item ${m.complete?"complete":""}">
                        ${m.have}/${m.need} ${m.name}
                    </span>
                `).join("");c.innerHTML!==h&&(c.innerHTML=h)}const d=a.querySelector(".task-queue-complete-btn"),u=a.querySelector(".task-queue-progress-bar");if(l&&!d){a.classList.add("ready");const h=a.querySelector(".task-queue-info");if(h&&u){const m=h.querySelector(".task-queue-progress-bar"),g=h.querySelector(".task-queue-progress-text");m&&m.remove(),g&&g.remove();const y=document.createElement("button");y.className="task-queue-complete-btn",y.dataset.taskId=n,y.textContent="âœ“ Complete",y.addEventListener("click",f=>{f.stopPropagation(),this.completeBuildTaskFromQueue(n)}),h.appendChild(y)}}else if(!l&&d){a.classList.remove("ready"),d.remove();const h=a.querySelector(".task-queue-info");if(h){const m=`
                        <div class="task-queue-progress-bar">
                            <div class="fill build" style="width:${o.percent}%"></div>
                        </div>
                        <div class="task-queue-progress-text">${Math.round(o.percent)}%</div>
                    `;h.insertAdjacentHTML("beforeend",m)}}else if(!l){const h=a.querySelector(".task-queue-progress-bar .fill");if(h){const g=`${o.percent}%`;h.style.width!==g&&(h.style.width=g)}const m=a.querySelector(".task-queue-progress-text");if(m){const g=`${Math.round(o.percent)}%`;m.textContent!==g&&(m.textContent=g)}}}}completeBuildTaskFromQueue(e){if(!this.townActions||!this.inventory)return;this.townActions.completeBuildTask(e,this.inventory)&&($.playSuccess(),this.updateTaskQueue(),this.currentTownCardView==="townBoard"&&this.updateTownCard("townBoard"))}checkExistingSave(){const t=new ue().getSaveInfo();this.hasSavedGame=t.exists;const i=document.getElementById("title-continue");t.exists&&i&&i.classList.remove("hidden");const s=document.getElementById("continue-game-btn");if(t.exists&&s){s.classList.remove("hidden");const a=t.savedAt?new Date(t.savedAt):null;a&&a.toLocaleString();const n=t.playerName?`${t.playerName} Lv.${t.playerLevel}`:"",r=t.day?`Day ${t.day}`:"";let o=[n,r].filter(Boolean).join(" - ");o&&(s.innerHTML=`Continue Journey<span class="save-info">${o}</span>`)}}initPreview(){this.previewWorldGen=new Ye,this.previewSeed=this.previewWorldGen.seed;const e=120,t=120,i=10;this.previewGrid=new He(e,t,i),this.generatePreviewWorld(),this.renderPreview()}generatePreviewWorld(){this.previewGrid.generate(),this.previewWorldGen.generate(this.previewGrid,{elevationScale:.02,moistureScale:.03,elevationOctaves:6,moistureOctaves:4,islandFactor:.5,redistributePower:1,continentScale:.008});const e=new bt(this.previewWorldGen.seed);this.previewRivers=e.generate(this.previewGrid,{riverCount:6,minLength:12,maxLength:50,startElevation:.7,meanderStrength:.5});const t=new yt(this.previewWorldGen.seed);this.previewPois=t.generate(this.previewGrid,{density:1.2,maxPOIs:150});const i=new vt;this.previewRoads=i.generate(this.previewGrid,this.previewPois,{connectSettlements:!0,connectToLandmarks:!0,maxRoadLength:45}),document.getElementById("world-seed-input").value=this.previewSeed}renderPreview(){const e=document.getElementById("map-preview");if(!e)return;const i=e.parentElement.getBoundingClientRect(),s=window.devicePixelRatio||1;e.width=i.width*s,e.height=i.height*s,e.style.width=i.width+"px",e.style.height=i.height+"px";const a=e.getContext("2d");a.scale(s,s);const n=this.previewGrid.getPixelBounds(),r=n.width,o=n.height,l=i.width/r,c=i.height/o,d=Math.min(l,c)*.85,u=(i.width-r*d)/2-n.minX*d,h=(i.height-o*d)/2-n.minY*d;a.fillStyle="#1a1a1a",a.fillRect(0,0,i.width,i.height),a.save(),a.translate(u,h),a.scale(d,d);for(const m of this.previewGrid.cells.values()){if(!m.biome)continue;const g=this.previewGrid.hexToPixel(m.q,m.r),y=this.getHexCorners(g.x,g.y,this.previewGrid.hexSize);a.beginPath(),a.moveTo(y[0].x,y[0].y);for(let f=1;f<6;f++)a.lineTo(y[f].x,y[f].y);a.closePath(),a.fillStyle=m.biome.color,a.fill()}for(const m of this.previewPois){const g=this.previewGrid.hexToPixel(m.q,m.r),y=m.type.category==="settlement"?8:5;a.beginPath(),a.arc(g.x,g.y,y,0,Math.PI*2),a.fillStyle=m.type.category==="settlement"?"#e8d4c4":"#a08060",a.fill()}a.restore()}getHexCorners(e,t,i){const s=[];for(let a=0;a<6;a++){const n=Math.PI/180*(60*a);s.push({x:e+i*Math.cos(n),y:t+i*Math.sin(n)})}return s}rerollWorld(){this.previewWorldGen.regenerate(this.previewGrid,{elevationScale:.02,moistureScale:.03,elevationOctaves:6,moistureOctaves:4,islandFactor:.5,redistributePower:1,continentScale:.008}),this.previewSeed=this.previewWorldGen.seed;const e=new bt(this.previewSeed);this.previewRivers=e.generate(this.previewGrid,{riverCount:6,minLength:12,maxLength:50,startElevation:.7,meanderStrength:.5});const t=new yt(this.previewSeed);this.previewPois=t.generate(this.previewGrid,{density:1.2,maxPOIs:150});const i=new vt;this.previewRoads=i.generate(this.previewGrid,this.previewPois,{connectSettlements:!0,connectToLandmarks:!0,maxRoadLength:45}),document.getElementById("world-seed-input").value=this.previewSeed,this.renderPreview()}calculateStats(){const e=Rs[this.selectedRace],t=Ds[this.selectedClass],i={};for(const s of Object.keys(e))i[s]=Math.max(1,e[s]+t[s]);return i}updateStatsPreview(){const e=this.calculateStats();for(const[s,a]of Object.entries(e)){const n=document.getElementById(`preview-${s}`);n&&(n.textContent=a)}const t=Ls[this.selectedClass]||[],i=document.getElementById("class-perks");i&&(i.innerHTML=t.map(s=>`
                <div class="perk-item">
                    <span class="perk-icon">${s.icon}</span>
                    <span class="perk-text">${s.text}</span>
                </div>
            `).join(""))}bindTitleScreenEvents(){const e=document.getElementById("title-screen"),t=document.getElementById("main-menu");document.getElementById("title-new-game").addEventListener("click",()=>{e.classList.add("hidden"),t.classList.remove("hidden"),this.renderPreview()}),document.getElementById("title-continue").addEventListener("click",()=>{this.hasSavedGame&&(e.classList.add("hidden"),this.loadGame())}),document.getElementById("title-settings").addEventListener("click",()=>{alert("Settings coming soon!")}),document.getElementById("title-lexicon").addEventListener("click",()=>{this.showTitleScreenLexicon()}),document.getElementById("back-to-title").addEventListener("click",()=>{t.classList.add("hidden"),e.classList.remove("hidden")})}bindMenuEvents(){document.querySelectorAll(".race-btn").forEach(s=>{s.addEventListener("click",()=>{document.querySelectorAll(".race-btn").forEach(a=>a.classList.remove("selected")),s.classList.add("selected"),this.selectedRace=s.dataset.race,this.updateStatsPreview()})}),document.querySelectorAll(".class-btn").forEach(s=>{s.addEventListener("click",()=>{document.querySelectorAll(".class-btn").forEach(a=>a.classList.remove("selected")),s.classList.add("selected"),this.selectedClass=s.dataset.class,this.updateStatsPreview()})}),document.getElementById("start-game-btn").addEventListener("click",()=>{this.validateForm()&&this.startGame()});const t=document.getElementById("continue-game-btn");t&&t.addEventListener("click",()=>{this.loadGame()}),document.getElementById("char-name").addEventListener("input",()=>{this.updateStartButton()}),this.updateStartButton(),document.getElementById("reroll-world-btn").addEventListener("click",()=>{this.rerollWorld()}),document.getElementById("apply-seed-btn").addEventListener("click",()=>{this.applySeed()}),document.getElementById("world-seed-input").addEventListener("keypress",s=>{s.key==="Enter"&&this.applySeed()})}applySeed(){const t=document.getElementById("world-seed-input").value.trim();if(!t)return;let i;if(/^\d+$/.test(t))i=parseInt(t);else{i=0;for(let s=0;s<t.length;s++)i=(i<<5)-i+t.charCodeAt(s),i=i&i;i=Math.abs(i)%65536}this.previewWorldGen=new Ye(i),this.previewSeed=this.previewWorldGen.seed,this.previewGrid=new He(120,120,10),this.generatePreviewWorld(),document.getElementById("world-seed-input").value=this.previewSeed,this.renderPreview()}validateForm(){return document.getElementById("char-name").value.trim()?!0:(document.getElementById("char-name").classList.add("invalid"),document.getElementById("char-name").focus(),!1)}updateStartButton(){const e=document.getElementById("char-name").value.trim(),t=document.getElementById("start-game-btn"),i=document.getElementById("char-name");e?(t.disabled=!1,t.textContent="Begin Journey",i.classList.remove("invalid")):(t.disabled=!0,t.textContent="Enter Name to Begin")}async startGame(){var o;if(this.gameStarted)return;this.gameStarted=!0;const e=document.getElementById("char-name").value.trim()||"Unnamed Citizen",t=document.getElementById("guild-selection").value;document.getElementById("main-menu").classList.add("hidden"),document.getElementById("game-container").classList.remove("hidden"),this.music.transitionToGameplay(6),this.music.ensureCorrectMusic(),this.canvas=document.getElementById("game-canvas"),this.renderer=new gt(this.canvas),await this.renderer.loadIcons(),await this.renderer.loadTerrainTileset(),this.particleCanvas=document.getElementById("particle-canvas"),this.particles=new Yt(this.particleCanvas),this.setupParticleCanvas(),this.worldMinimapCanvas=document.getElementById("world-minimap-canvas"),this.worldMinimapCtx=(o=this.worldMinimapCanvas)==null?void 0:o.getContext("2d"),this.worldMinimapContainer=document.getElementById("world-minimap"),this.biomeAudio=new Xt,this.biomeAudio.init(),this.gridWidth=120,this.gridHeight=120,this.hexSize=10,this.grid=this.previewGrid,this.hexActions&&this.hexActions.setGrid(this.grid),this.worldGen=this.previewWorldGen,this.pois=this.previewPois,this.roads=this.previewRoads,this.rivers=this.previewRivers,this.state=new ue,this.state.worldSeed=this.previewSeed,this.state.pois=this.pois,this.gameLoop=new wt(this.state),this.state.player.name=e,this.state.player.race=this.selectedRace,this.state.player.class=this.selectedClass;const i=this.calculateStats();Object.assign(this.state.player.attributes,i),this.state.player.maxHealth=30+i.hp*8,this.state.player.health=this.state.player.maxHealth,this.state.player.maxStamina=40+i.stamina*8,this.state.player.stamina=this.state.player.maxStamina,this.state.player.maxEther=20+i.ether*6,this.state.player.ether=this.state.player.maxEther,this.selectedClass==="merchant"?this.state.player.gold+=30:this.selectedClass==="scout"?this.state.player.skills.survival=3:this.selectedClass==="artisan"&&(this.state.player.skills.crafting=3),t!=="none"&&(this.state.guild.unlocked=!0,this.state.guild.name={merchants:"Merchant's Coalition",explorers:"Explorer's League",artisans:"Artisan's Circle",mercenaries:"Iron Company"}[t],this.state.player.gold+=t==="merchants"?50:20),this.tooltip=document.getElementById("tooltip"),this.hoveredPOI=null,this.ui={timeDisplay:document.getElementById("time-display"),timePeriod:document.getElementById("time-period"),playerName:document.getElementById("player-name"),playerLevel:document.getElementById("player-level"),playerRace:document.getElementById("player-race"),playerLocation:document.getElementById("player-location"),playerStatus:document.getElementById("player-status"),conditionsDisplay:document.getElementById("conditions-display"),healthBar:document.getElementById("health-bar"),healthText:document.getElementById("health-text"),staminaBar:document.getElementById("stamina-bar"),staminaText:document.getElementById("stamina-text"),playerGold:document.getElementById("player-gold"),etherBar:document.getElementById("ether-bar"),etherText:document.getElementById("ether-text"),xpBar:document.getElementById("xp-bar"),xpText:document.getElementById("xp-text"),attrTrust:document.getElementById("attr-trust"),attrPrestige:document.getElementById("attr-prestige"),attrInfluence:document.getElementById("attr-influence"),attrAgility:document.getElementById("attr-agility"),alignmentTier:document.getElementById("alignment-tier"),alignmentMarker:document.getElementById("alignment-marker"),restBtn:document.getElementById("rest-btn"),tentBtn:document.getElementById("tent-btn"),waitBtn:document.getElementById("wait-btn"),logEntries:document.getElementById("log-entries"),townActions:document.getElementById("town-actions"),activityActions:document.getElementById("activity-actions"),serviceActions:document.getElementById("service-actions"),wildernessActions:document.getElementById("wilderness-actions"),actionProgress:document.getElementById("action-progress"),progressActionName:document.getElementById("progress-action-name"),progressPercent:document.getElementById("progress-percent"),progressFill:document.getElementById("progress-fill"),cancelActionBtn:document.getElementById("cancel-action-btn"),hexMenu:document.getElementById("hex-menu"),hexMenuBiome:document.getElementById("hex-menu-biome"),hexMenuActions:document.getElementById("hex-menu-actions"),hexMenuClose:document.getElementById("hex-menu-close"),hexOverlay:document.getElementById("hex-overlay"),hexProgressFill:document.getElementById("hex-progress-fill"),hexProgressIcon:document.getElementById("hex-progress-icon"),hexProgressText:document.getElementById("hex-progress-text"),inventoryWeight:document.getElementById("inventory-weight"),inventoryItems:document.getElementById("inventory-items"),gameModal:document.getElementById("game-modal"),modalTitle:document.getElementById("modal-title"),modalBody:document.getElementById("modal-body"),modalClose:document.getElementById("modal-close"),compass:document.getElementById("compass"),compassArrow:document.getElementById("compass-arrow"),compassIcon:document.getElementById("compass-icon"),compassName:document.getElementById("compass-name"),compassDistance:document.getElementById("compass-distance")},this.compassState={currentTargetIndex:0,targets:[]},this.inventory=new Et(this.state),this.state.inventory=this.inventory;const s=$t[this.selectedClass]||$t.mercenary;for(const{itemId:l,quantity:c}of s)this.inventory.add(l,c);if(this.state.addLog("You packed your survival gear.","info"),this.citizens=new je(this.state),this.citizenManager=this.citizens,this.state.citizens=this.citizens,this.guilds=new Ht(this.state),this.state.guilds=this.guilds,this.cults=new Nt(this.state,this.guilds),this.state.cults=this.cults,this.state.guild.name){const c={"Merchant's Coalition":"merchants","Explorer's League":"explorers","Artisan's Circle":"artisans","Iron Company":"mercenaries"}[this.state.guild.name];c&&this.guilds.join(c)}this.townActions=new Ct(this.state,this.gameLoop),this.state.townActions=this.townActions,this.townEconomy=new At(this.state),this.state.townEconomy=this.townEconomy,this.hexActions=new qt(this.state,this.gameLoop,this.grid),this.hexActions.onActionComplete=()=>this.processEnemyTurn(),this.selectedHex=null,this.travel=new zt(this.state,this.grid,this.pois),this.state.travel=this.travel,this.quests=new jt(this.state,this.pois),this.quests.setCitizenManager(this.citizenManager),this.state.quests=this.quests,window.QUEST_TEMPLATES=B,this.encounters=new Vt(this.state),this.state.encounters=this.encounters,this.encounters.onDungeonCombatEnd=l=>this.onDungeonCombatEnd(l),this.encounters.onBanditAmbushEnd=(l,c,d,u)=>this.onBanditAmbushEnd(l,c,d,u),this.encounters.onCombatEvent=(l,c)=>this.handleCombatEvent(l,c),this.auraSystem=new ti(this.state,this.grid);const a=l=>{let c=Math.floor(l)||1;return()=>(c=c*16807%2147483647,(c-1)/2147483646)},n=this.state.worldSeed!==null?a(this.state.worldSeed+5e3):null;this.auraSystem.initFromPOIs(this.pois,n),this.state.auraSystem=this.auraSystem,this.overworldCorruption=new Jt(this.state,this.grid),this.overworldCorruption.initFromPOIs(this.pois),this.state.overworldCorruption=this.overworldCorruption,this.overworldCorruption.onCorruptionDeath=()=>this.handleCorruptionDeath(),this.encounters.onOverworldCombatEnd=(l,c)=>{if(this.auraSystem&&!this.inDungeon){const d=this.state.player.position;d&&this.auraSystem.applyPostCombatConditions(d.q,d.r)}if(l&&c){const d=c.enemies||(c.enemy?[c.enemy]:[]);for(const u of d)u&&u.id&&this.triggerCreatureLexicon(u.id)}},this.lexicon=new tt(this.state),this.state.lexicon=this.lexicon;try{const l=localStorage.getItem("etherground_save");if(l){const c=JSON.parse(l);c.lexiconData&&this.lexicon.fromJSON(c.lexiconData)}}catch{console.log("No preserved lexicon data")}const r=document.getElementById("debug-midgame-checkbox");(r!=null&&r.checked||ot)&&(at(!0),setTimeout(()=>{li(this)},100)),this.init()}async loadGame(){var n;if(this.gameStarted)return;this.gameStarted=!0,document.getElementById("main-menu").classList.add("hidden"),document.getElementById("game-container").classList.remove("hidden"),this.music.transitionToGameplay(6),this.music.ensureCorrectMusic(),this.canvas=document.getElementById("game-canvas"),this.renderer=new gt(this.canvas),await this.renderer.loadIcons(),await this.renderer.loadTerrainTileset(),this.particleCanvas=document.getElementById("particle-canvas"),this.particles=new Yt(this.particleCanvas),this.setupParticleCanvas(),this.worldMinimapCanvas=document.getElementById("world-minimap-canvas"),this.worldMinimapCtx=(n=this.worldMinimapCanvas)==null?void 0:n.getContext("2d"),this.worldMinimapContainer=document.getElementById("world-minimap"),this.biomeAudio=new Xt,this.biomeAudio.init(),this.gridWidth=120,this.gridHeight=120,this.hexSize=10;const t=new ue().getSaveInfo();if(t.worldSeed&&(this.previewWorldGen=new Ye(t.worldSeed),this.previewSeed=t.worldSeed,this.previewGrid=new He(this.gridWidth,this.gridHeight,this.hexSize),this.generatePreviewWorld()),this.grid=this.previewGrid,this.hexActions&&this.hexActions.setGrid(this.grid),this.worldGen=this.previewWorldGen,this.pois=this.previewPois,this.roads=this.previewRoads,this.rivers=this.previewRivers,this.state=new ue,this.state.pois=this.pois,this.gameLoop=new wt(this.state),!this.state.load()){console.log("Save incompatible or corrupted, preserving lexicon and returning to title"),this.state.deleteSave(),this.gameStarted=!1,location.reload();return}this.state.migrateSettlementData(),this.tooltip=document.getElementById("tooltip"),this.hoveredPOI=null,this.ui={timeDisplay:document.getElementById("time-display"),timePeriod:document.getElementById("time-period"),playerName:document.getElementById("player-name"),playerLevel:document.getElementById("player-level"),playerRace:document.getElementById("player-race"),playerLocation:document.getElementById("player-location"),playerStatus:document.getElementById("player-status"),conditionsDisplay:document.getElementById("conditions-display"),healthBar:document.getElementById("health-bar"),healthText:document.getElementById("health-text"),staminaBar:document.getElementById("stamina-bar"),staminaText:document.getElementById("stamina-text"),playerGold:document.getElementById("player-gold"),etherBar:document.getElementById("ether-bar"),etherText:document.getElementById("ether-text"),xpBar:document.getElementById("xp-bar"),xpText:document.getElementById("xp-text"),attrTrust:document.getElementById("attr-trust"),attrPrestige:document.getElementById("attr-prestige"),attrInfluence:document.getElementById("attr-influence"),attrAgility:document.getElementById("attr-agility"),alignmentTier:document.getElementById("alignment-tier"),alignmentMarker:document.getElementById("alignment-marker"),restBtn:document.getElementById("rest-btn"),tentBtn:document.getElementById("tent-btn"),waitBtn:document.getElementById("wait-btn"),logEntries:document.getElementById("log-entries"),townActions:document.getElementById("town-actions"),activityActions:document.getElementById("activity-actions"),serviceActions:document.getElementById("service-actions"),wildernessActions:document.getElementById("wilderness-actions"),actionProgress:document.getElementById("action-progress"),progressActionName:document.getElementById("progress-action-name"),progressPercent:document.getElementById("progress-percent"),progressFill:document.getElementById("progress-fill"),cancelActionBtn:document.getElementById("cancel-action-btn"),hexMenu:document.getElementById("hex-menu"),hexMenuBiome:document.getElementById("hex-menu-biome"),hexMenuActions:document.getElementById("hex-menu-actions"),hexMenuClose:document.getElementById("hex-menu-close"),hexOverlay:document.getElementById("hex-overlay"),hexProgressFill:document.getElementById("hex-progress-fill"),hexProgressIcon:document.getElementById("hex-progress-icon"),hexProgressText:document.getElementById("hex-progress-text"),inventoryWeight:document.getElementById("inventory-weight"),inventoryItems:document.getElementById("inventory-items"),gameModal:document.getElementById("game-modal"),modalTitle:document.getElementById("modal-title"),modalBody:document.getElementById("modal-body"),modalClose:document.getElementById("modal-close"),compass:document.getElementById("compass"),compassArrow:document.getElementById("compass-arrow"),compassIcon:document.getElementById("compass-icon"),compassName:document.getElementById("compass-name"),compassDistance:document.getElementById("compass-distance")},this.compassState={currentTargetIndex:0,targets:[]},this.inventory=new Et(this.state),this.state.inventory=this.inventory,this.state._savedInventoryData&&(this.inventory.fromJSON(this.state._savedInventoryData),this.state._savedInventoryData=null),this.citizens=new je(this.state),this.citizenManager=this.citizens,this.state.citizens=this.citizens,this.state._savedCitizensData&&(this.citizens.fromJSON(this.state._savedCitizensData),this.state._savedCitizensData=null),this.guilds=new Ht(this.state),this.state.guilds=this.guilds,this.state._savedGuildsData&&(this.guilds.fromJSON(this.state._savedGuildsData),this.state._savedGuildsData=null),this.cults=new Nt(this.state,this.guilds),this.state.cults=this.cults,this.townActions=new Ct(this.state,this.gameLoop),this.state.townActions=this.townActions,this.townEconomy=new At(this.state),this.state.townEconomy=this.townEconomy,this.state._savedCultData&&(this.cults.fromJSON(this.state._savedCultData),this.state._savedCultData=null),this.state._savedTownActionsData&&(this.townActions.fromJSON(this.state._savedTownActionsData),this.state._savedTownActionsData=null),this.state._savedTownEconomyData&&(this.townEconomy.fromJSON(this.state._savedTownEconomyData),this.state._savedTownEconomyData=null),this.state.stolenDelivery&&(this.stolenDelivery=this.state.stolenDelivery),this.hexActions=new qt(this.state,this.gameLoop,this.grid),this.hexActions.onActionComplete=()=>this.processEnemyTurn(),this.selectedHex=null,this.travel=new zt(this.state,this.grid,this.pois),this.state.travel=this.travel,this.quests=new jt(this.state,this.pois),this.quests.setCitizenManager(this.citizenManager),this.state.quests=this.quests,this.state._savedQuestsData&&(this.quests.fromJSON(this.state._savedQuestsData),this.state._savedQuestsData=null),window.QUEST_TEMPLATES=B,this.encounters=new Vt(this.state),this.state.encounters=this.encounters,this.encounters.onDungeonCombatEnd=r=>this.onDungeonCombatEnd(r),this.encounters.onBanditAmbushEnd=(r,o,l,c)=>this.onBanditAmbushEnd(r,o,l,c),this.encounters.onCombatEvent=(r,o)=>this.handleCombatEvent(r,o),this.auraSystem=new ti(this.state,this.grid);const s=r=>{let o=Math.floor(r)||1;return()=>(o=o*16807%2147483647,(o-1)/2147483646)},a=this.state.worldSeed!==null?s(this.state.worldSeed+5e3):null;this.auraSystem.initFromPOIs(this.pois,a),this.state.auraSystem=this.auraSystem,this.overworldCorruption=new Jt(this.state,this.grid),this.overworldCorruption.initFromPOIs(this.pois),this.state._savedOverworldCorruptionData&&this.overworldCorruption.fromJSON(this.state._savedOverworldCorruptionData),this.state.overworldCorruption=this.overworldCorruption,this.overworldCorruption.onCorruptionDeath=()=>this.handleCorruptionDeath(),this.encounters.onOverworldCombatEnd=(r,o)=>{if(this.auraSystem&&!this.inDungeon){const l=this.state.player.position;l&&this.auraSystem.applyPostCombatConditions(l.q,l.r)}if(r&&o){const l=o.enemies||(o.enemy?[o.enemy]:[]);for(const c of l)c&&c.id&&this.triggerCreatureLexicon(c.id)}},this.lexicon=new tt(this.state),this.state.lexiconData&&this.lexicon.fromJSON(this.state.lexiconData),this.state.lexicon=this.lexicon,this.init(!0)}init(e=!1){e?this.restorePlayerPosition():this.setupPlayer(),this.bindEvents(),this.bindUIEvents(),this.initTimeMode(),this.uiUpdatePending=!1,this.state.subscribe(()=>{this.uiUpdatePending||(this.uiUpdatePending=!0,requestAnimationFrame(()=>{this.updateUI(),this.uiUpdatePending=!1}))});let t=this.state.day,i=this.state.hour;if(this.gameLoop.onTick(s=>{if(this.citizens.processTick(),this.townActions.processCitizenTasks(this.citizens),s.tickConditions(),this.auraSystem&&!this.inDungeon&&this.auraSystem.tickInnerZoneEffects(),this.quests.checkProgress(),this.citizenManager&&!this.inDungeon&&(this.citizenManager.moveRoamingNPCs(this.grid),this.citizenManager.spawnRoamingNPCs(this.pois,this.grid)),s.hour!==i){const a=s.hour>=i?s.hour-i:24-i+s.hour;i=s.hour,this.townActions.updateTimeTasks(a)}s.day!==t&&(t=s.day,this.citizens.payWages(),this.citizens.processDailyStatus(),this.guilds.checkExpiredContracts(),this.guilds.decrementAlignmentLock(),this.quests.checkExpired(),this.quests.processScoutMissions(),this.townActions.clearExpiredTasks(),this.citizenManager&&this.citizenManager.processDayChange(),this.auraSystem&&this.auraSystem.dailyUpdate(),this.hexActions&&this.hexActions.propagateResources(),this.townEconomy&&this.townEconomy.processDailyEconomy(this.pois,s.day))}),e?this.state.addLog("Game loaded","info"):(this.state.addLog(`Welcome, ${this.state.player.name}`,"info"),this.state.guild.name&&this.state.addLog(`Guild: ${this.state.guild.name}`,"info")),this.updateUI(),this.updateLexiconBadges(),this.ui.compass&&!this.inDungeon&&(this.ui.compass.classList.remove("hidden"),this.updateCompass()),this.setupAutoSave(),this.setupMusicCheck(),this.encounters.spawnWorldEnemies(this.grid,this.maxPathLength),this.citizenManager){this.citizenManager.spawnRoamingNPCs(this.pois,this.grid,!0);const s=this.citizenManager.getRoamingNPCs();console.log("Spawned NPCs:",s.length,s.map(a=>`${a.name} at ${a.currentQ},${a.currentR}`))}this.render(),this.showIntroModal()}showIntroModal(){const e=[{title:"Welcome to the Realm",icon:"âš”ï¸",content:`
                    <p>You awaken in a land torn between <strong>order and chaos</strong>.</p>
                    <p><strong>Guilds</strong> seek to protect civilization, offering contracts, training, and purpose. Join their ranks to gain power through honor.</p>
                    <p><strong>Cults</strong> lurk in the shadows, their dark shrines emanating corruption. Some seek their forbidden power... at great cost.</p>
                    <p>The choice of which path to walk is yours alone.</p>
                `},{title:"Building Your Following",icon:"ðŸ‘¥",content:`
                    <p>As you travel, you'll encounter <strong>wandering NPCs</strong> who may join your cause.</p>
                    <p><strong>Hire citizens</strong> at settlements to expand your influence. Assign them to:</p>
                    <ul style="text-align: left; margin: 10px 40px;">
                        <li><strong>Gather</strong> - Collect resources automatically</li>
                        <li><strong>Guard</strong> - Protect locations from threats</li>
                        <li><strong>Trade</strong> - Generate income over time</li>
                    </ul>
                    <p>A strong following is key to surviving the challenges ahead.</p>
                `},{title:"Explore the Unknown",icon:"ðŸ—ºï¸",content:`
                    <p>The world is vast and filled with secrets.</p>
                    <p><strong>Dungeons</strong> hold treasures and dangers. <strong>Settlements</strong> offer rest and trade. <strong>Guild halls</strong> provide contracts and training.</p>
                    <p>Watch your <strong>stamina</strong> as you travel - roads are faster and safer. Rest when needed.</p>
                    <p>The <strong>compass</strong> at the bottom guides you to points of interest. Click it to cycle through targets.</p>
                    <p style="margin-top: 15px; color: #c4a84b;"><em>Good luck, traveler. May your journey be legendary.</em></p>
                `}];let t=0;const i=()=>{var o,l;const s=e[t],a=t===e.length-1,n=t===0,r=`
                <div class="intro-modal">
                    <div class="intro-page-indicator">
                        ${e.map((c,d)=>`<span class="intro-dot ${d===t?"active":""}"></span>`).join("")}
                    </div>
                    <div class="intro-icon">${s.icon}</div>
                    <div class="intro-content">
                        ${s.content}
                    </div>
                    <div class="intro-nav">
                        ${n?"<div></div>":'<button class="modal-btn intro-prev" id="intro-prev">â† Back</button>'}
                        <button class="modal-btn intro-next" id="intro-next">${a?"Begin Adventure":"Next â†’"}</button>
                    </div>
                </div>
            `;this.showModal(s.title,r,{uncloseable:!0}),(o=document.getElementById("intro-next"))==null||o.addEventListener("click",()=>{a?(this.forceHideModal(),this.isRealtimeMode=!0,this.updateTimeModeUI()):(t++,i())}),(l=document.getElementById("intro-prev"))==null||l.addEventListener("click",()=>{n||(t--,i())})};i()}restorePlayerPosition(){const e=this.state.player.position;if(e){const t=this.pois.find(i=>i.q===e.q&&i.r===e.r);this.state.player.currentPOI=t||null,this.renderer.centerOnHex(this.grid,e.q,e.r),this.playerFacingAngle=this.state.playerFacingAngle||0}else this.setupPlayer()}setupAutoSave(){this.autoSaveInterval=setInterval(()=>{var i;this.gameStarted&&!((i=this.encounters)!=null&&i.isInCombat())&&this.saveGame()},3e4);let e=null;this.state.subscribe(()=>{e&&clearTimeout(e),e=setTimeout(()=>{var i;this.gameStarted&&!((i=this.encounters)!=null&&i.isInCombat())&&this.saveGame()},5e3)});const t=()=>{this.gameStarted&&(this.state.playerFacingAngle=this.playerFacingAngle||0,this.state.stolenDelivery=this.stolenDelivery||null,this.state.save())};document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&t()}),window.addEventListener("pagehide",()=>{t()}),window.addEventListener("beforeunload",()=>{t()})}setupMusicCheck(){this.musicCheckInterval=setInterval(()=>{this.gameStarted&&this.music&&(this.music.isInDungeon=this.inDungeon||!1,this.music.ensureCorrectMusic())},5e3)}saveGame(){this.state.playerFacingAngle=this.playerFacingAngle||0,this.state.stolenDelivery=this.stolenDelivery||null,this.state.save()&&this.showSaveIndicator()}showSaveIndicator(){const e=document.getElementById("save-indicator");e&&(e.classList.add("visible"),setTimeout(()=>e.classList.remove("visible"),1500))}setupPlayer(){switch(this.selectedSpawnType||"dungeon"){case"dungeon":this.setupDungeonSpawn();break;case"wilderness":this.setupWildernessSpawn();break;case"settlement":this.setupSettlementSpawn();break;case"aura_zone":this.setupAuraZoneSpawn();break;default:this.setupAuraZoneSpawn()}this.playerFacingAngle=0,this.updateParticleBiome()}setupDungeonSpawn(){var t;const e=this.pois.filter(i=>["ruins","cave","keep","fortress"].includes(i.type.id));if(e.length===0){this.setupSettlementSpawn();return}try{const i=e[Math.floor(Math.random()*e.length)];this.worldGrid=this.grid,this.worldPois=this.pois,this.worldRoads=this.roads,this.worldRivers=this.rivers,this.worldPlayerPosition={q:i.q,r:i.r};const s=this.state.worldSeed+i.q*1e3+i.r;this.dungeonGenerator=new Gt(s),this.currentDungeon=this.dungeonGenerator.generate(i,1),this.inDungeon=!0,this.music&&(this.music.transitionToDungeon(),this.music.ensureCorrectMusic());const a=Math.min(2,this.currentDungeon.floors.length-1);this.currentDungeon.currentFloorIndex=a;for(const h of this.currentDungeon.floors)h.doors.clear();this.grid=this.currentDungeon.grid,this.hexActions&&this.hexActions.setGrid(this.grid),this.pois=[],this.roads=[],this.rivers=[];const n=this.currentDungeon.currentFloor,r=n.entrance,o=new Set,l=[`${r.q},${r.r}`];for(;l.length>0;){const h=l.pop();if(o.has(h))continue;const[m,g]=h.split(",").map(Number),y=this.grid.getCell(m,g);if(!y||(t=y.biome)!=null&&t.impassable)continue;o.add(h);const f=this.grid.getNeighbors(m,g);for(const p of f){const v=`${p.q},${p.r}`;o.has(v)||l.push(v)}}const c=[];for(const h of o)if(!n.enemies.has(h)&&!n.chests.has(h)){const[m,g]=h.split(",").map(Number);c.push({q:m,r:g})}const d=c.filter(h=>Math.abs(h.q-r.q)+Math.abs(h.r-r.r)>3),u=d.length>0?d[Math.floor(Math.random()*d.length)]:c[Math.floor(Math.random()*c.length)];u&&(this.currentDungeon.playerPosition={q:u.q,r:u.r},n.explored.add(`${u.q},${u.r}`),this.grid.getNeighbors(u.q,u.r).forEach(m=>n.explored.add(`${m.q},${m.r}`))),this.state.player.position={q:i.q,r:i.r},this.state.player.currentPOI=i,i.id&&this.state.discoverPOI(i.id,i),this.state.addLog("You awaken in darkness...","info"),this.state.addLog("Cold stone beneath you. The stench of decay in the air.","info"),this.state.addLog("You must find a way out.","warning"),u&&this.renderer.centerOnHex(this.grid,u.q,u.r)}catch(i){console.error("setupDungeonSpawn - Error:",i),this.setupSettlementSpawn()}}setupWildernessSpawn(){const e=this.pois.filter(s=>s.type.category==="guild"||s.type.category==="cult");if(e.length===0){this.setupSettlementSpawn();return}const t=e[Math.floor(Math.random()*e.length)],i=this.findNearbyWalkableHex(t.q,t.r,3,6);this.state.player.position=i,this.state.player.currentPOI=null,this.inDungeon=!1,t.type.category==="guild"?this.state.addLog(`You find yourself in the wilderness. A ${t.name} lies nearby.`,"info"):this.state.addLog("An uneasy feeling washes over you. Dark energy pulses nearby.","warning"),this.renderer.centerOnHex(this.grid,i.q,i.r)}setupSettlementSpawn(){const e=this.pois.filter(i=>i.type.category==="settlement"),t=e.find(i=>i.type.id==="village"||i.type.id==="town")||e[0];if(t)this.state.player.position={q:t.q,r:t.r},this.state.player.currentPOI=t,this.inDungeon=!1,this.state.initializeDiscoveredPOIs(this.pois,t),this.state.addLog(`You arrive at ${t.name}, ready to begin your journey.`,"info"),this.renderer.centerOnHex(this.grid,t.q,t.r);else{const i=this.findAnyLandHex();this.state.player.position=i,this.state.player.currentPOI=null,this.inDungeon=!1,this.state.addLog("You find yourself in an unknown land...","warning"),this.renderer.centerOnHex(this.grid,i.q,i.r)}}setupAuraZoneSpawn(){const e=this.pois.filter(s=>s.type.category==="cult");if(e.length===0){this.setupWildernessSpawn();return}const t=e[Math.floor(Math.random()*e.length)],i=this.findNearbyWalkableHex(t.q,t.r,2,4);this.state.player.position=i,this.state.player.currentPOI=null,this.inDungeon=!1,t.id&&this.state.discoverPOI(t.id,t),this.state.addLog("You awaken near a place of dark power...","warning"),this.state.addLog(`The air feels thick with corruption. A ${t.name} pulses with malevolent energy nearby.`,"info"),this.state.addLog("Something watches from the shadows.","danger"),this.renderer.centerOnHex(this.grid,i.q,i.r)}findNearbyWalkableHex(e,t,i,s){var n,r;const a=[];for(let o=-s;o<=s;o++)for(let l=-s;l<=s;l++){const c=e+o,d=t+l,u=this.hexDistance(e,t,c,d);if(u>=i&&u<=s){const h=this.grid.getCell(c,d);h&&!((n=h.biome)!=null&&n.impassable)&&h.elevation>=.42&&a.push({q:c,r:d})}}if(a.length===0)for(let o=-s*2;o<=s*2;o++)for(let l=-s*2;l<=s*2;l++){const c=e+o,d=t+l,u=this.grid.getCell(c,d);u&&!((r=u.biome)!=null&&r.impassable)&&u.elevation>=.42&&a.push({q:c,r:d})}return a.length>0?a[Math.floor(Math.random()*a.length)]:this.findAnyLandHex()}findAnyLandHex(){const e=[];return this.grid.forEach(t=>{var i;t&&!((i=t.biome)!=null&&i.impassable)&&t.elevation>=.42&&e.push({q:t.q,r:t.r})}),e.length>0?e[Math.floor(Math.random()*e.length)]:{q:60,r:60}}updateUI(){const e=this.state,t=this.ui;t.timeDisplay.textContent=e.formattedTime,t.timePeriod.textContent=e.timeOfDay.charAt(0).toUpperCase()+e.timeOfDay.slice(1),t.timePeriod.className=e.isNight?"night":"",t.playerName.textContent=e.player.name;const i=e.player.race.replace("_"," "),s=e.player.class.charAt(0).toUpperCase()+e.player.class.slice(1);t.playerRace.textContent=`${i} ${s}`,t.playerLocation.textContent=e.player.currentPOI?`Location: ${e.player.currentPOI.name}`:"Location: Wilderness";let a="";if(this.overworldCorruption&&e.player.position&&!this.inDungeon){const p=this.overworldCorruption.getZoneAt(e.player.position.q,e.player.position.r),v=he[p];if(p!=="SAFE"){const b={TAINTED:"#9966cc",CORRUPTED:"#cc4488",BLIGHTED:"#aa2255"},k=this.overworldCorruption.getWardTimeRemaining(),w=k>0?` ðŸ›¡ï¸${Math.ceil(k/10)}m`:"";a=`<span style="color: ${b[p]||"#9966cc"}">âš ï¸ ${v.name}${w}</span>`}}const n=e.isNight?"Night time":"Idle";t.playerStatus.innerHTML=a?`${a} | ${n}`:n,this.updateConditionsUI();const r=e.player.health/e.player.maxHealth*100,o=e.player.stamina/e.player.maxStamina*100,l=e.player.ether/e.player.maxEther*100;t.healthBar.style.width=r+"%",t.healthText.textContent=`${Math.floor(e.player.health)}/${e.player.maxHealth}`,t.staminaBar.style.width=o+"%",t.staminaText.textContent=`${Math.floor(e.player.stamina)}/${e.player.maxStamina}`,t.etherBar.style.width=l+"%",t.etherText.textContent=`${Math.floor(e.player.ether)}/${e.player.maxEther}`;const c=e.player.exp/e.player.xpToNextLevel*100;t.xpBar.style.width=c+"%",t.xpText.textContent=`${e.player.exp}/${e.player.xpToNextLevel}`,t.playerLevel.textContent=`Lv.${e.player.level}`;const d=e.player.attributes;t.attrTrust.textContent=Math.floor(d.trust),t.attrPrestige.textContent=Math.floor(d.prestige),t.attrInfluence.textContent=Math.floor(d.influence),t.attrAgility.textContent=Math.floor(d.agility),t.playerGold.textContent=`Gold: ${e.player.gold}`;const u=this.guilds.getAlignmentTier();t.alignmentTier.textContent=u.name,t.alignmentTier.style.color=u.color;const h=(e.player.alignment+100)/200*100;t.alignmentMarker.style.left=`${h}%`,t.restBtn.disabled=e.player.stamina>=e.player.maxStamina;const g=this.inventory&&this.inventory.has("tent")&&!this.inDungeon;t.tentBtn.classList.toggle("hidden",!g),this.updateLocationActions(),this.updateInventoryUI(),this.updateCitizensUI(),this.updateGuildsUI(),this.updateTownModalStats();const y=e.log[0],f=y?`${y.time}:${y.message}`:"";this._lastLogKey!==f&&(this._lastLogKey=f,t.logEntries.innerHTML=e.log.slice(0,10).map(p=>`
                <div class="log-entry ${p.type}">
                    <span class="log-time">${p.time}</span> ${p.message}
                </div>
            `).join(""))}updateConditionsUI(){const e=this.ui.conditionsDisplay;if(!e)return;const t=this.state.getActiveConditions(),i=t.map(s=>`${s.id}:${s.remainingDuration}`).join("|");if(this._lastConditionsKey!==i){if(this._lastConditionsKey=i,t.length===0){e.innerHTML!==""&&(e.innerHTML="");return}e.innerHTML=t.map(s=>{const a=s.remainingDuration,n=a>60?`${Math.floor(a/60)}h${a%60}m`:`${a}m`;return`
                <div class="condition-badge" style="color: ${s.color};" title="${s.name}: ${n} remaining">
                    <span class="condition-icon">${s.icon}</span>
                    <span class="condition-name">${s.name}</span>
                    <span class="condition-timer">${n}</span>
                </div>
            `}).join("")}}updateLocationActions(){const e=this.state.player.currentPOI,t=this.ui;t.townActions.classList.add("hidden"),t.wildernessActions.innerHTML="";const i=this.getAdjacentResourceActions(),s=this.consolidateResourceActions(i);let a="";if(e){const r=e.name||e.type.name,o=e.type.icon||"ðŸ“";a+=`
                <button class="location-btn enter-location" data-location-type="${e.type.category}" id="enter-location-btn">
                    ${o} Enter ${r}
                </button>
            `}if(s.forEach((r,o)=>{const l=!r.canPerform,c=l?r.reason:`${r.staminaCost} stamina`;a+=`
                <button class="location-btn resource-action-direct"
                        data-action="resource-direct"
                        data-action-id="${o}"
                        ${l?"disabled":""}
                        title="${c}">
                    ${r.icon} ${r.name} <span class="resource-count">Ã—${r.totalRemaining}</span>
                </button>
            `}),this.inventory&&this.inventory.has("tent")&&(a+=`
                <button class="location-btn camp" data-action="camp-direct" title="Set up camp and rest safely">
                    â›º Make Camp
                </button>
            `),this.hexActions&&this.hexActions.hasChest()){const r=this.hexActions.getChestInfo();r&&(a+=`
                    <button class="location-btn chest" data-action="chest-direct" title="Open ${r.name}">
                        ${r.icon} Open ${r.name}
                    </button>
                `)}t.wildernessActions.innerHTML=a,this._wildernessActionsHandler&&t.wildernessActions.removeEventListener("click",this._wildernessActionsHandler);const n=this;this._wildernessActionsHandler=function(r){const o=r.target.closest("button");if(!o||o.disabled)return;const l=o.dataset.action;if(!l){o.id==="enter-location-btn"&&n.showLocationActionsModal(e);return}switch(l){case"resource-direct":const c=o.dataset.actionId;n.startConsolidatedResourceAction(c);break;case"camp-direct":n.makeCamp();break;case"chest-direct":if(n.hexActions&&n.hexActions.hasChest()){const d=n.hexActions.getChestInfo();d&&n.showChestModal(d)}break}},t.wildernessActions.addEventListener("click",this._wildernessActionsHandler),this.updateCompass()}consolidateResourceActions(e){const t=new Map;return e.forEach(i=>{t.has(i.id)||t.set(i.id,{id:i.id,name:i.name,icon:i.icon,resource:i.resource,staminaCost:i.staminaCost,totalRemaining:0,canPerform:!1,reason:i.reason,sources:[]});const s=t.get(i.id);s.totalRemaining+=i.remaining,s.sources.push({hex:i.hex,remaining:i.remaining,canPerform:i.canPerform,reason:i.reason}),i.canPerform&&(s.canPerform=!0,s.reason="")}),t}startConsolidatedResourceAction(e){const i=this.getAdjacentResourceActions().filter(s=>s.id===e&&s.canPerform).sort((s,a)=>s.distance!==a.distance?s.distance-a.distance:a.remaining-s.remaining);if(i.length>0){const s=i[0];this.startHexAction(s.hex,s)}}getAdjacentResourceActions(){if(!this.hexActions||!this.grid)return[];const e=this.state.player.position,t=[],i=this.grid.getCell(e.q,e.r);i&&this.hexActions.getActionsForHex(i).forEach(n=>{const r=this.hexActions.canPerform(n,i);t.push({...n,hex:i,distance:0,distanceText:"Here",canPerform:r.can,reason:r.reason})});const s=this.grid.getNeighbors?this.grid.getNeighbors(e.q,e.r):[];for(const a of s){const n=this.grid.getCell(a.q,a.r);if(!n)continue;this.hexActions.getActionsForHex(n).forEach(o=>{const l=this.hexActions.canPerform(o,n);t.push({...o,hex:n,distance:1,distanceText:"Adjacent",canPerform:l.can,reason:l.reason})})}return t}showLocationActionsModal(e){var a,n;if(!e)return;const t=e.name||e.type.name,i=e.type.icon||"ðŸ“";let s="";if(e.type.category==="settlement"){const r=this.townActions.getAvailableActions(e),o=r.filter(b=>b.id==="work"||b.id==="volunteer"),l=r.filter(b=>b.id!=="work"&&b.id!=="volunteer"),c={work:"âš’ï¸",volunteer:"ðŸ¤",rest:"ðŸ›ï¸",shop:"ðŸª",stables:"ðŸ´",townBoard:"ðŸ“‹",storage:"ðŸ“¦",facilities:"ðŸ›ï¸"};l.push({id:"facilities",name:"Facilities",cost:{}});const d=this.citizens?this.citizens.citizens:[],u=this.citizens?this.citizens.maxHiredWorkers:2;let h=[];const m=(n=(a=this.townEconomy)==null?void 0:a.getOrCreateEconomy)==null?void 0:n.call(a,e);m&&m.population&&(h=m.population.getHireableCitizens());const g=this.guilds?this.guilds.memberships:{},y=Object.keys(g).length,f=Object.values(z).filter(b=>!this.guilds.isMember(b.id));d.length===0||d.map(b=>{const k={idle:"ðŸ’¤",exhausted:"ðŸ˜´",traveling_to_resource:"ðŸš¶",gathering:"â›ï¸",traveling_to_storage:"ðŸš¶",depositing:"ðŸ“¦",working:"âš’ï¸"},w=(b.energy||100)<10,x=w?"exhausted":b.state;return`
                    <div class="panel-list-item citizen-row ${w?"exhausted":""}" data-uid="${b.uid}">
                        <span class="item-icon">${b.icon}</span>
                        <div class="item-info">
                            <div class="item-name">${b.name}</div>
                            <div class="item-sub">${b.role} ${k[x]||""} ${w?'<span class="exhausted-label">Exhausted</span>':""}</div>
                        </div>
                    </div>
                `}).join(""),y===0||Object.entries(g).map(([b,k])=>{const w=z[b],x=this.guilds.getRank(b);return`
                    <div class="panel-list-item guild-row" data-guild="${b}">
                        <span class="item-icon">${w.icon}</span>
                        <div class="item-info">
                            <div class="item-name">${w.name}</div>
                            <div class="item-sub">${x.name}</div>
                        </div>
                    </div>
                `}).join(""),s=`
                <div class="town-modal-stats-header" id="town-stats-header">
                    <div class="town-name-display">${i} ${t}</div>
                    <div class="stat-item gold"><span class="stat-icon">ðŸ’°</span><span class="stat-value">${this.state.player.gold}</span></div>
                    <div class="stat-item prestige"><span class="stat-icon">ðŸ‘‘</span><span class="stat-value">${this.state.player.attributes.prestige}</span></div>
                    <div class="stat-item trust"><span class="stat-icon">ðŸ¤</span><span class="stat-value">${this.state.player.attributes.trust}</span></div>
                    <div class="stat-item influence"><span class="stat-icon">ðŸ“¢</span><span class="stat-value">${this.state.player.attributes.influence}</span></div>
                </div>
                <div class="town-modal-grid">
                    <div class="town-panel" id="town-card">
                        <div class="panel-header-bar">
                            <span class="panel-title">Town</span>
                        </div>
                        <div class="panel-content" id="town-card-content">
                            ${this.renderTownCardMain(o,l,c,e)}
                        </div>
                    </div>
                    <div class="town-panel" id="citizens-card">
                        <div class="panel-header-bar">
                            <span class="panel-title">Citizens</span>
                            <span class="panel-count">${d.length}/${u}</span>
                        </div>
                        <div class="panel-content" id="citizens-card-content">
                            ${this.renderCitizensCardMain(d,h,u)}
                        </div>
                    </div>
                    <div class="town-panel" id="guilds-card">
                        <div class="panel-header-bar">
                            <span class="panel-title">Guilds</span>
                            <span class="panel-count">${y}</span>
                        </div>
                        <div class="panel-content" id="guilds-card-content">
                            ${this.renderGuildsCardMain(g,f)}
                        </div>
                    </div>
                </div>
            `,this.showModal("Settlement",s,{}),this.drawTownRadarChart(),this.syncProgressBarsToTweens();const p=this,v=document.getElementById("modal-body");this._townClickHandler&&v.removeEventListener("click",this._townClickHandler),this._townModalPoi=e,this._townClickHandler=function(b){const k=p._townModalPoi,w=b.target.closest(".card-back-btn");if(w){b.stopPropagation();const A=w.dataset.card;A==="town"?p.updateTownCard("main"):A==="citizens"?p.updateCitizensCard("main"):A==="guilds"&&p.updateGuildsCard("main");return}const x=b.target.closest(".town-btn[data-action]");if(x&&!x.disabled){b.stopPropagation();const A=x.dataset.action;A==="work"?p.updateTownCard("work"):A==="volunteer"?p.updateTownCard("volunteer"):A==="shop"?p.updateTownCard("shop"):A==="townBoard"?p.updateTownCard("townBoard"):A==="storage"?p.updateTownCard("storage"):A==="stables"?p.updateTownCard("stables"):A==="facilities"?p.updateTownCard("facilities"):A==="rest"&&(p.handleServiceAction("rest"),p.hideModal());return}const C=b.target.closest(".panel-action-btn[data-action]");if(C&&!C.disabled){b.stopPropagation();const A=C.dataset.action;A==="hire"?p.updateCitizensCard("hire"):A==="join-guild"&&p.updateGuildsCard("join");return}const _=b.target.closest(".citizen-row[data-uid]");if(_){b.stopPropagation();const A=_.dataset.uid;p.updateCitizensCard("detail",A);return}const M=b.target.closest(".guild-row[data-guild]");if(M){b.stopPropagation();const A=M.dataset.guild;p.updateGuildsCard("detail",A);return}const S=b.target.closest(".economy-details-btn");if(S){b.stopPropagation();const A=S.dataset.poi;p.showEconomyModal(A,k);return}p.handleTownCardActions(b)},v.addEventListener("click",this._townClickHandler),this._townChangeHandler&&v.removeEventListener("change",this._townChangeHandler),this._townChangeHandler=function(b){const k=b.target.closest(".citizen-select");if(k&&k.value){const x=k.dataset.taskId,C=k.value,_=k.dataset.category||"work";if(x&&p.townActions.assignCitizenToTask(C,x)){p.citizens&&p.citizens.assign(C,{type:"townTask",taskId:x});const M=_==="townBoard"?"townBoard":_==="volunteer"?"volunteer":"work";p.updateTownCard(M),p.updateCitizensCard("main")}}const w=b.target.closest(".facility-citizen-select");if(w&&w.value){const x=w.dataset.facility,C=w.dataset.task,_=w.value,M=p._townModalPoi;x&&C&&_&&M&&p.townActions.acceptTrainingTask(x,C,_,M,p.citizens)&&(p.updateTownCard("facilities"),p.updateCitizensCard("main"),p.updateUI())}},v.addEventListener("change",this._townChangeHandler)}else if(e){let r="";if(e.type.category==="resource"?r=`
                    <button class="location-btn gather" data-action="gather">
                        Gather ${e.data.output} (1hr)
                    </button>`:e.type.category==="landmark"?r=`
                    <button class="location-btn" data-action="explore">
                        Explore ${e.type.name}
                    </button>`:e.type.category==="cult"?r=`
                    <button class="location-btn cult" data-action="approach-shrine">
                        ${e.type.icon} Approach ${e.type.name}
                    </button>`:e.type.category==="guild"?r=`
                    <button class="location-btn guild" data-action="enter-guild" style="background: linear-gradient(135deg, ${e.type.color}40, ${e.type.color}20);">
                        ${e.type.icon} Enter ${e.name}
                    </button>`:e.type.category==="crafting"&&(r=`
                    <button class="location-btn crafting" data-action="use-crafting" style="background: linear-gradient(135deg, ${e.type.color}40, ${e.type.color}20);">
                        ${e.type.icon} Use ${e.name}
                    </button>`),this.hexActions&&this.hexActions.hasChest()){const c=this.hexActions.getChestInfo();c&&(r+=`
                        <button class="location-btn chest" data-action="open-chest" title="Open ${c.name}">
                            ${c.icon} Open ${c.name}
                        </button>`)}s=`<div class="location-actions-modal">${r}</div>`,this.showModal(`${i} ${t}`,s,{});const o=this,l=document.getElementById("modal-body");this._locationClickHandler&&l.removeEventListener("click",this._locationClickHandler),this._locationClickHandler=function(c){const d=c.target.closest("[data-action]");if(!d||d.disabled)return;c.stopPropagation();const u=d.dataset.action;console.log("Location button clicked:",u);let h=!1;switch(u){case"gather":o.gatherResource(e);break;case"explore":o.showDungeonIntelPanel(e),h=!0;break;case"approach-shrine":o.showCultShrineModal(e),h=!0;break;case"enter-guild":o.showGuildHallModal(e),h=!0;break;case"use-crafting":o.showCraftingModal(),h=!0;break;case"open-chest":if(o.hexActions&&o.hexActions.hasChest()){const m=o.hexActions.getChestInfo();m&&(o.showChestModal(m),h=!0)}break;default:return}h||o.hideModal()},l.addEventListener("click",this._locationClickHandler)}}renderTownCardMain(e,t,i,s=null){return`
            ${s?`
            <div class="action-category">
                <span class="category-label">Attributes</span>
                <div class="town-attributes-bar" id="town-attributes-bar">
                    ${this.renderTownAttributesBar(s)}
                </div>
            </div>
        `:""}
            <div class="action-category">
                <span class="category-label">Activities</span>
                <div class="action-grid">
                    ${e.map(n=>{const r=this.townActions.canAfford(n);return`
                            <button class="town-btn ${n.id}" data-action="${n.id}" ${r.can?"":'disabled title="'+r.reason+'"'}>
                                <span class="btn-icon">${i[n.id]||"ðŸ“Œ"}</span>
                                <span class="btn-label">${n.name}</span>
                            </button>`}).join("")}
                </div>
            </div>
            <div class="action-category">
                <span class="category-label">Services</span>
                <div class="action-grid">
                    ${t.map(n=>{const r=this.townActions.canAfford(n);return`
                            <button class="town-btn" data-action="${n.id}" ${r.can?"":'disabled title="'+r.reason+'"'}>
                                <span class="btn-icon">${i[n.id]||"ðŸ“Œ"}</span>
                                <span class="btn-label">${n.name}</span>
                            </button>`}).join("")}
                </div>
            </div>
        `}getAttributeLevelTitle(e){return{0:"Dormant",1:"Fledgling",2:"Novice",3:"Developing",4:"Established",5:"Proficient",6:"Advanced",7:"Expert",8:"Master",9:"Renowned",10:"Legendary"}[e]||"Unknown"}renderTownAttributesBar(e){var r;if(!((r=e==null?void 0:e.data)!=null&&r.townAttributes))return"";const t=e.data.townAttributes,s=["agriculture","construction","medicine","tailoring","warriors","smithing","rangers"].map(o=>{var v;const l=t[o],c=!(l!=null&&l.active),d=Ri[o],u=c?0:(l==null?void 0:l.level)||1,h=(l==null?void 0:l.xp)||0,m=Ti(u),g=((v=J[u])==null?void 0:v.xp)||0,y=h-g,f=m-g,p=c?0:u>=10?100:Math.floor(y/f*100);return{id:o,name:(d==null?void 0:d.name)||o,icon:(d==null?void 0:d.icon)||"ðŸ“Š",color:(d==null?void 0:d.color)||"#888",level:u,progress:p,isDormant:c,xpInLevel:y,xpNeeded:f}}),a=s.map((o,l)=>{const c=this.getAttributeLevelTitle(o.level),d=10,u=o.level,h=Array(d).fill(0).map((m,g)=>`<span class="radar-dot" style="background: ${g<u?o.color:"rgba(60, 55, 50, 0.6)"};"></span>`).join("");return`
                <div class="radar-label" data-position="${l}" data-attr="${o.id}">
                    <div class="radar-label-name">
                        <span class="radar-label-icon">${o.icon}</span>
                        <span class="radar-label-text ${o.isDormant?"dormant":""}">${o.name}</span>
                    </div>
                    <div class="radar-dots">${h}</div>
                    <div class="radar-tooltip">
                        <div class="tooltip-title" style="color: ${o.color}">${o.icon} ${o.name}</div>
                        <div class="tooltip-level">Level ${o.level} Â· ${c}</div>
                        <div class="tooltip-xp-bar">
                            <div class="tooltip-xp-fill" style="width: ${o.progress}%; background: ${o.color};"></div>
                        </div>
                        <div class="tooltip-xp-text">${o.xpInLevel} / ${o.xpNeeded} XP</div>
                    </div>
                </div>
            `}).join("");return`
            <div class="radar-chart-container">
                <canvas id="town-radar-canvas" class="radar-canvas" width="140" height="140" data-attrs='${JSON.stringify(s.map(o=>({level:o.level,color:o.color})))}'></canvas>
                <div class="radar-labels">${a}</div>
            </div>
        `}drawTownRadarChart(){const e=document.getElementById("town-radar-canvas");if(!e)return;const t=e.getContext("2d"),i=JSON.parse(e.dataset.attrs||"[]");if(i.length===0)return;const s=e.width/2,a=e.height/2,n=Math.min(s,a)-10,r=i.length,o=10;t.clearRect(0,0,e.width,e.height),t.strokeStyle="rgba(80, 70, 60, 0.3)",t.lineWidth=1;for(let c=1;c<=5;c++){const d=c/5*n;t.beginPath();for(let u=0;u<=r;u++){const h=Math.PI*2*u/r-Math.PI/2,m=s+Math.cos(h)*d,g=a+Math.sin(h)*d;u===0?t.moveTo(m,g):t.lineTo(m,g)}t.closePath(),t.stroke()}t.strokeStyle="rgba(80, 70, 60, 0.2)";for(let c=0;c<r;c++){const d=Math.PI*2*c/r-Math.PI/2;t.beginPath(),t.moveTo(s,a),t.lineTo(s+Math.cos(d)*n,a+Math.sin(d)*n),t.stroke()}t.beginPath();for(let c=0;c<r;c++){const d=Math.PI*2*c/r-Math.PI/2,u=i[c].level/o,h=Math.max(u*n,n*.05),m=s+Math.cos(d)*h,g=a+Math.sin(d)*h;c===0?t.moveTo(m,g):t.lineTo(m,g)}t.closePath();const l=t.createRadialGradient(s,a,0,s,a,n);l.addColorStop(0,"rgba(200, 170, 80, 0.8)"),l.addColorStop(1,"rgba(160, 130, 60, 0.6)"),t.fillStyle=l,t.fill(),t.strokeStyle="rgba(80, 60, 40, 0.8)",t.lineWidth=2,t.stroke();for(let c=0;c<r;c++){const d=Math.PI*2*c/r-Math.PI/2,u=i[c].level/o,h=Math.max(u*n,n*.05),m=s+Math.cos(d)*h,g=a+Math.sin(d)*h;t.beginPath(),t.arc(m,g,3,0,Math.PI*2),t.fillStyle=i[c].color,t.fill(),t.strokeStyle="rgba(40, 30, 20, 0.8)",t.lineWidth=1,t.stroke()}}renderFacilitiesGrid(e){var i;if(!((i=e==null?void 0:e.data)!=null&&i.facilities))return'<div class="panel-empty-state">No facilities</div>';const t=e.data.facilities;return t.length===0?'<div class="panel-empty-state">No facilities built</div>':`
            <div class="facilities-grid">
                ${t.map(s=>{const a=le[s];return a?`
                        <div class="facility-item" title="${a.description}">
                            <span class="facility-icon">${a.icon}</span>
                            <span class="facility-name">${a.name}</span>
                        </div>
                    `:""}).join("")}
            </div>
        `}renderFacilitiesContent(e){var h,m,g,y,f,p;if(!((h=e==null?void 0:e.data)!=null&&h.facilities))return`
                <button class="card-back-btn" data-card="town">â† Back</button>
                <div class="panel-empty-state">No facilities data</div>
            `;const t=e.data.facilities||[],i=e.data.townAttributes||{},s=((g=(m=this.state)==null?void 0:m.player)==null?void 0:g.gold)||0,a=((y=this.state)==null?void 0:y.day)||0,r=(((f=this.citizens)==null?void 0:f.hiredWorkers)||[]).filter(v=>(v.status==="active"||!v.status)&&!v.assignment&&v.lastTrainingDay!==a),l=Si(i,t).filter(v=>v.canUnlock&&!t.includes(v.id));let c='<button class="card-back-btn" data-card="town">â† Back</button>';c+='<div class="facilities-header">ðŸ›ï¸ Town Facilities</div>';const d=e.key||`${e.x},${e.y}`,u=(p=this.townEconomy)==null?void 0:p.getEconomySummary(d,e);if(u){const v=u.foodBalance>=0?`<span class="eco-positive">+${u.foodBalance}</span>`:`<span class="eco-negative">${u.foodBalance}</span>`,b=u.production.gold||0,k=u.deficitDays>0?`<span class="eco-warning">âš  Food shortage: Day ${u.deficitDays}</span>`:"";c+=`
                <div class="economy-summary-bar">
                    <div class="eco-stats">
                        <span class="eco-stat" title="Population">ðŸ‘¥ ${u.population}</span>
                        <span class="eco-stat" title="Food balance per day">ðŸž ${v}/day</span>
                        <span class="eco-stat" title="Gold income per day">ðŸ’° +${b}/day</span>
                        <span class="eco-stat" title="Average morale">ðŸ˜Š ${u.morale}%</span>
                    </div>
                    ${k}
                    <button class="economy-details-btn" data-poi="${d}">ðŸ“Š Details</button>
                </div>
            `}if(t.length===0)c+='<div class="panel-empty-state">No facilities built yet</div>';else{c+='<div class="facilities-list">';for(const v of t){const b=le[v];if(!b)continue;const k=Object.entries(b.effects||{}).map(([C,_])=>{if(typeof _=="boolean")return _?`<span class="facility-effect-badge boolean">âœ“ ${this.formatEffectName(C)}</span>`:"";if(typeof _=="number"){const M=_<1&&_>0?`+${Math.round(_*100)}%`:`+${_}`;return`<span class="facility-effect-badge">${this.formatEffectName(C)}: ${M}</span>`}return""}).filter(C=>C).slice(0,4).join(""),w=ai(v);let x="";if(w.length>0){x='<div class="facility-tasks">';for(const C of w){const _=s>=C.cost,M=C.cost>0?`${C.cost}g`:"Free",S=`${C.duration}h`;let A='<option value="">Select citizen...</option>';for(const N of r)A+=`<option value="${N.uid}">${N.name}</option>`;const q=r.length===0,U=_?q?"No available citizens":"":"Not enough gold";x+=`
                            <div class="facility-task-row" data-task="${C.id}" data-facility="${v}">
                                <div class="facility-task-info">
                                    <span class="facility-task-icon">${C.icon}</span>
                                    <span class="facility-task-name">${C.name}</span>
                                    <span class="facility-task-meta">${S} â€¢ ${M}</span>
                                </div>
                                <div class="facility-task-assign">
                                    <select class="facility-citizen-select"
                                            data-facility="${v}"
                                            data-task="${C.id}"
                                            ${!_||q?"disabled":""}
                                            title="${U}">
                                        ${A}
                                    </select>
                                </div>
                            </div>
                        `}x+="</div>"}c+=`
                    <div class="facility-card" data-facility="${v}">
                        <div class="facility-card-header">
                            <span class="facility-icon-large">${b.icon}</span>
                            <div class="facility-title-row">
                                <span class="facility-name">${b.name}</span>
                                <span class="facility-desc">${b.description}</span>
                            </div>
                        </div>
                        <div class="facility-effects-row">
                            ${k||'<span class="facility-effect-badge">No passive effects</span>'}
                        </div>
                        ${x}
                    </div>
                `}c+="</div>"}if(l.length>0){c+='<div class="facilities-unlock-header">Available via Town Board</div>',c+='<div class="facilities-unlock-list">';for(const v of l.slice(0,4))c+=`
                    <div class="facility-unlock-item">
                        <span class="facility-icon">${v.icon}</span>
                        <span class="facility-name">${v.name}</span>
                    </div>
                `;c+="</div>"}return c}formatEffectName(e){return e.replace(/([A-Z])/g," $1").replace(/^./,t=>t.toUpperCase()).replace("Bonus","").replace("Available","").trim()}showEconomyModal(e,t){var y,f,p,v,b,k;const i=(y=this.townEconomy)==null?void 0:y.getEconomyData(e),s=(f=this.townEconomy)==null?void 0:f.getEconomySummary(e);if(!i||!s){this.state.addLog("No economy data available","warning");return}const a=((p=t==null?void 0:t.data)==null?void 0:p.name)||(t==null?void 0:t.name)||"Settlement",n=(b=(v=this.state).getStorage)==null?void 0:b.call(v,e),r=((k=n==null?void 0:n.getCount)==null?void 0:k.call(n,"food"))||0,o=s.production;let l="";o.food>0&&(l+=`<div class="eco-row">ðŸŒ¾ Food: +${o.food}/day</div>`),o.gold>0&&(l+=`<div class="eco-row">ðŸ’° Gold: +${o.gold}/day</div>`),o.weapons>0&&(l+=`<div class="eco-row">âš”ï¸ Weapons: +${o.weapons}/day</div>`),o.morale>0&&(l+=`<div class="eco-row">ðŸ˜Š Morale: +${o.morale}/day</div>`),o.defense>0&&(l+=`<div class="eco-row">ðŸ›¡ï¸ Defense: +${o.defense}/day</div>`),l||(l='<div class="eco-row eco-muted">No facilities producing yet</div>');const c=s.foodBalance,d=c>=0?"eco-positive":"eco-negative",u=c>=0?"âœ“":"âš ";let h="";if(s.deficitDays>0){let w="Morale dropping";s.deficitDays>=5?w="Population starving!":s.deficitDays>=3&&(w="Population fleeing"),h=`
                <div class="eco-deficit-warning">
                    <div class="eco-deficit-title">âš  Food Shortage - Day ${s.deficitDays}</div>
                    <div class="eco-deficit-consequence">${w}</div>
                    <button class="eco-import-btn" data-poi="${e}">ðŸ“¦ Import Food (3g each)</button>
                </div>
            `}const m=s.stats,g=`
            <div class="economy-modal">
                <div class="eco-section">
                    <div class="eco-section-title">Population</div>
                    <div class="eco-grid">
                        <div class="eco-stat-box">
                            <span class="eco-stat-value">${s.population}</span>
                            <span class="eco-stat-label">Active</span>
                        </div>
                        <div class="eco-stat-box">
                            <span class="eco-stat-value">${s.morale}%</span>
                            <span class="eco-stat-label">Morale</span>
                        </div>
                        <div class="eco-stat-box">
                            <span class="eco-stat-value">${s.productivity}%</span>
                            <span class="eco-stat-label">Productivity</span>
                        </div>
                    </div>
                </div>

                <div class="eco-section">
                    <div class="eco-section-title">Daily Production</div>
                    ${l}
                </div>

                <div class="eco-section">
                    <div class="eco-section-title">Food Balance</div>
                    <div class="eco-balance">
                        <div class="eco-balance-row">
                            <span>Produced:</span>
                            <span class="eco-positive">+${o.food}</span>
                        </div>
                        <div class="eco-balance-row">
                            <span>Consumed:</span>
                            <span class="eco-negative">-${s.consumption.food}</span>
                        </div>
                        <div class="eco-balance-row eco-balance-total">
                            <span>Net:</span>
                            <span class="${d}">${u} ${c>=0?"+":""}${c}/day</span>
                        </div>
                        <div class="eco-balance-row">
                            <span>In Storage:</span>
                            <span>${r} food</span>
                        </div>
                    </div>
                </div>

                ${h}

                <div class="eco-section">
                    <div class="eco-section-title">Historical Stats</div>
                    <div class="eco-history">
                        <div class="eco-row">Days tracked: ${m.totalDaysTracked}</div>
                        <div class="eco-row">Total food produced: ${m.totalFoodProduced}</div>
                        <div class="eco-row">Total food consumed: ${m.totalFoodConsumed}</div>
                        <div class="eco-row">Total gold generated: ${m.totalGoldGenerated}</div>
                        <div class="eco-row">Deficit days: ${m.deficitDaysTotal}</div>
                    </div>
                </div>
            </div>
        `;this.showModal(`ðŸ“Š ${a} Economy`,g,{onShow:w=>{const x=w.querySelector(".eco-import-btn");x&&x.addEventListener("click",()=>{this.townEconomy.importFood(e,10)&&(this.updateUI(),this.showEconomyModal(e,t))})}})}renderCitizensCardMain(e,t,i){const s={idle:"Idle",traveling_to_resource:"Traveling...",gathering:"Working",traveling_to_storage:"Returning...",depositing:"Depositing"},a={gathering:"ðŸŒ¾",agriculture:"ðŸŒ¾",woodcutting:"ðŸ”¨",construction:"ðŸ”¨",crafting:"ðŸ”¨",mining:"âš’ï¸",smithing:"âš’ï¸",combat:"âš”ï¸",patrol:"âš”ï¸",warriors:"âš”ï¸",trading:"ðŸ§µ",appraisal:"ðŸ§µ",tailoring:"ðŸ§µ",exploration:"ðŸ¹",survival:"ðŸ¹",rangers:"ðŸ¹",herbalism:"âš•ï¸",medicine:"âš•ï¸",healing:"âš•ï¸"},n={active:{icon:"",color:"",label:""},injured:{icon:"ðŸ©¹",color:"#f80",label:"Injured"},imprisoned:{icon:"â›“ï¸",color:"#f44",label:"Captured!"},missing:{icon:"â“",color:"#888",label:"Missing"},dead:{icon:"ðŸ’€",color:"#666",label:"Deceased"}};return`
            <div class="panel-scrollable">
                ${e.length===0?`
            <div class="panel-empty-state">
                <span class="empty-icon">ðŸ‘¥</span>
                <span class="empty-text">No citizens hired</span>
                <div class="empty-hint">Hire citizens to help with tasks</div>
            </div>
        `:`<div class="panel-list">
            ${e.map(o=>{var _,M,S,A,q,U,N,ne,Z;const l=o.role||"Worker",c=s[o.state]||"Idle",d=!o.assignment,u=o.status||"active",h=n[u]||n.active,m=["injured","imprisoned","missing","dead"].includes(u),g=o.guildId?`<span style="font-size: 10px; opacity: 0.7;">${this.getGuildIcon(o.guildId)}</span>`:"",y=o.skills||{},f=Object.entries(y).sort((L,G)=>G[1]-L[1]),p=f[0],v=p?a[p[0]]||"ðŸ“Š":"",b=p?p[1]:0,k=f.slice(0,4).map((L,G)=>{const Ae=a[L[0]]||"ðŸ“Š";return`<span class="tooltip-skill-tag ${G===0?"primary":""}">${Ae} ${L[0]} ${L[1]}</span>`}).join("");let w="";if(((_=o.assignment)==null?void 0:_.type)==="townTask"&&o.assignment.taskId){const L=(S=(M=this.townActions)==null?void 0:M.getAcceptedTasks())==null?void 0:S.find(G=>G.id===o.assignment.taskId);w=(L==null?void 0:L.name)||"Working"}else if(((A=o.assignment)==null?void 0:A.type)==="quest"&&o.assignment.questId){const L=(U=(q=this.quests)==null?void 0:q.activeQuests)==null?void 0:U.find(G=>G.id===o.assignment.questId);w=(L==null?void 0:L.name)||"Quest"}else if(((N=o.assignment)==null?void 0:N.type)==="scout"&&o.assignment.questId){const L=(Z=(ne=this.quests)==null?void 0:ne.activeQuests)==null?void 0:Z.find(G=>G.id===o.assignment.questId);w=(L==null?void 0:L.name)||"Scouting"}let x="";if(m){const L=o.statusTimer?` (${o.statusTimer} days)`:"";x=`<span style="color: ${h.color};">${h.icon} ${h.label}${L}</span>`}else d?x="ðŸ’¤ Idle":x="âš¡ "+w;const C=`
                    <div class="tooltip-title">${o.icon} ${o.name}</div>
                    <div class="tooltip-level">${l} Â· Level ${o.level||1}</div>
                    ${k?`<div class="tooltip-skills">${k}</div>`:""}
                    ${p?`<div class="tooltip-yield">Daily yield potential based on ${p[0]}</div>`:""}
                    <div class="tooltip-desc">${d?"Available for tasks":`Currently: ${w||c}`}</div>
                `;return`
                <div class="panel-list-item citizen-row" data-uid="${o.uid}" style="${m?"opacity: 0.7;":""}">
                    <span class="item-icon" style="${m?"filter: grayscale(50%);":""}">${o.icon}</span>
                    <div class="item-info">
                        <div class="item-name">${o.name} ${g} ${v?`<span class="citizen-skill-badge">${v}</span>`:""}</div>
                        <div class="item-sub">${l} â€¢ Lv${o.level||1}${p?` â€¢ ${p[0]} ${b}`:""}${o.guildRank?` â€¢ Rank ${o.guildRank}`:""}</div>
                        <div class="item-task ${d&&!m?"idle":"working"}">${x}</div>
                    </div>
                    <div class="citizen-tooltip">${C}</div>
                </div>
            `}).join("")}
        </div>`}
            </div>
            <div class="panel-footer">
                <button class="panel-action-btn" data-action="hire" ${t.length===0||e.length>=i?"disabled":""}>
                    Hire (${t.length})
                </button>
            </div>
        `}renderGuildsCardMain(e,t){return`
            <div class="panel-scrollable">
                ${Object.keys(e).length===0?`
            <div class="panel-empty-state">
                <span class="empty-icon">ðŸ›ï¸</span>
                <span class="empty-text">No guild membership</span>
            </div>
        `:`<div class="panel-list">
            ${Object.entries(e).map(([a,n])=>{const r=z[a],o=this.guilds.getRank(a);return`
                    <div class="panel-list-item guild-row" data-guild="${a}">
                        <span class="item-icon">${r.icon}</span>
                        <div class="item-info">
                            <div class="item-name">${r.name}</div>
                            <div class="item-sub">${o.name}</div>
                        </div>
                    </div>
                `}).join("")}
        </div>`}
            </div>
            <div class="panel-footer">
                <button class="panel-action-btn" data-action="join-guild" ${t.length===0?"disabled":""}>
                    Join (${t.length})
                </button>
            </div>
        `}refreshOpenModalContent(){document.getElementById("town-card-content")&&this._townModalPoi&&this._currentTownView&&this.updateTownCard(this._currentTownView),document.getElementById("citizens-card-content")&&this._currentCitizensView&&this.updateCitizensCard(this._currentCitizensView,this._currentCitizensViewData)}updateTownCard(e,t=null){this._currentTownView=e;const i=document.getElementById("town-card-content");if(!i)return;const s=this._townModalPoi;if(s){if(e==="main"){const a=this.townActions.getAvailableActions(s),n=a.filter(l=>l.id==="work"||l.id==="volunteer"),r=a.filter(l=>l.id!=="work"&&l.id!=="volunteer");r.push({id:"facilities",name:"Facilities",cost:{}});const o={work:"âš’ï¸",volunteer:"ðŸ¤",rest:"ðŸ›ï¸",shop:"ðŸª",stables:"ðŸ´",townBoard:"ðŸ“‹",storage:"ðŸ“¦",facilities:"ðŸ›ï¸"};i.innerHTML=this.renderTownCardMain(n,r,o,s),this.drawTownRadarChart()}else e==="work"?i.innerHTML=this.renderWorkContent(s):e==="volunteer"?i.innerHTML=this.renderVolunteerContent(s):e==="shop"?i.innerHTML=this.renderShopContent(s):e==="townBoard"?i.innerHTML=this.renderTownBoardContent(s):e==="storage"?i.innerHTML=this.renderStorageContent(s):e==="stables"?i.innerHTML=this.renderStablesContent(s):e==="facilities"&&(i.innerHTML=this.renderFacilitiesContent(s));this.syncProgressBarsToTweens()}}updateTownModalStats(){const e=document.getElementById("town-stats-header");if(!e)return;const t=e.querySelector(".stat-item.gold .stat-value"),i=e.querySelector(".stat-item.prestige .stat-value"),s=e.querySelector(".stat-item.trust .stat-value"),a=e.querySelector(".stat-item.influence .stat-value");t&&(t.textContent=this.state.player.gold),i&&(i.textContent=Math.floor(this.state.player.attributes.prestige)),s&&(s.textContent=Math.floor(this.state.player.attributes.trust)),a&&(a.textContent=Math.floor(this.state.player.attributes.influence))}updateCitizensCard(e,t=null){var a,n;this._currentCitizensView=e,this._currentCitizensViewData=t;const i=document.getElementById("citizens-card-content");if(!i)return;const s=this._townModalPoi;if(e==="main"){const r=this.citizens?this.citizens.citizens:[];let o=[];const l=(n=(a=this.townEconomy)==null?void 0:a.getOrCreateEconomy)==null?void 0:n.call(a,s);l&&l.population&&(o=l.population.getHireableCitizens());const c=this.citizens?this.citizens.maxHiredWorkers:2;i.innerHTML=this.renderCitizensCardMain(r,o,c)}else e==="hire"?i.innerHTML=this.renderHireContent(s):e==="detail"&&(i.innerHTML=this.renderCitizenDetailContent(t));this.syncProgressBarsToTweens()}updateGuildsCard(e,t=null){const i=document.getElementById("guilds-card-content");if(i)if(e==="main"){const s=this.guilds?this.guilds.memberships:{},a=Object.values(z).filter(n=>!this.guilds.isMember(n.id));i.innerHTML=this.renderGuildsCardMain(s,a)}else e==="join"?i.innerHTML=this.renderJoinGuildContent():e==="detail"&&(i.innerHTML=this.renderGuildDetailContent(t))}renderWorkContent(e){this.townActions.generateTasks(e);const t=this.townActions.getTasksByCategory("work"),i=this.townActions.getAcceptedTasksByCategory("work");let s='<button class="card-back-btn" data-card="town">â† Back</button>';return s+='<div class="card-section-title">Work Tasks</div>',i.length>0&&(s+='<div class="card-subsection">Active</div>',s+=i.map(a=>{var m,g,y,f,p;const n=a.assignedCitizenUid?(m=this.citizens)==null?void 0:m.getCitizen(a.assignedCitizenUid):null,r=((g=a.objective)==null?void 0:g.current)||0,o=((y=a.objective)==null?void 0:y.required)||1,l=this.getTweenedProgress(a.id),c=n?(f=this.townActions.citizenAssignedTasks)==null?void 0:f.get(a.id):null,d=l??(c==null?void 0:c.progress)??r,u=Math.min(100,d/o*100),h=this.townActions.getEligibleCitizens(a);return`
                <div class="card-task-item accepted">
                    <span class="task-icon">${a.icon}</span>
                    <div class="task-info">
                        <div class="task-name">${a.name}</div>
                        <div class="task-progress-bar"><div class="fill" data-task-progress="${a.id}" style="transition:none;width:${u}%"></div></div>
                        <div class="task-progress-text" data-task-progress-text="${a.id}">${Math.round(u)}%</div>
                        ${n?`
                            <div class="task-assigned">
                                ${n.icon} ${n.name}
                                <button class="unassign-task-btn" data-task-id="${a.id}">âœ•</button>
                            </div>
                        `:h.length>0?`
                            <div class="task-assign-row">
                                <select class="citizen-select" data-task-id="${a.id}" data-category="work">
                                    <option value="">Assign citizen...</option>
                                    ${h.map(v=>`<option value="${v.uid}">${v.icon} ${v.name}</option>`).join("")}
                                </select>
                            </div>
                        `:`
                            <div class="task-no-eligible">
                                <span class="requires-text">Requires: ${((p=a.requiredRoles)==null?void 0:p.join(", "))||"Any"}</span>
                            </div>
                        `}
                    </div>
                    <button class="task-abandon-btn" data-task-id="${a.id}">âœ•</button>
                </div>
            `}).join("")),t.length>0?(s+='<div class="card-subsection">Available</div>',s+=t.map(a=>{var c;const n=this._formatReward(a.reward),r=a.hasEligibleCitizen!==!1,o=r?"":"task-unavailable",l=((c=a.requiredRoles)==null?void 0:c.length)>0?`Requires: ${a.requiredRoles.join(", ")}`:"";return`
                <div class="card-task-item ${o}">
                    <span class="task-icon">${a.icon}</span>
                    <div class="task-info">
                        <div class="task-name">${a.name} ${"â­".repeat(a.difficulty)}</div>
                        <div class="task-desc">${a.objective.required}x â€¢ ${n}</div>
                        ${r?"":`<div class="task-requires">${l}</div>`}
                    </div>
                    ${r?`<button class="task-accept-btn" data-task-id="${a.id}">Accept</button>`:`<button class="task-accept-btn" disabled title="${l}">Locked</button>`}
                </div>
            `}).join("")):i.length===0&&(s+='<div class="panel-empty-state"><span class="empty-text">No work available</span></div>'),s}_formatReward(e){const t=[];return e.gold&&t.push(`+${e.gold}g`),e.trust&&t.push(`+${e.trust} trust`),e.prestige&&t.push(`+${e.prestige} prestige`),e.influence&&t.push(`+${e.influence} influence`),t.join(", ")||"No reward"}renderVolunteerContent(e){this.townActions.generateTasks(e);const t=this.townActions.getTasksByCategory("volunteer"),i=this.townActions.getAcceptedTasksByCategory("volunteer");let s='<button class="card-back-btn" data-card="town">â† Back</button>';return s+='<div class="card-section-title">Volunteer</div>',i.length>0&&(s+='<div class="card-subsection">Active</div>',s+=i.map(a=>{var m,g,y,f,p;const n=a.assignedCitizenUid?(m=this.citizens)==null?void 0:m.getCitizen(a.assignedCitizenUid):null,r=((g=a.objective)==null?void 0:g.current)||0,o=((y=a.objective)==null?void 0:y.required)||1,l=this.getTweenedProgress(a.id),c=n?(f=this.townActions.citizenAssignedTasks)==null?void 0:f.get(a.id):null,d=l??(c==null?void 0:c.progress)??r,u=Math.min(100,d/o*100),h=this.townActions.getEligibleCitizens(a);return`
                    <div class="card-task-item accepted volunteer">
                        <span class="task-icon">${a.icon}</span>
                        <div class="task-info">
                            <div class="task-name">${a.name}</div>
                            <div class="task-progress-bar"><div class="fill" data-task-progress="${a.id}" style="transition:none;width:${u}%"></div></div>
                            <div class="task-progress-text" data-task-progress-text="${a.id}">${Math.round(u)}%</div>
                            ${n?`
                                <div class="task-assigned">
                                    ${n.icon} ${n.name}
                                    <button class="unassign-task-btn" data-task-id="${a.id}">âœ•</button>
                                </div>
                            `:h.length>0?`
                                <div class="task-assign-row">
                                    <select class="citizen-select" data-task-id="${a.id}" data-category="volunteer">
                                        <option value="">Assign citizen...</option>
                                        ${h.map(v=>`<option value="${v.uid}">${v.icon} ${v.name}</option>`).join("")}
                                    </select>
                                </div>
                            `:`
                                <div class="task-no-eligible">
                                    <span class="requires-text">Requires: ${((p=a.requiredRoles)==null?void 0:p.join(", "))||"Any"}</span>
                                </div>
                            `}
                        </div>
                        <button class="task-abandon-btn" data-task-id="${a.id}">âœ•</button>
                    </div>
                `}).join("")),t.length>0?(s+='<div class="card-subsection">Available</div>',s+=t.map(a=>{var c;const n=this._formatReward(a.reward),r=a.hasEligibleCitizen!==!1,o=r?"":"task-unavailable",l=((c=a.requiredRoles)==null?void 0:c.length)>0?`Requires: ${a.requiredRoles.join(", ")}`:"";return`
                    <div class="card-task-item volunteer ${o}">
                        <span class="task-icon">${a.icon}</span>
                        <div class="task-info">
                            <div class="task-name">${a.name}</div>
                            <div class="task-desc">${n}</div>
                            ${r?"":`<div class="task-requires">${l}</div>`}
                        </div>
                        ${r?`<button class="task-accept-btn" data-task-id="${a.id}">Accept</button>`:`<button class="task-accept-btn" disabled title="${l}">Locked</button>`}
                    </div>
                `}).join("")):i.length===0&&(s+='<div class="panel-empty-state"><span class="empty-text">No volunteer work</span></div>'),s}renderShopContent(e){const t=this.getShopInventory(e),i=e?`${e.q},${e.r}`:null,s=i?this.state.getFacilityEffects(i):{},a=s.buyPriceReduction||0,n=s.sellPriceBonus||0,r=a>0||n>0;let o='<button class="card-back-btn" data-card="town">â† Back</button>';o+='<div class="card-section-title">Shop</div>',o+=`<div class="shop-gold-display">Gold: ${this.state.player.gold}g</div>`,r&&(o+=`<div class="shop-bonus-notice">ðŸ›’ Market bonus: ${a>0?`-${Math.round(a*100)}% buy`:""} ${n>0?`+${Math.round(n*100)}% sell`:""}</div>`),o+='<div class="storage-section-header">Buy Items</div>',t.length===0?o+='<div class="panel-empty-state"><span class="empty-text">Nothing for sale</span></div>':o+=t.map((d,u)=>{const h=this.getItemDef(d.id);if(!h)return"";const m=Math.ceil(h.value*d.markup),g=Math.ceil(m*(1-a)),y=this.state.player.gold>=g,f=g<m;return`
                    <div class="card-shop-item ${y?"":"cant-afford"}">
                        <span class="shop-icon">${h.icon}</span>
                        <div class="shop-info">
                            <div class="shop-name">${h.name}</div>
                            <div class="shop-stock">Stock: ${d.stock}</div>
                        </div>
                        <div class="shop-price ${f?"discounted":""}">${g}g${f?` <span class="original-price">${m}g</span>`:""}</div>
                        <button class="shop-buy-btn" data-item-index="${u}" data-price="${g}" ${!y||d.stock<=0?"disabled":""}>Buy</button>
                    </div>
                `}).join(""),o+='<div class="storage-section-header" style="margin-top:12px">Sell Items</div>';const c=this.inventory.getAllItems().filter(d=>d.value>0&&d.category!=="tool");return c.length===0?o+='<div class="panel-empty-state"><span class="empty-text">No items to sell</span></div>':o+=c.map(d=>{const u=Math.floor(d.value*.5),h=Math.floor(u*(1+n)),m=h>u;return`
                    <div class="card-shop-item sell">
                        <span class="shop-icon">${d.icon}</span>
                        <div class="shop-info">
                            <div class="shop-name">${d.name}</div>
                            <div class="shop-stock">Owned: ${d.quantity}</div>
                        </div>
                        <div class="shop-price sell-price ${m?"boosted":""}">${h}g</div>
                        <button class="shop-sell-btn" data-item-id="${d.id}" data-sell-price="${h}" ${h<=0?"disabled":""}>Sell</button>
                    </div>
                `}).join(""),o}renderTownBoardContent(e){this.townActions.generateTasks(e);const t=this.townActions.getTasksByCategory("townBoard"),i=this.townActions.getAcceptedTasksByCategory("townBoard");let s='<button class="card-back-btn" data-card="town">â† Back</button>';return s+='<div class="card-section-title">Town Board</div>',s+='<div class="card-section-desc">Infrastructure projects to develop the town</div>',i.length>0&&(s+='<div class="card-subsection">Active Projects</div>',s+=i.map(a=>{var g,y,f,p,v;const n=a.assignedCitizenUid?(g=this.citizens)==null?void 0:g.getCitizen(a.assignedCitizenUid):null,r=((y=a.objective)==null?void 0:y.current)||0,o=((f=a.objective)==null?void 0:f.required)||1,l=this.getTweenedProgress(a.id),c=n?(p=this.townActions.citizenAssignedTasks)==null?void 0:p.get(a.id):null,d=l??(c==null?void 0:c.progress)??r,u=Math.min(100,d/o*100),h=a.type==="build"&&a.requirements,m=this.townActions.getEligibleCitizens(a);return`
                    <div class="card-task-item accepted townboard">
                        <span class="task-icon">${a.icon}</span>
                        <div class="task-info">
                            <div class="task-name">${a.name}</div>
                            ${h?`
                                <div class="task-requirements">
                                    Requires: ${Object.entries(a.requirements).map(([b,k])=>`${k} ${b}`).join(", ")}
                                </div>
                                <button class="task-complete-btn" data-task-id="${a.id}">Complete Build</button>
                            `:`
                                <div class="task-progress-bar"><div class="fill" data-task-progress="${a.id}" style="transition:none;width:${u}%"></div></div>
                                <div class="task-progress-text" data-task-progress-text="${a.id}">${Math.round(u)}%</div>
                            `}
                            ${n?`
                                <div class="task-assigned">
                                    ${n.icon} ${n.name}
                                    <button class="unassign-task-btn" data-task-id="${a.id}">âœ•</button>
                                </div>
                            `:!h&&m.length>0?`
                                <div class="task-assign-row">
                                    <select class="citizen-select" data-task-id="${a.id}" data-category="townBoard">
                                        <option value="">Assign citizen...</option>
                                        ${m.map(b=>`<option value="${b.uid}">${b.icon} ${b.name}</option>`).join("")}
                                    </select>
                                </div>
                            `:h?"":`
                                <div class="task-no-eligible">
                                    <span class="requires-text">Requires: ${((v=a.requiredRoles)==null?void 0:v.join(", "))||"Any"}</span>
                                </div>
                            `}
                        </div>
                        <button class="task-abandon-btn" data-task-id="${a.id}">âœ•</button>
                    </div>
                `}).join("")),t.length>0?(s+='<div class="card-subsection">Available Projects</div>',s+=t.map(a=>{var c;const n=this._formatReward(a.reward),r=a.hasEligibleCitizen!==!1,o=r?"":"task-unavailable",l=((c=a.requiredRoles)==null?void 0:c.length)>0?`Requires: ${a.requiredRoles.join(", ")}`:"";return`
                    <div class="card-task-item townboard ${o}">
                        <span class="task-icon">${a.icon}</span>
                        <div class="task-info">
                            <div class="task-name">${a.name} ${"â­".repeat(a.difficulty)}</div>
                            <div class="task-desc">${a.description}</div>
                            <div class="task-reward">${n}</div>
                            ${r?"":`<div class="task-requires">${l}</div>`}
                        </div>
                        ${r?`<button class="task-accept-btn" data-task-id="${a.id}">Accept</button>`:`<button class="task-accept-btn" disabled title="${l}">Locked</button>`}
                    </div>
                `}).join("")):i.length===0&&(s+='<div class="panel-empty-state"><span class="empty-text">No projects available</span></div>'),s}renderStorageContent(e){const t=`${e.q},${e.r}`,i=this.state.getStorage(t),s=this.state.getStorageItems(t).filter(l=>l.quantity>0),a=this.state.getEffectiveStorageCapacity(t),n=a>i.maxCapacity,r=this.inventory?this.inventory.getAllItems().filter(l=>["material","trade","consumable","food"].includes(l.category)):[];let o='<button class="card-back-btn" data-card="town">â† Back</button>';return o+='<div class="card-section-title">Town Storage</div>',o+=`<div class="storage-capacity">${i.currentWeight}/${a} items${n?' <span class="capacity-bonus">(+'+(a-i.maxCapacity)+" from facilities)</span>":""}</div>`,o+='<div class="storage-section-header">Stored Items</div>',s.length===0?o+='<div class="panel-empty-state small"><span class="empty-text">Storage is empty</span></div>':o+=s.map(l=>{const c=this.getItemDef(l.itemId);return`
                    <div class="card-storage-item">
                        <span class="storage-icon">${(c==null?void 0:c.icon)||"?"}</span>
                        <div class="storage-name">${(c==null?void 0:c.name)||l.itemId}</div>
                        <div class="storage-qty">Ã—${l.quantity}</div>
                        <button class="storage-withdraw-btn" data-item="${l.itemId}" data-amount="${l.quantity}">Take</button>
                    </div>
                `}).join(""),o+='<div class="storage-section-header">Your Inventory</div>',r.length===0?o+='<div class="panel-empty-state small"><span class="empty-text">No items to deposit</span></div>':o+=r.map(l=>`
                    <div class="card-storage-item deposit">
                        <span class="storage-icon">${l.icon||"?"}</span>
                        <div class="storage-name">${l.name}</div>
                        <div class="storage-qty">Ã—${l.quantity}</div>
                        <button class="storage-deposit-btn" data-item="${l.id}" data-amount="${l.quantity}">Store</button>
                    </div>
                `).join(""),o}renderStablesContent(e){const t=this.getStableDestinations(e);let i='<button class="card-back-btn" data-card="town">â† Back</button>';return i+='<div class="card-section-title">Stables</div>',!t||t.length===0?i+='<div class="panel-empty-state"><span class="empty-text">No destinations available</span></div>':i+=t.map((s,a)=>`
                <div class="card-travel-item">
                    <div class="travel-info">
                        <div class="travel-name">${s.poi.name}</div>
                        <div class="travel-dist">${s.distance} hexes â€¢ ${s.cost}g</div>
                    </div>
                    <button class="travel-btn" data-dest-index="${a}" ${this.state.player.gold<s.cost?"disabled":""}>Travel</button>
                </div>
            `).join(""),i}renderHireContent(e){var n,r;let t=[];const i=(r=(n=this.townEconomy)==null?void 0:n.getOrCreateEconomy)==null?void 0:r.call(n,e);i&&i.population&&(t=i.population.getHireableCitizens()),this._cachedHireAvailable=t;const s={agriculture:"ðŸŒ¾",construction:"ðŸ”¨",medicine:"âš•ï¸",tailoring:"ðŸ§µ",warriors:"âš”ï¸",smithing:"âš’ï¸",rangers:"ðŸ¹"};let a='<button class="card-back-btn" data-card="citizens">â† Back</button>';return a+=`<div class="card-section-title">Town Citizens (${t.length} available)</div>`,t.length===0?a+='<div class="panel-empty-state"><span class="empty-text">No one available to hire</span></div>':(a+='<div class="hire-list-scrollable">',a+=t.map((o,l)=>{const c=o.skills?Object.values(o.skills).reduce((b,k)=>b+k,0):0,d=20+c*10+((o.age||25)>40?15:0),u=3+Math.floor(c/2),h=this.state.player.gold>=d;let m=null,g=0;if(o.skills)for(const[b,k]of Object.entries(o.skills))k>g&&(m=b,g=k);const y=o.skills?Object.entries(o.skills).sort((b,k)=>k[1]-b[1]).map(([b,k])=>`<span class="skill-tag">${s[b]||"â€¢"} ${k}</span>`).join(""):"",f=m&&s[m]||"ðŸ‘¤",v=m&&{agriculture:"Farmer",construction:"Builder",medicine:"Healer",tailoring:"Tailor",warriors:"Guard",smithing:"Smith",rangers:"Ranger"}[m]||"Worker";return`
                <div class="card-hire-item ${h?"":"cant-afford"}">
                    <span class="hire-icon">${f}</span>
                    <div class="hire-info">
                        <div class="hire-name">${o.name}</div>
                        <div class="hire-role">Age ${o.age||"?"} â€¢ ${v}</div>
                        <div class="hire-skills">${y}</div>
                    </div>
                    <div class="hire-costs">
                        <div class="hire-cost">${d}g</div>
                        <div class="hire-wage">${u}g/day</div>
                    </div>
                    <button class="hire-btn" data-hire-index="${l}" data-villager-uid="${o.uid}" ${h?"":"disabled"}>Hire</button>
                </div>
            `}).join(""),a+="</div>"),a}renderCitizenDetailContent(e){var n,r,o,l,c,d,u,h,m;const t=(n=this.citizens)==null?void 0:n.getCitizen(e);if(!t)return'<button class="card-back-btn" data-card="citizens">â† Back</button><div class="panel-empty-state">Citizen not found</div>';const i=t.role||"Worker",s=!!t.assignment;let a=null;if(s&&t.assignment.type==="townTask"){const g=this.townActions.getAcceptedTasks().find(y=>y.id===t.assignment.taskId);if(g){const y=g.category==="volunteer"?"Volunteer":g.category==="townBoard"?"Project":"Work",f=this.getTweenedProgress(g.id),p=(r=this.townActions.citizenAssignedTasks)==null?void 0:r.get(g.id),v=f??(p==null?void 0:p.progress)??((o=g.objective)==null?void 0:o.current)??0;a={type:y,name:g.name,icon:g.icon,taskId:g.id,progress:((l=g.objective)==null?void 0:l.current)||0,fractionalProgress:v,required:((c=g.objective)==null?void 0:c.required)||1}}}else if(s&&t.assignment.type==="quest"){const g=(d=this.quests.activeQuests)==null?void 0:d.find(y=>y.id===t.assignment.questId);g&&(a={type:"Quest",name:g.name,icon:"ðŸ“œ",taskId:g.id,progress:((u=g.objective)==null?void 0:u.current)||g.progress||0,fractionalProgress:((h=g.objective)==null?void 0:h.current)||g.progress||0,required:((m=g.objective)==null?void 0:m.required)||1})}return`
            <button class="card-back-btn" data-card="citizens">â† Back</button>
            <div class="citizen-detail-card">
                <div class="citizen-header">
                    <span class="citizen-icon-large">${t.icon}</span>
                    <div class="citizen-header-info">
                        <div class="citizen-name">${t.name}</div>
                        <div class="citizen-role">${i} â€¢ Lv${t.level||1}</div>
                        <div class="citizen-wage">${t.wage||5}g/day</div>
                    </div>
                </div>

                <div class="citizen-assignment-section">
                    ${a?`
                        <div class="current-task-card">
                            <div class="task-label">${a.type} Task</div>
                            <div class="task-row">
                                <span class="task-icon">${a.icon}</span>
                                <div class="task-info">
                                    <div class="task-name">${a.name}</div>
                                    <div class="task-progress-bar"><div class="fill" data-task-progress="${a.taskId||""}" style="transition:none;width:${Math.min(100,a.fractionalProgress/a.required*100)}%"></div></div>
                                    <div class="task-progress-text">${Math.round(Math.min(100,a.fractionalProgress/a.required*100))}%</div>
                                </div>
                            </div>
                        </div>
                    `:`
                        <div class="idle-status">
                            <span class="idle-icon">ðŸ’¤</span>
                            <span class="idle-text">Idle - assign from Work, Volunteer, or Quests</span>
                        </div>
                    `}
                </div>

                <div class="citizen-footer">
                    <button class="citizen-dismiss-btn" data-citizen-uid="${e}">Dismiss</button>
                </div>
            </div>
        `}getNearbyResources(e){var n;if(!e||!this.grid)return[];const t=[],i=new Set,s=3,a=[{q:e.q,r:e.r,dist:0}];for(i.add(`${e.q},${e.r}`);a.length>0;){const r=a.shift();if(r.dist>s)continue;const o=this.grid.getHex(r.q,r.r);o!=null&&o.poi&&((n=o.poi.type)==null?void 0:n.category)==="resource"&&r.dist>0&&t.push({type:o.poi.type.resource||o.poi.type.id,name:o.poi.type.name||o.poi.name,icon:o.poi.type.icon||"ðŸ“¦",poiKey:`${r.q},${r.r}`,distance:r.dist});const l=this.grid.getNeighbors(r.q,r.r);for(const c of l){const d=`${c.q},${c.r}`;i.has(d)||(i.add(d),a.push({q:c.q,r:c.r,dist:r.dist+1}))}}return t.slice(0,4)}renderJoinGuildContent(){const e=Object.values(z).filter(i=>!this.guilds.isMember(i.id));let t='<button class="card-back-btn" data-card="guilds">â† Back</button>';return t+='<div class="card-section-title">Join Guild</div>',e.length===0?t+='<div class="panel-empty-state"><span class="empty-text">Already in all guilds</span></div>':t+=e.map(i=>`
                <div class="card-guild-item">
                    <span class="guild-icon">${i.icon}</span>
                    <div class="guild-info">
                        <div class="guild-name">${i.name}</div>
                        <div class="guild-focus">${i.focus}</div>
                    </div>
                    <button class="guild-join-btn" data-guild-id="${i.id}">Join</button>
                </div>
            `).join(""),t}renderGuildDetailContent(e){var n;const t=z[e],i=(n=this.guilds)==null?void 0:n.memberships[e];if(!t||!i)return'<button class="card-back-btn" data-card="guilds">â† Back</button><div class="panel-empty-state">Guild not found</div>';const s=this.guilds.getRank(e),a=this.guilds.getCurrentPerks(e);return`
            <button class="card-back-btn" data-card="guilds">â† Back</button>
            <div class="guild-detail-card">
                <div class="guild-header">
                    <span class="guild-icon">${t.icon}</span>
                    <div>
                        <div class="guild-name">${t.name}</div>
                        <div class="guild-rank">${s.name} â€¢ ${i.reputation} rep</div>
                    </div>
                </div>
                <div class="guild-perks">
                    <div class="perks-title">Perks</div>
                    ${a.map(r=>`<div class="perk-item">${r}</div>`).join("")}
                </div>
            </div>
        `}handleTownCardActions(e){var f,p,v,b,k;const t=this._townModalPoi,i=e.target.closest(".task-accept-btn");if(i){const w=i.dataset.taskId,x=(f=this.townActions.availableTasks)==null?void 0:f.find(C=>C.id===w);if(x&&this.townActions.acceptTask(w)){const C=x.category==="townBoard"?"townBoard":x.category==="volunteer"?"volunteer":"work";this.updateTownCard(C)}return}const s=e.target.closest(".task-abandon-btn");if(s){const w=s.dataset.taskId,x=(p=this.townActions.acceptedTasks)==null?void 0:p.find(C=>C.id===w);if(x){const C=x.category==="townBoard"?"townBoard":x.category==="volunteer"?"volunteer":"work";this.townActions.abandonTask(w),this.updateTownCard(C),this.updateCitizensCard("main")}return}const a=e.target.closest(".unassign-task-btn");if(a){const w=a.dataset.taskId,x=(v=this.townActions.acceptedTasks)==null?void 0:v.find(C=>C.id===w);if(x&&x.assignedCitizenUid){this.citizens&&this.citizens.unassign(x.assignedCitizenUid),this.townActions.unassignCitizenFromTask(w);const C=x.category==="townBoard"?"townBoard":x.category==="volunteer"?"volunteer":"work";this.updateTownCard(C),this.updateCitizensCard("main")}return}const n=e.target.closest(".task-complete-btn");if(n){const w=n.dataset.taskId;this.townActions.completeBuildTask(w,this.inventory)&&(this.updateTownCard("townBoard"),this.updateUI());return}const r=e.target.closest(".shop-buy-btn");if(r&&!r.disabled){const w=parseInt(r.dataset.itemIndex),C=this.getShopInventory(t)[w];if(C){const _=this.getItemDef(C.id),M=Math.ceil(_.value*C.markup);this.state.player.gold>=M&&C.stock>0&&(this.state.player.gold-=M,this.inventory.add(C.id,1),C.stock--,this.updateTownCard("shop"),this.updateUI())}return}const o=e.target.closest(".shop-sell-btn");if(o&&!o.disabled){const w=o.dataset.itemId,x=parseInt(o.dataset.sellPrice);if(this.inventory.has(w)){this.inventory.remove(w,1),this.state.player.gold+=x;const C=this.getItemDef(w);this.state.addLog(`Sold ${(C==null?void 0:C.name)||w} for ${x}g`,"success"),this.updateTownCard("shop"),this.updateUI()}return}const l=e.target.closest(".storage-withdraw-btn");if(l){const w=l.dataset.item,x=parseInt(l.dataset.amount),C=`${t.q},${t.r}`,_=this.inventory.canAdd(w,x);if(!_.can){this.state.addLog(_.reason,"warning");return}const M=this.state.removeFromStorage(C,w,x);if(M>0){this.inventory.add(w,M);const S=this.getItemDef(w);this.state.addLog(`Took ${M}Ã— ${(S==null?void 0:S.name)||w} from storage`,"success"),this.updateTownCard("storage"),this.updateUI()}return}const c=e.target.closest(".storage-deposit-btn");if(c){const w=c.dataset.item,x=parseInt(c.dataset.amount),C=`${t.q},${t.r}`;if(this.inventory.remove(w,x)){this.state.addToStorage(C,w,x);const _=this.getItemDef(w);this.state.addLog(`Stored ${x}Ã— ${(_==null?void 0:_.name)||w}`,"success"),this.updateTownCard("storage"),this.updateUI()}return}const d=e.target.closest(".travel-btn");if(d&&!d.disabled){const w=parseInt(d.dataset.destIndex),C=this.getStableDestinations(t)[w];C&&this.state.player.gold>=C.cost&&(this.state.player.gold-=C.cost,this.state.player.position={q:C.poi.q,r:C.poi.r},this.state.player.currentPOI=C.poi,this.hideModal(),this.updateUI());return}const u=e.target.closest(".hire-btn");if(u&&!u.disabled){const w=parseInt(u.dataset.hireIndex);u.dataset.villagerUid;const C=(this._cachedHireAvailable||[])[w];if(C){const _=C.skills?Object.values(C.skills).reduce((q,U)=>q+U,0):0,M=20+_*10+((C.age||25)>40?15:0),S=3+Math.floor(_/2),A={uid:C.uid,name:C.name,age:C.age,icon:this.getSkillIcon(C.skills),role:this.getSkillRole(C.skills),level:1,skills:C.skills||{},hireCost:M,wage:S,morale:C.morale||80,energy:100,maxCarryWeight:15+Math.floor(_*2)};if(this.citizens.hire(A,t)){const q=(k=(b=this.townEconomy)==null?void 0:b.getOrCreateEconomy)==null?void 0:k.call(b,t);q&&q.population&&q.population.markAsHired(C.uid),this.updateCitizensCard("hire"),this.updateUI()}}return}const h=e.target.closest(".citizen-dismiss-btn");if(h){const w=h.dataset.citizenUid;confirm("Dismiss this citizen?")&&(this.citizens.dismiss(w),this.updateCitizensCard("main"),this.updateUI());return}const m=e.target.closest(".assign-btn");if(m){const w=m.dataset.citizenUid,x=m.dataset.resource,C=m.dataset.poiKey;this.citizens.assignCitizen(w,{type:"gather",resourceType:x,poiKey:C})&&this.updateCitizensCard("detail",w);return}const g=e.target.closest(".unassign-btn");if(g){const w=g.dataset.citizenUid;this.citizens.unassignCitizen(w)&&this.updateCitizensCard("detail",w);return}const y=e.target.closest(".guild-join-btn");if(y){const w=y.dataset.guildId;this.guilds.join(w)&&(this.updateGuildsCard("main"),this.updateUI());return}}updateInventoryUI(){const e=this.ui,t=this.inventory,i=t.currentWeight,s=t.maxWeight;e.inventoryWeight.textContent=`${i}/${s}`,e.inventoryWeight.classList.toggle("over-weight",i>=s*.9);const a=t.getAllItems();let n="";const r=t.has("torch"),o=this.state.equippedTorch;if(o||r){const c=t.getQuantity("torch");let d="";o?d=`<span class="torch-lit">ðŸ”¥ Lit (${Math.round((1-o.currentBurn/o.burnDuration)*100)}%)</span>`:d='<span class="torch-unlit">ðŸ’¤ Unlit</span>',n=`
                <div class="torch-status">
                    <span class="torch-icon">ðŸ”¦</span>
                    <span class="torch-count">Ã—${c+(o?1:0)}</span>
                    ${d}
                    <button class="torch-btn" id="torch-toggle-btn">
                        ${o?"Extinguish":"Light"}
                    </button>
                </div>
            `}if(a.length===0&&!n){e.inventoryItems.innerHTML='<div class="inventory-empty">Empty</div>';return}e.inventoryItems.innerHTML=n+a.map(c=>`
            <div class="inventory-item ${c.category}" data-item-id="${c.id}">
                <span class="inv-icon">${c.icon}</span>
                <span class="inv-name">${c.name}</span>
                <span class="inv-quantity">Ã—${c.quantity}</span>
                <span class="inv-weight">${c.totalWeight}kg</span>
            </div>
        `).join(""),e.inventoryItems.querySelectorAll(".inventory-item").forEach(c=>{const d=c.dataset.itemId,u=this.getItemDef(d);u&&(c.addEventListener("mouseenter",h=>{this.showItemTooltip(u,h.clientX,h.clientY)}),c.addEventListener("mousemove",h=>{const m=document.getElementById("item-tooltip");if(m&&!m.classList.contains("hidden")){const g=window.innerWidth-260,y=window.innerHeight-m.offsetHeight-10;m.style.left=`${Math.min(h.clientX+10,g)}px`,m.style.top=`${Math.min(h.clientY+10,y)}px`}}),c.addEventListener("mouseleave",()=>{this.hideItemTooltip()}))});const l=document.getElementById("torch-toggle-btn");l&&l.addEventListener("click",()=>{this.state.equippedTorch?this.unequipTorch():this.equipTorch(),this.updateInventoryUI()}),e.inventoryItems.querySelectorAll(".inventory-item.consumable, .inventory-item.food").forEach(c=>{c.addEventListener("click",()=>{const d=c.dataset.itemId;this.inventory.useConsumable(d)})}),e.inventoryItems.querySelectorAll(".inventory-item.usable").forEach(c=>{c.addEventListener("click",()=>{const d=c.dataset.itemId;this.useItem(d)})})}updateCitizensUI(){}updateGuildsUI(){}showModal(e,t,i={}){const s=!this.ui.gameModal.classList.contains("hidden");this.ui.modalTitle.textContent=e,this.ui.modalBody.innerHTML=t,this.ui.gameModal.classList.remove("closing"),s?this.ui.gameModal.classList.add("no-animate"):this.ui.gameModal.classList.remove("no-animate"),this.ui.gameModal.classList.remove("hidden"),this.modalUncloseable=i.uncloseable||!1,this.ui.modalClose&&(this.ui.modalClose.style.display=this.modalUncloseable?"none":"");const a=this.ui.gameModal.querySelector(".modal-header");let n=a.querySelector(".modal-back");i.backAction?(n||(n=document.createElement("button"),n.className="modal-back",n.innerHTML="â†",a.insertBefore(n,a.firstChild)),n.style.display="",n.onclick=i.backAction):n&&(n.style.display="none")}hideModal(){this.modalUncloseable||this.animateModalClose()}forceHideModal(){this.modalUncloseable=!1,this.ui.modalClose&&(this.ui.modalClose.style.display=""),this.animateModalClose(!0)}animateModalClose(e=!1){if(this.ui.gameModal.classList.contains("closing")||this.ui.gameModal.classList.contains("hidden")){e&&(this.ui.gameModal.classList.remove("closing"),this.ui.gameModal.classList.add("hidden"));return}this.ui.gameModal.classList.remove("no-animate"),this.ui.gameModal.classList.add("closing"),setTimeout(()=>{this.ui.gameModal.classList.remove("closing"),this.ui.gameModal.classList.add("hidden")},200)}closeModalInstant(){this.ui.gameModal.classList.remove("closing"),this.ui.gameModal.classList.add("hidden")}showCraftingModal(e="all"){const t=this.state.player.currentPOI,i=this.state.knownRecipes||new Set,s=Object.values(Oe).filter(d=>i.has(d.id));if(s.length===0){this.state.addLog("You don't know any recipes yet","info");return}const a=["all",...new Set(s.map(d=>d.category))],n={all:"All",materials:"Materials",consumables:"Items",food:"Food",weapons:"Weapons",armor:"Armor",tools:"Tools",alchemy:"Alchemy"},r=a.map(d=>`
            <button class="crafting-tab ${d===e?"active":""}" data-category="${d}">
                ${n[d]||d}
            </button>
        `).join(""),l=(e==="all"?s:s.filter(d=>d.category===e)).map(d=>{const u=d.ingredients.map(f=>{const p=D[f.item];return`<span class="${this.inventory.getCount(f.item)>=f.quantity?"has":"missing"}">${f.quantity}x ${(p==null?void 0:p.name)||f.item}</span>`}).join(", "),h=d.ingredients.every(f=>this.inventory.getCount(f.item)>=f.quantity),m=Ss(d,t),g=h&&m;let y="";return d.station&&(y=`<div class="recipe-station">${{forge:"ðŸ”¨ Forge required",alchemy:"âš—ï¸ Alchemy table required",cooking:"ðŸ”¥ Fire required",workbench:"ðŸ”§ Workbench required"}[d.station]||d.station}${m?" âœ“":""}</div>`),`
                <div class="recipe-item ${g?"craftable":""}">
                    <span class="recipe-icon">${d.icon}</span>
                    <div class="recipe-info">
                        <div class="recipe-name">${d.name} ${d.result.quantity>1?`(x${d.result.quantity})`:""}</div>
                        <div class="recipe-ingredients">${u}</div>
                        ${y}
                    </div>
                    <button class="craft-btn" data-recipe="${d.id}" ${g?"":"disabled"}>
                        Craft
                    </button>
                </div>
            `}).join(""),c=`
            <div class="crafting-content">
                <div class="crafting-tabs">${r}</div>
                <div class="crafting-recipes">${l||'<div style="color:#707070;text-align:center;padding:20px;">No recipes in this category</div>'}</div>
            </div>
        `;this.showModal("Crafting",c),this.ui.modalBody.querySelectorAll(".crafting-tab").forEach(d=>{d.addEventListener("click",()=>{this.showCraftingModal(d.dataset.category)})}),this.ui.modalBody.querySelectorAll(".craft-btn").forEach(d=>{d.addEventListener("click",()=>{const u=Oe[d.dataset.recipe];u&&this.inventory.craft(u)&&this.showCraftingModal(e)})})}showChestModal(e){if(!e)return;const t=this.grid.getCell(e.q,e.r);if(!t||!this.hexActions.hasChest(t)){this.state.addLog("No chest here","warning");return}const i=this.hexActions.openChest(t);if(!i){this.state.addLog("Chest is empty","info");return}const s=rt[e.type];let a="";for(const l of i.items){const c=D[l.item];c&&(a+=`
                    <div class="chest-loot-item">
                        <span class="loot-icon">${c.icon}</span>
                        <span class="loot-name">${l.quantity>1?`${l.quantity}x `:""}${c.name}</span>
                    </div>
                `)}let n="";if(i.recipe){const l=Oe[i.recipe];l&&(n=`
                    <div class="chest-loot-recipe">
                        <span class="loot-icon">ðŸ“œ</span>
                        <span class="loot-name">Recipe: ${l.name}</span>
                    </div>
                `)}const r=`
            <div class="chest-content">
                <div class="chest-header">
                    <span class="chest-icon">${(s==null?void 0:s.icon)||"ðŸ§°"}</span>
                    <span class="chest-title">You found a ${(s==null?void 0:s.name)||"Chest"}!</span>
                </div>
                <div class="chest-gold">
                    <span>ðŸ’°</span>
                    <span>${i.gold} Gold</span>
                </div>
                <div class="chest-items">
                    ${a}
                    ${n}
                </div>
                <button class="chest-take-all-btn" id="chest-take-all">Take All</button>
            </div>
        `;this.showModal("Chest Found!",r);const o=document.getElementById("chest-take-all");o&&o.addEventListener("click",()=>{this.state.player.gold+=i.gold;for(const l of i.items)this.inventory.add(l.item,l.quantity);if(i.recipe&&this.state.learnRecipe&&this.state.learnRecipe(i.recipe)){const c=Oe[i.recipe];this.state.addLog(`Learned recipe: ${(c==null?void 0:c.name)||i.recipe}!`,"discovery")}this.state.addLog(`Looted ${(s==null?void 0:s.name)||"chest"}: ${i.gold}g and ${i.items.length} items`,"success"),this.hideModal(),this.render()})}showHireModal(){var n,r;const e=this.state.player.currentPOI;if(!e)return;let t=[];const i=(r=(n=this.townEconomy)==null?void 0:n.getOrCreateEconomy)==null?void 0:r.call(n,e);if(i&&i.population&&(t=i.population.getHireableCitizens()),t.length===0){this.state.addLog("No one available for hire here","info");return}const s={agriculture:"ðŸŒ¾",construction:"ðŸ”¨",medicine:"âš•ï¸",tailoring:"ðŸ§µ",warriors:"âš”ï¸",smithing:"âš’ï¸",rangers:"ðŸ¹"},a=`
            <div class="hire-list" style="max-height: 400px; overflow-y: auto;">
                ${t.map((o,l)=>{const c=o.skills?Object.values(o.skills).reduce((g,y)=>g+y,0):0,d=20+c*10+((o.age||25)>40?15:0),u=3+Math.floor(c/2),h=this.state.player.gold>=d,m=o.skills?Object.entries(o.skills).sort((g,y)=>y[1]-g[1]).map(([g,y])=>`<span class="skill-tag">${s[g]||"â€¢"} ${g}: ${y}</span>`).join(""):"";return`
                    <div class="hire-citizen ${h?"":"cant-afford"}" data-index="${l}">
                        <div class="hire-header">
                            <span class="hire-icon">${this.getSkillIcon(o.skills)}</span>
                            <span class="hire-name">${o.name}</span>
                            <span class="hire-cost">${d}g</span>
                        </div>
                        <div class="hire-role">Age ${o.age||"?"} â€¢ ${this.getSkillRole(o.skills)}</div>
                        <div class="hire-skills">${m}</div>
                        <div class="hire-wage">Wage: ${u}g/day</div>
                        <button class="hire-btn" data-index="${l}" data-villager-uid="${o.uid}" ${h?"":"disabled"}>
                            Hire
                        </button>
                    </div>
                `}).join("")}
            </div>
        `;this.showModal(`Hire Citizens (${t.length} available)`,a,{backAction:()=>this.showLocationActionsModal(e)}),this._hireAvailable=t,this._hirePoi=e,this.ui.modalBody.querySelectorAll(".hire-btn").forEach(o=>{o.addEventListener("click",l=>{var u,h;l.stopPropagation();const c=parseInt(o.dataset.index),d=this._hireAvailable[c];if(d){const m=d.skills?Object.values(d.skills).reduce((p,v)=>p+v,0):0,g=20+m*10+((d.age||25)>40?15:0),y=3+Math.floor(m/2),f={uid:d.uid,name:d.name,age:d.age,icon:this.getSkillIcon(d.skills),role:this.getSkillRole(d.skills),level:1,skills:d.skills||{},hireCost:g,wage:y,morale:d.morale||80,energy:100,maxCarryWeight:15+Math.floor(m*2)};if(this.citizens.hire(f,this._hirePoi)){const p=(h=(u=this.townEconomy)==null?void 0:u.getOrCreateEconomy)==null?void 0:h.call(u,this._hirePoi);p&&p.population&&p.population.markAsHired(d.uid),this.triggerLexicon("hire_citizen"),this.showHireModal(),this.updateCitizensUI()}}})})}showCitizensManagementModal(){var o,l;const e=this.state.player.currentPOI;if(!e)return;const t=this.citizens.citizens,i=this.citizens.maxHiredWorkers;let s=[];const a=(l=(o=this.townEconomy)==null?void 0:o.getOrCreateEconomy)==null?void 0:l.call(o,e);a&&a.population&&(s=a.population.getHireableCitizens());const n=`
            <div class="management-modal">
                <div class="management-section">
                    <div class="section-header">
                        <span class="section-title">Your Citizens</span>
                        <span class="section-count">${t.length}/${i}</span>
                    </div>
                    ${t.length===0?`
                        <div class="empty-message">No citizens hired yet</div>
                    `:`
                        <div class="citizen-list modal-list">
                            ${t.map(c=>{const u={idle:"ðŸ’¤",traveling_to_resource:"ðŸš¶",gathering:"â›ï¸",traveling_to_storage:"ðŸš¶",depositing:"ðŸ“¦"}[c.state]||"";return`
                                    <div class="modal-item citizen-row" data-uid="${c.uid}">
                                        <span class="item-icon">${c.icon}</span>
                                        <div class="item-info">
                                            <div class="item-name">${c.name} <span class="level-badge">Lv${c.level}</span></div>
                                            <div class="item-desc">${c.role||"Worker"} ${u}</div>
                                        </div>
                                        <div class="item-meta">${c.wage}g/day</div>
                                    </div>
                                `}).join("")}
                        </div>
                    `}
                </div>
                <div class="management-actions">
                    <button class="management-btn hire-btn-action" ${s.length===0?'disabled title="No one available for hire"':""} ${t.length>=i?'disabled title="Max citizens reached"':""}>
                        <span class="btn-icon">âž•</span>
                        <span class="btn-text">Hire Citizens</span>
                        <span class="btn-badge">${s.length} available</span>
                    </button>
                </div>
            </div>
        `;this.showModal("ðŸ‘¥ Citizens",n,{backAction:()=>this.showLocationActionsModal(e)}),this.ui.modalBody.querySelectorAll(".citizen-row").forEach(c=>{c.addEventListener("click",()=>{const d=parseInt(c.dataset.uid);this.showCitizenModal(d)})});const r=this.ui.modalBody.querySelector(".hire-btn-action");r&&!r.disabled&&r.addEventListener("click",()=>{this.showHireModal()})}showGuildsManagementModal(){const e=this.state.player.currentPOI,t=this.guilds.memberships,i=Object.keys(t).length,s=Object.values(z).filter(o=>!this.guilds.isMember(o.id)),a=this.guilds.activeContracts||[],n=`
            <div class="management-modal">
                <div class="management-section">
                    <div class="section-header">
                        <span class="section-title">Guild Memberships</span>
                        <span class="section-count">${i}</span>
                    </div>
                    ${i===0?`
                        <div class="empty-message">Not a member of any guild</div>
                    `:`
                        <div class="guild-list modal-list">
                            ${Object.entries(t).map(([o,l])=>{const c=z[o],d=this.guilds.getRank(o);return`
                                    <div class="modal-item guild-row" data-guild="${o}">
                                        <span class="item-icon">${c.icon}</span>
                                        <div class="item-info">
                                            <div class="item-name">${c.name}</div>
                                            <div class="item-desc">${d.name} â€¢ ${l.reputation} rep</div>
                                        </div>
                                    </div>
                                `}).join("")}
                        </div>
                    `}
                </div>
                ${a.length>0?`
                    <div class="management-section">
                        <div class="section-header">
                            <span class="section-title">Active Contracts</span>
                            <span class="section-count">${a.length}</span>
                        </div>
                        <div class="contracts-list modal-list">
                            ${a.map(o=>{var l;return`
                                <div class="modal-item contract-row">
                                    <span class="item-icon">ðŸ“œ</span>
                                    <div class="item-info">
                                        <div class="item-name">${o.name}</div>
                                        <div class="item-desc">${o.progress||0}/${((l=o.requirement)==null?void 0:l.amount)||"?"}</div>
                                    </div>
                                </div>
                            `}).join("")}
                        </div>
                    </div>
                `:""}
                <div class="management-actions">
                    <button class="management-btn join-guild-action" ${s.length===0?'disabled title="Already in all guilds"':""}>
                        <span class="btn-icon">ðŸ›ï¸</span>
                        <span class="btn-text">Join Guild</span>
                        <span class="btn-badge">${s.length} available</span>
                    </button>
                </div>
            </div>
        `;this.showModal("ðŸ›ï¸ Guilds",n,{backAction:()=>this.showLocationActionsModal(e)}),this.ui.modalBody.querySelectorAll(".guild-row").forEach(o=>{o.addEventListener("click",()=>{const l=o.dataset.guild;this.showGuildModal(l)})});const r=this.ui.modalBody.querySelector(".join-guild-action");r&&!r.disabled&&r.addEventListener("click",()=>{this.showJoinGuildModal()})}showCitizenModal(e){const t=this.citizens.getCitizen(e);if(!t)return;const i=this.getCitizenAssignmentOptions(t),s=this.citizens.getCarryWeight(t),a=Math.min(100,s/t.maxCarryWeight*100),n={idle:"Idle",exhausted:"Exhausted",traveling_to_resource:"Traveling to work...",gathering:"Gathering resources",traveling_to_storage:"Returning to storage...",depositing:"Depositing items"},o=(t.energy||100)<10?"exhausted":t.state,l=n[o]||o,c=`
            <div class="citizen-detail">
                <div class="detail-header">
                    <span class="detail-icon">${t.icon}</span>
                    <div>
                        <div class="detail-name">${t.name}</div>
                        <div class="detail-role">${t.role} â€¢ Level ${t.level}</div>
                    </div>
                </div>

                <div class="citizen-state-badge ${o}">${l}</div>

                <div class="detail-stats">
                    <div class="detail-row">
                        <span>Energy</span>
                        <div class="detail-bar"><div class="detail-fill energy" style="width:${t.energy}%"></div></div>
                        <span>${t.energy}%</span>
                    </div>
                    <div class="detail-row">
                        <span>Morale</span>
                        <div class="detail-bar"><div class="detail-fill morale" style="width:${t.morale}%"></div></div>
                        <span>${t.morale}%</span>
                    </div>
                    <div class="detail-row">
                        <span>Experience</span>
                        <div class="detail-bar"><div class="detail-fill exp" style="width:${t.experience/(t.level*100)*100}%"></div></div>
                        <span>${t.experience}/${t.level*100}</span>
                    </div>
                    <div class="detail-row">
                        <span>Carrying</span>
                        <div class="detail-bar"><div class="detail-fill carry" style="width:${a}%"></div></div>
                        <span>${s}/${t.maxCarryWeight}</span>
                    </div>
                </div>

                ${t.inventory.length>0?`
                    <div class="citizen-inventory">
                        <div class="inventory-header">Inventory</div>
                        <div class="inventory-items-mini">
                            ${t.inventory.map(h=>{const m=this.getItemDef(h.itemId);return`<span class="inv-item">${(m==null?void 0:m.icon)||"?"} ${(m==null?void 0:m.name)||h.itemId} x${h.quantity}</span>`}).join("")}
                        </div>
                    </div>
                `:""}

                <div class="detail-skills">
                    <div class="skills-header">Skills</div>
                    ${Object.entries(t.skills).map(([h,m])=>`<div class="skill-row"><span>${h}</span><span>${m}</span></div>`).join("")}
                </div>
                <div class="detail-wage">Daily wage: ${t.wage}g</div>

                <div class="citizen-assignment-section">
                    <div class="assignment-header">Assignment</div>
                    ${t.assignment?`
                        <div class="current-assignment">
                            <span class="assignment-icon">${this.getAssignmentIcon(t.assignment.type)}</span>
                            <span class="assignment-text">${this.formatAssignment(t.assignment)}</span>
                            <button class="unassign-btn" data-uid="${e}">Stop</button>
                        </div>
                    `:`
                        <div class="assignment-options">
                            ${i.length>0?i.map((h,m)=>`
                                <button class="assign-btn" data-uid="${e}" data-index="${m}" ${t.energy<10?'disabled title="Too tired"':""}>
                                    <span class="assign-icon">${h.icon}</span>
                                    <span class="assign-text">${h.name}</span>
                                </button>
                            `).join(""):'<div class="no-assignments">No tasks available for this role</div>'}
                        </div>
                    `}
                </div>

                <div class="detail-actions">
                    <button class="modal-btn dismiss-btn" data-uid="${e}">Dismiss</button>
                </div>
            </div>
        `,d=this.state.player.currentPOI;this.showModal("Citizen Details",c,{backAction:d?()=>this.showLocationActionsModal(d):null}),this._citizenAssignmentOptions=i,this.ui.modalBody.querySelectorAll(".assign-btn").forEach(h=>{h.addEventListener("click",()=>{const m=parseInt(h.dataset.index),g=this._citizenAssignmentOptions[m];this.citizens.assign(e,g.assignment)&&this.showCitizenModal(e)})});const u=this.ui.modalBody.querySelector(".unassign-btn");u&&u.addEventListener("click",()=>{this.citizens.unassign(e),this.showCitizenModal(e)}),this.ui.modalBody.querySelector(".dismiss-btn").addEventListener("click",()=>{confirm(`Dismiss ${t.name}?`)&&(this.citizens.dismiss(e),this.hideModal(),this.updateCitizensUI())})}getCitizenAssignmentOptions(e){var r;const t=[],i=this.state.player.position,s=this.state.player.currentPOI,a=(r=e.role)==null?void 0:r.toLowerCase();let n="Wood";switch(s&&s.data&&s.data.output&&(n=s.data.output),a){case"gatherer":case"farmer":t.push({name:`Gather ${n}`,icon:"ðŸ§º",assignment:{type:"gather",poiKey:`${i.q},${i.r}`,resourceType:n}});break;case"crafter":case"smith":case"builder":s&&s.type.category==="settlement"&&t.push({name:"Craft at Workshop",icon:"ðŸ”¨",assignment:{type:"craft",location:`${i.q},${i.r}`}});break;case"merchant":case"tailor":s&&s.type.category==="settlement"&&t.push({name:"Trade Goods",icon:"ðŸ’°",assignment:{type:"trade",location:`${i.q},${i.r}`}});break;case"guard":t.push({name:"Patrol Area",icon:"ðŸ›¡ï¸",assignment:{type:"patrol",location:`${i.q},${i.r}`}});break;case"scout":case"ranger":t.push({name:"Scout Surroundings",icon:"ðŸ”­",assignment:{type:"scout",location:`${i.q},${i.r}`}});break;case"healer":s&&s.type.category==="settlement"&&t.push({name:"Tend to Wounded",icon:"ðŸ’Š",assignment:{type:"heal",location:`${i.q},${i.r}`}});break;case"worker":t.push({name:`Gather ${n}`,icon:"ðŸ§º",assignment:{type:"gather",poiKey:`${i.q},${i.r}`,resourceType:n}});break}return t}getAssignmentIcon(e){return{gather:"ðŸ§º",craft:"ðŸ”¨",trade:"ðŸ’°",patrol:"ðŸ›¡ï¸",scout:"ðŸ”­",heal:"ðŸ’Š"}[e]||"ðŸ“‹"}getItemDef(e){return D[e]||null}generateItemTooltip(e){const t=e.category==="consumable"||e.category==="food"||e.category==="usable"||e.category==="relic";let i=`<div class="item-tooltip">
            <div class="tooltip-header">
                <span class="tooltip-icon">${e.icon}</span>
                <div>
                    <div class="tooltip-title">${e.name}</div>
                    <div class="tooltip-category">${e.category}${e.raw?" (raw)":""}</div>
                </div>
            </div>`;if(e.description&&(i+=`<div class="tooltip-desc">${e.description}</div>`),e.effect&&(i+='<div class="tooltip-effects">',e.effect.health&&(i+=`<span class="effect-hp">+${e.effect.health} HP</span>`),e.effect.stamina&&(i+=`<span class="effect-sta">+${e.effect.stamina} STA</span>`),e.effect.ether&&(i+=`<span class="effect-eth">+${e.effect.ether} ETH</span>`),i+="</div>"),e.cures&&e.cures.length>0&&(i+=`<div class="tooltip-cures">Cures: ${e.cures.join(", ")}</div>`),e.buffs&&e.buffs.length>0){i+='<div class="tooltip-buffs">';for(const s of e.buffs){const a=Math.floor(s.duration/60);i+=`<span class="buff">${s.type} +${Math.round(s.value*100)}% (${a}m)</span>`}i+="</div>"}if(e.bonus){i+='<div class="tooltip-bonus">';for(const[s,a]of Object.entries(e.bonus))i+=`<span>${s}: +${Math.round((a-1)*100)}%</span>`;i+="</div>"}return i+=`<div class="tooltip-footer">
            <span class="tooltip-value">Value: ${e.value}g</span>
            ${t?'<span class="tooltip-usable">Click to use</span>':""}
        </div>`,i+="</div>",i}showItemTooltip(e,t,i){const s=document.getElementById("item-tooltip");if(!s)return;s.innerHTML=this.generateItemTooltip(e),s.classList.remove("hidden");const a=s.getBoundingClientRect(),n=window.innerWidth-260,r=window.innerHeight-a.height-10;s.style.left=`${Math.min(t+10,n)}px`,s.style.top=`${Math.min(i+10,r)}px`}hideItemTooltip(){const e=document.getElementById("item-tooltip");e&&e.classList.add("hidden")}formatAssignment(e){return{gather:"Gathering resources",craft:"Crafting items",trade:"Trading goods",patrol:"Patrolling area",scout:"Scouting surroundings",heal:"Tending to wounded"}[e.type]||e.type}showJoinGuildModal(){const e=Object.values(z).filter(s=>!this.guilds.isMember(s.id));if(e.length===0){this.state.addLog("Already a member of all available guilds","info");return}const t=`
            <div class="guild-join-list">
                <p class="join-intro">Choose a guild to join:</p>
                ${e.map(s=>`
                    <div class="guild-option" data-guild="${s.id}">
                        <div class="guild-option-header">
                            <span class="guild-option-icon">${s.icon}</span>
                            <div class="guild-option-info">
                                <div class="guild-option-name">${s.name}</div>
                                <div class="guild-option-focus">${s.focus}</div>
                            </div>
                        </div>
                        <div class="guild-option-desc">${s.description}</div>
                        <div class="guild-option-perk">First perk: ${s.perks[1].name} - ${s.perks[1].description}</div>
                        <button class="join-guild-action" data-guild="${s.id}">Join</button>
                    </div>
                `).join("")}
            </div>
        `,i=this.state.player.currentPOI;this.showModal("Join a Guild",t,{backAction:i?()=>this.showLocationActionsModal(i):null}),this.ui.modalBody.querySelectorAll(".join-guild-action").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.guild;this.guilds.join(a)&&(i?this.showLocationActionsModal(i):this.hideModal(),this.updateGuildsUI())})})}showGuildModal(e){const t=z[e],i=this.guilds.memberships[e];if(!t||!i)return;const s=this.guilds.getRank(e),a=this.guilds.getCurrentPerks(e),n=this.state.player.currentPOI,r=n?this.guilds.generateContracts(e,n):[],o=`
            <div class="guild-detail">
                <div class="detail-header">
                    <span class="detail-icon">${t.icon}</span>
                    <div>
                        <div class="detail-name">${t.name}</div>
                        <div class="detail-role">${s.name} â€¢ ${i.reputation} rep</div>
                    </div>
                </div>
                <div class="guild-focus">Focus: ${t.focus}</div>
                <div class="guild-perks">
                    <div class="perks-header">Current Perks</div>
                    ${a.map(l=>`<div class="perk-row">${l}</div>`).join("")}
                </div>
                ${r.length>0?`
                    <div class="guild-contracts">
                        <div class="contracts-header">Available Contracts</div>
                        ${r.map((l,c)=>`
                            <div class="contract-offer">
                                <div class="offer-name">${l.name}</div>
                                <div class="offer-desc">${l.description}</div>
                                <div class="offer-rewards">
                                    +${l.reward.reputation} rep, +${l.reward.gold}g
                                </div>
                                <button class="accept-contract-btn" data-index="${c}">Accept</button>
                            </div>
                        `).join("")}
                    </div>
                `:'<div class="no-contracts">No contracts available here</div>'}
            </div>
        `;this.showModal("Guild Details",o,{backAction:n?()=>this.showLocationActionsModal(n):null}),this._guildContracts=r,this._guildDetailPoi=n,this.ui.modalBody.querySelectorAll(".accept-contract-btn").forEach(l=>{l.addEventListener("click",()=>{const c=parseInt(l.dataset.index),d=this._guildContracts[c];this.guilds.acceptContract(d)&&(this._guildDetailPoi?this.showLocationActionsModal(this._guildDetailPoi):this.hideModal(),this.updateGuildsUI())})})}startTownAction(e){const t=this.state.player.currentPOI;if(console.log("startTownAction:",e,"POI:",t),!t){console.error("No currentPOI set!"),this.state.addLog("You must be in a settlement to do this.","warning");return}if(e==="work"){this.showWorkTasksModal(t);return}if(e==="volunteer"){this.showVolunteerTasksModal(t);return}}showWorkTasksModal(e){var c,d;const t=this.townActions.generateWorkTasks(e),i=this.townActions.getAcceptedTasks().filter(u=>!u.isVolunteer);this.townActions.generateDeliveryJobs(e,this.pois);const s=this.townActions.getAvailableDeliveries(),a=this.townActions.getActiveDelivery();let n=`
            <div class="task-modal">
                <div class="task-header">
                    <h3>Available Work</h3>
                    <div class="task-stats">Completed today: ${this.townActions.getCompletedToday()}/5</div>
                </div>
        `;if(a){const u=a.toPoi,h=e&&e.q===u.q&&e.r===u.r,m=this.inventory.has(a.packageType.itemId,1);if(h&&m&&this.townActions.completeDelivery(this.inventory)){this.updateCompass(),setTimeout(()=>this.showWorkTasksModal(e),100);return}n+=`
                <div class="task-section delivery-section">
                    <h4>ðŸ“¦ Active Delivery</h4>
                    <div class="task-item accepted delivery ${h?"at-destination":""}">
                        <div class="task-icon">${a.packageType.icon}</div>
                        <div class="task-info">
                            <div class="task-name">Deliver ${a.packageType.name}</div>
                            <div class="task-desc">To: ${a.toPoi.name}</div>
                            ${h?'<div class="task-requirement success">âœ“ You are at the destination!</div>':`<div class="task-requirement">âš ï¸ Bandit risk: ${Math.floor(a.banditChance*100)}%</div>`}
                            ${m?"":'<div class="task-requirement danger">âœ— Package missing!</div>'}
                        </div>
                        <div class="task-reward">+${a.reward}g</div>
                        ${h&&m?'<button class="task-btn complete" data-delivery-complete="true">Complete</button>':'<button class="task-btn abandon" data-delivery-abandon="true">Abandon</button>'}
                    </div>
                </div>
            `}!a&&s.length>0&&(n+=`
                <div class="task-section delivery-section">
                    <h4>ðŸ“¦ Delivery Jobs</h4>
                    ${s.map(u=>`
                        <div class="task-item delivery">
                            <div class="task-icon">${u.packageType.icon}</div>
                            <div class="task-info">
                                <div class="task-name">Deliver ${u.packageType.name}</div>
                                <div class="task-desc">To: ${u.toPoi.name} (~${u.distance} hexes)</div>
                                <div class="task-requirement">âš ï¸ Bandit risk: ${Math.floor(u.banditChance*100)}%</div>
                            </div>
                            <div class="task-reward">+${u.reward}g</div>
                            <button class="task-btn accept" data-delivery-id="${u.id}">Accept</button>
                        </div>
                    `).join("")}
                </div>
            `),i.length>0&&(n+=`
                <div class="task-section">
                    <h4>Active Tasks</h4>
                    ${i.map(u=>`
                        <div class="task-item accepted">
                            <div class="task-icon">${u.icon}</div>
                            <div class="task-info">
                                <div class="task-name">${u.name}</div>
                                <div class="task-desc">${u.description}</div>
                                <div class="task-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${u.progress/u.required*100}%"></div>
                                    </div>
                                    <span>${u.progress}/${u.required}</span>
                                </div>
                            </div>
                            <div class="task-reward">+${u.reward.gold}g</div>
                            <button class="task-btn abandon" data-task-id="${u.id}">Abandon</button>
                        </div>
                    `).join("")}
                </div>
            `);const r=t.filter(u=>!u.accepted);r.length>0?n+=`
                <div class="task-section">
                    <h4>Available Tasks</h4>
                    ${r.map(u=>`
                        <div class="task-item">
                            <div class="task-icon">${u.icon}</div>
                            <div class="task-info">
                                <div class="task-name">${u.name} ${"â­".repeat(u.difficulty)}</div>
                                <div class="task-desc">${u.description}</div>
                                <div class="task-requirement">Collect ${u.required}x</div>
                            </div>
                            <div class="task-reward">+${u.reward.gold}g</div>
                            <button class="task-btn accept" data-task-id="${u.id}">Accept</button>
                        </div>
                    `).join("")}
                </div>
            `:i.length===0&&(n+='<div class="no-tasks">No work available. Check back later!</div>');const o=((c=this.citizens)==null?void 0:c.getIdleCitizens())||[],l=[...((d=this.townActions.citizenAssignedTasks)==null?void 0:d.entries())||[]];l.length>0&&(n+=`
                <div class="task-section citizen-working-section">
                    <h4>ðŸ‘· Citizens Working</h4>
                    ${l.map(([u,h])=>{var f;const m=[...this.townActions.workTasks,...this.townActions.volunteerTasks].find(p=>p.id===u),g=(f=this.citizens)==null?void 0:f.getCitizenByUid(h.citizenUid);if(!m||!g)return"";const y=Math.min(100,h.progress/m.required*100);return`
                            <div class="task-item citizen-task">
                                <div class="task-icon">${m.icon}</div>
                                <div class="task-info">
                                    <div class="task-name">${m.name}</div>
                                    <div class="task-worker">
                                        ${g.icon} ${g.name}
                                        (${Math.round(h.efficiency*100)}% efficiency)
                                    </div>
                                    <div class="task-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${y}%"></div>
                                        </div>
                                        <span>${Math.floor(h.progress)}/${m.required}</span>
                                    </div>
                                </div>
                                <div class="task-reward">+${m.reward.gold||0}g</div>
                                <button class="task-btn recall" data-recall-task="${u}" data-citizen-uid="${g.uid}">Recall</button>
                            </div>
                        `}).join("")}
                </div>
            `),o.length>0&&r.length>0&&(n+=`
                <div class="task-section citizen-assignment-section">
                    <h4>ðŸ“‹ Assign Citizens</h4>
                    <div class="citizen-assignment-info">
                        Your hired workers can complete tasks while you explore.
                    </div>
                    ${o.map(u=>{const h=this.townActions.getTasksForCitizen(u,!1);return h.length===0?"":`
                            <div class="citizen-assignment-row">
                                <span class="citizen-icon">${u.icon}</span>
                                <span class="citizen-name">${u.name}</span>
                                <select class="task-select" data-citizen-uid="${u.uid}">
                                    <option value="">-- Select Task --</option>
                                    ${h.map(m=>`
                                        <option value="${m.task.id}">
                                            ${m.task.icon} ${m.task.name} (${Math.round(m.efficiency*100)}%)
                                        </option>
                                    `).join("")}
                                </select>
                                <button class="assign-citizen-btn" data-citizen-uid="${u.uid}">Assign</button>
                            </div>
                        `}).join("")}
                </div>
            `),n+="</div>",this.showModal("Work Opportunities",n,{backAction:()=>this.showLocationActionsModal(e)}),this.bindTaskModalEvents(!1,e)}showVolunteerTasksModal(e){var l,c;const t=this.townActions.generateVolunteerTasks(e),i=this.townActions.getAcceptedTasks().filter(d=>d.isVolunteer);let s=`
            <div class="task-modal">
                <div class="task-header">
                    <h3>Volunteer Opportunities</h3>
                    <div class="task-stats">Help the community for trust and influence</div>
                </div>
        `;i.length>0&&(s+=`
                <div class="task-section">
                    <h4>Active Tasks</h4>
                    ${i.map(d=>{const u=Object.entries(d.reward).map(([g,y])=>`+${y} ${g}`).join(", ");let h="",m=`${d.progress}/${d.required}`;if(d.type==="use_item"){const g=this.townActions.canUseItemForTask(d.id,this.inventory);h=`<button class="task-btn use-item ${g.can?"":"disabled"}"
                                data-task-id="${d.id}"
                                ${g.can?"":"disabled"}
                                title="${g.can?"Use item to help":g.reason}">
                                Use ${d.targetItem}
                            </button>`}else d.type==="time"&&(m=`${Math.floor(d.progress)}/${d.required} hrs`);return`
                            <div class="task-item accepted volunteer">
                                <div class="task-icon">${d.icon}</div>
                                <div class="task-info">
                                    <div class="task-name">${d.name}</div>
                                    <div class="task-desc">${d.description}</div>
                                    ${d.type==="time"?'<div class="task-hint">Stay near settlement to progress</div>':""}
                                    <div class="task-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${d.progress/d.required*100}%"></div>
                                        </div>
                                        <span>${m}</span>
                                    </div>
                                </div>
                                <div class="task-reward">${u}</div>
                                <div class="task-actions">
                                    ${h}
                                    <button class="task-btn abandon" data-task-id="${d.id}" data-volunteer="true">Abandon</button>
                                </div>
                            </div>
                        `}).join("")}
                </div>
            `);const a=t.filter(d=>!d.accepted);a.length>0?s+=`
                <div class="task-section">
                    <h4>Available Opportunities</h4>
                    ${a.map(d=>{const u=Object.entries(d.reward).map(([h,m])=>`+${m} ${h}`).join(", ");return`
                            <div class="task-item volunteer">
                                <div class="task-icon">${d.icon}</div>
                                <div class="task-info">
                                    <div class="task-name">${d.name} ${"â­".repeat(d.difficulty)}</div>
                                    <div class="task-desc">${d.description}</div>
                                    <div class="task-requirement">Complete ${d.required}x</div>
                                </div>
                                <div class="task-reward">${u}</div>
                                <button class="task-btn accept" data-task-id="${d.id}" data-volunteer="true">Accept</button>
                            </div>
                        `}).join("")}
                </div>
            `:i.length===0&&(s+='<div class="no-tasks">No volunteer work available. Check back later!</div>');const n=((l=this.citizens)==null?void 0:l.getIdleCitizens())||[],r=[...((c=this.townActions.citizenAssignedTasks)==null?void 0:c.entries())||[]].filter(([d])=>{var u;return(u=this.townActions.volunteerTasks)==null?void 0:u.find(h=>h.id===d)});r.length>0&&(s+=`
                <div class="task-section citizen-working-section">
                    <h4>ðŸ‘· Citizens Volunteering</h4>
                    ${r.map(([d,u])=>{var y;const h=this.townActions.volunteerTasks.find(f=>f.id===d),m=(y=this.citizens)==null?void 0:y.getCitizenByUid(u.citizenUid);if(!h||!m)return"";const g=Math.min(100,u.progress/h.required*100);return`
                            <div class="task-item citizen-task">
                                <div class="task-icon">${h.icon}</div>
                                <div class="task-info">
                                    <div class="task-name">${h.name}</div>
                                    <div class="task-worker">
                                        ${m.icon} ${m.name}
                                        (${Math.round(u.efficiency*100)}% efficiency)
                                    </div>
                                    <div class="task-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${g}%"></div>
                                        </div>
                                        <span>${Math.floor(u.progress)}/${h.required}</span>
                                    </div>
                                </div>
                                <div class="task-reward">${Object.entries(h.reward).map(([f,p])=>`+${p} ${f}`).join(", ")}</div>
                                <button class="task-btn recall" data-recall-task="${d}" data-citizen-uid="${m.uid}">Recall</button>
                            </div>
                        `}).join("")}
                </div>
            `);const o=t.filter(d=>{var u;return!d.accepted&&!((u=this.townActions.citizenAssignedTasks)!=null&&u.has(d.id))});n.length>0&&o.length>0&&(s+=`
                <div class="task-section citizen-assignment-section">
                    <h4>ðŸ“‹ Assign Citizens to Volunteer</h4>
                    <div class="citizen-assignment-info">
                        Your hired workers can volunteer while you explore.
                    </div>
                    ${n.map(d=>{const u=this.townActions.getTasksForCitizen(d,!0);return u.length===0?"":`
                            <div class="citizen-assignment-row">
                                <span class="citizen-icon">${d.icon}</span>
                                <span class="citizen-name">${d.name}</span>
                                <select class="task-select" data-citizen-uid="${d.uid}">
                                    <option value="">-- Select Task --</option>
                                    ${u.map(h=>`
                                        <option value="${h.task.id}">
                                            ${h.task.icon} ${h.task.name} (${Math.round(h.efficiency*100)}%)
                                        </option>
                                    `).join("")}
                                </select>
                                <button class="assign-citizen-btn" data-citizen-uid="${d.uid}">Assign</button>
                            </div>
                        `}).join("")}
                </div>
            `),s+="</div>",this.showModal("Volunteer",s,{backAction:()=>this.showLocationActionsModal(e)}),this.bindTaskModalEvents(!0,e)}bindTaskModalEvents(e,t=null){const i=t||this.state.player.currentPOI;this.ui.modalBody.querySelectorAll(".task-btn.accept[data-task-id]").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.taskId,n=s.dataset.volunteer==="true";this.townActions.acceptTask(a,n)&&(this.hideModal(),n?this.showVolunteerTasksModal(i):this.showWorkTasksModal(i))})}),this.ui.modalBody.querySelectorAll(".task-btn.accept[data-delivery-id]").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.deliveryId;this.townActions.acceptDelivery(a,this.inventory)&&(this.hideModal(),this.showWorkTasksModal(i))})}),this.ui.modalBody.querySelectorAll(".task-btn.abandon[data-task-id]").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.taskId;this.townActions.abandonTask(a)&&(this.hideModal(),e?this.showVolunteerTasksModal(i):this.showWorkTasksModal(i))})}),this.ui.modalBody.querySelectorAll(".task-btn.abandon[data-delivery-abandon]").forEach(s=>{s.addEventListener("click",()=>{this.townActions.abandonDelivery(this.inventory),this.hideModal(),this.showWorkTasksModal(i)})}),this.ui.modalBody.querySelectorAll(".task-btn.complete[data-delivery-complete]").forEach(s=>{s.addEventListener("click",()=>{const a=this.townActions.completeDelivery(this.inventory);this.hideModal(),a&&(this.updateCompass(),this.updateUI())})}),this.ui.modalBody.querySelectorAll(".task-btn.use-item[data-task-id]").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.taskId;this.townActions.useItemForTask(a,this.inventory)&&(this.hideModal(),this.showVolunteerTasksModal(i))})}),this.ui.modalBody.querySelectorAll(".assign-citizen-btn").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.citizenUid,n=s.parentElement.querySelector(".task-select"),r=n==null?void 0:n.value;a&&r&&this.citizens.assignToTownTask(a,r,this.townActions)&&(this.hideModal(),e?this.showVolunteerTasksModal(i):this.showWorkTasksModal(i))})}),this.ui.modalBody.querySelectorAll(".task-btn.recall").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.citizenUid;a&&this.citizens.unassignFromTownTask(a,this.townActions)&&(this.hideModal(),e?this.showVolunteerTasksModal(i):this.showWorkTasksModal(i))})})}showCultShrineModal(e){var c,d,u,h,m,g,y,f;const t=(c=e.data)==null?void 0:c.associatedCult,i=t?ie[t]:null,s=this.cults.getMembership(t),a=!!s,n=i&&this.cults.canJoin(t),r=this.guilds.getAlignmentTier();let o=`
            <div class="cult-shrine-modal">
                <div class="shrine-header">
                    <span class="shrine-icon">${e.type.icon}</span>
                    <div class="shrine-info">
                        <div class="shrine-name">${e.name}</div>
                        <div class="shrine-type">${e.type.name}</div>
                    </div>
                </div>

                <div class="shrine-lore">
                    <p>${((d=e.data)==null?void 0:d.lore)||"An ancient place of dark power..."}</p>
                </div>`;if(i)if(o+=`
                <div class="cult-info">
                    <div class="cult-header">
                        <span class="cult-icon" style="color: ${i.color}">${i.icon}</span>
                        <span class="cult-name">${i.name}</span>
                    </div>
                    <div class="cult-focus">Focus: ${i.focus}</div>
                    <div class="cult-desc">${i.description}</div>
                </div>`,a){const p=this.cults.getRank(t),v=this.cults.getRankName(t),b=s.reputation,k=this.cults.getNextRankThreshold(t);if(o+=`
                    <div class="cult-membership">
                        <div class="membership-header">Your Standing</div>
                        <div class="membership-rank">${v} (Rank ${p})</div>
                        <div class="membership-rep">Reputation: ${b}${k?` / ${k}`:" (Max)"}</div>
                    </div>

                    <div class="ritual-section">
                        <div class="ritual-header">Available Rituals</div>
                        ${this.getRitualsHTML(e,t,p)}
                    </div>`,t==="blood_covenant"&&e.type.id==="blood_altar"&&p>=3){const w=this.citizens.getHiredCitizens();w.length>0&&(o+=`
                            <div class="sacrifice-section">
                                <div class="sacrifice-header">ðŸ©¸ Blood Sacrifice</div>
                                <p class="sacrifice-desc">Offer a soul to the altar for great power...</p>
                                <select id="sacrifice-target" class="sacrifice-select">
                                    ${w.map(x=>`<option value="${x.uid}">${x.name} - ${x.profession}</option>`).join("")}
                                </select>
                                <button class="cult-btn sacrifice-btn" data-action="sacrifice">Perform Sacrifice</button>
                            </div>`)}o+=`
                    <div class="cult-actions">
                        <button class="cult-btn leave-btn" data-action="leave-cult">Abandon ${i.name}</button>
                    </div>`}else o+=`
                    <div class="cult-join">
                        <div class="join-header">Join the ${i.name}?</div>
                        <div class="join-requirements">
                            <div>Alignment Required: ${((u=i.alignmentRequirement)==null?void 0:u.max)!==void 0?`${i.alignmentRequirement.max} or lower`:"Any"}</div>
                            <div>Your Alignment: <span style="color: ${r.color}">${r.name}</span> (${this.state.player.alignment})</div>
                        </div>
                        ${n?`
                            <button class="cult-btn join-btn" data-action="join-cult" data-cult="${t}">
                                Pledge yourself to ${i.name}
                            </button>
                        `:`
                            <div class="join-blocked">Your soul is too pure to join this cult.</div>
                        `}
                    </div>`;else o+=`
                <div class="shrine-mystery">
                    <p>This shrine has no clear affiliation. Dark energies swirl within...</p>
                </div>`;const l=(h=e.data)==null?void 0:h.cleansed;if(!a&&!l&&this.state.player.alignment>=0){const p=(m=this.inventory)==null?void 0:m.has("purifying_crystal"),v=(g=this.inventory)==null?void 0:g.has("holy_relic"),b=(y=this.inventory)==null?void 0:y.has("sacred_chalice"),k=(f=this.inventory)==null?void 0:f.has("blessed_water");p||v||b||k?o+=`
                    <div class="cleanse-section">
                        <div class="cleanse-header">âœï¸ Purification</div>
                        <p class="cleanse-desc">You sense the corruption emanating from this place. Your sacred items pulse with cleansing energy.</p>
                        <button class="cult-btn cleanse-btn" data-action="cleanse-shrine" style="background: linear-gradient(to right, #4a6fa5, #9370db);">
                            Cleanse this Site (+15 Alignment)
                        </button>
                    </div>`:this.state.player.alignment>=25&&(o+=`
                    <div class="cleanse-section">
                        <div class="cleanse-header">âœï¸ Purification</div>
                        <p class="cleanse-desc" style="opacity: 0.7;">
                            You could cleanse this corruption, but you lack a sacred item.
                            Seek purifying crystals, holy relics, or blessed water from dungeons and guild quests.
                        </p>
                    </div>`)}else l&&(o+=`
                <div class="cleansed-section" style="text-align: center; padding: 15px; background: rgba(100, 200, 100, 0.1); border-radius: 8px;">
                    <div style="font-size: 24px;">âœ¨</div>
                    <div style="color: #6d6;">This site has been cleansed of corruption.</div>
                </div>`);o+="</div>",this.showModal(e.name,o),this.bindCultModalEvents(e,t)}getRitualsHTML(e,t,i){var a;const s=((a=e.data)==null?void 0:a.availableRituals)||[];return s.length===0?'<div class="no-rituals">No rituals available at this shrine.</div>':s.map(n=>{const r=st[n];if(!r)return"";const l=this.cults.canPerformRitual(n).can,c=this.cults.isRitualOnCooldown(n),d=i>=(r.minRank||1);let u=[];if(r.cost.playerHealth&&u.push(`${r.cost.playerHealth} HP`),r.cost.ether&&u.push(`${r.cost.ether} Ether`),r.cost.gold&&u.push(`${r.cost.gold} Gold`),r.cost.items){const y=r.cost.items;y.type==="any"?u.push(`Items worth ${y.value}g`):y.category&&y.count&&u.push(`${y.count}x ${y.category.replace(/_/g," ")}`)}let h=[];r.reward.reputation&&h.push(`+${r.reward.reputation} Rep`),r.reward.gold&&h.push(`+${r.reward.gold} Gold`),r.reward.ether&&h.push(`+${r.reward.ether} Ether`),r.reward.health&&h.push(`+${r.reward.health} HP`),r.reward.alignment&&h.push(`${r.reward.alignment} Alignment`);const m=!l||c||!d;let g="";return d?c?g="(On cooldown)":l||(g="(Missing requirements)"):g=`(Rank ${r.minRank} required)`,`
                <div class="ritual-item ${m?"disabled":""}">
                    <div class="ritual-info">
                        <div class="ritual-name">${r.name}</div>
                        <div class="ritual-desc">${r.description}</div>
                        <div class="ritual-cost">Cost: ${u.join(", ")||"None"}</div>
                        <div class="ritual-reward">Reward: ${h.join(", ")}</div>
                        ${g?`<div class="ritual-status">${g}</div>`:""}
                    </div>
                    <button class="ritual-btn" data-ritual="${n}" ${m?"disabled":""}>
                        Perform
                    </button>
                </div>`}).join("")}bindCultModalEvents(e,t){var s,a,n,r;const i=this.ui.gameModal;(s=i.querySelector(".join-btn"))==null||s.addEventListener("click",o=>{const l=o.target.dataset.cult,c=this.cults.join(l);c.success?(this.state.addLog(c.message,"success"),this.hideModal(),this.showCultShrineModal(e)):this.state.addLog(c.message,"warning")}),(a=i.querySelector(".leave-btn"))==null||a.addEventListener("click",()=>{const o=this.cults.leave(t);o.success?(this.state.addLog(o.message,"info"),this.hideModal(),this.showCultShrineModal(e)):this.state.addLog(o.message,"warning")}),i.querySelectorAll(".ritual-btn:not([disabled])").forEach(o=>{o.addEventListener("click",l=>{const c=l.target.dataset.ritual,d=this.cults.performRitual(c,e);d.success?(this.state.addLog(d.message,"success"),this.updateUI(),this.hideModal(),this.showCultShrineModal(e)):this.state.addLog(d.message,"warning")})}),(n=i.querySelector(".sacrifice-btn"))==null||n.addEventListener("click",()=>{const o=i.querySelector("#sacrifice-target");if(!o)return;const l=o.value;this.showSacrificeConfirmation(e,l)}),(r=i.querySelector(".cleanse-btn"))==null||r.addEventListener("click",()=>{this.cleanseCultSite(e)})}cleanseCultSite(e){var s;let t=null;const i=["purifying_crystal","holy_relic","sacred_chalice","blessed_water"];for(const a of i)if((s=this.inventory)!=null&&s.has(a)){t=a;break}if(!t){this.state.addLog("You need a sacred item to cleanse this site!","warning");return}this.inventory.remove(t),this.auraSystem?this.auraSystem.cleanseCultSite(e):(e.data=e.data||{},e.data.cleansed=!0,this.state.player.alignment+=15,this.state.addLog(`The corruption at ${e.name} has been cleansed!`,"success")),this.state.clearAllConditions(),this.state.gainXp(50),this.updateUI(),this.hideModal(),this.showCultShrineModal(e)}showGuildHallModal(e){var o;const t=((o=e.data)==null?void 0:o.guildId)||e.type.guildId,i=e.data||{},a={merchants:{name:"Merchant's Coalition",icon:"ðŸ’°",color:"#d4af37",focus:"Trade & Commerce"},explorers:{name:"Explorer's League",icon:"ðŸ§­",color:"#2e8b57",focus:"Discovery & Mapping"},artisans:{name:"Artisan's Circle",icon:"âš’ï¸",color:"#cd853f",focus:"Crafting & Creation"},iron_company:{name:"Iron Company",icon:"âš”ï¸",color:"#708090",focus:"Mercenary Work & Combat"},shadows:{name:"Shadow Network",icon:"ðŸ—ï¸",color:"#2f1f3f",focus:"Information & Infiltration"},ether_conclave:{name:"Ether Conclave",icon:"ðŸ”®",color:"#9370db",focus:"Arcane Knowledge"}}[t]||{name:"Unknown Guild",icon:"ðŸ›ï¸",color:"#888",focus:"Unknown"},n=i.services||["contracts","training"];let r=`
            <div class="guild-hall-modal">
                <div class="guild-header" style="border-left: 4px solid ${a.color}; padding-left: 12px;">
                    <span class="guild-icon" style="font-size: 32px;">${a.icon}</span>
                    <div class="guild-info">
                        <div class="guild-name" style="color: ${a.color}; font-size: 18px; font-weight: bold;">${a.name}</div>
                        <div class="guild-focus" style="opacity: 0.8;">${a.focus}</div>
                    </div>
                </div>

                <div class="guild-lore" style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-style: italic;">
                    "${i.lore||"A place of purpose and profit."}"
                </div>

                <div class="guild-services" style="margin: 15px 0;">
                    <div style="font-weight: bold; margin-bottom: 8px;">Available Services:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${n.map(l=>`
                            <span style="padding: 4px 10px; background: ${a.color}30; border: 1px solid ${a.color}50; border-radius: 12px; font-size: 12px;">
                                ${l.charAt(0).toUpperCase()+l.slice(1).replace(/_/g," ")}
                            </span>
                        `).join("")}
                    </div>
                </div>

                <div class="guild-actions" style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                    <button class="location-btn guild-action" data-action="guild-quests" style="background: linear-gradient(135deg, ${a.color}60, ${a.color}30);">
                        ðŸ“‹ Guild Contracts
                    </button>
                    <button class="location-btn guild-action" data-action="guild-roster" style="background: linear-gradient(135deg, #4a4a6a60, #3a3a5a30);">
                        ðŸ‘¥ Guild Roster
                    </button>
                    <button class="location-btn guild-action" data-action="guild-rest" style="background: #3a3a3a;">
                        ðŸ›ï¸ Rest at Guild (Restore HP/Stamina)
                    </button>`;i.antiCultFocus&&(r+=`
                <div class="guild-anticult" style="margin-top: 15px; padding: 10px; background: rgba(100, 200, 100, 0.1); border-radius: 6px;">
                    <div style="font-weight: bold; color: #6d6;">âœï¸ Anti-Cult Operations</div>
                    <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                        ${{resource_denial:"Specializes in disrupting cult supply lines",discovery:"Experts at locating hidden cult sites",sacred_crafting:"Masters of forging purifying artifacts",direct_combat:"Frontline fighters against cult forces",infiltration:"Covert operations against cult cells",magical_cleansing:"Arcane specialists in dispelling corruption"}[i.antiCultFocus]||"Stands against dark forces"}
                    </div>
                </div>`),i.corruptionResistance&&(r+=`
                <div class="guild-protection" style="margin-top: 10px; font-size: 12px; opacity: 0.7;">
                    ðŸ›¡ï¸ This guild provides ${i.corruptionResistance} hex protection from nearby corruption
                </div>`),r+=`
                </div>
            </div>`,this.showModal(e.name,r),this.bindGuildModalEvents(e,t)}bindGuildModalEvents(e,t){var s,a,n;const i=this.ui.gameModal;(s=i.querySelector('[data-action="guild-quests"]'))==null||s.addEventListener("click",()=>{this.showGuildQuestBoard(e,t)}),(a=i.querySelector('[data-action="guild-roster"]'))==null||a.addEventListener("click",()=>{this.showGuildRoster(e,t)}),(n=i.querySelector('[data-action="guild-rest"]'))==null||n.addEventListener("click",()=>{this.restAtGuild(e)})}showGuildRoster(e,t){const s={merchants:{name:"Merchant's Coalition",icon:"ðŸ’°"},explorers:{name:"Explorer's League",icon:"ðŸ§­"},artisans:{name:"Artisan's Circle",icon:"âš’ï¸"},iron_company:{name:"Iron Company",icon:"âš”ï¸"},ironcompany:{name:"Iron Company",icon:"âš”ï¸"},shadows:{name:"Shadow Network",icon:"ðŸ—ï¸"},ether_conclave:{name:"Ether Conclave",icon:"ðŸ”®"}}[t]||{name:"Guild",icon:"ðŸ›ï¸"},a=this.citizens.citizens.filter(o=>o.guildId===t),n=["","Initiate","Member","Adept","Veteran","Master"];let r=`
            <div class="guild-roster" style="max-height: 450px; overflow-y: auto;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 32px;">${s.icon}</div>
                    <div style="font-weight: bold;">${s.name}</div>
                    <div style="font-size: 12px; opacity: 0.6;">${a.length} member(s)</div>
                </div>`;if(a.length===0)r+=`
                <div style="text-align: center; padding: 20px; opacity: 0.6;">
                    No members in this guild yet.<br>
                    <small>Hire citizens and they may come with guild membership,<br>
                    or initiate existing citizens at a guild hall.</small>
                </div>`;else{r+='<div class="roster-list">';for(const o of a){const l=n[o.guildRank]||"Unknown",c=o.status==="active"?"#4a9":o.status==="injured"?"#f66":o.status==="imprisoned"?"#a0a":"#888";let d="Available";o.assignment&&(o.assignment.type==="scout_mission"?d="ðŸ§­ On Mission":o.assignment.type==="gather"?d="â›ï¸ Gathering":d="ðŸ“‹ Working"),r+=`
                    <div class="roster-member citizen-link" data-uid="${o.uid}" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: background 0.15s;">
                        <div style="font-size: 24px; margin-right: 10px;">${o.icon||"ðŸ‘¤"}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${o.name}</div>
                            <div style="font-size: 11px; opacity: 0.7;">
                                Level ${o.level} ${o.role||o.workerRole||""} â€¢ ${l}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; color: ${c};">${o.status}</div>
                            <div style="font-size: 10px; opacity: 0.6;">${d}</div>
                        </div>
                    </div>`}r+="</div>"}r+="</div>",this.showModal("Guild Roster",r),this.ui.modalBody.querySelectorAll(".citizen-link[data-uid]").forEach(o=>{o.addEventListener("click",()=>{const l=o.dataset.uid;this.showCitizenModal(l)})})}showScoutMissionPanel(e,t){var l,c;const i=this.quests.getActiveScoutMissions(),s=this.quests.getPendingScoutMissions(),a=this.quests.getActiveRescueQuests(),n=this.citizens.citizens.filter(d=>d.status==="active"&&!d.assignment&&d.guildId);let r=`
            <div class="scout-mission-panel" style="max-height: 500px; overflow-y: auto;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 32px;">ðŸ§­</div>
                    <div style="font-weight: bold;">Scout Missions</div>
                    <div style="font-size: 12px; opacity: 0.7;">Send guild members to discover hidden locations</div>
                </div>`;if(a.length>0){r+=`
                <div class="mission-section" style="margin-bottom: 20px;">
                    <div style="font-weight: bold; color: #f66; margin-bottom: 10px;">ðŸ†˜ Urgent Rescues</div>`;for(const d of a){const u=d.expiresDay-this.state.day;r+=`
                    <div class="mission-card" style="background: rgba(255,100,100,0.1); border: 1px solid #f66; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${d.name}</strong>
                                <div style="font-size: 12px; opacity: 0.8;">${d.description}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #f66; font-weight: bold;">${u} days left</div>
                                <div style="font-size: 11px; opacity: 0.7;">Player required</div>
                            </div>
                        </div>
                    </div>`}r+="</div>"}if(i.length>0){r+=`
                <div class="mission-section" style="margin-bottom: 20px;">
                    <div style="font-weight: bold; color: #4a9; margin-bottom: 10px;">ðŸ”„ Active Missions</div>`;for(const d of i){const h=(((l=d.objective)==null?void 0:l.assignedCitizens)||[]).map(g=>{var y;return((y=this.citizens.getCitizenByUid(g))==null?void 0:y.name)||"Unknown"}).join(", "),m=d.expiresDay-this.state.day;r+=`
                    <div class="mission-card" style="background: rgba(70,150,100,0.1); border: 1px solid #4a9; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${d.name}</strong>
                                <div style="font-size: 12px; opacity: 0.8;">Assigned: ${h||"None"}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #4a9;">${m} days left</div>
                                <div style="font-size: 11px; opacity: 0.7;">${Math.round((((c=d.objective)==null?void 0:c.successChance)||.5)*100)}% success</div>
                            </div>
                        </div>
                    </div>`}r+="</div>"}if(s.length>0){r+=`
                <div class="mission-section" style="margin-bottom: 20px;">
                    <div style="font-weight: bold; color: #d4af37; margin-bottom: 10px;">ðŸ“‹ Pending Assignments</div>`;for(const d of s)r+=`
                    <div class="mission-card" style="background: rgba(200,175,55,0.1); border: 1px solid #d4af37; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                        <div>
                            <strong>${d.name}</strong>
                            <div style="font-size: 12px; opacity: 0.8;">${d.description}</div>
                            <button class="assign-scout-btn" data-quest-id="${d.id}" style="margin-top: 8px; padding: 4px 12px; font-size: 12px; cursor: pointer; background: #d4af37; border: none; color: #000; border-radius: 4px;">
                                Assign Scouts
                            </button>
                        </div>
                    </div>`;r+="</div>"}if(r+=`
            <div class="mission-section">
                <div style="font-weight: bold; margin-bottom: 10px;">ðŸ‘¥ Available Guild Members (${n.length})</div>`,n.length===0)r+=`
                <div style="text-align: center; padding: 15px; opacity: 0.6; font-size: 13px;">
                    No available guild members.<br>
                    <small>Hire citizens and initiate them into guilds to unlock scouting.</small>
                </div>`;else{r+='<div style="display: flex; flex-wrap: wrap; gap: 8px;">';for(const d of n.slice(0,8)){const u=this.getGuildIcon(d.guildId);r+=`
                    <div class="scout-citizen citizen-link" data-uid="${d.uid}" style="padding: 6px 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 12px; cursor: pointer; transition: background 0.15s;">
                        ${u} ${d.name} <span style="opacity: 0.6;">Lv${d.level}</span>
                    </div>`}n.length>8&&(r+=`<div style="padding: 6px; opacity: 0.6;">+${n.length-8} more</div>`),r+="</div>"}r+="</div></div>",this.showModal("Scout Missions",r);const o=this.ui.gameModal;o.querySelectorAll(".assign-scout-btn").forEach(d=>{d.addEventListener("click",()=>{const u=d.dataset.questId;this.showScoutAssignmentModal(u,n)})}),o.querySelectorAll(".citizen-link[data-uid]").forEach(d=>{d.addEventListener("click",()=>{const u=d.dataset.uid;this.showCitizenModal(u)})})}getGuildIcon(e){return{merchants:"ðŸ’°",explorers:"ðŸ§­",artisans:"âš’ï¸",iron_company:"âš”ï¸",shadows:"ðŸ—ï¸",ether_conclave:"ðŸ”®"}[e]||"ðŸ›ï¸"}getSkillIcon(e){if(!e||Object.keys(e).length===0)return"ðŸ‘¤";const t={agriculture:"ðŸŒ¾",construction:"ðŸ”¨",medicine:"âš•ï¸",tailoring:"ðŸ§µ",warriors:"âš”ï¸",smithing:"âš’ï¸",rangers:"ðŸ¹"};let i=null,s=0;for(const[a,n]of Object.entries(e))n>s&&(i=a,s=n);return t[i]||"ðŸ‘¤"}getSkillRole(e){if(!e||Object.keys(e).length===0)return"Worker";const t={agriculture:"Farmer",construction:"Builder",medicine:"Healer",tailoring:"Tailor",warriors:"Guard",smithing:"Smith",rangers:"Ranger"};let i=null,s=0;for(const[a,n]of Object.entries(e))n>s&&(i=a,s=n);return t[i]||"Worker"}showScoutAssignmentModal(e,t){var u;const i=this.quests.activeQuests.find(h=>h.id===e);if(!i)return;const s=i.minCitizens||1,a=i.maxCitizens||3;let n=`
            <div class="scout-assignment-modal">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 24px;">ðŸ§­</div>
                    <div style="font-weight: bold;">${i.name}</div>
                    <div style="font-size: 12px; opacity: 0.7;">${i.description}</div>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                    <div style="font-size: 12px;">
                        <div>ðŸ“Š Party Size: ${s}-${a} members</div>
                        <div>â±ï¸ Duration: ~${i.duration||3} days</div>
                        <div>âš ï¸ Danger Level: ${i.dangerLevel||"Low"}</div>
                    </div>
                </div>

                <div style="font-weight: bold; margin-bottom: 8px;">Select Scouts:</div>
                <div class="scout-selection" style="max-height: 200px; overflow-y: auto;">`;if(t.length===0)n+='<div style="text-align: center; padding: 15px; opacity: 0.6;">No available scouts</div>';else for(const h of t){const m=this.getGuildIcon(h.guildId),g=h.guildId==="explorers";n+=`
                    <label class="scout-option" style="display: flex; align-items: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 4px; margin-bottom: 4px; cursor: pointer;">
                        <input type="checkbox" class="scout-checkbox" data-uid="${h.uid}" style="margin-right: 10px;">
                        <div style="flex: 1;">
                            <div>${m} ${h.name}</div>
                            <div style="font-size: 11px; opacity: 0.7;">
                                Level ${h.level} ${h.role||""}
                                ${g?'<span style="color: #4a9;">(+15% bonus)</span>':""}
                            </div>
                        </div>
                        <div style="font-size: 12px; opacity: 0.6;">
                            Rank ${h.guildRank||1}
                        </div>
                    </label>`}n+=`
                </div>

                <div id="success-preview" style="margin: 15px 0; padding: 10px; background: rgba(70,150,100,0.1); border-radius: 6px; text-align: center;">
                    Select scouts to see success chance
                </div>

                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="confirm-assignment" disabled style="padding: 10px 20px; background: #4a9; border: none; color: white; border-radius: 6px; cursor: pointer; opacity: 0.5;">
                        Deploy Scouts
                    </button>
                    <button id="cancel-assignment" style="padding: 10px 20px; background: #666; border: none; color: white; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            </div>`,this.showModal("Assign Scouts",n);const r=this.ui.gameModal,o=r.querySelectorAll(".scout-checkbox"),l=r.querySelector("#confirm-assignment"),c=r.querySelector("#success-preview"),d=()=>{const h=Array.from(o).filter(m=>m.checked).map(m=>this.citizens.getCitizenByUid(m.dataset.uid));if(h.length===0)c.innerHTML="Select scouts to see success chance",l.disabled=!0,l.style.opacity="0.5";else if(h.length<s)c.innerHTML=`Need at least ${s} scout(s)`,l.disabled=!0,l.style.opacity="0.5";else if(h.length>a)c.innerHTML=`Maximum ${a} scouts allowed`,l.disabled=!0,l.style.opacity="0.5";else{const m=this.quests.calculateScoutSuccess(i,h),g=Math.round(m*100),y=g>=70?"#4a9":g>=40?"#d4af37":"#f66";c.innerHTML=`
                    <div style="font-size: 18px; font-weight: bold; color: ${y};">${g}% Success Chance</div>
                    <div style="font-size: 11px; opacity: 0.7;">${h.length} scout(s) assigned</div>
                `,l.disabled=!1,l.style.opacity="1"}};o.forEach(h=>h.addEventListener("change",d)),l.addEventListener("click",()=>{const h=Array.from(o).filter(m=>m.checked).map(m=>m.dataset.uid);h.length>=s&&h.length<=a&&(this.quests.assignScoutMission(e,h),this.hideModal(),this.state.addLog(`Scouts deployed on mission: ${i.name}`,"info"))}),(u=r.querySelector("#cancel-assignment"))==null||u.addEventListener("click",()=>{this.hideModal()})}showGuildQuestBoard(e,t){var l,c,d,u;const i=this.quests.getGuildQuests(e,t),s=this.citizens.citizens.filter(h=>h.status==="active"&&!h.assignment&&h.guildId===t),a=this.quests.activeQuests.filter(h=>h.isGuildQuest&&h.guildId===t);let n="";if(a.length>0){n+=`<div style="margin-bottom: 15px;">
                <div style="font-weight: bold; color: #4a9; margin-bottom: 8px;">ðŸ“Œ Active Contracts</div>`;for(const h of a){const m=this.getQuestIcon((l=h.objective)==null?void 0:l.type),g=h.isScoutQuest,y=((c=h.objective)==null?void 0:c.status)||"pending";let f="";if(g&&y==="in_progress"){const p=(((d=h.objective)==null?void 0:d.assignedCitizens)||[]).map(b=>{var k;return((k=this.citizens.getCitizenByUid(b))==null?void 0:k.name)||"Unknown"}).join(", ");f=`
                        <div style="font-size: 11px; color: #4a9;">
                            ðŸ”„ In Progress (${h.expiresDay-this.state.day}d left)<br>
                            <span style="opacity: 0.7;">Assigned: ${p}</span>
                        </div>`}else g&&y==="pending"?f='<div style="font-size: 11px; color: #d4af37;">â³ Awaiting assignment</div>':f='<div style="font-size: 11px; color: #4a9;">âœ“ Active</div>';n+=`
                    <div class="quest-item" style="margin-bottom: 8px; padding: 10px; background: rgba(70,150,100,0.1); border-radius: 6px; border-left: 3px solid #4a9;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong>${m} ${h.name}</strong>
                                <div style="font-size: 11px; opacity: 0.7;">${h.description}</div>
                            </div>
                            <div style="text-align: right;">
                                ${f}
                            </div>
                        </div>
                    </div>`}n+="</div>"}n+='<div style="font-weight: bold; margin-bottom: 8px;">ðŸ“‹ Available Contracts</div>';const r=i.filter(h=>!this.quests.activeQuests.some(m=>m.id===h.id));if(r.length===0)n+=`
                <div style="text-align: center; padding: 15px; opacity: 0.6; font-size: 12px;">
                    No new contracts available.<br>
                    <small>Check back later or visit other guild halls.</small>
                </div>`;else for(const h of r){const m=Object.entries(h.rewards).map(([b,k])=>`+${k} ${b}`).join(", "),g=this.getQuestIcon((u=h.objective)==null?void 0:u.type),y=h.isScoutQuest,f=h.minCitizens||1,p=h.maxCitizens||3;let v="";y?s.length===0?v=`
                            <div style="text-align: right;">
                                <div style="font-size: 11px; color: #f66; margin-bottom: 4px;">No guild members available</div>
                                <button disabled style="padding: 4px 10px; font-size: 11px; opacity: 0.5;">Accept & Assign</button>
                            </div>`:v=`
                            <div class="quest-assignment" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <div style="font-size: 11px; opacity: 0.7; margin-bottom: 4px;">
                                    Assign ${f}${p>f?"-"+p:""} guild member(s):
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;">
                                    ${s.slice(0,6).map(b=>`
                                        <label class="citizen-checkbox-label" style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: rgba(255,255,255,0.05); border-radius: 4px; cursor: pointer; font-size: 11px;">
                                            <input type="checkbox" class="quest-citizen-checkbox" data-quest-id="${h.id}" data-uid="${b.uid}">
                                            ${b.icon||"ðŸ‘¤"} ${b.name} <span style="opacity: 0.5;">L${b.level}</span>
                                        </label>
                                    `).join("")}
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="quest-success-preview" data-quest-id="${h.id}" style="font-size: 11px; opacity: 0.7;">Select members...</span>
                                    <button class="accept-assign-btn" data-quest-id="${h.id}" disabled style="padding: 4px 12px; font-size: 11px; cursor: pointer; opacity: 0.5;">
                                        Accept & Assign
                                    </button>
                                </div>
                            </div>`:v=`
                        <button class="accept-guild-quest-btn" data-quest-id="${h.id}" style="padding: 4px 12px; font-size: 12px; cursor: pointer;">
                            Accept
                        </button>`,n+=`
                    <div class="quest-item" style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid #666;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong>${g} ${h.name}</strong>
                                <span style="font-size: 11px; opacity: 0.6; margin-left: 8px;">[${h.difficulty||"Normal"}]</span>
                                ${y?'<span style="font-size: 10px; background: #2e8b57; color: white; padding: 1px 6px; border-radius: 8px; margin-left: 6px;">Scout</span>':""}
                                <div style="font-size: 12px; margin-top: 4px; opacity: 0.8;">${h.description}</div>
                                <div style="font-size: 11px; margin-top: 4px; color: #d4af37;">${m}</div>
                                ${y?`<div style="font-size: 10px; opacity: 0.6; margin-top: 2px;">â±ï¸ ${h.duration||3} days</div>`:""}
                            </div>
                            ${y?"":v}
                        </div>
                        ${y?v:""}
                    </div>`}const o=`
            <div class="quest-board" style="max-height: 500px; overflow-y: auto;">
                <div style="padding: 10px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 32px;">ðŸ“‹</div>
                        <div style="font-size: 14px; font-weight: bold;">Guild Contracts</div>
                        <div style="font-size: 11px; opacity: 0.6;">Complete missions to earn rewards and reputation</div>
                        <div style="font-size: 10px; margin-top: 4px; opacity: 0.5;">
                            ${s.length} guild member(s) available for assignment
                        </div>
                    </div>
                    <div class="guild-quests-list">
                        ${n}
                    </div>
                </div>
            </div>`;this.showModal("Guild Contracts",o),this._guildQuests=i,this._guildQuestPoi=e,this._guildQuestGuildId=t,this.bindGuildContractEvents(s)}bindGuildContractEvents(e){const t=this.ui.modalBody;t.querySelectorAll(".accept-guild-quest-btn").forEach(i=>{i.addEventListener("click",()=>{const s=i.dataset.questId,a=this._guildQuests.find(n=>n.id===s);a&&this.quests.acceptQuest(a)&&this.showGuildQuestBoard(this._guildQuestPoi,this._guildQuestGuildId)})}),t.querySelectorAll(".quest-citizen-checkbox").forEach(i=>{i.addEventListener("change",()=>{const s=i.dataset.questId;this.updateQuestAssignmentPreview(s,e)})}),t.querySelectorAll(".accept-assign-btn").forEach(i=>{i.addEventListener("click",()=>{const s=i.dataset.questId;this.acceptAndAssignGuildQuest(s)})})}updateQuestAssignmentPreview(e,t){const i=this.ui.modalBody,s=this._guildQuests.find(d=>d.id===e);if(!s)return;const a=i.querySelectorAll(`.quest-citizen-checkbox[data-quest-id="${e}"]`),n=Array.from(a).filter(d=>d.checked).map(d=>parseInt(d.dataset.uid)),r=i.querySelector(`.quest-success-preview[data-quest-id="${e}"]`),o=i.querySelector(`.accept-assign-btn[data-quest-id="${e}"]`),l=s.minCitizens||1,c=s.maxCitizens||3;if(n.length===0)r.textContent="Select members...",r.style.color="",o.disabled=!0,o.style.opacity="0.5";else if(n.length<l)r.textContent=`Need ${l-n.length} more`,r.style.color="#f66",o.disabled=!0,o.style.opacity="0.5";else if(n.length>c)r.textContent=`Max ${c} allowed`,r.style.color="#f66",o.disabled=!0,o.style.opacity="0.5";else{const d=n.map(g=>t.find(y=>y.uid===g)).filter(Boolean),u=this.quests.calculateScoutSuccess(s,d),h=Math.round(u*100),m=h>=70?"#4a9":h>=40?"#d4af37":"#f66";r.innerHTML=`<span style="color: ${m}; font-weight: bold;">${h}% success</span>`,o.disabled=!1,o.style.opacity="1"}}acceptAndAssignGuildQuest(e){const t=this._guildQuests.find(n=>n.id===e);if(!t)return;const i=this.ui.modalBody.querySelectorAll(`.quest-citizen-checkbox[data-quest-id="${e}"]`),s=Array.from(i).filter(n=>n.checked).map(n=>parseInt(n.dataset.uid));if(s.length===0){this.state.addLog("Select at least one guild member","warning");return}if(!this.quests.acceptQuest(t))return;const a=this.quests.assignScoutMission(t.id,s);a.success?(this.state.addLog("Contract accepted and team assigned!","success"),this.showGuildQuestBoard(this._guildQuestPoi,this._guildQuestGuildId)):this.state.addLog(a.reason||"Failed to assign team","warning")}getQuestIcon(e){return{clear_cult_site:"ðŸ›ï¸",bounty_cultist:"ðŸ—¡ï¸",dispel_aura:"âœ¨",dungeon_retrieve_sacred:"ðŸ’Ž",craft_sacred_item:"âš’ï¸",seal_void_rift:"ðŸŒ€",map_corruption_zone:"ðŸ—ºï¸",infiltrate_cult:"ðŸ•µï¸",scout_region:"ðŸ§­",scout_poi:"ðŸ”",explore_dungeon:"ðŸ—ï¸",rescue:"ðŸ†˜"}[e]||"ðŸ“œ"}restAtGuild(e){const t=this.state.player,i=t.maxHealth-t.health,s=t.maxStamina-t.stamina;t.health=t.maxHealth,t.stamina=t.maxStamina,this.state.clearAllConditions(),this.gameLoop.advanceHours(4);const a=10;t.gold>=a?(t.gold-=a,this.state.addLog(`Rested at ${e.name} for 4 hours (-${a}g)`,"info"),i>0&&this.state.addLog(`Restored ${Math.floor(i)} HP`,"success"),s>0&&this.state.addLog(`Restored ${Math.floor(s)} Stamina`,"success")):(t.health=Math.min(t.maxHealth,t.health+t.maxHealth*.5),t.stamina=Math.min(t.maxStamina,t.stamina+t.maxStamina*.5),this.state.addLog(`Rested at ${e.name} (no coin for full service)`,"info")),this.hideModal(),this.updateUI(),this.render()}showTitleScreenLexicon(){const e="etherground_save";let t=null;try{const u=localStorage.getItem(e);u&&(t=JSON.parse(u).lexiconData)}catch{console.log("No saved lexicon data")}const i=new tt(null);t&&i.fromJSON(t);const s=i.getProgress(),a=i.getUnlockedCategories(),n=document.getElementById("lexicon-screen"),r=document.getElementById("title-screen"),o=document.getElementById("lexicon-screen-content"),l=document.getElementById("lexicon-progress-text");if(l.textContent=`${s.unlocked}/${s.total} discovered (${s.percent}%)`,s.unlocked===0)o.innerHTML=`
                <div class="lexicon-empty-state" style="width: 100%;">
                    <div class="lexicon-empty-icon">ðŸ“–</div>
                    <p style="font-size: 18px; margin-bottom: 8px;">No discoveries yet</p>
                    <p style="font-size: 14px;">Play the game to unlock lore entries!</p>
                </div>`;else{const u=a.length>0?a[0].id:null;o.innerHTML=`
                <div class="lexicon-categories-panel" id="lexicon-categories"></div>
                <div class="lexicon-entries-panel" id="lexicon-entries"></div>
                <div class="lexicon-detail-panel" id="lexicon-detail">
                    <div class="lexicon-empty-state">
                        <div class="lexicon-empty-icon">ðŸ“œ</div>
                        <p>Select an entry to view details</p>
                    </div>
                </div>`;const h=document.getElementById("lexicon-categories");h.innerHTML=a.map(g=>{const y=i.getEntriesByCategory(g.id).length;return`
                    <button class="lexicon-category-btn ${g.id===u?"active":""}" data-category="${g.id}">
                        <span class="lexicon-category-icon">${g.icon}</span>
                        <span class="lexicon-category-name">${g.name}</span>
                        <span class="lexicon-category-count">${y}</span>
                    </button>`}).join("");const m=g=>{const y=i.getEntriesByCategory(g),f=document.getElementById("lexicon-entries");f.innerHTML=y.map(p=>`
                    <button class="lexicon-entry-btn" data-entry="${p.id}">
                        ${p.icon} ${p.title}
                    </button>`).join(""),f.querySelectorAll(".lexicon-entry-btn").forEach(p=>{p.addEventListener("click",()=>{f.querySelectorAll(".lexicon-entry-btn").forEach(k=>k.classList.remove("active")),p.classList.add("active");const v=p.dataset.entry,b=be[v];if(b){const k=document.getElementById("lexicon-detail");k.innerHTML=`
                                <div class="lexicon-detail-header">
                                    <span class="lexicon-detail-icon">${b.icon}</span>
                                    <h2 class="lexicon-detail-title">${b.title}</h2>
                                </div>
                                <div class="lexicon-detail-content">
                                    ${b.content.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}
                                </div>`}})})};h.querySelectorAll(".lexicon-category-btn").forEach(g=>{g.addEventListener("click",()=>{h.querySelectorAll(".lexicon-category-btn").forEach(y=>y.classList.remove("active")),g.classList.add("active"),m(g.dataset.category),document.getElementById("lexicon-detail").innerHTML=`
                        <div class="lexicon-empty-state">
                            <div class="lexicon-empty-icon">ðŸ“œ</div>
                            <p>Select an entry to view details</p>
                        </div>`})}),u&&m(u)}r.classList.add("hidden"),n.classList.remove("hidden");const c=document.getElementById("lexicon-back-to-title"),d=()=>{n.classList.add("hidden"),r.classList.remove("hidden"),c.removeEventListener("click",d)};c.addEventListener("click",d)}showLexiconModal(e=null,t=null){if(!this.lexicon)return;const i=this.lexicon.getProgress(),s=this.lexicon.getUnreadCount(),a=this.lexicon.getUnlockedCategories();!e&&a.length>0&&(e=a[0].id);const n=e?this.lexicon.getEntriesByCategory(e):[];let r=`
            <div class="lexicon-modal">
                <div class="lexicon-header">
                    <span style="font-size: 24px;">ðŸ“–</span>
                    <div>
                        <h2 style="margin: 0;">Lexicon ${s>0?`<span style="color: #ff6b6b; font-size: 14px;">(${s} new!)</span>`:""}</h2>
                        <div class="lexicon-progress">
                            <div class="lexicon-progress-bar">
                                <div class="lexicon-progress-fill" style="width: ${i.percent}%"></div>
                            </div>
                            <span>${i.unlocked}/${i.total} discovered (${i.percent}%)</span>
                        </div>
                    </div>
                </div>

                <div class="lexicon-content">
                    <div class="lexicon-categories">`;for(const o of a){const l=this.lexicon.getEntriesByCategory(o.id),c=l.length,d=l.some(h=>this.lexicon.isUnread(h.id)),u=o.id===e?"active":"";r+=`
                <div class="lexicon-category ${u} ${d?"has-unread":""}" data-category="${o.id}">
                    <span class="cat-icon">${o.icon}</span>
                    <span>${o.name}</span>
                    <span class="cat-count">${c}${d?"!":""}</span>
                </div>`}if(r+=`
                    </div>
                    <div class="lexicon-entries">`,t){const o=be[t];if(o){this.lexicon.markRead(t),this.updateLexiconBadges();let l=o.content.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n\n/g,"</p><p>").replace(/\n- /g,"<br>â€¢ ");r+=`
                    <div class="lexicon-entry-detail">
                        <button class="lexicon-back-btn" data-back="true">â† Back to List</button>
                        <h2><span class="entry-icon">${o.icon}</span> ${o.title}</h2>
                        <p>${l}</p>
                    </div>`}}else if(n.length>0)for(const o of n){const l=this.lexicon.isUnread(o.id);r+=`
                    <div class="lexicon-entry-item ${l?"unread":""}" data-entry="${o.id}">
                        <span class="entry-icon">${o.icon}</span>
                        <span class="entry-title">${o.title}</span>
                    </div>`}else a.length===0?r+=`
                <div class="lexicon-empty">
                    <span class="empty-icon">ðŸ“–</span>
                    <p>Your lexicon is empty.</p>
                    <p style="font-size: 12px; opacity: 0.7;">Explore the world and use game mechanics to discover entries.</p>
                </div>`:r+=`
                <div class="lexicon-empty">
                    <span class="empty-icon">ðŸ“‚</span>
                    <p>No entries in this category yet.</p>
                </div>`;r+=`
                    </div>
                </div>
            </div>`,this.showModal("Lexicon",r),this.bindLexiconModalEvents(e),e==="factions"&&this.triggerLexicon("view_guilds")}bindLexiconModalEvents(e){var i;const t=this.ui.gameModal;t.querySelectorAll(".lexicon-category").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.category;this.showLexiconModal(a,null)})}),t.querySelectorAll(".lexicon-entry-item").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.entry;this.showLexiconModal(e,a)})}),(i=t.querySelector(".lexicon-back-btn"))==null||i.addEventListener("click",()=>{this.showLexiconModal(e,null)})}triggerLexicon(e){if(!this.lexicon)return;const t=_s[e];t&&this.lexicon.unlock(t)&&this.updateLexiconBadges()}updateLexiconBadges(){if(!this.lexicon)return;const e=this.lexicon.getUnreadCount(),t=document.getElementById("lexicon-badge");t&&(e>0?(t.textContent=e,t.classList.remove("hidden")):t.classList.add("hidden"));const i=document.getElementById("lexicon-panel-badge");i&&(e>0?(i.textContent=e,i.classList.remove("hidden")):i.classList.add("hidden"))}triggerCreatureLexicon(e){if(!this.lexicon)return;const t=e.toLowerCase().replace(/\s+/g,"_"),s={wolf:"defeat_wolf",dire_wolf:"defeat_dire_wolf",bear:"defeat_bear",boar:"defeat_boar",spider:"defeat_spider",giant_spider:"defeat_spider",snake:"defeat_snake",crocodile:"defeat_crocodile",goblin:"defeat_goblin",troll:"defeat_troll",ogre:"defeat_ogre",skeleton:"defeat_skeleton",zombie:"defeat_zombie",ghost:"defeat_ghost",wraith:"defeat_wraith",golem:"defeat_golem",stone_golem:"defeat_golem",iron_golem:"defeat_golem",elemental:"defeat_elemental",fire_elemental:"defeat_elemental",ice_elemental:"defeat_elemental",slime:"defeat_slime",bandit:"defeat_bandit",bandit_leader:"defeat_bandit",cultist:"defeat_cultist",void_cultist:"defeat_cultist",blood_cultist:"defeat_cultist",bat:"defeat_spider",rat:"defeat_spider",construct:"defeat_golem"}[t];s&&this.triggerLexicon(s)}showSacrificeConfirmation(e,t){var n,r;const i=this.citizens.getCitizen(t);if(!i)return;const s=`
            <div class="sacrifice-confirm">
                <div class="sacrifice-warning">âš ï¸ WARNING âš ï¸</div>
                <p>You are about to sacrifice <strong>${i.name}</strong> to the Blood Altar.</p>
                <p>This action:</p>
                <ul>
                    <li>Will permanently kill ${i.name}</li>
                    <li>Grant +100 cult reputation</li>
                    <li>Award 500 gold</li>
                    <li>Decrease your alignment by 25</li>
                    <li>May alert nearby witnesses</li>
                </ul>
                <div class="sacrifice-buttons">
                    <button class="cult-btn cancel-btn" data-action="cancel">Cancel</button>
                    <button class="cult-btn confirm-sacrifice-btn" data-action="confirm">Sacrifice ${i.name}</button>
                </div>
            </div>`;this.showModal("Blood Sacrifice",s);const a=this.ui.gameModal;(n=a.querySelector(".cancel-btn"))==null||n.addEventListener("click",()=>{this.hideModal(),this.showCultShrineModal(e)}),(r=a.querySelector(".confirm-sacrifice-btn"))==null||r.addEventListener("click",()=>{const o=this.cults.sacrificeNPC(t,e);o.success?(this.state.addLog(o.message,"danger"),this.citizens.removeCitizen(t),this.updateUI(),this.hideModal()):this.state.addLog(o.message,"warning")})}handleServiceAction(e){const t=this.state.player.currentPOI;if(console.log("handleServiceAction:",e,"POI:",t),!t){console.error("No currentPOI set for service action!"),this.state.addLog("You must be in a settlement to do this.","warning");return}switch(e){case"rest":this.restAtInn(t);break;case"shop":this.showShopModal(t);break;case"stables":this.showStablesModal(t);break;case"townBoard":this.showLocationModal(t),setTimeout(()=>this.updateTownCard("townBoard"),50);break;case"storage":this.showStorageModal(t);break}}showStablesModal(e){const t=this.travel.getDestinations(e);if([...t.horse,...t.carriage].length===0){this.state.addLog("No travel destinations available from here","info");return}const s=`
            <div class="travel-list">
                ${t.horse.length>0?`
                    <div class="travel-category">
                        <div class="travel-category-header">ðŸ´ Horse - Nearby</div>
                        ${t.horse.map((a,n)=>`
                            <div class="travel-destination" data-type="horse" data-index="${n}">
                                <div class="dest-info">
                                    <div class="dest-name">${a.poi.name}</div>
                                    <div class="dest-type">${a.poi.type.name} â€¢ ${a.distance} hexes</div>
                                </div>
                                <div class="dest-cost">
                                    <span class="cost-gold">${a.cost}g</span>
                                    <span class="cost-time">${a.travelTime}hr</span>
                                </div>
                                <button class="travel-btn" data-type="horse" data-index="${n}" ${this.state.player.gold<a.cost?"disabled":""}>
                                    Travel
                                </button>
                            </div>
                        `).join("")}
                    </div>
                `:""}
                ${t.carriage.length>0?`
                    <div class="travel-category">
                        <div class="travel-category-header">ðŸ›’ Carriage - Farther</div>
                        ${t.carriage.map((a,n)=>`
                            <div class="travel-destination" data-type="carriage" data-index="${n}">
                                <div class="dest-info">
                                    <div class="dest-name">${a.poi.name}</div>
                                    <div class="dest-type">${a.poi.type.name} â€¢ ${a.distance} hexes</div>
                                </div>
                                <div class="dest-cost">
                                    <span class="cost-gold">${a.cost}g</span>
                                    <span class="cost-time">${a.travelTime}hr</span>
                                </div>
                                <button class="travel-btn" data-type="carriage" data-index="${n}" ${this.state.player.gold<a.cost?"disabled":""}>
                                    Travel
                                </button>
                            </div>
                        `).join("")}
                    </div>
                `:""}
            </div>
        `;this.showModal(`Stables - ${e.name}`,s,{backAction:()=>this.showLocationActionsModal(e)}),this._travelDestinations=t,this.ui.modalBody.querySelectorAll(".travel-btn").forEach(a=>{a.addEventListener("click",()=>{const n=a.dataset.type,r=parseInt(a.dataset.index),o=this._travelDestinations[n][r],l=this.travel.travel(o);l&&(this.gameLoop.advanceHours(l),this.hideModal(),this.render())})})}getShopInventory(e){const t=e.type.id,i=[{id:"health_potion",stock:3,markup:1.2},{id:"stamina_potion",stock:3,markup:1.2},{id:"bandage",stock:5,markup:1.1},{id:"rations",stock:10,markup:1},{id:"torch",stock:8,markup:1},{id:"rope",stock:3,markup:1.1}];return(t==="town"||t==="city"||t==="capital")&&i.push({id:"greater_health_potion",stock:2,markup:1.3},{id:"antidote",stock:3,markup:1.2},{id:"waterskin",stock:4,markup:1},{id:"pickaxe",stock:2,markup:1.2},{id:"axe",stock:2,markup:1.2},{id:"lantern",stock:2,markup:1.3}),(t==="city"||t==="capital")&&i.push({id:"tent",stock:1,markup:1.3},{id:"mana_crystal",stock:2,markup:1.4},{id:"iron_sword",stock:1,markup:1.3},{id:"leather_armor",stock:1,markup:1.3},{id:"backpack",stock:1,markup:1.2}),i}showShopModal(e,t="buy"){const i=this.getShopInventory(e),s=this.inventory.getAllItems(),a=.5,n=this.state.player.attributes.agility,r=Math.min(80,30+n*3),o=`
            <div class="shop-container">
                <div class="shop-gold">Your Gold: <span id="shop-gold-display">${this.state.player.gold}g</span></div>

                <div class="shop-tabs">
                    <button class="shop-tab ${t==="buy"?"active":""}" data-tab="buy">Buy</button>
                    <button class="shop-tab ${t==="sell"?"active":""}" data-tab="sell">Sell</button>
                    <button class="shop-tab steal-tab ${t==="steal"?"active":""}" data-tab="steal">Steal</button>
                </div>

                <div class="shop-panel ${t!=="buy"?"hidden":""}" id="shop-buy-panel">
                    <div class="shop-items">
                        ${i.map((l,c)=>{const d=this.getItemDef(l.id);if(!d)return"";const u=Math.ceil(d.value*l.markup),h=this.state.player.gold>=u;return`
                                <div class="shop-item ${h?"":"cant-afford"}">
                                    <span class="shop-icon">${d.icon}</span>
                                    <div class="shop-item-info">
                                        <div class="shop-item-name">${d.name}</div>
                                        <div class="shop-item-stock">Stock: ${l.stock}</div>
                                    </div>
                                    <div class="shop-item-price">${u}g</div>
                                    <button class="shop-buy-btn" data-index="${c}" data-price="${u}" ${!h||l.stock<=0?"disabled":""}>Buy</button>
                                </div>
                            `}).join("")}
                    </div>
                </div>

                <div class="shop-panel ${t!=="sell"?"hidden":""}" id="shop-sell-panel">
                    ${s.length===0?`
                        <div class="shop-empty">You have nothing to sell.</div>
                    `:`
                        <div class="shop-items">
                            ${s.map((l,c)=>{const d=Math.floor(l.value*a);return`
                                    <div class="shop-item">
                                        <span class="shop-icon">${l.icon}</span>
                                        <div class="shop-item-info">
                                            <div class="shop-item-name">${l.name}</div>
                                            <div class="shop-item-qty">Own: ${l.quantity}</div>
                                        </div>
                                        <div class="shop-item-price sell-price">+${d}g</div>
                                        <button class="shop-sell-btn" data-id="${l.id}" data-price="${d}">Sell</button>
                                        ${l.quantity>1?`<button class="shop-sell-btn sell-all" data-id="${l.id}" data-qty="${l.quantity}" data-price="${d*l.quantity}">All</button>`:""}
                                    </div>
                                `}).join("")}
                        </div>
                    `}
                </div>

                <div class="shop-panel ${t!=="steal"?"hidden":""}" id="shop-steal-panel">
                    <div class="steal-warning">
                        <span class="steal-icon">ðŸ¦</span>
                        <span class="steal-chance">Success Chance: ${r}% (Agility: ${n})</span>
                    </div>
                    <div class="steal-risk">Failure triggers combat with the merchant!</div>
                    <div class="shop-items">
                        ${i.filter(l=>l.stock>0).map((l,c)=>{const d=this.getItemDef(l.id);return d?`
                                <div class="shop-item steal-item">
                                    <span class="shop-icon">${d.icon}</span>
                                    <div class="shop-item-info">
                                        <div class="shop-item-name">${d.name}</div>
                                        <div class="shop-item-stock">Stock: ${l.stock}</div>
                                    </div>
                                    <div class="shop-item-price steal-penalty">-5 alignment</div>
                                    <button class="shop-steal-btn" data-index="${c}">Steal</button>
                                </div>
                            `:""}).join("")}
                    </div>
                </div>
            </div>
        `;this.showModal(`Shop - ${e.name}`,o,{backAction:()=>this.showLocationActionsModal(e)}),this._shopItems=i,this._shopPoi=e,this.ui.modalBody.querySelectorAll(".shop-tab").forEach(l=>{l.addEventListener("click",()=>{this.ui.modalBody.querySelectorAll(".shop-tab").forEach(d=>d.classList.remove("active")),l.classList.add("active");const c=l.dataset.tab;document.getElementById("shop-buy-panel").classList.toggle("hidden",c!=="buy"),document.getElementById("shop-sell-panel").classList.toggle("hidden",c!=="sell"),document.getElementById("shop-steal-panel").classList.toggle("hidden",c!=="steal")})}),this.ui.modalBody.querySelectorAll(".shop-buy-btn").forEach(l=>{l.addEventListener("click",()=>{const c=parseInt(l.dataset.index),d=parseInt(l.dataset.price);this.buyFromShop(c,d)})}),this.ui.modalBody.querySelectorAll(".shop-sell-btn").forEach(l=>{l.addEventListener("click",()=>{const c=l.dataset.id,d=l.dataset.qty?parseInt(l.dataset.qty):1;this.sellToShop(c,d)})}),this.ui.modalBody.querySelectorAll(".shop-steal-btn").forEach(l=>{l.addEventListener("click",()=>{const c=parseInt(l.dataset.index);this.attemptSteal(c,e)})})}buyFromShop(e,t){const i=this._shopItems[e];if(!i||i.stock<=0)return;if(this.state.player.gold<t){this.state.addLog("Can't afford that","warning");return}const s=this.inventory.canAdd(i.id,1);if(!s.can){this.state.addLog(s.reason,"warning");return}this.state.player.gold-=t,this.inventory.add(i.id,1),i.stock--;const a=this.getItemDef(i.id);this.state.addLog(`Bought ${a.name} for ${t}g`,"success"),$.playCoin(),this.showToast(`Purchased ${a.name}`,"gold",2e3,a.icon||"ðŸ›’"),this.showShopModal(this._shopPoi)}sellToShop(e,t){this.inventory.sell(e,t,.5)&&this.showShopModal(this._shopPoi,"sell")}attemptSteal(e,t){var o;const i=this._shopItems[e];if(!i||i.stock<=0)return;const s=this.getItemDef(i.id);if(!s)return;const a=this.state.player.attributes.agility,n=Math.min(80,30+a*3)/100;if(Math.random()<n){const l=this.inventory.canAdd(i.id,1);if(!l.can){this.state.addLog(l.reason,"warning");return}this.inventory.add(i.id,1),i.stock--,this.guilds.modifyAlignment(-5,`Stole ${s.name}`),((o=t.data)==null?void 0:o.trustLevel)!==void 0&&(t.data.trustLevel=Math.max(0,t.data.trustLevel-3)),this.state.addLog(`Stole ${s.name}! (-5 alignment)`,"success"),this.showShopModal(this._shopPoi,"steal")}else this.hideModal(),this.state.addLog("Caught stealing! The merchant attacks!","danger"),this.initiateMerchantCombat(t)}initiateMerchantCombat(e){const t={name:`${e.name} Merchant`,icon:"ðŸ§‘â€ðŸ’¼",combatStats:{hp:40,maxHp:40,damage:6,defense:3,agility:5}};this.guilds.modifyAlignment(-3,"Caught stealing"),this._combatNPC=t,this._stealCombatPoi=e;const i={enemy:{id:"merchant_enemy",name:t.name,icon:t.icon,maxHp:t.combatStats.maxHp,currentHp:t.combatStats.hp,damage:[Math.floor(t.combatStats.damage*.8),Math.floor(t.combatStats.damage*1.2)],defense:t.combatStats.defense,chargeTime:1500,xp:15,gold:[5,15],category:"humanoid",templateId:"merchant"},isNPCCombat:!0,isStealCombat:!0,npcRef:t,playerStartHp:this.state.player.health,playerStartEther:this.state.player.ether,round:0,fled:!1,victory:!1,playerBuffs:{},enemyBuffs:{},combatState:{playerAction:null,playerActionData:null,playerChargeTime:0,playerChargeProgress:0,playerReady:!1,enemyChargeProgress:0,paused:!1}};this.encounters.onNPCCombatEnd=s=>this.onStealCombatEnd(s),this.encounters.startCombat(i),this.showCombatModal()}onStealCombatEnd(e){const t=this._stealCombatPoi;e?(this.state.addLog("You defeated the merchant...","danger"),this.guilds.modifyAlignment(-10,"Killed merchant"),t.data&&(t.data.shopClosed=!0,t.data.shopReopenDay=this.state.day+7)):this.state.addLog("You escaped the angry merchant.","warning"),this._stealCombatPoi=null,this.encounters.onNPCCombatEnd=null}showStorageModal(e){var c;const t=`${e.q},${e.r}`,i=this.state.getStorageItems(t),s=this.state.getStorage(t),a=(c=this.townEconomy)==null?void 0:c.getEconomySummary(t,e),n=(a==null?void 0:a.citizenYields)||[],r=(a==null?void 0:a.citizenYieldsValue)||0,o=`
            <div class="storage-container">
                <div class="storage-info">
                    <span>Items: ${s.currentWeight}</span>
                    <span>Capacity: ${s.maxCapacity}</span>
                </div>
                ${i.length===0?`
                    <div class="storage-empty">Storage is empty. Citizens will deposit gathered resources here.</div>
                `:`
                    <div class="storage-items">
                        ${i.map((d,u)=>{const h=this.getItemDef(d.itemId);return`
                                <div class="storage-item" data-index="${u}" data-item="${d.itemId}">
                                    <span class="storage-icon">${(h==null?void 0:h.icon)||"?"}</span>
                                    <span class="storage-name">${(h==null?void 0:h.name)||d.itemId}</span>
                                    <span class="storage-qty">Ã—${d.quantity}</span>
                                    <div class="storage-actions">
                                        <button class="withdraw-btn" data-item="${d.itemId}" data-amount="1" title="Withdraw 1">+1</button>
                                        <button class="withdraw-btn" data-item="${d.itemId}" data-amount="${Math.min(10,d.quantity)}" title="Withdraw 10">+10</button>
                                        <button class="withdraw-btn all" data-item="${d.itemId}" data-amount="${d.quantity}" title="Withdraw All">All</button>
                                    </div>
                                </div>
                            `}).join("")}
                    </div>
                `}

                <div class="storage-section-divider"></div>

                <div class="crafted-goods-section">
                    <div class="crafted-goods-header">
                        <span class="crafted-goods-title">ðŸ› ï¸ Crafted Goods</span>
                        ${n.length>0?`
                            <span class="crafted-goods-value">Value: ${r}g</span>
                        `:""}
                    </div>
                    ${n.length===0?`
                        <div class="storage-empty">No crafted goods yet. Hire citizens to produce items!</div>
                    `:`
                        <div class="crafted-goods-list">
                            ${n.map(d=>`
                                <div class="crafted-good-item" data-item-id="${d.id}">
                                    <span class="crafted-icon">${d.icon}</span>
                                    <span class="crafted-name">${d.name}</span>
                                    <span class="crafted-qty">Ã—${d.quantity}</span>
                                    <span class="crafted-value">${d.value}g ea</span>
                                    <button class="sell-good-btn" data-item-id="${d.id}" title="Sell 1 for ${Math.floor(d.value*.8)}g">Sell</button>
                                </div>
                            `).join("")}
                        </div>
                        <div class="crafted-goods-footer">
                            <span>Sell value: ${Math.floor(r*.8)}g</span>
                            <button class="sell-all-goods-btn">Sell All</button>
                        </div>
                    `}
                </div>
            </div>
        `;this.showModal(`Storage - ${e.name}`,o,{backAction:()=>this.showLocationActionsModal(e)}),this.ui.modalBody.querySelectorAll(".withdraw-btn").forEach(d=>{d.addEventListener("click",()=>{const u=d.dataset.item,h=parseInt(d.dataset.amount);this.withdrawFromStorage(t,u,h,e)})}),this.ui.modalBody.querySelectorAll(".sell-good-btn").forEach(d=>{d.addEventListener("click",()=>{const u=d.dataset.itemId;this.townEconomy.sellCitizenYield(t,u,1).success&&(this.updateUI(),this.showStorageModal(e))})});const l=this.ui.modalBody.querySelector(".sell-all-goods-btn");l&&l.addEventListener("click",()=>{let d=0;for(const u of n){const h=this.townEconomy.sellCitizenYield(t,u.id,u.quantity);h.success&&(d+=h.goldEarned)}d>0&&(this.state.addLog(`Sold all crafted goods for ${d}g`,"success"),this.updateUI(),this.showStorageModal(e))})}withdrawFromStorage(e,t,i,s){var r;const a=this.inventory.canAdd(t,i);if(!a.can){this.state.addLog(a.reason,"warning");return}const n=this.state.removeFromStorage(e,t,i);n>0&&(this.inventory.add(t,n),this.state.addLog(`Withdrew ${n} ${((r=this.getItemDef(t))==null?void 0:r.name)||t}`,"success"),this.showStorageModal(s),this.updateInventoryUI())}showQuestBoardModal(e){const t=this.quests.generateQuestBoard(e),i=this.quests.activeQuests,s=`
            <div class="quest-board">
                ${i.length>0?`
                    <div class="quest-section">
                        <div class="quest-section-header">Active Quests (${i.length}/${this.quests.maxActiveQuests})</div>
                        ${i.map(a=>`
                            <div class="quest-item active">
                                <div class="quest-header">
                                    <span class="quest-name">${a.name}</span>
                                    <span class="quest-difficulty ${a.difficulty.toLowerCase()}">${a.difficulty}</span>
                                </div>
                                <div class="quest-desc">${a.description}</div>
                                <div class="quest-objective">
                                    ${this.formatQuestObjective(a.objective)}
                                </div>
                                <div class="quest-progress-bar">
                                    <div class="quest-progress-fill" style="width: ${a.progress}%"></div>
                                </div>
                                <div class="quest-footer">
                                    <span class="quest-expires">${a.expiresDay-this.state.day} days left</span>
                                    <button class="quest-abandon-btn" data-quest-id="${a.id}">Abandon</button>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                `:""}
                <div class="quest-section">
                    <div class="quest-section-header">Available Quests</div>
                    ${t.length>0?t.map((a,n)=>`
                        <div class="quest-item available">
                            <div class="quest-header">
                                <span class="quest-name">${a.name}</span>
                                <span class="quest-difficulty ${a.difficulty.toLowerCase()}">${a.difficulty}</span>
                            </div>
                            <div class="quest-desc">${a.description}</div>
                            <div class="quest-objective">
                                ${this.formatQuestObjective(a.objective)}
                            </div>
                            <div class="quest-rewards">
                                ${Object.entries(a.rewards).map(([r,o])=>`<span class="reward-tag">+${o} ${r}</span>`).join("")}
                            </div>
                            <div class="quest-footer">
                                <span class="quest-duration">${a.duration} day limit</span>
                                <button class="quest-accept-btn" data-index="${n}" ${i.length>=this.quests.maxActiveQuests?"disabled":""}>
                                    Accept
                                </button>
                            </div>
                        </div>
                    `).join(""):'<div class="no-quests">No quests available. Check back in a few days.</div>'}
                </div>
            </div>
        `;this.showModal(`Quest Board - ${e.name}`,s,{backAction:()=>this.showLocationActionsModal(e)}),this._availableQuests=t,this.ui.modalBody.querySelectorAll(".quest-accept-btn").forEach(a=>{a.addEventListener("click",()=>{const n=parseInt(a.dataset.index),r=this._availableQuests[n];this.quests.acceptQuest(r)&&this.showQuestBoardModal(e)})}),this.ui.modalBody.querySelectorAll(".quest-abandon-btn").forEach(a=>{a.addEventListener("click",()=>{const n=a.dataset.questId;confirm("Abandon this quest?")&&(this.quests.abandonQuest(n),this.showQuestBoardModal(e))})})}formatQuestObjective(e){switch(e.type){case"gather":return`Gather: ${e.current||0}/${e.required} ${e.item.replace("_"," ")}`;case"have_gold":return`Have: ${e.current||0}/${e.required} gold`;case"visit":return`Visit: ${e.targetName} ${e.visited?"âœ“":""}`;case"clear":return`Clear: ${e.targetName} ${e.cleared?"âœ“":""}`;case"bounty":return`Hunt: ${e.current||0}/${e.required} ${e.target}`;case"dungeon_kill":return`Slay: ${e.current||0}/${e.required} in ${e.targetName}`;case"dungeon_boss":return`Defeat boss of ${e.targetName}`;case"dungeon_retrieve":return`Find: ${e.itemId} in ${e.targetName}`;default:return"Unknown objective"}}hexDistance(e,t,i,s){return Math.max(Math.abs(e-i),Math.abs(t-s),Math.abs(e+t-(i+s)))}getCompassTargets(){var l,c,d;const e=[],t=this.state.player.position,i=this.state.discoveredPOIs||new Set,s=150,a={settlement:{label:"Settlement",icon:"ðŸ˜ï¸",type:"town"},landmark:{label:"Dungeon",icon:"ðŸšï¸",type:"dungeon"},cult:{label:"Cult Site",icon:"ðŸ‘ï¸",type:"cult"},guild:{label:"Guild Hall",icon:"ðŸ›ï¸",type:"guild"},resource:{label:"Resource",icon:"â›ï¸",type:"resource"},crafting:{label:"Crafting",icon:"ðŸ”¨",type:"crafting"}};for(const u of this.quests.activeQuests){if(u.completed)continue;let h,m,g;if(u.objective.type==="visit"&&u.objective.poiType){const y=this.pois.find(f=>f.type.id===u.objective.poiType&&!this.state.isPOIVisible(f))||this.pois.find(f=>f.type.id===u.objective.poiType);y&&(h=y.q,m=y.r,g=u.name)}else if(u.objective.type==="return"&&u.originQ!==void 0)h=u.originQ,m=u.originR,g=`Return: ${u.name}`;else if(u.objective.type==="dungeon_floor"||u.objective.type==="dungeon_boss"){const y=this.pois.find(f=>f.type.id==="dungeon");y&&(h=y.q,m=y.r,g=u.name)}h!==void 0&&e.push({type:"quest",category:"Quest",icon:"ðŸ“œ",name:g,q:h,r:m})}const n=(c=(l=this.townActions)==null?void 0:l.getActiveDelivery)==null?void 0:c.call(l);n&&n.toPoi&&e.push({type:"delivery",category:"Delivery",icon:"ðŸ“¦",name:`Deliver to ${n.toPoi.name}`,q:n.toPoi.q,r:n.toPoi.r});const r=(d=this.getStolenDelivery)==null?void 0:d.call(this);r&&r.hideout&&e.unshift({type:"hideout",category:"Hideout",icon:"ðŸ´â€â˜ ï¸",name:`Bandit Hideout (${r.direction})`,q:r.hideout.q,r:r.hideout.r});const o={settlement:[],landmark:[],cult:[],guild:[],resource:[],crafting:[]};for(const u of this.pois){const h=u.type.category;if(!o[h])continue;const m=this.hexDistance(t.q,t.r,u.q,u.r);if(m>0&&m<=s){const g=`${u.q},${u.r}`,y=i.has(g);o[h].push({poi:u,dist:m,discovered:y})}}for(const[u,h]of Object.entries(o)){if(h.length===0)continue;h.sort((g,y)=>g.dist-y.dist);const m=a[u];for(const{poi:g,discovered:y}of h)e.push({type:m.type,category:m.label,icon:y?g.type.icon||m.icon:"â“",name:y?g.name:`Unknown ${m.label}`,q:g.q,r:g.r,discovered:y})}return e}cycleCompassTarget(){const e=this.getCompassTargets();e.length!==0&&(this.compassState.currentTargetIndex=(this.compassState.currentTargetIndex+1)%e.length,this.compassState.targets=e,this.updateCompass())}calculateCompassAngle(e,t){if(!this.grid)return 0;const i=this.state.player.position,s=this.grid.hexToPixel(i.q,i.r),a=this.grid.hexToPixel(e,t),n=a.x-s.x,r=a.y-s.y;return Math.atan2(r,n)*(180/Math.PI)}updateCompassArrow(){if(!this.ui.compass||!this.ui.compassArrow||this.inDungeon||!this.grid)return;const e=this.compassState.targets;if(!e||e.length===0)return;const t=this.compassState.currentTargetIndex;if(t>=e.length)return;const i=e[t],s=this.state.player.position;let a,n;if(this.playerVisualPos)a=this.playerVisualPos.x,n=this.playerVisualPos.y;else{const m=this.grid.hexToPixel(s.q,s.r);a=m.x,n=m.y}const r=this.grid.hexToPixel(i.q,i.r),o=r.x,l=r.y,c=o-a,d=l-n;if(Math.sqrt(c*c+d*d)>1){const m=Math.atan2(d,c)*(180/Math.PI);this.ui.compassArrow.style.transform=`rotate(${m}deg)`}const h=this.hexDistance(s.q,s.r,i.q,i.r);this.ui.compassDistance&&(this.ui.compassDistance.textContent=h===0?"Here!":`${h} hex${h!==1?"es":""}`)}updateCompass(){if(!this.ui.compass)return;if(this.inDungeon){this.ui.compass.classList.add("hidden");return}const e=this.getCompassTargets();if(this.compassState.targets=e,e.length===0){this.ui.compass.classList.add("no-target"),this.ui.compass.classList.remove("hidden","target-quest","target-town","target-dungeon","target-delivery","target-hideout","target-cult","target-guild","target-resource","target-crafting"),this.ui.compassName.textContent="No Target",this.ui.compassDistance.textContent="-- hexes",this.ui.compassIcon.textContent="ðŸ§­",this.ui.compassArrow.style.transform="rotate(0deg)";return}this.compassState.currentTargetIndex>=e.length&&(this.compassState.currentTargetIndex=0);const t=e[this.compassState.currentTargetIndex],i=this.state.player.position,s=this.hexDistance(i.q,i.r,t.q,t.r);this.ui.compass.classList.remove("hidden","no-target","target-quest","target-town","target-dungeon","target-delivery","target-hideout","target-cult","target-guild","target-resource","target-crafting"),this.ui.compass.classList.add(`target-${t.type}`),this.ui.compassIcon.textContent=t.icon;const a=t.category?`${t.category}: `:"";this.ui.compassName.textContent=`${a}${t.name}`,this.ui.compassDistance.textContent=s===0?"Here!":`${s} hex${s!==1?"es":""}`;const n=`[${this.compassState.currentTargetIndex+1}/${e.length}]`;if(this.ui.compassDistance.textContent+=` ${n}`,s>0){const r=this.calculateCompassAngle(t.q,t.r);this.ui.compassArrow.style.transform=`rotate(${r}deg)`}else this.ui.compassArrow.style.transform="rotate(0deg)"}buyFromNPC(e,t){if(!e.tradeInventory||t>=e.tradeInventory.length)return!1;const i=e.tradeInventory[t];if(i.quantity<=0)return!1;const s=i.price;return this.state.player.gold<s?(this.state.addLog("Not enough gold.","warning"),!1):this.inventory.add(i.id,1)?(this.state.player.gold-=s,i.quantity--,this.citizenManager.onTrade(e.uid,s),$.playCoin(),this.showToast(`Purchased ${i.name}`,"gold",2e3,i.icon||"ðŸ›’"),this.state.addLog(`Bought ${i.name} for ${s} gold.`,"success"),!0):(this.state.addLog("Inventory full!","warning"),!1)}showRoamingNPCModal(e){var m;if(e.isDead){this.showNPCLootModal(e);return}const t=e.archetypeData||Me[e.archetype],i=e.canTrade&&((m=e.tradeInventory)==null?void 0:m.length)>0,s=e.currentQuest&&!e.currentQuest.accepted,a=this.citizenManager.getTrustLevel(e.trust);let n=`
            <div style="text-align: center; margin-bottom: 16px;">
                <span style="font-size: 2.5em;">${e.icon}</span>
                <p style="color: #8aa; margin: 4px 0 0 0;">${(t==null?void 0:t.name)||"Traveler"}</p>
                <p style="color: #666; font-size: 0.9em; margin: 0;">From ${e.originName||"unknown lands"}</p>
                <p style="margin: 8px 0 0 0;">
                    <span style="color: ${a.color}; font-weight: bold; text-transform: capitalize;">${a.level}</span>
                    <span style="color: #666; font-size: 0.85em;">(Trust: ${e.trust})</span>
                </p>
            </div>
        `;const r=this.state.player.attributes.agility,o=Math.min(80,30+r*3);if(i){n+=`
                <div class="modal-list">
                    <h4 style="color: #aaa; margin-bottom: 8px;">ðŸ›’ Trade <span style="color: #806060; font-size: 10px; font-weight: normal;">(ðŸ¦ ${o}% success)</span></h4>
            `,e.tradeInventory.forEach((f,p)=>{if(f.quantity>0){const v=Math.floor(f.price*(f.priceModifier||1));n+=`
                        <div class="modal-item">
                            <div class="modal-item-info">
                                <div class="modal-item-name">${f.name}</div>
                                <div class="modal-item-desc">${f.quantity} available</div>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="modal-item-action npc-buy-btn" data-idx="${p}">${v}g</button>
                                <button class="modal-item-action npc-steal-btn" data-idx="${p}" style="background: #3a2020; border-color: #5a3030; color: #c09090;" title="Steal (-5 alignment, combat if caught)">ðŸ¦</button>
                            </div>
                        </div>
                    `}}),n+="</div>";const y=this.inventory.getAllItems().filter(f=>f.value>0&&f.category!=="tool");y.length>0&&(n+=`
                    <div class="modal-list" style="margin-top: 16px;">
                        <h4 style="color: #aaa; margin-bottom: 8px;">ðŸ’° Sell to ${e.name}</h4>
                `,y.forEach(f=>{const p=Math.floor(f.value*.5);p>0&&(n+=`
                            <div class="modal-item">
                                <div class="modal-item-info">
                                    <div class="modal-item-name">${f.icon} ${f.name}</div>
                                    <div class="modal-item-desc">Own: ${f.quantity}</div>
                                </div>
                                <button class="modal-item-action npc-sell-btn" data-item-id="${f.id}" data-price="${p}" style="background: #2a3a2a; border-color: #3a4a3a; color: #90c090;">+${p}g</button>
                            </div>
                        `)}),n+="</div>")}if(s){const g=e.currentQuest,y=Object.entries(g.rewards).map(([f,p])=>`+${p} ${f}`).join(", ");n+=`
                <div class="modal-list" style="margin-top: 16px;">
                    <h4 style="color: #aaa; margin-bottom: 8px;">ðŸ“œ Quest Available</h4>
                    <div class="modal-item" style="flex-direction: column; align-items: flex-start;">
                        <div class="modal-item-name">${g.name} <span style="color: #888;">(${g.difficulty})</span></div>
                        <div class="modal-item-desc" style="margin: 8px 0;">${g.description}</div>
                        <div class="modal-item-stats">
                            <span class="modal-item-stat">â° Expires: Day ${g.expiresDay}</span>
                            <span class="modal-item-stat">ðŸŽ ${y}</span>
                        </div>
                        <button class="modal-item-action npc-accept-quest-btn" style="margin-top: 8px; width: 100%;">Accept Quest</button>
                    </div>
                </div>
            `}!i&&!s&&(n+=`<p style="color: #888; text-align: center; padding: 20px;">The ${(t==null?void 0:t.name)||"traveler"} has nothing to offer right now.</p>`);const l=this.state.player.alignment,c=Object.keys(this.cults.getAllMemberships()).length>0;(l<=0||c)&&(n+=`
                <div class="attack-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #3a2020;">
                    <button class="attack-npc-btn" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #4a1a1a 0%, #2a0a0a 100%); border: 1px solid #6a2a2a; color: #ff8888; border-radius: 4px; cursor: pointer;">
                        âš”ï¸ Attack ${e.name}
                    </button>
                    <p style="color: #666; font-size: 0.8em; text-align: center; margin-top: 6px;">
                        ${c?"Your dark patrons approve...":"Your morals are slipping..."}
                    </p>
                </div>
            `),this._currentNPC=e,this.showModal(e.name,n),this.ui.modalBody.querySelectorAll(".npc-buy-btn").forEach(g=>{g.onclick=y=>{y.stopPropagation();const f=parseInt(g.dataset.idx);this.buyFromNPC(this._currentNPC,f)&&(this.updateUI(),this.showRoamingNPCModal(this._currentNPC))}});const u=this.ui.modalBody.querySelector(".npc-accept-quest-btn");u&&(u.onclick=()=>{this.acceptNPCQuest(this._currentNPC)&&this.showRoamingNPCModal(this._currentNPC)});const h=this.ui.modalBody.querySelector(".attack-npc-btn");h&&(h.onclick=()=>{this.initiateNPCCombat(this._currentNPC)}),this.ui.modalBody.querySelectorAll(".npc-steal-btn").forEach(g=>{g.onclick=y=>{y.stopPropagation();const f=parseInt(g.dataset.idx);this.attemptNPCSteal(this._currentNPC,f)}}),this.ui.modalBody.querySelectorAll(".npc-sell-btn").forEach(g=>{g.onclick=y=>{y.stopPropagation();const f=g.dataset.itemId,p=parseInt(g.dataset.price);if(this.inventory.has(f)){this.inventory.remove(f,1),this.state.player.gold+=p;const v=this.getItemDef(f);this.state.addLog(`Sold ${(v==null?void 0:v.name)||f} to ${this._currentNPC.name} for ${p}g`,"success"),this._currentNPC.trust=Math.min(100,this._currentNPC.trust+1),this.updateUI(),this.showNPCInteractionModal(this._currentNPC)}}})}attemptNPCSteal(e,t){if(!e.tradeInventory||!e.tradeInventory[t])return;const i=e.tradeInventory[t];if(i.quantity<=0)return;const s=this.state.player.attributes.agility,a=Math.min(80,30+s*3)/100;if(Math.random()<a){const r=this.inventory.canAdd(i.id,1);if(!r.can){this.state.addLog(r.reason,"warning");return}this.inventory.add(i.id,1),i.quantity--,this.guilds.modifyAlignment(-5,`Stole from ${e.name}`),e.trust=Math.max(-100,e.trust-30),this.state.addLog(`Stole ${i.name} from ${e.name}! (-5 alignment)`,"success"),this.showRoamingNPCModal(e)}else this.hideModal(),this.state.addLog(`${e.name} caught you stealing!`,"danger"),e.trust=-100,this.initiateNPCCombat(e)}showNPCLootModal(e){if(!e.loot||e.loot.length===0){this.citizenManager.removeDeadNPC(e.uid),this.state.addLog(`${e.name}'s body fades away...`,"info"),this.render();return}let t=`
            <div class="npc-loot-modal">
                <div style="text-align: center; margin-bottom: 16px;">
                    <span style="font-size: 2.5em;">ðŸ’€</span>
                    <p style="color: #888; margin: 4px 0 0 0;">${e.name}'s Remains</p>
                </div>

                <div class="loot-list">
                    <h4 style="color: #aaa; margin-bottom: 8px;">Loot</h4>
                    ${e.loot.map((n,r)=>`
                        <div class="loot-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #1a1a18; border-radius: 4px; margin-bottom: 4px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">${n.icon}</span>
                                <span>${n.name}</span>
                                <span style="color: #888;">x${n.quantity}</span>
                            </div>
                            <button class="loot-take-btn" data-idx="${r}" style="padding: 4px 12px; background: #2a3a2a; border: 1px solid #4a5a4a; color: #8a8; border-radius: 4px; cursor: pointer;">Take</button>
                        </div>
                    `).join("")}
                </div>

                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="loot-all-btn" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #3a4a3a 0%, #2a3a2a 100%); border: 1px solid #5a6a5a; color: #afa; border-radius: 4px; cursor: pointer;">
                        Take All
                    </button>
                    <button class="loot-close-btn" style="flex: 1; padding: 10px; background: #2a2a2a; border: 1px solid #4a4a4a; color: #aaa; border-radius: 4px; cursor: pointer;">
                        Leave
                    </button>
                </div>
            </div>
        `;this._lootNPC=e,this.showModal(`${e.name}'s Remains`,t);const i=document.querySelectorAll(".loot-take-btn"),s=document.querySelector(".loot-all-btn"),a=document.querySelector(".loot-close-btn");i.forEach(n=>{n.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();const o=parseInt(n.dataset.idx);this.takeLootItem(this._lootNPC,o)})}),s&&s.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.takeAllLoot(this._lootNPC)}),a&&a.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.hideModal()})}takeLootItem(e,t){if(!e.loot||t>=e.loot.length)return;const i=e.loot[t];i.itemId==="gold"?(this.state.player.gold+=i.quantity,this.state.addLog(`Looted ${i.quantity} gold`,"success")):(this.inventory.add(i.itemId,i.quantity),this.state.addLog(`Looted ${i.quantity}x ${i.name}`,"success")),e.loot.splice(t,1),e.loot.length===0?(this.citizenManager.removeDeadNPC(e.uid),this.state.addLog(`${e.name}'s body fades away...`,"info"),this.hideModal(),this.render()):this.showNPCLootModal(e),this.updateUI()}takeAllLoot(e){if(!e.loot)return;let t=0,i=0;e.loot.forEach(s=>{s.itemId==="gold"?(t+=s.quantity,this.state.player.gold+=s.quantity):(this.inventory.add(s.itemId,s.quantity),i++)}),t>0&&this.state.addLog(`Looted ${t} gold`,"success"),i>0&&this.state.addLog(`Looted ${i} item(s)`,"success"),e.loot=[],this.citizenManager.removeDeadNPC(e.uid),this.state.addLog(`${e.name}'s body fades away...`,"info"),this.hideModal(),this.updateUI(),this.render()}initiateNPCCombat(e){var r,o,l,c,d;this.hideModal(),this.guilds.modifyAlignment(-10,`Attacked ${e.name}`),this.state.addLog(`You attack ${e.name}!`,"danger"),this._combatNPC=e;const t=((r=e.combatStats)==null?void 0:r.hp)||50,i=((o=e.combatStats)==null?void 0:o.maxHp)||50,s=((l=e.combatStats)==null?void 0:l.damage)||5,a=((c=e.combatStats)==null?void 0:c.agility)||5,n={enemy:{id:"npc_enemy",name:e.name,icon:e.icon,maxHp:i,currentHp:t,damage:[Math.floor(s*.8),Math.floor(s*1.2)],defense:((d=e.combatStats)==null?void 0:d.defense)||3,chargeTime:Math.max(800,2e3*(1-a*.03)),xp:20,gold:[10,30],category:"humanoid",templateId:"npc"},isNPCCombat:!0,npcRef:e,playerStartHp:this.state.player.health,playerStartEther:this.state.player.ether,round:0,fled:!1,victory:!1,playerBuffs:{},enemyBuffs:{},combatState:{playerAction:null,playerActionData:null,playerChargeTime:0,playerChargeProgress:0,playerReady:!1,enemyChargeProgress:0,paused:!1}};this.encounters.onNPCCombatEnd=u=>this.onNPCCombatEnd(u),this.encounters.startCombat(n),this.showCombatModal()}onNPCCombatEnd(e){const t=this._combatNPC;if(t){if(e){this.state.addLog(`${t.name} has been slain...`,"danger"),this.guilds.modifyAlignment(-15,`Killed ${t.name}`),t.isDead=!0,t.icon="ðŸ’€",t.loot=[];const i=10+Math.floor(Math.random()*30);if(t.loot.push({itemId:"gold",quantity:i,name:"Gold",icon:"ðŸ’°"}),t.tradeInventory&&t.tradeInventory.length>0&&t.tradeInventory.forEach(a=>{a.quantity>0&&t.loot.push({itemId:a.id||a.itemId,quantity:a.quantity,name:a.name,icon:a.icon||"ðŸ“¦"})}),this.cults.canHarvest()){const a=this.citizens.harvestBodyParts(t);a&&a.length>0&&a.forEach(n=>{const r=this.getItemDef(n.itemId);t.loot.push({itemId:n.itemId,quantity:n.quantity,name:(r==null?void 0:r.name)||n.itemId,icon:(r==null?void 0:r.icon)||"ðŸ©¸"})})}const s=this.state.player.currentPOI;if(s){const a=this.cults.checkForWitnesses(s,this.citizens);a.length>0&&this.state.addLog(`${a.length} witness(es) saw your crime!`,"danger")}this.state.addLog(`${t.name}'s body can be looted.`,"info")}else this.state.addLog(`${t.name} fought you off!`,"warning"),t.combatStats&&(t.combatStats.isHostile=!0);this._combatNPC=null,this.updateUI(),this.render()}}onBanditAmbushEnd(e,t,i,s=!1){t&&(s?this.createBanditHideout(i):this.townActions.failDelivery(this.inventory,"fled")),this.updateUI(),this.updateCompass(),this.render()}createBanditHideout(e){var o;const t=this.state.player.position,i=[{name:"north",dq:0,dr:-1},{name:"northeast",dq:1,dr:-1},{name:"southeast",dq:1,dr:0},{name:"south",dq:0,dr:1},{name:"southwest",dq:-1,dr:1},{name:"northwest",dq:-1,dr:0}],s=i[Math.floor(Math.random()*i.length)],a=3+Math.floor(Math.random()*6),n=t.q+s.dq*a,r=t.r+s.dr*a;this.stolenDelivery={...e,hideout:{q:n,r},direction:s.name,packageType:e.packageType,reward:e.reward||((o=e.packageType)==null?void 0:o.value)||50},this.townActions.clearActiveDelivery(),this.showBanditEscapeModal(s.name,a)}showBanditEscapeModal(e,t){const i=`
            <div class="bandit-escape-modal">
                <div class="escape-header">
                    <span class="escape-icon">ðŸƒðŸ’¨</span>
                    <h3>Bandits Escaped!</h3>
                </div>
                <div class="escape-message">
                    <p>The bandits knocked you unconscious and fled with your delivery package!</p>
                    <p class="escape-direction">
                        <strong>They fled towards the <span class="direction-highlight">${e}</span></strong>
                    </p>
                    <p class="escape-hint">You can track them to their hideout using your compass and recover the package.</p>
                </div>
                <div class="escape-stats">
                    <div class="stat-item">
                        <span class="stat-label">Your Health</span>
                        <span class="stat-value danger">${this.state.player.health}/${this.state.player.maxHealth}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Estimated Distance</span>
                        <span class="stat-value">~${t} hexes</span>
                    </div>
                </div>
            </div>
        `;this.showModal("Ambush Defeat",i,"bandit-escape")}getStolenDelivery(){return this.stolenDelivery||null}clearStolenDelivery(){this.stolenDelivery=null}startHideoutRaid(e){const t=2+Math.floor(Math.random()*2),i=this.encounters.ENEMIES,s=[];for(let r=0;r<t;r++){const o=r===0,l=o?i.bandit_leader:i.bandit,c=l.hp||l.maxHp||20;s.push({id:r,templateId:o?"bandit_leader":"bandit",...l,maxHp:c,currentHp:c,damage:l.damage,chargeTime:l.chargeTime||1500,chargeProgress:Math.random()*.3,dead:!1})}const a={enemies:s,targetedEnemyIndex:0,isHideoutRaid:!0,stolenDelivery:e,playerStartHp:this.state.player.health,playerStartEther:this.state.player.ether,round:0,fled:!1,victory:!1,playerBuffs:{},enemyBuffs:{},combatState:{playerAction:null,playerActionData:null,playerChargeTime:0,playerChargeProgress:0,playerReady:!1,pendingAction:null,pendingActionData:null,paused:!1}};this.encounters.startCombat(a);const n=this.encounters.onCombatUpdate;this.encounters.onCombatUpdate=(r,o)=>{n&&n(r,o),o&&!o.ongoing&&a.isHideoutRaid&&this.onHideoutRaidEnd(o,e)}}onHideoutRaidEnd(e,t){if(e.victory){const i=t.packageType;i&&i.itemId&&(this.inventory.add(i.itemId,1),t.toPoi?(this.townActions.activeDelivery={id:`recovered_${Date.now()}`,packageType:i,toPoi:t.toPoi,reward:t.reward||50,banditChance:.02,stepsTaken:0},this.state.addLog(`Package recovered! Continue delivery to ${t.toPoi.name}.`,"success")):(this.state.addLog(`Package recovered! +${i.value||30}g`,"success"),this.state.player.gold+=i.value||30)),this.clearStolenDelivery()}else e.fled?this.state.addLog("You fled the hideout. The bandits still have your package.","warning"):(this.state.addLog("You were defeated. The stolen package is lost forever.","danger"),this.clearStolenDelivery());this.updateCompass(),this.updateUI()}showQuestBoard_old(e){const t=this.townActions.generateQuests(e);if(t.length===0){this.state.addLog("No quests available at your reputation level","warning");return}this.state.addLog(`${t.length} quests available:`,"info"),t.forEach(i=>{const s=Object.entries(i.rewards).map(([a,n])=>`+${n} ${a}`).join(", ");this.state.addLog(`â€¢ ${i.name}: ${s}`,"info")})}gatherResource(e){if(this.state.player.stamina<10){this.state.addLog("Too tired to gather. Rest first!","warning");return}this.state.player.stamina-=10,this.gameLoop.advanceHours(1);const t=e.data.output,i=We[t],s=i?D[i]:null,a=Math.floor(Math.random()*3)+1;s&&i?this.inventory.add(i,a)?(this.state.addLog(`Gathered ${a}x ${s.name}`,"success"),this.state.showResourcePopup(s.icon||"ðŸ“¦",`+${a} ${s.name}`),$.playPickup(),this.townActions&&this.townActions.updateTaskProgress("gather",i,a),this.guilds&&this.guilds.updateContractProgress("gather",{resource:i,amount:a}),this.awardGatheringXPToNearestSettlement(i,a)):this.state.addLog("Inventory full!","warning"):(this.state.addLog(`Gathered ${a}x ${t}`,"success"),this.state.showResourcePopup("ðŸŒ¿",`+${a} ${t}`),$.playPickup()),this.state.player.exp+=5}awardGatheringXPToNearestSettlement(e,t){var l,c,d,u,h;const i=ki(e);if(!i)return;const s=this.state.player.position;let a=null,n=1/0;for(const m of this.pois){const g=typeof m.type=="string"?m.type:(l=m.type)==null?void 0:l.id;if(!["hamlet","village","town","city","capital","citadel"].includes(g))continue;const y=m.q-s.q,f=m.r-s.r,p=Math.abs(y)+Math.abs(f)+Math.abs(-y-f);p<n&&(n=p,a=m)}if(!a||n>10)return;const r=a.key||`${a.q},${a.r}`;let o=!1;for(const[m,g]of Object.entries(i)){const y=g*t;((d=(c=this.state).awardTownAttributeXP)==null?void 0:d.call(c,r,m,y))!==!1&&(o=!0)}if(o){const m=Object.keys(i).map(g=>({agriculture:"ðŸŒ¾",construction:"ðŸ”¨",medicine:"âš•ï¸",tailoring:"ðŸ§µ",warriors:"âš”ï¸",smithing:"âš’ï¸",rangers:"ðŸ¹"})[g]||g).join("");(h=(u=this.state).showResourcePopup)==null||h.call(u,m,`+XP ${a.name}`)}}restAtInn(e){const t=e.type.size*5;if(this.state.player.gold<t){this.state.addLog(`Not enough gold (${t}g required)`,"warning");return}this.state.player.gold-=t,this.state.player.stamina=this.state.player.maxStamina,this.state.player.health=this.state.player.maxHealth,this.gameLoop.advanceHours(8),this.state.addLog(`Rested at ${e.name} (-${t}g)`,"success"),this.render()}bindUIEvents(){this.ui.restBtn.addEventListener("click",()=>{if(this.encounters.hasEnemiesNearby(this.grid,this.maxPathLength)){this.state.addLog("Cannot rest with enemies nearby!","warning");return}this.gameLoop.rest(1),this.processEnemyTurn(),this.resetIdleTimer()}),this.ui.tentBtn.addEventListener("click",()=>{this.makeCamp(),this.resetIdleTimer()}),this.ui.waitBtn.addEventListener("click",()=>{this.toggleTimeMode()}),this.ui.cancelActionBtn.addEventListener("click",()=>{this.currentTownActionSound&&(this.currentTownActionSound.stop(!1),this.currentTownActionSound=null),this.townActions.cancelAction(),this.ui.actionProgress.classList.add("hidden"),this.ui.progressFill.style.width="0%"}),this.ui.playerLocation.addEventListener("click",()=>{this.focusOnCurrentLocation()}),this.ui.modalClose.addEventListener("click",()=>{var i;(i=this.encounters)!=null&&i.isInCombat()||this.hideModal()}),this.ui.gameModal.querySelector(".modal-backdrop").addEventListener("click",()=>{var i;(i=this.encounters)!=null&&i.isInCombat()||this.hideModal()}),document.querySelectorAll(".ui-panel.collapsible .panel-header").forEach(i=>{i.addEventListener("click",()=>{const s=i.dataset.toggle,a=document.getElementById(s);a&&(a.classList.toggle("collapsed"),i.classList.toggle("collapsed"))})}),this.ui.compass&&this.ui.compass.addEventListener("click",()=>{this.cycleCompassTarget()});const e=document.getElementById("lexicon-btn");e&&e.addEventListener("click",()=>{this.showLexiconModal()});const t=document.getElementById("lexicon-float-btn");t&&t.addEventListener("click",()=>{this.showLexiconModal()}),this.canvas.addEventListener("click",i=>{var s;try{if(this.hideHexMenu(),this.encounters.isInCombat())return;if(this.inDungeon){if((s=this.dungeonTravelState)!=null&&s.isMoving)return;if(this.pathPreview&&this.pathPreview.length>1){this.walkAlongDungeonPath();return}this.handleDungeonInteraction(i.clientX,i.clientY);return}const a=this.findNPCAtScreen(i.clientX,i.clientY);if(a){const o=this.state.player.position;if(this.hexDistance(o.q,o.r,a.currentQ,a.currentR)<=1){this.showRoamingNPCModal(a);return}else{this.state.addLog(`${a.name} is too far away. Move closer!`,"info");return}}const n=this.findHexAtScreen(i.clientX,i.clientY),r=this.findPOIAtScreen(i.clientX,i.clientY);if(r&&r!==this.state.player.currentPOI){const o=this.state.player.position,l=this.grid.distance(o.q,o.r,r.q,r.r);if(l<=2){this.gameLoop.travelTo(r,this.grid),this.townActions&&this.townActions.getActiveDelivery()&&this.townActions.completeDelivery(this.inventory)&&this.updateCompass(),this.quests&&this.quests.checkProgress(),this.clearPathPreview(),this.resetIdleTimer();return}else{if(l<=this.maxPathLength){const d=this.grid.getCell(r.q,r.r);d&&(this.updatePathPreview(d),this.state.addLog(`Click again to walk to ${r.name}.`,"info"))}else this.state.addLog(`${r.name} is ${l} hexes away. Move closer first.`,"info");return}}this.pathPreview&&this.pathPreview.length>1&&(this.walkAlongPath(),this.resetIdleTimer())}catch(a){console.error("Click handler error:",a),this.state.addLog("An error occurred. Check console.","warning")}}),this.canvas.addEventListener("contextmenu",i=>{if(i.preventDefault(),this.encounters.isInCombat())return;const s=this.findHexAtScreen(i.clientX,i.clientY);s&&s.biome&&this.showHexMenu(s,i.clientX,i.clientY)}),this.pathPreview=null,this.baseMaxPathLength=6,this.canvas.addEventListener("mousemove",i=>{var a,n;if(this.encounters.isInCombat()){this.clearPathPreview();return}if((a=this.travelState)!=null&&a.isMoving||(n=this.dungeonTravelState)!=null&&n.isMoving)return;const s=this.findHexAtScreen(i.clientX,i.clientY);s&&s.biome?this.inDungeon?this.updateDungeonPathPreview(s):this.updatePathPreview(s):this.clearPathPreview(),this.handleMouseMove(i.clientX,i.clientY)}),this.ui.hexMenuClose.addEventListener("click",()=>{this.hideHexMenu()}),document.addEventListener("click",i=>{!this.ui.hexMenu.contains(i.target)&&!this.canvas.contains(i.target)&&this.hideHexMenu()}),document.querySelectorAll(".attr-item[data-tooltip]").forEach(i=>{i.addEventListener("mouseenter",s=>{const a=i.dataset.tooltip,n=i.querySelector(".attr-label").textContent;this.tooltip.innerHTML=`
                    <div class="tooltip-header">
                        <span class="tooltip-icon">${i.querySelector(".attr-icon").textContent}</span>
                        <div>
                            <div class="tooltip-title">${n}</div>
                        </div>
                    </div>
                    <div class="tooltip-lore">${a}</div>
                `,this.tooltip.classList.remove("hidden"),this.positionTooltip(s.clientX,s.clientY)}),i.addEventListener("mousemove",s=>{this.positionTooltip(s.clientX,s.clientY)}),i.addEventListener("mouseleave",()=>{this.tooltip.classList.add("hidden")})})}focusOnCurrentLocation(){const e=this.state.player.currentPOI;if(!e)return;const t=this.grid.hexToPixel(e.q,e.r);this.renderer.offsetX=this.renderer.width/2-t.x*this.renderer.scale,this.renderer.offsetY=this.renderer.height/2-t.y*this.renderer.scale,this.render()}findHexAtScreen(e,t){const i=this.renderer.scale,s=(e-this.renderer.offsetX)/i,a=(t-this.renderer.offsetY)/i,n=this.grid.pixelToHex(s,a);return this.grid.getCell(n.q,n.r)}findNPCAtScreen(e,t){var r;const i=((r=this.citizenManager)==null?void 0:r.getRoamingNPCs())||[];if(i.length===0)return null;const s=this.renderer.scale,a=8,n=11*s;for(const o of i){const l=this.grid.getCell(o.currentQ,o.currentR);if(!l)continue;const c=this.grid.hexToPixel(o.currentQ,o.currentR),d=(l.elevation-.4)*a*s,u=c.x*s+this.renderer.offsetX,h=c.y*s+this.renderer.offsetY-d,m=e-u,g=t-h;if(Math.sqrt(m*m+g*g)<=n)return o}return null}acceptNPCQuest(e){if(!e||!e.currentQuest)return!1;const t=e.currentQuest,i=this.quests.acceptQuest(t);return i&&(e.currentQuest=null,this.citizenManager.modifyTrust(e.uid,2,"accepted quest")),i}getDepletedActionsForHex(e){return[]}showHexMenu(e,t,i){const s=this.hexActions.getActionsForHex(e),a=this.getDepletedActionsForHex(e),n=this.hexActions.hasChest(e),r=n?this.hexActions.getChestInfo(e):null;if(s.length===0&&a.length===0&&!n)return;this.selectedHex=e;const o=this.ui,l=this.hexActions.getDistanceToHex(e),c=l===0?"Here":l===1?"Adjacent":`${l} hexes away`,d=l>this.hexActions.maxGatherDistance;o.hexMenuBiome.innerHTML=`${e.biome.name} <span class="hex-distance ${d?"too-far":""}">(${c})</span>`;let u=s.map(p=>{const v=this.hexActions.canPerform(p,e);return`
                <button class="hex-action-btn" data-action-id="${p.id}" ${v.can?"":"disabled"} ${v.can?"":`title="${v.reason}"`}>
                    <span class="action-icon">${p.icon}</span>
                    <div class="action-info">
                        <div class="action-name">${p.name}</div>
                        <div class="action-detail">${p.resource} â€¢ ${p.staminaCost} stamina</div>
                    </div>
                    <span class="action-remaining">Ã—${p.remaining}</span>
                </button>
            `}).join("");if(u+=a.map(p=>`
                <div class="hex-action-btn depleted" disabled>
                    <span class="action-icon">${p.icon}</span>
                    <div class="action-info">
                        <div class="action-name">${p.name}</div>
                        <div class="action-detail depleted-text">Regenerates in ${p.daysUntil} day${p.daysUntil>1?"s":""}</div>
                    </div>
                    <span class="action-remaining depleted">âœ—</span>
                </div>
            `).join(""),n&&r){const p=l<=1;u+=`
                <button class="hex-action-btn chest-action" data-action-id="open_chest" ${p?"":'disabled title="Move closer to open"'}>
                    <span class="action-icon">${r.icon}</span>
                    <div class="action-info">
                        <div class="action-name">Open ${r.name}</div>
                        <div class="action-detail">Discover loot</div>
                    </div>
                </button>
            `}o.hexMenuActions.innerHTML=u;const h=r;o.hexMenuActions.querySelectorAll(".hex-action-btn").forEach(p=>{p.addEventListener("click",()=>{const v=p.dataset.actionId;if(v==="open_chest"&&h){this.showChestModal(h),this.hideHexMenu();return}const b=s.find(k=>k.id===v);b&&this.startHexAction(e,b)})});const m=10;let g=t+m,y=i+m;o.hexMenu.classList.remove("hidden");const f=o.hexMenu.getBoundingClientRect();g+f.width>window.innerWidth&&(g=t-f.width-m),y+f.height>window.innerHeight&&(y=i-f.height-m),o.hexMenu.style.left=g+"px",o.hexMenu.style.top=y+"px"}hideHexMenu(){this.ui.hexMenu.classList.add("hidden"),this.selectedHex=null}startHexAction(e,t){this.hideHexMenu();const i=this.grid.hexToPixel(e.q,e.r),s=i.x*this.renderer.scale+this.renderer.offsetX,a=i.y*this.renderer.scale+this.renderer.offsetY,n=this.grid.hexSize*this.renderer.scale,r=this.ui.hexOverlay,o=n*2.5;r.style.left=s-o/2+"px",r.style.top=a-o/2+"px",r.style.width=o+"px",r.style.height=o+"px",this.ui.hexProgressIcon.textContent=t.icon,this.ui.hexProgressText.textContent="0%",this.ui.hexProgressFill.style.clipPath="inset(100% 0 0 0)",r.classList.remove("hidden");const l=$.startProgressSound(200,500);this.hexActions.startAction(e,t,c=>{const d=Math.floor(c);this.ui.hexProgressText.textContent=d+"%",this.ui.hexProgressFill.style.clipPath=`inset(${100-c}% 0 0 0)`,l.update(c)},(c,d,u)=>{if(l.stop(!0),r.classList.add("hidden"),this.updateUI(),u>0){const h=this.grid.hexToPixel(d.q,d.r),m=h.x*this.renderer.scale+this.renderer.offsetX,g=h.y*this.renderer.scale+this.renderer.offsetY;setTimeout(()=>{this.showHexMenu(d,m,g)},300)}})}generateWorld(){this.grid.generate(),this.worldGen.generate(this.grid,{elevationScale:.02,moistureScale:.03,elevationOctaves:6,moistureOctaves:4,islandFactor:.5,redistributePower:1,continentScale:.008}),this.rivers=this.riverGen.generate(this.grid,{riverCount:6,minLength:12,maxLength:50,startElevation:.7,meanderStrength:.5}),this.pois=this.poiGen.generate(this.grid,{density:1.2,maxPOIs:150}),this.roads=this.roadGen.generate(this.grid,this.pois,{connectSettlements:!0,connectToLandmarks:!0,maxRoadLength:45}),this.render()}regenerateWorld(){this.renderer._centered=!1,this.worldGen.regenerate(this.grid,{elevationScale:.02,moistureScale:.03,elevationOctaves:6,moistureOctaves:4,islandFactor:.5,redistributePower:1,continentScale:.008}),this.rivers=this.riverGen.regenerate(this.grid,this.worldGen.seed,{riverCount:6,minLength:12,maxLength:50,startElevation:.7,meanderStrength:.5}),this.pois=this.poiGen.regenerate(this.grid,this.worldGen.seed,{density:1.2,maxPOIs:150}),this.roads=this.roadGen.regenerate(this.grid,this.pois,{connectSettlements:!0,connectToLandmarks:!0,maxRoadLength:45}),this.state=new ue,this.state.pois=this.pois,this.gameLoop.state=this.state,this.state.subscribe(()=>this.updateUI()),this.setupPlayer(),this.state.addLog("New world generated","discovery"),this.updateUI(),this.render()}getTorchLight(){if(!this.state||!this.state.equippedTorch)return 0;const e=this.state.equippedTorch,t=e.currentBurn/e.burnDuration;return e.lightRadius*(1-t*.5)}getMaxWalkRange(){return this.baseMaxPathLength||6}get maxPathLength(){return this.getMaxWalkRange()}equipTorch(){if(!this.inventory.has("torch"))return this.state.addLog("No torches in inventory!","warning"),!1;this.state.equippedTorch&&this.unequipTorch();const e=D.torch;return this.state.equippedTorch={lightRadius:e.lightRadius,burnDuration:e.burnDuration,currentBurn:0},this.inventory.remove("torch",1),this.state.addLog("Lit a torch.","info"),this.render(),!0}unequipTorch(){this.state.equippedTorch&&(this.state.equippedTorch=null,this.state.addLog("Extinguished torch.","info"),this.render())}updateTorch(){if(!this.state.equippedTorch)return;const e=this.state.equippedTorch;e.currentBurn++,e.currentBurn>=e.burnDuration&&(this.state.equippedTorch=null,this.state.addLog("Your torch has burned out!","warning"),this.inventory.has("torch")&&this.equipTorch())}useItem(e){if(!this.inventory.has(e))return this.state.addLog(`You don't have any ${e}.`,"warning"),!1;const t=D[e];if((t==null?void 0:t.category)==="relic")return this.useRelic(e,t);switch(e){case"rope":return this.useRope();case"tent":return this.useTent();default:return this.state.addLog("You can't use that item here.","warning"),!1}}useRelic(e,t){if(this.inDungeon)return this.state.addLog("You can't use relics inside dungeons. Return to the surface first.","warning"),!1;if(!this.auraSystem)return this.state.addLog("No corruption to cleanse.","info"),!1;const i=this.state.player.position.q,s=this.state.player.position.r,a=this.auraSystem.getCleanseableAuras(i,s);return a.length===0?(this.state.addLog("No corruption zones nearby. Travel closer to a corrupted area.","warning"),!1):(this.showRelicCleanseConfirmation(e,t,a),!0)}showRelicCleanseConfirmation(e,t,i){var n,r;const s=i.map(o=>{var c;return`â€¢ ${(((c=this.auraSystem.constructor.AURA_EFFECTS)==null?void 0:c[o.cultType])||{name:o.cultType.replace("_"," ")}).name||o.cultType} (Power: ${o.power.toFixed(1)})`}).join("<br>"),a=`
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">${t.icon||"âœ¨"}</div>
                <h3 style="margin: 10px 0;">${t.name}</h3>
                <p style="opacity: 0.8; margin-bottom: 15px;">${t.description}</p>

                <div style="background: rgba(100,30,30,0.3); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <div style="font-weight: bold; margin-bottom: 8px;">Nearby Corruption:</div>
                    <div style="text-align: left; font-size: 13px;">${s}</div>
                </div>

                <p style="color: #ff9; margin: 15px 0;">
                    âš ï¸ Using this relic will <strong>consume</strong> it permanently!
                </p>

                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button id="confirm-cleanse" style="padding: 10px 20px; background: #4a9; border: none; color: white; border-radius: 6px; cursor: pointer;">
                        Perform Cleansing Ritual
                    </button>
                    <button id="cancel-cleanse" style="padding: 10px 20px; background: #666; border: none; color: white; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            </div>
        `;this.showModal("Cleanse Corruption",a),(n=document.getElementById("confirm-cleanse"))==null||n.addEventListener("click",()=>{this.performCleansingRitual(e,t),this.hideModal()}),(r=document.getElementById("cancel-cleanse"))==null||r.addEventListener("click",()=>{this.hideModal()})}performCleansingRitual(e,t){const i=this.state.player.position.q,s=this.state.player.position.r,a=this.auraSystem.cleanseAura(i,s,e,t);a.success?(this.inventory.remove(e,1),this.state.addLog(`âœ¨ ${a.message}`,"success"),this.showToast("Corruption Cleansed!","success"),this.gameLoop.advanceHours(2),this.updateUI(),this.render()):this.state.addLog(a.reason,"warning")}useRope(){return this.inDungeon?(this.inventory.remove("rope",1),this.state.addLog("You secure the rope and climb out of the dungeon!","success"),this.exitDungeon(),!0):(this.state.addLog("You can only use rope in dungeons to escape.","warning"),!1)}useTent(){return this.inDungeon?(this.state.addLog("You can't set up a tent in a dungeon!","warning"),!1):(this.state.addLog("You set up the tent for rest.","info"),!0)}render(){var i,s,a,n,r,o,l,c,d,u;const e=performance.now();if(this.lastRenderTime&&e-this.lastRenderTime<16){this._renderPending||(this._renderPending=!0,requestAnimationFrame(()=>{this._renderPending=!1,this.render()}));return}this.lastRenderTime=e;const t=window.PERF_MONITOR?performance.now():null;try{if(!this.grid){console.error("render: No grid available");return}const h=this.maxPathLength||6;this.inDungeon?this.renderer.setTime(22,0):this.renderer.setTime(this.state.hour,this.state.minute),this.music&&!this.inDungeon&&this.music.updateTimeOfDay(this.state.hour);const m=this.getTorchLight(),g=this.inDungeon&&this.currentDungeon?this.currentDungeon.playerPosition:(s=(i=this.state)==null?void 0:i.player)==null?void 0:s.position;g&&!((a=this.playerTransition)!=null&&a.active)&&this.renderer.centerOnHex(this.grid,g.q,g.r);let y=null;(n=this.playerTransition)!=null&&n.active&&this.playerTransition.fromHex&&this.playerTransition.toHex&&(y={fromQ:this.playerTransition.fromHex.q,fromR:this.playerTransition.fromHex.r,toQ:this.playerTransition.toHex.q,toR:this.playerTransition.toHex.r,t:this.playerTransition.t||0});const f={showStroke:!0,strokeColor:"rgba(0, 0, 0, 0.15)",shadingIntensity:.2,pathPreview:this.pathPreview,playerPosition:g,playerVisualPos:this.inDungeon?null:this.playerVisualPos,playerTransitionInfo:this.inDungeon?null:y,walkRange:h,worldEnemies:this.inDungeon?[]:((r=this.state)==null?void 0:r.worldEnemies)||[],roamingNPCs:this.inDungeon?[]:((o=this.citizenManager)==null?void 0:o.getRoamingNPCs())||[],corruptionAuras:this.inDungeon?[]:((l=this.auraSystem)==null?void 0:l.getAllAffectedHexes())||[],overworldCorruption:this.inDungeon?null:this.overworldCorruption,torchLight:this.inDungeon?Math.max(m,5):m,facingAngle:this.playerFacingAngle||0,openedChests:((c=this.state)==null?void 0:c.openedChests)||new Set};if(this.inDungeon&&this.currentDungeon){const v=this.currentDungeon;g&&v.currentFloor&&v.currentFloor.explored.add(`${g.q},${g.r}`),f.isDungeon=!0,f.dungeonExplored=v.explored,f.dungeonEnemies=v.enemies,f.dungeonChests=v.chests,f.dungeonExits=v.exits,f.dungeonLadders=v.ladders,f.dungeonDoors=v.doors,f.dungeonPortals=v.portals,f.dungeonBossPosition=(d=v.currentFloor)==null?void 0:d.bossPosition,f.dungeonQuestItems=v.questItems;const b=!!this.state.equippedTorch;f.dungeonFloorBrightness=v.getFloorBrightness(b),f.dungeonFloorLevel=v.currentFloorIndex,f.dungeonRequiresTorch=v.requiresTorch(),f.dungeonHasTorch=b}const p=this.inDungeon?this.pois:this.state.getVisiblePOIs(this.pois);if(this.renderer.renderWorld(this.grid,p,this.roads,f,this.rivers),t&&window.PERF_MONITOR){const v=performance.now()-t;if(this.perfStats||(this.perfStats={renderTimes:[],frameCount:0}),this.perfStats.renderTimes.push(v),this.perfStats.frameCount++,this.perfStats.frameCount%60===0){const b=this.perfStats.renderTimes.reduce((x,C)=>x+C,0)/this.perfStats.renderTimes.length,k=Math.max(...this.perfStats.renderTimes),w=Math.min(...this.perfStats.renderTimes);console.log(`Performance: Avg render ${b.toFixed(2)}ms, Min ${w.toFixed(2)}ms, Max ${k.toFixed(2)}ms`),this.perfStats.renderTimes=[],b>33.33&&console.warn(`Performance warning: Average render time ${b.toFixed(2)}ms (target: <16.67ms for 60fps)`)}}this.updateCompassArrow(),this.inDungeon?this.updateDungeonMinimap():(u=document.getElementById("dungeon-minimap"))==null||u.classList.add("hidden"),this.renderWorldMinimap()}catch(h){if(console.error("render error:",h),window.PERF_MONITOR&&t){const m=performance.now()-t;console.error(`Render failed after ${m.toFixed(2)}ms`)}}}updateDungeonMinimap(){var f;const e=document.getElementById("dungeon-minimap"),t=document.getElementById("minimap-canvas");if(!this.inDungeon||!this.currentDungeon||!e||!t){e==null||e.classList.add("hidden");return}e.classList.remove("hidden"),document.getElementById("minimap-floor").textContent=this.currentDungeon.currentFloorIndex+1;const i=t.getContext("2d"),s=this.currentDungeon.explored,a=this.currentDungeon.playerPosition;if(!s||s.size===0)return;i.fillStyle="#0a0a0a",i.fillRect(0,0,150,150);let n=1/0,r=-1/0,o=1/0,l=-1/0;for(const p of s){const[v,b]=p.split(",").map(Number);n=Math.min(n,v),r=Math.max(r,v),o=Math.min(o,b),l=Math.max(l,b)}const c=2,d=r-n+1+c*2,u=l-o+1+c*2,h=Math.min(150/d,150/u,8),m=(150-d*h)/2,g=(150-u*h)/2;for(const p of s){const[v,b]=p.split(",").map(Number),k=m+(v-n+c)*h,w=g+(b-o+c)*h,x=this.grid.getCell(v,b);i.fillStyle=(f=x==null?void 0:x.biome)!=null&&f.impassable?"#2a2a2a":"#3a3a4a",i.fillRect(k,w,h-1,h-1)}const y=Math.max(2,h*.6);for(const p of this.currentDungeon.ladders||[])if(s.has(`${p.q},${p.r}`)){const v=m+(p.q-n+c)*h+h/2,b=g+(p.r-o+c)*h+h/2;i.fillStyle="#ff9944",i.beginPath(),i.arc(v,b,y,0,Math.PI*2),i.fill()}for(const p of this.currentDungeon.exits||[])if(s.has(`${p.q},${p.r}`)){const v=m+(p.q-n+c)*h+h/2,b=g+(p.r-o+c)*h+h/2;i.fillStyle="#44ff44",i.beginPath(),i.arc(v,b,y,0,Math.PI*2),i.fill()}if(a){const p=m+(a.q-n+c)*h+h/2,v=g+(a.r-o+c)*h+h/2;i.fillStyle="#ffffff",i.beginPath(),i.arc(p,v,y*1.5,0,Math.PI*2),i.fill()}}setupParticleCanvas(){!this.particleCanvas||!this.particles||(this.resizeParticleCanvas(),this.particles.start(),this.weatherAudioInterval=setInterval(()=>{if(this.biomeAudio&&this.particles&&!this.inDungeon){const e=this.particles.getWeatherType();this.biomeAudio.setWeather(e)}},1e3))}resizeParticleCanvas(){if(!this.particleCanvas)return;const e=window.devicePixelRatio||1,t=this.canvas.getBoundingClientRect();this.particleCanvas.width=t.width*e,this.particleCanvas.height=t.height*e,this.particleCanvas.style.width=t.width+"px",this.particleCanvas.style.height=t.height+"px",this.particleCanvas.getContext("2d").setTransform(e,0,0,e,0,0)}renderWorldMinimap(){var u,h,m,g,y,f;if(!this.worldMinimapCtx||!this.grid||!this.worldMinimapCanvas||!this.worldMinimapContainer)return;if(this.inDungeon){this.worldMinimapContainer.classList.add("hidden");return}this.worldMinimapContainer.classList.remove("hidden");const e=this.worldMinimapCtx,t=this.worldMinimapCanvas,i=t.width,s=t.height;e.fillStyle="#0a0a0a",e.fillRect(0,0,i,s);const a=this.gridWidth||120,n=this.gridHeight||120,r=Math.min(i/a,s/n),o=(i-a*r)/2,l=(s-n*r)/2,c=((u=this.state)==null?void 0:u.exploredHexes)||new Set,d=(m=(h=this.state)==null?void 0:h.player)==null?void 0:m.position;if(d&&this.state)for(let v=-8;v<=8;v++)for(let b=-8;b<=8;b++){const k=d.q+v,w=d.r+b;Math.max(Math.abs(v),Math.abs(b),Math.abs(-v-b))<=8&&this.state.exploredHexes.add(`${k},${w}`)}if(this.grid.forEach(p=>{if(!p.biome)return;const v=`${p.q},${p.r}`;if(!c.has(v))return;const b=o+p.q*r,k=l+p.r*r;e.fillStyle=p.biome.color,e.fillRect(b,k,r+.5,r+.5)}),this.pois&&this.pois.length>0)for(const p of this.pois){const v=`${p.q},${p.r}`;if(!c.has(v))continue;const b=o+p.q*r+r/2,k=l+p.r*r+r/2;let w="#ffcc00";((g=p.type)==null?void 0:g.category)==="settlement"?w="#ffffff":((y=p.type)==null?void 0:y.category)==="dungeon"?w="#ff4444":((f=p.type)==null?void 0:f.category)==="landmark"&&(w="#44ff44"),e.fillStyle=w,e.beginPath(),e.arc(b,k,Math.max(2,r*.8),0,Math.PI*2),e.fill()}if(this.renderer&&d){const p=this.renderer.width/this.renderer.scale/this.grid.hexSize/2,v=this.renderer.height/this.renderer.scale/this.grid.hexSize/1.5,b=o+(d.q-p/2)*r,k=l+(d.r-v/2)*r,w=p*r,x=v*r;e.strokeStyle="rgba(255, 255, 255, 0.4)",e.lineWidth=1,e.strokeRect(b,k,w,x)}if(d){const p=o+d.q*r+r/2,v=l+d.r*r+r/2;e.fillStyle="rgba(100, 200, 255, 0.5)",e.beginPath(),e.arc(p,v,Math.max(4,r*1.5),0,Math.PI*2),e.fill(),e.fillStyle="#ffffff",e.beginPath(),e.arc(p,v,Math.max(2,r*.8),0,Math.PI*2),e.fill()}}updateParticleBiome(){var s,a,n,r;if(this.inDungeon){this.particles&&this.particles.setEnabled(!1),this.biomeAudio&&this.biomeAudio.stopAll();return}this.particles&&this.particles.setEnabled(!0);const e=(a=(s=this.state)==null?void 0:s.player)==null?void 0:a.position;if(!e)return;const t=(n=this.grid)==null?void 0:n.getCell(e.q,e.r);if(!t||!t.biome)return;const i=this.state.hour>=20||this.state.hour<6;if(this.particles)if(this.particles.setBiome(t.biome.id),this.particles.setNight(i),this.overworldCorruption){const o=this.overworldCorruption.getZoneAt(e.q,e.r);this.particles.setCorruptionZone(o)}else this.particles.setCorruptionZone(null);if(this.biomeAudio&&this.overworldCorruption){const o=this.overworldCorruption.getZoneAt(e.q,e.r);this.biomeAudio.setCorruptionZone(o)}if(this.biomeAudio){this.biomeAudio.setNight(i),this.biomeAudio.setBiome(t.biome.id);const o=this.state.player.currentPOI;if(o&&((r=o.type)==null?void 0:r.category)==="settlement"?this.biomeAudio.setSettlement(o.type.id):this.biomeAudio.setSettlement(null),this.particles){const l=this.particles.getWeatherType();this.biomeAudio.setWeather(l)}}}processEnemyTurn(){if(this.encounters.isInCombat())return;if(this.inDungeon){this.render();return}this.encounters.spawnWorldEnemies(this.grid,this.maxPathLength);const e=this.encounters.moveWorldEnemies(this.grid);if(this.encounters.removeDistantEnemies(this.grid,this.maxPathLength+4),e&&e.length>0){if(e.length===1)this.state.addLog(`${e[0].name} attacks!`,"warning"),this.encounters.startCombatWithWorldEnemy(e[0]);else{const t=e.map(i=>i.name).join(", ");this.state.addLog(`${t} attack!`,"warning"),this.encounters.startCombatWithMultipleEnemies(e)}this.showCombatModal()}this.render()}initTimeMode(){this.isRealtimeMode=!1,this.realtimeInterval=null,this.idleTimeout=null,this.idleDelay=15e3,this.startRealtimeLoop(),this.updateTimeModeUI()}startRealtimeLoop(){this.realtimeInterval||(this.realtimeInterval=setInterval(()=>{if(!this.isRealtimeMode||this.encounters.isInCombat()||this.travelState||this.currentAction)return;this.gameLoop.advanceMinutes(2);const e=this.state.player;e.stamina<e.maxStamina&&(e.stamina=Math.min(e.maxStamina,e.stamina+5)),Math.random()<.08&&(this.encounters.spawnWorldEnemies(this.grid,this.maxPathLength),this.encounters.moveWorldEnemies(this.grid)),this.updateUI(),this.render()},3e3))}enterStopMode(){this.isRealtimeMode&&(this.isRealtimeMode=!1,this.updateTimeModeUI(),this.idleTimeout&&clearTimeout(this.idleTimeout),this.resetIdleTimer())}enterRealtimeMode(){this.isRealtimeMode||(this.isRealtimeMode=!0,this.updateTimeModeUI(),this.idleTimeout&&(clearTimeout(this.idleTimeout),this.idleTimeout=null))}toggleTimeMode(){this.isRealtimeMode?this.enterStopMode():this.enterRealtimeMode()}resetIdleTimer(){this.isRealtimeMode||(this.idleTimeout&&clearTimeout(this.idleTimeout),this.idleTimeout=setTimeout(()=>{!this.isRealtimeMode&&!this.encounters.isInCombat()&&this.enterRealtimeMode()},this.idleDelay))}updateTimeModeUI(){this.ui.waitBtn&&(this.isRealtimeMode?(this.ui.waitBtn.textContent="â¸ Stop",this.ui.waitBtn.classList.remove("stopped")):(this.ui.waitBtn.textContent="â–¶ Play",this.ui.waitBtn.classList.add("stopped")))}bindEvents(){window.addEventListener("resize",()=>{this.renderer.resize(),this.resizeParticleCanvas(),this.render()}),window.addEventListener("keydown",e=>{if(e.key==="Escape"&&(this.inDungeon?this.exitDungeon():this.cancelTravel()),e.key==="Tab"&&this.encounters.currentEncounter&&this.encounters.currentEncounter.enemies){e.preventDefault(),this.encounters.cycleTarget();const t=document.querySelectorAll(".combat-enemy"),i=this.encounters.currentEncounter.targetedEnemyIndex;t.forEach((s,a)=>{s.classList.toggle("targeted",a===i)})}e.key===" "&&(e.preventDefault(),this.toggleTimeMode())}),this.canvas.addEventListener("wheel",e=>{e.preventDefault()},{passive:!1}),this.canvas.addEventListener("mouseleave",()=>{this.hideTooltip(),this.clearPathPreview()})}handleMouseMove(e,t){const i=this.findPOIAtScreen(e,t);i!==this.hoveredPOI?(this.hoveredPOI=i,i?this.showTooltip(i,e,t):this.hideTooltip()):i&&this.positionTooltip(e,t)}findPOIAtScreen(e,t){const i=this.renderer.scale,s=15*i;for(const a of this.pois){const n=this.grid.hexToPixel(a.q,a.r),r=n.x*i+this.renderer.offsetX,o=n.y*i+this.renderer.offsetY,l=e-r,c=t-o;if(Math.sqrt(l*l+c*c)<=s)return a}return null}showTooltip(e,t,i){let s=`
            <div class="tooltip-header">
                <span class="tooltip-icon">${e.type.icon}</span>
                <div>
                    <div class="tooltip-title">${e.name}</div>
                    <div class="tooltip-type">${e.type.name}</div>
                </div>
            </div>
            <div class="tooltip-stats">
        `;e.type.category==="settlement"?(s+=`
                <span class="tooltip-label">Population:</span>
                <span class="tooltip-value">${e.data.population.toLocaleString()}</span>
                <span class="tooltip-label">Economy:</span>
                <span class="tooltip-value">${e.data.economy}</span>
                <span class="tooltip-label">Wealth:</span>
                <span class="tooltip-value">${e.data.wealth}</span>
                <span class="tooltip-label">Faction:</span>
                <span class="tooltip-value">${e.data.faction}</span>
            `,s+="</div>",e.data.features.length>0&&(s+=`<div class="tooltip-features">Notable: ${e.data.features.join(", ")}</div>`)):e.type.category==="resource"?(s+=`
                <span class="tooltip-label">Produces:</span>
                <span class="tooltip-value">${e.data.output}</span>
                <span class="tooltip-label">Yield:</span>
                <span class="tooltip-value">${e.data.yield}</span>
                <span class="tooltip-label">Access:</span>
                <span class="tooltip-value">${e.data.accessibility}</span>
            `,e.data.claimed&&(s+=`
                    <span class="tooltip-label">Claimed by:</span>
                    <span class="tooltip-value">${e.data.owner}</span>
                `),s+="</div>"):(s+=`
                <span class="tooltip-label">Condition:</span>
                <span class="tooltip-value">${e.data.condition}</span>
                <span class="tooltip-label">Danger:</span>
                <span class="tooltip-value">${e.data.danger}</span>
            `,e.data.resources&&(s+=`
                    <span class="tooltip-label">Resources:</span>
                    <span class="tooltip-value">${e.data.resources}</span>
                `),s+="</div>",s+=`<div class="tooltip-lore">"${e.data.lore}"</div>`),this.tooltip.innerHTML=s,this.tooltip.classList.remove("hidden"),this.positionTooltip(t,i)}positionTooltip(e,t){const s=this.tooltip.getBoundingClientRect();let a=e+15,n=t+15;a+s.width>window.innerWidth&&(a=e-s.width-15),n+s.height>window.innerHeight&&(n=t-s.height-15),this.tooltip.style.left=a+"px",this.tooltip.style.top=n+"px"}hideTooltip(){this.tooltip.classList.add("hidden"),this.hoveredPOI=null}updatePathPreview(e){const t=this.state.player.position;if(e.q===t.q&&e.r===t.r){this.clearPathPreview();return}if(this.grid.distance(t.q,t.r,e.q,e.r)>this.maxPathLength){this.clearPathPreview();return}if(e.biome.id==="ocean"){this.clearPathPreview();return}const s=this.getHexPath(t,e);if(!s||s.length===0){this.clearPathPreview();return}this.pathPreview=s,this.render()}clearPathPreview(){this.pathPreview&&(this.pathPreview=null,this.render())}getHexPath(e,t){const i=[],s=this.grid.distance(e.q,e.r,t.q,t.r);if(s===0)return i;for(let a=0;a<=s;a++){const n=s===0?0:a/s,r=e.q+(t.q-e.q)*n,o=e.r+(t.r-e.r)*n,l=this.grid.axialRound(r,o),c=this.grid.getCell(l.q,l.r);if(!c||!c.biome||c.biome.id==="ocean")return null;(i.length===0||i[i.length-1].q!==l.q||i[i.length-1].r!==l.r)&&i.push({q:l.q,r:l.r,hex:c})}return i}walkAlongPath(){var i,s;if(!this.pathPreview||this.pathPreview.length<2||(i=this.travelState)!=null&&i.isMoving)return;const e=this.state.player;let t=0;for(let a=1;a<this.pathPreview.length;a++){const r=this.pathPreview[a].hex;let o=1;r.biome.id==="mountain"||r.biome.id==="swamp"?o=3:(r.biome.id==="forest"||r.biome.id==="rainforest")&&(o=2),((s=this.roads)==null?void 0:s.some(c=>{var d;return(d=c.path)==null?void 0:d.some(u=>u.q===r.q&&u.r===r.r)}))&&(o=Math.ceil(o*.5)),e.class==="ranger"&&(o=Math.ceil(o*.5)),t+=o}if(e.stamina<t){this.state.addLog("Not enough stamina for this journey. Rest first!","warning"),this.clearPathPreview();return}this.travelState={isMoving:!0,path:[...this.pathPreview],currentStep:1,cancelled:!1},this.clearPathPreview(),this.animateTravelStep()}animateTravelStep(){var p,v;if(!this.travelState||!this.travelState.isMoving)return;const{path:e,currentStep:t,cancelled:i}=this.travelState;if(i||t>=e.length){this.finishTravel();return}const s=this.state.player,a=e[t],n=a.hex;let r=1;n.biome.id==="mountain"||n.biome.id==="swamp"?r=3:(n.biome.id==="forest"||n.biome.id==="rainforest")&&(r=2),((p=this.roads)==null?void 0:p.some(b=>{var k;return(k=b.path)==null?void 0:k.some(w=>w.q===n.q&&w.r===n.r)}))&&(r=Math.ceil(r*.5)),s.class==="ranger"&&(r=Math.ceil(r*.5)),s.stamina-=r;const l={...s.position},c=this.grid.hexToPixel(l.q,l.r),d=this.grid.hexToPixel(a.q,a.r);if(this.playerFacingAngle=Math.atan2(d.y-c.y,d.x-c.x),s.position={q:a.q,r:a.r},this.updateParticleBiome(),this.townActions&&this.townActions.updateTaskProgress("travel",null,1),this.playStepSound(),this.auraSystem&&!this.inDungeon&&(this.auraSystem.applyAuraEffects(a.q,a.r),this.state.onPlayerMove(),this.quests&&this.quests.updateCorruptionMapping(a.q,a.r,this.auraSystem)),this.overworldCorruption&&!this.inDungeon){const b=this.overworldCorruption.applyZoneEffects(a.q,a.r);b.damage>0&&this.state.showToast(`-${b.damage} HP (corruption)`,"warning",1500,"â˜ ï¸")}const u=n.biome.id==="mountain"?500:350;this.startPlayerTransition(l,s.position,u);const h=this.pois.find(b=>b.q===a.q&&b.r===a.r);s.currentPOI=h||null;const m=n.biome.id==="mountain"?15:3;this.gameLoop.advanceMinutes(m),this.updateTorch(),this.encounters.moveWorldEnemies(this.grid);const g=this.state.worldEnemies.filter(b=>this.grid.distance(b.q,b.r,a.q,a.r)<=1);if(g.length>0){if(g.length===1)this.state.addLog(`${g[0].name} blocks your path!`,"warning"),this.encounters.startCombatWithWorldEnemy(g[0]);else{const b=g.map(k=>k.name).join(", ");this.state.addLog(`${b} block your path!`,"warning"),this.encounters.startCombatWithMultipleEnemies(g)}this.travelState.cancelled=!0,this.showCombatModal(),this.finishTravel();return}if(this.townActions){const b=this.townActions.checkBanditAmbush();if(b){this.state.addLog(b.message,"danger"),this.encounters.startBanditAmbush(b),this.travelState.cancelled=!0,this.showCombatModal(),this.finishTravel();return}}const y=(v=this.getStolenDelivery)==null?void 0:v.call(this);if(y&&y.hideout&&a.q===y.hideout.q&&a.r===y.hideout.r){this.state.addLog("You found the bandit hideout!","warning"),this.startHideoutRaid(y),this.travelState.cancelled=!0,this.showCombatModal(),this.finishTravel();return}this.pathPreview=e.slice(t),this.updateUI(),this.updateInventoryUI(),this.travelState.currentStep++;const f=n.biome.id==="mountain"?300:180;setTimeout(()=>this.animateTravelStep(),f)}finishTravel(){var i,s,a,n,r,o,l,c;if(!this.travelState)return;this.state.player;const e=this.travelState.path,t=this.travelState.currentStep;if(!this.travelState.cancelled&&t>=e.length){const d=e[e.length-1];let u=this.pois.find(h=>h.q===d.q&&h.r===d.r);u||(u=this.pois.find(h=>this.grid.distance(h.q,h.r,d.q,d.r)===1)),u?(this.state.player.currentPOI=u,u.id&&this.state.discoverPOI(u.id,u),this.state.addLog(`Arrived at ${u.name}`,"info"),((i=u.type)==null?void 0:i.category)==="settlement"?this.triggerLexicon("enter_settlement"):((s=u.type)==null?void 0:s.category)==="guild"?this.triggerLexicon("enter_guild"):((a=u.type)==null?void 0:a.category)==="cult"?this.triggerLexicon("enter_cult_site"):(((n=u.type)==null?void 0:n.category)==="dungeon"||(o=(r=u.type)==null?void 0:r.id)!=null&&o.includes("ruin")||(c=(l=u.type)==null?void 0:l.id)!=null&&c.includes("cave"))&&this.triggerLexicon("enter_dungeon"),this.townActions&&this.townActions.getActiveDelivery()&&this.townActions.completeDelivery(this.inventory)&&this.updateCompass(),this.quests&&this.quests.checkProgress()):(this.state.player.currentPOI=null,this.state.addLog(`Arrived at ${d.hex.biome.name}`,"info"))}this.travelState=null,this.clearPathPreview(),this.encounters.spawnWorldEnemies(this.grid,this.maxPathLength),this.state.notify(),this.updateUI(),this.updateInventoryUI(),this.updateLocationActions(),this.render()}playStepSound(){if(!this.stepSounds||this.stepSounds.length===0)return;const e=this.stepSounds[Math.floor(Math.random()*this.stepSounds.length)],t=e.cloneNode();t.volume=e.volume,t.playbackRate=.9+Math.random()*.2,t.play().catch(()=>{})}cancelTravel(){this.travelState&&this.travelState.isMoving&&(this.travelState.cancelled=!0,this.stopCameraLerp(),this.state.addLog("Journey cancelled.","info"))}startPlayerTransition(e,t,i){const s=this.grid.hexToPixel(e.q,e.r),a=this.grid.hexToPixel(t.q,t.r);this.cameraState||(this.cameraState={offsetX:this.renderer.offsetX,offsetY:this.renderer.offsetY}),this.cameraLerpFrame&&(cancelAnimationFrame(this.cameraLerpFrame),this.cameraLerpFrame=null),this.playerTransition={fromPixel:s,toPixel:a,fromHex:{q:e.q,r:e.r},toHex:{q:t.q,r:t.r},startTime:performance.now(),duration:i,active:!0,t:0},this.animatePlayerTransition()}animatePlayerTransition(){var d;if(!((d=this.playerTransition)!=null&&d.active))return;const{fromPixel:e,toPixel:t,startTime:i,duration:s}=this.playerTransition,a=performance.now()-i,n=Math.min(1,a/s),r=1-Math.pow(1-n,3);this.playerTransition.t=r,this.playerVisualPos={x:e.x+(t.x-e.x)*r,y:e.y+(t.y-e.y)*r};const o=this.renderer.width/2-this.playerVisualPos.x*this.renderer.scale,l=this.renderer.height/2-this.playerVisualPos.y*this.renderer.scale;this.cameraState||(this.cameraState={offsetX:this.renderer.offsetX,offsetY:this.renderer.offsetY});const c=.12;this.cameraState.offsetX+=(o-this.cameraState.offsetX)*c,this.cameraState.offsetY+=(l-this.cameraState.offsetY)*c,this.renderer.offsetX=this.cameraState.offsetX,this.renderer.offsetY=this.cameraState.offsetY,this.render(),n<1?this.transitionFrame=requestAnimationFrame(()=>this.animatePlayerTransition()):(this.playerTransition.active=!1,this.playerVisualPos=null,this.finishCameraLerp(o,l))}finishCameraLerp(e,t){const i=e-this.cameraState.offsetX,s=t-this.cameraState.offsetY;if(Math.sqrt(i*i+s*s)<.5){this.renderer.offsetX=e,this.renderer.offsetY=t,this.cameraState.offsetX=e,this.cameraState.offsetY=t,this.render();return}const n=.15;this.cameraState.offsetX+=i*n,this.cameraState.offsetY+=s*n,this.renderer.offsetX=this.cameraState.offsetX,this.renderer.offsetY=this.cameraState.offsetY,this.render(),this.cameraLerpFrame=requestAnimationFrame(()=>this.finishCameraLerp(e,t))}stopPlayerTransition(){this.playerTransition&&(this.playerTransition.active=!1),this.transitionFrame&&(cancelAnimationFrame(this.transitionFrame),this.transitionFrame=null),this.cameraLerpFrame&&(cancelAnimationFrame(this.cameraLerpFrame),this.cameraLerpFrame=null),this.playerVisualPos=null}smoothCameraFollow(e){var t;!e||!this.grid||(t=this.playerTransition)!=null&&t.active||this.centerCamera(e.q,e.r)}centerCamera(e,t){this.grid&&(this.renderer.centerOnHex(this.grid,e,t),this.cameraState?(this.cameraState.offsetX=this.renderer.offsetX,this.cameraState.offsetY=this.renderer.offsetY):this.cameraState={offsetX:this.renderer.offsetX,offsetY:this.renderer.offsetY})}stopCameraLerp(){this.stopPlayerTransition(),this.cameraState&&(this.cameraState.offsetX=this.renderer.offsetX,this.cameraState.offsetY=this.renderer.offsetY)}makeCamp(){var r;if(!this.inventory.has("tent")){this.state.addLog("You need a tent to make camp!","warning");return}if((r=this.travelState)!=null&&r.isMoving){this.state.addLog("Stop moving first!","warning");return}if(this.encounters.isInCombat()){this.state.addLog("Can't camp during combat!","warning");return}const e=this.state.player,i=D.tent.restBonus||1.5,s=Math.floor(e.maxHealth*.5*i),a=Math.floor(e.maxStamina*.8*i),n=Math.floor(e.maxEther*.3*i);if(e.health=Math.min(e.maxHealth,e.health+s),e.stamina=Math.min(e.maxStamina,e.stamina+a),e.ether=Math.min(e.maxEther,e.ether+n),this.gameLoop.advanceHours(8),this.state.equippedTorch)for(let o=0;o<32;o++)this.updateTorch();this.state.addLog("Set up camp and rested safely.","success"),this.state.addLog(`Recovered: +${s} HP, +${a} Stamina, +${n} Ether`,"success");for(let o=0;o<8;o++)this.encounters.moveWorldEnemies(this.grid);this.encounters.spawnWorldEnemies(this.grid,this.maxPathLength),this.state.notify(),this.updateUI(),this.updateInventoryUI(),this.render()}canWalkTo(e){return!(e.biome.id==="ocean"||(e.heightLevel||0)>=2||this.state.player.stamina<5)}walkToHex(e){const t=this.state.player;let i=.5;if(e.biome.id==="mountain"||e.biome.id==="swamp"?i=2:(e.biome.id==="forest"||e.biome.id==="rainforest")&&(i=.6),(e.heightLevel||0)===1&&(i+=1),t.class==="ranger"&&(i=Math.ceil(i*.5)),t.stamina<i){this.state.addLog("Too tired to walk. Rest first!","warning");return}t.stamina-=i,t.position={q:e.q,r:e.r},this.guilds&&this.guilds.updateContractProgress("explore",{});const a=this.pois.find(r=>r.q===e.q&&r.r===e.r);t.currentPOI=a||null,a?(a.id&&this.state.discoverPOI(a.id,a),this.state.addLog(`Arrived at ${a.name}`,"info")):this.state.addLog(`Walked to ${e.biome.name}`,"info");const n=e.biome.id==="mountain"?30:15;this.gameLoop.advanceMinutes(n),this.state.notify(),this.render()}showCombatModal(){const e=this.encounters.currentEncounter;if(!e)return;this.triggerLexicon("enter_combat"),$.playCombatStart(),this.music.transitionToCombat();const t=this.state.player,i=this.encounters.getAvailableActions(),a=e.enemies&&e.enemies.length>0?e.enemies:[e.enemy];this.turnTracker||(this.turnTracker=new Ms),this.actionResolver||(this.actionResolver=new As(this.state)),this.combatAI||(this.combatAI=new $s);const n={id:"player",name:t.name,icon:"ðŸ§™",isPlayer:!0,hp:t.health,currentHp:t.health,maxHp:t.maxHealth,health:t.health,maxHealth:t.maxHealth,stamina:t.stamina,ether:t.ether,speed:t.attributes.agility,defense:t.attributes.defense||0,damage:this.encounters.getPlayerWeaponDamage(),attributes:t.attributes,position:{x:80,y:100}};a.forEach((p,v)=>{const b=v%2,k=Math.floor(v/2);p.position={x:60+b*100,y:50+k*80},p.speed=p.speed||p.agility||5,p.isPlayer=!1,p.icon||(p.icon="ðŸ’€")});const r=[n,...a];this.turnTracker.buildTurnOrder(r),this._playerCombatant=n,this._combatEnemies=a,this._selectedAction=null,this._combatLog=[];const o=i.filter(p=>p.type==="attack"||p.type==="skill"),l=i.filter(p=>p.type==="spell"),c=i.filter(p=>p.type==="defend"||p.type==="flee"),d=p=>{const v=p.available?"":"disabled",b=p.cost?` (${p.cost})`:"";return`
                <button class="combat-action-btn ${p.type}"
                        data-action="${p.type}"
                        data-action-id="${p.skillId||p.spellId||p.type}"
                        data-skill="${p.skillId||""}"
                        data-spell="${p.spellId||""}"
                        title="${p.description}"
                        ${v}>
                    <span class="action-icon">${p.icon}</span>
                    <span class="action-name">${p.name}</span>
                    ${b?`<span class="action-cost">${b}</span>`:""}
                </button>
            `},u=(p,v)=>`
                <div class="combatant-card enemy ${p.dead||p.currentHp<=0?"dead":""}"
                     data-enemy-index="${v}"
                     data-combatant-id="${p.id}"
                     style="left: ${p.position.x-50}px; top: ${p.position.y-40}px;">
                    <div class="combatant-icon">${p.icon}</div>
                    <div class="combatant-name">${p.name}</div>
                    <div class="combatant-hp-bar">
                        <div class="fill" data-enemy-hp="${v}"
                             style="width: ${p.currentHp/p.maxHp*100}%"></div>
                    </div>
                    <div class="combatant-hp-text" data-enemy-hp-text="${v}">${p.currentHp}/${p.maxHp}</div>
                </div>
            `,h=`
            <div class="combat-container turn-based">
                <!-- Combat Arena -->
                <div class="combat-arena" id="combat-arena">
                    <canvas id="spline-canvas"></canvas>

                    <!-- Player Side -->
                    <div class="arena-side player-side">
                        <div class="combatant-card player" id="player-card" data-combatant-id="player">
                            <div class="combatant-icon">ðŸ§™</div>
                            <div class="combatant-name">${t.name}</div>
                            <div class="combatant-hp-bar player-bar">
                                <div class="fill player-hp" style="width: ${t.health/t.maxHealth*100}%"></div>
                            </div>
                            <div class="combatant-hp-text" id="player-hp-text">${Math.floor(t.health)}/${t.maxHealth}</div>
                            <div class="combatant-resources">
                                <span class="resource stamina" id="player-stamina">âš¡${Math.floor(t.stamina)}</span>
                                <span class="resource ether" id="player-ether">âœ¨${Math.floor(t.ether)}</span>
                            </div>
                            <div class="player-conditions" id="player-conditions"></div>
                        </div>
                    </div>

                    <div class="arena-divider"></div>

                    <!-- Enemy Side -->
                    <div class="arena-side enemy-side" id="enemy-container">
                        ${a.map((p,v)=>u(p,v)).join("")}
                    </div>

                    <!-- Round Counter -->
                    <div class="round-counter">Round ${this.turnTracker.roundNumber}</div>
                </div>

                <!-- Turn Timer Bar (Action Window) -->
                <div class="turn-timer-container ${this.turnTracker.isPlayerTurn()?"":"hidden"}" id="turn-timer-container">
                    <div class="turn-timer-bar">
                        <div class="turn-timer-fill" id="turn-timer-fill" style="width: 100%"></div>
                        <div class="turn-timer-text" id="turn-timer-text">â±ï¸ Action Window</div>
                    </div>
                    <div class="turn-timer-actions">
                        <span class="actions-count" id="actions-count">Actions: 0</span>
                        <button class="end-turn-btn" id="end-turn-btn">End Turn â©</button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="combat-actions ${this.turnTracker.isPlayerTurn()?"":"disabled"}" id="combat-actions">
                    <div class="action-row primary">
                        ${o.map(d).join("")}
                        ${l.map(d).join("")}
                    </div>
                    <div class="action-row secondary">
                        ${c.map(d).join("")}
                    </div>
                </div>

                <!-- Combat Consumables -->
                <div class="combat-consumables" id="combat-consumables">
                    ${this.buildCombatConsumablesUI()}
                </div>

                <!-- Combat Log -->
                <div class="combat-log" id="combat-log">
                    <div class="combat-log-entry">Combat begins!</div>
                </div>
            </div>
        `;this.showModal("Combat",h);const m=document.getElementById("spline-canvas"),g=document.getElementById("combat-arena"),y=document.getElementById("enemy-container");if(m&&g){m.width=g.offsetWidth,m.height=g.offsetHeight;const p=y?y.offsetLeft:g.offsetWidth/2;a.forEach(v=>{v.arenaPosition={x:p+v.position.x,y:v.position.y}}),this.splineTargeter=new Is(m),this.splineTargeter.setParticipants({x:80,y:100},a)}if(this.bindCombatActionButtons(),this.bindCombatConsumableEvents(),this.ui.modalBody.querySelectorAll(".combatant-card.enemy").forEach(p=>{p.addEventListener("click",()=>{if(!this.turnTracker.isPlayerTurn())return;const v=parseInt(p.dataset.enemyIndex),b=this._combatEnemies[v];b&&!b.dead&&b.currentHp>0&&(this.splineTargeter&&this.splineTargeter.lockToTarget(b),this.ui.modalBody.querySelectorAll(".combatant-card.enemy").forEach((k,w)=>{k.classList.toggle("targeted",w===v)}),this._selectedAction&&this.executeTurnAction(this._selectedAction,b))})}),this.splineTargeter&&a.length>0){const p=a.find(v=>!v.dead&&v.currentHp>0);p&&(this.splineTargeter.lockToTarget(p),this.ui.modalBody.querySelectorAll(".combatant-card.enemy").forEach((v,b)=>{v.classList.toggle("targeted",this._combatEnemies[b]===p)}))}this.encounters.onCombatUpdate=(p,v)=>{!p&&v&&this.endTurnBasedCombat(v)},this.encounters.onTurnTimerUpdate=p=>{this.updateTurnTimerUI(p)},this.encounters.onTurnEnded=p=>{this.onPlayerTurnEnded(p)};const f=document.getElementById("end-turn-btn");f&&f.addEventListener("click",()=>{this.encounters.endTurnEarly()}),this.ui.modalClose.classList.add("hidden"),setTimeout(()=>{this.updateCurrentTurnHighlight()},100),this.turnTracker.isPlayerTurn()?setTimeout(()=>this.enablePlayerTurn(),300):setTimeout(()=>this.executeEnemyTurn(),800)}bindCombatActionButtons(){this.ui.modalBody.querySelectorAll(".combat-action-btn").forEach(e=>{e.addEventListener("click",()=>{if(e.disabled||!this.turnTracker.isPlayerTurn())return;const t=e.dataset.action;e.dataset.actionId;const i=e.dataset.skill||null,s=e.dataset.spell||null;let n=this.encounters.getAvailableActions().find(o=>!!(i&&o.skillId===i||s&&o.spellId===s||!i&&!s&&o.type===t));if(!n)return;if(t==="defend"||t==="flee"||n.targetType==="self"){this.executeTurnAction(n,this._playerCombatant);return}this._selectedAction=n,this.ui.modalBody.querySelectorAll(".combat-action-btn").forEach(o=>{o.classList.remove("selected")}),e.classList.add("selected"),this.splineTargeter&&this.splineTargeter.start();const r=document.getElementById("turn-indicator");r&&(r.textContent=`ðŸŽ¯ Select a target for ${n.name}`)})})}triggerCombatShake(e="light"){const t=document.querySelector(".combat-arena");if(!t)return;t.classList.remove("combat-shake-light","combat-shake-heavy"),t.offsetWidth;const i=e==="heavy"?"combat-shake-heavy":"combat-shake-light";t.classList.add(i),setTimeout(()=>{t.classList.remove(i)},e==="heavy"?400:300)}triggerCombatAnimation(e,t,i=400){const s=document.querySelector(`[data-combatant-id="${e}"]`);s&&(s.classList.remove("attacking","hit-recoil","crit-recoil","dodging","dying","defending"),s.offsetWidth,s.classList.add(t),setTimeout(()=>{s.classList.remove(t)},i))}showCombatNumber(e,t,i="damage"){const s=document.querySelector(`[data-combatant-id="${e}"]`);if(!s)return;const a=s.parentElement||s,n=s.getBoundingClientRect(),r=a.getBoundingClientRect(),o=document.createElement("div");o.className="combat-damage-number",i==="crit"?(o.classList.add("crit"),o.textContent=t):i==="heal"?(o.classList.add("heal"),o.textContent=t):i==="dodge"?(o.classList.add("dodge"),o.textContent="DODGE!"):o.textContent=t;const l=n.left-r.left,c=n.top-r.top;o.style.left=`${l+n.width/2}px`,o.style.top=`${c}px`,o.style.transform="translateX(-50%)",a.style.position="relative",a.appendChild(o),setTimeout(()=>{o.remove()},i==="crit"?1e3:800)}triggerImpactFlash(e,t=!1){const i=document.querySelector(`[data-combatant-id="${e}"]`);if(!i)return;const s=document.createElement("div");s.className="combat-impact-flash",t&&s.classList.add("crit"),i.style.position="relative",i.appendChild(s),setTimeout(()=>{s.remove()},t?300:200)}triggerDeathAnimation(e){const t=document.querySelector(`[data-combatant-id="${e}"]`);t&&t.classList.add("dying")}updateCurrentTurnHighlight(){var t;document.querySelectorAll(".combatant-card.current-turn").forEach(i=>{i.classList.remove("current-turn")});const e=(t=this.turnTracker)==null?void 0:t.getCurrentTurn();if(e){const i=e.combatant.isPlayer?"player":e.combatant.id,s=document.querySelector(`[data-combatant-id="${i}"]`);s&&s.classList.add("current-turn")}}applyDefendingState(e){const t=document.querySelector(`[data-combatant-id="${e}"]`);t&&t.classList.add("defending")}removeDefendingState(e){const t=document.querySelector(`[data-combatant-id="${e}"]`);t&&t.classList.remove("defending")}executeTurnAction(e,t,i=!1){var h,m;this.splineTargeter&&this.splineTargeter.stop(),this.ui.modalBody.querySelectorAll(".combat-action-btn").forEach(g=>{g.classList.remove("selected")});const s=this.turnTracker.isPlayerTurn()?this._playerCombatant:this.turnTracker.getCurrentTurn().combatant,a=s.isPlayer?"player":s.id,n=t!=null&&t.isPlayer?"player":t==null?void 0:t.id;s.isPlayer&&(e.staminaCost&&(this.state.player.stamina-=e.staminaCost,this._playerCombatant.stamina=this.state.player.stamina),e.etherCost&&(this.state.player.ether-=e.etherCost,this._playerCombatant.ether=this.state.player.ether)),s.defending&&e.type!=="defend"&&this.removeDefendingState(a),(e.type==="attack"||e.type==="skill"||e.type==="spell"&&e.damage)&&this.triggerCombatAnimation(a,"attacking",350);const r=this.actionResolver.resolveAction(e,s,t);if(setTimeout(()=>{n&&(r.dodged?(this.triggerCombatAnimation(n,"dodging",400),this.showCombatNumber(n,0,"dodge")):r.damage>0?(r.isCrit?(this.triggerCombatAnimation(n,"crit-recoil",500),this.triggerImpactFlash(n,!0),this.triggerCombatShake("heavy"),this.showCombatNumber(n,r.damage,"crit")):(this.triggerCombatAnimation(n,"hit-recoil",400),this.triggerImpactFlash(n,!1),this.triggerCombatShake("light"),this.showCombatNumber(n,r.damage,"damage")),r.killed&&setTimeout(()=>{this.triggerDeathAnimation(n)},300)):r.healing>0&&this.showCombatNumber(n,r.healing,"heal")),e.type==="defend"&&this.applyDefendingState(a)},150),this.addCombatLogEntry(r.message,s.isPlayer?"player-action":"enemy-action"),s.isPlayer)e.type==="attack"||e.type==="skill"?$.playSwordSlash():e.type==="spell"?e.healing?$.playHeal():$.playSpellCast():e.type==="defend"?$.playDefend():e.type==="flee"&&r.fled&&$.playFlee(),r.damage>0&&!r.dodged?(r.isCrit?$.playCriticalHit():$.playHit(),this.encounters.subtractTimeOnHit()):r.dodged&&$.playDodge();else if($.playEnemyAttack(),r.damage>0&&!r.dodged){$.playPlayerHurt();const g=this.encounters.tryApplyCondition(s);if(g){const{condition:y,action:f,stacks:p}=g;let v="";f==="applied"?v=`${y.icon} You are now ${y.name}!`:f==="stacked"?v=`${y.icon} ${y.name} x${p}!`:f==="refreshed"&&(v=`${y.icon} ${y.name} refreshed`),v&&this.addCombatLogEntry(v,"condition"),this.updateConditionsUI()}}else r.dodged&&$.playDodge();if(this.updateTurnBasedCombatUI(),this.updateCurrentTurnHighlight(),r.fled){this.encounters.currentEncounter.fled=!0,this.encounters.endCombat();return}let o=this._playerCombatant.currentHp??this._playerCombatant.hp??this._playerCombatant.health??0;(isNaN(o)||o<0)&&(o=0),o=Math.min(o,this._playerCombatant.maxHp||this.state.player.maxHealth),this._playerCombatant.hp=o,this._playerCombatant.currentHp=o,this._playerCombatant.health=o,this.state.player.health=o;const l=this._combatEnemies.every(g=>g.dead||g.currentHp<=0),c=o<=0;if(l){this.encounters.stopTurnTimer(),this.encounters.currentEncounter.victory=!0,setTimeout(()=>{this.encounters.endCombat()},2500);return}if(c){this.encounters.stopTurnTimer(),this.encounters.currentEncounter.victory=!1,setTimeout(()=>{this.encounters.endCombat()},2500);return}s.defending&&e.type!=="defend"&&(s.defending=!1);const d=s.isPlayer,u=(m=(h=this.encounters.currentEncounter)==null?void 0:h.combatState)==null?void 0:m.turnTimerActive;if(d&&u){this.encounters.recordActionThisTurn(),this._selectedAction=null,this.ui.modalBody.querySelectorAll(".combat-action-btn").forEach(y=>{y.classList.remove("selected")}),this.splineTargeter&&this.splineTargeter.stop(),this.updateTurnBasedCombatUI(),this.updateActionAvailability();const g=document.getElementById("turn-indicator");g&&(g.textContent="âš”ï¸ Keep attacking!"),(e.type==="defend"||e.type==="flee")&&this.encounters.endTurnEarly();return}if(i){this._selectedAction=null,this.updateTurnBasedCombatUI();return}this._selectedAction=null,this.turnTracker.nextTurn(),this.updateTurnOrderUI(),this.turnTracker.isPlayerTurn()?this.enablePlayerTurn():setTimeout(()=>this.executeEnemyTurn(),800)}executeEnemyTurn(){const e=this.turnTracker.getCurrentTurn();if(!e||e.combatant.isPlayer)return;const t=e.combatant;if(t.dead||t.currentHp<=0){this.turnTracker.nextTurn(),this.updateCurrentTurnHighlight(),this.turnTracker.isPlayerTurn()?this.enablePlayerTurn():setTimeout(()=>this.executeEnemyTurn(),800);return}this.updateCurrentTurnHighlight();const i=document.getElementById("combat-actions");i&&i.classList.add("disabled");const s=t.hitsPerTurn||[1,1],a=s[0],n=s[1],r=a+Math.floor(Math.random()*(n-a+1)),o=document.getElementById("turn-indicator");o&&(r>1?o.textContent=`â³ ${t.name}'s turn (${r} attacks)...`:o.textContent=`â³ ${t.name}'s turn...`);const l=this.getEnemyActions(t),{action:c,target:d}=this.combatAI.selectAction(t,this._playerCombatant,l);this.executeEnemyHits(t,c,d,r,0)}executeEnemyHits(e,t,i,s,a){if(this._playerCombatant.currentHp<=0||!this.encounters.currentEncounter)return;if(e.dead||e.currentHp<=0){this.turnTracker.nextTurn(),this.updateTurnOrderUI(),this.turnTracker.isPlayerTurn()?this.enablePlayerTurn():setTimeout(()=>this.executeEnemyTurn(),800);return}const n=a===s-1,r=a===0?500:600;if(s>1){const o=document.getElementById("turn-indicator");o&&(o.textContent=`â³ ${e.name} attacks! (${a+1}/${s})`)}setTimeout(()=>{this.executeTurnAction(t,i,!n),n||this.executeEnemyHits(e,t,i,s,a+1)},r)}buildCombatConsumablesUI(){if(!this.inventory)return'<div class="consumables-empty">No items</div>';const t=this.inventory.getAllItems().filter(i=>i.category!=="consumable"&&i.category!=="food"?!1:i.effect||i.cures);return t.length===0?'<div class="consumables-empty">No items</div>':t.map(i=>{var n,r,o;const s=[];(n=i.effect)!=null&&n.health&&s.push(`+${i.effect.health} HP`),(r=i.effect)!=null&&r.stamina&&s.push(`+${i.effect.stamina} SP`),(o=i.effect)!=null&&o.ether&&s.push(`+${i.effect.ether} EP`),i.cures&&s.push(`Cures: ${i.cures.join(", ")}`);const a=s.join(", ")||"Use";return`
                <button class="consumable-btn" data-item-id="${i.id}" title="${i.description||i.name}">
                    <span class="consumable-icon">${i.icon}</span>
                    <span class="consumable-name">${i.name}</span>
                    <span class="consumable-count">x${i.quantity}</span>
                    <span class="consumable-effect">${a}</span>
                </button>
            `}).join("")}bindCombatConsumableEvents(){const e=document.getElementById("combat-consumables");e&&e.querySelectorAll(".consumable-btn").forEach(t=>{t.addEventListener("click",()=>{if(t.disabled||!this.turnTracker.isPlayerTurn())return;const i=t.dataset.itemId;this.useCombatConsumable(i)})})}useCombatConsumable(e){const t=D[e];if(!t)return;if(!this.inventory.has(e)){this.addCombatLogEntry(`No ${t.name} available!`);return}this.inventory.remove(e,1);const i=[];if(t.effect){if(t.effect.health){const a=t.effect.health,n=this._playerCombatant.currentHp;this._playerCombatant.currentHp=Math.min(this._playerCombatant.maxHp,this._playerCombatant.currentHp+a),this.state.player.health=this._playerCombatant.currentHp;const r=this._playerCombatant.currentHp-n;r>0&&(i.push(`+${r} HP`),this.showCombatNumber("player",r,"heal"))}t.effect.stamina&&(this.state.player.stamina=Math.min(this.state.player.maxStamina,this.state.player.stamina+t.effect.stamina),this._playerCombatant.stamina=this.state.player.stamina,i.push(`+${t.effect.stamina} SP`)),t.effect.ether&&(this.state.player.ether=Math.min(this.state.player.maxEther,this.state.player.ether+t.effect.ether),this._playerCombatant.ether=this.state.player.ether,i.push(`+${t.effect.ether} EP`))}const s=i.length>0?` (${i.join(", ")})`:"";this.addCombatLogEntry(`Used ${t.icon} ${t.name}${s}`),this.updateTurnBasedCombatUI(),this.updateConsumablesUI()}updateConsumablesUI(){const e=document.getElementById("combat-consumables");e&&(e.innerHTML=this.buildCombatConsumablesUI(),this.bindCombatConsumableEvents())}updateConditionsUI(){const e=document.getElementById("player-conditions");if(!e)return;const t=this.encounters.getActiveConditions();if(t.length===0){e.innerHTML="";return}e.innerHTML=t.map(i=>{const s=i.stacks>1?` x${i.stacks}`:"";return`
                <div class="condition-badge" title="${i.description} (${i.turnsRemaining} turns)">
                    <span class="condition-icon">${i.icon}</span>
                    <span class="condition-turns">${i.turnsRemaining}${s}</span>
                </div>
            `}).join("")}getEnemyActions(e){const t=[{type:"attack",name:"Attack",damage:e.damage,available:!0}];return e.abilities&&e.abilities.forEach(i=>{t.push({...i,available:!0})}),t}enablePlayerTurn(){const e=this.encounters.processConditionEffects();for(const n of e)if(n.type==="damage"){this.addCombatLogEntry(`${n.condition.icon} ${n.condition.name} deals ${n.value} damage!`,"condition"),this.showCombatNumber("player",n.value,"condition");const r=Math.max(0,this.state.player.health);this._playerCombatant.currentHp=r,this._playerCombatant.hp=r,this._playerCombatant.health=r}else n.type==="staminaDrain"?this.addCombatLogEntry(`${n.condition.icon} ${n.condition.name} drains ${n.value} stamina`,"condition"):n.type==="etherDrain"&&this.addCombatLogEntry(`${n.condition.icon} ${n.condition.name} drains ${n.value} ether`,"condition");if(this.state.player.health<=0){this.encounters.currentEncounter.victory=!1,this.encounters.endCombat();return}this.updateConditionsUI(),this.updateCurrentTurnHighlight();const t=document.getElementById("combat-actions");t&&t.classList.remove("disabled");const i=document.getElementById("turn-timer-container");i&&i.classList.remove("hidden");const s=document.getElementById("turn-timer-fill");s&&(s.style.width="100%",s.classList.remove("warning","critical"));const a=document.getElementById("actions-count");a&&(a.textContent="Actions: 0"),this.encounters.startTurnTimer(),this.updateActionAvailability(),this.updateTurnBasedCombatUI()}updateTurnTimerUI(e){const t=document.getElementById("turn-timer-fill"),i=document.getElementById("turn-timer-text"),s=document.getElementById("actions-count");if(t){t.style.width=`${e.percent}%`;const a=e.remaining/e.duration;t.classList.toggle("warning",a<=ae.warningThreshold&&a>ae.criticalThreshold),t.classList.toggle("critical",a<=ae.criticalThreshold)}if(i){const a=Math.ceil(e.remaining/1e3);i.textContent=`â±ï¸ ${a}s`}s&&(s.textContent=`Actions: ${e.actionsThisTurn}`)}onPlayerTurnEnded(e){this.encounters.stopTurnTimer();const t=document.getElementById("turn-timer-container");t&&t.classList.add("hidden");const i=document.getElementById("combat-actions");i&&i.classList.add("disabled");const s=document.getElementById("turn-indicator");s&&(s.textContent=e.timedOut?"â° Time's up!":"âœ”ï¸ Turn ended"),e.actionsThisTurn>0&&this.addCombatLogEntry(`You performed ${e.actionsThisTurn} action${e.actionsThisTurn!==1?"s":""}!`,"info"),this._selectedAction=null,this.splineTargeter&&this.splineTargeter.stop(),this.ui.modalBody.querySelectorAll(".combat-action-btn").forEach(a=>{a.classList.remove("selected")}),this.turnTracker.nextTurn(),this.updateTurnOrderUI(),setTimeout(()=>{this.turnTracker.isPlayerTurn()?this.enablePlayerTurn():setTimeout(()=>this.executeEnemyTurn(),800)},500)}updateActionAvailability(){const e=this.encounters.getAvailableActions();this.ui.modalBody.querySelectorAll(".combat-action-btn").forEach(t=>{const i=t.dataset.actionId,s=e.find(a=>a.skillId===i||a.spellId===i||a.type===i);t.disabled=!s||s.available===!1})}updateTurnOrderUI(){const e=document.getElementById("turn-order");if(!e)return;const t=this.turnTracker.getUpcomingTurns(6),i=t.map((a,n)=>{const r=a.combatant.icon||(a.combatant.isPlayer?"ðŸ§™":"ðŸ’€");return`
                <div class="turn-order-item ${a.isCurrent?"current":""} ${a.combatant.isPlayer?"player":"enemy"}">
                    <span class="turn-icon">${r}</span>
                    <span class="turn-name">${a.combatant.isPlayer?"You":a.combatant.name}</span>
                </div>
                ${n<t.length-1?'<span class="turn-order-arrow">â†’</span>':""}
            `}).join("");e.innerHTML=`<span class="turn-label">Turn Order:</span>${i}`;const s=document.querySelector(".round-counter");s&&(s.textContent=`Round ${this.turnTracker.roundNumber}`)}updateTurnBasedCombatUI(){const e=document.querySelector(".player-hp"),t=document.getElementById("player-hp-text");if(e&&t){let a=this._playerCombatant.currentHp??this._playerCombatant.hp??this._playerCombatant.health??0;const n=this._playerCombatant.maxHp||this._playerCombatant.maxHealth||100;isNaN(a)&&(a=0),a=Math.max(0,Math.min(a,n));const r=a/n*100;e.style.width=`${r}%`,t.textContent=`${Math.floor(a)}/${n}`}const i=document.getElementById("player-stamina"),s=document.getElementById("player-ether");i&&(i.textContent=`âš¡${Math.floor(this.state.player.stamina)}`),s&&(s.textContent=`âœ¨${Math.floor(this.state.player.ether)}`),this._combatEnemies.forEach((a,n)=>{const r=document.querySelector(`[data-enemy-hp="${n}"]`),o=document.querySelector(`[data-enemy-hp-text="${n}"]`),l=document.querySelector(`[data-enemy-index="${n}"]`);if(r){const c=Math.max(0,a.currentHp/a.maxHp*100);r.style.width=`${c}%`}o&&(o.textContent=`${Math.max(0,Math.floor(a.currentHp))}/${a.maxHp}`),l&&(a.dead||a.currentHp<=0)&&l.classList.add("dead")})}addCombatLogEntry(e,t=""){this._combatLog.push({message:e,type:t});const i=document.getElementById("combat-log");if(i){const s=document.createElement("div");s.className=`combat-log-entry ${t}`,s.textContent=e,i.appendChild(s),i.scrollTop=i.scrollHeight}}endTurnBasedCombat(e){this.music.transitionFromCombat(),this.encounters.stopTurnTimer(),this.encounters.onTurnTimerUpdate=null,this.encounters.onTurnEnded=null,this.splineTargeter&&(this.splineTargeter.stop(),this.splineTargeter=null),this._selectedAction=null,this._playerCombatant=null,this._combatEnemies=null,this._combatLog=[],this.ui.modalClose.classList.remove("hidden"),e.fled?(this.hideModal(),this.state.addLog("Escaped from combat","info")):this.showCombatResult(e,e.victory),this.encounters.onCombatUpdate=null,this.render()}updateCombatUI(e,t=null){if(!e){this.ui.modalClose.classList.remove("hidden"),t&&(t.fled?(this.hideModal(),this.state.addLog("Escaped from combat","info")):this.showCombatResult(t,t.victory)),this.encounters.onCombatUpdate=null,this.render();return}const i=document.getElementById("player-charge-bar"),s=document.getElementById("player-charge-label");if(i&&s)if(i.style.width=`${e.playerChargePercent}%`,e.playerReady)s.textContent="Ready",i.classList.remove("charging"),i.classList.add("ready");else{const c=this.getActionDisplayName(e.playerAction);s.textContent=`${c}...`,i.classList.add("charging"),i.classList.remove("ready")}if(e.enemies)e.enemies.forEach((c,d)=>{const u=document.querySelector(`[data-enemy-hp="${d}"]`),h=document.querySelector(`[data-enemy-hp-text="${d}"]`),m=document.querySelector(`[data-enemy-charge="${d}"]`),g=document.querySelector(`[data-enemy-index="${d}"]`),y=Math.max(0,c.currentHp/c.maxHp*100);u&&(u.style.width=`${y}%`),h&&(h.textContent=`${Math.max(0,Math.floor(c.currentHp))}/${c.maxHp}`),m&&(m.style.width=`${c.chargePercent}%`),g&&(c.dead&&g.classList.add("dead"),g.classList.toggle("targeted",d===e.targetedEnemyIndex))});else if(e.enemy){const c=document.querySelector('[data-enemy-hp="0"]'),d=document.querySelector('[data-enemy-hp-text="0"]'),u=document.querySelector('[data-enemy-charge="0"]');if(e.enemy){const h=Math.max(0,e.enemy.currentHp/e.enemy.maxHp*100);c&&(c.style.width=`${h}%`),d&&(d.textContent=`${Math.max(0,Math.floor(e.enemy.currentHp))}/${e.enemy.maxHp}`),u&&(u.style.width=`${e.enemyChargePercent}%`)}}const a=document.querySelector(".player-hp"),n=document.getElementById("player-hp-text");if(a&&n){const c=e.playerHealth/e.playerMaxHealth*100;a.style.width=`${c}%`,n.textContent=`${Math.floor(e.playerHealth)}/${e.playerMaxHealth}`}const r=document.getElementById("player-stamina"),o=document.getElementById("player-ether");r&&(r.textContent=`âš¡${Math.floor(e.playerStamina)}`),o&&(o.textContent=`âœ¨${Math.floor(e.playerEther)}`);const l=document.getElementById("combat-actions");if(l){const c=this.encounters.getAvailableActions(),d=new Map;c.forEach(g=>{const y=g.skillId||g.spellId||g.type;d.set(y,g.available)});const u=l.querySelectorAll(".combat-btn"),h=e.pendingAction,m=e.pendingActionData||{};u.forEach(g=>{const y=g.dataset.action,f=g.dataset.skill,p=g.dataset.spell,v=f||p||y,b=d.get(v)!==!1;let k=!1;h&&(h==="skill"&&f===m.skillId||h==="spell"&&p===m.spellId||h===y&&!f&&!p)&&(k=!0),k?g.classList.add("action-pending"):g.classList.remove("action-pending"),g.disabled=!b})}}getActionDisplayName(e){return{attack:"Attacking",skill:"Skill",spell:"Casting",defend:"Defending",flee:"Fleeing"}[e]||"Charging"}handleCombatAction(e,t={}){this.encounters.queuePlayerAction(e,t)}handleCombatEvent(e,t){switch(e){case"playerAttack":case"playerSkill":$.playSwordSlash();break;case"playerSpell":$.playSpellCast();break;case"playerHeal":$.playHeal();break;case"playerBuff":$.playBuff();break;case"playerDefend":$.playDefend();break;case"playerFlee":t.success&&$.playFlee();break;case"playerDodge":$.playDodge();break;case"playerHurt":$.playPlayerHurt();const i=t.damage>this.state.player.maxHealth*.2;this.triggerPlayerShake(i);break;case"enemyAttack":$.playEnemyAttack();break;case"enemyDamaged":$.playHit(),this.triggerEnemyShake(t.enemyIndex);break;case"criticalHit":$.playCriticalHit();break;case"enemyKilled":break;case"victory":$.playVictory();break;case"defeat":$.playDefeat();break}}triggerEnemyShake(e){const t=document.querySelector(`[data-enemy-index="${e}"]`);t&&(t.classList.add("shake","damage-flash"),setTimeout(()=>{t.classList.remove("shake","damage-flash")},400))}triggerPlayerShake(e=!1){const t=document.querySelector(".combat-participant.player");t&&(t.classList.add("shake","damage-flash"),setTimeout(()=>{t.classList.remove("shake","damage-flash")},300));const i=e?"fullscreen-shake-crit":"fullscreen-shake";document.body.classList.remove("fullscreen-shake","fullscreen-shake-crit"),document.body.offsetWidth,document.body.classList.add(i),setTimeout(()=>{document.body.classList.remove(i)},e?500:400)}showCombatResult(e,t){var n,r,o,l,c;t?$.playVictory():$.playDefeat(),this.pendingLoot=((n=e.rewards)==null?void 0:n.loot)||[],this.lastDefeatedEnemy=e.enemyInfo||null,this.canDismember=t&&this.lastDefeatedEnemy&&!e.dismembered;const i=this.pendingLoot.length>0||this.canDismember?`
            <div class="loot-section">
                <div class="loot-header">
                    <span class="loot-title">Loot Dropped</span>
                    <div style="display: flex; gap: 8px;">
                        ${this.canDismember?'<button class="dismember-btn" id="dismember-btn" title="Harvest viscera and body parts">ðŸ”ª Dismember</button>':""}
                        ${this.pendingLoot.length>0?'<button class="loot-all-btn" id="loot-all-btn">Loot All</button>':""}
                    </div>
                </div>
                <div class="loot-grid" id="loot-grid">
                    ${this.pendingLoot.map((d,u)=>`
                        <div class="loot-item" data-index="${u}" title="${d.name} - ${d.value}g each">
                            <div class="loot-icon">${d.icon}</div>
                            <div class="loot-info">
                                <div class="loot-name">${d.name}</div>
                                <div class="loot-qty">x${d.quantity}</div>
                            </div>
                            <button class="loot-take-btn" data-index="${u}">Take</button>
                        </div>
                    `).join("")}
                </div>
            </div>
        `:"",s=e.permadeath;s&&(this.isPlayerDead=!0);const a=`
            <div class="combat-result ${t?"victory":"defeat"}">
                <div class="result-icon">${t?"ðŸ†":"ðŸ’€"}</div>
                <div class="result-title">${t?"Victory!":s?"You Have Fallen":"Defeated..."}</div>
                ${(r=e.rewards)!=null&&r.leveledUp?`
                    <div class="level-up-banner">
                        <div class="level-up-icon">â¬†ï¸</div>
                        <div class="level-up-text">LEVEL UP!</div>
                        <div class="level-up-new">Level ${this.state.player.level}</div>
                    </div>
                `:""}
                ${t&&e.rewards?`
                    <div class="result-rewards">
                        <div class="reward-item">+${e.rewards.gold} Gold</div>
                        <div class="reward-item">+${e.rewards.xp} Experience</div>
                    </div>
                `:""}
                ${s?`
                    <div class="result-penalty permadeath">
                        <div class="permadeath-message">Your journey ends here.</div>
                        <div class="permadeath-stats">
                            <div>Days Survived: ${this.state.day}</div>
                            <div>Level Reached: ${this.state.player.level}</div>
                        </div>
                    </div>
                `:""}
                ${i}
                <div class="combat-log final-log">
                    ${e.log.slice(-5).map(d=>`<div class="combat-msg">${d}</div>`).join("")}
                </div>
                <button class="modal-btn close-combat" id="close-combat-btn">${s?"Return to Title":"Continue"}</button>
            </div>
        `;this.showModal(t?"Victory!":s?"Game Over":"Defeat",a,{uncloseable:s}),this.pendingLoot.length>0&&((o=document.getElementById("loot-all-btn"))==null||o.addEventListener("click",()=>{this.lootAll()}),document.querySelectorAll(".loot-take-btn").forEach(d=>{d.addEventListener("click",u=>{u.stopPropagation();const h=parseInt(d.dataset.index);this.takeLootItem(h)})})),(l=document.getElementById("dismember-btn"))==null||l.addEventListener("click",()=>{this.dismemberEnemy()}),(c=document.getElementById("close-combat-btn"))==null||c.addEventListener("click",()=>{this.pendingLoot=[],s?(this.forceHideModal(),this.state.deleteSave(),this.gameStarted=!1,location.reload()):this.hideModal()})}handleCorruptionDeath(){var t;this.isPlayerDead=!0,this.pathPreview=[],this.currentPath=[];const e=`
            <div class="combat-result defeat corruption-death">
                <div class="result-header">
                    <div class="result-icon">â˜ ï¸</div>
                    <div class="result-title">Consumed by Corruption</div>
                </div>
                <div class="result-penalty permadeath">
                    <div class="permadeath-message">The corruption has claimed your soul.</div>
                    <div class="permadeath-stats">
                        <div>Days Survived: ${this.state.day}</div>
                        <div>Level Reached: ${this.state.player.level}</div>
                    </div>
                </div>
                <button class="modal-btn primary" id="close-death-btn">Accept Fate</button>
            </div>
        `;this.showModal("Death",e,{}),(t=document.getElementById("close-death-btn"))==null||t.addEventListener("click",()=>{this.forceHideModal(),this.state.deleteSave(),this.gameStarted=!1,location.reload()})}takeLootItem(e){if(!this.pendingLoot||e>=this.pendingLoot.length)return;const t=this.pendingLoot[e];if(!t)return;const i=t.quantity||1;if(this.inventory.add(t.id,i)){const a=i>1?` x${i}`:"";this.state.addLog(`Looted: ${t.name}${a}`,"success"),this.pendingLoot.splice(e,1);const n=document.getElementById("loot-grid"),r=n==null?void 0:n.querySelector(`[data-index="${e}"]`);if(r&&(r.classList.add("looted"),setTimeout(()=>r.remove(),200)),this.reindexLootItems(),this.pendingLoot.length===0){const o=document.querySelector(".loot-section");o&&o.remove()}}}lootAll(){if(!this.pendingLoot)return;const e=[...this.pendingLoot];let t=0,i=0;for(const a of e){const n=a.quantity||1;this.inventory.add(a.id,n)&&(t++,i+=n)}this.pendingLoot=[];const s=document.querySelector(".loot-section");s&&(s.classList.add("looted-all"),setTimeout(()=>s.remove(),300)),t>0&&this.state.addLog(`Looted ${i} item${i>1?"s":""} (${t} stack${t>1?"s":""})`,"success")}reindexLootItems(){document.querySelectorAll(".loot-item:not(.looted)").forEach((t,i)=>{t.dataset.index=i;const s=t.querySelector(".loot-take-btn");s&&(s.dataset.index=i)})}dismemberEnemy(){if(!this.lastDefeatedEnemy||!this.canDismember){this.state.addLog("Nothing to dismember.","warning");return}const e=this.lastDefeatedEnemy,t=fs(e.id||e.templateId,e.category);if(t.length===0)this.state.addLog("Nothing useful could be harvested.","info");else{this.pendingLoot.push(...t);const s=document.getElementById("loot-grid");if(s){const n=this.pendingLoot.length-t.length;t.forEach((r,o)=>{const l=n+o,c=`
                        <div class="loot-item dismembered" data-index="${l}" title="${r.name} - ${r.value}g each">
                            <div class="loot-icon">${r.icon}</div>
                            <div class="loot-info">
                                <div class="loot-name">${r.name}</div>
                                <div class="loot-qty">x${r.quantity}</div>
                            </div>
                            <button class="loot-take-btn" data-index="${l}">Take</button>
                        </div>
                    `;s.insertAdjacentHTML("beforeend",c)}),s.querySelectorAll(".loot-item.dismembered .loot-take-btn").forEach(r=>{r.addEventListener("click",o=>{o.stopPropagation();const l=parseInt(r.dataset.index);this.takeLootItem(l)})})}const a=t.map(n=>n.name).join(", ");this.state.addLog(`Harvested: ${a}`,"success")}this.canDismember=!1;const i=document.getElementById("dismember-btn");i&&(i.disabled=!0,i.textContent="âœ“ Dismembered",i.style.opacity="0.5")}showDungeonIntelPanel(e){var p,v;const t=e.data||{},i=e.type.id,s={cave:"ðŸ•³ï¸",mine:"â›ï¸",shrine:"â›©ï¸",ruins:"ðŸ›ï¸",temple:"ðŸ›•",fortress:"ðŸ°",keep:"ðŸ—¼",castle:"ðŸ¯",forest_grove:"ðŸŒ³"},a=t.maxFloors||8,n=t.exploredDepth||0,r=t.danger||"Unknown",o=t.difficultyTier||1,l=t.bossFloor||a,c=t.bossDefeated||!1,d=t.relicClaimed||!1;t.clearedFloors;const u=["","Tier 1 (Easy)","Tier 2 (Medium)","Tier 3 (Hard)","Tier 4 (Deadly)"],h=["","#4a9","#d4af37","#f80","#f44"],m={Safe:"#4a9","Caution Advised":"#d4af37",Dangerous:"#f80",Deadly:"#f44"};let g=`
            <div class="dungeon-intel-panel" style="max-width: 400px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 48px;">${s[i]||"ðŸšï¸"}</div>
                    <div style="font-size: 18px; font-weight: bold;">${e.name}</div>
                    <div style="font-size: 12px; opacity: 0.7; text-transform: capitalize;">${i.replace("_"," ")}</div>
                </div>

                <div class="intel-stats" style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-size: 11px; opacity: 0.6;">FLOORS</div>
                            <div style="font-size: 16px; font-weight: bold;">${a}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; opacity: 0.6;">SCOUTED</div>
                            <div style="font-size: 16px; font-weight: bold;">${n} / ${a}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; opacity: 0.6;">DANGER</div>
                            <div style="font-size: 14px; color: ${m[r]||"#888"};">${r}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; opacity: 0.6;">DIFFICULTY</div>
                            <div style="font-size: 14px; color: ${h[o]};">${u[o]}</div>
                        </div>
                    </div>
                </div>

                <div class="intel-details" style="margin-bottom: 15px;">`;const y=Math.round(n/a*100);g+=`
            <div style="margin-bottom: 12px;">
                <div style="font-size: 12px; margin-bottom: 4px;">Exploration Progress</div>
                <div style="background: #333; border-radius: 4px; height: 8px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #4a9, #2e8b57); width: ${y}%; height: 100%;"></div>
                </div>
                <div style="font-size: 11px; opacity: 0.6; margin-top: 2px;">${y}% explored</div>
            </div>`,(n>=l-2||c)&&(g+=`
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: ${c?"rgba(70,150,100,0.2)":"rgba(255,100,100,0.2)"}; border-radius: 6px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">${c?"âœ…":"ðŸ‘¹"}</span>
                    <div>
                        <div style="font-size: 12px; font-weight: bold;">Boss: Floor ${l}</div>
                        <div style="font-size: 11px; opacity: 0.8;">${c?"Defeated!":"Lurking in the depths..."}</div>
                    </div>
                </div>`),(n>=Math.floor(a*.7)||d)&&(g+=`
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: ${d?"rgba(100,100,100,0.2)":"rgba(212,175,55,0.2)"}; border-radius: 6px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">${d?"ðŸ“¦":"âœ¨"}</span>
                    <div>
                        <div style="font-size: 12px; font-weight: bold;">Ancient Relic</div>
                        <div style="font-size: 11px; opacity: 0.8;">${d?"Already claimed":"Hidden on deep floors"}</div>
                    </div>
                </div>`),t.lore&&(g+=`
                <div style="font-style: italic; font-size: 12px; opacity: 0.7; padding: 10px; border-left: 2px solid #555;">
                    "${t.lore}"
                </div>`),g+=`
                </div>

                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="enter-dungeon-btn" style="padding: 12px 24px; background: linear-gradient(135deg, #4a9, #2e8b57); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        âš”ï¸ Enter Dungeon
                    </button>
                    <button id="cancel-dungeon-btn" style="padding: 12px 24px; background: #555; border: none; color: white; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            </div>`,this.showModal("Dungeon Intel",g);const f=this.ui.gameModal;(p=f.querySelector("#enter-dungeon-btn"))==null||p.addEventListener("click",()=>{this.hideModal(),this.enterDungeon(e)}),(v=f.querySelector("#cancel-dungeon-btn"))==null||v.addEventListener("click",()=>{this.hideModal()})}enterDungeon(e){var u,h,m,g,y;if(this.isPlayerDead)return;if(this.clearPathPreview(),this.dungeonTravelState=null,!["cave","mine","shrine","ruins","temple","fortress","keep","castle","forest_grove"].includes(e.type.id)){this.state.addLog("Nothing to explore here.","info");return}this.worldGrid=this.grid,this.worldPois=this.pois,this.worldRoads=this.roads,this.worldRivers=this.rivers,this.worldPlayerPosition={...this.state.player.position};const i=this.state.worldSeed+e.q*1e3+e.r;this.dungeonGenerator=new Gt(i);let s=1;((u=e.data)==null?void 0:u.danger)==="Deadly"?s=3:((h=e.data)==null?void 0:h.danger)==="Dangerous"?s=2:((m=e.data)==null?void 0:m.danger)==="Caution Advised"&&(s=1.5);let a=!1;if(this.overworldCorruption){const f=this.overworldCorruption.getZoneAt(e.q,e.r);(f==="CORRUPTED"||f==="BLIGHTED")&&(a=!0,f==="BLIGHTED"?s=Math.max(s,2.5):f==="CORRUPTED"&&(s=Math.max(s,2)))}this.currentDungeon=this.dungeonGenerator.generate(e,s,a),this.inDungeon=!0,this.music&&(this.music.transitionToDungeon(),this.music.ensureCorrectMusic()),this.updateParticleBiome(),this.placeActiveQuestItems(e),this.grid=this.currentDungeon.grid,this.hexActions&&this.hexActions.setGrid(this.grid),this.pois=[],this.roads=[],this.rivers=[];const n=this.currentDungeon.entrance;this.currentDungeon.playerPosition={q:n.q,r:n.r};const r=this.currentDungeon.currentFloor;if(r){for(let f=-3;f<=3;f++)for(let p=-3;p<=3;p++)if(Math.abs(f)+Math.abs(p)+Math.abs(-f-p)<=4){const b=n.q+f,k=n.r+p,w=this.grid.getCell(b,k);w&&!((g=w.biome)!=null&&g.impassable)&&r.explored.add(`${b},${k}`)}}this.renderer._centered=!1,this.renderer.centerOnHex(this.grid,n.q,n.r),this.encounters.onDungeonCombatEnd=f=>this.onDungeonCombatEnd(f);const o=this.currentDungeon.totalFloors,l=this.currentDungeon.isDeepDungeon,c=this.currentDungeon.currentFloor,d=((y=c==null?void 0:c.floorType)==null?void 0:y.name)||"Standard";this.state.addLog(`Entering ${this.currentDungeon.type.name}... (${o} floors${l?" - Deep Dungeon!":""})`,"discovery"),d!=="Standard"?this.state.addLog(`Floor 1: ${d}`,"info"):this.state.addLog(`Floor 1 of ${o}. Find the exit to descend deeper.`,"info"),this.render()}placeActiveQuestItems(e){if(!this.currentDungeon||!this.quests)return;const t=this.currentDungeon,i=t.grid,s=this.quests.activeQuests.filter(n=>{var r;return((r=n.objective)==null?void 0:r.type)==="dungeon_retrieve"&&n.objective.targetQ===e.q&&n.objective.targetR===e.r&&!n.completed});if(s.length===0)return;const a=[];i.forEach(n=>{var r;if(!((r=n.biome)!=null&&r.impassable)){const o=`${n.q},${n.r}`;!t.enemies.has(o)&&!t.chests.has(o)&&o!==`${t.entrance.q},${t.entrance.r}`&&Math.abs(n.q-t.entrance.q)+Math.abs(n.r-t.entrance.r)>5&&a.push(n)}});for(let n=a.length-1;n>0;n--){const r=Math.floor(Math.random()*(n+1));[a[n],a[r]]=[a[r],a[n]]}for(let n=0;n<s.length&&n<a.length;n++){const r=s[n],o=a[n],l=`${o.q},${o.r}`;t.questItems.set(l,{itemId:r.objective.itemId,questId:r.id,found:!1,q:o.q,r:o.r}),this.state.addLog(`A ${r.objective.itemId} is hidden somewhere in this dungeon...`,"info")}}exitDungeon(){var e;this.inDungeon&&(this.clearPathPreview(),this.dungeonTravelState=null,this.worldGrid&&(this.grid=this.worldGrid,this.hexActions&&this.hexActions.setGrid(this.grid),this.pois=this.worldPois,this.roads=this.worldRoads,this.rivers=this.worldRivers),(e=this.currentDungeon)!=null&&e.poi&&(this.state.player.position={q:this.currentDungeon.poi.q,r:this.currentDungeon.poi.r},this.renderer.centerOnHex(this.grid,this.currentDungeon.poi.q,this.currentDungeon.poi.r)),this.currentDungeon=null,this.inDungeon=!1,this.worldGrid=null,this.worldPois=null,this.worldRoads=null,this.worldRivers=null,this.worldPlayerPosition=null,this.currentDungeonEnemy=null,this.music&&(this.music.transitionFromDungeon(),this.music.ensureCorrectMusic()),this.updateParticleBiome(),this.encounters.onDungeonCombatEnd=null,this.state.addLog("Left the dungeon.","info"),this.render())}getDungeonHexPath(e,t,i=6){var d;if(!this.currentDungeon)return null;const s=this.currentDungeon;if(!s.currentFloor)return null;const n=`${e.q},${e.r}`,r=`${t.q},${t.r}`;if(n===r)return[];const o=new Set([n]),l=[{q:e.q,r:e.r,path:[]}],c=[[1,0],[-1,0],[0,1],[0,-1],[1,-1],[-1,1]];for(;l.length>0;){const u=l.shift();for(const[h,m]of c){const g=u.q+h,y=u.r+m,f=`${g},${y}`;if(o.has(f))continue;o.add(f);const p=this.grid.getCell(g,y);if(!p||(d=p.biome)!=null&&d.impassable)continue;const v=s.doors.get(f);if(v&&v.locked&&!v.opened)continue;const b=[...u.path,{q:g,r:y,hex:p}];if(g===t.q&&y===t.r)return b.length>i?null:b;b.length<i&&l.push({q:g,r:y,path:b})}}return null}updateDungeonPathPreview(e){var r;if(!this.currentDungeon){this.clearPathPreview();return}const i=this.currentDungeon.playerPosition;if(e.q===i.q&&e.r===i.r){this.clearPathPreview();return}if((r=e.biome)!=null&&r.impassable){this.clearPathPreview();return}const s=this.getDungeonHexPath(i,e,this.maxPathLength);if(!s||s.length===0){this.clearPathPreview();return}const a=this.grid.getCell(i.q,i.r),n=[{q:i.q,r:i.r,hex:a},...s];this.pathPreview=n,this.render()}walkAlongDungeonPath(){var e;!this.pathPreview||this.pathPreview.length<2||(e=this.dungeonTravelState)!=null&&e.isMoving||this.currentDungeon&&(this.dungeonTravelState={isMoving:!0,path:[...this.pathPreview],currentStep:1,cancelled:!1},this.clearPathPreview(),this.animateDungeonTravelStep())}animateDungeonTravelStep(){if(!this.dungeonTravelState||!this.dungeonTravelState.isMoving)return;if(!this.currentDungeon){this.finishDungeonTravel();return}const{path:e,currentStep:t,cancelled:i}=this.dungeonTravelState,s=this.currentDungeon;if(i||t>=e.length){this.finishDungeonTravel();return}const a=e[t],n=`${a.q},${a.r}`,r=s.enemies.get(n);if(r&&!r.defeated){this.executeDungeonStep(a,()=>{this.startDungeonCombat(a.q,a.r,r),this.finishDungeonTravel()});return}const o=s.doors.get(n);if(o&&o.locked&&!o.opened)if(s.hasFloorKey)o.locked=!1,o.opened=!0,this.state.addLog("Used the floor key to unlock the door.","success");else if(this.inventory.has("lockpick"))this.inventory.remove("lockpick",1),o.locked=!1,o.opened=!0,this.state.addLog("Picked the lock with a lockpick.","success");else{this.state.addLog("Path blocked by a locked door.","warning"),this.finishDungeonTravel();return}this.executeDungeonStep(a,()=>{this.dungeonTravelState.currentStep++,setTimeout(()=>this.animateDungeonTravelStep(),120)})}executeDungeonStep(e,t){var h;const i=this.currentDungeon,s=i.playerPosition,a=`${e.q},${e.r}`,n=this.grid.hexToPixel(s.q,s.r),r=this.grid.hexToPixel(e.q,e.r);this.playerFacingAngle=Math.atan2(r.y-n.y,r.x-n.x),i.playerPosition={q:e.q,r:e.r},i.currentFloor.explored.add(a);const o=[[1,0],[-1,0],[0,1],[0,-1],[1,-1],[-1,1]];for(const[m,g]of o){const y=e.q+m,f=e.r+g;this.grid.getCell(y,f)&&i.currentFloor.explored.add(`${y},${f}`)}this.renderer.centerOnHex(this.grid,e.q,e.r);const l=i.chests.get(a);l&&!l.opened&&this.openDungeonContainer(e.q,e.r,l);const c=i.questItems.get(a);c&&!c.found&&(c.found=!0,this.state.addLog(`Found ${c.itemId}!`,"success"),this.quests.checkDungeonProgress("retrieve",{poi:i.poi,itemId:c.itemId}));const d=i.ladders.get(a);if(d){const m=d.direction==="down"?"descending":"ascending";this.state.addLog(`Found a ladder ${m}. Click again to use it.`,"discovery")}const u=(h=i.exits)==null?void 0:h.find(m=>m.q===e.q&&m.r===e.r);u&&!u.isEntrance&&this.state.addLog("Found an exit! Click again to leave.","discovery"),this.render(),t&&t()}finishDungeonTravel(){this.currentDungeon&&this.moveDungeonEnemies(),this.dungeonTravelState=null,this.render()}handleDungeonInteraction(e,t){var c;if(!this.currentDungeon)return;const i=this.findHexAtScreen(e,t);if(!i)return;const s=this.currentDungeon,a=s.playerPosition,n=`${i.q},${i.r}`;if(i.q!==a.q||i.r!==a.r)return;const r=s.ladders.get(n);if(r){this.useDungeonLadder(r);return}const o=(c=s.exits)==null?void 0:c.find(d=>d.q===i.q&&d.r===i.r);if(o&&!o.isEntrance){this.useDungeonExit(o);return}const l=s.portals.get(n);if(l){this.useDungeonPortal(l);return}if(s.currentFloorIndex===0){const d=s.entrance;if(i.q===d.q&&i.r===d.r){this.state.addLog("The entrance has collapsed. Find another way out.","warning");return}}}handleDungeonMovement(e,t){var y,f,p;if(!this.currentDungeon)return;const i=this.findHexAtScreen(e,t);if(!i)return;const s=this.currentDungeon,a=s.playerPosition;if(!a||typeof a.q!="number"||typeof a.r!="number"){console.error("Invalid dungeon player position:",a);return}const n=`${i.q},${i.r}`;if(i.q===a.q&&i.r===a.r){const v=s.ladders.get(n);if(v){this.useDungeonLadder(v);return}const b=(y=s.exits)==null?void 0:y.find(w=>w.q===i.q&&w.r===i.r);if(b&&!b.isEntrance){this.useDungeonExit(b);return}const k=s.portals.get(n);if(k){this.useDungeonPortal(k);return}if(s.currentFloorIndex===0){const w=s.entrance;if(i.q===w.q&&i.r===w.r){this.state.addLog("The entrance has collapsed. Find another way out.","warning");return}}return}if(!this.isHexAdjacent(a.q,a.r,i.q,i.r)){this.state.addLog("Too far to move there.","warning");return}if((f=i.biome)!=null&&f.impassable){this.state.addLog("You can't walk through walls.","warning");return}const r=s.doors.get(n);if(r&&r.locked&&!r.opened)if(s.hasFloorKey)r.locked=!1,r.opened=!0,this.state.addLog("Used the floor key to unlock the door.","success");else if(this.inventory.has("lockpick"))this.inventory.remove("lockpick",1),r.locked=!1,r.opened=!0,this.state.addLog("Picked the lock with a lockpick.","success");else{this.state.addLog("This door is locked. Find the key or a lockpick.","warning");return}const o=this.grid.hexToPixel(a.q,a.r),l=this.grid.hexToPixel(i.q,i.r);this.playerFacingAngle=Math.atan2(l.y-o.y,l.x-o.x),s.playerPosition={q:i.q,r:i.r},s.currentFloor.explored.add(n);const c=[[1,0],[-1,0],[0,1],[0,-1],[1,-1],[-1,1]];for(const[v,b]of c){const k=i.q+v,w=i.r+b;this.grid.getCell(k,w)&&s.currentFloor.explored.add(`${k},${w}`)}this.renderer.centerOnHex(this.grid,i.q,i.r);const d=s.enemies.get(n);if(d&&!d.defeated){this.startDungeonCombat(i.q,i.r,d);return}const u=s.chests.get(n);u&&!u.opened&&this.openDungeonContainer(i.q,i.r,u);const h=s.questItems.get(n);h&&!h.found&&(h.found=!0,this.state.addLog(`Found ${h.itemId}!`,"success"),this.quests.checkDungeonProgress("retrieve",{poi:s.poi,itemId:h.itemId}));const m=s.ladders.get(n);if(m){const v=m.direction==="down"?"descending":"ascending";this.state.addLog(`Found a ladder ${v}. Click again to use it.`,"discovery")}const g=(p=s.exits)==null?void 0:p.find(v=>v.q===i.q&&v.r===i.r);g&&!g.isEntrance&&this.state.addLog("Found an exit! Click again to leave.","discovery"),this.moveDungeonEnemies(),this.render()}moveDungeonEnemies(){var n;if(!this.currentDungeon)return;const e=this.currentDungeon,t=e.currentFloor;if(!t)return;const i=e.playerPosition,s=e.grid,a=[];for(const[r,o]of t.enemies){if(o.defeated)continue;const l=Math.abs(o.q-i.q)+Math.abs(o.r-i.r);l>1&&l<=5&&a.push({key:r,enemy:o})}for(const{key:r,enemy:o}of a){const l=[{q:o.q+1,r:o.r},{q:o.q-1,r:o.r},{q:o.q,r:o.r+1},{q:o.q,r:o.r-1},{q:o.q+1,r:o.r-1},{q:o.q-1,r:o.r+1}];let c=null,d=Math.abs(o.q-i.q)+Math.abs(o.r-i.r);for(const u of l){const h=s.getCell(u.q,u.r);if(!h||(n=h.biome)!=null&&n.impassable)continue;const m=`${u.q},${u.r}`;if(t.enemies.has(m)&&!t.enemies.get(m).defeated||u.q===i.q&&u.r===i.r||t.doors.has(m)&&t.doors.get(m).locked)continue;const g=Math.abs(u.q-i.q)+Math.abs(u.r-i.r);g<d&&(d=g,c=u)}c&&Math.random()<.6&&(t.enemies.delete(r),o.q=c.q,o.r=c.r,t.enemies.set(`${c.q},${c.r}`,o))}}exploreDungeonArea(e,t,i=3){var a,n;const s=(a=this.currentDungeon)==null?void 0:a.currentFloor;if(!(!s||!this.grid)){for(let r=-i;r<=i;r++)for(let o=-i;o<=i;o++)if(Math.abs(r)+Math.abs(o)+Math.abs(-r-o)<=i+1){const c=e+r,d=t+o,u=this.grid.getCell(c,d);u&&!((n=u.biome)!=null&&n.impassable)&&s.explored.add(`${c},${d}`)}}}useDungeonLadder(e){var a,n,r;const t=this.currentDungeon,i=e.targetFloor,s=!!this.state.equippedTorch;if(this.clearPathPreview(),this.dungeonTravelState=null,e.direction==="down"){if(t.descendToFloor(i)){this.grid=t.grid,this.hexActions&&this.hexActions.setGrid(this.grid),this.exploreDungeonArea(t.playerPosition.q,t.playerPosition.r,3),this.renderer._centered=!1,this.renderer.centerOnHex(this.grid,t.playerPosition.q,t.playerPosition.r);const o=t.currentFloor,l=((a=o==null?void 0:o.floorType)==null?void 0:a.name)||"Standard",c=((n=o==null?void 0:o.floorType)==null?void 0:n.description)||"";this.state.addLog(`Descended to floor ${i+1} of ${t.totalFloors}.`,"discovery"),l!=="Standard"&&this.state.addLog(`${l}: ${c}`,"info"),i>=5&&!s?this.state.addLog("It is pitch black! You need a torch to see.","danger"):i>=3&&!s?this.state.addLog("The darkness deepens... A torch would help.","warning"):i>=2&&l==="Standard"&&this.state.addLog("The air grows cold and stale.","info"),this.render()}}else if(t.ascendToFloor(i)){this.grid=t.grid,this.hexActions&&this.hexActions.setGrid(this.grid),this.exploreDungeonArea(t.playerPosition.q,t.playerPosition.r,3),this.renderer._centered=!1,this.renderer.centerOnHex(this.grid,t.playerPosition.q,t.playerPosition.r);const o=t.currentFloor,l=((r=o==null?void 0:o.floorType)==null?void 0:r.name)||"Standard";this.state.addLog(`Ascended to floor ${i+1} of ${t.totalFloors}.`,"discovery"),l!=="Standard"&&this.state.addLog(`${l}`,"info"),i<3&&t.currentFloorIndex>=3&&this.state.addLog("Light returns as you climb.","info"),this.render()}}openDungeonContainer(e,t,i){i.opened=!0;const s=Wt(i),a=i.type==="vase"?"vase":"chest";this.inventory.add(s.id,s.quantity)?(this.state.addLog(`Opened ${a}: Found ${s.quantity}x ${s.name}!`,"success"),this.townActions&&this.townActions.updateTaskProgress("gather",s.id,s.quantity),this.guilds&&this.guilds.updateContractProgress("gather",{resource:s.id,amount:s.quantity})):this.state.addLog(`Opened ${a}: Inventory full!`,"warning"),!this.inventory.has("rope")&&Math.random()<.5&&this.inventory.add("rope",1)&&this.state.addLog("Also found a rope!","success")}useDungeonExit(e){if(!this._exitingDungeon&&!(!this.inDungeon||!this.currentDungeon)){if(!e||typeof e.overworldQ!="number"||typeof e.overworldR!="number"){console.error("Invalid exit info:",e),this.state.addLog("Cannot use this exit.","warning");return}if(!this.worldGrid){console.error("No world grid to restore!"),this.state.addLog("Cannot exit - world state lost.","error");return}this._exitingDungeon=!0,this.grid=this.worldGrid,this.hexActions&&this.hexActions.setGrid(this.grid),this.pois=this.worldPois||[],this.roads=this.worldRoads||[],this.rivers=this.worldRivers||[],this.state.player.position={q:e.overworldQ,r:e.overworldR},this.renderer.centerOnHex(this.grid,e.overworldQ,e.overworldR),this.currentDungeon=null,this.inDungeon=!1,this.worldGrid=null,this.worldPois=null,this.worldRoads=null,this.worldRivers=null,this.worldPlayerPosition=null,this.currentDungeonEnemy=null,this.music&&(this.music.transitionFromDungeon(),this.music.ensureCorrectMusic()),this.updateParticleBiome(),this.encounters.onDungeonCombatEnd=null,this._exitingDungeon=!1,this.state.addLog("You emerge from the dungeon.","info"),this.render()}}useDungeonPortal(e){if(this._exitingDungeon||!this.inDungeon||!this.currentDungeon)return;if(!this.worldGrid||!this.worldPois){console.error("No world state to restore!"),this.state.addLog("The portal flickers and fades...","warning");return}let t=null;const i=this.currentDungeon.poi;if(e.destination==="cult"){const s=this.worldPois.filter(a=>{var n;return((n=a.type)==null?void 0:n.category)==="cult"&&a.q!==(i==null?void 0:i.q)&&a.r!==(i==null?void 0:i.r)});s.length>0&&(t=s[Math.floor(Math.random()*s.length)])}else{const s=this.worldPois.filter(a=>{var n;return((n=a.type)==null?void 0:n.category)==="guild"&&a.q!==(i==null?void 0:i.q)&&a.r!==(i==null?void 0:i.r)});s.length>0&&(t=s[Math.floor(Math.random()*s.length)])}if(!t){const s=this.worldPois.filter(a=>{var n,r;return(((n=a.type)==null?void 0:n.category)==="settlement"||((r=a.type)==null?void 0:r.category)==="landmark")&&a.q!==(i==null?void 0:i.q)&&a.r!==(i==null?void 0:i.r)});s.length>0&&(t=s[Math.floor(Math.random()*s.length)])}if(!t){this.state.addLog("The portal fizzles out - no destination found.","warning");return}this._exitingDungeon=!0,this.grid=this.worldGrid,this.hexActions&&this.hexActions.setGrid(this.grid),this.pois=this.worldPois||[],this.roads=this.worldRoads||[],this.rivers=this.worldRivers||[],this.state.player.position={q:t.q,r:t.r},this.state.player.currentPOI=t,t.id&&this.state.discoverPOI(t.id,t),this.renderer.centerOnHex(this.grid,t.q,t.r),this.currentDungeon=null,this.inDungeon=!1,this.worldGrid=null,this.worldPois=null,this.worldRoads=null,this.worldRivers=null,this.worldPlayerPosition=null,this.currentDungeonEnemy=null,this.music&&(this.music.transitionFromDungeon(),this.music.ensureCorrectMusic()),this.updateParticleBiome(),this.encounters.onDungeonCombatEnd=null,this._exitingDungeon=!1,e.destination==="cult"?(this.state.addLog("You step through the swirling portal...","info"),this.state.addLog(`You emerge near ${t.name}. Dark energy lingers in the air.`,"discovery")):(this.state.addLog("The portal envelops you in golden light...","info"),this.state.addLog(`You materialize at ${t.name}.`,"discovery")),this.render()}startRoguelikeRun(e){if(this.isPlayerDead)return;let t=1;if(this.overworldCorruption){const i=this.overworldCorruption.getZoneAt(e.q,e.r);i==="BLIGHTED"?t=3:i==="CORRUPTED"?t=2:i==="TAINTED"&&(t=1.5)}this.currentRoguelikeRun=createRoguelikeRun(e,t),this.currentRoguelikeRun.start(),this.inRoguelikeRun=!0,this.worldGrid=this.grid,this.worldPois=this.pois,this.worldRoads=this.roads,this.worldRivers=this.rivers,this.worldPlayerPosition={...this.state.player.position},this.music&&this.music.transitionToDungeon(),this.state.addLog(`Descending into ${this.currentRoguelikeRun.dungeonType.name}...`,"discovery"),this.state.addLog(`${this.currentRoguelikeRun.totalFloors} floors of darkness await. Find the relic at the bottom.`,"info"),this.showRoguelikeRoomChoices()}showRoguelikeRoomChoices(){var m;if(!this.currentRoguelikeRun||this.currentRoguelikeRun.state!==RUN_STATES.IN_PROGRESS)return;const e=this.currentRoguelikeRun,t=e.getCurrentFloor(),i=e.currentFloor+1,s=e.totalFloors;let a="";t.rooms.forEach((g,y)=>{const f=g.type.icon,p=g.type.name,v=g.type.description,b=g.enemies.length>0?` (${g.enemies.length} enemies)`:"";a+=`
                <button class="room-choice-btn" data-room-idx="${y}" style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    padding: 15px 20px;
                    margin: 8px;
                    background: rgba(40, 40, 60, 0.9);
                    border: 2px solid #555;
                    border-radius: 8px;
                    color: #ddd;
                    cursor: pointer;
                    min-width: 120px;
                    transition: all 0.2s;
                ">
                    <span style="font-size: 32px; margin-bottom: 8px;">${f}</span>
                    <span style="font-weight: bold; color: #fff;">${p}</span>
                    <span style="font-size: 12px; color: #aaa; margin-top: 4px;">${v}</span>
                    ${b?`<span style="font-size: 11px; color: #c55; margin-top: 4px;">${b}</span>`:""}
                </button>
            `});const n=`
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                <span>Floor: ${i} / ${s}</span>
                <span>Rooms: ${e.roomsCompleted}</span>
                <span>Gold: ${e.goldCollected}</span>
                <span>Enemies: ${e.enemiesDefeated}</span>
            </div>
        `;let r="";const o=e.runBonuses;(o.damageBonus>0||o.defenseBonus>0||o.dodgeBonus>0||o.maxHpBonus>0)&&(r=`<div style="margin-bottom: 15px; padding: 8px; background: rgba(50,100,50,0.3); border-radius: 5px; font-size: 12px;">
                <strong>Run Bonuses:</strong>
                ${o.damageBonus>0?`+${Math.round(o.damageBonus*100)}% DMG`:""}
                ${o.defenseBonus>0?`+${Math.round(o.defenseBonus*100)}% DEF`:""}
                ${o.dodgeBonus>0?`+${Math.round(o.dodgeBonus*100)}% Dodge`:""}
                ${o.maxHpBonus>0?`+${o.maxHpBonus} Max HP`:""}
            </div>`);let l="";t.isBossFloor?l=`<div style="text-align: center; color: #c44; font-weight: bold; margin-bottom: 10px;">
                ðŸ‘¹ BOSS FLOOR - Defeat the guardian to proceed!
            </div>`:t.isRelicFloor&&(l=`<div style="text-align: center; color: #4c4; font-weight: bold; margin-bottom: 10px;">
                âœ¨ RELIC CHAMBER - The purifying relic awaits!
            </div>`);const d=e.canRetreat()?`
            <button id="retreat-run-btn" style="
                margin-top: 15px;
                padding: 8px 16px;
                background: rgba(100, 60, 40, 0.8);
                border: 1px solid #864;
                border-radius: 5px;
                color: #ddd;
                cursor: pointer;
            ">ðŸƒ Retreat (keep 50% gold + items)</button>
        `:"",u=`
            <div class="roguelike-run-panel" style="max-width: 500px;">
                ${n}
                ${r}
                ${l}

                <div style="text-align: center; margin-bottom: 15px;">
                    <strong>Choose your path:</strong>
                </div>

                <div style="display: flex; flex-wrap: wrap; justify-content: center;">
                    ${a}
                </div>

                ${d}
            </div>
        `;this.showModal(`Floor ${i} - ${e.dungeonType.name}`,u);const h=this.ui.gameModal;h.querySelectorAll(".room-choice-btn").forEach(g=>{g.addEventListener("click",()=>{const y=parseInt(g.dataset.roomIdx);this.selectRoguelikeRoom(y)}),g.addEventListener("mouseenter",()=>{g.style.borderColor="#8af",g.style.background="rgba(60, 60, 100, 0.9)"}),g.addEventListener("mouseleave",()=>{g.style.borderColor="#555",g.style.background="rgba(40, 40, 60, 0.9)"})}),(m=h.querySelector("#retreat-run-btn"))==null||m.addEventListener("click",()=>{this.retreatFromRoguelikeRun()})}selectRoguelikeRoom(e){if(!this.currentRoguelikeRun)return;const i=this.currentRoguelikeRun.selectRoom(e);if(i)switch(this.hideModal(),i.type.id){case"combat":case"elite":this.handleRoguelikeCombatRoom(i);break;case"treasure":this.handleRoguelikeTreasureRoom(i);break;case"shrine":this.handleRoguelikeShrineRoom(i);break;case"event":this.handleRoguelikeEventRoom(i);break;case"boss":this.handleRoguelikeBossRoom(i);break;case"relic":this.handleRoguelikeRelicRoom(i);break}}handleRoguelikeCombatRoom(e){const t=this.currentRoguelikeRun,i=e.enemies;if(i.length===0){this.completeRoguelikeRoom(e,{gold:10});return}const s=i.map((n,r)=>{var d;const o=(d=this.encounters.ENEMIES)==null?void 0:d[n.templateId];if(!o)return null;const l=1+(n.level-1)*.15,c=n.isElite?1.5:1;return{id:`roguelike_${Date.now()}_${r}`,templateId:n.templateId,name:n.isElite?`Elite ${o.name}`:o.name,icon:o.icon,hp:Math.floor(o.hp*l*c),maxHp:Math.floor(o.hp*l*c),damage:Array.isArray(o.damage)?o.damage.map(u=>Math.floor(u*l*c)):Math.floor(o.damage*l*c),defense:Math.floor((o.defense||0)*l),agility:o.agility||5,xp:Math.floor(o.xp*l*c)}}).filter(n=>n!==null);if(s.length===0){this.completeRoguelikeRoom(e,{gold:15});return}this.currentRoguelikeRoom=e,this.encounters.onRoguelikeCombatEnd=n=>{this.onRoguelikeCombatEnd(n)};const a=this.state.player;t.runBonuses.maxHpBonus>0&&(a.maxHp=(a.maxHp||100)+t.runBonuses.maxHpBonus,a.hp=Math.min(a.hp,a.maxHp)),this.encounters.startCombatWithMultipleEnemies(s),this.showCombatModal()}onRoguelikeCombatEnd(e){const t=this.currentRoguelikeRoom,i=this.currentRoguelikeRun;if(!(!t||!i)){if(e){const s=t.type.id==="elite",a=15+i.currentFloor*3,n=s?a*2:a;this.state.addLog(`Victory! Gained ${n} gold.`,"success"),this.completeRoguelikeRoom(t,{gold:n})}else this.dieInRoguelikeRun();this.currentRoguelikeRoom=null,this.encounters.onRoguelikeCombatEnd=null}}handleRoguelikeTreasureRoom(e){var n;const t=e.loot;let i='<div style="text-align: center;">';i+='<p style="margin-bottom: 15px;">You found treasure!</p>',i+='<div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 15px;">';let s=0;const a=[];t.forEach(r=>{r.id==="gold"?s+=r.quantity:(a.push(r),i+=`<div style="margin: 5px 0;">${r.name} x${r.quantity} <span style="color: #aaa;">(${r.tier})</span></div>`)}),s>0&&(i+=`<div style="margin-top: 10px; color: #fc5;">+${s} Gold</div>`),i+="</div>",i+='<button id="collect-treasure-btn" style="padding: 10px 25px; background: #4a4; border: none; border-radius: 5px; color: #fff; cursor: pointer;">Collect</button>',i+="</div>",this.showModal("ðŸ’Ž Treasure Room",i),(n=this.ui.gameModal.querySelector("#collect-treasure-btn"))==null||n.addEventListener("click",()=>{a.forEach(r=>{this.inventory.add(r.id,r.quantity)}),this.state.player.gold+=s,this.hideModal(),this.completeRoguelikeRoom(e,{gold:s,items:a})})}handleRoguelikeShrineRoom(e){var n;let t='<div style="text-align: center;">';t+='<p style="margin-bottom: 15px;">A sacred shrine offers blessings...</p>',t+='<div style="display: flex; flex-wrap: wrap; justify-content: center;">';const s=[...SHRINE_BLESSINGS].sort(()=>Math.random()-.5).slice(0,3);s.forEach((r,o)=>{t+=`
                <button class="blessing-btn" data-blessing-idx="${o}" style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    padding: 15px;
                    margin: 8px;
                    background: rgba(60, 80, 100, 0.9);
                    border: 2px solid #68a;
                    border-radius: 8px;
                    color: #ddd;
                    cursor: pointer;
                    min-width: 140px;
                ">
                    <span style="font-weight: bold; color: #8cf;">${r.name}</span>
                    <span style="font-size: 12px; color: #aaa; margin-top: 8px;">${r.description}</span>
                </button>
            `}),t+="</div>",t+='<button id="skip-shrine-btn" style="margin-top: 15px; padding: 8px 16px; background: rgba(80, 80, 80, 0.8); border: 1px solid #666; border-radius: 5px; color: #aaa; cursor: pointer;">Leave without blessing</button>',t+="</div>",this.showModal("ðŸ›ï¸ Sacred Shrine",t);const a=this.ui.gameModal;a.querySelectorAll(".blessing-btn").forEach(r=>{r.addEventListener("click",()=>{const o=parseInt(r.dataset.blessingIdx),l=s[o],c=l.effect,d=this.currentRoguelikeRun;if(c.healPercent){const u=Math.floor(this.state.player.maxHp*c.healPercent);this.state.player.hp=Math.min(this.state.player.maxHp,this.state.player.hp+u),this.state.addLog(`Healed for ${u} HP.`,"success")}c.damageBonus&&(d.runBonuses.damageBonus+=c.damageBonus),c.defenseBonus&&(d.runBonuses.defenseBonus+=c.defenseBonus),c.dodgeBonus&&(d.runBonuses.dodgeBonus+=c.dodgeBonus),c.maxHpBonus&&(d.runBonuses.maxHpBonus+=c.maxHpBonus),e.blessing=l,this.state.addLog(`Received blessing: ${l.name}`,"discovery"),this.hideModal(),this.completeRoguelikeRoom(e,{blessing:l})}),r.addEventListener("mouseenter",()=>{r.style.borderColor="#8cf",r.style.background="rgba(80, 100, 140, 0.9)"}),r.addEventListener("mouseleave",()=>{r.style.borderColor="#68a",r.style.background="rgba(60, 80, 100, 0.9)"})}),(n=a.querySelector("#skip-shrine-btn"))==null||n.addEventListener("click",()=>{this.hideModal(),this.completeRoguelikeRoom(e,{})})}handleRoguelikeEventRoom(e){const t=e.event;if(!t){this.completeRoguelikeRoom(e,{});return}let i='<div style="text-align: center;">';i+=`<p style="margin-bottom: 15px; font-style: italic;">${t.description}</p>`,i+='<div style="display: flex; flex-wrap: wrap; justify-content: center;">',t.choices.forEach((a,n)=>{const r=a.risk>0?` <span style="color: #c55;">(${Math.round(a.risk*100)}% risk)</span>`:"";i+=`
                <button class="event-choice-btn" data-choice-idx="${n}" style="
                    display: block;
                    width: 100%;
                    padding: 12px 20px;
                    margin: 5px 0;
                    background: rgba(60, 60, 80, 0.9);
                    border: 1px solid #666;
                    border-radius: 5px;
                    color: #ddd;
                    cursor: pointer;
                    text-align: left;
                ">
                    ${a.label}${r}
                </button>
            `}),i+="</div></div>",this.showModal(`â“ ${t.name}`,i),this.ui.gameModal.querySelectorAll(".event-choice-btn").forEach(a=>{a.addEventListener("click",()=>{const n=parseInt(a.dataset.choiceIdx),r=t.choices[n];this.resolveRoguelikeEventChoice(e,r)}),a.addEventListener("mouseenter",()=>{a.style.borderColor="#888",a.style.background="rgba(80, 80, 100, 0.9)"}),a.addEventListener("mouseleave",()=>{a.style.borderColor="#666",a.style.background="rgba(60, 60, 80, 0.9)"})})}resolveRoguelikeEventChoice(e,t){this.hideModal();const i=this.currentRoguelikeRun,s={},a=Math.random();if(t.risk>0&&a<t.risk&&t.loss){const r=t.loss;if(r.gold&&(this.state.player.gold=Math.max(0,this.state.player.gold+r.gold),this.state.addLog(`Lost ${Math.abs(r.gold)} gold!`,"warning")),r.hpPercent){const o=Math.floor(this.state.player.maxHp*Math.abs(r.hpPercent));this.state.player.hp=Math.max(1,this.state.player.hp-o),this.state.addLog(`Took ${o} damage!`,"warning")}if(r.combat){this.state.addLog(`A ${r.combat} attacks!`,"combat");const o=10+i.currentFloor*2;this.state.player.hp=Math.max(1,this.state.player.hp-o)}r.debuff&&this.state.addLog(`You are ${r.debuff}!`,"warning")}else if(t.reward){const r=t.reward;if(r.gold&&(s.gold=r.gold,this.state.player.gold+=r.gold,this.state.addLog(`Gained ${r.gold} gold!`,"success")),r.healPercent){const o=Math.floor(this.state.player.maxHp*r.healPercent);this.state.player.hp=Math.min(this.state.player.maxHp,this.state.player.hp+o),this.state.addLog(`Healed for ${o} HP!`,"success")}r.item&&(this.inventory.add(r.item,1),this.state.addLog(`Found ${r.item}!`,"discovery"),s.items=[{id:r.item,quantity:1}]),r.xp&&(this.state.player.xp=(this.state.player.xp||0)+r.xp,this.state.addLog(`Gained ${r.xp} XP!`,"success")),r.damageBonus&&(i.runBonuses.damageBonus+=r.damageBonus,this.state.addLog(`+${Math.round(r.damageBonus*100)}% damage this run!`,"success")),r.buff&&this.state.addLog(`You are ${r.buff}!`,"success")}this.completeRoguelikeRoom(e,s)}handleRoguelikeBossRoom(e){var r;const t=this.currentRoguelikeRun,i=e.enemies[0];if(!i){this.completeRoguelikeRoom(e,{gold:100});return}const s=(r=this.encounters.ENEMIES)==null?void 0:r[i.templateId];if(!s){this.state.addLog("The boss has fled!","info"),this.completeRoguelikeRoom(e,{gold:50});return}i.level;const a=1.5+t.currentFloor/8*.5,n={id:`boss_${Date.now()}`,templateId:i.templateId,name:i.name||`${s.name} (Boss)`,icon:s.icon,hp:Math.floor(s.hp*a*2),maxHp:Math.floor(s.hp*a*2),damage:Array.isArray(s.damage)?s.damage.map(o=>Math.floor(o*a*1.3)):Math.floor(s.damage*a*1.3),defense:Math.floor((s.defense||0)*a),agility:s.agility||5,xp:Math.floor(s.xp*a*3)};this.currentRoguelikeRoom=e,this.currentRoguelikeBoss=!0,this.encounters.onRoguelikeCombatEnd=o=>{this.onRoguelikeBossCombatEnd(o)},this.state.addLog(`ðŸ‘¹ ${n.name} appears!`,"combat"),this.encounters.startCombatWithMultipleEnemies([n]),this.showCombatModal()}onRoguelikeBossCombatEnd(e){const t=this.currentRoguelikeRoom,i=this.currentRoguelikeRun;if(!(!t||!i)){if(e){const s=50+i.currentFloor*10;this.state.addLog(`Boss defeated! Gained ${s} gold!`,"success"),this.completeRoguelikeRoom(t,{gold:s})}else this.dieInRoguelikeRun();this.currentRoguelikeRoom=null,this.currentRoguelikeBoss=!1,this.encounters.onRoguelikeCombatEnd=null}}handleRoguelikeRelicRoom(e){var n;const t=this.currentRoguelikeRun,i=e.relic||t.targetRelic,s=RELIC_COLORS[i]||{name:"Ancient Relic",color:"#fff"};let a='<div style="text-align: center;">';a+='<div style="font-size: 64px; margin: 20px 0;">âœ¨</div>',a+=`<p style="margin-bottom: 15px; font-size: 18px; color: ${s.color};">You found the ${s.name}!</p>`,a+='<p style="color: #aaa; margin-bottom: 20px;">This sacred relic can purify corrupted zones when placed on an overworld shrine.</p>',a+='<button id="take-relic-btn" style="padding: 12px 30px; background: linear-gradient(180deg, #5a5, #383); border: 2px solid #8c8; border-radius: 5px; color: #fff; cursor: pointer; font-size: 16px;">Take the Relic</button>',a+="</div>",this.showModal("âœ¨ Relic Chamber",a),(n=this.ui.gameModal.querySelector("#take-relic-btn"))==null||n.addEventListener("click",()=>{this.inventory.add(i,1),t.relicFound=i,this.state.addLog(`Obtained ${s.name}!`,"discovery"),this.state.addLog("Find an overworld shrine to place this relic and cleanse the corruption.","info"),this.hideModal(),this.completeRoguelikeRun()})}completeRoguelikeRoom(e,t){const i=this.currentRoguelikeRun;if(!i)return;i.completeRoom(e,t),i.advanceFloor()===null?this.completeRoguelikeRun():this.showRoguelikeRoomChoices()}completeRoguelikeRun(){var s;const e=this.currentRoguelikeRun;if(!e)return;const t=e.complete();let i='<div style="text-align: center;">';if(i+='<div style="font-size: 48px; margin: 20px 0;">ðŸ†</div>',i+='<h3 style="color: #4c4; margin-bottom: 15px;">Run Complete!</h3>',i+='<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin-bottom: 15px;">',i+=`<div>Floors Cleared: ${t.stats.floorsCleared}</div>`,i+=`<div>Enemies Defeated: ${t.stats.enemiesDefeated}</div>`,i+=`<div>Bosses Defeated: ${t.stats.bossesDefeated}</div>`,i+=`<div>Gold Collected: ${t.gold}</div>`,i+=`<div>Items Found: ${t.items.length}</div>`,t.relic){const a=RELIC_COLORS[t.relic]||{name:"Relic"};i+=`<div style="color: #4c4; margin-top: 10px;">Relic Obtained: ${a.name}</div>`}i+="</div>",i+='<button id="exit-run-btn" style="padding: 12px 30px; background: #4a4; border: none; border-radius: 5px; color: #fff; cursor: pointer;">Return to Surface</button>',i+="</div>",this.showModal("Victory!",i),(s=this.ui.gameModal.querySelector("#exit-run-btn"))==null||s.addEventListener("click",()=>{this.hideModal(),this.exitRoguelikeRun(t)})}retreatFromRoguelikeRun(){var s;const e=this.currentRoguelikeRun;if(!e)return;const t=e.retreat();let i='<div style="text-align: center;">';i+='<div style="font-size: 48px; margin: 20px 0;">ðŸƒ</div>',i+='<h3 style="color: #ca4; margin-bottom: 15px;">Retreated</h3>',i+='<p style="color: #aaa; margin-bottom: 15px;">You escaped with some of your findings.</p>',i+='<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin-bottom: 15px;">',i+=`<div>Floors Explored: ${t.stats.floorsCleared}</div>`,i+=`<div>Gold Kept: ${t.gold} (50%)</div>`,i+=`<div>Items Kept: ${t.items.length}</div>`,i+="</div>",i+='<button id="exit-run-btn" style="padding: 12px 30px; background: #864; border: none; border-radius: 5px; color: #fff; cursor: pointer;">Return to Surface</button>',i+="</div>",this.showModal("Retreat",i),(s=this.ui.gameModal.querySelector("#exit-run-btn"))==null||s.addEventListener("click",()=>{this.hideModal(),this.exitRoguelikeRun(t)})}dieInRoguelikeRun(){var s;const e=this.currentRoguelikeRun;if(!e)return;const t=e.die();this.state.player.hp=Math.floor(this.state.player.maxHp*.25);let i='<div style="text-align: center;">';i+='<div style="font-size: 48px; margin: 20px 0;">ðŸ’€</div>',i+='<h3 style="color: #c44; margin-bottom: 15px;">You Died</h3>',i+='<p style="color: #aaa; margin-bottom: 15px;">The darkness claims your findings...</p>',i+='<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin-bottom: 15px;">',i+=`<div>Final Floor: ${t.stats.floorsCleared}</div>`,i+=`<div>Gold Lost: ${e.goldCollected-t.gold}</div>`,i+='<div style="color: #c44;">Items Lost: All</div>',i+="</div>",i+='<button id="exit-run-btn" style="padding: 12px 30px; background: #633; border: none; border-radius: 5px; color: #fff; cursor: pointer;">Accept Fate</button>',i+="</div>",this.showModal("Defeat",i),(s=this.ui.gameModal.querySelector("#exit-run-btn"))==null||s.addEventListener("click",()=>{this.hideModal(),this.exitRoguelikeRun(t)})}exitRoguelikeRun(e){this.state.player.gold+=e.gold,this.grid=this.worldGrid,this.hexActions&&this.hexActions.setGrid(this.grid),this.pois=this.worldPois||[],this.roads=this.worldRoads||[],this.rivers=this.worldRivers||[],this.worldPlayerPosition&&(this.state.player.position={...this.worldPlayerPosition}),this.renderer.centerOnHex(this.grid,this.state.player.position.q,this.state.player.position.r),this.currentRoguelikeRun=null,this.inRoguelikeRun=!1,this.worldGrid=null,this.worldPois=null,this.worldRoads=null,this.worldRivers=null,this.worldPlayerPosition=null,this.music&&this.music.transitionFromDungeon(),this.updateParticleBiome(),this.state.addLog("You emerge from the depths.","info"),this.render()}isHexAdjacent(e,t,i,s){const a=[[1,0],[-1,0],[0,1],[0,-1],[1,-1],[-1,1]];for(const[n,r]of a)if(e+n===i&&t+r===s)return!0;return!1}startDungeonCombat(e,t,i){var y;const s=i.templateId;if(!this.encounters.ENEMIES||!this.encounters.ENEMIES[s]){this.state.addLog(`You defeated the ${s.toLowerCase().replace("_"," ")}!`,"success"),i.defeated=!0,this.render();return}const a=this.encounters.ENEMIES[s],n=i.isBoss,r=this.state.player.level||1,o=((y=this.currentDungeon)==null?void 0:y.currentFloorIndex)||0,l=.5+(Math.min(r,10)-1)*.11,c=1+o*.05,d=Math.max(.4,Math.min(1.8,l*c)),u=n?1.8:1,h=Math.floor(a.hp*d*u),m=Array.isArray(a.damage)?a.damage.map(f=>Math.floor(f*d*(n?1.3:1))):Math.floor(a.damage*d*(n?1.3:1)),g={id:`dungeon_${Date.now()}`,templateId:s,name:n?`${a.name} (Boss)`:a.name,icon:a.icon,q:e,r:t,hp:h,maxHp:h,damage:m,defense:Math.floor((a.defense||0)*d),agility:a.agility||5,xp:Math.floor((n?a.xp*2.5:a.xp)*d)};this.currentDungeonEnemy={q:e,r:t,enemy:i},this.encounters.startCombatWithMultipleEnemies([g]),this.showCombatModal()}openDungeonChest(e,t,i){var n;if(i.opened)return;if(i.type==="relic_chest"&&i.relicId){const r=this.inventory.add(i.relicId,1),o=D[i.relicId];if(r)this.state.addLog(`ðŸ† Found a legendary relic: ${(o==null?void 0:o.name)||i.relicId}!`,"success"),this.showToast(`Discovered: ${(o==null?void 0:o.name)||"Ancient Relic"}!`,"relic"),(n=this.currentDungeonPOI)!=null&&n.data&&(this.currentDungeonPOI.data.relicClaimed=!0);else{this.state.addLog("Inventory full! Could not pick up the relic.","warning");return}i.opened=!0,this.updateUI(),this.render();return}const s=Wt(i);if(this.inventory.add(s.id,s.quantity)){const r=s.tier.charAt(0).toUpperCase()+s.tier.slice(1);this.state.addLog(`Found ${s.quantity}x ${s.name} (${r})!`,"success"),this.state.showResourcePopup(s.icon||"ðŸ“¦",`+${s.quantity} ${s.name}`),$.playPickup(),this.townActions&&this.townActions.updateTaskProgress("gather",s.id,s.quantity),this.guilds&&this.guilds.updateContractProgress("gather",{resource:s.id,amount:s.quantity})}else this.state.addLog(`Inventory full! Could not pick up ${s.name}.`,"warning");!this.inventory.has("rope")&&Math.random()<.5&&this.inventory.add("rope",1)&&(this.state.addLog("Also found a rope!","success"),this.state.showResourcePopup("ðŸª¢","+1 Rope")),i.opened=!0,this.updateUI(),this.render()}onDungeonCombatEnd(e){if(!this.currentDungeonEnemy)return;const{q:t,r:i,enemy:s}=this.currentDungeonEnemy;if(e){if(s.defeated=!0,s.templateId&&this.triggerCreatureLexicon(s.templateId),this.currentDungeon){const a=this.currentDungeon.killCounts.get(s.templateId)||0;this.currentDungeon.killCounts.set(s.templateId,a+1),this.currentDungeon.totalKills++,this.quests.checkDungeonProgress("kill",{poi:this.currentDungeon.poi,enemyType:s.templateId}),s.hasKey&&(this.currentDungeon.hasFloorKey=!0,this.state.addLog("Found a floor key! You can now access the next level.","success"))}this.townActions&&this.townActions.updateTaskProgress("kill",null,1,s.templateId),this.quests&&this.quests.updateCultistKill(s.templateId),this.guilds&&this.guilds.updateContractProgress("kill",{target:s.templateId}),s.isBoss&&this.currentDungeon&&(this.currentDungeon.bossDefeated=!0,this.state.addLog("The dungeon boss has been defeated!","success"),this.quests.checkDungeonProgress("boss",{poi:this.currentDungeon.poi}),this.guilds&&this.guilds.updateContractProgress("dungeon_clear",{}))}this.currentDungeonEnemy=null,this.render()}}window.game=new Bs;fi(document.body,32);
